---
title: "TF5200"
product: "TF5200"
category: "Motion_Control"
tags: ["NC"]
language: "EN"
document_type: "Manual"
version: "1.11"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF5200_trafo_interface_en.pdf"
release_date: "2025-06-05"
---
Manual | EN TF5200 | Twin CAT 3 CNC Transformation interface 6/5/2025 | Version: 1.11
## Page 3

Notes on the documentation Notes on the documentation This description is only intended for the use of trained specialists in control and automation engineering who are familiar with the applicable national standards. It is essential that the documentation and the following notes and explanations are followed when installing and commissioning the components. It is the duty of the technical personnel to use the documentation published at the respective time of each installation and commissioning. The responsible staff must ensure that the application or use of the products described satisfy all the requirements for safety, including all the relevant laws, regulations, guidelines and standards. Disclaimer The documentation has been prepared with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without prior announcement. No claims for the modification of products that have already been supplied may be made on the basis of the data, diagrams and descriptions in this documentation. Trademarks Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered trademarks of and licensed by Beckhoff Automation Gmb H. Other designations used in this publication may be trademarks whose use by third parties for their own purposes could violate the rights of the owners. Patent Pending The Ether CAT technology is patent protected, in particular by the following applications and patents: EP1590927, EP1789857, EP1456722, EP2137893, DE102015105702 with corresponding applications or registrations in various other countries. Ether CAT® is registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The reproduction, distribution and utilisation of this document as well as the communication of its contents to others without express authorisation are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event of the grant of a patent, utility model or design. TF5200 | Twin CAT 3 CNC Version: 1.11 3 Transformation interface
## Page 4

General and safety instructions General and safety instructions Icons used and their meanings This documentation uses the following icons next to the safety instruction and the associated text. Please read the (safety) instructions carefully and comply with them at all times. Icons in explanatory text 1. Indicates an action. ð Indicates an action statement. DANGER Acute danger to life! If you fail to comply with the safety instruction next to this icon, there is immediate danger to human life and health. CAUTION Personal injury and damage to machines! If you fail to comply with the safety instruction next to this icon, it may result in personal injury or damage to machines. NOTICE Restriction or error This icon describes restrictions or warns of errors. Tips and other notes This icon indicates information to assist in general understanding or to provide additional informa- tion. General example Example that clarifies the text. NC programming example Programming example (complete NC program or program sequence) of the described function or NC com- mand. Specific version information Optional or restricted function. The availability of this function depends on the configuration and the scope of the version. 4 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 5

Table of contents Table of contents Notes on the documentation.................................................................................................................... 3 General and safety instructions.............................................................................................................. 4 1 General information on kinematic transformations (TRAFO)............................................................... 8 1.1 Coordinate systems........................................................................................................................ 10 1.2 Position offsets................................................................................................................................ 12 1.3 Modulo setting of axes.................................................................................................................... 14 2 Interfacing transformation via Tc COM.................................................................................................. 15 2.1 Transformation methods................................................................................................................. 15 2.2 Working (instance data) of the transformation................................................................................ 17 2.2.1 Basic working data: Tc Nc Trafo Parameter....................................................................... 17 2.2.2 Extended working data: Tc Nc Trafo Parameter Ext Cnc..................................................... 18 2.3 Extended working data: Tc Cnc Ori Parameter.................................................................................. 22 2.4 Configuring and registering the transformation with the CNC......................................................... 22 3 Parametrisation....................................................................................................................................... 24 3.1 CNC parameters: Channel and tool................................................................................................ 24 3.1.1 Transformation parameters of the tool............................................................................. 25 3.1.2 Channel parameter.......................................................................................................... 26 3.2 Tc COM parameters......................................................................................................................... 29 4 Error handling and diagnosis................................................................................................................ 31 4.1 Error message................................................................................................................................. 31 4.2 Diagnostic data............................................................................................................................... 34 5 Concatenating transformations, multistep transformations............................................................... 36 6 Generating a transformation.................................................................................................................. 38 6.1 Generation process......................................................................................................................... 38 6.1.1 Create new project........................................................................................................... 39 6.1.2 Generate transformation.................................................................................................. 42 6.1.3 Integrate transformation................................................................................................... 44 6.1.4 Debug the transformation................................................................................................. 46 6.1.5 Source code extension/encoding..................................................................................... 48 6.2 Differences between extended transformation / standard transformation....................................... 49 7 Additional options of extended transformation................................................................................... 50 7.1 Version identifier of transformation interface................................................................................... 50 7.2 Rotation sequence.......................................................................................................................... 50 7.3 Modulo handling of axis positions................................................................................................... 51 7.4 Use of extended parameters........................................................................................................... 52 7.5 Use of extended options................................................................................................................. 54 8 Applying and using the Caller ID........................................................................................................... 56 9 Support and Service............................................................................................................................... 59 Index......................................................................................................................................................... 60 TF5200 | Twin CAT 3 CNC Version: 5 Transformation interface
## Page 6

Table of contents 6 Version: TF5200 | Twin CAT 3 CNC Transformation interface
## Page 7

List of figures List of figures Fig. 1 Example of a kinematic transformation........................................................................................ 8 Fig. 2 Coordinate systems in detail........................................................................................................ 10 Fig. 3 Coordinate systems in detail........................................................................................................ 12 Fig. 4 Access to kinematic parameters.................................................................................................. 13 Fig. 5 Modulo handling of an axis.......................................................................................................... 14 Fig. 6 Dimensioning the input and output coordinates........................................................................... 15 Fig. 7 Kinematic transformation when intersection calculation is active................................................ 21 Fig. 8 Kinematic transformation when intersection calculation is inactive.............................................. 21 Fig. 9 Transformation parameters of the tool......................................................................................... 25 Fig. 10 Channel transformation parameter.............................................................................................. 27 Fig. 11 Transformation parameters via Tc COM....................................................................................... 29 Fig. 12 TMC Editor................................................................................................................................... 30 Fig. 13 Concatenating kinematic transformations.................................................................................... 36 Fig. 14 Create a new project.................................................................................................................... 39 Fig. 15 Configure the new project............................................................................................................ 39 Fig. 16 Create a CNC configuration......................................................................................................... 40 Fig. 17 Create a channel.......................................................................................................................... 40 Fig. 18 Create an axis.............................................................................................................................. 41 Fig. 19 Create Twin CAT driver project..................................................................................................... 42 Fig. 20 Create transformation class......................................................................................................... 42 Fig. 21 Name transformation class.......................................................................................................... 43 Fig. 22 Create driver................................................................................................................................ 44 Fig. 23 Integrate Tc COM object............................................................................................................... 44 Fig. 24 Properties of the Tc COM object................................................................................................... 45 Fig. 25 Parameterise the transformation in the channel parameter list.................................................... 46 Fig. 26 Switch over to debug configuration.............................................................................................. 46 Fig. 27 Activate real-time debugging........................................................................................................ 47 Fig. 28 Breakpoint in the transformation.................................................................................................. 47 Fig. 29 Setting the constructor after generation using Twin CAT3 templates........................................... 48 Fig. 30 Adapted constructor due to high number of axes........................................................................ 48 Fig. 31 Adapting the number of inputs/outputs........................................................................................ 54 Fig. 32 Interfaces for adaptation to various callers.................................................................................. 55 Fig. 33 Displaying the additive transformation position............................................................................ 57 Fig. 34 Identification of the transformation callers.................................................................................... 58 TF5200 | Twin CAT 3 CNC Version: 1.11 7 Transformation interface
## Page 8

General information on kinematic transformations (TRAFO) 1 General information on kinematic transformations (TRAFO) You will find an overview of the standard available kinematic transformation in Kinematic transformations. +Z +B -Z -B -X -Y +C -C +Y +X Z w Y X w w Fig. 1: Example of a kinematic transformation Kinematic structure To simplify workpiece programming, the kinematic transformation encapsulates the machine’s kinematic structure and abstracts the motions in a simple Cartesian coordinate system. Forward/backward transformation Forward/backward transformation Depending on the machines' kinematics, the CNC needs the transformation between axis coordinates and programming coordinates to calculate motions. With the aid of this kinematic transformation, the coordinates of the NC program (forward transformation, ACS -> MCS) are calculated from the physical positions of the axes. Conversely, backward transformation calculates the axis positions from the programmed NC positions (MCS -> ACS). 8 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 9

General information on kinematic transformations (TRAFO) Selecting/deselecting A transformation is selected and deselected using NC commands in the NC program. The NC command for selection is #TRAFO ON; the command for deselection is #TRAFO OFF. The NC command #KIN ID[ ] is provided for selecting the transformation; alternatively, it can be pre-assigned by P-CHAN-00032 [} 27]. Extendibility You can create a user-defined transformation and make it available to the CNC under a selected number (ID). The range [500; 999] is provided as the transformation numbers for this operation. The range [65; 69] continues to be provided for compatibility reasons. TF5200 | Twin CAT 3 CNC Version: 1.11 9 Transformation interface
## Page 10

General information on kinematic transformations (TRAFO) 1.1 Coordinate systems PCS : part coordinate system cartesian transformation z PCS translation & rotation (e.g. #CS) z WCS programmable translation (e.g. G92) WCS : workpiece coordinate system y PCS x WCS x PCS cartesian z transformation M y M x M MCS : machine coordinate system kinematic transformation axis 1 axis 2 axis 3 axis 4 axis 5 ACS : axes coordinate system Fig. 2: Coordinate systems in detail 10 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 11

General information on kinematic transformations (TRAFO) Subroutine Coordinate System PCS This coordinate system is used for geometry description based on the DIN 66025 programming syntax language. The data in a subroutine represents program coordinates. Workpiece Coordinate System WCS This coordinate system refers to a fixed point of the workpiece. The coordinate description of the workpiece refers to this system. The workpiece coordinate system without offsets is used as the basic coordinate system (WCS ). 0 Machine Coordinate System MCS The machine coordinate system represents an abstract coordinate system that is defined by the machine manufacturer. All other coordinate systems refer to this system. If the machine has no Cartesian axis structure (e.g. robot), the machine coordinate system is only virtual. Axis Coordinate System ACS Each axis has a separate coordinate system. Each axis is either fitted to the machine bed itself or to another axis. This means that the machine bed or the associated axis forms the basis. Therefore, the axis coordinate system is defined related to its fixed point. TF5200 | Twin CAT 3 CNC Version: 1.11 11 Transformation interface
## Page 12

General information on kinematic transformations (TRAFO) 1.2 Position offsets Offset management in PCS – WCS transformations If an offset needs to be activated between the programmed coordinates PCS and the actual physical axis positions ACS, you have a number of options as user. CNC-programmed offsets (G54, G92, etc.) are taken into consideration between PCS and WCS. WCS – ACS If the kinematics of a machine require offsets on the axis coordinate system, this is taken into consideration in the transformation. PCS part coordinate system X C PCS PCS X Offset,PCS C + Offset,PCS + WCS workpiece coordinate system X C WCS WCS user kinematic transformation translatory trafo kinematic + X C parameter Offset,ACS Offset,ACS + ACS X C axes coordinate system ACS ACS Fig. 3: Coordinate systems in detail 12 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 13

General information on kinematic transformations (TRAFO) Use of axis-specific offsets in kinematic transformation N010 G54 ; activate zero point offsets at ACS=PCS level N020 G0 X0 Y0 Z0 B0 C0 ; move to zero at PCS level ; … N090 G53 ; deactivate PCS offsets ; … N120 V. G. KIN[500]. PARAM[40] = <x_offset in [0.1 µm]> N130 V. G. KIN[500]. PARAM[43] = <b_offset in [0.0001 degree]> N140 V. G. KIN[500]. PARAM[44] = <c_offset> in [0.0001 degree] N200 #KIN ID[500] ; select kinematic type N210 #TRAFO ON ; ACS offsets are considered inside transformation N220 G01 X100 C90 ;… N240 G92 X400 C180 ; activate additional offset at PCS level N250 G01 X12 C0 … N340 G56 ; activate additional offset at PCS level N350 G01 X2 C50 ;… N999 M30 Access to kinematic parameters If kinematic parameters are initialised in the CNC program, they are forwarded to the forward/backward algorithms as transformation input parameters (the parameter index used is transformation-specific). Fig. 4: Access to kinematic parameters TF5200 | Twin CAT 3 CNC Version: 1.11 13 Transformation interface
## Page 14

General information on kinematic transformations (TRAFO) 1.3 Modulo setting of axes MCS – ACS Depending on the axis properties, the kinematic transformation must define the modulo calculation of the positions. Modulo handling within the transformation must use the same modulo interval as the CNC caller function. The specified MCS modulo setting is automatically adopted by the CNC caller functionality. MCS linear / mod[-180;180] The specified ACS modulo setting is used for a plausibility check. The CNC checks whether the setting matches the axis property configured . ACS linear / mod[-180;180] / mod[0;360] modulo calculation axis parameter modulo= linear/180/360 Modulo linear 180 MCS kinematic transformation Modulo linear 180 360 ACS check modulo configuration ? Fig. 5: Modulo handling of an axis 14 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 15

Interfacing transformation via Tc COM 2 Interfacing transformation via Tc COM 2.1 Transformation methods The following methods must be implemented when creating a transformation (Tc Nc Kinematics Interfaces.h). • virtual HRESULT TCOMAPI Forward (PTc Cnc Trafo Parameter p)=0; • virtual HRESULT TCOMAPI Backward (PTc Cnc Trafo Parameter p)=0; • virtual HRESULT TCOMAPI Trafo Supported (PTc Cnc Trafo Parameter p, bool fwd)=0; • virtual HRESULT TCOMAPI Get Dimensions (PULONG p Forward Input, PULONG p Forward Output)=0; Forward Transformation of the axis positions into the programming coordinate system. PTc Cnc Trafo Parameter *p Current parameters of the transformation Backward Transformation of the programming coordinates into the axis coordinate system. PTc Cnc Trafo Parameter *p Current parameters of the transformation Get Dimension When the transformation is selected, a configuration request (required axis numbers) is executed once. ULONG * p Forward Input Number of forward transformation input coordinates (= number of reverse transformation output coordinates) ULONG * p Forward Input Number of forward transformation output coordinates (= number of reverse transformation input coordinates) Trafo Supported Initialising the transformation and requesting options PTc Cnc Trafo Parameter *p Current parameters of the transformation bool fwd The corresponding member variables must be initialised in the constructor of the "ITc Cnc Trafo Po- s On" class to dimension the input and output coordinates. Fig. 6: Dimensioning the input and output coordinates Extending the transformation for couple kinematics and 3D distance control This function is available as of V3.01.3081.7, V3.1.3115.0 or V4.19.0.0 If you intend to use couple kinematics or 3D distance control with the transformation you created, you must also implement the functions below. Pos Ori To Mcs Transformation from a position and orientation in MCS coordinates PTc Cnc Pos Ori Parameter Current parameters of the transformation *p Mcs To Pos Ori Transformation from MCS coordinates to a position and orientation TF5200 | Twin CAT 3 CNC Version: 1.11 15 Transformation interface
## Page 16

Interfacing transformation via Tc COM PTc Cnc Pos Ori Parameter Current parameters of the transformation *p 16 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 17

Interfacing transformation via Tc COM 2.2 Working (instance data) of the transformation Definition of working data Implementation of the transformation can provide any parameters as working data. Make sure that the transformation is used in several timing phases of the CNC. This is why the CNC must be written as re- entrant. Therefore, the working data must not contain a state of the transformation that is used for subsequent calculation 2.2.1 Basic working data: Tc Nc Trafo Parameter Parameters of the methods Type = Ec Nc Trafo Parameter_Base The parameters for the individual methods are passed on in encapsulated form via the following structure Tc Nc Trafo Parameter (Tc Nc Kinematics Interfaces.h). Ec Nc Trafo Parameter type; ULONG dim_i; // dim of input vectors (i, d_i, dd_i) ULONG dim_o; // dim of output vectors (o, d_o, dd_o, torque) ULONG dim_para; // dim of additional parameter (para) const double* i; // input values parameter (dim_i) const double* d_i; const double* dd_i; double* o; // output values parameter (dim_i) double* d_o; double* dd_o; double* torque; const double* para; // additional parameter (dim_p) double payload; // weight in kg double tool_len; // actual tool length in [mm] Note: The CNC does not use the variables in italics. TF5200 | Twin CAT 3 CNC Version: 1.11 17 Transformation interface
## Page 18

Interfacing transformation via Tc COM 2.2.2 Extended working data: Tc Nc Trafo Parameter Ext Cnc Parameters of the methods Type = Ec Nc Trafo Parameter_Ext Cnc The parameters for the individual methods are transferred via the following extended structure Tc Cn CTrafo Parameter . The data structure provided by the CNC is identified by this parameter type. Type = Ec Nc Trafo Parameter_Ext Cnc struct Tc Cnc Trafo Parameter : public Tc Nc Trafo Parameter, Tc Cnc Param unsigned short kin_id; // in: used kinematic ID unsigned long control; // in: control trafo calculation, e.g. Ec Cnc Trafo Ctrl_cartesian Trafo Inactive Ec Cnc Trafo Option ret_option; // out: select option of transformation during Trafo Supported() Tc Cnc Version Cnc Interface Version; // Interface version Tc Cnc Version Major. Tc Cnc Version Minor // orientation Ec Cnc_Trafo Ori Mode Actual actual_orientation_mode; // Treatment of orientation, actual rotation sequence Ec Cnc_Trafo Mode Supported supported_modes; // modes supported by the Tc COM transformation Note: The structure element Ec Cnc_Trafo Mode Supported supported_modes replaces the previous element Ec Cnc_Trafo Ori Mode Supported supported_orientation_modes. However, the data item is still supported for downward compatibility reasons. // modulo configuration ULONG dim_modulo; // dim of modulo vector Ec Cnc_Mcs Modulo * mcs_modulo; Ec Cnc_Acs Modulo * acs_modulo; Caller identification The active kinematic transformation is currently used at several points in the CNC: The different callers are noted in the working data transferred to the transformation. 0 : Ec Cnc Trafo Caller ID_Undefined 1 : Ec Cnc Trafo Caller ID_Decode 2 : Ec Cnc Trafo Caller ID_Tool Radius Correction 3 : Ec Cnc Trafo Caller ID_Path Preparation 4 : Ec Cnc Trafo Caller ID_Interpolation 5 : Ec Cnc Trafo Caller ID_Display 6 : Ec Cnc Trafo Caller ID_Block Search The caller’s identifier (caller_id) is used to calculate the transformation at various points with variants. For examples, see Applying and using the Caller ID [} 56] Transformation options While the transformation is initialised (Trafo Supported method), you can select individual CNC options. These options change the CNC interface management and may supply additional parameters. Each of the options is predefined by the CNC and must match the corresponding transformation. The following options are available: 0 : Ec Cnc Trafo Option_None 1 : Ec Cnc Trafo Option_Interpolation_Add Input 18 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 19

Interfacing transformation via Tc COM Control input The following data is transferred cyclically to the kinematic transformation 0x0000 0001 Ec Cnc Trafo Ctrl_cartesian Trafo Inactive Cartesian transformation is inactive in the CNC. The angle is specified directly by the CNC. 0x0000 0010 Ec Cnc Trafo Ctrl_RTCPMode RTCP mode is requested for a singular kinematic transformation. The angle is also specified directly by the CNC in the singular axis position. These two items of control information as mentioned above can be used to switch handling in the singularity within the Tc COM transformation, for example. In such cases, the angle is specified directly by the CNC. As another example (where both control information items listed above not set), the angle input values are assigned via a tool direction vector in angular representation, e.g. for a CA head: C: +-180 degrees, A: 0… 90 degrees. Version number of CNC interface In the Tc Cnc Version data item, the CNC transfers the version number of the transformation interface it uses: struct Tc Cnc Version { Long major; Long minor; }; Further information on version number: Version identifier of transformation interface [} 50] Rotation sequence In the actual_rotation_mode data item, the CNC transfers the active rotation sequence of the orientation axes: Ec Cnc Trafo Ori_None = 0 Ec Cnc Trafo Ori_YPR = 1 Ec Cnc Trafo Ori_CBC1 = 2 Ec Cnc Trafo Ori_CBA = 3 Ec Cnc Trafo Ori_CAB = 4 Ec Cnc Trafo Ori_AB = 5 Ec Cnc Trafo Ori_BA = 6 Ec Cnc Trafo Ori_CA = 7 Ec Cnc Trafo Ori_CB = 8 The rotation sequences supported in the transformation are transferred to the CNC in the data item supported_rotation_modes (see also Rotation sequence [} 50]): typedef struct _Ec Cnc_Trafo Mode Supported { unsigned long f_YPR : 1; unsigned long f_CBC1 : 1; unsigned long f_CBA : 1; unsigned long f_CAB : 1; unsigned long f_Unique Trafo : 1; unsigned long f_AB : 1; unsigned long f_BA : 1; unsigned long f_CA : 1; unsigned long f_CB : 1; unsigned long f_Singular Ori : 1; } Ec Cnc_Trafo Mode Supported; Unique CNC --> Tc COM transformation The flag f_Unique Trafo in the data item supported_modes allows the user to mark the Tc COM transformation as unique in forward and backward directions. The user sets the flag in the Trafo Supported method. By default, the CNC handles Tc COM transformations as not unique. The flag f_Unique Trafo is checked when the transformation is initialised. TF5200 | Twin CAT 3 CNC Version: 1.11 19 Transformation interface
## Page 20

Interfacing transformation via Tc COM Setting the flag accelerates by a few cycles all operations where the CNC must read the positions of the drives. Such operations include selecting or deselecting the transformation, changing coordinate systems when a Tc COM transformation is active or using V. A. ACS. ABS variables. Example code to set the flag: virtual HRESULT TCOMAPI Trafo Supported(PTc Cnc Trafo Parameter p, bool fwd) { p->supported_modes.f_Unique Trafo = TRUE; return S_OK; }; Singular Tc COM transformation The flag f_Singular Or in the data item supported_modes allows the user to mark the Tc COM transformation as a kinematic with a singular head position. The user sets the flag in the Trafo Supported method. The CNC then activates singularity handling for five-axis kinematics with CA, CB head. Example code to set the flag: virtual HRESULT TCOMAPI Trafo Supported(PTc Cnc Trafo Parameter p, bool fwd) { p->supported_modes.f_Singular Ori = TRUE; return S_OK; }; Modulo settings The CNC supplies the dimension of the axis-specific objects mcs_modulo and acs_modulo in the object dim_modulo. Modulo handling in the MCS coordinate system is transferred to the CNC in the axis-specific data item mcs_modulo: Ec Cnc_Mcs Modulo_None = 0, Ec Cnc_Mcs Modulo_180_180 = 1, The CNC transfers the extended modulo setting of an axis in the ACS coordinate system in the acs_modulo data item: Ec Cnc_Acs Modulo_None = 0, Ec Cnc_Acs Modulo_180_180 = 1, Ec Cnc_Acs Modulo_0_360 = 2, Disabling intersection calculation if #CS is inactive For example, if the kinematic transformation varies depending on whether a higher-level Cartesian transformation is active or not, you can select this operation by means of the input bit. This is indicated by the controller. Kinematic transformation when intersection calculation is active (Ec Cnc Trafo Ctrl_cartesian Trafo Inactive deleted) 20 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 21

Interfacing transformation via Tc COM PCS #PCS #WCS #ICS MCS Guide compens. GCS kinematic transform ACS intersection inactive intersection active TF5200 | Twin CAT 3 CNC Version: 1.11 21 Transformation interface drawkcab Fig. 7: Kinematic transformation when intersection calculation is active Kinematic transformation when intersection calculation is inactive (Ec Cnc Trafo Ctrl_cartesian Trafo Inactive set) MCS MCS Guide compens. GCS kinematic transform ACS intersection inactive intersection active drawkcab Fig. 8: Kinematic transformation when intersection calculation is inactive
## Page 22

Interfacing transformation via Tc COM 2.3 Extended working data: Tc Cnc Ori Parameter This function is available as of V3.01.3081.7, V3.1.3115.0 or V4.19.0.0 Parameters of the methods Type = Ec Cnc Trafo Pos Ori Parameter Base The parameters for the individual methods are transferred by the following extended structure Tc Cnc Pos Ori Parameter . The data structure provided by the CNC is identified by this parameter type. struct Tc Cnc Pos Ori Parameter: public Tc Cnc Param Ec Cnc Trafo Ori Parameter type double *mcs; // MCS values double *ori; // Values of the orientation matrix [9] double *pos; // Position value [3] unsigned long dim_mcs; // Dimension of MCS coordinates unsigned long prog_axis; // Bit mask of the programmed axes unsigned long locked_axis; // Bit mask of the locked axes unsigned short kin_id; // ID of the active kinematic MCS values In MCS, the MCS coordinates are used to calculate the position and orientation of the kinematics in the Mcs To Pos Ori() function. The dimension of the MCS vector is derived from the dimension specified in Get Dimensions(). The MCS values form the input of the Mcs To Pos Ori() function and the output of the Pos Ori To Mcs() function. Position value (Pos) and orientation matrix (Ori) The position value (Pos) is a vector of dimension 3. This contains the position of the kinematics in relation to its base. The orientation matrix (Ori) consists of a vector of dimension 9, representing the 3x3 rotation matrix. Pos and Ori form the input of the Pos Ori To Mcs() function and the output of the Mcs To Pos Ori() function. The bit masks prog_axis and locked_axis For kinematics with MCS of dimension 7 (or greater), the function Pos Ori To Mcs() is not always unique. For this reason, the actual output vector MCS with the current coordinates is also used as input in Pos Ori To Mcs(). The MCS values can then be calculated in combination with prog_axis and locked_axis, which are a bit mask of the programmed and locked axes. 2.4 Configuring and registering the transformation with the CNC Register the transformation The following data is used to register a Tc COM (Tc Cnc Services.h) • Type 1 (see TCCNC_REGISTEROBJECT_TYPE_TRAFO) is defaulted • Group Channel number of transformation [1;12] selectable at configuration • Index Number of the kinematic [500; 999] selectable at configuration; also permitted for compatibility reasons [65;69] The transformation is registered via the following Tc COM interface, which is defined in the Tc Cnc Interfaces.h file. • virtual HRESULT TCOMAPI Register Object (Tc Cnc Register Object& id, ITc Unknown* ip Unk)=0; • virtual HRESULT TCOMAPI Unregister Object (Tc Cnc Register Object& id)=0; 22 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 23

Interfacing transformation via Tc COM Manual transformation provision After the transformation is generated, two files must be provided for its uses. The transformation is described in the TMC file Tc Cnc Trafo1.tmc and is stored out of the source code directory in the following target directory. <Twin CAT>\3.1\Custom Config\Modules The generated device driver (e.g. Tc Cnc Trafo1.sys) is stored by <Twin CAT>\3.1\SDK\_products\Twin CAT RT (x86)\Release <Twin CAT>\3.1\sdk\_products\Twin CAT RT (x64)\Release in <Twin CAT>\3.1\\Driver\Auto Install , i.e. 64 bits or 32 bits depending on the system. For debugging, the generated device driver (e.g. Tc Cnc Trafo1.sys) and the symbol file (e.g. Tc Cnc Trafo1.pdb) are stored by <Twin CAT>\3.1\SDK\_products\Twin CAT RT (x86)\Debug <Twin CAT>\3.1\SDK\_products\Twin CAT RT (x64)\Debug in <Twin CAT>\3.1\\Driver\Auto Install . Configuration of the transformation When the transformation is configured, the Tc COM object is selected in the System Manager and the channel (group) and the transformation ID (index) are initialised. The procedure is illustrated in Integrate transformation [} 44]. TF5200 | Twin CAT 3 CNC Version: 1.11 23 Transformation interface
## Page 24

Parametrisation 3 Parametrisation Transformation parameters Users can parameterise the transformation via channel and/or tool-specific values. The parameters' meanings depend purely on the implementation of the transformation. The parameters can be initialised in the following areas and have different validity periods: • CNC channel The channel parameters can be set for each channel. They apply in the CNC configuration until this channel data is updated (download in System Manager). • Tool Tool parameters are included with the tool request (D programming in the NC program). They apply until the tool is selected in the NC program. The parameters can be initialised individually for each tool. • Tc COM Global parameters can be specified when the kinematics are configured. These apply for as long as the transformation is loaded, i.e. as long as Twin CAT is active. 3.1 CNC parameters: Channel and tool The transformation parameters for the CNC channel and the tools are supplied to the transformation by means of transfer parameters (pointer p to structure Tc Nc Trafo Parameter). If a tool is selected (D word, see [PROG//Tool geometry compensation], the sum of the kinematic parameters is transferred from the channel parameter list and the tool. Example: Channel parameter list: trafo[1].param[2] 300000 Selected tool: wz[5].kinematic.param[2] 500000 Transferred transformation parameter: p->para[2] = 800000 NOTICE The transformation parameter with index 0 (trafo[..].param[0]) always acts in the direction of the 3rd main axis (normally the Z axis) and is also included in the calculation of the tool length. Therefore, if the un- changed length of the tool is required for the transformation, this parameter should not be used. 24 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 25

Parametrisation 3.1.1 Transformation parameters of the tool The tool parameters can be managed in the CNC or in an external tool management system (e.g. in the PLC). If the tool parameters are managed in the CNC, i.e. the channel parameter ext_wzv_vorhanden = 0 (see P-CHAN-00016) is set, the tab “Tool Para” and the tool parameter list are available in the Twin CAT3 project. Tool parameterisation example For parameterisation in the tool list, see P-TOOL-00009 wz[5].kinematic.param[0] 1538000 # Head offset 1: 153.8 mm wz[5].kinematic.param[1] 25000 # Head offset 2: 2.5 mm wz[5].kinematic.param[2] 0 # Head offset 3: 0 mm wz[5].kinematic.param[5] 900000 # Head offset 6; 90 mm The kinematic parameters of the tool can only be specified for default step = 0. Fig. 9: Transformation parameters of the tool P-TOOL-00009 Kinematic parameters Description These parameters are used for tool-dependent parameterisation of kinematic transformation (RTCP / TLC / TOOL ORI CS [PROG]). Assignment is defined application-specific. Parameter wz[i].kinematic.param[j] where j = 0 … 74 (maximum number of kinematic parameters, application-specific, syntax as of V263 and higher) Data type SGN32 Data range MIN(SGN32) < param[j] < MAX(SGN32) Dimension 0.1µm Default value 0 TF5200 | Twin CAT 3 CNC Version: 1.11 25 Transformation interface
## Page 26

Parametrisation Remarks wz[i].kinematic.wz_kopf_versatz[j] (Syntax up to V260) In addition, it is possible to enter offsets for every kinematic parameter in the channel parameters P-CHAN-00094. If an element is assigned in both lists, the CNC performs an addition of the specified values. For more details regarding the parameterisation of kinematic transformation for 5- axis machining, see [KITRA] and [PROG]. Parameterisation example: wz[5].kinematic.param[0] 1538000 #Tool offset 1: 153.8 mm wz[5].kinematic.param[1] 25000 #Tool offset 2: 2.5 mm wz[5].kinematic.param[2] 0 #Tool offset 3: 0 mm wz[5].kinematic.param[5] 900000 #Tool offset 6: 90 mm 3.1.2 Channel parameter Channel parameterisation example # Define the standard transformation kinematik_id 500 ( P-CHAN-00032) # --------------------------------------------- # -- Tc COM Transformation # trafo[0].id 500 ( P-CHAN-00262 ) trafo[0].param[0] 1088000 ( P-CHAN-00263 ) trafo[0].param[1] 342000 trafo[0].param[2] 150 trafo[0].param[3] 0 trafo[0].param[4] 0 trafo[0].param[5] 0 trafo[0].param[6] 0 # trafo[1].id 9 trafo[1].param[0] 120000 trafo[1].param[1] 100000 trafo[1].param[2] 120 trafo[1].param[3] 0 trafo[1].param[4] 0 26 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 27

Parametrisation Fig. 10: Channel transformation parameter Description of channel parameters P-CHAN-00032 Select kinematic default transformation (kinematic type) Description The purpose of kinematic ID is to identify the machine or tool head specific kinematic types implemented in the controller. This parameter defines the default setting for the kinematic transformation to be used. Parameter kinematik_id Data type UNS16 Data range 1 ≤ kinematik_id < 1000 Dimension ---- Default value 0 Remarks Parameterisation example: After the controller starts up, transformation with ID 2 is valid. kinematik_id 2 For more details on machine kinematics see [KITRA] and [PROG]. P-CHAN-00262 Define kinematic ID for transformations Description The kinematic ID identifies the related transformation as an element of the data set of kinematic parameters. The definition can be made for single-step, multi-step and PCS transformations. Parameter trafo[j].id kin_step[i].trafo[j].id (multi-step transformations) trafo_pcs[i].id (PCS transformation *) Data type UNS16 Data range 1 ... MAX(UNS16) TF5200 | Twin CAT 3 CNC Version: 1.11 27 Transformation interface
## Page 28

Parametrisation Dimension ---- Default value 0 Remarks Parameter syntax as of V300 and higher *The PCS transformation function is available as of V3.1.3110. P-CHAN-00263 Define kinematic parameters for multi-step transformations Description The specific kinematic offsets are entered in this structure for each transformation. You can specify offsets for single-level, multilevel transformations and PCS transformations. Parameter trafo[j].param[k] or where k = 0 to 73 (maximum number of kinematic parameters) kin_step[i].trafo[j].param[k] (multi-step transformations) trafo_pcs[i].param[k] (PCS transformation *) Data type REAL64 Data range ---- Dimension 0.1 µm or 0.0001 inch Default value 0 Remarks Kinematic parameters can also be entered in the tool data list P-TOOL-00009 (they are then relevant only when a tool is selected, independent of the kinematics). If a kinematic parameter is assigned in both lists, the specified values are added in the NC. This is only valid for transformation step 1. No additional kinematic parameters can be entered in the tool data for transformation step 2. For further details on the parameterisation of a kinematic transformation, see [KITRA] and [PROG]. (Parameter syntax as of V300) *The PCS transformation function is available as of V3.1.3110. P-CHAN-00829 Kinematic type for transformations Description This parameter defines the kinematic type. An overview of kinematics is contained in Kinematic transformations. The definition can be made for single-step, multi-step and PCS transformations. Parameter trafo[j].type kin_step[i].trafo[j].type (multi-step transformations) trafo_pcs[i].type (PCS transformation *) Data type UNS16 Data range 0 ... MAX(UNS16) Dimension --- Default value 0 Remarks When a kinematic ID (P-CHAN-00262 [} 27]) is configured unequal to 0 and the kinematic type is 0, the value of the kinematic ID is assigned to the kinematic type. Available as of V3.1.3080.09 * The PCS transformation function is available as of V3.1.3110. 28 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 29

Parametrisation 3.2 Tc COM parameters Tc COM transformation parameter Besides the channel or tool-specific parameters, which are made available via the CNC, further individual parameters can be passed on to the transformation. These are initialised during configuration of the Tc COM object. Fig. 11: Transformation parameters via Tc COM TF5200 | Twin CAT 3 CNC Version: 1.11 29 Transformation interface
## Page 30

Parametrisation The Tc COM parameters required for the transformation can be defined in the TMC Editor: Fig. 12: TMC Editor Use the Twin CAT TMC Code Generator (right-click on the Tc Cn CTrafo project -> Twin CAT TMC Code Generator) to automatically add the parameters in the TMC file to the class for the transformation Ctc Cnc Trafo1 as member variables, e.g. m_Parameter. They can then be used in forward and backward transformation. 30 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 31

Error handling and diagnosis 4 Error handling and diagnosis 4.1 Error message Administration errors If an error occurs, the CNC issues an error message and current execution of the CNC channel is cancelled. 292019 Programmed transformation is not loaded, i.e. may not be configured in Twin CAT. 292020 Insufficient memory for management of the kinematic transformation (system error). 292021 An unknown channel number was transferred internally (system error). 292022 Programmed transformation is unknown internally (loaded), i.e. incorrectly configured in Twin CAT. 292023 The backward transformation is not the inverse of the forward transformation. 292030 Error when requesting configuration data of kinematic transformation. 292031 Error during initialisation of kinematic transformation. 292032 Error in the kinematic forward transformation. 292033 Error in the kinematic backward transformation. 292034 Current MCS input position of the kinematic forward transformation. 292035 Current PCS output position of the kinematic forward transformation. 292036 Current PCS input position of the kinematic backward transformation. 292037 Current MCS output position of the kinematic forward transformation. 292044 CNC interface version is too old. Incompatible with the current Tc COM object. 292045 Selected orientation mode or rotation sequence unsupported by the transformation. 292089 Exception in WCS to matrix transformation. 292090 Exception in matrix to WCS transformation. 292091 Error in WCS to matrix transformation. 292092 Error in matrix to WCS transformation. TF5200 | Twin CAT 3 CNC Version: 1.11 31 Transformation interface
## Page 32

Error handling and diagnosis Example of default error: Logging in diagnostic data (Date/Time): 07.09.2012 / 11:37:38 Version: V3.00.3012.04 Module: DECU_TRF. C Cycle: 3108 ------------------------------------------------------------ ERRTXT: Backward transformation after forward transformation results in different position. ------------------------------------------------------------ Error ID : 292023 BF type : 9 Channel ID : 1 Multiple ID : 1 Line : 2213 Commu ID : 42 Recovery class: 2 Reaction class: 2 Body type: 1 NC file : log. path no. 65535 -> D:\Twin CAT3\test.nc NC program: trafo_test NC prog. info: Block number : 20 File offset: 55 Block offset: 14 --------------------- NC_block ------------------------------ Output not possible! log_pfad_nr not in assignment table. Value_1: Current value is 500 [-] Value_2: Error value is 1005 [-] ------------- end of error message ----------------------- User-specific transformation errors Besides the standard transformation errors, the user can issue user-defined errors for some methods (e.g. error ID 123) by using the function return value (0 = OK). HRESULT CTrafo::Forward(PTc Nc Trafo Parameter p) { if (…) return 123; // raise error … return S_OK; } Error messages in Tc Cnc Users Events.xml In the event of an error, the user-defined return value of the method can be transferred to the error message evaluation via the PLC or the Twin CAT Event Logger, (see also FCT-M7// Twin CAT3 error output). The error texts are supplemented accordingly in the XML error text file for each language (C: \Twin CAT\3.1\Target\Resource): <Event> <Id>123</Id> <Message Lc Id="1033">Kinematic transformation reports error 123</Message> <Message Lc Id="1031">Kinematic transformation reports error 123</Message> </Event> The error is output by the Event Logger. Direct output of user-specific transformation error messages As of CNC Build V3.1.3081.4 or V3.1.3110 user-specific error messages of the user-specific transformation can be output directly. The error range ID 500000 to ID 500999 is provided for this purpose. The process is as follows: • Return error value from transformation in the provided range • Integrate the corresponding error text in the Tc Cnc Users Events.xml file, see code example above. Extended error return values If the extended transformation parameter Tc Nc Trafo Parameter Ext Cnc is used, additional error values may be returned in the event of an error. These values are displayed in the error message. double ret_value1; // out: error value 32 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 33

Error handling and diagnosis double ret_value2; // out: error value char ret_text[24]; // out: additional error info TF5200 | Twin CAT 3 CNC Version: 1.11 33 Transformation interface
## Page 34

Error handling and diagnosis User-specific errors <<---------------------------------------------------------------- 20.06.2013 16:31:06:019 (11862) Version: V3.00.3017.00 ------------------------------------------------------------------ Error : 292033 - Error in the kinematic backward transformation ------------------------------------------------------------------ Program : trafo_test Path : D:\Twin CAT3\ (No: 65535) File : _trafo-error-test.nc Block no: N60 Fileoffset: 151 Line : N060 Y42 ; util_error_Id = -12 ------------------------------------------------------------------ Channel : (No.: 1) Value : 500 Class : ERROR (5) Reaction : PROGRAM_ABORT (2) ================================================================== Value 1 : Actual value : 500 Value 2 : Actual value : 0 Value 3 : Actual value : ------------------------------------------------------------------ Utility : Error 123 - … Module : Line : 0 ------------------------------------------------------------------ Config : ONE_CHANNEL_CONFIGURATION / ... Module : BAVO_5AX. C Line : 6438 BF-Type : BAVO (5) Commu: BAVO_1 (44) Multiple ID: 0 Content : NC_PROGRAM (1) ------------------------------------------------------------------ <<----------------------------------------------------------------20.06.2013 16:31:06:019 (11862) Version: V3.00.3017.00 ------------------------------------------------------------------ Error : 292036 - Current PCS output position of the kinematic forward transformation. ------------------------------------------------------------------ Program : trafo_test Path : D:\Twin CAT3\ (No: 65535) File : _trafo-error-test.nc Block no: N60 Fileoffset: 151 Line : N060 Y42 ; util_error_Id = -12 ------------------------------------------------------------------ Channel : (No.: 1) Value : 000 [mm] Class : WARNING (0) Reaction : PROGRAM_ABORT (2) ================================================================== Value 1 : Actual value : 0 / 1.05E+005 / 0 [0.1*10^-3 mm or ░] Value 2 : Actual value : 0 / 0 / 0 [0.1*10^-3 mm or ░] Value 3 : Actual value : 0 / 0 / 0 [0.1*10^-3 mm or ░] Value 4 : Actual value : 0 / 0 / 0 [0.1*10^-3 mm or ░] Value 5 : Actual value : 0 / 0 / 0 [0.1*10^-3 mm or ░] ------------------------------------------------------------------ Config : ONE_CHANNEL_CONFIGURATION / ... Module : BAVO_5AX. C Line : 6438 BF-Type : BAVO (5) Commu: BAVO_1 (44) Multiple ID: 2 Content : NC_PROGRAM (1) 4.2 Diagnostic data Log of axis positions The <n> input/output positions of the kinematic transformation last used are logged. When diagnostic data is requested (see dump.bat), these values are logged in the diagnostic data diag_data.txt. The following transformations are recorded in the diagnostic data: • positions of the decoder forward transformation • positions of the backward transformation during interpolation Logging in diagnostic data DECODER : KINEMATIC FORWARD-TRAFO, CHANNEL-NO.: 1 =================================================================== TIME ID0 ID1 IN[00] IN[01] ... OUT[00] ... 153441 500 0 -12600000.000 -12600000.000 ... -40365738.845 ... 34 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 35

Error handling and diagnosis 153448 500 0 -12600000.000 -12600000.000 ... -40365738.845 ... 153455 500 0 -12600000.000 -12600000.000 ... -40365738.845 ... 153508 500 0 -12683073.658 -12663380.896 ... -40375276.063 ... PATH : KINEMATIC BACKWARD-TRAFO, CYCLIC, CHANNEL-NO.: 1 =================================================================== TIME ID0 ID1 IN[00] IN[01] ... OUT[00] ... 215242 500 0 -40243827.115 11630715.707 ... -14546527.976 ... 215244 500 0 -40243827.115 11630715.706 ... -14546527.977 ... 215243 500 0 -40243827.115 11630715.706 ... -14546527.976 ... 215245 500 0 -40243827.115 11630715.705 ... -14546527.977 ... 215246 500 0 -40243827.115 11630715.705 ... -14546527.977 ... 215247 500 0 -40243827.115 11630715.704 ... -14546527.977 ... PATH : KINEMATIC BACKWARD-TRAFO, DEST, CHANNEL-NO.: 1 =================================================================== TIME ID0 ID1 IN[00] IN[01] ... OUT[00] ... 199502 500 0 -40245718.482 11643365.168 ... -12937949.950 ... 199503 500 0 -40245466.676 11641681.090 ... -12938699.356 ... 199504 500 0 -40245236.484 11640141.566 ... -12939384.586 ... 199505 500 0 -40245027.043 11638740.826 ... -12940008.169 ... 199506 500 0 -40244837.558 11637473.552 ... -12940572.438 ... TF5200 | Twin CAT 3 CNC Version: 1.11 35 Transformation interface
## Page 36

Concatenating transformations, multistep transformations 5 Concatenating transformations, multistep transformations Multi-step capability - Additive kinematic transformation Normally, only one kinematic transformation is used but the CNC offers the option of cascading several partial kinematic transformations. At present, an additional transformation can be concatenated to the normal transformation Using this option, you can structure your transformations independently: • Standard kinematic transformation (Step=0): maps the basic kinematic chain of the machine (Configuration type = TCCNC_REGISTEROBJECT_TYPE_TRAFO) • Additive kinematic transformation (Step=1): compensates, e.g. dynamic effects of the machine (Configuration type = TCCNC TCCNC_REGISTEROBJECT_TYPE_TRAFO_ADD) CNC-program Decoding trafo cart add kin std kin std kin standard kinematic transformation add kin additive kinematic transformation Fig. 13: Concatenating kinematic transformations Initialising kinematic parameters The kinematic parameters for each step of the kinematic transformation can be initialised in the channel list in the following form: kin_step[0].id[83].param[0] 10000 kin_step[1].id[51].param[0] 55000 kin_step[1].id[51].param[1] 80000 Initialising the standard transformation The standard transformation of each step can be defined in the channel list in the following form. default_id_of_kin_step[0] 83 default_id_of_kin_step[1] 51 Accessing parameters in the NC program The kinematic parameters of each step can be addressed in the NC program in the following way., N10 V. G. KIN_STEP[1]. ID[1]. PARAM[0] = 55000 N20 V. G. KIN_STEP[1]. ID[1]. PARAM[1] = 80000 Activating a transformation for every step Each of the kinematic steps can be selected by the following NC commands: #TRAFO [<kin-id-step0>, <kin-id-step1>] 36 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 37

Concatenating transformations, multistep transformations #TRAFO [DEFAULT, DEFAULT] ;DEFAULT = value of parameter default_id_of_kin_step[] #TRAFO [ OFF, <kin-id-step1>] #TRAFO [<kin-id-step0>, OFF] #TRAFO [ OFF, OFF] #TRAFO OFF TF5200 | Twin CAT 3 CNC Version: 1.11 37 Transformation interface
## Page 38

Generating a transformation 6 Generating a transformation When you generate a Tc COM object using the Twin CAT3 template, a so-called extended transformation is created by default. 6.1 Generation process Minimum requirements for using Mc COM assistants • Twin CAT3 Version 4024 • Microsoft Visual Studio 2019 Professional/Enterprise: During installation, additionally select the option “Desktop development with C++”. The transformation is generated using a Win CAT3 template Execute the following steps: • Create or open a Twin CAT3 XAE project with integrated CNC configuration • Create the scope for transformation using templates as shown in the example below. • Generate user C++ code for transformation (this step can also take place later but then a new driver must also be generated) • Generate driver (My Trafo.sys) • Integrate the transformation into the XAE project Configuration as Tc COM object • Activating the configuration The My Trafo.sys driver is copied automatically to the <Twin CAT>\3.1\Driver\Autoinstall directory when the configuration is activated. All additive drivers are placed in this directory. 38 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 39

Generating a transformation 6.1.1 Create new project The procedure below is an example of how to create a user-defined kinematic transformation using a Tc COM object and was generated with Visual Studio 2019. Twin CAT3 XAE project with CNC configuration Fig. 14: Create a new project Fig. 15: Configure the new project TF5200 | Twin CAT 3 CNC Version: 1.11 39 Transformation interface
## Page 40

Generating a transformation Fig. 16: Create a CNC configuration Fig. 17: Create a channel 40 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 41

Generating a transformation Fig. 18: Create an axis TF5200 | Twin CAT 3 CNC Version: 1.11 41 Transformation interface
## Page 42

Generating a transformation 6.1.2 Generate transformation Create user transformation using Twin CAT3 templates. Fig. 19: Create Twin CAT driver project Fig. 20: Create transformation class 42 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 43

Generating a transformation Fig. 21: Name transformation class This defines the framework for the Tc COM object in Visual Studio. TF5200 | Twin CAT 3 CNC Version: 1.11 43 Transformation interface
## Page 44

Generating a transformation Create the driver Right-click on the project to “Create” the driver. Fig. 22: Create driver 6.1.3 Integrate transformation Integrate the transformation into the existing CNC configuration as follows: Fig. 23: Integrate Tc COM object The integration is completed when you press the “OK” button to confirm. 44 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 45

Generating a transformation Double-click on the Tc COM object to display the properties. Fig. 24: Properties of the Tc COM object Parameter Permissible values Description Type 1 Type = 1 specifies that the Tc COM object is a kinematic transformation. Group 0 <= group <= number of The group parameter specifies which CNC channel channels may access the transformation. If group = 0, the transformation is available for all CNC channels. Index 500 <= index <= 999 The index parameter provides the transformation with a unique ID in the CNC channel by means of For compatibility reasons: which it can be addressed in the CNC, e.g. in the 65 <= index <= 69 NC program with the command #KIN ID [500]. TF5200 | Twin CAT 3 CNC Version: 1.11 45 Transformation interface
## Page 46

Generating a transformation Parameterise the transformation in the CNC The created kinematic must still be parameterised in the CNC: This is executed in the default channel parameter list or in a specific channel parameter list. Fig. 25: Parameterise the transformation in the channel parameter list The transformation ID to be entered in the index of the Tc COM object. 6.1.4 Debug the transformation To debug, switch the transformation in the Twin CAT3 project over to debug and activate the real-time debugger. Fig. 26: Switch over to debug configuration 46 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 47

Generating a transformation Fig. 27: Activate real-time debugging The My Trafo.sys debug driver and the associated pdb file are copied automatically to the Autoinstall directory when the configuration is activated. You can start debugging the transformation project after starting Twin CAT in the "RUN" state and setting the associated breakpoints. Fig. 28: Breakpoint in the transformation TF5200 | Twin CAT 3 CNC Version: 1.11 47 Transformation interface
## Page 48

Generating a transformation 6.1.5 Source code extension/encoding To complete the generation process, integrate your user transformation equations in the functions • Forward • Backward • Trafo Supported • Get Dimensions • Mcs To Pos Ori • Pos Ori To Mcs file. They are already created as examples in the My Kin Trafo.cpp using the Twin CAT3 template. User tip If the transformation requires more than 5 axes, adapt the constructor as follows. If there are fewer than 5 axes, the values must be reduced correspondingly. Fig. 29: Setting the constructor after generation using Twin CAT3 templates Fig. 30: Adapted constructor due to high number of axes If you enter a value in the constructor that is higher than the number of axes in the channel, error message ID 20658 is output. This error message is also output if there are gaps in the configuration of axes in the channel. Possible solutions: • Check and correct the gaps in the configuration • Adapt the constructor to the number of the axes in the channel used After implementing the functions, recreate the driver and re-activate the configuration. 48 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 49

Generating a transformation 6.2 Differences between extended transformation / standard transformation When you use Twin CAT3 templates, the extended transformation is created by default. It is exclusively designed for use with the CNC. The standard transformation is used when both the CNC and the NCI are used. (NCI – controller solution from Beckhoff) Extended transformation Standard transformation Extended interface: ITc Cnc Trafo Default interface: ITc Nc Trafo GUID extended interface: IID_ITc Cnc Trafo GUID standard interface: IID_ITc Nc Trafo Extended transformation parameter: Default parameter: PTc Cnc Trafo Parameter PTc Nc Trafo Parameter TF5200 | Twin CAT 3 CNC Version: 1.11 49 Transformation interface
## Page 50

Additional options of extended transformation 7 Additional options of extended transformation 7.1 Version identifier of transformation interface The transformation interface has a unique version identifier (<Major>.<Minor>). The CNC version number is supplied to the Tc COM transformation in the data item p->Cnc Interface Version. The Tc COM object can request the unique version number using the Get Interface Version() method. The CNC transformation interface is downwards compatible, i.e. Tc COM objects of an older interface version can continue to be used together with more recent CNC versions. However, the opposite does not apply: The interface version of the CNC must be at least as up-to-date as the transformation interface of the Tc COM object. Otherwise, the CNC generates the error message ID 292044. HRESULT <User Trafo>::Trafo Supported(PTc Cnc Trafo Parameter p, bool fwd) { ... Tc Cnc Version Tc COMInterface Version; this->Get Interface Version(&Tc COMInterface Version); if ( (Tc COMInterface Version.major <= p->Cnc Interface Version.major) && (Tc COMInterface Version.minor <= p->Cnc Interface Version.minor)) { return S_OK; }; } 7.2 Rotation sequence When transformations are complete, the sequence of rotations executed about the 3 rotary axes can be defined to meet the requirements (see P-CHAN-00112). If this is required, the Tc COM transformation must also take this into consideration. Therefore, the current setting is transferred to the transformation in the p- >actual_orientation_mode parameter. The rotation sequences supported in the transformation can be sent to the CNC in the data item p->supported_orientation_modes When the transformation is selected, the CNC checks the setting in P-CHAN-00112 for plausibility and generates the error message ID 292045 if the transformation does not support the selected rotation sequence. CNC --> Tc COM transformation: p->actual_orientation_mode Meaning Ec Cnc Trafo Ori_None No rotation Ec Cnc Trafo Ori_YPR Yaw-Pitch-Roll rotation sequence: 1st rotation about Z, 2nd negative rotation about Y, 3rd rotation about X Ec Cnc Trafo Ori_CBC1 Euler rotation sequence: 1st rotation about Z, 2nd rotation about Y, 3rd rotation about Z‘ Ec Cnc Trafo Ori_CBA 1st rotation about Z, 2nd rotation about Y, 3rd rotation about X Ec Cnc Trafo Ori_CAB 1st rotation about Z, 2nd rotation about X, 3rd rotation about Y Ec Cnc Trafo Ori_AB 1st rotation about X, 2nd rotation about Y Ec Cnc Trafo Ori_BA 1st rotation about Y, 2nd rotation about X Ec Cnc Trafo Ori_CA 1st rotation about Z, 2nd rotation about X Ec Cnc Trafo Ori_CB 1st rotation about Z, 2nd rotation about Y Tc COM transformation --> CNC: p->supported_orientation_modes Meaning .f_YPR = TRUE, transformation supports rotation sequence YPR 50 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 51

Additional options of extended transformation .f_CBC1 = TRUE, transformation supports rotation sequence CBC‘ .f_CBA = TRUE, transformation supports rotation sequence CBA .f_CAB = TRUE, transformation supports rotation sequence CAB .f_AB = TRUE, transformation supports rotation sequence AB .f_BA = TRUE, transformation supports rotation sequence BA .f_CA = TRUE, transformation supports rotation sequence CA .f_CB = TRUE, transformation supports rotation sequence CB By default, the CNC uses the setting Ec Cnc Trafo Ori_YPR (Yaw->Pitch->Roll). Accordingly, the data item p- >supported_orientation_mode.f_YPR is set to the value TRUE by default. HRESULT <User Trafo>::Trafo Supported(PTc Cnc Trafo Parameter p, bool fwd) { ... /* Transformation supports YPR and Euler rotation sequence. */ p->supported_orientation_modes.f_YPR = TRUE; p->supported_orientation_modes.f_CBC1 = TRUE; ... return S_OK; } HRESULT <User Trafo>::Backward(PTc Cnc Trafo Parameter p) { … if (Ec Cnc Trafo Ori_CBC1 == p->actual_orientation_mode) { /* Rotation sequence acc. to Euler active */ } else { ... } return S_OK; } 7.3 Modulo handling of axis positions Normally, the positions in the MCS coordinate system is handled linearly by the CNC, i.e. no modulo correction takes place. If the transformation expects the MCS positions in the modulo interval [-180° - +180° [ (e.g. for shortest way programming), a modulo correction can be activated for an axis in the MCS coordinate system in the Trafo Supported() function by the data item mcs_modulo. p->mcs_modulo[i] Meaning Ec Cnc_Mcs Modulo_None Linear MCS positions, no modulo calculation for this axis Ec Cnc_Mcs Modulo_180_180 Modulo calculation of the MCS positions for this axis in the interval [-180°, +180°[. The calculated ACS coordinates must match the axis properties. If the axis uses modulo positions, the ACS coordinates in the transformation must also execute a modulo correction. Therefore, the modulo setting in the axis-specific data item acs_modulo used in the transformation is sent to the CNC. The CNC then checks whether the transformation matches the axis properties. If not, it generates the error message P-ERR-50534. p->acs_modulo[i] Meaning Ec Cnc_Acs Modulo_None Linear ACS positions: no modulo handling is required for this axis. Ec Cnc_Acs Modulo_180_180 For this axis a modulo calculation of the ACS positions is required in the interval [-180°, +180°[. Ec Cnc_Acs Modulo_0_360 For this axis a modulo calculation of the ACS positions is required in the interval [0°, 360°[. TF5200 | Twin CAT 3 CNC Version: 1.11 51 Transformation interface
## Page 52

Additional options of extended transformation Modulo handling of axis positions HRESULT <User Trafo>::Trafo Supported(PTc Cnc Trafo Parameter p, bool fwd) { ... /* 3 axes linear MCS positions, modulo handling for the 4th axis */ p->mcs_modulo[0] = Ec Cnc_Mcs Modulo_None p->mcs_modulo[1] = Ec Cnc_Mcs Modulo_None p->mcs_modulo[2] = Ec Cnc_Mcs Modulo_None p->mcs_modulo[3] = Ec Cnc_Mcs Modulo_180_180 /* 2 axes linear ACS positions, modulo handling for 2 axes */ p->acs_modulo[0] = Ec Cnc_Acs Modulo_None p->acs_modulo[1] = Ec Cnc_Acs Modulo_180_180 p->acs_modulo[2] = Ec Cnc_Acs Modulo_0_360 p->acs_modulo[3] = Ec Cnc_Acs Modulo_None } 7.4 Use of extended parameters The example below shows the use of extended transformation parameters. 52 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 53

Additional options of extended transformation TF5200 | Twin CAT 3 CNC Version: 1.11 53 Transformation interface
## Page 54

Additional options of extended transformation 7.5 Use of extended options Number of inputs/outputs Normally, the number of inputs and outputs is symmetrical in the forward and backward directions. This basic number is defined by the method Get Dimension . For special requirements, the transformation can evaluate additional inputs. The method Trafo Supported can match the number of inputs/outputs to the requirements. • CNC option (ret_option) • Number of additional input values (dim_i) In this case, the CNC must supply the additional values to the interface. If the CNC does not support this function, an error message is output. add kin std kin 54 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface drawkcab drawrof bw fw in out bw fw out in bw fw in out bw fw out in Fig. 31: Adapting the number of inputs/outputs The transformation options can be set during a configuration request (Tafo Supported method). Forward/backward adaptation Adaptation can be carried out for each forward/backward transformation. In addition, this can also be carried out depending on the callers within the CNC (decoder, tool radius compensation etc.).
## Page 55

Additional options of extended transformation CNC-program PCS Path Decoding trafo cart add kin decoder std kin PCS Path tool radius correction trafo cart add kin TRC std kin Path Preparation trafo cart path add kin preparation std kin trafo cart block add kin interpolator search std kin trafo cart trafo cart add kin add kin std kin std kin interpolation display Fig. 32: Interfaces for adaptation to various callers. TF5200 | Twin CAT 3 CNC Version: 1.11 55 Transformation interface
## Page 56

Applying and using the Caller ID 8 Applying and using the Caller ID Example 1: Saving resources in path preparation (Path Preparation) A transformation may be CPU-intensive and therefore time-consuming. This may result in many calls to the backward transformation in Path Preparation and may impair the internal record supply under certain circumstances. To counteract this, a transformation with lower accuracy and therefore fewer required resources (computing time) can be used explicitly for the Path Preparation, for example. A transformation with lower accuracy can be used at selected points, such as Path Preparation, if only relatively minor effects occur to the function of the CNC or are expected. This is therefore a feasible solution to avoid impairing block supply. Example 2: Display the position of the additive transformation During the interpolation, the additive transformation is called for display purposes (caller ID = 5 = Ec Cnc Trafo Caller ID_Display). These position values are accessible for each axis via CNC objects. mc_ax_<i>_add_kin_pos_r 56 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 57

Applying and using the Caller ID PCS dynamic TCP #PCS transform WCS CS #WCS intersect ICS #ICS MCS GCS (Guide) ACS drive real positions theoretical positions TF5200 | Twin CAT 3 CNC Version: 1.11 57 Transformation interface noitamrofsnar T IPO Interpolation: linear, circular PCS(t) Continuous Path online TRC: equidistant TCP-path PCS basic TCP simple add. trafo basic & dynamic add. trafo display GCS basic Kinematic XY UV Z1 Fig. 33: Displaying the additive transformation position Additive transformation positions can also be verified by the COM task in the ISG object browser. NOTICE Forward transformation must always be inverse to backward transformation. position = forward(backward(position)) If the transformation varies is dependent on the caller (caller_id), then disable this variation when the con- troller is initialised at standstill.
## Page 58

Applying and using the Caller ID CNC-program PCS Path Decoding trafo cart add kin decoder std kin PCS Path tool radius correction trafo cart add kin TRC std kin Path Preparation trafo cart path add kin preparation std kin trafo cart block add kin interpolator search std kin trafo cart trafo cart add kin add kin std kin std kin interpolation display Fig. 34: Identification of the transformation callers 58 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 59

Support and Service 9 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com TF5200 | Twin CAT 3 CNC Version: 1.11 59 Transformation interface
## Page 60

Index Index P P-CHAN-00032 27 P-CHAN-00262 27 P-CHAN-00263 28 P-CHAN-00829 28 P-TOOL-00009 25 60 Version: 1.11 TF5200 | Twin CAT 3 CNC Transformation interface
## Page 62

More Information: www.beckhoff.com/TF5200 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
