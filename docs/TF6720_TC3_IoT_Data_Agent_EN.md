---
title: "TF6720 Twin CAT 3"
product: "TF6720"
category: "IoT"
tags: ["CAT", "IoT", "TWIN"]
language: "EN"
document_type: "Manual"
version: "1.5.0"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF6720_TC3_IoT_Data_Agent_EN.pdf"
release_date: "2024-06-18"
---
Manual | EN TF6720 Twin CAT 3 | Io T Data Agent 2024-06-18 | Version: 1.5.0
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation............................................................................................................. 5 1.2 For your safety.................................................................................................................................. 5 1.3 Notes on information security............................................................................................................ 7 1.4 Documentation output status............................................................................................................ 7 2 Overview.................................................................................................................................................... 8 3 Installation................................................................................................................................................. 9 3.1 System requirements........................................................................................................................ 9 3.2 Setup scenarios................................................................................................................................ 9 3.3 Installation....................................................................................................................................... 11 3.4 Installation from Twin CAT 4026...................................................................................................... 14 3.5 Licensing......................................................................................................................................... 15 3.6 Licensing information...................................................................................................................... 17 4 Technical introduction............................................................................................................................ 18 4.1 Application examples...................................................................................................................... 18 4.1.1 AWS Io T Core.................................................................................................................. 18 4.1.2 Bosch Io T Suite................................................................................................................ 19 4.1.3 Google Io T Core............................................................................................................... 19 4.1.4 IBM Watson Io T............................................................................................................... 20 4.1.5 Math Works Thing Speak................................................................................................... 20 4.1.6 Microsoft Azure Io T Hub.................................................................................................. 21 4.1.7 Node-RED........................................................................................................................ 22 4.2 Features.......................................................................................................................................... 22 4.3 Internet connectivity........................................................................................................................ 24 4.4 MQTT basics................................................................................................................................... 25 4.5 Startup modes................................................................................................................................. 31 4.6 Security........................................................................................................................................... 31 4.7 Buffering of data.............................................................................................................................. 32 4.8 Supported protocols and services................................................................................................... 33 4.8.1 Microsoft Azure Io T Hub.................................................................................................. 33 5 Configuration........................................................................................................................................... 36 5.1 Quick Start...................................................................................................................................... 36 5.2 Configurator.................................................................................................................................... 38 5.2.1 Topology view.................................................................................................................. 39 5.2.2 Tree view.......................................................................................................................... 40 5.2.3 Mappings.......................................................................................................................... 41 5.2.4 Target Browser................................................................................................................. 41 5.2.5 Cascading Editor.............................................................................................................. 42 5.2.6 Parameter Editor.............................................................................................................. 42 5.2.7 Settings............................................................................................................................ 44 5.2.8 Error logging..................................................................................................................... 51 5.3 System tray..................................................................................................................................... 51 5.4 Support Information Report............................................................................................................. 52 TF6720 Version: 1.5.0 3
## Page 4

Table of contents 6 Samples................................................................................................................................................... 54 6.1 Quick Start...................................................................................................................................... 54 6.2 Southbound..................................................................................................................................... 56 6.2.1 Connect to third-party devices via OPC UA..................................................................... 56 6.2.2 Connect to a BC9191 via ADS......................................................................................... 58 6.2.3 Connect to a Twin CAT I/O Task via ADS........................................................................ 59 6.2.4 Connect to a Twin CAT Tc COM module via ADS............................................................. 61 6.3 Northbound..................................................................................................................................... 63 6.3.1 Publish data to AWS Io T Core......................................................................................... 63 6.3.2 Publish data to AWS Greengrass.................................................................................... 65 6.3.3 Publish data to IBM Watson Io T....................................................................................... 67 6.3.4 Publish data to Microsoft Azure Io T Hub.......................................................................... 69 6.3.5 Publish data to MQTT Message Broker........................................................................... 71 6.3.6 Publish data to Twin CAT Io T Communicator App............................................................ 73 6.3.7 Subscribe to MQTT Message Broker............................................................................... 74 6.3.8 Use Microsoft Azure Io T Hub Device Twin...................................................................... 76 7 Appendix.................................................................................................................................................. 78 7.1 Error logging.................................................................................................................................... 78 7.2 Error diagnosis................................................................................................................................ 78 7.3 Support and Service........................................................................................................................ 80 4 Version: 1.5.0 TF6720
## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. For installation and commissioning of the components, it is absolutely necessary to observe the documentation and the following notes and explanations. The qualified personnel is obliged to always use the currently valid documentation. The responsible staff must ensure that the application or use of the products described satisfies all requirements for safety, including all the relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been prepared with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. No claims to modify products that have already been supplied may be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of designations or trademarks used in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Patents The Ether CAT Technology is covered, including but not limited to the following patent applications and patents: EP1590927, EP1789857, EP1456722, EP2137893, DE102015105702 and similar applications and registrations in several other countries. Ether CAT® is registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document as well as the use and communication of its contents without express authorization are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. TF6720 Version: 1.5.0 5
## Page 6

Foreword Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 6 Version: 1.5.0 TF6720
## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. 1.4 Documentation output status Version Cange 1.5.x Installation: Description of the installation under Twin CAT 3.1 Build 4026 TF6720 Version: 1.5.0 7
## Page 8

Overview 2 Overview The Twin CAT Function TC3 Io T Data Agent provides bi-directional connectivity to different cloud services. It is a gateway application that can be installed either on the controller or on a gateway computer. The TC3 Io T Data Agent can be configured to connect different data sources with each other, e.g. a Twin CAT 3 PLC (ADS) and a MQTT Message Broker. In addition, public cloud services can be used, for example AWS Io T and Microsoft Azure Io T Hub. TC3 Io T Data Agent includes an integrated OPC UA client, which allows to connect third-party devices to the cloud. Legacy applications running Twin CAT 2 can be connected by running TC3 Io T Data Agent on a gateway computer and by using ADS or OPC UA connectivity to the Twin CAT 2 system. When sending or receiving data, users can select from a variety of different data formats, ranging from efficient binary formats to ASCII-based JSON formats. This allows the use of the TC3 Io T Data Agent in different scenarios, e.g. to connect devices to Twin CAT Analytics. Different communication patterns can be configured to optimize traffic congestion, e.g. polling or on-change patterns. Components TC3 Io T Data Agent consists of the following components: • Core application: background service that provides the logic • Configurator: graphical tool to create/edit and deploy a configuration for the core application Twin CAT 3 Io T Data Agent can be installed and used in different setup scenarios, e.g. directly on the controller or on a gateway computer (see Setup scenarios [} 9]). 8 Version: 1.5.0 TF6720
## Page 9

Installation 3 Installation 3.1 System requirements The following table lists the system requirements for TC3 Io T Data Agent. Technical data Description Operating system Windows 7/10, Windows Embedded Standard 7 Target platform PC architecture (x86, x64) . NET Framework 4.5.2 (only required for configurator) Twin CAT version 1 Twin CAT 2, Twin CAT 3 Twin CAT installation level 2 3 Twin CAT 3 XAE, XAR, ADS (build 4022.22 and above) Required Twin CAT license TF6720 TC3 Io T Data Agent (includes 4 gates) Additional licenses 4 TF6721 TC3 Io T Data Agent Gate Pack 4 TF6722 TC3 Io T Data Agent Gate Pack 16 TF6723 TC3 Io T Data Agent Gate Pack 64 TF6724 TC3 Io T Data Agent Gate Pack 256 1 Version of the Twin CAT runtime to which TC3 Io T Data Agent can connect (via ADS, alternatively also via additional functions, e.g. Twin CAT OPC UA) 2 A minimum setup level of Twin CAT 3 ADS is required for licensing purposes. 3 XAE is currently required for the configurator. 4 Every additional license can be acquired once per system and adds to the total amount of gates. 3.2 Setup scenarios TC3 Io T Data Agent can be used in almost every deployment scenario. It can either be installed and used directly on the industrial controller (see System Requirements [} 9]) or on a gateway computer that aggregates multiple devices or connects to legacy applications like Twin CAT 2. Each setup scenario has its advantages and disadvantages, depending on the system environment and project for which the TC3 Io T Data Agent is to be used. TC3 Io T Data Agent running on the controller This is the default scenario. TC3 Io T Data Agent is installed directly on a Beckhoff industrial controller (IPC or Embedded-PC) and connects only to the Twin CAT runtime on that system. This is the preferred scenario because every Io T device should have an own connection to the cloud service, although gateway scenarios are possible and sometimes also necessary. TF6720 Version: 1.5.0 9
## Page 10

Installation TC3 Io T Data Agent running on a gateway computer In this scenario, TC3 Io T Data Agent is installed on a gateway computer that aggregates multiple devices, e.g. to connect to existing machine applications in a retrofit scenario. This scenario can also be combined with other Twin CAT Functions, e.g. a Twin CAT OPC UA Server, which is also able to aggregate multiple Twin CAT runtimes. A typical hardware device for such a setup scenario is a Beckhoff C6015 Ultra-Compact Industrial-PC. Be aware that the network traffic between the TC3 Io T Data Agent and the underlying devices can be very high in this setup scenario because the TC3 Io T Data Agent needs to sample symbols from every connected runtime and this sampling is being done via the network. 10 Version: 1.5.0 TF6720
## Page 11

Installation TC3 Io T Data Agent configurator The TC3 Io T Data Agent configurator [} 38] is a graphical configuration tool. It can be installed on the same computer that executes the TC3 Io T Data Agent core application or on an engineering computer to remotely create/edit and deploy the configuration across the network. 3.3 Installation The following section describes how to install the Twin CAT 3 Function for Windows-based operating systems. ü The Twin CAT 3 Function setup file was downloaded from the Beckhoff website. 1. Run the setup file as administrator. To do this, select the command Run as administrator in the context menu of the file. ð The installation dialog opens. TF6720 Version: 1.5.0 11
## Page 12

Installation 2. Accept the end user licensing agreement and click Next. 3. Enter your user data. 12 Version: 1.5.0 TF6720
## Page 13

Installation 4. If you want to install the full version of the Twin CAT 3 Function, select Complete as installation type. If you want to install the Twin CAT 3 Function components separately, select Custom. 5. Select Next, then Install to start the installation. ð A dialog box informs you that the Twin CAT system must be stopped to proceed with the installation. TF6720 Version: 1.5.0 13
## Page 14

Installation 6. Confirm the dialog with Yes. 7. Select Finish to exit the setup. ð The Twin CAT 3 Function has been successfully installed. 3.4 Installation from Twin CAT 4026 Twin CAT Package Manager If you are using Twin CAT 3.1 Build 4026 (and higher) on the Microsoft Windows operating system, you can install this function via the Twin CAT Package Manager, see Installation documentation. Normally you install the function via the corresponding workload; however, you can also install the packages contained in the workload individually. This documentation briefly describes the installation process via the workload. Command line program Tc Pkg You can use the Tc Pkg Command Line Interface (CLI) to display the available workloads on the system: tcpkg list TF6720 You can use the following command to install the workload of the TF6720 TC3 Io T Data Agent function. tcpkg install TF6720. Io TData Agent. XAE tcpkg install TF6720. Io TData Agent. XAR 14 Version: 1.5.0 TF6720
## Page 15

Installation Twin CAT Package Manager UI You can use the User Interface (UI) to display all available workloads and install them if required. To do this, follow the corresponding instructions in the interface. 3.5 Licensing The Twin CAT 3 function can be activated as a full version or as a 7-day test version. Both license types can be activated via the Twin CAT 3 development environment (XAE). Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. TF6720 Version: 1.5.0 15
## Page 16

Installation 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. 16 Version: 1.5.0 TF6720
## Page 17

Installation 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. 3.6 Licensing information Licensing of TC3 Io T Data Agent is based on so-called “Gate packs”. Each ADS device or OPC UA server namespace to which the TC3 Io T Data Agent connects is considered to be a “Gate”. The TC3 Io T Data Agent base license “TF6720” already includes an amount of four Gates. Additional Gates can be acquired by buying one of the “Gate pack” licenses (TF6721-TF6724). These licenses are then added to the base license, e.g. TF6720 + TF6721 = 8 Gates. TF6720 Version: 1.5.0 17
## Page 18

Technical introduction 4 Technical introduction TC3 Io T Data Agent is a gateway application that connects multiple data sources with each other. A data source is typically a communication protocol, e.g. ADS, OPC UA or MQTT. The TC3 Io T Data Agent is configured via a graphical configurator, which creates or edits an XML-based configuration file. On startup, this file is read by the TC3 Io T Data Agent core application, which is installed as a service and therefore runs in the background of the operating system. Simply spoken: The XML file tells the TC3 Io T Data Agent what to do. • Which data sources should be connected • Which cloud services should be used • Which symbols (variables) should be exchanged and in which direction • Which data rates and sampling modes should be used A typical installation of TC3 Io T Data Agent on a controller or gateway computer includes only the TC3 Io T Data Agent core application. The graphical configurator is usually installed on an engineering computer and used to connect to the core application over the network but can also be installed and used on the controller or gateway computer. 4.1 Application examples The following sections provide some application examples in which TC3 Io T Data Agent can be used. 4.1.1 AWS Io T Core AWS Io T Core is a managed cloud service that enables connected devices to easily and securely communicate bi-directionally with cloud applications and other devices. Special functionalities, such as the AWS Io T Device Shadow Service, enable communication with devices that are not yet connected. 18 Version: 1.5.0 TF6720
## Page 19

Technical introduction AWS Io T Core and Twin CAT Io T AWS Io T Core is based on the MQTT transport protocol. It is therefore possible to use Twin CAT Io T to send or receive messages to or from AWS Io T Core or AWS Io T Greengrass. Various samples illustrate how to connect to the AWS Io T Core service. Sample Product Description Iot Mqtt Sample Aws I TF6701 This sample demonstrates how you can use MQTT function o T blocks within the PLC logic to connect to AWS Io T Core and exchange data. Data Agent AWS Io T TF6720 This sample demonstrates how to configure the Twin CAT Io T Data Agent to connect to AWS Io T Core and exchange data. [} 63] In a similar way, the samples can also be applied to AWS Io T Greengrass. The associated AWS Io T Greengrass Core can be installed and operated on a C6015 Industrial PC, for example. Typically, the Greengrass Core (or a Lambda function provided there) initiates data communication with the controller, e.g. via OPC UA. However, since the Greengrass Core has an integrated message broker, this communication direction may be reversed. In this case, Twin CAT Io T would establish a connection to the Greengrass Core via an MQTT channel and exchange data accordingly, for example. Further Information Further information about AWS Io T Core can be found in the AWS Io T Core documentation. 4.1.2 Bosch Io T Suite The Bosch Io T Suite is an Io T platform based on open standards and open source and supports seamless integration into the Bosch Io T eco-system. The Bosch Io T Hub provides devices with various communication interfaces for exchanging data with the Bosch Io T Cloud. Bosch Io T Suite and Twin CAT Io T The Bosch Io T Suite includes an MQTT message broker referred to as the Bosch Io T Hub. It is therefore possible to use Twin CAT Io T to send or receive messages to or from the Bosch Io T Suite. The following sample illustrates how to establish a connection to the Bosch Io T Hub. Sample Product Description Iot Mqtt Sample Bosch Io T TF6701 This sample demonstrates how you can use MQTT function blocks within the PLC logic to connect to the Bosch Io T Hub and exchange data. Further Information For more information about the Bosch Io T Suite please visit the official Bosch Io T Suite website. 4.1.3 Google Io T Core Google Io T Core is a managed cloud service that enables distributed devices to exchange data with the Google cloud through a secure transport channel. Google Io T Core and Twin CAT Io T Google Io T Core includes an MQTT message broker. It is therefore possible to use Twin CAT Io T to send or receive messages to or from Google Io T Core. The following sample illustrates how to connect to Google Io T Core. TF6720 Version: 1.5.0 19
## Page 20

Technical introduction Sample Product Description Iot Mqtt Sample Google Io T TF6701 This sample demonstrates how you can use MQTT function blocks from within PLC logic to connect to Google Io T Core and exchange data. 4.1.4 IBM Watson Io T IBM Watson Io T is an Io T suite in the IBM cloud, which offers several services for connecting Io T devices to IBM Bluemix services, processing incoming messages or sending messages to the devices. From a device perspective, the functionalities of IBM Watson Io T enable simple and safe connection of Io T devices with IBM services by facilitating bidirectional communication between the devices and IBM Watson Io T. IBM Watson Io T and Twin CAT Io T Since IBM Watson Io T can be reached via the MQTT transport protocol, it is possible to use Twin CAT Io T for sending messages to IBM Watson Io T or receiving messages from it. Various samples illustrate how to connect to IBM Watson Io T. Sample Product Description Iot Mqtt Sample Ibm Watson Io T TF6701 This sample demonstrates how you can use MQTT function blocks to connect to IBM Watson Io T and exchange data. Publication of data to IBM Watson TF6720 This sample demonstrates how to configure the Twin CAT Io T Data Io T Agent to establish a connection to IBM Watson Io T and exchange data. 4.1.5 Math Works Thing Speak Thing Speak TM is an Io T platform from The Math Works®, well known among other things for the software solutions MATLAB® and Simulink®. The platform offers (apart from a REST API) an MQTT interface, via which the data from the Twin CAT runtime can be sent to Thing Speak TM. Thing Speak TM enables the collection, storage, analysis, visualization of and reaction to incoming data. An important point that sets it apart from other platforms is the option to write MATLAB® code in the web browser, which can be used for the analysis and visualization of the data. It is also possible to use existing licenses for toolboxes from the On-premis programming environment in Thing Speak TM. Functioning The data ingest and the saving of data take place on the basis of so-called channels. Each channel has 8 fields that can be filled with incoming data. Apart from the 8 data fields there are further meta fields available such as latitude, longitude, altitude or a time stamp. Data published on a channel are stored in a database with the option of a data export (JSON, XML, CSV). The number of messages per time unit that can be sent to a channel depends on the stored Thing Speak TM license. The MQTT interface is currently based on the sending of strings that are interpreted by the Thing Speak channel. Examples of possible actions on Thing Speak TM: • Send a message to Twitter • Cyclic execution of Matlab analysis scripts • Execution of a Matlab analysis script, triggered by channel conditions. 20 Version: 1.5.0 TF6720
## Page 21

Technical introduction Applications On account of the data rate – limited by the cloud service – that can currently be sent by the controller to Thing Speak TM, a pronounced edge computing approach is a constructive strategy. MATLAB®/Simulink® models can be integrated in the Twin CAT runtime via the Beckhoff product TE1400 and algorithms for information densification in real time can be executed along with the various Twin CAT functions (Condition Monitoring, filter, etc.). Furthermore, processes with large time constants such as energy data management, building automation, etc. can be handled well with Thing Speak TM. 4.1.6 Microsoft Azure Io T Hub The Microsoft Azure Io T Hub is an Io T suite in the Azure cloud, which offers several services for connecting Io T devices with Azure services, processing incoming messages or sending messages to the devices. From a device perspective, the functionalities of the Microsoft Azure Io T Hub enable simple and safe connection of Io T devices with Azure services by facilitating bidirectional communication between the devices and the Azure Io T Hub. Microsoft Azure Io T Hub and Twin CAT Io T The Microsoft Azure Io T Hub offers several communication interfaces for receiving or sending messages, including MQTT. It is therefore possible to use Twin CAT Io T to send messages to or receive messages from the Microsoft Azure Io T Hub or to control the Device Twin or execute method calls to the device. Various samples illustrate how to connect to the Microsoft Azure Io T Hub. Sample Product Description Iot Mqtt Sample Azure Iot Hub TF6701 This sample demonstrates how you can use MQTT function blocks within the PLC logic to connect to the Microsoft Azure Io T Hub and exchange data. Data Agent TF6720 This sample demonstrates how to configure the Twin CAT Io T Data Agent to establish a connection to the Microsoft Azure Io T Hub and exchange data. Data Agent Device Twin TF6720 This sample demonstrates how to configure the Twin CAT Io T Data Agent to establish a connection to the Microsoft Azure Io T Hub and exchange data with the Device Twin. TF6720 Version: 1.5.0 21
## Page 22

Technical introduction 4.1.7 Node-RED Node-RED is a popular tool that enables workflow-based programming for wiring together hardware devices, APIs and online services in new and interesting ways. It runs on a variety of platforms, e.g. PLC controllers, edge devices, virtual machines or even native services in the cloud. It is a simple open source visual editor for wiring Internet-of-Things services and devices. The system contains so-called “nodes” that look like icons that can be placed on the canvas and wired together by using drag-and-drop. Each node offers a different functionality. For example, there are simple debug nodes to analyze/check the data flow or MQTT nodes that subscribe to data on a MQTT message broker and insert this data into the workflow. Node-RED can be extended by plugins to enrich its functionalities. Twin CAT Io T can be used to send machine data to Node-RED and receive commands from the Node-RED workflow. In addition, other Twin CAT functions may be used as well, e.g. the Twin CAT TCP/IP Server. Node-RED includes built-in support for multiple communication protocols, e.g. MQTT, HTTP, Raw TCP/IP, and so on. In order to connect Twin CAT Io T via MQTT with a Node-RED workflow, a message broker is required as an intermediate. Another alternative would be to use Twin CAT Io T HTTPS/REST with the built-in HTTPS/REST web server of Node-RED. Sources • https://nodered.org/ • https://learn.adafruit.com/raspberry-pi-hosting-node-red/what-is-node-red 4.2 Features The following table gives an overview of the TC3 Io T Data Agent features. The features can be categorized as follows: • General: Basic features of the TC3 Io T Data Agent, e.g. sampling patterns, etc. • Gates: Supported cloud services and protocols, e.g. ADS, MQTT, OPC UA, etc. • Data Format: Supported data formats when sending/receiving data to/from a cloud service • Symbol: Supported data types and additional symbol-related features 22 Version: 1.5.0 TF6720
## Page 23

Technical introduction Gates Description Version ADS ADS devices can be used either via symbolic access or Igrp/ 0.7.0.1 and above Ioff combination. Twin CAT 2/3 I/O channels as well as Twin CAT 2/3 PLC runtimes, Twin CAT 3 Tc COM modules and BC Controllers can be accessed via ADS. OPC UA The TC3 Io T Data Agent can connect to any OPC UA server 0.7.0.1 and above that supports the opc.tcp transport channel. In addition, OPC UA certificates and username/password authentication can be used to secure the communication channel to the server. MQTT Generic MQTT message brokers can be used to send/receive 0.7.0.1 and above data. The message broker needs to support the MQTT TCP transport (no web socket connections are supported at the moment). TLS 1.2 can be used to secure the communication channel either via CA certificate, a client certificate or via a PSK. Microsoft Azure Io T Public cloud service by Microsoft. Can be used to send/receive 0.7.0.1 and above Hub telemetry data. The communication channel is secured via the 1.3.2.1 and above for primary or secondary key of the Io T Hub device. The device Device Twin feature can be created on the Azure Io T Hub configuration website. In addition, the Azure Io T Hub Device Twin service can be used to update the twin document or retrieve desired updates by backend applications. AWS Io T Public Cloud service by AWS. Can be used to send/receive 0.16.2.2 and above data. Configuration is based on specific settings in MQTT gate. TLS 1.2 with a client certificate is mandatory to secure the communication channel. The certificate can be obtained on the AWS Io T configuration website. Data formats Description Version ADS binary Binary ADS data format. 0.7.0.1 and above Can be used for send/receive operations. Simple JSON “Flat” JSON format which consists of a timestamp and key/ 0.16.2.2 and above value pairs that represent the variables. Can be used for send/receive operations. Twin CAT JSON Common JSON data format in all Twin CAT Io T and Analytics 0.7.0.1 and above products as well as the EK9160. See separate documentation article about Twin CAT Io T JSON data format specification. Can be used for send/receive operations. Twin CAT Analytics Common binary data format in all Twin CAT Analytics products 0.26.2.8 and above as well as the EK9160. TF6720 Version: 1.5.0 23
## Page 24

Technical introduction Symbols Description Version Simple data types Simple data types are supported: 0.7.0.1 and above Int16, Int32, Int64, UInt16, UInt32, Float, Double, … Strings Strings are supported 0.7.0.1 and above Arrays Arrays with simple and complex data types are supported for 1.2.17.7 and above publish direction Structured Types Structured types are supported for publish direction 1.2.17.7 and above Trigger Symbol Trigger Symbols can be used to set up a “send on demand” use 0.8.2.21 and above case Type Conversion Type conversion can be used to convert between different data 0.8.2.21 and above types Multi-link Link one subscriber symbol with multiple publisher symbols. 0.24.1.4 and above (not the other way around) Units Units are supported as meta-data on a symbol. This setting 0.26.2.8 and above depends on the data format and gate. Rounding float types Rounding of float types to a specified amount of decimal places 1.3.2.1 and above is supported 4.3 Internet connectivity One of the main advantages of Twin CAT Io T and the EK9160 Io T coupler is that the cloud-related communication protocols are based on publisher/subscriber (“pub/sub”) and broker-based connectivity principles. From a firewall point-of-view, publisher/subscriber is based on only outgoing data communications. This not only allows an easy integration into the existing IT infrastructure, but is also very convenient for security reasons, as no incoming firewall ports need to be opened (“port forwarding”) to send and receive data. Because of this technical advantage, it is not required or not recommended to place Twin CAT Io T and EK9160 products on the internet edge or untrusted network. Instead, these products can and should be used within local, trusted network boundaries – secured by a firewall from the Internet. 24 Version: 1.5.0 TF6720
## Page 25

Technical introduction The following table gives an overview about the commonly used communication protocols and their corresponding network ports. Note that this port overview depends on the specific environment and scenario and is based on commonly used default settings. Service Protocol Network port Notes MQTT Message Broker MQTT 1883/tcp MQTT Message Broker MQTT with TLS 8883/tcp Microsoft Azure Io T Hub AMQP 5671/tcp Microsoft Azure Io T Hub MQTT with TLS 8883/tcp AWS Io T MQTT with TLS 8883/tcp AWS Greengrass MQTT with TLS 8883/tcp Microsoft Azure Io T Hub TC3 Io T Data Agent uses AMQP when establishing a connection with the Microsoft Azure Io T Hub. 4.4 MQTT basics MQTT (Message Queueing Telemetry Transport) is a publisher/subscriber-based communication protocol which enables message-based transfer between applications. The message broker is a central component of this transfer type. It distributes messages between the individual applications or the sender and receiver of a message. The message broker decouples the sender and receiver, so that it is not necessary for the sender and receiver to know and exchange each other's address information. During sending and receiving, all communication devices contact the message broker, which handles the distribution of the messages. TF6720 Version: 1.5.0 25
## Page 26

Technical introduction Client ID When establishing a connection with the message broker, the client transmits a Client ID, which is used to uniquely identify the client on the message broker. The MQTT communication driver from Twin CAT 3 automatically generates its own Client ID, which is based on the following naming scheme: Plc Project Name-Tc Mqtt Client%n %n is an incremental counter for the number of the respective MQTT client instance. Each instance of the FB_Iot Mqtt Client function block increments this counter. In most cases, using this Client ID format is sufficient. In special cases, e.g. depending on the message broker or also due to the own MQTT application, an application-specific Client ID must be assigned. This can be done via a corresponding input at the FB_Iot Mqtt Client and FB_Iot Mqtt5Client function blocks. If a unique Client ID is to be generated automatically at the start of the PLC project, the use of a GUID is recommended, which can be generated via the FB_Create Guid function block from the Tc2_System library. The following sample code illustrates the use of this function block. PROGRAM MAIN VAR fb Guid : FB_Create GUID; obj Guid : GUID; s Guid : STRING; n State : UINT; b Start : BOOL; // set to TRUE to start this sample END_VAR CASE n State OF 0 : IF b Start THEN b Start := FALSE; n State := n State + 1; END_IF 1 : // create GUID using FB_Create Guid from Tc2_System library fb Guid(b Execute := TRUE, p Guid Buffer := ADR(obj Guid), n Guid Buffer Size := SIZEOF(obj Guid)); IF NOT fb Guid.b Busy THEN fb Guid(b Execute := FALSE); 26 Version: 1.5.0 TF6720
## Page 27

Technical introduction IF NOT fb Guid.b Error THEN n State := n State + 1; ELSE n State := 255; // go to error state END_IF END_IF 2: // GUID has been created, now convert to STRING s Guid := GUID_TO_STRING(obj Guid); n State := n State + 1; 3: // done 255: // error state END_CASE After execution of this State Machine, the variable s Guid contains the generated GUID as STRING. This can then be used at the FB_Iot Mqtt Client and FB_Iot Mqtt5Client function blocks as Client ID. Payload The content of an MQTT message is referred to as payload. Data of any type can be transferred, e.g. text, individual numerical values or a whole information structure. Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Topics If a message broker is used that is based on the MQTT protocol, sending (publish mode) and subscribing (subscribe mode) of messages is organized with the aid of so-called topics. The message broker filters incoming messages based on these topics for each connected client. A topic may consist of several levels; the individual levels are separated by “/”. Example: Campus / Building1 / Floor2 / Room3 / Temperature When a publisher sends a message, it always specifies for which topic it is intended. A subscriber indicates which topic it is interested in. The message broker forwards the message accordingly. TF6720 Version: 1.5.0 27
## Page 28

Technical introduction Communication example 1 from the diagram above: • An application subscribes to “topic1”. • A controller publishes a message to “topic1”. • The message broker forwards the message to the application accordingly. Communication example 2 from the diagram above: • A controller subscribes to “topic2”. • An application publishes a message to “topic2”. • The message broker forwards the message to the controller accordingly. Wildcards It is possible to use wildcards in conjunction with topics. A wildcard is used to represent part of the topic. In this case a subscriber may receive messages from several topics. A distinction is made between two types of wildcards: • Single-level wildcards • Multi-level wildcards Example for single-level wildcard: The + symbol describes a single-level wildcard. If it is used by the subscriber as described below, for example, corresponding messages to the topics are either received by the subscriber or not. • The receiver subscribes to Campus/Building1/Floor2/+/Temperature • The publisher sends to Campus/Building1/Floor2/Room1/Temperature - OK • The publisher sends to Campus/Building1/Floor2/Room2/Temperature - OK • The publisher sends to Campus/Building42/Floor1/Room1/Temperature - NOK • The publisher sends to Campus/Building1/Floor2/Room1/Fridge/Temperature - NOK Example for multi-level wildcard: 28 Version: 1.5.0 TF6720
## Page 29

Technical introduction The # symbol describes a multi-level wildcard. If it is used by the subscriber as described below, for example, corresponding messages to the topics are either received by the subscriber or not. The # symbol must always be the last symbol in a topic string. • The receiver subscribes to Campus/Building1/Floor2/# • The publisher sends to Campus/Building1/Floor2/Room1/Temperature - OK • The publisher sends to Campus/Building1/Floor2/Room2/Temperature - OK • The publisher sends to Campus/Building42/Floor1/Room1/Temperature - NOK • The publisher sends to Campus/Building1/Floor2/Room1/Fridge/Temperature - OK • The publisher sends to Campus/Building1/Floor2/Room1/Humidity - OK Qo S (Quality of Service) Qo S is an arrangement between the sender and receiver of a message with regard to guaranteeing of the message transfer. MQTT features three different levels: • 0 – not more than once • 1 – at least once • 2 – exactly once Both types of communication (publish/subscribe) with the message broker must be taken into account and considered separately. The Qo S level that a client uses for publishing a message is set by the respective client. When the broker forwards the message to client that has subscribed to the topic, the subscriber uses the Qo S level that was specified when the subscription was established. This means that a Qo S level that may have been specified as 2 by the publisher can be “overwritten” with 0 by the subscriber. Qo S-Level 0 At this Qo S level the receiver does not acknowledge receipt. The message is not sent a second time. Qo S-Level 1 At this Qo S level the system guarantees that the message arrives at the receiver at least once, although the message may arrive more than once. The sender stores the message internally until it has received an acknowledgement from the receiver in the form of a PUBACK message. If the PUBACK message fails to arrive within a certain time, the message is resent. TF6720 Version: 1.5.0 29
## Page 30

Technical introduction Qo S-Level 2 At this Qo S level the system guarantees that the message arrives at the receiver no more than once. On the MQTT side this is realized through a handshake mechanism. Qo S level 2 is the safest level (from a message transfer perspective), but also the slowest. When a receiver receives a message with Qo S level 2, it acknowledges the message with a PUBREC. The sender of the message remembers it internally until it has received a PUBCOMP. This additional handshake (compared with Qo S 1) is important for avoiding duplicate transfer of the message. Once the sender of the message receives a PUBREC, it can discard the initial publish information, since it knows that the message was received once by the receiver. In other words, it remembers the PUBREC internally and sends a PUBREL. Once the receiver has received a PUBREL, it can discard the previously remembered states and respond with a PUBCOMP, and vice versa. Whenever a package is lost, the respective communication device is responsible for resending the last message after a certain time. The Last Will is a message sent by the broker to all clients subscribed to the matching topic in the event of an abnormal connection failure. If the MQTT client in the PLC loses the connection to the broker and a Last Will was stored when the connection was established, this Last Will is communicated by the broker without the client having to do it. In the event of a planned disconnect, the Last Will is not necessarily transmitted according to the specification. From the PLC programmer's point of view, he can decide whether he wants to publish the Last Will before calling the disconnect. To this end, the Last Will message is published again on the Last Will topic. This is necessary because the broker would not publish the Last Will message due to the regular disconnection. In the event of a Twin CAT context change and a resulting restart of the MQTT communication, the Io T driver sends the previously specified Last Will to the broker, because at this point, doing this from the PLC is not an option. If no Last Will was defined when the connection was established, no message will be transmitted before the disconnect. Safety When a connection to the message broker is established, security mechanisms such as TLS can be used to encrypt the communication connection or to execute authentication between client and message broker. 30 Version: 1.5.0 TF6720
## Page 31

Technical introduction Sources For further and more detailed information about MQTT, we recommend the following sites: Hive Mq Blog: http://www.hivemq.com/blog/mqtt-essentials/ (the main basis for this article) 4.5 Startup modes TC3 Io T Data Agent is automatically installed as a Windows service that runs under the local system context (and is therefore independent of the user account logged in) and starts automatically during system boot. After starting the TC3 Io T Data Agent, the core application waits for a trigger command to start the communication. The trigger command is usually send via the configurator or the system tray application (see Configurator [} 38] and System tray [} 51]). You can also configure an Auto Start option per configuration file by using the graphical configurator tool. Command line As an alternative, the TC3 Io T Data Agent can be executed as a standalone application on the Windows command line. To do so, start the TC3 Io T Data Agent executable file (Tc Iot Data Agent.exe) in the installation directory. You can set different startup options by specifying parameters to the process call, e.g. a path to the configuration file or logging settings. Use the parameter “-h” for a list of all startup options. Examples: Process call Description Tc Iot Data Agent.exe The configuration file Tc Iot Data Agent Config.xml from the default config directory %TC_BOOTDIR% is used. Waits for a trigger command to start the communication. Tc Iot Data Agent.exe -a Starts the communication after startup automatically. Takes the config file automatically from %TC_BOOTDIR%. Tc Iot Data Agent.exe -c Path To Config Specifies the configuration file to be used. Waits for a trigger command to start the communication. Tc Iot Data Agent.exe -a -c Path To Config Specifies the configuration file to be used. Starts the communication automatically without waiting for a trigger command. Tc Iot Data Agent.exe -l VERBOSE The configuration file is retrieved from the Twin CAT boot directory and logging is activated in verbose mode. The Windows command line is used as log output. Tc Iot Data Agent.exe -l VERBOSE -o The configuration file is retrieved from the Twin CAT boot Path To File directory and logging is activated in verbose mode. A file is used as log output. 4.6 Security Depending on the functionality of each gate, TC3 Io T Data Agent supports several security mechanisms to secure data communication, for example the encryption of messages and client/server authentication. The following table gives an overview of the different security mechanisms in each supported Gate. TF6720 Version: 1.5.0 31
## Page 32

Technical introduction Gate Security mechanisms Description ADS none ADS communication should be treated as none secure. OPC UA Client/Server authentication Depending on the functionalities of the OPC UA server that the TC3 Io T Data Agent should connect to, the following Username/password security mechanisms may can be used: authentication • Client/Server authentication can be used via X.509 Authorization certificates (public/private key) and establishing a trust Data encryption relationship between the communication participants. • Username/password authentication can be used by an OPC UA client to connect to an OPC UA server. • Authorization can be used on the server to define access levels on OPC UA nodes to configure which user identity may access which nodes on an OPC UA server. • Data encryption can be used to encrypt OPC UA messages on the wire. MQTT Client/Server authentication Depending on the functionalities of MQTT message broker that the TC3 Io T Data Agent should connect to, the following Username/password security mechanisms may be used. authentication • Client/Server authentication can be used via X.509 Authorization certificates (public/private key) and establishing a trust Data encryption relationship between the communication participants (client and message broker) • Username/password authentication can be used by a client to connect to the message broker • Authorization can be used on the message broker to define access levels on topics in order to configure which user identity may access which topic on the message broker • Data encryption can be used to encrypt messages on the wire. The TC3 Io T Data Agent uses TLS version 1.2 for securing the communication channel. Microsoft Azure Device authentication Every Azure Io T Hub client needs to be registered as a device on the Io T Hub instance. During device registration, a Io T Hub Data encryption Device Id and Shared Access Key is generated, which need to be used during connection establishment for authenticating the device to the Io T Hub instance. In addition, messages are encrypted on the wire. AWS Io T Device authentication Every AWS Io T client needs to be registered as a “thing”. A thing/device is configured with X.509 certificates that Authorization authenticates the device at AWS Io T and can also be linked Data encryption with security policies to authorize the device to perform certain actions. In addition, messages are encrypted on the wire. TLS version 1.2 is used to secure the communication channel. 4.7 Buffering of data The Data Agent offers a buffer function for short-term network failures. It is very important to note that buffering takes place exclusively in RAM. Accordingly, an eye should always be kept on the RAM with this buffer function. If a connection to the target has been restored, the Data Agent begins to process the buffer. Another point to note is the restrictions of a message brokers to which data are sent. There are message brokers that are limited to a certain number of messages per time unit. Care must be taken when conceiving a Data Agent application that this upper limit is not exceeded when processing a buffer. 32 Version: 1.5.0 TF6720
## Page 33

Technical introduction Configuration in the Data Agent A Publisher channel offers the possibility to set the size of a buffer. This size is related to the number of messages to be buffered. For this reason there is a setting option Inhibit Time on this Publisher channel. This specifies the time interval with which the messages are to be collected from the buffer as soon as the connection to the target has been restored. In the case of a cyclic Publisher channel the Inhibit Time must be smaller than the Cycle Time, as otherwise the buffer can never be emptied. In the case of an On Change or Trigger channel, the Inhibit Time indicates the cycle time with which the data are collected from the buffer and published to the Message Broker. If the Inhibit Time is set to 0, the messages are sent to the target by the Data Agent as quickly as possible. If new messages arrive during the processing of the buffer, they are appended to the end of the buffer. This ensures the correct order of the data. 4.8 Supported protocols and services 4.8.1 Microsoft Azure Io T Hub Microsoft Azure Io T Hub is an Io T suite in the Azure cloud, which offers several services for connecting Io T devices with Azure services. Microsoft Azure Io T Hub enables devices to establish a secure, bi-directional data communication to send telemetry data, receive commands or maintain a digital twin of the device. Configuration in Twin CAT Io T Data Agent Connections to the Microsoft Azure Io T Hub service can be easily configured within the Twin CAT Io T Data Agent Configurator and are represented by an own Gate type. The Gate configuration includes all required parameters to establish a connection to the Azure Io T Hub, e.g. Device Id, Primary Key/Secondary Key, Hostname and a link to a trusted CA certificate for the connection. TF6720 Version: 1.5.0 33
## Page 34

Technical introduction Send data Receive data Properties Microsoft Azure Io T Hub offers the functionality to send message telemetry meta data. Such data can be send as so-called "Properties". In Twin CAT Io T Data Agent Configurator, properties can be set as channel parameters in the Parameter Editor. 34 Version: 1.5.0 TF6720
## Page 35

Technical introduction A cloud-application (e.g. Azure Stream Analytics) can then take these parameters for further processing. 3/19/2021 3:54:51 PM> Device: [CX-12345], Data: [{"Timestamp":"2021-03-19T14:54:51.1650000+01:00","Group Name":"Publisher","MAIN.n Counter":49510}]Pro perties: 'Company': 'Beckhoff Automation' 'Device': 'CX5130-0020' 'OS': 'Windows 10' 'OS Build': '1909' Device Twin TF6720 Version: 1.5.0 35
## Page 36

Configuration 5 Configuration 5.1 Quick Start This section describes how to quickly start the TC3 Io T Data Agent. The communication scenario is a typical use case for the Data Agent: variables from a southbound device (Twin CAT PLC runtime) are sampled and published to a northbound service (MQTT message broker). In this example, the message broker is running on the same computer as the PLC runtime. To set up this scenario, the following steps are required. All steps are performed on the same computer. • Installing the software [} 36] • Preparing the PLC program [} 36] • Configuring the TC3 Io T Data Agent [} 36] • Displaying the published messages [} 38] Install the software 1. Install TF6720 Io T Data Agent as described in the Installation [} 11] section. 2. Install Mosquitto MQTT Message Broker with its default setup settings. The Message Broker can be installed anywhere and is connected to via its hostname or IP address. 3. Open a Windows Console, navigate to the installation directory of the Mosquitto MQTT Message Broker (typically C:\Program Files (x86)\mosquitto) and start the Broker in verbose mode by executing the following command: mosquitto.exe -v Mosquitto MQTT Message Broker The Mosquitto MQTT Message Broker can be downloaded from www.mosquitto.org. Make sure to follow any installation instructions provided by the Mosquitto installer. Mosquitto startup By default, the Mosquitto MQTT Message Broker is installed as a Windows service. You can also start the mosquitto.exe from a command line and specify parameters like "-v" for verbose output. If you want to start the broker from a command line, make sure that the Mosquitto Windows service is not running. Prepare the PLC program Set up a Twin CAT 3 PLC project and activate trial licenses for TC1200 (PLC) and TF6720 (TC3 Io T Data Agent). In this sample the PLC program should include the following variables: PROGRAM MAIN VAR n Counter1 : INT; n Counter2 : LREAL; END_VAR These two variables should be incremented cyclically. Add the following implementation code for the PLC program: n Counter1 := n Counter1 + 1; n Counter2 := n Counter2 + 0.1; Activate the project and start Twin CAT into run mode. Make sure that the PLC program is running by logging in. Configuring the Twin CAT Io T Data Agent 1. Start the Twin CAT Io T Data Agent configurator either via the link in the Windows Start menu or via the taskbar application (see Configurator [} 38]). 36 Version: 1.5.0 TF6720
## Page 37

Configuration 2. Follow the step-by-step instructions below to create a Data Agent configuration. Alternatively, you can open the "Sample_Quick Start.xml" configuration file located in the Data Agent installation directory and go directly to step (m). 3. Start a new configuration by clicking the New icon on the Configurator toolbar. 4. Right-click an empty area in the topology view and select Add Gate (ADS). 5. Select the new gate and make sure the local Ams Net Id and ADS Port 851 are selected in the properties window 6. Right-click on the new gate in the topology view and select Add Channel (Subscriber). 7. Select the new channel and make sure the sampling mode is set to "cyclic" and the cycle time is set to "1000" in the Properties window. 8. Open the Target Browser and navigate to your local PLC runtime (Port 851). 9. Select the variables "n Counter1" and "n Counter2" and drag them to the subscriber channel in the topology view. 10. Right-click on an empty area in the topology view and select Add Gate (MQTT). 11. Select the new gate and make sure that the URL is set to 127.0.0.1 and Port 1883 is used. 12. Right-click on the new gate in the topology view and select Add Channel (Publisher). 13. Select the new channel and make sure that the sampling mode is set to “cyclic”. Set the cycle time to “1000” and the formatter to “Twin CAT JSON”. The MQTT topic can be set to a topic of your choice, e.g. “Test Topic”. 14. Hold the CTRL key and drag the subscriber channel to the publisher channel in order to create a mapping between the source and destination symbols. Note that the destination symbols are automatically created. 15. Activate the configuration by clicking on the Activate Configuration button in the toolbar. TF6720 Version: 1.5.0 37
## Page 38

Configuration Displaying the published messages Open a command line window and navigate to the installation directory of the Mosquitto MQTT Message Broker (typically "C:\Program Files\mosquitto" or "C:\Program Files (x86)\mosquitto"). Start the Mosquitto Subscriber Tool by executing the following command: mosquitto_sub.exe -t Test Topic. The Mosquitto Subscriber tool will now receive the messages that are published from the Twin CAT Io T Data Agent. 5.2 Configurator The TC3 Io T Data Agent configurator is an easy-to-use, graphical user interface that abstracts the XML configuration file and provides a modern interface that includes all functionalities to easily configure symbols that should be send to or received from a cloud service. The configurator is also used to configure TC3 Io T Functions. Standard components The TC3 Io T Data Agent configurator consists of the following areas: 38 Version: 1.5.0 TF6720
## Page 39

Configuration Menu and toolbar Provides commands for saving and opening files and for starting and stopping the application Hierarchical Tree View Gives a hierarchical overview of the configuration to create and edit a configuration Topology view Gives a graphical overview of the configuration to create and edit a configuration Properties window Shows the properties of an activated component in the topology or tree view. Logging Provides log information from the configurator. Cascading Editor Helps to navigate through large and complex navigations by providing filtering mechanisms for symbols Mapping Links Gives an overview of all links between symbols in the configuration Target Browser Is used to provide symbolic access for ADS and OPC UA target runtimes Installation The configurator is installed automatically by the setup and is available as a shortcut in the Windows start menu. When starting the configurator the first time, it asks for the generation of an OPC UA client certificate. This certificate is used by the configurator in its integrated OPC UA Target Browser to connect to a server and search its namespace. After the certificate has been created, the configurator user interface is displayed. 5.2.1 Topology view The topology view (or “canvas”) is the central graphical configuration area of the TC3 Io T Data Agent configurator. It shows the following components of a configuration: • The configured gates, channels and symbols • The relationship (mapping) between gates, channels and symbols TF6720 Version: 1.5.0 39
## Page 40

Configuration • The cardinality on each relationship The topology view can be used to create and edit a configuration. Simply right-click the canvas to open the context menu and select from the variety of configuration options, e.g. to create a new gate, attach a new channel to a gate or remove a component from the configuration. You can move any object in the topology view by dragging it to a new position. Each attached subcomponent is moved together with its parent. Optionally, you can also hide a subcomponent by clicking the expand button of its parent. When saving a configuration, the position of each object is saved in the configuration file. In order to make navigational tasks a little easier, the topology view supports the following functionalities: • Scrollbars for vertical and horizontal navigation • Vertical navigation via mouse wheel • Horizontal navigation via mouse wheel and SHIFT key (press and hold) • Zoom In/Zoom Out via mouse wheel and CTRL key (press and hold) Instead of the topology view you can also use the tree view for configuration, but the topology view might give a better graphical overview of the currently configuration (see Tree view [} 40]) 5.2.2 Tree view The tree view provides a hierarchical view of the currently opened configuration. It shows the following components of a configuration: • The configured gates, channels and symbols • The existence of a relationship (mapping) between symbols The tree view can also be used to edit the configuration, but it may be easier to use the topology view instead (see Topology view [} 39]). 40 Version: 1.5.0 TF6720
## Page 41

Configuration 5.2.3 Mappings The mappings window gives an overview of all links between symbols in the currently opened configuration. When a link is selected, it is automatically highlighted in the topology view. 5.2.4 Target Browser The Target Browser is used to provide symbolic access for ADS and OPC UA target runtimes. It can be used to configure symbols for a target runtime by drag-and-drop. Fig. 1: TF6720 Version: 1.5.0 41
## Page 42

Configuration 5.2.5 Cascading Editor The Cascading Editor helps to navigate through large and complex configurations by providing filtering mechanisms for symbols. Starting from left to right you can select gates and channels in order to display the corresponding symbols. In addition, you can also search for symbol names using free text. When a component is selected, it is automatically highlighted in the topology view. 5.2.6 Parameter Editor The Parameter Editor enables the configuration of symbol metadata for symbols in a Publisher channel. As a prerequisite, the Publisher channel must be configured to use the "Twin CAT JSON" data format. New symbol parameters can then be added by right-clicking on a symbol and selecting Add Symbol Parameter. This adds a new symbol parameter entry to the Parameter Editor. The data type, name and value of the new parameter can then be defined. 42 Version: 1.5.0 TF6720
## Page 43

Configuration A result of the above configuration can look like this when using the Twin CAT JSON data format. In this configuration, the variable "GVL_nodes_dynamic.dyn_scalar_UI8" was configured with the symbol parameters Min, Max and Unit. These parameters are added to the "Meta Data" section of the Twin CAT JSON-formatted message. { "Timestamp": "2020-09-28T12:32:49.0370000+02:00", "Group Name": "Publisher", "Values": { "GVL_nodes_dynamic.dyn_scalar_UI8": 259096147, "GVL_nodes_dynamic.dyn_scalar_UI1": 83, "GVL_nodes_dynamic.dyn_scalar_UI2": 32339, "GVL_nodes_dynamic.dyn_scalar_UI4": 259096147 }, "Meta Data": { "GVL_nodes_dynamic.dyn_scalar_UI8": { "Timestamp": "2020-09-28T12:32:49.0350000+02:00", "Min": -10, "Max": 100, "Unit": "Celsius" }, "GVL_nodes_dynamic.dyn_scalar_UI1": { "Timestamp": "2020-09-28T12:32:49.0350000+02:00" }, "GVL_nodes_dynamic.dyn_scalar_UI2": { "Timestamp": "2020-09-28T12:32:49.0350000+02:00" }, "GVL_nodes_dynamic.dyn_scalar_UI4": { "Timestamp": "2020-09-28T12:32:49.0350000+02:00" } } } Parameters can also be added to a channel, adding metadata properties to the root message. Example: As a result, the root message now contains a static metadata property called "Room", which has the value "Living Room": { "Timestamp": "2020-09-30T09:55:58.1160000+02:00", "Group Name": "Publisher", "Room": "Living Room", "Values": { "GVL_nodes_dynamic.dyn_scalar_UI8": 267266470, "GVL_nodes_dynamic.dyn_scalar_UI1": 166, "GVL_nodes_dynamic.dyn_scalar_UI2": 10662, "GVL_nodes_dynamic.dyn_scalar_UI4": 267266470 }, TF6720 Version: 1.5.0 43
## Page 44

Configuration "Meta Data": { "GVL_nodes_dynamic.dyn_scalar_UI8": { "Timestamp": "2020-09-30T09:55:58.1140000+02:00", "Min": -10, "Max": 100, "Unit": "Celsius" }, "GVL_nodes_dynamic.dyn_scalar_UI1": { "Timestamp": "2020-09-30T09:55:58.1140000+02:00" }, "GVL_nodes_dynamic.dyn_scalar_UI2": { "Timestamp": "2020-09-30T09:55:58.1140000+02:00" }, "GVL_nodes_dynamic.dyn_scalar_UI4": { "Timestamp": "2020-09-30T09:55:58.1140000+02:00" } } } 5.2.7 Settings This section provides some detailed information about the different configuration parameters that can be set on gates, channels and symbols. 5.2.7.1 Gates A Gate represents a communication protocol or specific connectivity service, e.g. ADS, OPC UA, MQTT, AWS Io T or Microsoft Azure Io T Hub. Each Gate is configured with parameters that are specific for the corresponding Gate type. ADS A Beckhoff ADS device represents either a Twin CAT 2/3 or a Beckhoff BC device. ADS is the common Beckhoff communication protocol and can be used to access many parts of the Twin CAT system. The most common application scenarios for TC3 Io T Data Agent involve access to a Twin CAT 2/3 PLC, C++, Tc COM modules or the I/O process image, which is done via ADS. When configuring an ADS gate, the following settings are required by the TC3 Io T Data Agent to access the underlying ADS device: Setting Description Ams Net Id Ams Net Id of the target device, e.g. 127.0.0.1.1.1 for the local device. Ads Port Ads Port of the target device, e.g. 801 (Twin CAT 2 PLC) or 851 (Twin CAT 3 PLC) Io Mode Specifies how the TC3 Io T Data Agent should communicate with the ADS device. The following options can be set: • Direct: accesses every symbol with a separate ADS command. Mandatory for BC controllers but increases ADS traffic • Batched: accesses symbols batched into an ADS sum command, which optimizes ADS traffic and can be used for Twin CAT 2 and 3 PLC or C++ runtimes OPC UA OPC UA is a standardized, industrial, client/server communication protocol and adopted by many vendors for different use cases. The TC3 Io T Data Agent can access OPC UA server devices to connect variables (so-called “nodes”) on those devices with Io T services. When configuring an OPC UA gate, the following settings are required by the TC3 Io T Data Agent to access the underlying OPC UA device: 44 Version: 1.5.0 TF6720
## Page 45

Configuration Setting Description Server URL The OPC UA Server URL, e.g. opc.tcp://localhost:4840 Security policy The OPC UA security policy that the TC3 Io T Data Agent should use during connection establishment with the OPC UA server Security mode The OPC UA message security mode that the TC3 Io T Data Agent should use during connection establishment with the OPC UA server Authentication mode The OPC UA authentication mode that the TC3 Io T Data Agent should use during connection establishment with the OPC UA server MQTT MQTT can be used for connecting to a generic message broker, e.g. Mosquitto, Hive MQ or similar broker types. Setting Description Broker address The IP address or hostname of the MQTT message broker Port MQTT specifies port 1883 for unencrypted communication and 8883 for encrypted communication Client Id A numeric or string-based value that identifies the client. Depending on the message broker type, this ID should be unique Authentication mode Specifies if the TC3 Io T Data Agent should authenticate to the broker by using a username/password combination TLS mode Specifies if TLS should be used to secure the communication channel to the message broker. Note that the message broker also needs to support TLS in order for this to work. Different options are available for TLS: • CA certificate: Only uses the CA certificate for server authentication • Client certificate: Uses a client certificate for mutual client/server authentication • PSK: Used a common PSK-Identity and PSK-Key that is known to the message broker and the client Microsoft Azure Io T Hub With Azure Io T Hub the Microsoft Azure cloud platform offers a connectivity service in the cloud that provides bi-directional communication, device security and automatic scalability. In the TC3 Io T Data Agent, the Io T Hub can be configured as a special gate type. Setting Description Host Name URL of the Azure Io T Hub instance Device Id Device Id of the device that has been created on the Io T Hub configuration website Shared Access Key Either the primary or secondary device key that has been generated together with the device on the Io T Hub configuration website CA file CA file that is used for server authentication. At the time writing this article, three certificates are in play during the server authentication, which form part of the certificate chain and are linked together. • Root CA: Baltimore Cyber Trust Root • Intermediate CA: Baltimore Cyber Trust • Wilcard certificate During the initial TLS handshake, only the first two are sent by the server to the client. The client will normally only validate the Root CA of the chain and will determine if it is trusted. In order to acquire the CA file for the Root CA, you can open the Windows certificate store (certmgr.msc), browse to the trusted root authorities and export the Baltimore Cyber Trust Root certificate. TF6720 Version: 1.5.0 45
## Page 46

Configuration AWS Io T With AWS Io T the Amazon Web Services cloud platform offers a message broker service in the cloud that provides bi-directional communication, device security and automatic scalability. In the TC3 Io T Data Agent, AWS Io T is configured as a regular MQTT gate. However, some special MQTT settings have to be configured to successfully connect to an AW Io T instance. Setting Description Broker address The URL of the AWS Io T instance Port Port 8883 for encrypted TLS communication is mandatory Client Id Can be set to anything but needs to be unique. Typically this could be the AWS Io T thing name. Authentication mode Set to “No authentication”. Authentication on AWS Io T is done via the TLS client certificate. TLS mode Automatically set to “Client certificate” by the configurator. Select path to CA file, client certificate file and client key file. These are the files that can be generated and downloaded on the AWS Io T configuration website. 5.2.7.2 Channels Channels are configured on a Gate to send (“publisher”) or receive (“subscriber”) data to/from a Gate. • Source: This Gate is the source of the data, i.e. the TC3 Io T Data Agent connects to the Gate and requests data from it in order to send it somewhere else (to a "Destination Gate"). Technically, this is also referred to as the “Subscriber Channel”. • Destination: This Gate is the destination of the data, i.e. the TC3 Io T Data Agent connects to the Gate and sends it data that it has received from another Gate (from a "Source Gate"). Technically, this is also referred to as the “Publisher Channel”. Each channel has different settings that either describe the data format that should be used for this channel or the sampling settings that the TC3 Io T Data Agent should use for gathering data. These settings may also depend on the Gate type for which the channel is configured. All available settings are listed in the table below. 46 Version: 1.5.0 TF6720
## Page 47

Configuration Setting Description Applicable to Gate type Direction Specifies whether the channel should be either a All Gates Publisher (sender) or Subscriber (receiver) Channel. Depending on the selection and Gate type, other settings are required or pre-selected. Setting Description Applicable to Gate type Sampling Mode Selects if the channel should use either cyclic or All Gates event-based sampling mechanisms when gathering data from a source. It should be noted that not all Gates support both types, depending on the direction. An MQTT Gate, for example, uses when receiving data always Sampling Mode “event” (this is always event-based due to the Pub/Sub principle). Cycle Time Only applicable for Sampling Mode “cyclic”. Specifies All Gates the sampling rate in [ms]. Timeout The timeout for a communication with the Gate in [ms]. All Gates Partial Update Enables/disables partial updates on this channel. All Gates When enabled (default), a Publish includes only the updated symbol. When disabled, a Publish includes all symbols of a channel with their last known value. Only applicable to Publisher channels. Buffer Size Specifies the size (number of messages) of the ring MQTT, AWS Io T, Azure Io T buffer in the event of connection loss. Hub Setting Description Applicable to Gate type Formatter Specifies the data format to use for this channel, such MQTT, AWS Io T, Azure Io T as binary or JSON. Note that some Gates require their Hub channels to use a predefined data format, such as ADS or OPC UA Gates, because communication with these devices requires a specific format. In this case the Formatter is predefined and not changeable via the configurator. Formatter Type Specifies the Formatter type on this channel. In most MQTT, AWS Io T, Azure Io T cases, the Formatter type is an In Out type. For more Hub information on this setting, see our documentation article on writing custom plugins using the Formatter interface. Setting Description Applicable to Gate type Topic Specifies the MQTT topic to be used for publishing or MQTT subscribing. Qo S Specifies the Qo S (Quality-of-Service) level to be MQTT, AWS Io T used for publishing or subscribing. Retain Specifies whether a message should be sent as MQTT "Retain". (Only relevant for the Publisher channel) TF6720 Version: 1.5.0 47
## Page 48

Configuration Setting Description Applicable to Gate type Send State Info When enabled, the TC3 Io T Data Agent publishes its MQTT, AWS Io T Online State to the subtopic /Desc/ and uses this subtopic in its Last Will. When the TC3 Io T Data Agent connects to the message broker, a JSON message is published to this topic containing the following { “Online State” : true } When the TC3 Io T Data Agent properly disconnects from the message broker, the following message is sent to this topic: { “Online State” : false } When the message broker detects, that the TC3 Io T Data Agent has lost the connection, the following message is sent to this topic (Last Will): { “Online State” : false } Sampling Modes The TC3 Io T Data Agent includes different sampling modes that influence the way data is acquired from a source or written to a destination. The sampling mode can be set on a channel. The following sampling modes are currently available: • Cyclic • On Change • Trigger Symbol Cyclic Cyclic sampling means that the TC3 Io T Data Agent is cyclically sampling the gate for data (subscriber channel) or cyclically writing data to a gate (publisher channel). On a subscriber channel, this results in cyclic read commands whereas on a publisher channel this results in cyclic write commands, e.g. on an ADS or OPC UA gate. On gate types that are based on publisher/subscriber concepts, e.g. MQTT, AWS Io T and Azure Io T Hub gates, cyclic requests on a subscriber channel are automatically replaced by subscriptions whereas on a publisher channel this results in cyclic publish commands. On Change On Change sampling means that the TC3 Io T Data Agent only communicates data with a gate if the value of a variable has changed. Trigger symbols Trigger symbols enable “on demand” sampling, e.g. if a certain condition for a specified symbol (the so- called “trigger symbol”) is fullfilled. Different condition types can be set. They are configured as part of a channel and allow to specify the following condition types. Condition type Description EQ Trigger symbol value equals a given value NE Trigger symbol value differs from a given value LE Trigger symbol value is less than or equals a given value GE Trigger symbol value is greater than or equals a given value LT Trigger symbol value is less than given value GT Trigger symbol value is greater than given value If the condition is fullfilled, all symbols in that channel are published to the corresponding gate. In addition you can specify how often the symbol values should be send. 48 Version: 1.5.0 TF6720
## Page 49

Configuration Send behavior Description rising Edge Symbols are only send once when the condition is fullfilled continuous Symbols are send as long as the condition is fullfilled Usage of trigger symbols Trigger symbols can only be configured for ADS and OPC UA subscriber symbols. • Add the symbol that should act as trigger symbol to the ADS or OPC UA subscriber channel. • Configure the linked publisher channel with Sampling Mode “On Trigger” to specify the previously added symbol as trigger symbol. 5.2.7.3 Symbols Symbols represent variables from a gate, e.g. a Twin CAT PLC variable. The symbol configuration includes the address information that the Data Agent requires in order to read a symbol’s value or write to it. This address information is therefore depending on the gate type. On gates that support a target browser [} 41], the browser will automatically detect the correct address information for a symbol. For all other gates, this information needs to be entered manually. TF6720 Version: 1.5.0 49
## Page 50

Configuration Gate type Setting Description ADS URN Symbol name address information of the ADS variable. Might not work with all ADS devices, e.g. BC devices do not support symbol names. ADS Index Group Index Group/Index Offset combination can be used to access data of an ADS device that does not support symbolic Index Offset address information. In case of the Twin CAT PLC, the Index Group/Index Offset combination directly represents a memory address, e.g. from a PLC variable, which may change after a re-compilation of the Twin CAT project. It is therefore common practice to use the Twin CAT PLC symbol server instead, which provides symbolic information for its PLC variables, which means that a variable can be accessed via its symbol name instead, which stays valid even after a re-compilation or online change (if the symbol still exists). However, some ADS services do not include such a symbol server, e.g. small Beckhoff BC devices. In those cases the Index Group/Index Offset combination needs to be used. ADS Data Type Data type of the symbol ADS Conversion Specifies conversion mode for this symbol. OPC UA Name Descriptive name of the OPC UA node. Only used in Configurator, does not represent any online address information. OPC UA Identifier Identifier of OPC UA symbol on the server, e.g.: • s = MAIN.n Counter (if the Identifier Type is “String”) • n = 42 (if the Identifier Type is “Numeric”) OPC UA Ns Name Namespace name in which the symbol is located. This corresponds to the namespace index, which is part of an OPC UA Node Id. The translation can be done via the Namespace Array. OPC UA Attribute Id The Attribute Id defines the OPC UA attribute that should be used by the Data Agent when reading a symbol. In most scenarios, this is the “Value” of a symbol. OPC UA Conversion Specifies conversion mode for this symbol. MQTT URN Name of the MQTT symbol. This represents the name that is being used in the JSON format as a key, also when receiving data from the MQTT Gate. MQTT Data Type Data type of the symbol MQTT Conversion Specifies conversion mode for this symbol. Io T Hub URN Name of the Io T Hub symbol. This represents the name that is being used in the JSON format as a key, also when receiving data from Io T Hub. Io T Hub Data Type Data type of the symbol Io T Hub Conversion Specifies conversion mode for this symbol. When configuring a Channel, symbols can be added via a target browser or manually by providing the correct address information. Note that not all gate types include target browser functionalities. In this case symbols need to be configured manually. Manual symbol configuration If the target device is not online or does not provide any symbolic address information (e.g. the BC9191), symbols may also be added manually by entering the symbol address. The tables at the beginning of this document show which information is required in this case. 50 Version: 1.5.0 TF6720
## Page 51

Configuration Type conversion The TC3 Io T Data Agent supports data type conversion before the data is published to a Gate. Type conversion occurs on symbol level, which means that different Symbols can use different conversion modes. The following table shows the different conversion modes available. Conversion mode Description Losless Default setting. “Smaller” types can be converted into “larger” types. For example, a subscriber symbol of data type INT can be published to a symbol of data type Int32 (2 byte to 4 byte). Lossy If required, “larger” symbols can also be converted into “smaller” symbols. For example, a subscriber symbol of data type DINT can be published to a symbol of data type Int16 (4 byte to 2 byte). Depending on the value of the subscriber symbol, this can of course result in cut-off values. Strict If required, symbols can also be configured to use “strict mode”. In this conversion mode, the data type size of a subscriber symbol needs to match exactly the data type of the mapped publisher symbol. For example, a subscriber symbol of data type INT can only be published to a symbol of data type Int16 (2 byte to 2 byte). 5.2.8 Error logging For troubleshooting purposes, the TC3 Io T Data Agent can generate a log file that can be filled based on different logging levels. All necessary settings can be configured via the properties window of the configurator. To do this, simply click on an empty space in the topology view and configure the logging settings in the properties window. Note that all settings are associated with the currently open configuration and must be defined for each configuration. The default directory in which the log file is created is the Twin CAT boot directory. The placeholder [Boot Dir] automatically selects the Twin CAT boot directory. Logging window The Logging window in the configurator displays only logged events related to the configurator. To create a log for the TC3 Io T Data Agent background service, the above settings are required. 5.3 System tray Local TC3 Io T Data Agent functions are also available via the Windows taskbar, e.g. starting or stopping the locally running TC3 Io T Data Agent. The TF6720 setup automatically installs a taskbar application that provides these functions via the context menu. TF6720 Version: 1.5.0 51
## Page 52

Configuration In addition, the icon in the taskbar shows the current state of the TC3 Io T Data Agent. Mode Symbol Description Idle No configuration is currently loaded and active mode Run A configuration is currently loaded and active mode Stop A configuration is loaded but currently not active, e.g. due to mode an error 5.4 Support Information Report The Support Information Report is a tool for collecting product information for submission to Beckhoff technical support. Collecting product-related data such as Twin CAT version/build, product version, image version and device type reduces email traffic significantly and enables more efficient advice. Plug-in mechanism Various Beckhoff products interface with the Support Information Report via a plug-in mechanism. These products, such as the Twin CAT Database Server, have a Support Information Report entry in the corresponding product menu. Creating and submitting a Support Information Report ü A Support Information Report is open. 1. Use the Behaviour text field to describe the behavior that occurred in as much detail as possible. 2. In the Attachment area, you can add files (screenshots etc.) to the report via the Add Attachment button, if required. Files can optionally be selected via remote access. To do this, select a target from the Remote System dropdown list. Depending on the selected target, it may be possible to browse Windows CE devices. 3. Enter your contact details and select a Beckhoff subsidiary for your country. This information is obligatory for submitting the Support Information Report. 4. You will be offered the option to store your contact details for future Support Information Reports. To do this, tick the Store personal data check box. 5. The product-specific plug-ins can be found in the lower section of the Support Information Report. Tick the Include in report check box. The information required for the product is added automatically, if it is available. The screenshot shows the current configuration of a Twin CAT Database Server in the form of an XML file as an example. 6. Submitting the Support Information Report: • If the device has an email connection, you can submit the Support Information Report directly to the Beckhoff subsidiary for your country via the Send Report button. • If the device does not have an email connection, you can save the Support Information Report locally as a .zip file via the Save .zip button and then make it available via FTP, USB etc. 52 Version: 1.5.0 TF6720
## Page 53

Configuration TF6720 Version: 1.5.0 53
## Page 54

Samples 6 Samples This section provides configuration examples that demonstrate how to use the Twin CAT Io T Data Agent to connect to specific device types and cloud services. The section is categorized into "Southbound" and "Northbound" samples. • Southbound: connections to underlying devices, e.g. via ADS to Twin CAT or OPC UA to third-party devices. • Northbound: connections to cloud services 6.1 Quick Start This section describes how to quickly start the TC3 Io T Data Agent. The communication scenario is a typical use case for the Data Agent: variables from a southbound device (Twin CAT PLC runtime) are sampled and published to a northbound service (MQTT message broker). In this example, the message broker is running on the same computer as the PLC runtime. To set up this scenario, the following steps are required. All steps are performed on the same computer. • Installing the software [} 54] • Preparing the PLC program [} 54] • Configuring the TC3 Io T Data Agent [} 55] • Displaying the published messages [} 56] Install the software 1. Install TF6720 Io T Data Agent as described in the Installation [} 11] section. 2. Install Mosquitto MQTT Message Broker with its default setup settings. The Message Broker can be installed anywhere and is connected to via its hostname or IP address. 3. Open a Windows Console, navigate to the installation directory of the Mosquitto MQTT Message Broker (typically C:\Program Files (x86)\mosquitto) and start the Broker in verbose mode by executing the following command: mosquitto.exe -v Mosquitto MQTT Message Broker The Mosquitto MQTT Message Broker can be downloaded from www.mosquitto.org. Make sure to follow any installation instructions provided by the Mosquitto installer. Mosquitto startup By default, the Mosquitto MQTT Message Broker is installed as a Windows service. You can also start the mosquitto.exe from a command line and specify parameters like "-v" for verbose output. If you want to start the broker from a command line, make sure that the Mosquitto Windows service is not running. Prepare the PLC program Set up a Twin CAT 3 PLC project and activate trial licenses for TC1200 (PLC) and TF6720 (TC3 Io T Data Agent). In this sample the PLC program should include the following variables: PROGRAM MAIN VAR n Counter1 : INT; n Counter2 : LREAL; END_VAR These two variables should be incremented cyclically. Add the following implementation code for the PLC program: n Counter1 := n Counter1 + 1; n Counter2 := n Counter2 + 0.1; 54 Version: 1.5.0 TF6720
## Page 55

Samples Activate the project and start Twin CAT into run mode. Make sure that the PLC program is running by logging in. Configuring the Twin CAT Io T Data Agent 1. Start the Twin CAT Io T Data Agent configurator either via the link in the Windows Start menu or via the taskbar application (see Configurator [} 38]). 2. Follow the step-by-step instructions below to create a Data Agent configuration. Alternatively, you can open the "Sample_Quick Start.xml" configuration file located in the Data Agent installation directory and go directly to step (m). 3. Start a new configuration by clicking the New icon on the Configurator toolbar. 4. Right-click an empty area in the topology view and select Add Gate (ADS). 5. Select the new gate and make sure the local Ams Net Id and ADS Port 851 are selected in the properties window 6. Right-click on the new gate in the topology view and select Add Channel (Subscriber). 7. Select the new channel and make sure the sampling mode is set to "cyclic" and the cycle time is set to "1000" in the Properties window. 8. Open the Target Browser and navigate to your local PLC runtime (Port 851). 9. Select the variables "n Counter1" and "n Counter2" and drag them to the subscriber channel in the topology view. 10. Right-click on an empty area in the topology view and select Add Gate (MQTT). 11. Select the new gate and make sure that the URL is set to 127.0.0.1 and Port 1883 is used. 12. Right-click on the new gate in the topology view and select Add Channel (Publisher). 13. Select the new channel and make sure that the sampling mode is set to “cyclic”. Set the cycle time to “1000” and the formatter to “Twin CAT JSON”. The MQTT topic can be set to a topic of your choice, e.g. “Test Topic”. 14. Hold the CTRL key and drag the subscriber channel to the publisher channel in order to create a mapping between the source and destination symbols. Note that the destination symbols are automatically created. 15. Activate the configuration by clicking on the Activate Configuration button in the toolbar. TF6720 Version: 1.5.0 55
## Page 56

Samples Displaying the published messages Open a command line window and navigate to the installation directory of the Mosquitto MQTT Message Broker (typically "C:\Program Files\mosquitto" or "C:\Program Files (x86)\mosquitto"). Start the Mosquitto Subscriber Tool by executing the following command: mosquitto_sub.exe -t Test Topic. The Mosquitto Subscriber tool will now receive the messages that are published from the Twin CAT Io T Data Agent. 6.2 Southbound 6.2.1 Connect to third-party devices via OPC UA Most of the step-by-step instructions in this sample section are based on an OPC UA subscriber channel, but the same principles can also be applied to data acquisition from another device type. The following section describes step-by-step how to configure the TC3 Io T Data Agent to sample data from an OPC UA Server and to publish it to a MQTT Message Broker by using a JSON data format. 56 Version: 1.5.0 TF6720
## Page 57

Samples Configure OPC UA gate, channel and symbols Follow the step-by-step instructions to create an OPC UA gate and a subscriber channel and add OPC UA nodes to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (OPC UA). 2. Select the new gate and configure OPC UA specific settings in the properties window (Server URL, Security Policy, Message Security Mode, …). 3. Right-click the new gate and select Add Channel (Subscriber). 4. Select the new channel and set “Sampling Mode” to “On Change”. Leave all other fields on their default settings. 5. Open the Target Browser. 6. Navigate to the OPC UA namespace and add some symbols to the configuration by dragging them to the subscriber channel. ð A OPC UA gate and a subscriber channel have been created. OPC UA nodes have been added to the configuration. Server URL Make sure that the Server URL that you specified in the gate settings equals the Server URL that is used in the target browser. Configure MQTT gate and channel Follow the step-by-step instructions to create a MQTT gate and a publisher channel. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (MQTT). 2. Select the new gate and configure MQTT-related settings in the properties window (Broker address, …). 3. Right-click the new gate and select Add Channel (Publisher). 4. Select the new channel and set “Sampling Mode” to “On Change”, “Formatter” to “Simple JSON” and “Topic” to “Test Topic”. Leave all other fields on their default settings. ð A MQTT gate and a publisher channel have been created. Create mapping Follow the step-by-step instructions to create a mapping between source and destination symbols. Note that a mapping can only be created between channels that have different roles (e.g. between a subscriber and a publisher channel and vice versa). Drag-and-drop - Channel: While holding the CTRL key, drag the subscriber channel to the publisher channel. The configurator automatically creates new symbols on the publisher channel and a mapping between the source and destination symbol. Drag-and-drop – Symbol: While holding the CTRL key, drag a symbol from the subscriber channel to either an existing symbol on the publisher channel or to the publisher channel itself. The configurator creates a link between source and destination symbol or, if the symbol has been dragged to a channel object, creates the destination symbol automatically Activate configuration Follow the step-by-step instructions to activate the currently opened configuration. 1. Select the target system via the toolbar. 2. Click the Activate Configuration button. TF6720 Version: 1.5.0 57
## Page 58

Samples ð A dialog opens asking if you want to switch the target TC3 Io T Data Agent into run mode. 3. Confirm the dialog with Yes if you want to switch the mode. Otherwise, choose No. ð The configuration is activated. The resulting configuration looks like this: 6.2.2 Connect to a BC9191 via ADS To configure the TC3 Io T Data Agent to access a BC9191 controller via ADS, the symbols must be configured manually in the TC3 Io T Data Agent configurator, as the BC9191 controller does not provide symbol information via ADS. The target browser mechanism cannot be used. The Index Group/Index Offset information must be configured for each symbol to be configured for Io T communication. For input/output variables, this information can be found in the Twin CAT System Manager in the "ADS Info" section. 58 Version: 1.5.0 TF6720
## Page 59

Samples In the case of internal variables, these variables can be configured for ADS access in several ways. Consult the BC9191 documentation for more information. The following PLC code snippet provides an example: VAR_GLOBAL i Counter1 AT%MB100 : INT; i Counter2 AT%MB200 : INT; i Counter3 AT%IB100 : INT; i Counter4 AT%IB200 : INT; END_VAR The corresponding Index Group/Index Offset combinations for these two variables are: Variable Index Group Index Offset i Counter1 0x4020 (16416) 0x64 (100) i Counter2 0x4020 (16416) 0x C8 (200) i Counter3 0x F020 (61472) 0x64 (100) i Counter4 0x F020 (61472) 0x C8 (200) The BC9191 can be added to the TC3 Io T Data Agent configuration as a regular ADS gate. The ADS port must be set to 800, the Io Mode is then automatically set to “direct”. As described, the symbols must be added manually using the corresponding Index Group/Index Offset information. An individual name of your choice can be specified as the URN. After mapping these Subscriber symbols to corresponding Publisher symbols, e.g. on an MQTT gate, the variables are shown on the Publisher’s side. 6.2.3 Connect to a Twin CAT I/O Task via ADS In order to configure the TC3 Io T Data Agent to access a Twin CAT I/O Task (with process image) via ADS, the symbols can be configured manually in the TC3 Io T Data Agent configurator, if the I/O Task has not been configured to create symbol information, or via the target browser. TF6720 Version: 1.5.0 59
## Page 60

Samples Twin CAT I/O Task A Twin CAT I/O Task can be configured with a process image in order to link variables from that image directly to I/Os. The TC3 Io T Data Agent can then access the I/O task via its ADS port. Manual symbol configuration The process image variables can be accessed via their Index Group/Index Offset combination. This information must be entered into the TC3 Io T Data Agent. 60 Version: 1.5.0 TF6720
## Page 61

Samples Configuration via target browser Symbol information can be generated for a Twin CAT I/O Task by activating the corresponding option in the I/ O task configuration. After activating this configuration, the symbol information can be accessed via the Target Browser and the symbols can be added to the TC3 Io T Data Agent configuration. 6.2.4 Connect to a Twin CAT Tc COM module via ADS In order to configure the TC3 Io T Data Agent to access a Twin CAT 3 Tc COM Module via ADS, the symbols can be configured manually in the TC3 Io T Data Agent configurator, if the Tc COM Module has not been configured to create symbol information, or via the target browser. Twin CAT 3 Tc COM module A Twin CAT 3 Tc COM module can be accessed via ADS using the corresponding ADS port. This is usually the port of the task. TF6720 Version: 1.5.0 61
## Page 62

Samples Manual symbol configuration The process image variables of the Tc COM module can be accessed via their Index Group/Index Offset combination. This information must be entered into the TC3 Io T Data Agent. Configuration via target browser Symbol information can be generated for a Twin CAT 3 Tc COM module via the TMC Code Generator. 62 Version: 1.5.0 TF6720
## Page 63

Samples After activating this configuration, the symbol information can be accessed via the Target Browser and the symbols can be added to the TC3 Io T Data Agent configuration. 6.3 Northbound 6.3.1 Publish data to AWS Io T Core The following section describes step-by-step how to use the configurator to sample data from a Twin CAT 3 PLC runtime and to publish it to AWS Io T by using a JSON data format. Configure ADS gate, channel and symbols Follow the step-by-step instructions to create an ADS gate and a subscriber channel and add symbols to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (ADS). 2. Select the new gate and configure ADS specific settings in the properties window (Ams Net Id, Ads Port, …). 3. Right-click the new gate and select Add Channel (Subscriber). 4. Select the new channel and set “Sampling Mode” to “Cyclic”. Leave all other fields on their default settings. 5. Open the Target Browser. 6. Navigate to the ADS device and add some symbols to the configuration by dragging them to the subscriber channel. ð An ADS gate and a subscriber channel have been created. Symbols have been added to the channel. AMS Net ID Make sure that the AMS Net ID, which has been configured on the ADS gate, matches the ADS device that you selected with the target browser. Configure AWS Io T gate and channel Follow the step-by-step instructions to create an AWS Io T gate and a publisher channel. TF6720 Version: 1.5.0 63
## Page 64

Samples ü The topology view is activated. 1. Right-click the canvas and select Add Gate (AWS Io T). 2. Select the new gate and configure AWS Io T related settings in the properties window (Broker address, TLS settings). 3. Right-click the new gate and select Add Channel (Publisher). 4. Select the new channel and set “Sampling Mode” to “On Change”, “Formatter” to “Simple JSON” and “Topic” to “Test Topic”. Leave all other fields on their default settings. ð An AWS Io T gate and a publisher channel have been created. Create mapping Follow the step-by-step instructions to create a mapping between source and destination symbols. Note that a mapping can only be created between channels that have different roles (e.g. between a subscriber and a publisher channel and vice versa). Drag-and-drop - Channel: While holding the CTRL key, drag the subscriber channel to the publisher channel. The configurator automatically creates new symbols on the publisher channel and a mapping between the source and destination symbol. Drag-and-drop – Symbol: While holding the CTRL key, drag a symbol from the subscriber channel to either an existing symbol on the publisher channel or to the publisher channel itself. The configurator creates a link between source and destination symbol or, if the symbol has been dragged to a channel object, creates the destination symbol automatically Activate configuration Follow the step-by-step instructions to activate the currently opened configuration. 1. Select the target system via the toolbar. 2. Click the Activate Configuration button. ð A dialog opens asking if you want to switch the target TC3 Io T Data Agent into run mode. 3. Confirm the dialog with Yes if you want to switch the mode. Otherwise, choose No. ð The configuration is activated. The resulting configuration looks like this: 64 Version: 1.5.0 TF6720
## Page 65

Samples 6.3.2 Publish data to AWS Greengrass The following section describes step-by-step how to use the configurator to sample data from a Twin CAT 3 PLC runtime and to publish it to AWS Greengrass by using a JSON data format. Configure ADS gate, channel and symbols Follow the step-by-step instructions to create an ADS gate and a subscriber channel and add symbols to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (ADS). 2. Select the new gate and configure ADS specific settings in the properties window (Ams Net Id, Ads Port, …). 3. Right-click the new gate and select Add Channel (Subscriber). 4. Select the new channel and set “Sampling Mode” to “Cyclic”. Leave all other fields on their default settings. 5. Open the Target Browser. 6. Navigate to the ADS device and add some symbols to the configuration by dragging them to the subscriber channel. ð An ADS gate and a subscriber channel have been created. Symbols have been added to the channel. AMS Net ID Make sure that the AMS Net ID, which has been configured on the ADS gate, matches the ADS device that you selected with the target browser. Configure AWS Io T gate and channel A connection to AWS Greengrass can basically be configured like a connection to AWS Io T. Follow the step- by-step instructions to create an AWS Greengrass gate and a publisher channel. TF6720 Version: 1.5.0 65
## Page 66

Samples CA certificate Make sure to use the correct CA certificate, which can be obtained via the AWS CLI. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (AWS Io T). 2. Select the new gate and configure AWS Greengrass related settings in the properties window (IP address or hostname of the Greengrass Core device and the TLS settings). 3. Right-click the new gate and select Add Channel (Publisher). 4. Select the new channel and set “Sampling Mode” to “On Change”, “Formatter” to “Simple JSON” and “Topic” to “Test Topic”. Make sure to set “Qo S” to “0”. Leave all other fields on their default settings. ð An AWS Greengrass gate and a publisher channel have been created. Create mapping Follow the step-by-step instructions to create a mapping between source and destination symbols. Note that a mapping can only be created between channels that have different roles (e.g. between a subscriber and a publisher channel and vice versa). Drag-and-drop - Channel: While holding the CTRL key, drag the subscriber channel to the publisher channel. The configurator automatically creates new symbols on the publisher channel and a mapping between the source and destination symbol. Drag-and-drop – Symbol: While holding the CTRL key, drag a symbol from the subscriber channel to either an existing symbol on the publisher channel or to the publisher channel itself. The configurator creates a link between source and destination symbol or, if the symbol has been dragged to a channel object, creates the destination symbol automatically Activate configuration Follow the step-by-step instructions to activate the currently opened configuration. 1. Select the target system via the toolbar. 2. Click the Activate Configuration button. ð A dialog opens asking if you want to switch the target TC3 Io T Data Agent into run mode. 3. Confirm the dialog with Yes if you want to switch the mode. Otherwise, choose No. ð The configuration is activated. The resulting configuration looks like this: 66 Version: 1.5.0 TF6720
## Page 67

Samples 6.3.3 Publish data to IBM Watson Io T The following section describes step-by-step how to use the configurator to sample data from a Twin CAT 3 PLC runtime and publish it to IBM Watson Io T by using a JSON data format. IBM Watson Io T settings For IBM-specific configuration settings, please consult the IBM Watson Io T documentation. A good Getting Started article can be found here: https://www.ibm.com/support/knowledgecenter/ SSQP8H/iot/platform/devices/mqtt.html Configure ADS gate, channel and symbols Follow the step-by-step instructions to create an ADS gate and a subscriber channel and add symbols to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (ADS). 2. Select the new gate and configure ADS specific settings in the properties window (Ams Net Id, Ads Port, …). 3. Right-click the new gate and select Add Channel (Subscriber). 4. Select the new channel and set “Sampling Mode” to “Cyclic”. Leave all other fields on their default settings. 5. Open the Target Browser. 6. Navigate to the ADS device and add some symbols to the configuration by dragging them to the subscriber channel. ð An ADS gate and a subscriber channel have been created. Symbols have been added to the channel. AMS Net ID Make sure that the AMS Net ID, which has been configured on the ADS gate, matches the ADS device that you selected with the target browser. Configure MQTT gate and channel MQTT is the transport protocol used by IBM Watson Io T. Follow the step-by-step instructions to create an MQTT gate and a publisher channel. TF6720 Version: 1.5.0 67
## Page 68

Samples ü The topology view is activated. 1. Right-click the canvas and select Add Gate (MQTT). 2. Select the new gate and configure IBM Watson Io T related settings in the properties window (Broker address, TLS settings, Username/Password, Client ID) as described in the IBM Watson Io T documentation. 3. Right-click the new gate and select Add Channel (Publisher). 4. Select the new channel and set “Sampling Mode” to “On Change”, “Formatter” to “Simple JSON” and “Topic” to “iot-2/evt/<event Id>/fmt/<format>”. Leave all other fields on their default settings. Replace <event Id> and <format> as described in the IBM Watson Io T documentation. ð An AWS Io T gate and a publisher channel have been created. Create mapping Follow the step-by-step instructions to create a mapping between source and destination symbols. Note that a mapping can only be created between channels that have different roles (e.g. between a subscriber and a publisher channel and vice versa). Drag-and-drop - Channel: While holding the CTRL key, drag the subscriber channel to the publisher channel. The configurator automatically creates new symbols on the publisher channel and a mapping between the source and destination symbol. Drag-and-drop – Symbol: While holding the CTRL key, drag a symbol from the subscriber channel to either an existing symbol on the publisher channel or to the publisher channel itself. The configurator creates a link between source and destination symbol or, if the symbol has been dragged to a channel object, creates the destination symbol automatically Activate configuration Follow the step-by-step instructions to activate the currently opened configuration. 1. Select the target system via the toolbar. 2. Click the Activate Configuration button. ð A dialog opens asking if you want to switch the target TC3 Io T Data Agent into run mode. 3. Confirm the dialog with Yes if you want to switch the mode. Otherwise, choose No. ð The configuration is activated. The resulting configuration may look like this: 68 Version: 1.5.0 TF6720
## Page 69

Samples 6.3.4 Publish data to Microsoft Azure Io T Hub The following section describes step-by-step how to use the configurator to sample data from a Twin CAT 3 PLC runtime and publish it to Microsoft Azure Io T Hub using a JSON data format. Configure ADS gate, channel and symbols Follow the step-by-step instructions to create an ADS gate and a subscriber channel and add symbols to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (ADS). 2. Select the new gate and configure ADS specific settings in the properties window (Ams Net Id, Ads Port, …). 3. Right-click the new gate and select Add Channel (Subscriber). 4. Select the new channel and set “Sampling Mode” to “Cyclic”. Leave all other fields on their default settings. 5. Open the Target Browser. 6. Navigate to the ADS device and add some symbols to the configuration by dragging them to the subscriber channel. ð An ADS gate and a subscriber channel have been created. Symbols have been added to the channel. AMS Net ID Make sure that the AMS Net ID, which has been configured on the ADS gate, matches the ADS device that you selected with the target browser. Configure Azure Io T Hub gate and channel Follow the step-by-step instructions to create an Azure Io T Hub gate and a Publisher channel. ü The topology view is activated. 1. Right-click on the empty area and select Add Gate (Io T Hub). 2. Select the new gate and configure the Io T Hub-related settings in the properties window (device name, primary key, CA certificate). 3. Right-click on the new gate and select Add Channel (Publisher). TF6720 Version: 1.5.0 69
## Page 70

Samples 4. Select the new channel and set "Sampling Mode" to "On Change" and "Formatter" to "Simple JSON". Leave the default settings for all other fields. ð An Azure Io T Hub gate and a Publisher channel were created. CA certificate A CA certificate must be specified when establishing a connection with Microsoft Azure Io T Hub. At the time of writing this documentation article, Microsoft migrated all Azure Io T Hub instances to a new root CA (Baltimore Cyber Trust Root CA -> Digi Cert Global Root G2). Therefore, please always consult the Microsoft documentation as well to find out the currently valid root CA. In most cases, the corresponding public key of the respective root CA can be extracted from the Microsoft Windows certificate console (Start > Run > mmc.exe, then add the "Certificates" snap-in). See also screenshot below for comparison. Create mapping Follow the step-by-step instructions to create a mapping between source and destination symbols. Note that a mapping can only be created between channels that have different roles (e.g. between a subscriber and a publisher channel and vice versa). Drag-and-drop - Channel: While holding the CTRL key, drag the subscriber channel to the publisher channel. The configurator automatically creates new symbols on the publisher channel and a mapping between the source and destination symbol. Drag-and-drop – Symbol: While holding the CTRL key, drag a symbol from the subscriber channel to either an existing symbol on the publisher channel or to the publisher channel itself. The configurator creates a link between source and destination symbol or, if the symbol has been dragged to a channel object, creates the destination symbol automatically Activate configuration Follow the step-by-step instructions to activate the currently opened configuration. 1. Select the target system via the toolbar. 2. Click the Activate Configuration button. ð A dialog opens asking if you want to switch the target TC3 Io T Data Agent into run mode. 3. Confirm the dialog with Yes if you want to switch the mode. Otherwise, choose No. ð The configuration is activated. The resulting configuration looks like this: 70 Version: 1.5.0 TF6720
## Page 71

Samples 6.3.5 Publish data to MQTT Message Broker The following section describes step-by-step how to use the configurator to sample data from a Twin CAT 3 PLC runtime and to publish it to a MQTT Message Broker by using a JSON data format. Configure ADS gate, channel and symbols Follow the step-by-step instructions to create an ADS gate and a subscriber channel and add symbols to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (ADS). 2. Select the new gate and configure ADS specific settings in the properties window (Ams Net Id, Ads Port, …). 3. Right-click the new gate and select Add Channel (Subscriber). 4. Select the new channel and set “Sampling Mode” to “Cyclic”. Leave all other fields on their default settings. 5. Open the Target Browser. 6. Navigate to the ADS device and add some symbols to the configuration by dragging them to the subscriber channel. ð An ADS gate and a subscriber channel have been created. Symbols have been added to the channel. AMS Net ID Make sure that the AMS Net ID, which has been configured on the ADS gate, matches the ADS device that you selected with the target browser. Configure MQTT gate and channel Follow the step-by-step instructions to create a MQTT gate and a publisher channel. TF6720 Version: 1.5.0 71
## Page 72

Samples ü The topology view is activated. 1. Right-click the canvas and select Add Gate (MQTT). 2. Select the new gate and configure MQTT-related settings in the properties window (Broker address, …). 3. Right-click the new gate and select Add Channel (Publisher). 4. Select the new channel and set “Sampling Mode” to “On Change”, “Formatter” to “Simple JSON” and “Topic” to “Test Topic”. Leave all other fields on their default settings. ð A MQTT gate and a publisher channel have been created. Create mapping Follow the step-by-step instructions to create a mapping between source and destination symbols. Note that a mapping can only be created between channels that have different roles (e.g. between a subscriber and a publisher channel and vice versa). Drag-and-drop - Channel: While holding the CTRL key, drag the subscriber channel to the publisher channel. The configurator automatically creates new symbols on the publisher channel and a mapping between the source and destination symbol. Drag-and-drop – Symbol: While holding the CTRL key, drag a symbol from the subscriber channel to either an existing symbol on the publisher channel or to the publisher channel itself. The configurator creates a link between source and destination symbol or, if the symbol has been dragged to a channel object, creates the destination symbol automatically Activate configuration Follow the step-by-step instructions to activate the currently opened configuration. 1. Select the target system via the toolbar. 2. Click the Activate Configuration button. ð A dialog opens asking if you want to switch the target TC3 Io T Data Agent into run mode. 3. Confirm the dialog with Yes if you want to switch the mode. Otherwise, choose No. ð The configuration is activated. The resulting configuration looks like this: 72 Version: 1.5.0 TF6720
## Page 73

Samples 6.3.6 Publish data to Twin CAT Io T Communicator App The following section describes step-by-step how to use the configurator to sample data from a Twin CAT 3 PLC runtime and publish it to an MQTT Message Broker by using a Twin CAT JSON data format in order to be visualized by the Twin CAT Io T Communicator smartphone app. Configure ADS gate, channel and symbols Follow the step-by-step instructions to create an ADS gate and a subscriber channel and add symbols to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (ADS). 2. Select the new gate and configure ADS specific settings in the properties window (Ams Net Id, Ads Port, …). 3. Right-click the new gate and select Add Channel (Subscriber). 4. Select the new channel and set “Sampling Mode” to “Cyclic”. Leave all other fields on their default settings. 5. Open the Target Browser. 6. Navigate to the ADS device and add some symbols to the configuration by dragging them to the subscriber channel. ð An ADS gate and a subscriber channel have been created. Symbols have been added to the channel. AMS Net ID Make sure that the AMS Net ID, which has been configured on the ADS gate, matches the ADS device that you selected with the target browser. TF6720 Version: 1.5.0 73
## Page 74

Samples Configure MQTT gate and channel Follow the step-by-step instructions to create a MQTT gate and a publisher channel. The channel is configured so that it represents the topic structure and data format for the Twin CAT Io T Communicator. 1. Right-click the canvas and select Add Gate (MQTT). 2. Select the new gate and configure MQTT related settings on the new gate (Broker address, …). 3. Right-click the new gate and select Add channel (Publisher). 4. Select the new channel and set “Sampling Mode” to “On Change” and “Formatter” to “Twin CAT JSON”. Set “Topic” to <Main Topic>/<Device Name>/Tc Iot Communicator/Json/Tx/Data . The parts <Main Topic> and <Device Name> must be replaced according to your Communicator setup. 5. Set “Status Info Topic” to <Main Topic>/<Device Name>/Tc Iot Communicator/Desc. The parts <Main Topic> and <Device Name> must be replaced according to your Communicator setup. ð A MQTT gate and a publisher channel have been created. Create mapping Follow the step-by-step instructions to create a mapping between source and destination symbols. Note that a mapping can only be created between channels that have different roles (e.g. between a subscriber and a publisher channel and vice versa). Drag-and-drop - Channel: While holding the CTRL key, drag the subscriber channel to the publisher channel. The configurator automatically creates new symbols on the publisher channel and a mapping between the source and destination symbol. Drag-and-drop – Symbol: While holding the CTRL key, drag a symbol from the subscriber channel to either an existing symbol on the publisher channel or to the publisher channel itself. The configurator creates a link between source and destination symbol or, if the symbol has been dragged to a channel object, creates the destination symbol automatically Activate configuration Follow the step-by-step instructions to activate the currently opened configuration. 1. Select the target system via the toolbar. 2. Click the Activate Configuration button. ð A dialog opens asking if you want to switch the target TC3 Io T Data Agent into run mode. 3. Confirm the dialog with Yes if you want to switch the mode. Otherwise, choose No. ð The configuration is activated. 6.3.7 Subscribe to MQTT Message Broker The following section describes step-by-step how to use the configurator to subscribe to an MQTT Message Broker and to write received data into ADS variables. Configure MQTT gate, channel and symbols Follow the step-by-step instructions to create an MQTT gate and a subscriber channel and add symbols to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (MQTT). 2. Select the new gate and configure MQTT related settings in the properties window (Broker address, …). 3. Right-click the new gate and select Add Channel (Subscriber). 74 Version: 1.5.0 TF6720
## Page 75

Samples 4. Select the new channel and set “Sampling Mode” to “On Change” and “Formatter” to “Simple JSON”. Leave all other fields on their default settings. Make sure that the MQTT topic matches the topic name on which you receive data. 5. Right-click the channel and select Add Symbol. Configure the symbol related settings, e.g. the symbol name. In case of a JSON data format, the name must match a JSON key in the JSON document received by the TC3 Io T Data Agent. Make sure to set the correct data type. ð A MQTT gate and a subscriber channel have been created. Symbols have been added to the channel. Data format Make sure that the data format of the received message payload corresponds to the configured data format. Otherwise, the TC3 Io T Data Agent cannot parse the content of the message and process the data. Configure ADS gate, channel and symbols Follow the step-by-step instructions to create an ADS gate and a publisher channel. Add symbols to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (ADS). 2. Select the new gate and configure ADS related settings in the properties window (Ams Net Id, Ads Port, …). 3. Right-click the new gate and select Add Channel (Publisher). 4. Select the new channel and set “Sampling Mode” to “On Change”. Leave all other fields on their default settings 5. Open the Target Browser. 6. Navigate to the ADS device and add the symbols to the configuration by dragging them to the publisher channel. ð An ADS gate and a publisher channel have been created. Symbols have been added to the channel. AMS Net ID Make sure that the AMS Net ID, that has been configured on the ADS gate, matches the ADS device that you selected with the target browser. Create mapping Follow the step-by-step instructions to create a mapping between source and destination symbols. Note that a mapping can only be created between channels that have different roles (e.g. between a subscriber and a publisher channel and vice versa). Drag-and-drop - Channel: While holding the CTRL key, drag the subscriber channel to the publisher channel. The configurator automatically creates new symbols on the publisher channel and a mapping between the source and destination symbol. Drag-and-drop – Symbol: While holding the CTRL key, drag a symbol from the subscriber channel to either an existing symbol on the publisher channel or to the publisher channel itself. The configurator creates a link between source and destination symbol or, if the symbol has been dragged to a channel object, creates the destination symbol automatically Activate configuration Follow the step-by-step instructions to activate the currently opened configuration. 1. Select the target system via the toolbar. 2. Click the Activate Configuration button. TF6720 Version: 1.5.0 75
## Page 76

Samples ð A dialog opens asking if you want to switch the target TC3 Io T Data Agent into run mode. 3. Confirm the dialog with Yes if you want to switch the mode. Otherwise, choose No. ð The configuration is activated. 6.3.8 Use Microsoft Azure Io T Hub Device Twin The following section describes step-by-step how to use the configurator to set up a connection to Microsoft Azure Io T Hub and the Microsoft Azure Io T Hub Device Twin service. Configure ADS gate, channel and symbols Follow the step-by-step instructions to create an ADS gate and a subscriber channel and add symbols to the channel’s configuration. ü The topology view is activated. 1. Right-click the canvas and select Add Gate (ADS). 2. Select the new gate and configure ADS specific settings in the properties window (Ams Net Id, Ads Port, …). 3. Right-click the new gate and select Add Channel (Subscriber). 4. Select the new channel and set “Sampling Mode” to “Cyclic”. Leave all other fields on their default settings. 5. Open the Target Browser. 6. Navigate to the ADS device and add some symbols to the configuration by dragging them to the subscriber channel. ð An ADS gate and a subscriber channel have been created. Symbols have been added to the channel. AMS Net ID Make sure that the AMS Net ID, which has been configured on the ADS gate, matches the ADS device that you selected with the target browser. Configure Azure Io T Hub gate and Device Twin channel Follow the step-by-step instructions to create an Azure Io T Hub gate and channels for telemetry data and the Device Twin. ü The topology view is activated 1. Right-click the canvas and select Add Gate (Io T Hub). 2. Select the new gate and configure Io T Hub related settings in the properties window (device name, primary key, CA certificate). 3. Right-click the new gate and select Add Channel (Publisher). 4. Select the new channel and set "Sampling Mode" to "On Change", "Formatter" to "Simple JSON" and "Name" to "Telemetry Data" (optional). Leave all other fields on their default settings. 5. Right-click the new gate and select Add Channel (Device Twin Publisher). 6. Select the new channel and set "Sampling Mode" to "On Change", "Formatter" to "Simple JSON" and "Name" to "Device Twin" (optional). Leave all other fields on their default settings. 7. Right-click the new gate and select Add Channel (Device Twin Subscriber). 8. Select the new channel and set "Sampling Mode" to "On Change", "Formatter" to "Simple JSON" and "Name" to "Device Twin GET" (optional). Leave all other fields on their default settings. ð You have configured an Azure Io T Hub connection and three channels - one for telemetry data and two for the Device Twin. In the step you have to decide which source symbols from the ADS gate will be treated as telemetry data and which symbols should be send to the Device Twin via the Device Twin Publisher channel. The Device Twin Subscriber channel can be used to retrieve updates to the Device Twin from cloud-based backenend applications (so-called "desired" updates). Every property expected has to be added as a symbol to that channel, using the property name as symbol name and URN. 76 Version: 1.5.0 TF6720
## Page 77

Samples Create mapping Follow the step-by-step instructions to create a mapping between source and destination symbols. Note that a mapping can only be created between channels that have different roles (e.g. between a subscriber and a publisher channel and vice versa). Drag-and-drop - Channel: While holding the CTRL key, drag the subscriber channel to the publisher channel. The configurator automatically creates new symbols on the publisher channel and a mapping between the source and destination symbol. Drag-and-drop – Symbol: While holding the CTRL key, drag a symbol from the subscriber channel to either an existing symbol on the publisher channel or to the publisher channel itself. The configurator creates a link between source and destination symbol or, if the symbol has been dragged to a channel object, creates the destination symbol automatically Activate configuration Follow the step-by-step instructions to activate the currently opened configuration. 1. Select the target system via the toolbar. 2. Click the Activate Configuration button. ð A dialog opens asking if you want to switch the target TC3 Io T Data Agent into run mode. 3. Confirm the dialog with Yes if you want to switch the mode. Otherwise, choose No. ð The configuration is activated. The resulting configuration may look like this: TF6720 Version: 1.5.0 77
## Page 78

Appendix 7 Appendix 7.1 Error logging For troubleshooting purposes, the TC3 Io T Data Agent can generate a log file that can be filled based on different logging levels. All necessary settings can be configured via the properties window of the configurator. To do this, simply click on an empty space in the topology view and configure the logging settings in the properties window. Note that all settings are associated with the currently open configuration and must be defined for each configuration. The default directory in which the log file is created is the Twin CAT boot directory. The placeholder [Boot Dir] automatically selects the Twin CAT boot directory. Logging window The Logging window in the configurator displays only logged events related to the configurator. To create a log for the TC3 Io T Data Agent background service, the above settings are required. 7.2 Error diagnosis This documentation article explains some common configuration or setup mistakes and could be a good way to troubleshoot your setup. Creating an Error logging [} 78] could also be helpful. 78 Version: 1.5.0 TF6720
## Page 79

Appendix Behavior Description The icon in the taskbar turns RED after Check all settings again and enable the Error logging [} 78]. startup Also check the following: • Can the TC3 Io T Data Agent connect to all configured gates (see below)? • Are there enough licenses? Connection to the MQTT message broker Check the following: could not be established • Make sure that the message broker is accessible for the device on which the TC3 Io T Data Agent is running. The MQTT standard port is 1883/tcp for unencrypted MQTT communication and 8883/tcp if MQTT-TLS is used. Make sure that these ports are open in your firewall (on the message broker side for incoming access and on the TC3 Io T Data Agent side for outgoing access). • Make sure that you are using the correct access data (if applicable) for the message broker • Check the connectivity with the message broker by using another MQTT client, e.g. Mqtt. Fx, Mqtt Spy or the Mosquitto command line tools. Connection to ADS device could not be Check the following: established • Make sure that you use the correct ADS port and Ams Net ID for the remote device • Make sure that there are no firewall settings on the remote device that prevent ADS access. • Make sure that the computer on which the TC3 Io T Data Agent is running has an ADS route configured for the corresponding Twin CAT target device. (Only applicable if the TC3 Io T Data Agent and the ADS target runtime are located on different computers). Connection to OPC UA server could not be Check the following: established • Make sure that there are no firewall settings on the computer on which the OPC UA server is running that prevent remote access to the server. • Check any local firewall settings on the TC3 Io T Data Agent device. Connection to Azure Io T Hub could not be Check the following: established • Make sure that you use the correct Io T Hub host name • Make sure that you have created a device on Azure Io T Hub, e.g. by using the Azure Io T Explorer, and that you have entered the correct device data for this device in the TC3 Io T Data Agent configurator • Make sure that you have used the correct CA certificate for Azure Io T Hub and that the CA certificate is used in a Base64-encoded file format. • Make sure that you do not use the same access data on another device. Only one connection to Io T Hub can be established with the same set of access data. Connection to AWS Io T could not be Check the following: established • Check the connectivity with AWS Io T by using another MQTT client, e.g. Mqtt. Fx, Mqtt Spy or the Mosquitto command line tools. • Make sure that no firewalls are blocking the TCP port 8883 (outgoing), which is required for connectivity with AWS Io T. • Make sure that you have used the correct set of certificates (as supplied by the AWS Io T management website) TF6720 Version: 1.5.0 79
## Page 80

Appendix Behavior Description The error message "Invalid Server Cert" is This error message means that the Data Agent encountered a displayed problem while checking the server certificate and the check was not successful. Reasons for this can be, for example: • The Common Name or the Subject Alternative Name (SAN) in the server certificate is not the same as the address used for the connection to the server. • The server certificate has expired. The server certificate could not be Some operating environments use a so-called CA chain, validated, although the correct CA consisting of root and one or more intermediate CAs. In this certificate was referenced. case, the CA certificate referenced in the Data Agent must contain the complete CA chain so that the server certificate can be checked correctly. 7.3 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com 80 Version: 1.5.0 TF6720
## Page 81

Appendix Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com TF6720 Version: 1.5.0 81
## Page 83

More Information: www.beckhoff.com/tf6720 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
