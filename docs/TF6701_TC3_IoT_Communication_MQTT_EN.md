---
title: "TF6701_TC3_IoT_Communication_MQTT_EN"
product: "TF6701"
category: "Communication"
tags: ["COMMUNICATION", "IoT", "MQTT"]
language: "EN"
document_type: "Manual"
version: "1.12.0"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF6701_TC3_IoT_Communication_MQTT_EN.pdf"
release_date: "2024-08-28"
---
Manual | EN TF6701 Twin CAT 3 | Io T Communication (MQTT) 2024-08-28 | Version: 1.12.0
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation............................................................................................................. 5 1.2 For your safety.................................................................................................................................. 5 1.3 Notes on information security............................................................................................................ 7 1.4 Documentation output status............................................................................................................ 7 2 Overview.................................................................................................................................................... 8 3 Installation............................................................................................................................................... 10 3.1 System requirements...................................................................................................................... 10 3.2 Installation....................................................................................................................................... 10 3.3 Licensing......................................................................................................................................... 10 4 Technical introduction............................................................................................................................ 13 4.1 Getting started................................................................................................................................. 13 4.2 Supported functions........................................................................................................................ 15 4.3 Supported message brokers........................................................................................................... 17 4.4 Application examples...................................................................................................................... 19 4.4.1 Sending SMS and E-Mail notifications............................................................................. 19 4.5 Protocol basics................................................................................................................................ 26 4.5.1 Overview.......................................................................................................................... 26 4.5.2 Protocol versions.............................................................................................................. 26 4.5.3 Client ID............................................................................................................................ 27 4.5.4 Topics............................................................................................................................... 27 4.5.5 Data formats..................................................................................................................... 29 4.5.6 Qo S.................................................................................................................................. 30 4.5.7 Retain............................................................................................................................... 32 4.5.8 Last will............................................................................................................................ 33 4.5.9 MQTT5 extensions........................................................................................................... 33 4.6 Security........................................................................................................................................... 40 4.6.1 Transport layer................................................................................................................. 40 4.6.2 Application level............................................................................................................... 47 4.7 Re-parameterization........................................................................................................................ 48 4.8 I/O device........................................................................................................................................ 48 4.9 Exponential backoff......................................................................................................................... 54 5 PLC API.................................................................................................................................................... 55 5.1 Tc3_Iot Base.................................................................................................................................... 55 5.1.1 MQTT3............................................................................................................................. 55 5.1.2 MQTT5............................................................................................................................. 69 5.1.3 ETc Iot Mqtt Client State.................................................................................................... 109 5.1.4 Parameter list................................................................................................................. 111 5.2 Tc3_Json Xml................................................................................................................................ 113 5.2.1 Function blocks.............................................................................................................. 113 5.2.2 Interfaces....................................................................................................................... 305 6 Samples................................................................................................................................................. 311 6.1 Iot Mqtt Sample Using Queue........................................................................................................... 312 TF6701 Version: 1.12.0 3
## Page 4

Table of contents 6.2 Iot Mqtt Sample Using Callback........................................................................................................ 314 6.3 Iot Mqtt Sample Tls Psk.................................................................................................................... 316 6.4 Iot Mqtt Sample Tls Ca...................................................................................................................... 317 6.5 Iot Mqtt Sample Aws Io T................................................................................................................... 317 6.6 Iot Mqtt Sample Azure Iot Hub........................................................................................................... 320 6.7 Iot Mqtt Sample Bosch Io T................................................................................................................ 322 6.8 Iot Mqtt Sample Ibm Watson Io T........................................................................................................ 323 6.9 Iot Mqtt Sample Mathworks Thingspeak........................................................................................... 324 6.10 Iot Mqtt Sample Azure Iot Hub Device Twin........................................................................................ 325 6.11 Iot Mqttv5Sample........................................................................................................................... 325 6.12 Iot Mqttv5Last Will Sample............................................................................................................... 328 6.13 Iot Mqttv5Req Res Sample.............................................................................................................. 328 6.14 Iot Mqttv5User Props Sample.......................................................................................................... 329 6.15 Json Xml Samples.......................................................................................................................... 330 6.15.1 Tc3Json Xml Sample Xml Dom Writer................................................................................ 330 6.15.2 Tc3Json Xml Sample Xml Dom Reader.............................................................................. 331 6.15.3 Tc3Json Xml Sample Json Dom Reader............................................................................ 332 6.15.4 Tc3Json Xml Sample Json Sax Writer................................................................................ 333 6.15.5 Tc3Json Xml Sample Json Sax Reader.............................................................................. 333 6.15.6 Tc3Json Xml Sample Json Data Type................................................................................ 334 7 Appendix................................................................................................................................................ 337 7.1 Sample configurations................................................................................................................... 337 7.1.1 Mosquitto........................................................................................................................ 337 7.2 Error Codes................................................................................................................................... 339 7.3 ADS Return Codes........................................................................................................................ 340 7.4 Error diagnosis.............................................................................................................................. 344 7.5 Support and Service...................................................................................................................... 346 4 Version: 1.12.0 TF6701
## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. For installation and commissioning of the components, it is absolutely necessary to observe the documentation and the following notes and explanations. The qualified personnel is obliged to always use the currently valid documentation. The responsible staff must ensure that the application or use of the products described satisfies all requirements for safety, including all the relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been prepared with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. No claims to modify products that have already been supplied may be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of designations or trademarks used in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Patents The Ether CAT Technology is covered, including but not limited to the following patent applications and patents: EP1590927, EP1789857, EP1456722, EP2137893, DE102015105702 and similar applications and registrations in several other countries. Ether CAT® is registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document as well as the use and communication of its contents without express authorization are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. TF6701 Version: 1.12.0 5
## Page 6

Foreword Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 6 Version: 1.12.0 TF6701
## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. 1.4 Documentation output status Version Change 1.12.0 New: Getting started [} 13] Supported functions [} 15] Supported message brokers [} 17] Protocol basics [} 26] Security [} 40] Get Time Since Last Broker Message [} 62] MQTT5 [} 69] TF6701 Version: 1.12.0 7
## Page 8

Overview 2 Overview The function blocks of the PLC library Tc3_Iot Base can be used for publisher/subscriber based data exchange between the Twin CAT PLC and a message broker via the MQTT communication protocol. Symbols can be sent (publish mode) and received (subscribe mode). The data format to be used is freely definable and can be created via additional PLC libraries, e.g. the Tc3_Json Xml library. In addition to the PLC library, a Twin CAT I/O device is available, via which a device-to-device communication connection can be configured via a message broker. The main application case for this I/O device is where two Twin CAT-based systems are to exchange data with each other via a message broker. Alternatively, an EK9160 can also be connected to a Twin CAT system via MQTT. 8 Version: 1.12.0 TF6701
## Page 9

Overview Product components TF6701 Io T Communication consists of the following components, which are installed [} 10] with Twin CAT 3 as standard: • Driver: Tc Iot Drivers.sys (supplied with Twin CAT 3 XAE and XAR Setups) • PLC library: Tc3_Iot Base (supplied with Twin CAT 3 XAE Setup) TF6701 Version: 1.12.0 9
## Page 10

Installation 3 Installation 3.1 System requirements Technical data Description Operating system Windows 7/10, Windows Embedded Standard 7, Windows CE 7, Twin CAT/BSD Target platform PC architecture (x86, x64 and ARM) Minimum Twin CAT version (MQTTv3) Twin CAT 3.1 Build 4022.0 or higher Minimum Twin CAT version (MQTTv5) Twin CAT 3.1 Build 4026.0 or higher Required Twin CAT setup level Twin CAT 3 XAE, XAR Required Twin CAT license TF6701 TC3 Io T Communication Please also see our documentation article on the supported MQTT functions [} 15] for a fine-grained overview. 3.2 Installation Twin CAT 3.1 Build 4022 and 4024 All the required components are supplied directly with the Twin CAT setup. • Twin CAT XAE Setup: Contains the MQTT driver and the PLC library (Tc3_Iot Base [} 55]) • Twin CAT XAR Setup: Contains only the MQTT driver Twin CAT 3.1 Build 4026 The MQTT driver is already included in the Twin CAT Standard Workload. The PLC library Tc3_Iot Base can be installed via the package Twin CAT. XAE. PLC. Lib. Tc3_Iot Base. If you are using Twin CAT 3.1 Build 4026 (and higher) on the Microsoft Windows operating system, you can install this function via the Twin CAT Package Manager, see Installation documentation. Normally you install the function via the corresponding workload; however, you can also install the packages contained in the workload individually. This documentation briefly describes the installation process via the workload. Command line program Tc Pkg You can use the Tc Pkg Command Line Interface (CLI) to display the available workloads on the system: tcpkg list -t workload You can use the following command to install the workload of the TF6701 Io T Communication MQTT function. tcpkg install TF6701. Iot Communication. XAE Twin CAT Package Manager UI You can use the User Interface (UI) to display all available workloads and install them if required. To do this, follow the corresponding instructions in the interface. 3.3 Licensing The Twin CAT 3 function can be activated as a full version or as a 7-day test version. Both license types can be activated via the Twin CAT 3 development environment (XAE). 10 Version: 1.12.0 TF6701
## Page 11

Installation Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. TF6701 Version: 1.12.0 11
## Page 12

Installation 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. 12 Version: 1.12.0 TF6701
## Page 13

Technical introduction 4 Technical introduction 4.1 Getting started This documentation article is intended to allow you an initial, quick start in how to use this product. After the successful Installation [} 10] and Licensing [} 10], perform the following steps in order to connect to an MQTT Message Broker and send and receive messages. Message Broker installation This document requires the presence of a locally installed and functional MQTT Message Broker. As an example we use the Mosquitto Message Broker here, but you can use any message broker you like. Message Broker setup The Mosquitto Message Broker has been shipped since version 2.x with a configuration that requires security measures to be set up to ensure secure operation of the message broker. In the following, we will show you how to modify the Mosquitto Message Broker configuration so that an unsecured communication connection can be established with the broker. However, this should be done exclusively for testing purposes in a trusted operating environment. For productive operation, we recommend using a secure broker configuration. 1. Install the Mosquitto Message Broker on your system. 2. Make a backup of the mosquitto.conf file from the Mosquitto installation directory. This is typically located at C:\Program Files\mosquitto. 3. Open the mosquitto.conf file with a text editor of your choice and remove the existing content. Add the following content and save the file. listener 1883 allow_anonymous true 4. Restart the Mosquitto Message Broker, either via the corresponding Windows service or manually via the console or mosquitto.exe. ð You have now configured the Mosquitto Message Broker to listen for incoming client connections on port 1883 and it does not require any security (neither user authentication nor client certificates). You can now start setting up the Twin CAT project. Setup of the Twin CAT project After you have installed the message broker, you can now start setting up the Twin CAT project to connect to the broker and exchange messages via it. 1. Create a Twin CAT project with a PLC and add Tc3_Iot Base as library reference. 2. Create a program block and create an instance of FB_Iot Mqtt Client [} 55] in the declaration part as well as two auxiliary variables to control the program flow if needed. PROGRAM Prg Mqtt Com VAR fb Mqtt Client : FB_Iot Mqtt Client; b Set Parameter : BOOL := TRUE; b Connect : BOOL := TRUE; END_VAR 3. Declare two variables (for topic and payload) for the MQTT message to be sent. In the sample, a message is to be sent every second, which is to be realized via a corresponding timer function block. A counter variable is to be used later for the message content. (* published message *) s Topic Pub : STRING(255) := 'My Topic'; s Payload Pub : STRING(255); fb Timer : TON := (PT:=T#1S); i : UDINT; TF6701 Version: 1.12.0 13
## Page 14

Technical introduction 4. For each message receive operation a variable containing the topic to be received should be declared, plus two further variables indicating the topic and payload of the last received message. The received messages are to be collected in a queue in order to be evaluated sequentially. For this you declare an instance of FB_Iot Mqtt Message Queue [} 64] and an instance of FB_Iot Mqtt Message [} 66]. (* received message *) b Subscribed : BOOL; s Topic Sub : STRING(255) := 'My Topic'; {attribute 'Tc Encoding':='UTF-8'} s Topic Rcv : STRING(255); {attribute 'Tc Encoding':='UTF-8'} s Payload Rcv : STRING(255); fb Message Queue : FB_Iot Mqtt Message Queue; fb Message : FB_Iot Mqtt Message; 5. In the program part, the MQTT client must be triggered cyclically, in order to ensure that a connection to the broker is established and maintained and the message is received. In this sample, the connection parameters are assigned once in the program code before the client call. Since this is usually only required once, the parameters can already be specified in the declaration part during instantiation of the MQTT client. Not all parameters have to be assigned. In our sample the broker is installed locally on the same system on which you want to activate the PLC project. Alternatively, you can specify the IP address or host name of the system on which the message broker was installed. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.s Host Name := 'localhost'; fb Mqtt Client.n Host Port := 1883; fb Mqtt Client.ip Message Queue := fb Message Queue; END_IF fb Mqtt Client. Execute(b Connect); 6. The cyclic call of the MQTT client ensures that the messages are received. The client receives all messages with topics to which it has previously subscribed with the broker (see next step) and places them in the message queue. Once messages are available, call the method Dequeue() to gain access to the message properties such as topic or payload via the message object fb Message. In the following implementation of message evaluation, one received message is evaluated per cycle. If several messages were accumulated in the message queue, the evaluation is distributed over several cycles. IF fb Message Queue.n Queued Messages > 0 THEN IF fb Message Queue. Dequeue(fb Message:=fb Message) THEN fb Message. Get Topic(p Topic:=ADR(s Topic Rcv), n Topic Size:=SIZEOF(s Topic Rcv) ); fb Message. Get Payload(p Payload:=ADR(s Payload Rcv), n Payload Size:=SIZEOF(s Payload Rcv), b Set Null Termination:=FALSE); END_IF END_IF 7. As soon as the connection to the broker is established, the client should subscribe to a particular topic. A message should be sent every second. In this sample, s Topic Pub = s Topic Sub, so that a loopback occurs and the sent messages are received right back. In other applications the topics usually differ. IF fb Mqtt Client.b Connected THEN IF NOT b Subscribed THEN b Subscribed := fb Mqtt Client. Subscribe(s Topic:=s Topic Sub, e Qo S:=Tc Iot Mqtt Qos. At Most Once De livery); END_IF fb Timer(IN:=TRUE); IF fb Timer. Q THEN // publish new payload every second fb Timer(IN:=FALSE); i := i + 1; s Payload Pub := CONCAT('My Message', TO_STRING(i)); fb Mqtt Client. Publish(s Topic:= s Topic Pub, p Payload:= ADR(s Payload Pub), n Payload Size:= LEN2(ADR(s Payload Pub))+1, e Qo S:= Tc Iot Mqtt Qos. At Most Once Delivery, b Retain:= FALSE, b Queue:= FALSE ); END_IF END_IF Next steps Now that you have successfully connected to the message broker, we recommend that you reset the Mosquitto Message Broker to its delivery state. For this, please take the backup file of mosquitto.conf that you created in the previous steps. This file, together with the broker documentation, is a good basis for further steps, e.g. to set up a secure message broker operating environment considering client/server certificates and user authentication. 14 Version: 1.12.0 TF6701
## Page 15

Technical introduction In the above sample, we have sent or received a string variable as the payload of the message. Since the data format [} 29] is not specified for MQTT, you are free to decide how this should be structured. However, typical Io T applications use a JSON or XML-based data format. For this purpose, Beckhoff provides the PLC library Tc3_Json Xml, which you can use to create and read JSON and XML documents. 4.2 Supported functions The following table gives an overview of all supported functions. In general, both MQTT 3.1.1 (hereafter referred to as MQTT3) and MQTT 5.0 (hereafter referred to as MQTT5) are supported. TF6701 Version: 1.12.0 15
## Page 16

Technical introduction Function Supported in Min. Twin CAT version Description User authentication MQTT3/MQTT5 3.1 Build 4022.0 A user name/password combination can be used to log in to the message broker. Cipher Suites MQTT3/MQTT5 3.1 Build 4022.0 Specification of the Cipher Suites to be used. Clean Session MQTT3/MQTT5 3.1 Build 4022.0 The use of Clean Session is currently supported only if Clean Session = TRUE. Client-ID MQTT3/MQTT5 3.1 Build 4022.0 Specification of an MQTT Client-ID. Connection MQTT5 3.1 Build 4026.0 The Connection acknowledgement Acknowledgement [} 34] feature can be used. Data format MQTT3/MQTT5 3.1 Build 4022.0 The data format [} 29] can be freely defined. Appropriate auxiliary libraries for easy use of JSON and XML are available. Keep Alive MQTT3/MQTT5 3.1 Build 4022.0 Set the Keep Alive value for the MQTT connection. Last Will MQTT3/MQTT5 3.1 Build 4022.0 Definition of a Last Will [} 33] message. Message expiry interval MQTT5 3.1 Build 4026.0 The Message expiry interval [} 38] can be set. Pre-Shared Key (PSK) MQTT3/MQTT5 3.1 Build 4022.0 A PSK can be used to secure the transport channel (using TLS). Publish MQTT3/MQTT5 3.1 Build 4022.0 Sending (publishing) messages to a topic. Qo S 0, 1, 2 MQTT3/MQTT5 3.1 Build 4022.0 The Qo S [} 30] levels 0, 1 and 2 can be used for publish and subscribe operations. Reason codes MQTT5 3.1 Build 4026.0 Reason codes [} 38] can be received and evaluated. Request/Response MQTT5 3.1 Build 4026.0 Send/receive messages based on the Request/ Response method [} 33]. Retain MQTT3/MQTT5 3.1 Build 4022.0 Messages can be flagged with Retain [} 32] during the Publish process. Session expiry interval MQTT5 3.1 Build 4026.0 The Session expiry interval [} 38] can be set and used. Subscribe/Unsubscribe MQTT3/MQTT5 3.1 Build 4022.0 Create a subscription to a topic to receive messages. Topics MQTT3/MQTT5 3.1 Build 4022.0 Topic [} 27] hierarchies can be defined freely. 16 Version: 1.12.0 TF6701
## Page 17

Technical introduction Function Supported in Min. Twin CAT version Description Transport Layer Security MQTT3/MQTT5 3.1 Build 4022.0 TLS can be used to (TLS) version 1.1, 1.2 and secure the transport 1.3 channel. User Properties MQTT5 3.1 Build 4026.0 Using User Properties [} 34] to define metadata on a message. Wildcard Subscriptions MQTT3/MQTT5 3.1 Build 4022.0 Use of wildcards (#, +) for a subscription. Certificates MQTT3/MQTT5 3.1 Build 4022.0 Certificates can be used to secure the transport channel (using TLS). The PEM format is used here. Certificate revocation lists MQTT3/MQTT5 3.1 Build 4022.0 Use of certificate revocation lists. 4.3 Supported message brokers MQTT is a standardized transport protocol that has become widespread in recent years. Especially in the area of cloud connectivity, all major cloud providers now rely on MQTT as the transport protocol for connecting Io T devices. The following table provides an overview of common cloud services or software applications with an MQTT interface that have already been used in various customer applications. This table is not a complete listing of all supported message brokers, but only the most common systems which are often used in customer applications. TF6701 Version: 1.12.0 17
## Page 18

Technical introduction Cloud service or software Description AWS Io T Core AWS Io T Core is a message broker managed by Amazon Web Services as a native cloud service. Io T devices can connect to the service via a secure transport channel and exchange data. Various mechanisms allow routing of messages to other AWS services. A corresponding Code Sample [} 317] demonstrates how to connect to this broker. AWS Io T Greengrass AWS Io T Greengrass, as part of AWS Io T Core, is a service that typically runs in an edge device environment. The integrated message broker enables MQTT communication with lower-level devices. A corresponding Code Sample [} 317] demonstrates how to connect to this broker. AWS Io T Shadow The AWS Io T Shadow stores status information of an Io T device within the AWS Io T Core service. The Code Sample for AWS Io T Core [} 317] can be used as a basis for communication with the AWS Io T Shadow. Bosch Io T Suite The Bosch Io T Suite is a product family in the Bosch Io T Cloud that enables data communication and analysis, as well as device management of Io T devices. An MQTT interface enables the reception and transmission of telemetry data. A corresponding Code Sample [} 322] demonstrates how to connect to this broker. Cloud MQTT Broker Message broker as a managed cloud service. Our general Code Sample for establishing an MQTT connection [} 312] can be used as a basis for data communication. IBM Watson Io T IBM Watson Io T is a family of products in the IBM Cloud that enables data communication and analysis, as well as Device Management of Io T devices. An MQTT interface enables the reception and transmission of telemetry data. A corresponding Code Sample [} 323] demonstrates how to connect to this broker. Hive MQ Message Broker Hive MQ is a message broker that enables fast and secure data exchange via the MQTT protocol. Our general Code Sample for establishing an MQTT connection [} 312] can be used as a basis for data communication. Homebridge Homebridge allows the connection of Io T devices to Apple Home Kit, which otherwise do not have their own native Apple Home Kit support. For Homebridge there is a MQTT client plugin, through which you can connect to a message broker. Our general Code Sample for establishing an MQTT connection [} 312] can be used as a basis for data communication with Homebridge. 18 Version: 1.12.0 TF6701
## Page 19

Technical introduction Cloud service or software Description Math Works Thing Speak Thing Speak is a cloud-based service that enables data aggregation, visualization and analysis of Io T data. A corresponding Code Sample [} 324] demonstrates how to connect to this broker. Microsoft Azure Io T Edge Microsoft Azure Io T Edge is a software application that typically runs in an Edge Device environment. The integrated message broker enables MQTT communication with lower-level devices. You can use our Code Sample for Azure Io T Hub [} 320] to establish an MQTT connection with this application. Microsoft Azure Io T Hub Microsoft Azure Io T Hub is a managed messaging service in the Microsoft Azure Cloud that enables secure exchange of Io T data. A corresponding Code Sample [} 320] demonstrates how to connect to this broker. Microsoft Azure Io T Hub Device Twin The Microsoft Azure Io T Hub Device Twin stores status information of an Io T device within the Microsoft Azure Io T Hub. A corresponding Code Sample [} 325] demonstrates how you can exchange data with the Device Twin. Mosquitto Message Broker Mosquitto is a message broker that enables fast and secure data exchange via the MQTT protocol. Our general Code Sample for establishing an MQTT connection [} 312] can be used as a basis for data communication. Node-RED Node-RED is a programming tool that allows graphical programming to connect devices together. Node-RED has an integrated MQTT client, which is suitable for communication with a message broker and can be connected to Twin CAT. Our general Code Sample for establishing an MQTT connection [} 312] can be used as a basis for data communication with Node-RED. Shelly Shelly devices offer an MQTT client out of the box, which can connect to a message broker and exchange data with other devices, e.g. Twin CAT. Our general code sample for establishing an MQTT connection [} 312] can be used as a basis for data communication with a Shelly device. 4.4 Application examples 4.4.1 Sending SMS and E-Mail notifications Many machine applications use SMS and email notifications to send status information and alarms. This documentation describes a cloud-based approach to sending text and email messages. With this approach, the communication channel is derived from the actual message type (text, email), and the decision whether an incoming message from the machine is to be treated as text or email (or both) is made in the cloud. TF6701 Version: 1.12.0 19
## Page 20

Technical introduction History Classically, either a telephone dial-up (via a connected USB or serial modem) or an SMTP connection to a mail server directly from the machine control was used to send SMS or email messages. Although this may have worked very well, the disadvantages of this approach are quickly apparent: • Special modem hardware and a contract with a cellular provider are required, resulting in additional costs. • Another communication channel to a mail server is needed. On the Twin CAT side, the Twin CAT3 Function TF6350 TC3 SMS/SMTP supports the PLC programmer in sending SMS and email messages. To send text messages, the supplement product communicates with a GSM modem connected to the controller via an RS232 serial port. For email messages, the supplement product establishes an SMTP connection to a mail server on the network. After that, the mail server is responsible for message delivery. Requirements Please ensure that the following requirements are met before you continue with this documentation. • Make sure that you have created an AWS account and that you can access the AWS management console using the account credentials. • Install Twin CAT 3.1 Build 4022.0 or higher, so that the product TF6701 Io T Communication is available. We recommend updating to the latest Twin CAT version if possible. • To understand how Twin CAT is linked to AWS Io T Core, please refer to the TF6701 documentation. Other Twin CAT Io T products and protocols In this tutorial we will use TF6701 Io T Communication to connect to AWS Io T Core via MQTT. Please note that other products from the Twin CAT Io T product range can also connect to AWS Io T Core and that the same principles apply for these products. Also note that MQTT is not the only transport channel that can be used to connect to AWS Io T Core. Another transport option is HTTPS, which can be implemented with the Twin CAT Io T product TF6760 Io T HTTPS/REST. We particularly recommend the following articles about getting started with AWS. We will point out when it is important to read any of these articles before proceeding to the next step. AWS Io T Core: https://docs.aws.amazon.com/iot/latest/developerguide/iot-gs.html Amazon SNS: https://docs.aws.amazon.com/sns/latest/dg/sns-getting-started.html Using Amazon SNS in an AWS Io T Core Rule: https://docs.aws.amazon.com/iot/latest/developerguide/ config-and-test-rules.html Architecture Cloud systems provide the technical infrastructure that makes the Internet of Things (Io T) possible. They also provide the scalability needed to support millions of connected devices. Cloud service providers like Microsoft Azure and Amazon Web Services (AWS) offer hundreds of services to support different use cases: virtual machines, message brokers, databases, serverless functions, etc. Their product portfolio also includes various functions for processing messages from connected devices. A central message broker (sometimes referred to as an "Io T Hub") provides a single, secure endpoint for devices to communicate with other services in the Ecosystem. Using so-called "rules", the user can then filter messages and easily forward them to other services. Because the message broker is treated as the single endpoint for all data connectivity scenarios, the firewall attack surface is minimized. The following diagram illustrates this concept. It is based on services offered by AWS as an example. Other cloud platforms such as Microsoft Azure offer similar services. 20 Version: 1.12.0 TF6701
## Page 21

Technical introduction Focusing on our use case (text messages and emails), the relevant services are: • AWS Io T Core (message broker) for a single, secure endpoint in the cloud • Amazon SNS for sending text messages and emails Compared to a traditional setup, a cloud-based solution has the following advantages: 1. The message type (email, text, ...) is transparent for the device that issues the message. The device simply sends the message, while the decision whether it is sent in the form of an email or text message is made in the cloud. 2. Address changes do not have to be forwarded to the device that issues a message. All relevant contact data (email addresses, phone numbers, ...) are managed in the cloud. 3. Secure transport between the device that issues a message and the cloud. Each message of the device is sent to AWS Io T Core over a secure communication channel, either MQTT or HTTPS. 4. The required internet connectivity is based on TCP/IP. No additional modem hardware is required for sending text messages. 5. No contract with a mobile phone provider is required. AWS manages the text message transmission. Charges are based on usage (pay-per-use). Twin CAT Io T supports MQTT and HTTPS connectivity with AWS Io T Core. The following pages of the documentation provide a more detailed configuration description for the components involved in this use case. Setup of AWS Io T Core AWS Io T Core is a scalable and managed message broker service in the AWS Eco system. It enables you to securely connect devices and manage their data ingest. To use AWS Io T Core, you need: • An AWS account for logging into the AWS web-based management console. All required AWS Io T Core features are automatically implemented when the account is created, so service provisioning is not necessary. • Device credentials (certificates) and security policies for each connected device. The certificates must be transferred to the device and used by the device while connecting to the AWS Io T Core service. In other words, the certificates are always used by Twin CAT Io T when the connection is established. This is described in a later chapter. The setup of AWS Io T Core includes the following topics: 1. Logging into the AWS Io T console 2. Creating an object TF6701 Version: 1.12.0 21
## Page 22

Technical introduction 3. Registering a device 4. Configuring your machine 5. Viewing the MQTT messages issued by the device with the AWS Io T MQTT client 6. Configuring and testing rules (next chapter) These steps are described in detail in the tutorial Getting Started with AWS Io T Core. This tutorial is a good source of information and describes the above steps in detail. We recommend that you read this tutorial and work through the step-by-step instructions before proceeding to the next chapter in this documentation. Step 6 of the tutorial describes exactly the use case we are trying to solve: Configuring an AWS Io T Core rule that uses Amazon SNS to send an email or text message. Setup of Amazon SNS Amazon SNS allows you to send push notifications to mobile apps, text messages to mobile numbers, and plain text emails to email addresses. Step 6 ("Configuring and testing rules") of the official "Getting started with AWS Io T Core" guide describes in detail how Amazon SNS must be prepared for an AWS Io T rule to forward a device message to an SNS topic. If you want to learn more about Amazon SNS, we recommend the tutorial Getting started with Amazon SNS. In this official graphic, AWS Io T Core acts as an intermediate station between the publisher of a message (the "device") and Amazon SNS. Simply follow the steps described in the official "Getting started guide" to • create an Amazon SNS topic and a subscription (use email as "protocol") • create an AWS Io T Core rule • test the rule Please note the following: when using "email" as protocol, a one-off message will be sent to the email address entered by the user to confirm the subscription. This email must be acknowledged before messages can be sent to this email address. This procedure is similar to that for e-newsletters. 22 Version: 1.12.0 TF6701
## Page 23

Technical introduction Note on service limits: note that for regular AWS accounts there may be a limit for text messages. This limit can be increased by calling AWS support. For more information, visit the Amazon SNS service limit web page. Once the Amazon SNS Topic/Subscription and the AWS Io T rule have been created, the setup can be tested using the MQTT client integrated into the AWS management console. To do this, simply send a test message to topic "my/topic" topic specified as a filter in the AWS Io T rule and use the following JSON content: { "default": "Hello, from AWS Io T console", "email": "Hello, from AWS Io T console" } All available properties are documented in the Amazon SNS documentation. TF6701 Version: 1.12.0 23
## Page 24

Technical introduction The notification email should arrive at the email address used for the Amazon SNS subscription after a few seconds. In the next step we want to enable Twin CAT to send messages to AWS Io T Core. Setup of Twin CAT The Twin CAT Io T Supplement products facilitate cloud connectivity for different use cases. One of their main advantages is that they use standard communication protocols to provide connectivity to cloud systems from different vendors, such as Microsoft Azure, Amazon Web Services, IBM, Google, etc. In this documentation, we use TF6701 Io T Communication to connect to AWS Io T Core and publish a message for the topic "my/topic" that has been set as a filter in the AWS Io T rule to forward the messages that arrive at Amazon SNS for that particular topic, in order to send a notification email. 24 Version: 1.12.0 TF6701
## Page 25

Technical introduction Requirements This chapter is based on the regular TF6701 sample Iot Mqtt Sample Aws Io T, which illustrates the general procedure for connecting to AWS Io T Core. Download this sample to establish a common starting point. For more detailed information about how the sample code works, please refer to the corresponding Infosys website for this particular sample. Important Before you continue please ensure you have completed all the steps described in chapter Setup of AWS Io T Core. Establishment of a connection All certificates created with the AWS Management Console must be referenced in the FB_Iot Mqtt Client.st TLS data structure (s CA, s Cert and s Key File). Use the URL of the AWS Io T Core instance as the s Host Name, as shown on the AWS Management Console. Since the connection is a secure MQTT connection, use 8883 as n Host Port. The MQTT client ID (s Client Id) is the object name (Thing Name) that was used when the object was created according to the chapter Setup of AWS Io T Core. (* TLS settings for AWS Io T connection *) fb Mqtt Client.st TLS.s CA := 'c:\certs\Amazon Root CA1.pem'; fb Mqtt Client.st TLS.s Cert := 'c:\certs\6a1ba937cb-certificate.pem.crt'; fb Mqtt Client.st TLS.s Key File := 'c:\certs\6a1ba937cb-private.pem.key'; (* Broker settings für AWS Io T *) fb Mqtt Client.s Host Name:= 'a XX-ats.iot.eu-central-1.amazonaws.com'; fb Mqtt Client.n Host Port:= 8883; fb Mqtt Client.s Client Id:= 'Thing Name'; Defining appropriate topics The standard sample illustrates how to connect to AWS Io T Core for exchange data with this message broker. It publishes messages for a topic and subscribes to a topic to receive messages. In the sample both topics are identical, so that Twin CAT receives the same message that it sent to the broker. In addition to this regular sample behavior, we will now write new code to make the sample send a message for the topic "my/topic" so that an email is sent. For this purpose we first declare some new variables: s Topic Email : STRING(255) := 'my/topic'; b Send Email : BOOL; s Payload Email : STRING(255) := '{"default": "Hello from Twin CAT","message": "Hello from Twin CAT"}'; Then we will add the following lines of code after the IF query for the timer execution: IF fb Timer. Q THEN ... END_IF IF b Send Email THEN b Send Email := FALSE; fb Mqtt Client. Publish(s Topic:= s Topic Email, p Payload:= ADR(s Payload Email), n Payload Size:= LEN2(ADR(s Payload Email)), e Qo S:= Tc Iot Mqtt Qos. At Most Once Delivery, b Retain:= FALSE, b Queue:= FALSE); END_IF After activating the project, first validate whether the connection with AWS Io T Core was successful by checking the parameter e Connection State (must be and remain "MQTT_ERR_SUCCESS"). If the connection status appears to fluctuate or if an TLS error is reported (e.g. "MQTT_ERR_TLS_VERIFICATIONFAILED"), double-check the steps described in chapter "Setup of AWS Io T Core" and make sure that the device certificate has been activated and the security policy allows the device to publish data for the topics used. If the connection is successful, try setting b Send Email to TRUE. After a few seconds, an email should appear in the inbox of the email address that was used for the Amazon SNS subscription. TF6701 Version: 1.12.0 25
## Page 26

Technical introduction 4.5 Protocol basics 4.5.1 Overview MQTT (Message Queueing Telemetry Transport) is a publisher/subscriber-based communication protocol, which enables message-based transfer between applications. A central component in this type of transmission is the so-called message broker, which is therefore a message-oriented middleware. The message broker has the task of distributing messages between the individual applications, or the sender and receiver of a message. It decouples the sender and receiver, so that it is not necessary for the sender and receiver to know their respective address information. During sending and receiving all communication devices contact the message broker, which handles the distribution of the messages. When a client connects to the message broker, security mechanisms such as TLS (Transport Layer Security) or even user name/password authentication can be used to encrypt the communication connection and realize authentication between client and message broker. 4.5.2 Protocol versions The MQTT protocol and its specification have been available since the late 1990s. In 2019, version 5.0 of the specification was released, which adds a number of new features to the protocol. 26 Version: 1.12.0 TF6701
## Page 27

Technical introduction 4.5.3 Client ID When establishing a connection with the message broker, the client transmits a so-called Client ID, which is used to uniquely identify the client on the message broker. The MQTT communication driver from Twin CAT3 automatically generates its own Client ID, which is based on the following naming scheme: Plc Project Name-Tc Mqtt Client%n %n is an incremental counter for the number of the respective MQTT client instance. Each instance of the FB_Iot Mqtt Client function block increments this counter. In most cases, using this Client ID format is sufficient. In special cases, e.g. depending on the message broker or also due to the own MQTT application, an application-specific Client ID must be assigned. This can be done via a corresponding input at the function blocks FB_Iot Mqtt Client [} 55] and FB_Iot Mqtt5Client [} 79]. If a unique Client ID is to be generated automatically at the start of the PLC project, the use of a GUID is recommended, which can be generated via the function block FB_Create Guid from the library Tc2_System. The following sample code illustrates the use of this function block. PROGRAM MAIN VAR fb Guid : FB_Create GUID; obj Guid : GUID; s Guid : STRING; n State : UINT; b Start : BOOL; // set to TRUE to start this sample END_VAR CASE n State OF 0 : IF b Start THEN b Start := FALSE; n State := n State + 1; END_IF 1 : // create GUID using FB_Create Guid from Tc2_System library fb Guid(b Execute := TRUE, p Guid Buffer := ADR(obj Guid), n Guid Buffer Size := SIZEOF(obj Guid)); IF NOT fb Guid.b Busy THEN fb Guid(b Execute := FALSE); IF NOT fb Guid.b Error THEN n State := n State + 1; ELSE n State := 255; // go to error state END_IF END_IF 2: // GUID has been created, now convert to STRING s Guid := GUID_TO_STRING(obj Guid); n State := n State + 1; 3: // done 255: // error state END_CASE After execution of this State Machine the variable s Guid contains the generated GUID as STRING. This can then be used at the function blocks FB_Iot Mqtt Client and FB_Iot Mqtt5Client as Client ID. 4.5.4 Topics The message broker manages the addressing of messages via so-called "Topics". A topic can be thought of as a hierarchically organized mailbox, where the individual hierarchical levels are separated from each other by a "/". Sample: Campus/Building1/Floor2/Room3/Temperature When a publisher sends a message, it always specifies for which topic it is intended. A subscriber indicates which topic it is interested in. The message broker forwards the message accordingly. TF6701 Version: 1.12.0 27
## Page 28

Technical introduction Wildcards It is possible to use wildcards in conjunction with topics. A wildcard is used to represent part of the topic. In this case a subscriber may receive messages from several topics. A distinction is made between two types of wildcards: • Single-level wildcards • Multi-level wildcards Example for single-level wildcard: The + symbol describes a single-level wildcard. If it is used by the subscriber as described below, for example, corresponding messages to the topics are either received by the subscriber or not. • The receiver subscribes to Campus/Building1/Floor2/+/Temperature • The publisher sends to Campus/Building1/Floor2/Room1/Temperature - OK • The publisher sends to Campus/Building1/Floor2/Room2/Temperature - OK • The publisher sends to Campus/Building42/Floor1/Room1/Temperature - NOK • The publisher sends to Campus/Building1/Floor2/Room1/Fridge/Temperature - NOK Example for multi-level wildcard: The # symbol describes a multi-level wildcard. If it is used by the subscriber as described below, for example, corresponding messages to the topics are either received by the subscriber or not. The # symbol must always be the last symbol in a topic string. • The receiver subscribes to Campus/Building1/Floor2/# • The publisher sends to Campus/Building1/Floor2/Room1/Temperature - OK • The publisher sends to Campus/Building1/Floor2/Room2/Temperature - OK • The publisher sends to Campus/Building42/Floor1/Room1/Temperature - NOK • The publisher sends to Campus/Building1/Floor2/Room1/Fridge/Temperature - OK • The publisher sends to Campus/Building1/Floor2/Room1/Humidity - OK 28 Version: 1.12.0 TF6701
## Page 29

Technical introduction 4.5.5 Data formats MQTT allows the transport of binary data, whereby the actual structure of the message content is not fixed by the specification. Thus, any data can be transported, e.g. cyclic or event-based telemetry data or commands to the controller. Since the data format is not specified, the format must be known to the sender and receiver. Over the years, a multitude of data formats and corresponding data description languages have emerged. In many Io T applications, JSON and XML have established themselves as description languages. However, the structure of a corresponding JSON or XML document is still application-specific and must be known to the applications so that they can exchange data with each other. JSON JSON (Java Script Objection Notation) is a lightweight description language in an easy-to-read text form in which data is organized into so-called objects via property/value pairs. JSON has established itself in most Io T applications due to its easy readability and still low overhead (compared to other description languages such as XML). The following sample shows a JSON document containing telemetry values from three sensors including metadata and timestamps. { "Timestamp": "2017-04-04T12:42:42", "Values": { "Sensor1": 42.41999816894531, "Sensor2": 230, "Sensor3": 3 }, "Meta Data": { "Sensor1": { "Unit": "m/s", "Display Name": "Speed" }, "Sensor2": { "Unit": "V", "Display Name": "Voltage" }, "Sensor3": { "Unit": "A", "Display Name": "Current" } } } XML XML (Extensible Markup Language) is a description language for structuring data in order to make it readable for both humans and programs. XML has a much higher overhead than JSON and is hardly used in modern Io T applications. The sample shown above could be represented in XML as follows. <Xml Document> <Timestamp>2017-04-04T12:42:42</Timestamp> <Values> <Value Name="Sensor1">42.41999816894531</Value> <Value Name="Sensor2">230</Value> <Value Name="Sensor3">3</Value> </Values> <Meta Data Coll> <Meta Data Name="Sensor1"> <Unit>m/s</Unit> <Display Name>Speed</Display Name> </Meta Data> <Meta Data Name="Sensor2"> <Unit>V</Unit> <Display Name>Voltage</Display Name> </Meta Data> <Meta Data Name="Sensor3"> <Unit>A</Unit> <Display Name>Current</Display Name> </Meta Data> </Meta Data Coll> </Xml Document> TF6701 Version: 1.12.0 29
## Page 30

Technical introduction Of course, there are many other variants of how the above JSON can be converted into an equivalent XML (and here it also becomes clear why nevertheless sender and receiver must know the data format - despite JSON or XML). Only the basic principle is to be shown here. If you compare the two documents above, you will quickly notice the difference in size: while the JSON document has an approximate size (depending on any line breaks and spaces) of about 393 bytes, the equivalent XML document has a size of about 569 bytes and is thus about 44% larger (although the same information is transferred). PLC library Tc3_Json Xml The library Tc3_Json Xml, which is automatically installed with Twin CAT 3 XAE, facilitates creation and processing of JSON and XML objects. (See documentation PLC Lib: Tc3_Json Xml) 4.5.6 Qo S Qo S (Quality-of-Service) is an arrangement between the client and message broker with regard to guaranteeing of the message transfer. The Qo S level must be specified by the client for both the publish and the subscribe process. There are three different Qo S levels: • 0 - message is sent at most once • 1 - message is sent at least once • 2 - message is sent exactly once Interaction of publisher and subscriber Qo S The MQTT specification (MQTT5, chapter 3.8.4) defines a few basic rules when publisher and subscriber Qo S interact, especially when publisher and subscriber specify a different Qo S level. Qo S level 0 At this Qo S level the receiver does not acknowledge receipt. The message is not sent a second time. The following graphic illustrates this relationship once again, especially in comparison with the underlying TCP level. Qo S level 1 At this Qo S level the system guarantees that the message arrives at the receiver at least once, although the message may arrive more than once. The sender stores the message internally until it has received an acknowledgment from the receiver in the form of a PUBACK message. If the PUBACK message fails to arrive within a certain time, the message is resent. The following graphic illustrates this relationship once again, especially in comparison with the underlying TCP level. 30 Version: 1.12.0 TF6701
## Page 31

Technical introduction Qo S level 2 At this Qo S level the system guarantees that the message arrives at the receiver no more than once. On the MQTT side this is realized through a handshake mechanism. Qo S level 2 is the most secure level (from a message transfer perspective), but also the slowest. When a receiver receives a message with Qo S level 2, it acknowledges the message with a PUBREC. The sender of the message remembers it internally until it has received a PUBCOMP. This additional handshake (compared with Qo S 1) is important for avoiding duplicate transfer of the message. Once the sender of the message receives a PUBREC, it can discard the initial publish information, since it knows that the message was received once by the receiver. In other words, it remembers the PUBREC internally and sends a PUBREL. Once the receiver has received a PUBREL, it can discard the previously remembered states and respond with a PUBCOMP, and vice versa. Whenever a packet is lost, the respective communication device is responsible for resending the last message after a certain time. The following graphic illustrates this relationship once again, especially in comparison with the underlying TCP level. TF6701 Version: 1.12.0 31
## Page 32

Technical introduction 4.5.7 Retain MQTT does not define a mechanism for the publisher of a message to be guaranteed that a subscriber actually received the message. The publisher can only use the Qo S [} 30] level to ensure that the message was delivered securely to the message broker. On the other hand, even a subscriber cannot ensure when a publisher has sent a message. In the worst case, the recipient subscribes to the topic only after the publisher has sent a message. In this case, the subscriber would not receive the message. If the retain flag is set on publish, the subscriber would receive it. The following diagram illustrates this relationship once again: 32 Version: 1.12.0 TF6701
## Page 33

Technical introduction The so-called retain flag offers the possibility during the publish process to inform the message broker that it will persistently retain the message in the corresponding topic. The message broker always saves the last retain message sent. Any client that subscribes to this topic (either before or after publish) will then get this message delivered immediately once they set up the subscription. This process also works for Wildcard Subscriptions [} 28]. A retain message can also be removed from a topic by sending a message without payload to the corresponding topic with the retain flag set. 4.5.8 Last will The Last Will is a message sent by the broker to all clients subscribed to the matching topic in case of an irregular connection failure. If the MQTT client in the PLC loses the connection to the broker and a Last Will was stored when the connection was established, this Last Will is communicated by the broker without the client having to worry about it. In the case of a planned disconnect, the Last Will is not necessarily transmitted according to the specification. From the PLC programmer's point of view, he can decide whether he wants to publish the Last Will before calling the disconnect. For this purpose, the Last Will message is published again on the Last Will topic. This is necessary because the broker would not publish the Last Will message due to the regular disconnection. In the event of a Twin CAT context change and a resulting restart of the MQTT communication, the Io T driver sends the previously specified Last Will to the broker, because at this moment there is no longer any possibility from the PLC. If no Last Will was defined when the connection was established, no message will be transmitted before the disconnect. 4.5.9 MQTT5 extensions 4.5.9.1 Request/Response While with MQTT3 a request/response procedure still had to be implemented manually by corresponding, applicative handshake mechanisms of the MQTT clients, MQTT5 now offers a native implementation for this. The procedure is based on the fundamental assumption that the sender of a request defines a so-called "response topic" and sends it as part of the message. The recipient of the request can then use this response topic to send its response. The following figure illustrates this process. Fig. 1: TF6701 Version: 1.12.0 33
## Page 34

Technical introduction 4.5.9.2 User properties One of the most important innovations in MQTT5 are the so-called User properties. These are key/value pairs that are set for almost all MQTT packet types and can transport additional metadata - independent of the actual message content. There is no limit to the number of user properties as long as the maximum size of an MQTT message is not exceeded. This feature is similar to the key/value pairs found in an HTTP header, for example. The advantage of user properties is that they are decoupled from the actual message content. For example, description information for the message content can be transmitted, which simplifies the encoding/decoding of the message content on the receiver side. Furthermore, routing information can also be transmitted with the help of User properties, so that a recipient is told what to do with the received message content, for example. 4.5.9.3 Connection acknowledgement The newly introduced Conn Ack Return Codes allow a message broker to indicate to the client which MQTT functions it supports. This information is transmitted from the message broker to the client during the Conn Ack process. The following figure illustrates this process in simplified form. 34 Version: 1.12.0 TF6701
## Page 35

Technical introduction The following figure shows the connection establishment between client and message broker on TCP level: The following information can be transmitted from the message broker to the client during Connection Acknowledgement. TF6701 Version: 1.12.0 35
## Page 36

Technical introduction Property Description Retain available Specifies whether the message broker supports retain messages. Server Keep Alive Specifies the Keep Alive time assigned by the server. Shared subscriptions available Specifies whether the message broker supports shared subscriptions. Wildcard subscriptions available Specifies whether the message broker supports wildcard subscriptions, e.g. subscriptions to a # or + topic. Authentication data Contains the authentication data, depending on the authentication method used. Maximum packet size Specifies the maximum packet size of the control packet. If this value is not specified, then no maximum size is explicitly set. Maximum Qo S Specifies the maximum Qo S level that the message broker supports. For example, some message broker implementations do not support Qo S 2. Reason code Optional reason code that the message broker can transmit to the client as part of the Conn Ack procedure. In conjunction with the Server Reference (see below), the message broker can use this to inform the client, for example, that it is temporarily or permanently unavailable and/or can be reached at a new address. Maximum receive The server uses this property to limit the number of Qo S1 and Qo S2 publishes it is willing to process for the client simultaneously. Session expiry interval The server can use this to inform the client that it is using a different Session Expiry Interval than originally requested by the client. Response info Optional return information from the message broker to the client. A use case for this can be, for example, that the broker informs the client about a "topic area" which has been assigned to the client and which it can access. Maximum topic alias Specifies the maximum value that can be used for a topic alias. Assigned client ID Returns the Client ID assigned by the message broker if the client has not specified its own Client ID. Server reference Optional (address) reference to another message broker, e.g. for Reason Code 0x9C or 0x9D (Server unavailable, Server has moved). User Properties User Properties are key/value pairs that can be attached to the Publish Properties. The meaning of the User Properties is not part of the MQTT5 specification and therefore application specific. 4.5.9.4 Subscription identifier Clients can specify a so-called subscription identifier when creating a subscription. The message broker then internally stores a mapping between this subscription and the respective identifier. As soon as a message is sent from the broker to the client, the subscription identifier is also transmitted to the client. The client then has the option of assigning the message internally based on the subscription identifier. The following figure illustrates this relationship once again: 36 Version: 1.12.0 TF6701
## Page 37

Technical introduction In this sample, the MQTT client creates four subscriptions on the left side, each to partially "overlapping" topics using wildcards [} 28]. Now the right MQTT client publishes a message on the topic /car/red/ convertible. Now two options are available. 1. Unoptimized variant: The subscriber receives three MQTT messages (publishes) from the broker. Each message contains the respective subscription identifier. In the Twin CAT PLC, based on our sample Iot Mqttv5Sample [} 325], three messages would thus end up in the message queue. Example screenshot from Wireshark when receiving the three messages: Mosquitto Broker version 2.0.15 uses this transfer type by default. 2. The subscriber contains only one MQTT message from the broker, where this message contains a list of subscription identifiers. In the above sample, the identifiers 1, 2 and 3. In this case, only one message would end up in the message queue in the Twin CAT PLC. This message then contains an TF6701 Version: 1.12.0 37
## Page 38

Technical introduction array of the subscription identifiers. Example screenshot from Wireshark when receiving the message: The Hive MQ CE Broker in version 2023.3 uses this transfer type by default. Both transmission types are permitted according to the MQTT specification. 4.5.9.5 Expiry intervals Session Expiry With MQTT3, the Clean Session flag passed during connection establishment can be used to specify whether the message broker saves client session information after disconnection. MQTT5 replaces this setting with a Clean Start flag and the introduction of a Session Expiry interval. The Clean Start flag has the same function as Clean Session in MQTT3. However, if the client's session is not to be deleted directly, the expiry time can be set via Session Expiry (reference: ST_Iot Mqtt5Connect [} 93]). Message Expiry If a message with Qo S 1 or 2 is published and additionally subscribed by a client with Qo S 1 or 2 and the client was connected without the Clean Start flag, MQTT3 will hold a message in the message broker until the client is connected again. With MQTT5 it is possible to define an expiration time for a message. After this expiration time, the message will no longer be delivered to clients that were not connected at the time of sending. 4.5.9.6 Reason codes In MQTT3, there are only 10 Return Codes returned for the CONNACK and SUBACK message types. With MQTT5, on the other hand, it is possible to pass so-called Reason Codes in many packages. A Reason Code indicates that a predefined protocol error has occurred and is usually transmitted with acknowledge packets so that the client and message broker can react to the error condition. 38 Version: 1.12.0 TF6701
## Page 39

Technical introduction 4.5.9.7 Retry-handling Qo S MQTT uses TCP as its underlying transport protocol. TCP has the property that messages arrive exactly once and in the correct order in the case of a functioning connection. All packets of an MQTT connection therefore arrive at the remote terminal. If the TCP connection is interrupted, options are available with Qo S [} 30] 1 and 2 so that the messages can be delivered across multiple TCP connections. MQTT3 already allowed repeated message delivery with an uninterrupted TCP connection. However, this could result in an overloaded MQTT client being further overloaded in case of doubt, e.g. if the client needs several seconds to process a received message and in the meantime the message broker sends the message again because it has not (yet) received the acknowledgement. The following figure illustrates the reception process of a message from the subscriber's point of view, which has subscribed to a topic at the message broker with Qo S 2: Now, if the receiver does not immediately send a MQTT_Publish Received command after the MQTT_Publish due to an overload, the message broker at MQTT3 will prepare a resend of the publish and send it on its way. The TCP connection is still active in this case. This is illustrated in the following figure. TF6701 Version: 1.12.0 39
## Page 40

Technical introduction Due to a new extension in MQTT5, repeated MQTT message transmission (Resend) is prevented for clients and message brokers when a TCP connection is established. 4.5.9.8 Bi-directional disconnect In MQTT3, a client could perform a proper Disconnect with the message broker, i.e., the client notified the broker of the disconnection. However, the protocol did not allow the message broker to inform the clients that it was disconnecting. In MQTT5 there is now such a mechanism. The message broker can send an MQTT Disconnect packet to the clients and also specify a Reason Code for the disconnection. 4.6 Security When considering protection of data communication, a distinction can be made between two levels: protection of the transport channel [} 40] and protection at application layer [} 47]. 4.6.1 Transport layer The worldwide common standard Transport Layer Security (TLS) is used in the Twin CAT Io T driver for the secure transmission of data. The following chapter describes the TLS communication flow, taking TLS version 1.2 as an example. The TLS standard combines symmetric and asymmetric cryptography to protect transmitted data from unauthorized access and manipulation by third parties. In addition, TLS supports authentication of communication devices for mutual identity verification. Contents of this chapter The information in this chapter refers to the general TLS communication flow, without specific reference to the implementation in Twin CAT. They are only intended to provide a basic understanding in order to better comprehend the reference to the Twin CAT implementation explained in the following sub-chapters. 40 Version: 1.12.0 TF6701
## Page 41

Technical introduction Supported functions The Twin CAT Io T driver enables the use of the following TLS functions. Function Description Self-signed client certificates Use a self-signed client certificate to authenticate to the message broker. CA-signed client certificates Use of a CA-signed client certificate to authenticate to the message broker. The CA certificate can also be specified to establish a trust relationship. Certificate revocation lists Use of certificate revocation lists (CRL). Pre-Shared Key (PSK) Use of a pre-shared key (PSK) to authenticate to the message broker. Cipher suite definition A cipher suite is by definition a composition of algorithms (key exchange, authentication, encryption, MAC) for encryption. The client and server agree on these during the TLS connection establishment. For more information on cipher suites please refer to the relevant technical literature. TLS communication flow Communication with TLS encryption starts with a TLS handshake between server and client. During the handshake asymmetric cryptography is used; after successful completion of the handshake the server and client communicate based on symmetric cryptography, because this is many times faster than asymmetric cryptography. There are three different types of authentication for the TLS protocol: • The server identifies itself through a certificate (see Server certificate [} 43]) • The client and server identify themselves through a certificate (see Client/Server certificate [} 44]) • Pre-shared keys (see Pre-shared keys [} 44]) Please refer to the relevant technical literature for information about the advantages and disadvantages of the different authentication types. Exemplary explanation based on RSA All messages marked with * are optional, i.e. not mandatory. The following steps refer to the RSA procedure and are not generally valid for other procedures. The following table explains the individual steps from the communication flow shown above. TF6701 Version: 1.12.0 41
## Page 42

Technical introduction Step Description Client Hello The client initiates a connection to the server. The TLS version used, a random sequence of bytes (client random) and the cipher suites supported by the client are transmitted, among other parameters. Server Hello The server selects one of the cipher suites offered by the client and specifies it for the communication. If there is no intersection between the cipher suites supported by the client and server, the TLS connection establishment is aborted. In addition, the server also communicates a random sequence of bytes (server random). Certificate The server presents its certificate to the client to enable the client to verify that the server is the expected server. If the client does not trust the server certificate, the TLS connection establishment is aborted. The server certificate also contains the server's public key. Server Key Exchange For certain key exchange algorithms, the information from the certificate is not sufficient for the client to generate the so-called pre-master secret. In this case the missing information is transferred using Server Key Exchange. Certificate Request The server requests a certificate from the client to verify the identity of the client. Server Hello Done The server notifies the client that sending of the initial information is complete. Certificate The client communicates its certificate, including the public key, to the server. The procedure is the same as in the opposite direction: If the server does not trust the certificate sent by the client, the connection establishment is aborted. Client Key Exchange The client generates an encrypted pre-master secret and uses the server's public key to send the secret to the server using asymmetric encryption. This pre- master secret, the "server random" and the "client random" are then used to calculate the symmetric key that is used for communication after the connection has been established. Certificate Verify The client signs the previous handshake messages with its private key. Since the server has obtained the client's public key by sending the certificate, it can verify that the certificate presented really "belongs" to the client. Change Cipher Spec The client notifies the server that it is switching to symmetric cryptography. From here on every message from the client to the server is signed and encrypted. Finished The client notifies the server in encrypted form that the TLS connection establishment on its side is complete. The message contains a hash and a MAC relating the previous handshake messages. 42 Version: 1.12.0 TF6701
## Page 43

Technical introduction Step Description Change Cipher Spec The server decrypts the pre-master secret that the client encrypted with its public key. Since only the server has its private key, only the server can decrypt this pre-master secret. This ensures that the symmetric key is only known to the client and the server. The server then calculates the symmetric key from the pre-master secret and the two random sequences and notifies the client that it too is now communicating using symmetric cryptography. From here on every message from the server to the client is signed and encrypted. By generating the symmetric key, the server can decrypt the client's Finished message and verify both hash and MAC. If this verification fails, the connection is aborted. Finished The server notifies the client that the TLS connection establishment on its side is also finished. As with the client, the message contains a hash and a MAC relating to the previous handshake messages. On the client side, the same verification is then performed as on the server. Here too, if the hash and MAC are not successfully decrypted, the connection is aborted. Application Data Once the TLS connection establishment is complete, client and server communicate using symmetric cryptography. 4.6.1.1 Server certificate This section covers a situation where the client wants to verify the server certificate but the server does not want to verify the client certificate. In this case the communication flow described in chapter Transport layer [} 40] is shortened as follows. Verification of the server certificate The server certificate is verified on the client side. A check is performed to ascertain whether it is signed by a particular certificate authority. If this is not the case, the client aborts the connection, since it does not trust the server. Application in Twin CAT In Twin CAT, the file path to the CA certificate (. PEM or . DER file) or the content of the . PEM file is specified as a string. The certificate presented by the server is then checked in the Io T driver. If the certificate chain is not signed by the specified CA, the connection to the server is aborted. The following code illustrates the described connection parameters as an example. The sample code refers to the HTTP client, the MQTT client and the Web Socket client. The HTTP client is used as an example. TF6701 Version: 1.12.0 43
## Page 44

Technical introduction PROGRAM MAIN VAR fb Client : FB_Iot Http Client; END_VAR fb Client.st TLS.s CA:= 'C:\Twin CAT\3.1\Config\Certificates\some CA.pem'; If the user does not have the CA certificate, a connection can still be established. A boolean variable is available for this purpose, which prevents Twin CAT from verifying the server certificate. Although the connection is encrypted with the public key of the unverified server certificate, it is more vulnerable to man- in-the-middle attacks. fb Client.st TLS.s CA.b No Server Cert Check:= TRUE; 4.6.1.2 Client/Server certificate This section considers the case where both the client certificate and the server certificate are verified. The slightly modified communication flow (compared to the Server certificate [} 43] chapter) is visualized in the following diagram. The individual steps of the TLS connection establishment are described in chapter Transport layer [} 40]. Application in Twin CAT If a client certificate is used, in Twin CAT the file path (. PEM or . DER file) or the content of the . PEM file is passed as a string, just as for the CA certificate. Twin CAT as the client then presents this certificate to the server. For Certificate Verify the client's private key must also be referenced. Optionally, in the case of password protection for the private key, this password can also be transferred. The sample code refers to the HTTP client, the MQTT client and the Web Socket client. The HTTP client is used as an example. PROGRAM MAIN VAR fb Client : FB_Iot Http Client; END_VAR fb Client.st TLS.s CA:= 'C:\Twin CAT\3.1\Config\Certificates\some CA.pem'; fb Client.st TLS.s Cert:= 'C:\Twin CAT\3.1\Config\Certificates\some CRT.pem'; fb Client.st TLS.s Key File:= 'C:\Twin CAT\3.1\Config\Certificates\someprivatekey.pem.key'; fb Client.st TLS.s Key Pwd:= 'yourkeyfilepasswordhere'; If a client certificate is set, a CA certificate must also be set to validate the server certificate. This is due to the behavior of the security framework used in the Io T driver. If the validation of the server certificate is to be shutdown in this case, an additional flag can be set to skip the validation. However, it is not possible to omit the CA certificate. 4.6.1.3 Pre-shared keys By default, asymmetric key pairs are used for the TLS connection establishment. Asymmetric cryptography requires more computing power, so using Pre-Shared Keys (PSK) may be an option in situations where CPU power is limited. Pre-shared keys are previously shared symmetric keys. 44 Version: 1.12.0 TF6701
## Page 45

Technical introduction Compared to the communication flow with asymmetric encryption, the certificate is omitted when using PSK. Client and server must agree on a PSK via the so-called identity. By definition the PSK is known in advance to both parties. Server Key Exchange: In this optional message, the server can give the client a hint about the identity of the PSK used. Client Key Exchange: The client specifies the identity of the PSK to be used for encryption. Application in Twin CAT In Twin CAT the identity of the PSK is specified as a string; the PSK itself is stored as a byte array in the controller. The length of the PSK is also specified. The sample code refers to the HTTP client, the MQTT client and the Web Socket client. The HTTP client is used as an example. PROGRAM MAIN VAR fb Client : FB_Iot Http Client; c My Psk Key : ARRAY[1..64] OF BYTE := [16#1B, 16#D0, 16#6F, 16#D2, 16#56, 16#16, 16#7D, 16#C1, 16# E8, 16#C7, 16#48, 16#2A, 16#8E, 16#F5, 16#FF]; END_VAR fb Client.st TLS.s Psk Identity:= identityof PSK'; fb Client.st TLS.a Psk Key:= c My Psk Key; fb Client.st TLS.n Psk Key Len:= 15; 4.6.1.4 Supported cipher suites The Twin CAT Io T driver supports secure data transmission using the TLS standard. Below you will find an overview of all cipher suites supported by the Io T driver, depending on the Twin CAT version. TF6701 Version: 1.12.0 45
## Page 46

Technical introduction Twin CAT 3.1 Build 4024.x Cipher suite AES128-GCM-SHA256 AES128-SHA AES128-SHA256 AES256-SHA AES256-SHA256 DES-CBC3-SHA DHE-RSA-AES128-GCM-SHA256 DHE-RSA-AES128-SHA DHE-RSA-AES128-SHA256 DHE-RSA-AES256-SHA DHE-RSA-AES256-SHA256 ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES128-SHA256 ECDHE-ECDSA-AES256-SHA ECDHE-ECDSA-DES-CBC3-SHA ECDHE-RSA-AES128-GCM-SHA256 ECDHE-RSA-AES128-SHA ECDHE-RSA-AES128-SHA256 ECDHE-RSA-AES256-SHA ECDHE-RSA-DES-CBC3-SHA EDH-RSA-DES-CBC3-SHA PSK-3DES-EDE-CBC-SHA PSK-AES128-CBC-SHA PSK-AES128-CBC-SHA256 PSK-AES128-GCM-SHA256 PSK-AES256-CBC-SHA 46 Version: 1.12.0 TF6701
## Page 47

Technical introduction Twin CAT 3.1 Build 4026.x Cipher suite AES128-GCM-SHA256 AES128-SHA AES128-SHA256 AES256-GCM-SHA384 AES256-SHA AES256-SHA256 DHE-RSA-AES128-GCM-SHA256 DHE-RSA-AES128-SHA DHE-RSA-AES128-SHA256 DHE-RSA-AES256-GCM-SHA384 DHE-RSA-AES256-SHA DHE-RSA-AES256-SHA256 ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES128-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-ECDSA-AES256-SHA ECDHE-ECDSA-AES256-SHA384 ECDHE-RSA-AES128-GCM-SHA256 ECDHE-RSA-AES128-SHA ECDHE-RSA-AES128-SHA256 ECDHE-RSA-AES256-GCM-SHA384 ECDHE-RSA-AES256-SHA ECDHE-RSA-AES256-SHA384 PSK-AES128-CBC-SHA PSK-AES128-CBC-SHA256 PSK-AES128-GCM-SHA256 PSK-AES256-CBC-SHA PSK-AES256-CBC-SHA384 PSK-AES256-GCM-SHA384 4.6.2 Application level User identity The MQTT specification only defines a user name/password authentication at the application layer, which can be done when establishing a connection. Other mechanisms are not specified and can be handled applicatively. Some message brokers also allow the Common Name attribute from the client certificate to be used as a user identity, which then allows access rights to be defined at topic level, for example. JSON Web Token (JWT) JSON Web Token (JWT) is an open standard (based on RFC 7519) that defines a compact and self- describing format for securely transmitting information between communication devices in the form of a JSON object. The authenticity of the transmitted information can be verified and ensured, since a JWT is provided with a digital signature. The signature can involve a shared secret (via an HMAC algorithm) or a public/private key (via RSA). TF6701 Version: 1.12.0 47
## Page 48

Technical introduction The most common application example for JWT is the authorization of a device or user for a service. Once a user has logged into the service, all further requests to the service include the JWT. Based on the JWT, the service can then decide which additional services or resources the user may access. This means, for example, that single sign-on solutions can be implemented in cloud services. The PLC library Tc3_Json Xml provides an option to create and sign a JSON Web Token via the method FB_Jwt Encode. The token can then be sent, for example, in the payload of the message or also in a User Property [} 34] to enable validation of the message at the receiving application. 4.7 Re-parameterization In certain cases, it may be necessary to re-parameterize the MQTT client during operation by means of an online change. This new parameterization can either take place automatically in the program sequence or be triggered manually if required. This depends on the implementation. Example use cases for a re-parameterization: replacement of a token that is about to expire, certificates that need to be renewed or a changed IP address of the MQTT broker. The following section describes the procedure for re-parameterization of a connected MQTT client. In order for the Twin CAT MQTT client to be connected to a message broker, the Execute [} 57] method must be called cyclically in the background (see FB_Iot Mqtt Client [} 55]). When the program starts, the parameterization of the MQTT client instance is carried out first by calling this method, after which a connection to the broker is established. In order to carry out a re-parameterization, the call of the Execute [} 57] method must be negated, the parameters must then be reset and the call must then take place again as usual. The following code snippet shows a simple re-parameterization using a trigger. fb Mqtt Client. Execute(b Connect); IF b Reset THEN b Connect:=FALSE; fb Mqtt Client. Client Id:= 'My Tc Mqtt Client35'; fb Mqtt Client.s Host Name:= '192.168.35.35'; b Reset:=FALSE; ELSE b Connect:=TRUE; END_IF The call of the Execute method is negated by the trigger variable b Reset, so that the parameters for the client ID and the host name can be reset afterwards. Once the trigger variable is set to FALSE again, the execute method is called cyclically again. 4.8 I/O device In addition to the Tc3_Iot Base PLC library, the Io T MQTT Controller and Io T MQTT Device provide two I/O devices that can be used to establish an MQTT-based communication connection between two Twin CAT systems. Alternatively, an EK9160 Io T coupler can also be integrated into this type of communication. 48 Version: 1.12.0 TF6701
## Page 49

Technical introduction The two device types can be added via the corresponding dialog in the Twin CAT I/O area and are located there within the Ethernet category. For an Io T MQTT Device, symbol information for all configured variables in the process image is stored on the message broker in a specific topic as a Retain [} 32] message. An Io T MQTT controller then has the ability to scan this symbol information and create matching variables in its own process image. The EK9160 is automatically always an Io T MQTT Device. Data format The data format for this type of MQTT communication must be set to "Binary". TF6701 Version: 1.12.0 49
## Page 50

Technical introduction EK9160 configuration The EK9160 is automatically configured as an Io T MQTT Device in the background as soon as the device is configured to connect to a message broker. As a prerequisite, "Binary" must be selected as the data format and retain messages must be activated. The following screenshot shows the corresponding section of the EK9160 configuration web page. All I/O terminals have been activated for the communication connection with the message broker. The following screenshot shows an example of this process on the configuration interface. 50 Version: 1.12.0 TF6701
## Page 51

Technical introduction Twin CAT as Io T MQTT Device In addition to the EK9160, a Twin CAT system can also be configured as an Io T MQTT Device. In this case, the corresponding configuration steps must be carried out manually via the Twin CAT I/O area. The Io T MQTT Device then behaves in the same way as the EK9160. Configuration in Twin CAT In order for Twin CAT to be able to process the symbol information and process values from the EK9160, an Io T MQTT Controller must be created in the I/O area of Twin CAT and configured for the connection with the message broker. It is important that the fields Main Topic, Device and Stream match the configuration of the EK9160. The following screenshot illustrates this process. TF6701 Version: 1.12.0 51
## Page 52

Technical introduction Publishers and Subscribers can then be created below the Io T MQTT controller, depending on whether you want to scan the output or input terminals. Input terminals are operated via the Publisher and output terminals via the Subscriber. 52 Version: 1.12.0 TF6701
## Page 53

Technical introduction Subsequently, the symbol information can be read out via a scan mechanism and corresponding input/output variables can be automatically created in the process image of the device. Result (taking the subscriber as an example): TF6701 Version: 1.12.0 53
## Page 54

Technical introduction Further Information After the configuration has been activated on the EK9160, three topics below the configured Main Topic are used on the message broker: 1. The Symbol Topic contains the symbol information for the connected I/O terminals and is filled by the EK9160 after the communication connection with the message broker has been established. 2. The Description Topic contains general status information about the device and is filled by the EK9160 after the communication connection with the message broker has been established. 3. The Data Topic contains the pure process data of the connected I/O terminals. This topic is thus cyclically filled with data by the EK9160. The following screenshot shows a section of the Mosquitto Message Broker in verbose mode, on which you can see the individual publishes of the EK9160 on the above-mentioned topics. 4.9 Exponential backoff A feature referred to as "exponential backoff" can be used to avoid burdening the message broker with unnecessary connection requests in case of a connection error. In the event of a TLS connection error involving the message broker, the reconnect rate is adjusted multiplicatively. This function can be activated using the Activate Exponential Backoff() [} 61] method. The parameters of the method specify the minimum and maximum time for the algorithm. The minimum time describes the initial delay value for the new connection attempt. The maximum time describes the highest delay value. The delay values are doubled until the maximum value is reached. Once a connection has been established, the backoff rate is reset to the original value. The Deactivate Exponential Backoff() [} 62] method can be used to deactivate this function programmatically. 54 Version: 1.12.0 TF6701
## Page 55

PLC API 5 PLC API 5.1 Tc3_Iot Base 5.1.1 MQTT3 The following function blocks and structures are implemented for MQTT in version 3.1.1. The implementations for MQTT in version 5 can be found at MQTT5 [} 69]. 5.1.1.1 FB_Iot Mqtt Client The function block enables communication to a message broker based on MQTT version 3.1.1. A client function block is responsible for the connection to precisely one broker. The Execute() [} 57] method of the function block must be called cyclically in order to ensure the background communication with this broker and facilitate receiving of messages. All connection parameters exist as input parameters and are evaluated when a connection is established. Syntax Definition: FUNCTION_BLOCK FB_Iot Mqtt Client VAR_INPUT s Client Id : STRING(255); // default is generated during initialization s Host Name : STRING(255) := '127.0.0.1'; // default is local host n Host Port : UINT := 1883; // default is 1883 s Topic Prefix : STRING(255); // topic prefix for pub and sub of this client (handled inte rnally) n Keep Alive : UINT := 60; // in seconds s User Name : STRING(255); // optional parameter s User Password : STRING(255); // optional parameter st Will : ST_Iot Mqtt Will; // optional parameter st TLS : ST_Iot Mqtt Tls; // optional parameter ip Message Queue : I_Iot Mqtt Message Queue; // if received messages should be queued during call o f Execute() END_VAR VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; e Connection State : ETc Iot Mqtt Client State; b Connected : BOOL; // TRUE if connection to host is established END_VAR TF6701 Version: 1.12.0 55
## Page 56

PLC API Inputs Name Type Description s Client Id STRING(255) The client ID can be specified individually and must be unique for most message brokers. If not specified, an ID based on the PLC project name is automatically generated by the Twin CAT driver. s Host Name STRING(255) s Host Name can be specified as name or as IP address. If no information is provided, the local host is used. n Host Port UINT The host port is specified here. The default is 1883. s Topic Prefix STRING(255) Here you can specify a topic prefix that will be added automatically for all publish and subscribe commands. n Keep Alive UINT Here you can specify the watchdog time (in seconds), with which the connection between client and broker is monitored. s User Name STRING(255) Optionally, a user name can be specified. s User Password STRING(255) A password for the user name can be entered here. st Will ST_Iot Mqtt Will [} 62] If the client is disconnected from the broker irregularly, a last preconfigured message can optionally be sent from the broker to the so-called “will topic”. This message is specified here. st TLS ST_Iot Mqtt Tls [} 63] If the broker offers a TLS-secured connection, the required configuration can be implemented here. ip Message Queue I_Iot Mqtt Message Queue An instance of FB_Iot Mqtt Message Queue [} 64] can optionally be assigned here. This input parameter can be used for storing incoming new messages in the message queue without implementing the callback method. (See also Iot Mqtt Sample Using Queue [} 312]) If you want to evaluate incoming new messages without a message queue by implementing the callback method yourself, this input parameter is not needed. (See also Iot Mqtt Sample Using Callback [} 314]) No message queue is used if the callback method is used or overwritten, irrespective of whether ip Message Queue was set. Outputs Name Type Description b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes can be found in the Appendix. e Connection State ETc Iot Mqtt Client State Indicates the state of the connection between client and broker as enumeration ETc Iot Mqtt Client State. [} 109] b Connected BOOL This output is TRUE if a connection exists between client and broker. 56 Version: 1.12.0 TF6701
## Page 57

PLC API Methods Name Description Execute [} 57] Method for background communication with the Twin CAT driver. The method must be called cyclically. Publish [} 58] Method for executing a publish operation to a MQTT message broker. Subscribe [} 59] Method for establishing a subscription. Unsubscribe [} 60] Method for removing a subscription. Activate Exponential Backoff Activates the exponential backoff [} 54] function [} 61] Deactivate Exponential Backof Deactivates the exponential backoff [} 54] function f [} 62] Get Time Since Last Broker Mes Method for querying the time (in ms) since the last message from the message broker. sage [} 62] Event-driven methods (callback methods) Name Description On Mqtt Message [} 60] Callback method used by the Twin CAT driver when a subscription to a topic was established and incoming messages are received. Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base 5.1.1.1.1 Execute This method must be called cyclically in order to ensure the background communication with the MQTT broker. TF6701 Version: 1.12.0 57
## Page 58

PLC API Syntax METHOD Execute VAR_INPUT b Connect : BOOL; END_VAR Inputs Name Type Description b Connect BOOL The connection to the broker is established when b Connect is set to TRUE. b Connect must remain set to maintain the connection. Any errors are reported at the outputs b Error, hr Error Code and e Connection State of the function block instance. 5.1.1.1.2 Publish This method is called once, in order to send a message to the broker. Syntax METHOD Publish : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case sensitive) END_VAR VAR_INPUT p Payload : PVOID; n Payload Size : UDINT; e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker b Retain : BOOL; // if TRUE the broker stores the message in order to send it to new subscri bers b Queue : BOOL; // for future extension END_VAR Return value Name Type Description Publish BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description s Topic STRING Topic of the MQTT message p Payload PVOID Address for the payload of the MQTT message n Payload Size UDINT Size of the payload in bytes e Qo S Tc Iot Mqtt Qos "Quality of Service" b Retain BOOL If b Retain is TRUE, the broker stores the message in order to make it available to subsequent subscribers. b Queue BOOL Reserved parameter that can always be given the value FALSE. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. 58 Version: 1.12.0 TF6701
## Page 59

PLC API Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. 5.1.1.1.3 Subscribe This method is used by the client to signal to the broker that it wants to receive all MQTT message with a particular topic. The method can subscribe an MQTT client instance to multiple topics. Syntax METHOD Subscribe : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case sensitive) END_VAR VAR_INPUT e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker END_VAR Return value Name Type Description Subscribe BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description e Qo S Tc Iot Mqtt Qos "Quality of Service" Inputs/outputs Name Type Description s Topic STRING Topic of the MQTT message Possible errors are output at the outputs b Error and hr Error Code of the function block instance. TF6701 Version: 1.12.0 59
## Page 60

PLC API 5.1.1.1.4 Unsubscribe This method is used by the client to signal to the broker that no further messages with the specified topic should be transferred to it. Syntax METHOD Unsubscribe : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case sensitive) END_VAR Return value Name Type Description Unsubscribe BOOL The method returns the return value TRUE if the call was successful. Inputs/outputs Name Type Description s Topic STRING Topic for which no further messages should be received. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. 5.1.1.1.5 On Mqtt Message Callback method This method must not be called by the user. Instead, the function block FB_Iot Mqtt Client can be used to derive information and overwrite this method. While the Execute() method is called, the responsible Twin CAT driver can call the On Mqtt Message() method in the event of new incoming messages. In the event of several incoming messages the callback method is called several times, once per message. This must be taken into account when the method is implemented. The use of the callback method is also explained in the sample Iot Mqtt Sample Using Callback [} 314]. Syntax METHOD On Mqtt Message : HRESULT VAR_IN_OUT CONSTANT topic : STRING; END_VAR VAR_INPUT payload : PVOID; length : UDINT; qos : Tc Iot Mqtt Qos; repeated : BOOL; END_VAR 60 Version: 1.12.0 TF6701
## Page 61

PLC API Return value Name Type Description On Mqtt Message HRESULT The return value of the method should be S_OK, if the message was accepted. If the message is to be issued again in the context of the next Execute() call, the return value can be assigned S_FALSE. Inputs Name Type Description payload PVOID Address for the payload of the received MQTT message length UDINT Size of the payload in bytes qos Tc Iot Mqtt Qos "Quality of Service" repeated BOOL If the user did not respond with S_OK to the last On Mqtt Message() method call, the message is issued again in the context of the next Execute() call, and the parameter repeated is set. This indicates that the message was issued more than once. Inputs/outputs Name Type Description Topic STRING Topic of the received MQTT message 5.1.1.1.6 Activate Exponential Backoff A feature referred to as "exponential backoff" can be used to avoid burdening the message broker with unnecessary connection requests in case of a connection error. In the event of a TLS connection error involving the message broker, the reconnect rate is adjusted multiplicatively. This function can be activated using the Activate Exponential Backoff() [} 61] method. The parameters of the method specify the minimum and maximum time for the algorithm. The minimum time describes the initial delay value for the new connection attempt. The maximum time describes the highest delay value. The delay values are doubled until the maximum value is reached. Once a connection has been established, the backoff rate is reset to the original value. The Deactivate Exponential Backoff() [} 62] method can be used to deactivate this function programmatically. Syntax METHOD Activate Exponential Backoff VAR_INPUT t Mqtt Backoff Min Time: TIME; t Mqtt Backoff Max Time: TIME; END_VAR Inputs Name Type Description t Mqtt Backoff Min TIME Describes the initial delay value for the new connection attempt. Time t Mqtt Backoff Max TIME Describes the largest delay value. Once this value has been reached, all new Time connection attempts are made at these intervals. TF6701 Version: 1.12.0 61
## Page 62

PLC API 5.1.1.1.7 Deactivate Exponential Backoff A feature referred to as "exponential backoff" can be used to avoid burdening the message broker with unnecessary connection requests in case of a connection error. In the event of a TLS connection error involving the message broker, the reconnect rate is adjusted multiplicatively. This function can be activated using the Activate Exponential Backoff() [} 61] method. The parameters of the method specify the minimum and maximum time for the algorithm. The minimum time describes the initial delay value for the new connection attempt. The maximum time describes the highest delay value. The delay values are doubled until the maximum value is reached. Once a connection has been established, the backoff rate is reset to the original value. The Deactivate Exponential Backoff() [} 62] method can be used to deactivate this function programmatically. Syntax METHOD Deactivate Exponential Backoff 5.1.1.1.8 Get Time Since Last Broker Message This method specifies the time (in ms) since the last message from the message broker. The time is reset to 0 with every new message from the message broker. It does not matter whether these are ping messages or regular publish/subscribe messages. The MQTT specification defines that an MQTT client itself determines the time after which it will accept a timeout in the direction of the message broker. This is possible with this method from the PLC. The keep alive time, on the other hand, specifies the time (multiplied by 1.5) after which the message broker assumes a client time-out if there are no messages from the client. Syntax METHOD Get Time Since Last Broker Message : UDINT Return value Name Type Description Get Time Sinc UDINT The time in milliseconds since the last message from the message broker. e Last Broker Message 5.1.1.2 ST_Iot Mqtt Will By means of the following specifications, a message can be specified which, in case of an irregular disconnection between client and broker, is sent as the last message from the broker to the subscribers who have subscribed to the corresponding topic. Syntax Definition: TYPE ST_Iot Mqtt Will : STRUCT {attribute 'Tc Encoding':='UTF-8'} s Topic : STRING(255); // topic string (UTF-8) (attend that MQTT topics are case sensitive ) p Payload : PVOID; n Payload Size : UDINT; e Qo S : Tc Iot Mqtt Qos := Tc Iot Mqtt Qos. Exactly Once Delivery; // quality of service between the publishing client and the broker b Retain : BOOL; // if TRUE the broker stores the message in order to send it to new subscr 62 Version: 1.12.0 TF6701
## Page 63

PLC API ibers END_STRUCT END_TYPE Parameter Name Type Description s Topic STRING(255) Message topic p Payload PVOID Address for the payload of the message n Payload Size UDINT Size of the payload in bytes e Qo S Tc Iot Mqtt Qos The “Quality of Service” parameter offers the following setting options: Qo S level 0, Qo S level 1, Qo S level 2 (see Qo S) b Retain BOOL If b Retain is TRUE, the broker stores the message in order to make it available to subsequent subscribers. Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. 5.1.1.3 ST_Iot Mqtt TLS TLS security setting for the MQTT client. Either CA (certificate authority) or PSK (Pre Shared Key) can be used. Syntax Definition: TYPE ST_Iot Mqtt Tls : STRUCT s CA : STRING(255); // certificate authority as filename (PEM or DER format) or as string (PEM) s CAPath : STRING(255); // for future use s Cert : STRING(255); // client certificate as filename (PEM or DER format) or as st ring (PEM) s Key File : STRING(255); s Key Pwd : STRING(255); s Crl : STRING(255); // Certificate Revocation List as filename (PEM or DER format) or as string (PEM) s Ciphers : STRING(255); s Version : STRING(80) := 'tlsv1.2'; // TLS version b No Server Cert Check : BOOL := FALSE; s Psk Identity : STRING(255); a Psk Key : ARRAY[1..64] OF BYTE; n Psk Key Len : USINT; s Azure Sas : STRING(511); END_STRUCT END_TYPE TF6701 Version: 1.12.0 63
## Page 64

PLC API Parameters Name Type Description s CA STRING(255) Certificate of the certificate authority (CA) s Cert STRING(255) Client certificate to be used for authentication at the broker s Key File STRING(255) Private key of the client s Key Pwd STRING(255) Password of the private key, if applicable s Crl STRING(255) Path to the certificate revocation list, which may be present in PEM or DER format s Ciphers STRING(255) Cipher suites to be used, specified in Open SSL string format s Version STRING(80) TLS version to be used b No Server Cert Check BOOL Disables verification of the server certificate validity. If communication is to take place without TLS encryption, this value must remain FALSE. s Psk Identity STRING(255) Pre Shared Key identity for TLS PSK connection a Psk Key ARRAY[1..64] OF BYTE Pre Shared Key for TLS PSK connection n Psk Key Len USINT Length of the Pre Shared Key in bytes s Azure SAS STRING(511) SAS token for connection to the Microsoft Azure Io T Hub 5.1.1.4 FB_Iot Mqtt Message Queue This function block provides a message queue for MQTT messages, which can be used with the FB_Iot Mqtt Client [} 55] function block. To this end an instance is declared and transferred at the input of FB_Iot Mqtt Client. The function block operates based on the first in, first out principle (FIFO). It is possible that multiple MQTT messages are received within one PLC cycle and made available at the message queue. During the program sequence, the property n Queued Messages can be used to check whether and how many messages have been collected in the message queue. The Dequeue() method is used for removing messages from the FIFO queue. The oldest message is output first. Size of the MQTT message queue The maximum number of possible messages in the queue can be set via the parameter c Max Entries In Mqtt Message Queue in the parameter list [} 111] of the Tc3_Iot Base library. The default value is 1000 messages. This value can usually be left unchanged, since prompt message processing is required in most cases. The MQTT message queue allocates new memory space for new messages according to the topic and payload size. By default the maximum size of a message is limited to 100 k B, the size of the MQTT message queue is limited to 1000 k B. For special cases these values can also be adjusted in the parameter list [} 111]. 64 Version: 1.12.0 TF6701
## Page 65

PLC API Properties Name Type Access Description b Overwrit BOOL Get, Set Here you can parameterize whether, e Oldest En when the queue is full, a newly received try message should overwrite the oldest message. If yes (TRUE), the oldest message is lost. If no (FALSE), the latest message is lost. A full queue is an unlikely case if the user ensures a speedy readout of the queue using the Dequeue() method. n Queued UDINT Get Outputs the number of MQTT messages Messages currently collected in the queue. Methods Name Description Dequeue() [} 65] Removes an MQTT message from the queue. Reset Queue() [} 66] Deletes all messages from the queue. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base 5.1.1.4.1 Dequeue The method returns the return value TRUE if the removal of an MQTT message from the queue was successful. The number of MQTT messages currently in the queue (n Queued Messages property) is reduced by one through the removal of a message. Syntax METHOD Dequeue : BOOL VAR_INPUT fb Message : REFERENCE TO FB_Iot Mqtt Message; END_VAR Return value Name Type Description Dequeue BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description fb Message REFERENCE TO FB_Iot Mqtt Me For the message itself the reference is transferred to an ssage instance of type FB_Iot Mqtt Message [} 66]. TF6701 Version: 1.12.0 65
## Page 66

PLC API 5.1.1.4.2 Reset Queue When this method is called, all accumulated MQTT messages are deleted from the queue. Syntax METHOD Reset Queue : BOOL Return value Name Type Description Reset Queue BOOL The method returns the return value TRUE if the call was successful. 5.1.1.5 FB_Iot Mqtt Message If the Twint CAT MQTT client (FB_Iot Mqtt Client [} 55]) is used in combination with a message queue (FB_Iot Mqtt Message Queue [} 64]), an MQTT message is represented by the function block FB_Iot Mqtt Message. Incoming messages are collected by the message queue and made available to the user in the form of a such a function block instance. The topic, the payload size and the "Quality of Service" parameter of the MQTT message are immediately available as Properties at the function block output. The topic and the payload can easily be evaluated or copied via the provided methods Compare Topic(), Get Topic() and Get Payload(). Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Size of an MQTT message The maximum size of an MQTT message to be received in the PLC depends on the hardware platform and should not exceed a few MB, even on higher-performance/larger platforms. The maximum possible size of a message can be set using the c Max Size Of Mqtt Message parameter in the parameter list [} 111] of the Tc3_Iot Base library. By default, the message size is limited to 100 k B. When using the MQTT Message Queue, it dynamically allocates new memory from the Twin CAT Router memory for new messages. Properties Name Type Access Description e Qo S Tc Iot Mqtt Q Get "Quality of Service" of the MQTT os message n Payload UDINT Get Size of the payload in bytes Size n Topic Siz UINT Get Size of the topic in bytes e 66 Version: 1.12.0 TF6701
## Page 67

PLC API Methods Name Description Compare Topic() [} 67] Compares a specified topic with the topic in the MQTT message Get Topic() [} 68] Returns the topic of an MQTT message Get Payload() [} 68] Returns the content of an MQTT message Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base 5.1.1.5.1 Compare Topic This method returns TRUE, if the specified topic is identical to the topic of the MQTT message in the function block. Syntax METHOD Compare Topic : BOOL VAR_IN_OUT CONSTANT s Topic : STRING; // topic string with any length (attend that MQTT topics are case sensitive) END_VAR Return value Name Type Description Compare To BOOL Is TRUE, if the specified topic is identical to the topic of the MQTT message in the pic function block. Inputs/outputs Name Type Description s Topic STRING TF6701 Version: 1.12.0 67
## Page 68

PLC API 5.1.1.5.2 Get Topic Syntax METHOD Get Topic : BOOL VAR_INPUT p Topic : POINTER TO STRING; // topic buffer n Topic Size : UINT; // maximum size of topic buffer in bytes END_VAR Return value Name Type Description Get Topic BOOL Inputs Name Type Description p Topic POINTER TO The memory address for the buffer into which the topic is to be copied is STRING specified here. n Topic Size UINT The maximum available buffer size (in bytes) is specified here. 5.1.1.5.3 Get Payload Syntax METHOD Get Payload : BOOL VAR_INPUT p Payload : PVOID; // payload buffer n Payload Size : UDINT; // maximum size of payload buffer in bytes b Set Null Termination: BOOL; // The publisher specifies the kind of payload. If it is a string, it could be null terminated or not. Setting this input to TRUE will force a null termination. One more byte is required for that. END_VAR Return value Name Type Description Get Payload BOOL 68 Version: 1.12.0 TF6701
## Page 69

PLC API Inputs Name Type Description p Payload PVOID The memory address for the buffer into which the payload is to be copied is specified here. n Payload Size UDINT The maximum available buffer size (in bytes) is specified here. b Set Null Termination BOOL If the payload type requires null termination (string), this can be implemented during the copy process. This is not necessary if the message source (publisher) has already implemented a null termination and this was taken into account in the payload size specification. In many cases no reliable information is available. 5.1.2 MQTT5 The following function blocks and structures are implemented for MQTT in version 5. 5.1.2.1 FB_Iot Mqtt5Client The function block enables communication to a message broker based on MQTT version 5.0. A client function block is responsible for the connection to precisely one broker. The Execute() method of the function block must be called cyclically in order to ensure the background communication with this broker and facilitate receiving of messages. All connection parameters exist as input parameters and are evaluated when a connection is established. Use the FB_Iot Mqtt5Client, if you do not want to implement callback methods yourself and incoming new messages should be provided in the message queue available at the output. Use the FB_Iot Mqtt5Client Base if you want to implement the callback methods (On Mqtt5Message() and others) yourself. Syntax Definition: FUNCTION_BLOCK FB_Iot Mqtt5Client VAR_INPUT {attribute 'Tc Encoding':='UTF-8'} s Client Id : STRING(255); // default is generated during initialization {attribute 'Tc Encoding':='UTF-8'} s Host Name : STRING(255) := '127.0.0.1'; // default is local host n Host Port : UINT := 1883; // default is 1883 {attribute 'Tc Encoding':='UTF-8'} s Topic Prefix : STRING(255); // topic prefix for pub and sub of this client (handled i nternally) n Keep Alive : UINT := 60; // in seconds {attribute 'Tc Encoding':='UTF-8'} s User Name : STRING(255); // optional parameter {attribute 'Tc Encoding':='UTF-8'} s User Password : STRING(255); // optional parameter st Will : ST_Iot Mqtt5Will; // optional parameter st TLS : ST_Iot Mqtt5Tls; // optional parameter st Auth : ST_Iot Mqtt5Auth; // optional parameter st Connect : ST_Iot Mqtt5Connect; // optional parameter END_VAR VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; e Connection State : ETc Iot Mqtt Client State; b Connected : BOOL; // TRUE if connection to host is established fb Message Queue : FB_Iot Mqtt5Message Queue; // received messages are queued during call of Execute() fb Conn Ack Props : FB_Iot Mqtt5Conn Ack Properties; // info is set when a connection is acknowledged fb Disconnect Props : FB_Iot Mqtt5Disconnect Properties; // info is set after disconnection END_VAR TF6701 Version: 1.12.0 69
## Page 70

PLC API Inputs Name Type Description s Client Id STRING(255) The client ID can be specified individually and must be unique for most message brokers. If not specified, an ID based on the PLC project name is automatically generated by the Twin CAT driver. s Host Name STRING(255) s Host Name can be specified as name or as IP address. If no information is provided, the local host is used. n Host Port UINT The host port is specified here. The default is 1883. s Topic Prefix STRING(255) Here you can specify a topic prefix that will be added automatically for all publish and subscribe commands. n Keep Alive UINT Here you can specify the watchdog time (in seconds), with which the connection between client and broker is monitored. s User Name STRING(255) Optionally, a user name can be specified. s User Password STRING(255) A password for the user name can be entered here. st Will ST_Iot Mqtt5Will [} 91] If the client is disconnected from the broker irregularly, a last preconfigured message can optionally be sent from the broker to the so-called “will topic”. This message is specified here. st TLS ST_Iot Mqtt5Tls [} 92] If the broker offers a TLS-secured connection, the required configuration can be implemented here. st Auth ST_Iot Mqtt5Auth [} 93] This structure can be used to pass extended authentication information to the message broker. st Connect ST_Iot Mqtt5Connect This structure can be used to pass advanced connection settings to the message broker. [} 93] Outputs Name Type Description b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes can be found in the Appendix. e Connection State ETc Iot Mqtt Client State Indicates the state of the connection between client and broker as enumeration ETc Iot Mqtt Client State. [} 109] b Connected BOOL This output is TRUE if a connection exists between client and broker. fb Message Queue FB_Iot Mqtt5Message Que The message queue of the received messages is provided at the output. This output can be accessed directly to work ue [} 94] with the message queue. fb Conn Ack Props FB_Iot Mqtt5Conn Ack Pro If the client has received Conn Ack Properties from the message broker, they are displayed here. perties [} 100] fb Disconnect Props FB_Iot Mqtt5Disconnect Pr If the client has received Disconnect Properties from the message broker, they are displayed here. operties [} 103] 70 Version: 1.12.0 TF6701
## Page 71

PLC API Methods Name Description Execute [} 71] Method for background communication with the Twin CAT driver. The method must be called cyclically. Publish [} 72] Method for executing a publish operation to a MQTT message broker. Request [} 76] This can be used to send a request as part of the request/response procedure of MQTTv5. Response [} 77] This can be used to send a response as part of the request/response procedure of MQTTv5. Subscribe [} 73] Method for establishing a subscription. Unsubscribe [} 74] Method for removing a subscription. Activate Exponential Backoff Activates the exponential backoff [} 54] function [} 75] Deactivate Exponential Backof Deactivates the exponential backoff [} 54] function f [} 75] Get Time Since Last Broker Mes Method for querying the time (in ms) since the last message from the message broker. sage [} 78] Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) 5.1.2.1.1 Execute This method must be called cyclically in order to ensure the background communication with the MQTT broker. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. TF6701 Version: 1.12.0 71
## Page 72

PLC API Syntax METHOD Execute VAR_INPUT b Connect : BOOL; END_VAR Inputs Name Type Description b Connect BOOL The connection to the broker is established when b Connect is set to TRUE. b Connect must remain set to maintain the connection. 5.1.2.1.2 Publish This method is called once, in order to send a message to the broker. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Publish : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case sensitive) END_VAR VAR_INPUT p Payload : PVOID; n Payload Size : UDINT; e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker b Retain : BOOL; // if TRUE the broker stores the message in order to send it to new subscri bers b Queue : BOOL; // for future extension p Props : POINTER TO Mqtt Publish Properties; // optional END_VAR Return value Name Type Description Publish BOOL The method returns the return value TRUE if the call was successful. 72 Version: 1.12.0 TF6701
## Page 73

PLC API Inputs Name Type Description p Payload PVOID Address for the payload of the MQTT message n Payload Size UDINT Size of the payload in bytes e Qo S Tc Iot Mqtt Qos "Quality of Service" b Retain BOOL If b Retain is TRUE, the broker stores the message in order to make it available to subsequent subscribers. b Queue BOOL Reserved parameter that can always be given the value FALSE. p Props POINTER TO Pointer to Publish properties to be sent. Mqtt Publish P The parameter is optional. The FB_Iot Mqtt5Publish Properties [} 104] can be roperties used to specify Publish properties. Inputs/outputs Name Type Description s Topic STRING Topic of the MQTT message Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. 5.1.2.1.3 Subscribe This method is used by the client to signal to the broker that it wants to receive all MQTT message with a particular topic. The method can subscribe an MQTT client instance to multiple topics. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Subscribe : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case se nsitive) END_VAR VAR_INPUT e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker p Props : POINTER TO Mqtt Subscribe Properties; // optional END_VAR TF6701 Version: 1.12.0 73
## Page 74

PLC API Return value Name Type Description Subscribe BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description e Qo S Tc Iot Mqtt Qos "Quality of Service" p Props POINTER TO Pointer to Subscribe properties to be sent. Mqtt Subscribe Properties The parameter is optional. The FB_Iot Mqtt5Subscribe Properties [} 106] can be used to specify Subscribe properties. Inputs/outputs Name Type Description s Topic STRING Topic of the MQTT message 5.1.2.1.4 Unsubscribe This method is used by the client to signal to the broker that no further messages with the specified topic should be transferred to it. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Unsubscribe : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case se nsitive) END_VAR VAR_INPUT p Props : POINTER TO Mqtt Unsubscribe Properties; // optional END_VAR Return value Name Type Description Unsubscribe BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description p Props POINTER TO Pointer to Unsubscribe properties to be sent. Mqtt Unsubscribe Properties The parameter is optional. The FB_Iot Mqtt5Unsubscribe Properties [} 107] can be used to specify Unsubscribe properties. 74 Version: 1.12.0 TF6701
## Page 75

PLC API Inputs/outputs Name Type Description s Topic STRING Topic for which no further messages should be received. 5.1.2.1.5 Activate Exponential Backoff A feature referred to as "exponential backoff" can be used to avoid burdening the message broker with unnecessary connection requests in case of a connection error. In the event of a TLS connection error involving the message broker, the reconnect rate is adjusted multiplicatively. This function can be activated using the Activate Exponential Backoff() [} 61] method. The parameters of the method specify the minimum and maximum time for the algorithm. The minimum time describes the initial delay value for the new connection attempt. The maximum time describes the highest delay value. The delay values are doubled until the maximum value is reached. Once a connection has been established, the backoff rate is reset to the original value. The Deactivate Exponential Backoff() [} 62] method can be used to deactivate this function programmatically. Syntax METHOD Activate Exponential Backoff VAR_INPUT t Mqtt Backoff Min Time: TIME; t Mqtt Backoff Max Time: TIME; END_VAR Inputs Name Type Description t Mqtt Backoff TIME Describes the initial delay value for the new connection attempt. Min Time t Mqtt Backoff TIME Describes the largest delay value. Once this value has been reached, all new Max Time connection attempts are made at these intervals. 5.1.2.1.6 Deactivate Exponential Backoff A feature referred to as "exponential backoff" can be used to avoid burdening the message broker with unnecessary connection requests in case of a connection error. In the event of a TLS connection error involving the message broker, the reconnect rate is adjusted multiplicatively. This function can be activated using the Activate Exponential Backoff() [} 61] method. The parameters of the method specify the minimum and maximum time for the algorithm. The minimum time describes the initial delay value for the new connection attempt. The maximum time describes the highest delay value. The delay values are doubled until the maximum value is reached. Once a connection has been established, the backoff rate is reset to the original value. The Deactivate Exponential Backoff() [} 62] method can be used to deactivate this function programmatically. Syntax METHOD Deactivate Exponential Backoff TF6701 Version: 1.12.0 75
## Page 76

PLC API 5.1.2.1.7 Request This method is called once, in order to send a Request to the broker. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Request : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics a re case sensitive) s Response Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case sensitive) END_VAR VAR_INPUT p Payload : PVOID; n Payload Size : UDINT; e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker b Retain : BOOL; // if TRUE the broker stores the message in order to send it to new subscribers b Queue : BOOL; // for future extension p Props : POINTER TO Mqtt Publish Properties; p Correlation Data : POINTER TO BYTE; n Correlation Data Size: UINT; END_VAR Return value Name Type Description Request BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description p Payload PVOID Address for the payload of the MQTT message n Payload Size UDINT Size of the payload in bytes e Qo S Tc Iot Mqtt Qos "Quality of Service" b Retain BOOL If b Retain is TRUE, the broker stores the message in order to make it available to subsequent subscribers. b Queue BOOL Reserved parameter that can always be given the value FALSE. p Props POINTER TO Pointer to Publish properties to be sent. Mqtt Publish Prop The parameter is optional. The FB_Iot Mqtt5Publish Properties [} 104] erties can be used to specify Publish properties. p Correlation Data POINTER TO Pointer to the Correlation Data to be sent. This can be used to assign BYTE a request to a received response in a request/response procedure. n Correlation Data S UINT Size of the Correlation Data in bytes ize 76 Version: 1.12.0 TF6701
## Page 77

PLC API Inputs/outputs Name Type Description s Topic STRING Topic of the MQTT message s Response T STRING Response topic on which the request should be answered. opic Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. 5.1.2.1.8 Response This method is called once to send a response to a request. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Response : BOOL VAR_IN_OUT s Response Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case sensitive) END_VAR VAR_INPUT p Payload : PVOID; n Payload Size : UDINT; e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker b Retain : BOOL; // if TRUE the broker stores the message in order to send it to new subscribers b Queue : BOOL; // for future extension p Props : POINTER TO Mqtt Publish Properties; p Correlation Data : POINTER TO BYTE; n Correlation Data Size: UINT; END_VAR TF6701 Version: 1.12.0 77
## Page 78

PLC API Return value Name Type Description Response BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description p Payload PVOID Address for the payload of the MQTT message n Payload Size UDINT Size of the payload in bytes e Qo S Tc Iot Mqtt Qos "Quality of Service" b Retain BOOL If b Retain is TRUE, the broker stores the message in order to make it available to subsequent subscribers. b Queue BOOL Reserved parameter that can always be given the value FALSE. p Props POINTER TO Pointer to Publish properties to be sent. Mqtt Publish Prop The parameter is optional. The FB_Iot Mqtt5Publish Properties [} 104] erties can be used to specify Publish properties. p Correlation Data POINTER TO Pointer to the Correlation Data to be sent. This can be used to assign BYTE a request to a received response in a request/response procedure. n Correlation Data S UINT Size of the Correlation Data in bytes ize Inputs/outputs Name Type Description s Response T STRING Topic on which the response should be sent. opic Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. 5.1.2.1.9 Get Time Since Last Broker Message 78 Version: 1.12.0 TF6701
## Page 79

PLC API This method specifies the time (in ms) since the last message from the message broker. The time is reset to 0 with every new message from the message broker. It does not matter whether these are ping messages or regular publish/subscribe messages. The MQTT specification defines that an MQTT client itself determines the time after which it will accept a timeout in the direction of the message broker. This is possible with this method from the PLC. The keep alive time, on the other hand, specifies the time (multiplied by 1.5) after which the message broker assumes a client time-out if there are no messages from the client. Syntax METHOD Get Time Since Last Broker Message : UDINT Return value Name Type Description Get Time Sinc UDINT The time in milliseconds since the last message from the message broker. e Last Broker Message 5.1.2.2 FB_Iot Mqtt5Client Base The function block enables communication to a message broker based on MQTT version 5.0. A client function block is responsible for the connection to precisely one broker. The Execute() method of the function block must be called cyclically in order to ensure the background communication with this broker and facilitate receiving of messages. All connection parameters exist as input parameters and are evaluated when a connection is established. Use the FB_Iot Mqtt5Client Base if you want to implement the callback methods (On Mqtt5Message() and others) yourself. Use the FB_Iot Mqtt5Client if you do not want to implement callback methods yourself and incoming new messages should be provided in the message queue available at the output. Syntax Definition: FUNCTION_BLOCK FB_Iot Mqtt5Client VAR_INPUT {attribute 'Tc Encoding':='UTF-8'} s Client Id : STRING(255); // default is generated during initialization {attribute 'Tc Encoding':='UTF-8'} s Host Name : STRING(255) := '127.0.0.1'; // default is local host n Host Port : UINT := 1883; // default is 1883 {attribute 'Tc Encoding':='UTF-8'} s Topic Prefix : STRING(255); // topic prefix for pub and sub of this client (handled i nternally) n Keep Alive : UINT := 60; // in seconds {attribute 'Tc Encoding':='UTF-8'} s User Name : STRING(255); // optional parameter {attribute 'Tc Encoding':='UTF-8'} s User Password : STRING(255); // optional parameter st Will : ST_Iot Mqtt5Will; // optional parameter st TLS : ST_Iot Mqtt5Tls; // optional parameter st Auth : ST_Iot Mqtt5Auth; // optional parameter st Connect : ST_Iot Mqtt5Connect; // optional parameter END_VAR VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; e Connection State : ETc Iot Mqtt Client State; b Connected : BOOL; // TRUE if connection to host is established END_VAR TF6701 Version: 1.12.0 79
## Page 80

PLC API Inputs Name Type Description s Client Id STRING(255) The client ID can be specified individually and must be unique for most message brokers. If not specified, an ID based on the PLC project name is automatically generated by the Twin CAT driver. s Host Name STRING(255) s Host Name can be specified as name or as IP address. If no information is provided, the local host is used. n Host Port UINT The host port is specified here. The default is 1883. s Topic Prefix STRING(255) Here you can specify a topic prefix that will be added automatically for all publish and subscribe commands. n Keep Alive UINT Here you can specify the watchdog time (in seconds), with which the connection between client and broker is monitored. s User Name STRING(255) Optionally, a user name can be specified. s User Password STRING(255) A password for the user name can be entered here. st Will ST_Iot Mqtt5Will [} 91] If the client is disconnected from the broker irregularly, a last preconfigured message can optionally be sent from the broker to the so-called “will topic”. This message is specified here. st TLS ST_Iot Mqtt5Tls [} 92] If the broker offers a TLS-secured connection, the required configuration can be implemented here. st Auth ST_Iot Mqtt5Auth [} 93] This structure can be used to pass extended authentication information to the message broker. st Connect ST_Iot Mqtt5Connect This structure can be used to pass advanced connection settings to the message broker. [} 93] Outputs Name Type Description b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes can be found in the Appendix. e Connection State ETc Iot Mqtt Client State Indicates the state of the connection between client and broker as enumeration ETc Iot Mqtt Client State. [} 109] b Connected BOOL This output is TRUE if a connection exists between client and broker. 80 Version: 1.12.0 TF6701
## Page 81

PLC API Methods Name Description Execute [} 82] Method for background communication with the Twin CAT driver. The method must be called cyclically. Publish [} 82] Method for executing a publish operation to a MQTT message broker. Request [} 88] This can be used to send a request as part of the request/response procedure of MQTTv5. Response [} 89] This can be used to send a response as part of the request/response procedure of MQTTv5. Subscribe [} 83] Method for establishing a subscription. Unsubscribe [} 84] Method for removing a subscription. Activate Exponential Backoff Activates the exponential backoff [} 54] function [} 87] Deactivate Exponential Backof Deactivates the exponential backoff [} 54] function f [} 88] Get Time Since Last Broker Mes Method for querying the time (in ms) since the last message from the message broker. sage [} 91] Event-driven methods (callback methods) Name Description On Mqtt5Authentication Callback method called by the Twin CAT driver when the message broker sends an AUTH message to the client in response to a Connect. On Mqtt5Conn Ack Callback method called by the Twin CAT driver when the message broker sends a CONNACK message in response to a Connect. On Mqtt5Disconnected Callback method that is called by the Twin CAT driver in case of the interruption of a connection to a message broker. On Mqtt5Message Callback method used by the Twin CAT driver when a subscription to a topic was established and incoming messages are received. Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) TF6701 Version: 1.12.0 81
## Page 82

PLC API 5.1.2.2.1 Execute This method must be called cyclically in order to ensure the background communication with the MQTT broker. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Execute VAR_INPUT b Connect : BOOL; END_VAR Inputs Name Type Description b Connect BOOL The connection to the broker is established when b Connect is set to TRUE. b Connect must remain set to maintain the connection. 5.1.2.2.2 Publish This method is called once, in order to send a message to the broker. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Publish : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case sensitive) END_VAR VAR_INPUT p Payload : PVOID; n Payload Size : UDINT; e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker b Retain : BOOL; // if TRUE the broker stores the message in order to send it to new subscri bers b Queue : BOOL; // for future extension p Props : POINTER TO Mqtt Publish Properties; // optional END_VAR Return value Name Type Description Publish BOOL The method returns the return value TRUE if the call was successful. 82 Version: 1.12.0 TF6701
## Page 83

PLC API Inputs Name Type Description p Payload PVOID Address for the payload of the MQTT message n Payload Size UDINT Size of the payload in bytes e Qo S Tc Iot Mqtt Qos "Quality of Service" b Retain BOOL If b Retain is TRUE, the broker stores the message in order to make it available to subsequent subscribers. b Queue BOOL Reserved parameter that can always be given the value FALSE. p Props POINTER TO Pointer to Publish properties to be sent. Mqtt Publish P The parameter is optional. The FB_Iot Mqtt5Publish Properties [} 104] can be roperties used to specify Publish properties. Inputs/outputs Name Type Description s Topic STRING Topic of the MQTT message Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. 5.1.2.2.3 Subscribe This method is used by the client to signal to the broker that it wants to receive all MQTT message with a particular topic. The method can subscribe an MQTT client instance to multiple topics. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Subscribe : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case se nsitive) END_VAR VAR_INPUT e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker p Props : POINTER TO Mqtt Subscribe Properties; // optional END_VAR TF6701 Version: 1.12.0 83
## Page 84

PLC API Return value Name Type Description Subscribe BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description e Qo S Tc Iot Mqtt Qos "Quality of Service" p Props POINTER TO Pointer to Subscribe properties to be sent. Mqtt Subscribe Properties The parameter is optional. The FB_Iot Mqtt5Subscribe Properties [} 106] can be used to specify Subscribe properties. Inputs/outputs Name Type Description s Topic STRING Topic of the MQTT message 5.1.2.2.4 Unsubscribe This method is used by the client to signal to the broker that no further messages with the specified topic should be transferred to it. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Unsubscribe : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case se nsitive) END_VAR VAR_INPUT p Props : POINTER TO Mqtt Unsubscribe Properties; // optional END_VAR Return value Name Type Description Unsubscribe BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description p Props POINTER TO Pointer to Unsubscribe properties to be sent. Mqtt Unsubscribe Properties The parameter is optional. The FB_Iot Mqtt5Unsubscribe Properties [} 107] can be used to specify Unsubscribe properties. 84 Version: 1.12.0 TF6701
## Page 85

PLC API Inputs/outputs Name Type Description s Topic STRING Topic for which no further messages should be received. 5.1.2.2.5 On Mqtt5Conn Ack Callback method This method must not be called by the user. Instead, the function block FB_Iot Mqtt5Client Base can be used to derive information and overwrite this method. During the call of the Execute() method the responsible Twin CAT driver has the possibility to receive a notification via this callback, if the message broker has sent a CONNACK as response to a Connect. Syntax METHOD On Mqtt5Disconnected : HRESULT VAR_INPUT p Props : POINTER TO Mqtt Conn Ack Properties; END_VAR Return value Name Type Description On Mqtt5Conn Ack HRESULT Inputs Name Type Description p Props POINTER TO MQTT properties received in case of CONNACK. Mqtt Conn Ack Properties 5.1.2.2.6 On Mqtt5Disconnected Callback method This method must not be called by the user. Instead, the function block FB_Iot Mqtt5Client Base can be used to derive information and overwrite this method. During the call of the Execute() method the responsible Twin CAT driver has the possibility to call the On Mqtt5Disconnected() method in case of a disconnection with the message broker. Syntax METHOD On Mqtt5Disconnected : HRESULT VAR_INPUT p Props : POINTER TO Mqtt Disconnect Properties; END_VAR TF6701 Version: 1.12.0 85
## Page 86

PLC API Return value Name Type Description On Mqtt5Discon HRESULT nect Inputs Name Type Description p Props POINTER TO MQTT properties received in case of Disconnect. Mqtt Disconne ct Properties 5.1.2.2.7 On Mqtt5Message Callback method This method must not be called by the user. Instead, the function block FB_Iot Mqtt5Client Base can be used to derive information and overwrite this method. While the Execute() method is called, the responsible Twin CAT driver can call the On Mqtt5Message() method in the event of new incoming messages. In the event of several incoming messages the callback method is called several times, once per message. This must be taken into account when the method is implemented. The use of the callback method is also explained in the sample Iot Mqtt Sample Using Callback [} 314]. Syntax METHOD On Mqtt5Message : HRESULT VAR_IN_OUT CONSTANT topic : STRING; END_VAR VAR_INPUT payload : PVOID; length : UDINT; qos : Tc Iot Mqtt Qos; p Props : POINTER TO Mqtt Publish Properties; p Req : POINTER TO Mqtt Request Properties; repeated : BOOL; END_VAR Return value Name Type Description On Mqtt5Messag HRESULT The return value of the method should be S_OK, if the message was e accepted. If the message is to be issued again in the context of the next Execute() call, the return value can be assigned S_FALSE. 86 Version: 1.12.0 TF6701
## Page 87

PLC API Inputs Name Type Description payload PVOID Address for the payload of the received MQTT message length UDINT Size of the payload in bytes qos Tc Iot Mqtt Qos "Quality of Service" p Props POINTER TO MQTT properties that may have been received with a message. Mqtt Publish Pr operties p Req POINTER TO MQTT Request Properties, which may have been received with a message. Mqtt Request P roperties repeated BOOL If the user did not respond with S_OK to the last On Mqtt5Message() method call, the message is issued again in the context of the next Execute() call, and the parameter repeated is set. This indicates that the message was issued more than once. Inputs/outputs Name Type Description Topic STRING Topic of the received MQTT message 5.1.2.2.8 Activate Exponential Backoff A feature referred to as "exponential backoff" can be used to avoid burdening the message broker with unnecessary connection requests in case of a connection error. In the event of a TLS connection error involving the message broker, the reconnect rate is adjusted multiplicatively. This function can be activated using the Activate Exponential Backoff() [} 61] method. The parameters of the method specify the minimum and maximum time for the algorithm. The minimum time describes the initial delay value for the new connection attempt. The maximum time describes the highest delay value. The delay values are doubled until the maximum value is reached. Once a connection has been established, the backoff rate is reset to the original value. The Deactivate Exponential Backoff() [} 62] method can be used to deactivate this function programmatically. Syntax METHOD Activate Exponential Backoff VAR_INPUT t Mqtt Backoff Min Time: TIME; t Mqtt Backoff Max Time: TIME; END_VAR Inputs Name Type Description t Mqtt Backoff TIME Describes the initial delay value for the new connection attempt. Min Time t Mqtt Backoff TIME Describes the largest delay value. Once this value has been reached, all new Max Time connection attempts are made at these intervals. TF6701 Version: 1.12.0 87
## Page 88

PLC API 5.1.2.2.9 Deactivate Exponential Backoff A feature referred to as "exponential backoff" can be used to avoid burdening the message broker with unnecessary connection requests in case of a connection error. In the event of a TLS connection error involving the message broker, the reconnect rate is adjusted multiplicatively. This function can be activated using the Activate Exponential Backoff() [} 61] method. The parameters of the method specify the minimum and maximum time for the algorithm. The minimum time describes the initial delay value for the new connection attempt. The maximum time describes the highest delay value. The delay values are doubled until the maximum value is reached. Once a connection has been established, the backoff rate is reset to the original value. The Deactivate Exponential Backoff() [} 62] method can be used to deactivate this function programmatically. Syntax METHOD Deactivate Exponential Backoff 5.1.2.2.10 Request This method is called once, in order to send a Request to the broker. Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Request : BOOL VAR_IN_OUT s Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics a re case sensitive) s Response Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case sensitive) END_VAR VAR_INPUT p Payload : PVOID; n Payload Size : UDINT; e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker b Retain : BOOL; // if TRUE the broker stores the message in order to send it to new subscribers b Queue : BOOL; // for future extension p Props : POINTER TO Mqtt Publish Properties; p Correlation Data : POINTER TO BYTE; n Correlation Data Size: UINT; END_VAR Return value Name Type Description Request BOOL The method returns the return value TRUE if the call was successful. 88 Version: 1.12.0 TF6701
## Page 89

PLC API Inputs Name Type Description p Payload PVOID Address for the payload of the MQTT message n Payload Size UDINT Size of the payload in bytes e Qo S Tc Iot Mqtt Qos "Quality of Service" b Retain BOOL If b Retain is TRUE, the broker stores the message in order to make it available to subsequent subscribers. b Queue BOOL Reserved parameter that can always be given the value FALSE. p Props POINTER TO Pointer to Publish properties to be sent. Mqtt Publish Prop The parameter is optional. The FB_Iot Mqtt5Publish Properties [} 104] erties can be used to specify Publish properties. p Correlation Data POINTER TO Pointer to the Correlation Data to be sent. This can be used to assign BYTE a request to a received response in a request/response procedure. n Correlation Data S UINT Size of the Correlation Data in bytes ize Inputs/outputs Name Type Description s Topic STRING Topic of the MQTT message s Response T STRING Response topic on which the request should be answered. opic Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. 5.1.2.2.11 Response This method is called once to send a response to a request. TF6701 Version: 1.12.0 89
## Page 90

PLC API Possible errors are output at the outputs b Error and hr Error Code of the function block instance. Syntax METHOD Response : BOOL VAR_IN_OUT s Response Topic : STRING; // topic string (UTF-8) with any length (attend that MQTT topics are case sensitive) END_VAR VAR_INPUT p Payload : PVOID; n Payload Size : UDINT; e Qo S : Tc Iot Mqtt Qos; // quality of service between the publishing client and the broker b Retain : BOOL; // if TRUE the broker stores the message in order to send it to new subscribers b Queue : BOOL; // for future extension p Props : POINTER TO Mqtt Publish Properties; p Correlation Data : POINTER TO BYTE; n Correlation Data Size: UINT; END_VAR Return value Name Type Description Response BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description p Payload PVOID Address for the payload of the MQTT message n Payload Size UDINT Size of the payload in bytes e Qo S Tc Iot Mqtt Qos "Quality of Service" b Retain BOOL If b Retain is TRUE, the broker stores the message in order to make it available to subsequent subscribers. b Queue BOOL Reserved parameter that can always be given the value FALSE. p Props POINTER TO Pointer to Publish properties to be sent. Mqtt Publish Prop The parameter is optional. The FB_Iot Mqtt5Publish Properties [} 104] erties can be used to specify Publish properties. p Correlation Data POINTER TO Pointer to the Correlation Data to be sent. This can be used to assign BYTE a request to a received response in a request/response procedure. n Correlation Data S UINT Size of the Correlation Data in bytes ize Inputs/outputs Name Type Description s Response T STRING Topic on which the response should be sent. opic Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. 90 Version: 1.12.0 TF6701
## Page 91

PLC API Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. 5.1.2.2.12 Get Time Since Last Broker Message This method specifies the time (in ms) since the last message from the message broker. The time is reset to 0 with every new message from the message broker. It does not matter whether these are ping messages or regular publish/subscribe messages. The MQTT specification defines that an MQTT client itself determines the time after which it will accept a timeout in the direction of the message broker. This is possible with this method from the PLC. The keep alive time, on the other hand, specifies the time (multiplied by 1.5) after which the message broker assumes a client time-out if there are no messages from the client. Syntax METHOD Get Time Since Last Broker Message : UDINT Return value Name Type Description Get Time Sinc UDINT The time in milliseconds since the last message from the message broker. e Last Broker Message 5.1.2.3 ST_Iot Mqtt5Will By means of the following specifications, a message can be specified which, in case of an irregular disconnection between client and broker, is sent as the last message from the broker to the subscribers who have subscribed to the corresponding topic. This structure is an extension of the previous structure ST_Iot Mqtt Will [} 62] for MQTT V5. No instantiation and assignment of this structure This structure does not allow instantiation and assignment to FB_Iot Mqtt5Client or FB_Iot Mqtt5Client Base. Instead, the input parameter of the MQTT v5 client function block is used directly. Syntax Definition: TYPE ST_Iot Mqtt5Will : STRUCT {attribute 'Tc Encoding':='UTF-8'} s Topic : STRING(255); TF6701 Version: 1.12.0 91
## Page 92

PLC API fb Payload : FB_Iot Data Buffer; e Qo S : Tc Iot Mqtt Qos := Tc Iot Mqtt Qos. Exactly Once Delivery; b Retain : BOOL; {attribute 'Tc Encoding':='UTF-8'} s Content Type : STRING(255); {attribute 'Tc Encoding':='UTF-8'} s Response Topic : STRING(255); n Msg Expiry Interval : UDINT; n Delay : UDINT; b Payload Utf8 : BOOL; fb Correlation Data : FB_Iot Data Buffer; fb User Properties : FB_Iot Mqtt5User Properties; END_STRUCT END_TYPE Parameters Name Type Description s Topic STRING(255) Message topic. fb Payload FB_Iot Data Buffer Data buffer for the payload of the message. e Qo S Tc Iot Mqtt Qos The "Quality of Service" offers the following setting options: Qo S level 0, Qo S level 1, Qo S level 2 (See Neuer Knoten). b Retain BOOL If b Retain is TRUE, the broker stores the message in order to make it available to subsequent subscribers. s Content Type STRING(255) Describes the encoding of the payload. MIME types such as "text/plain" are particularly suitable for high compatibility. s Response Topic STRING(255) At this point, the response topic can be specified on which a response from another client is expected. n Msg Expiry Interval UDINT Time in seconds after which a Last Will message expires and is no longer delivered by the broker if the connection is lost. n Delay UDINT Delay interval in seconds until the Last Will message is sent. b Payload Utf8 BOOL Format indicator for the message content. fb Correlation Data FB_Iot Data Buffer Data buffer for Correlation Data fb User Properties FB_Iot Mqtt5User Properties User Properties can be specified at this point. [} 108] 5.1.2.4 ST_Iot Mqtt5Tls TLS security settings for the MQTT client (V5). Either CA (certificate authority) or PSK (Pre Shared Key) can be used. Syntax Definition: TYPE ST_Iot Mqtt5Tls : STRUCT s CA : STRING(255); // certificate authority as filename (PEM or DER format) or as string (PEM) s Cert : STRING(255); // client certificate as filename (PEM or DER format) or as st ring (PEM) s Key File : STRING(255); s Key Pwd : STRING(255); s Crl : STRING(255); // Certificate Revocation List as filename (PEM or DER format) or as string (PEM) s Ciphers : STRING(255); s Version : STRING(80) := 'tlsv1.2'; // TLS version b No Server Cert Check : BOOL := FALSE; s Psk Identity : STRING(255); 92 Version: 1.12.0 TF6701
## Page 93

PLC API a Psk Key : ARRAY[1..64] OF BYTE; n Psk Key Len : USINT; s Azure Sas : STRING(511); END_STRUCT END_TYPE Parameters Name Type Description s CA STRING(255) Certificate of the certificate authority (CA) s Cert STRING(255) Client certificate to be used for authentication at the broker s Key File STRING(255) Private key of the client s Key Pwd STRING(255) Password of the private key, if applicable s Crl STRING(255) Path to the certificate revocation list, which may be present in PEM or DER format s Ciphers STRING(255) Cipher suites to be used, specified in Open SSL string format s Version STRING(80) TLS version to be used b No Server Cert Check BOOL Disables verification of the server certificate validity. If communication is to take place without TLS encryption, this value must remain FALSE. s Psk Identity STRING(255) Pre Shared Key identity for TLS PSK connection a Psk Key ARRAY[1..64] OF BYTE Pre Shared Key for TLS PSK connection n Psk Key Len USINT Length of the Pre Shared Key in bytes s Azure SAS STRING(511) SAS token for connection to the Microsoft Azure Io T Hub 5.1.2.5 ST_Iot Mqtt5Auth Authentication settings for the MQTT client (V5). Syntax Definition: TYPE ST_Iot Mqtt5Auth : STRUCT {attribute 'Tc Encoding':='UTF-8'} s Auth Method : STRING(255); a Auth Data : ARRAY[0..4095] OF BYTE; n Auth Data Size : UINT; END_STRUCT END_TYPE Parameter Name Type Description s Auth Method STRING(255) UTF-8 encoded name of an extended authentication method. a Auth Data ARRAY[0..4095] OF BYTE This array contains binary authentication data. n Auth Data Size UINT Specifies the length of the authentication data. 5.1.2.6 ST_Iot Mqtt5Connect Connection settings for the MQTTv5 client, which can be set at the function block FB_Iot Mqtt5Client [} 79]. Through these settings, the client can transmit information to the message broker about potential restrictions, for example, a maximum packet size that the client can receive. TF6701 Version: 1.12.0 93
## Page 94

PLC API Syntax Definition: TYPE ST_Iot Mqtt5Connect : STRUCT n Session Expire : UDINT; n Max Packet Size : UDINT; n Receive Max : UINT; n Topic Alias Max : UINT; b Req Response Info : BOOL; b Ignore Problem Info : BOOL; END_STRUCT END_TYPE Parameter Name Type Description n Session Expire UDINT Specifies the time in seconds after which a message broker deletes a client session if the client is not connected. n Max Packet Size UDINT With this setting the client tells the message broker up to which size in bytes it wants to or can receive messages. When a larger message is received, the client terminates the connection. n Receive Max UINT This setting determines how many Qo S 1 or Qo S 2 messages may be communicated to the client simultaneously. Simultaneous in the case means that the handshake (two- or four-step) happens at the same time. n Topic Alias Max UINT Specifies the highest value a Topic Alias may have to limit the number of Topic Aliases existing at the same time. If the value is 0, it means that the client does not accept Topic Aliases. b Req Response Info BOOL If the value is TRUE, then the message broker may send information in the CONNACK response. If the value is FALSE, the message broker does not send any response information. b Ignore Problem Info BOOL If the value is TRUE, then the message broker may send a Reason String or User Properties with each packet. If the value is FALSE, the message broker may 5.1.2.7 FB_Iot Mqtt5Message Queue This function block provides a message queue for MQTT messages that are received with the function block FB_Iot Mqtt5Client [} 69]. For this purpose, an instance is already provided at the output of FB_Iot Mqtt5Client. The function block operates based on the first in, first out principle (FIFO). It is possible that multiple MQTT messages are received within one PLC cycle and made available at the message queue. During the program sequence, the property n Queued Messages can be used to check whether and how many messages have been collected in the message queue. The Dequeue() method is used for removing messages from the FIFO queue. The oldest message is output first. 94 Version: 1.12.0 TF6701
## Page 95

PLC API Size of the MQTT message queue The maximum number of possible messages in the queue can be set via the parameter c Max Entries In Mqtt Message Queue in the parameter list [} 111] of the Tc3_Iot Base library. The default value is 1000 messages. This value can usually be left unchanged, since prompt message processing is required in most cases. The MQTT message queue allocates new memory space for new messages according to the topic and payload size. By default the maximum size of a message is limited to 100 k B, the size of the MQTT message queue is limited to 1000 k B. For special cases these values can also be adjusted in the parameter list [} 111]. Properties Name Type Access Description b Overwrit BOOL Get, Set Here you can parameterize whether, e Oldest En when the queue is full, a newly received try message should overwrite the oldest message. If yes (TRUE), the oldest message is lost. If no (FALSE), the reception of the new message will wait until the queue offers space. A full queue is an unlikely case if the user ensures a speedy readout of the queue using the Dequeue() method. n Lost Mes UDINT Get Returns the number of MQTT messages sages which had to be discarded completely. Discarded MQTT messages can be caused by a full queue or by the total size of a newly received message being too large. n Max Size UDINT Get Maximum size in bytes of all received Of Messag MQTT messages, which should be e received by the FB_Iot Mqtt5Client and stored in the FB_Iot Mqtt5Message Queue. If the maximum size specified with the library parameter [} 111] Parameter List.c Max Size Of Mqtt Me ssage is exceeded, the message queue first attempts to save the message without user properties. If this size reduction is not sufficient, the MQTT message must be discarded completely. n Queued UDINT Get Outputs the number of MQTT messages Messages currently collected in the queue. The maximum possible number is set with the library parameter [} 111] Parameter List.c Max Entries In Mqt t Message Queue. Methods Name Description Dequeue() [} 96] Removes an MQTT message from the queue. Reset Queue() [} 96] Deletes all messages from the queue. TF6701 Version: 1.12.0 95
## Page 96

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) 5.1.2.7.1 Dequeue The method returns the return value TRUE if the removal of an MQTT message from the queue was successful. The number of MQTT messages currently in the queue (n Queued Messages property) is reduced by one through the removal of a message. Syntax METHOD Dequeue : BOOL VAR_INPUT fb Message : REFERENCE TO FB_Iot Mqtt5Message; END_VAR Return value Name Type Description Dequeue BOOL The method returns the return value TRUE if the call was successful. Inputs Name Type Description fb Message REFERENCE TO FB_Iot Mqtt5M For the message itself the reference is transferred to an essage instance of type FB_Iot Mqtt5Message. 5.1.2.7.2 Reset Queue When this method is called, all accumulated MQTT messages are deleted from the queue. Syntax METHOD Reset Queue : BOOL Return value Name Type Description Reset Queue BOOL The method returns the return value TRUE if the call was successful. 5.1.2.8 FB_Iot Mqtt5Message If the Twint CAT MQTT v5 client (FB_Iot Mqtt5Client [} 69]) is used in combination with a message queue (FB_Iot Mqtt5Message Queue [} 94]), an MQTT message is represented by the FB_Iot Mqtt5Message function block. Incoming messages are collected by the message queue and made available to the user in the form of a such a function block instance. 96 Version: 1.12.0 TF6701
## Page 97

PLC API The topic, the payload size and the "Quality of Service" parameter of the MQTT message are immediately available as Properties at the function block output. The topic and the payload can easily be evaluated or copied via the provided methods Compare Topic(), Get Topic() and Get Payload(). Message payload formatting Note that the data type and the formatting of the content must be known to the sender and receiver side, particularly when binary information (alignment) or strings (with or without zero termination) are sent. Size of an MQTT message The maximum size of an MQTT message to be received in the PLC depends on the hardware platform and should not exceed a few MB, even on higher-performance/larger platforms. The maximum possible size of a message can be set using the c Max Size Of Mqtt Message parameter in the parameter list [} 111] of the Tc3_Iot Base library. By default, the message size is limited to 100 k B. When using the MQTT Message Queue, it dynamically allocates new memory from the Twin CAT Router memory for new messages. Properties Name Type Access Description b Payload BOOL Get If TRUE, the payload is UTF-8 formatted Utf8 text. b Topic Alia BOOL Get Indicates whether the receive topic is an s alias. e Qo S Tc Iot Mqtt Q Get "Quality of Service" of the MQTT os message n Correlati UINT Get Size of the Correlation Data in bytes on Data Siz e n Msg Expi UDINT Get Specifies the expiration interval of the ry Interval message in seconds. n Payload UDINT Get Size of the payload in bytes Size n Sub Id Cn UINT Get Indicates how many subscription t identifiers were received. n User Pro UINT Get Number of existing user properties. perty Cnt These can be read using Get User Property By Idx(). n User Pro UINT Get Number of user properties discarded on perty Cnt L reception. ost The cause can be an exceeding of the defined maximum number (see library parameter [} 111] Parameter List.c Max Mqtt5User Pro ps) or a too large received MQTT message (see library parameter [} 111] Parameter List.c Max Size Of Mqtt Me ssage). n Topic Siz UINT Get Size of the topic in bytes e s Content T STRING Get Content Type of the MQTT message ype If the original text is too large for this property, the Get Content Type() method can be used to get the full text. TF6701 Version: 1.12.0 97
## Page 98

PLC API Methods Name Description Compare Topic() [} 98] Compares a specified topic with the topic in the MQTT message. Get Content Type() Returns the Content Type of the MQTT message. Get Correlation Data() Returns the Correlation Data of the MQTT message. Get Response Topic() Returns the Response Topic. Get Payload() [} 99] Returns the content of an MQTT message. Get Sub Ids() Returns the Subscription Identifiers received for the MQTT message. Get Topic() [} 99] Returns the topic of an MQTT message. Get User Property By Idx() Returns the name and value of a User Property specified by its position (index) in the list. Get User Property Value By Nam Returns the value of a User Property specified by its name. e() Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) 5.1.2.8.1 Compare Topic This method returns TRUE, if the specified topic is identical to the topic of the MQTT message in the function block. Syntax METHOD Compare Topic : BOOL VAR_IN_OUT CONSTANT s Topic : STRING; // topic string with any length (attend that MQTT topics are case sensitive) END_VAR Return value Name Type Description Compare To BOOL Is TRUE, if the specified topic is identical to the topic of the MQTT message in the pic function block. 98 Version: 1.12.0 TF6701
## Page 99

PLC API Inputs/outputs Name Type Description s Topic STRING 5.1.2.8.2 Get Topic Syntax METHOD Get Topic : BOOL VAR_INPUT p Topic : POINTER TO STRING; // topic buffer n Topic Size : UINT; // maximum size of topic buffer in bytes END_VAR Return value Name Type Description Get Topic BOOL Inputs Name Type Description p Topic POINTER TO The memory address for the buffer into which the topic is to be copied is STRING specified here. n Topic Size UINT The maximum available buffer size (in bytes) is specified here. 5.1.2.8.3 Get Payload Syntax METHOD Get Payload : BOOL VAR_INPUT p Payload : PVOID; // payload buffer n Payload Size : UDINT; // maximum size of payload buffer in bytes b Set Null Termination: BOOL; // The publisher specifies the kind of payload. If it is a string, it could be null terminated or not. Setting this input to TRUE will force a null termination. One more byte is required for that. END_VAR Return value Name Type Description Get Payload BOOL TF6701 Version: 1.12.0 99
## Page 100

PLC API Inputs Name Type Description p Payload PVOID The memory address for the buffer into which the payload is to be copied is specified here. n Payload Size UDINT The maximum available buffer size (in bytes) is specified here. b Set Null Termination BOOL If the payload type requires null termination (string), this can be implemented during the copy process. This is not necessary if the message source (publisher) has already implemented a null termination and this was taken into account in the payload size specification. In many cases no reliable information is available. 5.1.2.9 MQTT5 Properties 5.1.2.9.1 FB_Iot Mqtt5Conn Ack Properties The function block enables the reception of status information from the message broker directly after the Connection Acknowledgement, which is part of the connection setup. This allows the message broker to communicate information to the client about potential constraints, such as a maximum packet size that the message broker can handle. It is the client's task to query these values and to react to them if necessary. If the client has received Conn Ack properties and makes them available at the output, this is indicated by b Properties Available=TRUE. General description of the Connection Acknowledgement Properties: 100 Version: 1.12.0 TF6701
## Page 101

PLC API Property Description Retain available Specifies whether the message broker supports retain messages. Server Keep Alive Specifies the Keep Alive time assigned by the server. Shared subscriptions available Specifies whether the message broker supports shared subscriptions. Wildcard subscriptions available Specifies whether the message broker supports wildcard subscriptions, e.g. subscriptions to a # or + topic. Authentication data Contains the authentication data, depending on the authentication method used. Maximum packet size Specifies the maximum packet size of the control packet. If this value is not specified, then no maximum size is explicitly set. Maximum Qo S Specifies the maximum Qo S level that the message broker supports. For example, some message broker implementations do not support Qo S 2. Reason code Optional reason code that the message broker can transmit to the client as part of the Conn Ack procedure. In conjunction with the Server Reference (see below), the message broker can use this to inform the client, for example, that it is temporarily or permanently unavailable and/or can be reached at a new address. Maximum receive The server uses this property to limit the number of Qo S1 and Qo S2 publishes it is willing to process for the client simultaneously. Session expiry interval The server can use this to inform the client that it is using a different Session Expiry Interval than originally requested by the client. Response info Optional return information from the message broker to the client. A use case for this can be, for example, that the broker informs the client about a topic area which has been assigned to the client and which it can access. Maximum topic alias Specifies the maximum value that can be used for a topic alias. Assigned client ID Returns the Client ID assigned by the message broker if the client has not specified its own Client ID. Server reference Optional (address) reference to another message broker, e.g. for Reason Code 0x9C or 0x9D (Server unavailable, Server has moved). User Properties User Properties are key/value pairs that can be attached to the Publish Properties. This is done by means of the function block FB_Iot Mqtt5User Properties [} 108]. The meaning of the User Properties is not part of the MQTT5 specification and therefore application specific. Syntax Definition: FUNCTION_BLOCK FB_Iot Mqtt5Conn Ack Properties EXTENDS FB_Iot Mqtt5User Properties [} 108] VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; END_VAR TF6701 Version: 1.12.0 101
## Page 102

PLC API Outputs Name Type Description b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes can be found in the Appendix. Properties Name Type Access Description b Propertie BOOL Get Indicates whether properties are present. s Available b Retain Av BOOL Get Specifies whether the message broker ailable supports retain messages. b Server K BOOL Get Indicates whether a different Keep Alive eep Alive value is used by the server than was originally requested by the client. b Session BOOL Get Indicates whether the client already has a Present session with the broker. b Shared S BOOL Get Specifies whether the message broker ub Availabl supports shared subscriptions. e b Sub Id Av BOOL Get Specifies whether the message broker ailable supports the use of Subscription Identifiers. b Wildcard BOOL Get Specifies whether the message broker Sub Availa supports Wildcard Subscriptions. ble n Auth Dat UINT Get Specifies the size of the Authentication a Size Data. n Max Pack UDINT Get Specifies the maximum packet size of the ate Size control packet. n Max Qo S BYTE Get Specifies the maximum Qo S level that the message broker supports. n Reason BYTE Get Specifies an optional reason code that Code the server transmits to the client as part of the Conn Ack procedure. n Receive UINT Get Maximum number of simultaneous Qo S 1 Max and 2 publishes that the server supports. n Respons UINT Get Returns the size of the response e Info Size information. n Session UDINT Get Value in seconds for the Session Expiry Expiry Inte Interval supported by the server. rval n Topic Alia UINT Get Maximum value for the Topic Alias that s Max the server supports. s Assigned STRING Get Client ID assigned by the message Client Id broker. s Auth Met STRING Get Returns the name of the authentication hod method used. s Reason S STRING Get Readable variant of the reason code. tring s Server R STRING Get Optional Server Reference, the format is eference not defined by the specification. 102 Version: 1.12.0 TF6701
## Page 103

PLC API Methods Name Description Get Auth Data Returns the authentication data, which depends on the used authentication method. Get Response Info Allows the response information to be read out. This allows the message broker to transmit to the client a basis for generating the response topic in the Req/Res procedure [} 33]. The format is not defined by the specification. Set Conn Ack Properties Enables the setting of the Conn Ack properties. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) 5.1.2.9.2 FB_Iot Mqtt5Disconnect Properties The function block enables the reception of disconnection information. If the client has received Disconnect Properties and provides these at the output, this is indicated by b Properties Available=TRUE. General description of the Disconnect Properties: Property Description Reason Code Specifies the reason for the Disconnect as described in MQTTv5 specification chapter 3.14.2.1. Usually used for programmatic evaluation. Reason String Specifies the reason for the Disconnect in legible form. Usually not used for programmatic evaluation. Session Expiry Interval Indicates the expiration interval for the session (in seconds). Server Reference Can be used by the message broker in conjunction with Reason Code 0x9C (Use Another Server) or 0x9D (Server moved) to specify a new server. The format of the server reference is not prescribed by the specification and therefore depends on the message broker used. User Properties User Properties are key/value pairs that can be attached to the Publish Properties. This is done by means of the function block FB_Iot Mqtt5User Properties [} 108]. The meaning of the User Properties is not part of the MQTT5 specification and therefore application specific. Syntax Definition: FUNCTION_BLOCK FB_Iot Mqtt5Disconnect Properties EXTENDS FB_Iot Mqtt5User Properties [} 108] VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; END_VAR TF6701 Version: 1.12.0 103
## Page 104

PLC API Outputs Name Type Description b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes can be found in the Appendix. Properties Name Type Access Description b Propertie BOOL Get Indicates whether properties are present. s Available n Reason BYTE Get Specifies the Disconnect reason as a Code numeric value. n Session UDINT Get Specifies a lifetime in seconds for the Expire session. s Reason S STRING Get Specifies the disconnect reason as a tring readable value. s Server R STRING Get Specifies an optional server reference for eference Reason Code 0x9C or 0x9D. Methods Name Description Set Disconnect Properties Allows you to set the Disconnect properties. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) 5.1.2.9.3 FB_Iot Mqtt5Publish Properties The function block allows the definition of various properties that can be set when sending a message. This allows additional metadata to be attached to a message during transmission. The following metadata can be defined: General description of the Publish Properties: 104 Version: 1.12.0 TF6701
## Page 105

PLC API Property Description Content Type Can be used by applications to convey a content description of the payload. Topic Alias A Topic Alias can be used to represent a topic e.g. by an integer value instead of a (potentially long) string. Subscription Identifier An ID to be able to identify a subscription. Message Expiry Interval Specifies the lifetime of a message until it can be discarded by the message broker. Payload UTF-8 Indicator Indicates whether the transmitted message is in UTF-8 format. User Properties User Properties are key/value pairs that can be attached to the Publish Properties. This is done by means of the function block FB_Iot Mqtt5User Properties [} 108]. The meaning of the User Properties is not part of the MQTT5 specification and therefore application specific. Syntax Definition: FUNCTION_BLOCK FB_Iot Mqtt5Publish Properties EXTENDS FB_Iot Mqtt5User Properties [} 108] VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; END_VAR Outputs Name Type Description b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes can be found in the Appendix. Properties Name Type Access Description b Payload BOOL Get, Set Indicates whether the message content is Utf8 in UTF-8 format. b Topic Alia BOOL Get, Set Specifies a Topic Alias. s n Msg Expi UDINT Get, Set Specifies a lifetime in seconds for the ry Interval message. n Sub Id Cn UINT Get Returns the number of subscription ids. t p Publish P POINTER Get Pointer to an object of type roperties TO Mqtt Publish Properties. Mqtt Publis When calling FB_Iot Mqtt5Client. Publish(), h Propertie as well as Request() and Response() it is s possible to pass this directly. s Content T STRING Get, Set Specifies a content type for the message ype content. TF6701 Version: 1.12.0 105
## Page 106

PLC API Methods Name Description Get Sub Ids Returns the subscription IDs. Set Publish Properties Sets the configured Publish Properties. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) 5.1.2.9.4 FB_Iot Mqtt5Subscribe Properties The function block allows the definition of different properties, which can be set when creating a subscription. This allows additional properties to be defined for a subscription and transferred from the client to the message broker. General description of the Subscribe Properties: Property Description No Local When using MQTTv3, if a message is sent on the same topic that was also subscribed to, the sent message will be received again. By using this flag, you will not receive messages that have already been sent again. Retained Message Control Retain messages still work as with MQTTv3, but this flag adds options that define what should happen when retain messages are received. Subscription Identifier A numeric value used to identify a subscription. User Properties User Properties are key/value pairs that can transport additional metadata. These are managed via the function block FB_Iot Mqtt5User Properties [} 108]. The meaning of the User Properties is not part of the MQTT5 specification and therefore application specific. Syntax Definition: FUNCTION_BLOCK FB_Iot Mqtt5Subscribe Properties EXTENDS FB_Iot Mqtt5User Properties [} 108] VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; END_VAR Outputs Name Type Description b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes can be found in the Appendix. 106 Version: 1.12.0 TF6701
## Page 107

PLC API Properties Name Type Access Description b No Local BOOL Get, Set Specifies whether the No Local property should be set, see above. b Retain As BOOL Get, Set Specifies whether the retain flag of a Published publisher should remain set when a message is received. n Retain H BYTE Get, Set Specifies how to receive retain andling messages. 0: Retain messages are sent by the broker when the client subscribes. (Default behavior of MQTTv3) 1: Retain messages are sent by the broker only when the client subscribes if the subscription does not exist. 2: Retain messages are not sent by the broker when the client subscribes. n Sub Id UDINT Get, Set Numeric value for optional identification of a subscription. p Subscrib POINTER Get Pointer to an object of type e Propertie TO Mqtt Subscribe Properties. s Mqtt Subscr When calling ibe Properti FB_Iot Mqtt5Client. Subscribe() it is es possible to pass this directly. Methods Name Description Set Subscribe Properties Allows you to set the Subscribe properties. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) 5.1.2.9.5 FB_Iot Mqtt5Unsubscribe Properties The function block allows the definition of various properties that can be set when a subscription is unsubscribed. This allows the following metadata to be transmitted from the client to the message broker. General description of the Unsubscribe Properties: Property Description User Properties User Properties are key/value pairs that can transport additional metadata. These are managed via the function block FB_Iot Mqtt5User Properties [} 108]. The meaning of the User Properties is not part of the MQTT5 specification and therefore application specific. Syntax Definition: TF6701 Version: 1.12.0 107
## Page 108

PLC API FUNCTION_BLOCK FB_Iot Mqtt5Unsubscribe Properties EXTENDS FB_Iot Mqtt5User Properties [} 108] VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; END_VAR Outputs Name Type Description b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes can be found in the Appendix. Properties Name Type Access Description p Unsubsc POINTER Get Pointer to an object of type ribe Proper TO Mqtt Unsubscribe Properties. ties Mqtt Unsub When calling scribe Prop FB_Iot Mqtt5Client. Unsubscribe() it is erties possible to pass this directly. Methods Name Description Set Unsubscribe Properties Allows to set the Unsubscribe properties. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) 5.1.2.9.6 FB_Iot Mqtt5User Properties The function block enables the definition and handling of User Properties. User Properties are key/value pairs that describe optional metadata and can be used, for example, with Publish Properties. Number of User Properties The processing of User Properties in the PLC real-time task cycle requires a certain amount of time, which is why it is better to keep it low. The maximum amount of possible User Properties can be set via the parameter c Max Mqtt5User Props in the parameter list [} 111] of the Tc3_Iot Base library. Syntax Definition: FUNCTION_BLOCK FB_Iot Mqtt5User Properties VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; END_VAR 108 Version: 1.12.0 TF6701
## Page 109

PLC API Outputs Name Type Description b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes can be found in the Appendix. Properties Name Type Access Description n User Pro UINT Get Specifies the number of User Properties perty Cnt included. Methods Name Description Add User Property Adds a User Property to the list. The property is specified by its name and value. Clear User Properties Deletes all User Properties contained in the list. Get User Property By Idx Returns the name and value of a User Property specified by its position (index) in the list. Get User Property Value By Na Returns the value of a User Property specified by its name. me Set User Properties Deletes all User Properties contained in the list and adds a set of User Properties specified by an array of objects of type Mqtt User Property. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0) 5.1.3 ETc Iot Mqtt Client State Syntax TYPE ETc Iot Mqtt Client State : ( MQTT_ERR_SUCCESS :=0, MQTT_ERR_NOMEM :=1, MQTT_ERR_PROTOCOL :=2, MQTT_ERR_INVAL :=3, MQTT_ERR_NO_CONN :=4, MQTT_ERR_CONN_REFUSED :=5, MQTT_ERR_NOT_FOUND :=6, MQTT_ERR_CONN_LOST :=7, MQTT_ERR_TLS :=8, MQTT_ERR_PAYLOAD_SIZE :=9, MQTT_ERR_NOT_SUPPORTED :=10, MQTT_ERR_AUTH :=11, MQTT_ERR_ACL_DENIED :=12, MQTT_ERR_UNKNOWN :=13, MQTT_ERR_ERRNO :=14, MQTT_ERR_EAI :=15, MQTT_ERR_PROXY :=16, MQTT_ERR_TLS_CA_NOTFOUND :=17, MQTT_ERR_TLS_CERT_NOTFOUND :=18, MQTT_ERR_TLS_KEY_NOTFOUND :=19, MQTT_ERR_TLS_CA_INVALID :=20, MQTT_ERR_TLS_CERT_INVALID :=21, MQTT_ERR_TLS_KEY_INVALID :=22, MQTT_ERR_TLS_VERIFY_FAIL :=23, MQTT_ERR_TLS_SETUP :=24, TF6701 Version: 1.12.0 109
## Page 110

PLC API MQTT_ERR_TLS_HANDSHAKE_FAIL :=25, MQTT_ERR_TLS_CIPHER_INVALID :=26, MQTT_ERR_TLS_VERSION_INVALID:=27, MQTT_ERR_TLS_PSK_INVALID :=28, MQTT_ERR_TLS_CRL_NOTFOUND :=29, MQTT_ERR_TLS_CRL_INVALID :=30, MQTT_ERR_FINALIZE_DISCONNECT:=31, MQTT_ERR_BIND :=32, MQTT_ERR_BIND_ADDR_INUSE :=33, MQTT_ERR_BIND_ADDR_INVAL :=34, MQTT_ERR_CREATE :=35, MQTT_ERR_CREATE_TYPE :=36, MQTT_ERR_CONN :=37, MQTT_ERR_CONN_TIMEDOUT :=38, MQTT_ERR_CONN_HOSTUNREACH :=39, MQTT_ERR_TLS_CERT_EXPIRED :=40, MQTT_ERR_TLS_CN_MISMATCH :=41 ) DINT; END_TYPE 110 Version: 1.12.0 TF6701
## Page 111

PLC API Parameter Value Description MQTT_ERR_SUCCESS MQTT_ERR_NOMEM MQTT_ERR_PROTOCOL MQTT_ERR_INVAL MQTT_ERR_NO_CONN MQTT_ERR_CONN_REFUSED MQTT_ERR_NOT_FOUND MQTT_ERR_CONN_LOST MQTT_ERR_TLS MQTT_ERR_PAYLOAD_SIZE MQTT_ERR_NOT_SUPPORTED MQTT_ERR_AUTH MQTT_ERR_ACL_DENIED MQTT_ERR_UNKNOWN MQTT_ERR_ERRNO MQTT_ERR_EAI MQTT_ERR_PROXY MQTT_ERR_TLS_CA_NOTFOUND MQTT_ERR_TLS_CERT_NOTFOUND MQTT_ERR_TLS_KEY_NOTFOUND MQTT_ERR_TLS_CA_INVALID MQTT_ERR_TLS_CERT_INVALID MQTT_ERR_TLS_KEY_INVALID MQTT_ERR_TLS_VERIFY_FAIL MQTT_ERR_TLS_SETUP MQTT_ERR_TLS_HANDSHAKE_FAIL MQTT_ERR_TLS_CIPHER_INVALID MQTT_ERR_TLS_VERSION_INVALID MQTT_ERR_TLS_PSK_INVALID MQTT_ERR_TLS_CRL_NOTFOUND MQTT_ERR_TLS_CRL_INVALID MQTT_ERR_FINALIZE_DISCONNECT MQTT_ERR_BIND MQTT_ERR_BIND_ADDR_INUSE MQTT_ERR_BIND_ADDR_INVAL MQTT_ERR_CREATE MQTT_ERR_CREATE_TYPE MQTT_ERR_CONN MQTT_ERR_CONN_TIMEDOUT MQTT_ERR_CONN_HOSTUNREACH MQTT_ERR_TLS_CERT_EXPIRED MQTT_ERR_TLS_CN_MISMATCH 5.1.4 Parameter list Parameters that influence the MQTT Message Queue (FB_Iot Mqtt Message Queue, FB_Iot Mqtt5Message Queue) as well as the dynamic memory used for the MQTT messages (Twin CAT Router memory): TF6701 Version: 1.12.0 111
## Page 112

PLC API Name Type Default value Description c Max Size Of Mqtt Message UDINT 102400 Maximum size in bytes of an MQTT message that can be collected in the message queue. If the FB_Iot Mqtt Client receives an MQTT message that is too large, it will be completely discarded when trying to store it in the FB_Iot Mqtt Message Queue. If the FB_Iot Mqtt5Client receives such an MQTT message, it will first be reduced by all User Properties when it attempts to store it in the FB_Iot Mqtt5Message Queue. If this is not sufficient, the MQTT message is discarded completely. c Max Size Of Mqtt Message Que UDINT 1024000 Maximum size in bytes of an entire message ue queue including all collected MQTT messages. If the FB_Iot Mqtt Client receives a new MQTT message that would exceed the maximum size of the message queue, this message is completely discarded when it is attempted to be stored in the FB_Iot Mqtt Message Queue. If the FB_Iot Mqtt5Client receives such an MQTT message, it waits until there is space in the queue to receive this new message. c Max Entries In Mqtt Message Q UDINT 1000 Maximum number of messages in a message ueue queue. Parameters that influence the inputs of an MQTT client (FB_Iot Mqtt Client, FB_Iot Mqtt5Client): Name Type Default value Description c Size Of Mqtt Client Client Id UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the Client Id. c Size Of Mqtt Client Host Name UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the host name. c Size Of Mqtt Client Topic Prefix UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the topic prefix. c Size Of Mqtt Client User Name UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the user name. c Size Of Mqtt Client User Pwd UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the user password. c Size Of Mqtt Will Topic UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the Will-Topic. Parameters that influence the MQTT 5 properties: 112 Version: 1.12.0 TF6701
## Page 113

PLC API Name Type Default value Description c Size Of Mqtt5Content Type UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the content type. c Size Of Mqtt5Auth Method UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the authentication method. c Size Of Mqtt5Auth Data UDINT 4096 Maximum size in bytes of the authentication data. c Size Of Mqtt5Server Reference UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the server reference. c Size Of Mqtt5Reason String UDINT 256 Definition of the STRING size in bytes, which specifies the maximum length of the reason string. c Max Mqtt5User Props UINT 20 Maximum number of User Properties that can be received with an MQTT 5 message or sent with the help of FB_Iot Mqtt5User Properties. The processing of User Properties in the PLC real-time task cycle requires a certain amount of time depending on the quantity, which is why it is better to keep it low. 5.2 Tc3_Json Xml 5.2.1 Function blocks 5.2.1.1 FB_Json Dom Parser This function block is derived from the same internal function block as FB_Json Dyn Dom Parser [} 183] and thus offers the same interface. The two derived function blocks differ only in their internal memory management. FB_Json Dom Parser is optimized for the fast and efficient parsing and creation of JSON documents that are only changed a little. The function block FB_Json Dyn Dom Parser [} 183] is recommended for JSON documents to which many changes are made (e.g. the cyclic changing of a specific value in the JSON document). WARNING Use of router memory The function block occupies new memory with each change, e.g. with the methods Set Object() or Set Json(). As a result, the amount of router memory used can grow enormously after repeated actions. This allocated memory is only released again by calling the New Document [} 159]() or Parse Document [} 159]() methods. TF6701 Version: 1.12.0 113
## Page 114

PLC API Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Syntax FUNCTION_BLOCK FB_Json Dom Parser VAR_OUTPUT init Status : HRESULT; END_VAR Outputs Name Type init Status HRESULT 114 Version: 1.12.0 TF6701
## Page 115

PLC API Methods TF6701 Version: 1.12.0 115
## Page 116

PLC API Name Description Add Array Member [} 119] Adds an Array member to a JSON object. Add Base64Member [} 120] Adds a Base64 member to a JSON object. Add Bool Member [} 121] Adds a Bool member to a JSON object. Add Date Time Member [} 122] Adds a Date Time member to a JSON object. Add Dc Time Member [} 122] Adds a Dc Time member to a JSON object. Add Double Member [} 123] Adds a Double member to a JSON object. Add File Time Member [} 124] Adds a File Time member to a JSON object. Add Hex Binary Member [} 124] Adds a Hex Binary member to a JSON object. Add Int64Member [} 125] Adds an Int64 member to a JSON object. Add Int Member [} 126] Adds an Int member to a JSON object. Add Json Member [} 126] Adds a JSON member to a JSON object. Add Null Member [} 127] Adds a NULL member to a JSON object. Add Object Member [} 128] Adds an Object member to a JSON object. Add String Member [} 128] Adds a String member to a JSON object. Add Uint64Member [} 129] Adds an UInt64 member to a JSON object. Add Uint Member [} 130] Adds an UInt member to a JSON object. Array Begin [} 130] Returns the first element of an array. Array End [} 131] Returns the last element of an array. Clear Array [} 131] Deletes the contents of an array. Copy Document [} 132] Copies the contents of the DOM memory into a variable of data type STRING. Copy Json [} 133] Extracts a JSON object from a key and stores it in a variable of data type STRING. Copy String [} 134] Copies the value of a key into a variable of data type STRING. Find Member [} 135] Searches for a specific property in a JSON document. Find Member Path [} 136] Searches for a specific property in a JSON document (path-specific). Get Array Size [} 138] Returns the number of elements in a JSON array. Get Array Value [} 138] Returns the value at the current iterator position of an array. Get Array Value By Idx [} 139] Returns the value of an array at a specified index. Get Base64 [} 139] Decodes a Base64 value from a JSON property. Get Bool [} 140] Returns the value of a property of the data type BOOL. Get Date Time [} 140] Returns the value of a property of the data type DATE_AND_TIME. Get Dc Time [} 140] Returns the value of a property of the data type DCTIME. Get Document [} 141] Returns the content of the DOM memory as the data type STRING(255). Get Document Length [} 141] Returns the length of a JSON document in the DOM memory. Get Document Root [} 142] Returns the root node of a JSON document in the DOM memory. Get Double [} 142] Returns the value of a property of the data type LREAL. Get File Time [} 142] Returns the value of a property of the data type DCTIME. Get Hex Binary [} 143] Decodes the Hex Binary content of a property and writes it to a certain memory address, Get Int [} 144] Returns the value of a property of the data type DINT. Get Int64 [} 144] Returns the value of a property of the data type LINT. Get Json [} 144] Returns the value of a property of the data type STRING(255). Get Json Length [} 145] Returns the length of a property if this is a JSON document. 116 Version: 1.12.0 TF6701
## Page 117

PLC API Name Description Get Max Decimal Places [} 146] Returns the current setting for Max Decimal Places. Get Member Name [} 146] Returns the name of a JSON property member at the position of the current iterator, Get Member Value [} 146] Returns the value of a JSON property member at the position of the current iterator, Get String [} 147] Returns the value of a property of the data type STRING(255). Get String Length [} 148] Returns the length of a property if its value is a string. Get Type [} 148] Returns the type of a property value. Get Uint [} 149] Returns the value of a property of the data type UDINT. Get Uint64 [} 149] Returns the value of a property of the data type ULINT. Has Member [} 150] Checks whether a certain property is present in the DOM memory. Is Array [} 150] Checks whether a given property is an array. Is Base64 [} 151] Checks whether the value of a given property is of the data type Base64. Is Bool [} 151] Checks whether the value of a given property is of the data type BOOL. Is Double [} 152] Checks whether the value of a given property is of the data type Double (PLC: LREAL). Is False [} 152] Checks whether the value of a given property is FALSE. Is Hex Binary [} 153] Checks whether the value of a property is in the Hex Binary format. Is Int [} 153] Checks whether the value of a given property is of the data type Integer (PLC: DINT) . Is Int64 [} 154] Checks whether the value of a given property is of the data type LINT. Is ISO8601Time Format [} 154] Checks whether the value of a given property has a time format according to ISO8601. Is Null [} 154] Checks whether the value of a given property is NULL. Is Number [} 155] Checks whether the value of a given property is a numerical value. Is Object [} 155] Checks whether the given property is a further JSON object. Is String [} 156] Checks whether the value of a given property is of the data type STRING. Is True [} 156] Checks whether the value of a given property is TRUE. Is Uint [} 157] Checks whether the value of a given property is of the data type UDINT. Is Uint64 [} 157] Checks whether the value of a given property is of the data type ULINT. Load Document From File [} 118] Loads a JSON document from a file. Member Begin [} 158] Returns the first child element below a JSON property. Member End [} 158] Returns the last child element below a JSON property. New Document [} 159] Generates a new empty JSON document in the DOM memory. Next Array [} 159] Returns the next element in an array. Next Member Returns the next property in a JSON document. Parse Document [} 159] Loads a JSON object into the DOM memory for further processing. Popback Value Deletes the element at the end of an array. Pushback Base64Value [} 160] Appends a Base64 value to the end of an array. Pushback Bool Value [} 161] Appends a Base64 value to the end of an array. Pushback Date Time Value [} 162] Appends a value of the data type DATE_AND_TIME to the end of an array. Pushback Dc Time Value [} 162] Appends a value of the data type DCTIME to the end of an array. TF6701 Version: 1.12.0 117
## Page 118

PLC API Name Description Pushback Double Value [} 163] Appends a value of the data type Double to the end of an array. Pushback File Time Value [} 163] Appends a value of the data type FILETIME to the end of an array. Pushback Hex Binary Value [} 164] This method appends a Hex Binary-coded value to the end of an array. Pushback Int64Value [} 164] Appends a value of the data type Int64 to the end of an array. Pushback Int Value [} 165] Appends a value of the data type INT to the end of an array. Pushback Json Value [} 166] Appends a JSON document to the end of an array. Pushback Null Value [} 166] Appends a NULL value to the end of an array. Pushback String Value [} 167] Appends a value of the data type String to the end of an array. Pushback Uint64Value [} 167] Appends a value of the data type UInt64 to the end of an array. Pushback Uint Value [} 168] Appends a value of the data type UInt to the end of an array. Remove All Members [} 168] Removes all child elements from a given property. Remove Array [} 169] Deletes the value of the current array iterator. Remove Member [} 170] Deletes the property at the current iterator. Remove Member By Name [} 170] Removes a child element from a given property. Save Document To File [} 171] Saves a JSON document in a file. Set Array [} 173] Sets the value of a property to the type "Array". Set Base64 [} 173] Sets the value of a property to a Base64-coded value. Set Bool [} 174] Sets the value of a property to a value of the data type BOOL. Set Date Time [} 174] Sets the value of a property to a value of the data type DATE_AND_TIME. Set Dc Time [} 175] Sets the value of a property to a value of the data type DCTIME. Set Double [} 175] Sets the value of a property to a value of the data type Double. Set File Time [} 176] Sets the value of a property to a value of the data type FILETIME. Set Hex Binary [} 177] Sets the value of a property to a Hex Binary-coded value. Set Int [} 177] Sets the value of a property to a value of the data type INT Set Int64 [} 178] Sets the value of a property to a value of the data type Int64. Set Json [} 178] Inserts a further JSON document into the value of a property. Set Max Decimal Places [} 179] Sets the current setting for Max Decimal Places. Set Null [} 179] Sets the value of a property to the value NULL. Set Object [} 180] Sets the value of a property to the type "Object". Set String [} 180] Sets the value of a property to a value of the data type STRING. Set Uint [} 181] Sets the value of a property to a value of the data type UInt. Set Uint64 [} 182] Sets the value of a property to a value of the data type UInt64. Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4022 x86, x64, ARM Tc3_Json Xml 5.2.1.1.1 Load Document From File This method loads a JSON document from a file. 118 Version: 1.12.0 TF6701
## Page 119

PLC API A rising edge on the input parameter b Exec triggers the loading procedure. The asynchronous process is terminated as soon as the reference b Exec is set back to FALSE from the method. When the process ends, the return value of the method indicates whether the loading of the file was successful (TRUE) or failed (FALSE) for the duration of one call. Encoding Please note that the imported files must be formatted in UTF-8. Formats such as UTF-16 are not supported. Syntax METHOD Load Document From File : BOOL VAR_IN_OUT CONSTANT s File : STRING; END_VAR VAR_INPUT b Exec : REFERENCE TO BOOL; END_VAR VAR_OUTPUT hr Error Code: HRESULT; END_VAR Return value Name Type Load Document From File BOOL Inputs Name Type b Exec REFERENCE TO BOOL / Inputs/outputs Name Type s File STRING Outputs Name Type hr Error Code HRESULT Sample call: IF b Load THEN b Loaded := fb Json. Load Document From File(s File, b Load); END_IF 5.2.1.1.2 Add Array Member This method adds an array member to a JSON object. Syntax METHOD Add Array Member : SJson Value VAR_INPUT v : SJson Value; TF6701 Version: 1.12.0 119
## Page 120

PLC API END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR VAR_INPUT reserve : UDINT; END_VAR Return value Name Type Add Array Member SJson Value Inputs Name Type v SJson Value reserve UDINT / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Add Array Member(json Doc, 'Test Array', 0); 5.2.1.1.3 Add Base64Member This method adds a Base64 member to a JSON object. A structure, for example, can be addressed as an input parameter. The corresponding Base64 coding is done by the method. Syntax METHOD Add Base64Member : SJson Value VAR_INPUT v : SJson Value; p : PVOID; n : DINT; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Base64Member SJson Value 120 Version: 1.12.0 TF6701
## Page 121

PLC API Inputs Name Type v SJson Value p PVOID n DINT / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Base64 := fb Json. Add Base64Member(json Doc, 'Test Base64', ADR(st Struct), SIZEOF(st Struct)); 5.2.1.1.4 Add Bool Member This method adds a Bool member to a JSON object. Syntax METHOD Add Bool Member : SJson Value VAR_INPUT v : SJson Value; value : BOOL; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Bool Member SJson Value Inputs Name Type v SJson Value value BOOL / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Bool Member(json Doc, 'Test Bool', TRUE); TF6701 Version: 1.12.0 121
## Page 122

PLC API 5.2.1.1.5 Add Date Time Member This method adds a Date Time member to a JSON object. Syntax METHOD Add Date Time Member : SJson Value VAR_INPUT v : SJson Value; value : DATE_AND_TIME; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Date Time Member SJson Value Inputs Name Type v SJson Value value DATE_AND_TIME / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Date Time Member(json Doc, 'Test Date Time', DT#2018-11-22-12:12); 5.2.1.1.6 Add Dc Time Member This method adds a Dc Time member to a JSON object. Syntax METHOD Add Dc Time Member : SJson Value VAR_INPUT v : SJson Value; value : DCTIME; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR 122 Version: 1.12.0 TF6701
## Page 123

PLC API Return value Name Type Add Dc Time Member SJson Value Inputs Name Type v SJson Value value DCTIME / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Dc Time Member(json Doc, 'Test Dc Time', 1234); 5.2.1.1.7 Add Double Member This method adds a Double member to a JSON object. Syntax METHOD Add Double Member : SJson Value VAR_INPUT v : SJson Value; value : LREAL; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Double Member SJson Value Inputs Name Type v SJson Value value LREAL / Inputs/Outputs Name Type member STRING Sample call: TF6701 Version: 1.12.0 123
## Page 124

PLC API json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Double Member(json Doc, 'Test Double', 42.42); 5.2.1.1.8 Add File Time Member This method adds a File Time member to a JSON object. Syntax METHOD Add File Time Member : SJson Value VAR_INPUT v : SJson Value; value : FILETIME; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add File Time Member SJson Value Inputs Name Type v SJson Value value FILETIME / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add File Time Member(json Doc, 'Test File Time', ft Time); 5.2.1.1.9 Add Hex Binary Member This method adds a Hex Binary member to a JSON object. Syntax METHOD Add Hex Binary Member : SJson Value VAR_INPUT v : SJson Value; p : PVOID; n : DINT; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR 124 Version: 1.12.0 TF6701
## Page 125

PLC API Return value Name Type Add Hex Binary Member Sjson Value Inputs Name Type v Sjson Value p PVOID n DINT / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Hex Binary Member(json Doc, ‚Test Hex Binary‘, s Hex Binary, SIZEOF(s Hex Binary)); 5.2.1.1.10 Add Int64Member This method adds an Int64 member to a JSON object. Syntax METHOD Add File Time Member : Sjson Value VAR_INPUT v : Sjson Value; value : LINT; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Int64Member SJson Value Inputs Name Type v SJson Value value LINT / Inputs/Outputs Name Type member STRING TF6701 Version: 1.12.0 125
## Page 126

PLC API Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Int64Member(json Doc, 'Test Int64', 42); 5.2.1.1.11 Add Int Member This method adds an Int member to a JSON object. Syntax METHOD Add Int Member : SJson Value VAR_INPUT v : SJson Value; value : DINT; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Int Member SJson Value Inputs Name Type v SJson Value value DINT / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Int Member(json Doc, 'Test Int', 42); 5.2.1.1.12 Add Json Member This method adds a JSON member to a JSON object. Syntax METHOD Add Json Member: SJson Value VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT member : STRING; raw Json : STRING; END_VAR 126 Version: 1.12.0 TF6701
## Page 127

PLC API Return value Name Type Add Json Member SJson Value Inputs Name Type v SJson Value / Inputs/Outputs Name Type member STRING raw Json STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Json Member(json Doc, 'Test Json', s Json); 5.2.1.1.13 Add Null Member This method adds a NULL member to a JSON object. Syntax METHOD Add Null Member : SJson Value VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Null Member SJson Value Inputs Name Type v SJson Value / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Null Member(json Doc, 'Test Json'); TF6701 Version: 1.12.0 127
## Page 128

PLC API 5.2.1.1.14 Add Object Member This method adds an Object member to a JSON object. Syntax METHOD Add Object Member : SJson Value VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Object Member SJson Value Inputs Name Type v SJson Value / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Object Member(json Doc, 'Test Object'); 5.2.1.1.15 Add String Member This method adds a String member to a JSON object. Syntax METHOD Add String Member : SJson Value VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT member : STRING; value : STRING; END_VAR Return value Name Type Add String Member SJson Value 128 Version: 1.12.0 TF6701
## Page 129

PLC API Inputs Name Type v SJson Value / Inputs/Outputs Name Type member STRING value STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add String Member(json Doc, 'Test String', 'Test'); 5.2.1.1.16 Add Uint64Member This method adds an UInt64 member to a JSON object. Syntax METHOD Add Uint64Member : SJson Value VAR_INPUT v : SJson Value; value : ULINT; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Uint64Member SJson Value Inputs Name Type v SJson Value value ULINT / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Uint64Member(json Doc, 'Test Uint64', 42); TF6701 Version: 1.12.0 129
## Page 130

PLC API 5.2.1.1.17 Add Uint Member This method adds an UInt member to a JSON object. Syntax METHOD Add Uint Member : SJson Value VAR_INPUT v : SJson Value; value : UDINT; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Add Uint Member SJson Value Inputs Name Type v SJson Value value UDINT / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Mem := fb Json. Add Uint Member(json Doc, 'Test Uint', 42); 5.2.1.1.18 Array Begin This method returns the first element of an array and can be used together with the methods Array End() and Next Array() for iteration through a JSON array. Syntax METHOD Array Begin : SJson AIterator VAR_INPUT v : SJson Value; END_VAR Return value Name Type Array Begin SJson AIterator 130 Version: 1.12.0 TF6701
## Page 131

PLC API Inputs Name Type v SJson Value Sample call: json Iterator := fb Json. Array Begin(json Array); json Iterator End := fb Json. Array End(json Array); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Array Value(json Iterator); json Iterator := fb Json. Next Array(json Iterator); END_WHILE 5.2.1.1.19 Array End This method returns the last element of an array and can be used together with the methods Array Begin() and Next Array() for iteration through a JSON array. Syntax METHOD Array End : SJson AIterator VAR_INPUT v : SJson Value; END_VAR Return value Name Type Array End SJson AIterator Inputs Name Type v SJson Value Sample call: json Iterator := fb Json. Array Begin(json Array); json Iterator End := fb Json. Array End(json Array); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Array Value(json Iterator); json Iterator := fb Json. Next Array(json Iterator); END_WHILE 5.2.1.1.20 Clear Array This method deletes the content of an array. Syntax METHOD Clear Array : BOOL VAR_INPUT v : SJson Value; i : SJson AIterator; END_VAR TF6701 Version: 1.12.0 131
## Page 132

PLC API Return value Name Type Clear Array BOOL Inputs Name Type v SJson Value i SJson AIterator Sample call: The following JSON document is to be loaded into the DOM memory: s Message := '{"serial Number":"123","battery Voltage":"1547m V","click Type":"SINGLE", "array": ["Hello",2,3]}'; The values of the JSON array "array" are to be deleted. First of all, the JSON document is searched iteratively for the "array" property, after which all elements of the array are deleted by calling the Clear Array() method. json Doc := fb Json. Parse Document(s Message); json Iterator := fb Json. Member Begin(json Doc); json Iterator End := fb Json. Member End(json Doc); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Member Name(json Iterator); json Value := fb Json. Get Member Value(json Iterator); IF s Name = 'array' THEN json Array Iterator := fb Json. Array Begin(json Value); fb Json. Clear Array(json Value, json Array Iterator); END_IF json Iterator := fb Json. Next Member(json Iterator); END_WHILE 5.2.1.1.21 Copy Document This method copies the contents of the DOM memory into a variable of data type STRING, which can have any length. The method returns the length of the string (including null termination). If the destination buffer is too small, it is emptied by a null termination and returned as length 0. Syntax METHOD Copy Document : UDINT VAR_INPUT n Doc : DINT; END_VAR VAR_IN_OUT CONSTANT p Doc : STRING; END_VAR Return value Name Type Copy Document UDINT Inputs Name Type n Doc DINT 132 Version: 1.12.0 TF6701
## Page 133

PLC API / Inputs/Outputs Name Type p Doc STRING Sample call: n Len := fb Json. Copy Document(s Json, SIZEOF(s Json)); 5.2.1.1.22 Copy From Syntax METHOD Copy From : SJson Value VAR_INPUT v : SJson Value; w : SJson Value; END_VAR Return value Name Type Copy From SJson Value Inputs Name Type v SJson Value w SJson Value 5.2.1.1.23 Copy Json This method extracts a JSON object from a key and stores it in a variable of data type STRING. This STRING can have any length. The method returns the length of the copied JSON object (including null termination). If the destination buffer is too small, it is emptied by a null termination and returned as length 0. Syntax METHOD Copy Json : UDINT VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT p Doc : STRING; n Doc : UDINT; END_VAR Return value Name Type Copy Json UDINT TF6701 Version: 1.12.0 133
## Page 134

PLC API Inputs Name Type v SJson Value / Inputs/Outputs Name Type p Doc STRING n Doc STRING Sample call: The following JSON document is to be loaded into the DOM memory: s Message := ' {"serial Number":"123","meta":{"battery Voltage":"1547m V","click Type":"SINGLE"}}'; The value of the JSON object "meta" is to be extracted and stored in a variable of data type STRING. First the JSON document is searched iteratively for the property "meta", then its value or sub-object is extracted by calling the method Copy Json(). json Doc := fb Json. Parse Document(s Message); json Iterator := fb Json. Member Begin(json Doc); json Iterator End := fb Json. Member End(json Doc); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Member Name(json Iterator); json Value := fb Json. Get Member Value(json Iterator); IF s Name = 'meta' THEN fb Json. Copy Json(json Value, s String, SIZEOF(s String)); END_IF json Iterator := fb Json. Next Member(json Iterator); END_WHILE After this run, the s String variable has the following content: {"battery Voltage":"1547m V","click Type":"SINGLE"} 5.2.1.1.24 Copy String This method copies the value of a key into a variable of the data type STRING, which can be of any length. The method returns the length of the copied string (including null termination). If the destination buffer is too small, it is emptied by a null termination and returned as length 0. Syntax METHOD Copy String : UDINT VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT p Str : STRING; n Str : UDINT; END_VAR Return value Name Type Copy String UDINT 134 Version: 1.12.0 TF6701
## Page 135

PLC API Inputs Name Type v SJson Value / Inputs/Outputs Name Type p Str STRING n Str UDINT Sample call: The following JSON document is to be loaded into the DOM memory: s Message := ' {"serial Number":"123","battery Voltage":"1547m V","click Type":"SINGLE"}'; The value of the key "click Type" is to be extracted and stored in a variable of data type STRING. First, the JSON document is iteratively searched for the property "click Type". json Doc := fb Json. Parse Document(s Message); json Iterator := fb Json. Member Begin(json Doc); json Iterator End := fb Json. Member End(json Doc); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Member Name(json Iterator); json Value := fb Json. Get Member Value(json Iterator); IF s Name = 'click Type' THEN fb Json. Copy String(json Value, s String, SIZEOF(s String)); END_IF json Iterator := fb Json. Next Member(json Iterator); END_WHILE After this run, the s String variable has the following content: SINGLE 5.2.1.1.25 Exception Raised Syntax METHOD Exception Raised : BOOL Return value Name Type Exception Raised BOOL 5.2.1.1.26 Find Member This method searches for a specific property in a JSON document and returns it. 0 is returned if no corresponding property is found. TF6701 Version: 1.12.0 135
## Page 136

PLC API Syntax METHOD Find Member : SJson Value VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Find Member SJson Value Inputs Name Type v SJson Value / Inputs/Outputs Name Type member STRING Sample call: json Prop := fb Json. Find Member(json Doc, 'Property Name'); 5.2.1.1.27 Find Member Path This method searches for a specific property in a JSON document and returns it. The property is specified according to its path in the document. 0 is returned if no corresponding property is found. Syntax METHOD Find Member Path : SJson Value VAR_INPUT v : SJson Value END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Find Member Path SJson Value Inputs Name Type v SJson Value 136 Version: 1.12.0 TF6701
## Page 137

PLC API / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member Path(json Doc, s Path); Accessing nested objects works according to the scheme a/b/c, to find a variable in a JSON hierarchy. The call for the variable c of the following JSON document is: json Prop := fb Json. Find Member Path(json Doc, 'a/b/c'); { "a":{ "b":{ "c": 123 } } } Support for arrays The method supports JSON documents with arrays from Twin CAT version >3.1.4024.35. The # character can be used to access elements of an array. json Prop := fb Json. Find Member Path(json Doc, '#1/Third#2'); [ { "First": 4 }, { "Second": 12, "Third": [ 1, 2, 3 ], "Fourth": { "a": true } }, ] The example call accesses the second element of the outer array (#1), then the third element of the array under the sub-element Third. Treatment of special cases Inserting the ~ character provides special treatment within a path. The following table lists the different possibilities. Expression Result Sample ~0 ~ is used as a character in the Test/Hello~0123 becomes Test/ string. Hello~123 ~1 The expression is replaced by the Test/Hello~1123 becomes Test/ character /, which is not interpreted Hello/123 as a separator, but as part of the string. ~2 The expression is replaced by the Test/Hello~2123 becomes Test/ character # , which is not Hello#123 interpreted as an array index, but as part of the string. TF6701 Version: 1.12.0 137
## Page 138

PLC API 5.2.1.1.28 Get Array Size This method returns the number of elements in a JSON array. Syntax METHOD Get Array Size : UDINT VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Array Size UDINT Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); n Size := fb Json. Get Array Size(json Array); 5.2.1.1.29 Get Array Value This method returns the value at the current iterator position of an array. Syntax METHOD Get Array Value : SJson Value VAR_INPUT i : SJson AIterator; END_VAR Return value Name Type Get Array Value SJson Value Inputs Name Type i SJson AIterator Sample call: json Iterator := fb Json. Array Begin(json Array); json Iterator End := fb Json. Array End(json Array); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Array Value(json Iterator); json Iterator := fb Json. Next Array(json Iterator); END_WHILE 138 Version: 1.12.0 TF6701
## Page 139

PLC API 5.2.1.1.30 Get Array Value By Idx This method returns the value of an array in a specified index. Syntax METHOD Get Array Value By Idx : SJson Value VAR_INPUT v : SJson Value; idx : UDINT; END_VAR Return value Name Type Get Array Value By Idx SJson Value Inputs Name Type v SJson Value idx UDINT Sample call: json Value := fb Json. Get Array Value By Idx(json Array, 1); 5.2.1.1.31 Get Base64 This method decodes a Base64 value from a JSON property. If the content of a data structure, for example, is located behind the Base64 value, the decoded content can also be placed on an identical structure again. Syntax METHOD Get Base64: DINT VAR_INPUT v : SJson Value; p : PVOID; n : DINT; END_VAR Return value Name Type Get Base64 DINT Inputs Name Type v SJson Value p PVOID n DINT TF6701 Version: 1.12.0 139
## Page 140

PLC API Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Base64 := fb Json. Find Member(json Doc, 'base64'); n Size := fb Json. Get Base64(json Base64, ADR(st Struct), SIZEOF(st Struct)); 5.2.1.1.32 Get Bool This method returns the value of a property of the data type BOOL. Syntax METHOD Get Bool : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Bool BOOL Inputs Name Type v SJson Value 5.2.1.1.33 Get Date Time This method returns the value of a property of the data type DATE_AND_TIME. Syntax METHOD Get Date Time : DATE_AND_TIME VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Date Time DATE_AND_TIME Inputs Name Type v SJson Value 5.2.1.1.34 Get Dc Time 140 Version: 1.12.0 TF6701
## Page 141

PLC API This method returns the value of a property of the data type DCTIME. Syntax METHOD Get Dc Time : DCTIME VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Dc Time DCTIME Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); dc Time := fb Json. Get Dc Time(json Prop); 5.2.1.1.35 Get Document This method returns the content of the DOM memory as the data type STRING(255). With longer strings, the method will return a NULL string. In this case the method Copy Document [} 132]() must be used. Syntax METHOD Get Document : STRING(255) Return value Name Type Get Document STRING(255) Sample call: s Json := fb Json. Get Document(); 5.2.1.1.36 Get Document Length This method returns the length of a JSON document in the DOM memory. Syntax METHOD Get Document Length: UDINT TF6701 Version: 1.12.0 141
## Page 142

PLC API Return value Name Type Get Document Length UDINT Sample call: n Len := fb Json. Get Document Length(); 5.2.1.1.37 Get Document Root This method returns the root node of a JSON document in the DOM memory. Syntax METHOD Get Document Root : SJson Value Return value Name Type Get Document Root SJson Value Sample call: json Root := fb Json. Get Document Root(); 5.2.1.1.38 Get Double This method returns the value of a property of the data type LREAL. Syntax METHOD Get Double : LREAL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Double LREAL Inputs Name Type v SJson Value 5.2.1.1.39 Get File Time 142 Version: 1.12.0 TF6701
## Page 143

PLC API This method returns the value of a property of the data type DCTIME. Syntax METHOD Get File Time : FILETIME VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get File Time FILETIME Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); file Time := fb Json. Get File Time(json Prop); 5.2.1.1.40 Get Hex Binary This method decodes the Hex Binary content of a property and writes it to a certain memory address, e.g. to a data structure. Syntax METHOD Get Hex Binary : DINT VAR_INPUT v : SJson Value; p : PVOID; n : DINT; END_VAR Return value Name Type Get Hex Binary DINT Inputs Name Type v SJson Value p PVOID n DINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); n Len := fb Json. Get Hex Binary(json Prop, ADR(st Struct), SIZEOF(st Struct)); TF6701 Version: 1.12.0 143
## Page 144

PLC API 5.2.1.1.41 Get Int This method returns the value of a property of the data type DINT. Syntax METHOD Get Int : DINT VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Int DINT Inputs Name Type v SJson Value 5.2.1.1.42 Get Int64 This method returns the value of a property of the data type LINT. Syntax METHOD Get Int64 : LINT VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Int64 LINT Inputs Name Type v SJson Value 5.2.1.1.43 Get Json 144 Version: 1.12.0 TF6701
## Page 145

PLC API This method returns the value of a property as data type STRING(255), if this is a JSON document itself. With longer strings, the method will return a NULL string. In this case the method Copy Json [} 133]() must be used. Syntax METHOD Get Json : STRING(255) VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Json STRING(255) Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); s Json := fb Json. Get Json(json Prop); 5.2.1.1.44 Get Json Length This method returns the length of a property if this is a JSON document. Syntax METHOD Get Json Length : UDINT VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Json Length UDINT Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); n Len := fb Json. Get Json Length(json Prop); TF6701 Version: 1.12.0 145
## Page 146

PLC API 5.2.1.1.45 Get Max Decimal Places This method returns the current setting for Max Decimal Places. This influences the number of decimal places in the case of floating-point numbers. Syntax METHOD Get Max Decimal Places : DINT Return value Name Type Get Max Decimal Places DINT Sample call: n Dec := fb Json. Get Max Decimal Places(); 5.2.1.1.46 Get Member Name This method returns the name of a JSON property member at the position of the current iterator, e.g. during the iteration of a child element of a JSON property with the methods Member Begin(), Member End() and Next Member(). Syntax METHOD Get Member Name : STRING(255) VAR_INPUT i : SJson Iterator; END_VAR Return value Name Type Get Member Name STRING(255) Inputs Name Type i SJson Iterator Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Iterator := fb Json. Member Begin(json Doc); json Iterator End := fb Json. Member End(json Doc); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Member Name(json Iterator); json Iterator := fb Json. Next Member(json Iterator); END_WHILE 5.2.1.1.47 Get Member Value 146 Version: 1.12.0 TF6701
## Page 147

PLC API This method returns the value of a JSON property member at the position of the current iterator, e.g. during the iteration of a child element of a JSON property with the methods Member Begin(), Member End() and Next Member(). Syntax METHOD Get Member Value : SJson Value VAR_INPUT i : SJson Iterator; END_VAR Return value Name Type Get Member Value SJson Value Inputs Name Type i SJson Iterator Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Iterator := fb Json. Member Begin(json Doc); json Iterator End := fb Json. Member End(json Doc); WHILE json Iterator <> json Iterator End DO json Value := fb Json. Get Member Value(json Iterator); json Iterator := fb Json. Next Member(json Iterator); END_WHILE 5.2.1.1.48 Get String This method returns the value of a property of the data type STRING(255). With longer strings, the method will return a NULL string. In this case the method Copy String [} 134]() must be used. Syntax METHOD Get String : STRING(255) VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get String STRING(255) Inputs Name Type v SJson Value TF6701 Version: 1.12.0 147
## Page 148

PLC API 5.2.1.1.49 Get String Length This method returns the length of a property if its value is a string. Syntax METHOD Get String Length : UDINT VAR_INPUT v : SJson Value END_VAR Return value Name Type Get String Length UDINT Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); n Len := fb Json. Get String Length(json Prop); 5.2.1.1.50 Get Type This method returns the type of a property value. The return value can assume one of the values of the enum EJson Type. Syntax METHOD Get Type : EJson Type VAR_INPUT v : SJson Value END_VAR TYPE EJson Type : ( e Null Type := 0, e False Type := 1, e True Type := 2, e Object Type := 3, e Array Type := 4, e String Type := 5, e Number Type := 6 ) DINT; Return value Name Type Get Type EJson Type 148 Version: 1.12.0 TF6701
## Page 149

PLC API Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); e Json Type := fb Json. Get Type(json Prop); 5.2.1.1.51 Get Uint This method returns the value of a property of the data type UDINT. Syntax METHOD Get Uint : UDINT VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Uint UDINT Inputs Name Type v SJson Value 5.2.1.1.52 Get Uint64 This method returns the value of a property of the data type ULINT. Syntax METHOD Get Uint64 : ULINT VAR_INPUT v : SJson Value; END_VAR Return value Name Type Get Uint64 ULINT TF6701 Version: 1.12.0 149
## Page 150

PLC API Inputs Name Type v SJson Value 5.2.1.1.53 Has Member This method checks whether a certain property is present in the DOM memory. If the property is present the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Has Member : BOOL VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Has Member BOOL Inputs Name Type v SJson Value / Inputs/Outputs Name Type member STRING Sample call: b Has Member := fb Json. Has Member(json Doc, 'Property Name'); 5.2.1.1.54 Is Array This method checks whether a given property is an array. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Array : BOOL VAR_INPUT v : SJson Value; END_VAR 150 Version: 1.12.0 TF6701
## Page 151

PLC API Return value Name Type Is Array BOOL Inputs Name Type v SJson Value 5.2.1.1.55 Is Base64 This method checks whether the value of a given property is of the data type Base64. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Base64 : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is Base64 BOOL Inputs Name Type v SJson Value 5.2.1.1.56 Is Bool This method checks whether the value of a given property is of the data type BOOL. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Bool : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is Bool BOOL TF6701 Version: 1.12.0 151
## Page 152

PLC API Inputs Name Type v SJson Value 5.2.1.1.57 Is Double This method checks whether the value of a given property is of the data type Double (PLC: LREAL). If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Double : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is Double BOOL Inputs Name Type v SJson Value 5.2.1.1.58 Is False This method checks whether the value of a given property is FALSE. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is False : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is False BOOL Inputs Name Type v SJson Value 152 Version: 1.12.0 TF6701
## Page 153

PLC API 5.2.1.1.59 Is Hex Binary This method checks whether the value of a property is in the Hex Binary format. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Hex Binary: BOOL VAR_INPUT v : SJson Value END_VAR Return value Name Type Is Hex Binary BOOL Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); b Ret := fb Json. Is Hex Binary(json Prop); 5.2.1.1.60 Is Int This method checks whether the value of a given property is of the data type Integer (PLC: DINT). If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Int : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is Int BOOL Inputs Name Type v SJson Value TF6701 Version: 1.12.0 153
## Page 154

PLC API 5.2.1.1.61 Is Int64 This method checks whether the value of a given property is of the data type LINT. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Int64 : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is Int64 BOOL Inputs Name Type v SJson Value 5.2.1.1.62 Is ISO8601Time Format This method checks whether the value of a given property has a time format according to ISO8601. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is ISO8601Time Format : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is ISO8601Time Format BOOL Inputs Name Type v SJson Value 5.2.1.1.63 Is Null 154 Version: 1.12.0 TF6701
## Page 155

PLC API This method checks whether the value of a given property is NULL. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Null : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is Null BOOL Inputs Name Type v SJson Value 5.2.1.1.64 Is Number This method checks whether the value of a given property is a numerical value. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Number : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is Number BOOL Inputs Name Type v SJson Value 5.2.1.1.65 Is Object This method checks whether the given property is a further JSON object. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Object : BOOL VAR_INPUT v : SJson Value; END_VAR TF6701 Version: 1.12.0 155
## Page 156

PLC API Return value Name Type Is Object BOOL Inputs Name Type v SJson Value 5.2.1.1.66 Is String This method checks whether the value of a given property is of the data type STRING. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is String : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is String BOOL Inputs Name Type v SJson Value 5.2.1.1.67 Is True This method checks whether the value of a given property is TRUE. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is True : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is True BOOL 156 Version: 1.12.0 TF6701
## Page 157

PLC API Inputs Name Type v SJson Value 5.2.1.1.68 Is Uint This method checks whether the value of a given property is of the data type UDINT. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Uint : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is Uint BOOL Inputs Name Type v SJson Value 5.2.1.1.69 Is Uint64 This method checks whether the value of a given property is of the data type ULINT. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Uint64 : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Is Uint64 BOOL Inputs Name Type v SJson Value TF6701 Version: 1.12.0 157
## Page 158

PLC API 5.2.1.1.70 Member Begin This method returns the first child element below a JSON property and can be used by a JSON property together with the methods Member End() and Next Member() for iteration. Syntax METHOD Member Begin : SJson Iterator VAR_INPUT v : SJson Value; END_VAR Return value Name Type Member Begin SJson Iterator Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Iterator := fb Json. Member Begin(json Doc); json Iterator End := fb Json. Member End(json Doc); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Member Name(json Iterator); json Iterator := fb Json. Next Member(json Iterator); END_WHILE 5.2.1.1.71 Member End This method returns the last child element below a JSON property and can be used by a JSON property together with the methods Member Begin() and Next Member() for iteration. Syntax METHOD Member End : SJson Iterator VAR_INPUT v : SJson Value; END_VAR Return value Name Type Member End SJson Iterator Inputs Name Type v SJson Value 158 Version: 1.12.0 TF6701
## Page 159

PLC API Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Iterator := fb Json. Member Begin(json Doc); json Iterator End := fb Json. Member End(json Doc); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Member Name(json Iterator); json Iterator := fb Json. Next Member(json Iterator); END_WHILE 5.2.1.1.72 New Document This method generates a new empty JSON document in the DOM memory. Syntax METHOD New Document : SJson Value Sample call: json Doc := fb Json. New Document(); Return value Name Type New Document SJson Value 5.2.1.1.73 Next Array Syntax METHOD Next Array : SJson AIterator VAR_INPUT v : SJson AIterator; END_VAR Return value Name Type Next Array SJson AIterator Inputs Name Type i SJson Alterator 5.2.1.1.74 Parse Document TF6701 Version: 1.12.0 159
## Page 160

PLC API This method loads a JSON object into the DOM memory for further processing. The JSON object takes the form of a string and is transferred to the method as an input. A reference to the JSON document in the DOM memory is returned to the caller. Syntax METHOD Parse Document : SJson Value VAR_IN_OUT CONSTANT s Json : STRING; END_VAR Return value Name Type Parse Document SJson Value Inputs Name Type s Json STRING Sample call: json Doc := fb Json. Parse Document(s Json String); 5.2.1.1.75 Pushback Base64Value This method appends a Base64 value to the end of an array. A structure, for example, can be addressed as an input parameter. The corresponding Base64 coding is done by the method. Syntax METHOD Pushback Base64Value : SJson Value VAR_INPUT v : SJson Value; p : PVOID; n : DINT; END_VAR Return value Name Type Pushback Base64Value SJson Value Inputs Name Type v s Json Value p PVOID n DINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Base64Value(json Array, ADR(st Struct), SIZEOF(st Struct)); 160 Version: 1.12.0 TF6701
## Page 161

PLC API 5.2.1.1.76 Pushback Bool Value This method appends a value of the data type BOOL to the end of an array. Syntax METHOD Pushback Bool Value : SJson Value VAR_INPUT v : SJson Value; value : BOOL; END_VAR Return value Name Type Pushback Bool Value SJson Value Inputs Name Type v s Json Value value BOOL Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Bool Value(json Array, TRUE); 5.2.1.1.77 Pushback Copy Value This method adds a JSON document from the memory of a FB_Json Dom Parser [} 113] to the end of an array. Syntax METHOD Pushback Copy Value : SJson Value VAR_INPUT v : SJson Value; json : SJson Value; END_VAR Return value Name Type Pushback Copy Value SJson Value Inputs Name Type v SJson Value json SJson Value TF6701 Version: 1.12.0 161
## Page 162

PLC API Sample call: json Copy:=fb Json Create. New Document(); fb Json Create. Add Int Member(json Copy,'a',1); fb Json Create. Add Int Member(json Copy,'b',2); json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Copy Value(json Array, json Copy); 5.2.1.1.78 Pushback Date Time Value This method appends a value of the data type DATE_AND_TIME to the end of an array. Syntax METHOD Pushback Date Time Value : SJson Value VAR_INPUT v : SJson Value; value : DATE_AND_TIME; END_VAR Return value Name Type Pushback Date Time Value SJson Value Inputs Name Type v s Json Value value DATE_AND_TIME Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Date Time Value(json Array, dt Time); 5.2.1.1.79 Pushback Dc Time Value This method appends a value of the data type DCTIME to the end of an array. Syntax METHOD Pushback Dc Time Value : SJson Value VAR_INPUT v : SJson Value; value : DCTIME; END_VAR Return value Name Type Pushback Dc Time Value SJson Value 162 Version: 1.12.0 TF6701
## Page 163

PLC API Inputs Name Type v s Json Value value DCTIME Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Dc Time Value(json Array, dc Time); 5.2.1.1.80 Pushback Double Value This method appends a value of the data type Double to the end of an array. Syntax METHOD Pushback Double Value : SJson Value VAR_INPUT v : SJson Value; value : LREAL; END_VAR Return value Name Type Pushback Double Value SJson Value Inputs Name Type v s Json Value value LREAL Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Double Value(json Array, 42.42); 5.2.1.1.81 Pushback File Time Value This method appends a value of the data type FILETIME to the end of an array. Syntax METHOD Pushback File Time Value : SJson Value VAR_INPUT v : SJson Value; value : FILETIME; END_VAR TF6701 Version: 1.12.0 163
## Page 164

PLC API Return value Name Type Pushback File Time Value SJson Value Inputs Name Type v s Json Value value FILETIME Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback File Time Value(json Array, file Time); 5.2.1.1.82 Pushback Hex Binary Value This method appends a Hex Binary value to the end of an array. The coding in the Hex Binary format is executed by the method. A data structure, for example, can be used as the source. Syntax METHOD Pushback Hex Binary Value : SJson Value VAR_INPUT v : SJson Value; p : PVOID; n : DINT; END_VAR Return value Name Type Pushback Hex Binary Value SJson Value Inputs Name Type v s Json Value p PVOID n DINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Hex Binary Value(json Array, ADR(st Struct), SIZEOF(st Struct)); 5.2.1.1.83 Pushback Int64Value 164 Version: 1.12.0 TF6701
## Page 165

PLC API This method appends a value of the data type Int64 to the end of an array. Syntax METHOD Pushback Int64Value : SJson Value VAR_INPUT v : SJson Value; value : LINT; END_VAR Return value Name Type Pushback Int64Value SJson Value Inputs Name Type v s Json Value value LINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Int64Value(json Array, 42); 5.2.1.1.84 Pushback Int Value This method appends a value of the data type INT to the end of an array. Syntax METHOD Pushback Int Value : SJson Value VAR_INPUT v : SJson Value; value : DINT; END_VAR Return value Name Type Pushback Int Value SJson Value Inputs Name Type v s Json Value value DINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Int Value(json Array, 42); TF6701 Version: 1.12.0 165
## Page 166

PLC API 5.2.1.1.85 Pushback Json Value This method appends a JSON document that exists as a STRING in the PLC to the end of an array. Syntax METHOD Pushback Json Value : SJson Value VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT raw Json : STRING; END_VAR Return value Name Type Pushback Json Value SJson Value Inputs Name Type v SJson Value / Inputs/Outputs Name Type raw Json STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Json Value(json Array, s Json); 5.2.1.1.86 Pushback Null Value This method appends a NULL value to the end of an array. Syntax METHOD Pushback Null Value : SJson Value VAR_INPUT v : SJson Value; END_VAR Return value Name Type Pushback Null Value SJson Value 166 Version: 1.12.0 TF6701
## Page 167

PLC API Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Null Value(json Array); 5.2.1.1.87 Pushback String Value This method appends a value of the data type DCTIME to the end of an array. Syntax METHOD Pushback String Value : SJson Value VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT value : STRING; END_VAR Return value Name Type Pushback String Value SJson Value Inputs Name Type v SJson Value / Inputs/Outputs Name Type value STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback String Value(json Array, s String); 5.2.1.1.88 Pushback Uint64Value This method appends a value of the data type UInt64 to the end of an array. TF6701 Version: 1.12.0 167
## Page 168

PLC API Syntax METHOD Pushback Uint64Value : SJson Value VAR_INPUT v : SJson Value; value : ULINT; END_VAR Return value Name Type Pushback Uint64Value SJson Value Inputs Name Type v SJson Value value ULINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Uint64Value(json Array, 42); 5.2.1.1.89 Pushback Uint Value This method appends a value of the data type UInt to the end of an array. Syntax METHOD Pushback Uint Value : SJson Value VAR_INPUT v : SJson Value; value : UDINT; END_VAR Return value Name Type Pushback Uint Value SJson Value Inputs Name Type v SJson Value value UDINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Array := fb Json. Find Member(json Doc, 'array'); json Value := fb Json. Pushback Uint Value(json Array, 42); 5.2.1.1.90 Remove All Members 168 Version: 1.12.0 TF6701
## Page 169

PLC API This method removes all child elements from a given property. Syntax METHOD Remove All Members : BOOL VAR_INPUT v : SJson Value; END_VAR Return value Name Type Remove All Members BOOL Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); b Removed := fb Json. Remove All Members(json Prop); 5.2.1.1.91 Remove Array This method deletes the value of the current array iterator. Syntax METHOD Remove Array : BOOL VAR_INPUT v : SJson Value; i : SJson AIterator; END_VAR Return value Name Type Remove Array BOOL Inputs Name Type v SJson Value i SJson AIterator Sample call: The following JSON document is to be loaded into the DOM memory: s Message := '{"serial Number":"123","battery Voltage":"1547m V","click Type":"SINGLE", "array": ["Hello",2,3]}'; The first array position is to be deleted. First of all, the JSON document is searched iteratively for the "array" property, after which the first element of the array is removed by calling the Remove Array() method. json Doc := fb Json. Parse Document(s Message); json Iterator := fb Json. Member Begin(json Doc); json Iterator End := fb Json. Member End(json Doc); TF6701 Version: 1.12.0 169
## Page 170

PLC API WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Member Name(json Iterator); json Value := fb Json. Get Member Value(json Iterator); IF s Name = 'array' THEN json Array Iterator := fb Json. Array Begin(json Value); fb Json. Remove Array(json Value, json Array Iterator); END_IF json Iterator := fb Json. Next Member(json Iterator); END_WHILE 5.2.1.1.92 Remove Member This method deletes the property at the current iterator. Syntax METHOD Remove Member : BOOL VAR_INPUT v : SJson Value; i : SJson Iterator; keep Order : BOOL; END_VAR Return value Name Type Remove Member BOOL Inputs Name Type v SJson Value i SJson Iterator keep Order BOOL Sample call: The following JSON document is to be loaded into the DOM memory: s Message := '{"serial Number":"123","battery Voltage":"1547m V","click Type":"SINGLE", "array": ["Hello",2,3]}'; The "array" property is to be deleted. First of all, the JSON document is searched for the "array" property, after which the property is removed. json Doc := fb Json. Parse Document(s Message); json Iterator := fb Json. Member Begin(json Doc); json Iterator End := fb Json. Member End(json Doc); WHILE json Iterator <> json Iterator End DO s Name := fb Json. Get Member Name(json Iterator); IF s Name = 'array' THEN fb Json. Remove Member(json Doc, json Iterator); END_IF json Iterator := fb Json. Next Member(json Iterator); END_WHILE 5.2.1.1.93 Remove Member By Name 170 Version: 1.12.0 TF6701
## Page 171

PLC API This method removes a child element from a given property. The element is referenced by its name. Syntax METHOD Remove Member By Name : BOOL VAR_INPUT v : SJson Value; keep Order : BOOL; END_VAR VAR_IN_OUT CONSTANT member : STRING; END_VAR Return value Name Type Remove Member By Name BOOL Inputs Name Type v SJson Value keep Order BOOL / Inputs/Outputs Name Type member STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Remove Member By Name(json Prop, 'Child Name'); 5.2.1.1.94 Save Document To File This method saves a JSON document in a file. A rising edge at the input parameter b Exec triggers the saving procedure. The asynchronous process is terminated as soon as the reference b Exec is set back to FALSE from the method. When the process ends, the return value of the method indicates for one call whether saving of the file was successful (TRUE) or failed (FALSE). Syntax METHOD Save Document To File : BOOL VAR_IN_OUT CONSTANT s File : STRING; END_VAR VAR_INPUT b Exec : REFERENCE TO BOOL; END_VAR VAR_OUTPUT hr Error Code: HRESULT; END_VAR TF6701 Version: 1.12.0 171
## Page 172

PLC API Return value Name Type Save Document To File BOOL Inputs Name Type b Exec REFERENCE TO BOOL / Inputs/Outputs Name Type s File STRING Outputs Name Type hr Error Code HRESULT Sample call: IF b Save THEN b Saved := fb Json. Save Document To File(s File, b Save); END_IF 5.2.1.1.95 Set Ads Provider This method sets the context in which the file accesses are processed when loading and saving the JSON documents. If no ADS provider is specified, the current task is used. Syntax METHOD Set Ads Provider : BOOL VAR_INPUT oid : OTCID; END_VAR Return value Name Type Description Set Ads Provider BOOL The method returns TRUE if the setting of the ADS provider was successful. Inputs Name Type Description oid OTCID Object ID of the task. Sample call: b Test := fb Json. Set Ads Provider(02010030); 172 Version: 1.12.0 TF6701
## Page 173

PLC API 5.2.1.1.96 Set Array This method sets the value of a property to the type "Array". New values can now be added to the array with the Pushback methods. Syntax METHOD Set Array : SJson Value VAR_INPUT v : SJson Value; END_VAR Return value Name Type Set Array SJson Value Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Array(json Prop); 5.2.1.1.97 Set Base64 This method sets the value of a property to a Base64-coded value. A data structure, for example, can be used as the source. Coding to the Base64 format takes place inside the method. Syntax METHOD Set Base64 : SJson Value VAR_INPUT v : SJson Value; p : PVOID; n : DINT; END_VAR Return value Name Type Set Base64 SJson Value TF6701 Version: 1.12.0 173
## Page 174

PLC API Inputs Name Type v SJson Value p PVOID n DINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Base64(json Prop, ADR(st Struct), SIZEOF(st Struct)); 5.2.1.1.98 Set Bool This method sets the value of a property to a value of the data type BOOL. Syntax METHOD Set Bool : SJson Value VAR_INPUT v : SJson Value; value : BOOL; END_VAR Return value Name Type Set Bool SJson Value Inputs Name Type v SJson Value value BOOL Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Bool(json Prop, TRUE); 5.2.1.1.99 Set Date Time This method sets the value of a property to a value of the data type DATE_AND_TIME. Syntax METHOD Set Date Time : SJson Value VAR_INPUT v : SJson Value; value : DATE_AND_TIME; END_VAR 174 Version: 1.12.0 TF6701
## Page 175

PLC API Return value Name Type Set Date Time SJson Value Inputs Name Type v SJson Value value DATE_AND_TIME Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Date Time(json Prop, dt Time); 5.2.1.1.100 Set Dc Time This method sets the value of a property to a value of the data type DCTIME. Syntax METHOD Set Dc Time : SJson Value VAR_INPUT v : SJson Value; value : DCTIME; END_VAR Return value Name Type Set Dc Time SJson Value Inputs Name Type v SJson Value value DCTIME Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Dc Time(json Prop, dc Time); 5.2.1.1.101 Set Double This method sets the value of a property to a value of the data type Double. TF6701 Version: 1.12.0 175
## Page 176

PLC API Syntax METHOD Set Double : SJson Value VAR_INPUT v : SJson Value; value : LREAL; END_VAR Return value Name Type Set Double SJson Value Inputs Name Type v SJson Value value LREAL Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Double(json Prop, 42.42); 5.2.1.1.102 Set File Time This method sets the value of a property to a value of the data type FILETIME. Syntax METHOD Set File Time : SJson Value VAR_INPUT v : SJson Value; value : FILETIME; END_VAR Return value Name Type Set File Time SJson Value Inputs Name Type v SJson Value value FILETIME Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set File Time(json Prop, file Time); 176 Version: 1.12.0 TF6701
## Page 177

PLC API 5.2.1.1.103 Set Hex Binary This method sets the value of a property to a Hex Binary-coded value. A data structure, for example, can be used as the source. Coding to the Hex Binary format takes place inside the method. Syntax METHOD Set Hex Binary : SJson Value VAR_INPUT v : SJson Value; p : PVOID; n : DINT; END_VAR Return value Name Type Set Hex Binary SJson Value Inputs Name Type v SJson Value p PVOID n DINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Hex Binary(json Prop, ADR(st Struct), SIZEOF(st Struct)); 5.2.1.1.104 Set Int This method sets the value of a property to a value of the data type INT. Syntax METHOD Set Int : SJson Value VAR_INPUT v : SJson Value; value : DINT; END_VAR Return value Name Type Set Int SJson Value TF6701 Version: 1.12.0 177
## Page 178

PLC API Inputs Name Type v SJson Value value DINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Int(json Prop, 42); 5.2.1.1.105 Set Int64 This method sets the value of a property to a value of the data type Int64. Syntax METHOD Set Int64 : SJson Value VAR_INPUT v : SJson Value; value : LINT; END_VAR Return value Name Type Set Int64 SJson Value Inputs Name Type v SJson Value value LINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Int64(json Prop, 42); 5.2.1.1.106 Set Json This method inserts a further JSON document into the value of a property. Syntax METHOD Set Json : SJson Value VAR_INPUT v : SJson Value; END_VAR VAR_IN_OUT CONSTANT raw Json : STRING; END_VAR 178 Version: 1.12.0 TF6701
## Page 179

PLC API Return value Name Type Set Json SJson Value Inputs Name Type v SJson Value / Inputs/Outputs Name Type raw Json STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Json(json Prop, s Json); 5.2.1.1.107 Set Max Decimal Places This function determines the number of decimal places after which a floating-point number is truncated. Syntax METHOD Set Max Decimal Places VAR_INPUT dp : DINT; END_VAR Inputs Name Type dp DINT Sample call: n Dec := fb Json. Set Max Decimal Places(); 5.2.1.1.108 Set Null This method sets the value of a property to the value NULL. Syntax METHOD Set Null : SJson Value VAR_INPUT v : SJson Value; END_VAR TF6701 Version: 1.12.0 179
## Page 180

PLC API Return value Name Type Set Null SJson Value Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Null(json Prop); 5.2.1.1.109 Set Object This method sets the value of a property to the type "Object". This enables the nesting of JSON documents. Syntax METHOD Set Object : SJson Value VAR_INPUT v : SJson Value; END_VAR Return value Name Type Set Object SJson Value Inputs Name Type v SJson Value Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Object(json Prop); 5.2.1.1.110 Set String This method sets the value of a property to a value of the data type STRING. Syntax METHOD Set String : SJson Value VAR_INPUT v : SJson Value; END_VAR 180 Version: 1.12.0 TF6701
## Page 181

PLC API VAR_IN_OUT CONSTANT value : STRING; END_VAR Return value Name Type Set String SJson Value Inputs Name Type v SJson Value / Inputs/Outputs Name Type value STRING Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set String(json Prop, 'Hello World'); 5.2.1.1.111 Set Uint This method sets the value of a property to a value of the data type UInt. Syntax METHOD Set Uint: SJson Value VAR_INPUT v : SJson Value; value : UDINT; END_VAR Return value Name Type Set Uint SJson Value Inputs Name Type v SJson Value value UDINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Uint(json Prop, 42); TF6701 Version: 1.12.0 181
## Page 182

PLC API 5.2.1.1.112 Set Uint64 This method sets the value of a property to a value of the data type UInt64. Syntax METHOD Set Uint64 : SJson Value VAR_INPUT v : SJson Value; value : ULINT; END_VAR Return value Name Type Set Uint64 SJson Value Inputs Name Type v SJson Value value ULINT Sample call: json Doc := fb Json. Parse Document(s Existing Json Document); json Prop := fb Json. Find Member(json Doc, 'property'); json Value := fb Json. Set Uint64(json Prop, 42); 5.2.1.1.113 Swap This method swaps the content of two pointers. Syntax METHOD Swap : BOOL VAR_INPUT v : SJson Value; w : SJson Value; END_VAR; END_VAR Return value Name Type Swap BOOL Inputs Name Type v SJson Value w SJson Value 182 Version: 1.12.0 TF6701
## Page 183

PLC API 5.2.1.2 FB_Json Dyn Dom Parser This function block is derived from the same internal function block as FB_Json Dom Parser [} 113] and thus offers the same interface. The two derived function blocks differ only in their internal memory management. The FB_Json Dyn Dom Parser is optimized for JSON documents where many changes are made and the JSON document is not released in between. It releases the allocated memory after an action has been executed, e.g. in the methods Set Object() or Set Json(). This flexibility results in greater overhead, allowing the FB_Json Dom Parser [} 113] to improve the performance. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Syntax FUNCTION_BLOCK FB_Json Dyn Dom Parser VAR_OUTPUT init Status : HRESULT; END_VAR Outputs Name Type init Status HRESULT Methods All methods can be found in FB_Json Dom Parser [} 113]. Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4024.7 x86, x64, ARM Tc3_Json Xml 3.3.8.0 5.2.1.3 FB_Json Sax Reader Syntax FUNCTION_BLOCK FB_Json Sax Reader VAR_OUTPUT init Status : HRESULT; END_VAR TF6701 Version: 1.12.0 183
## Page 184

PLC API Outputs Name Type init Status HRESULT Methods Name Description Decode Base64 [} 184] Converts a Base64-formated string to binary data. Decode Date Time [} 185] Creates a PLC variable of the data type DATE_AND_TIME or DT from a standardized ISO8601 time format (e.g. YYYY-MM-DDThh:mm:ss). Decode Dc Time [} 186] Creates a PLC variable of the data type DCTIME from a standardized ISO8601 time format (e.g. YYYY-MM-DDThh:mm:ss). Decode File Time [} 186] Creates a PLC variable of the data type FILETIME from a standardized ISO8601 time format (e.g. YYYY-MM-DDThh:mm:ss). Decode Hex Binary [} 187] Converts a string containing hexadecimal values into binary data. Is Base64 [} 188] Checks whether the transferred string corresponds to the Base64 format. Is Hex Binary [} 188] Checks whether the transferred string consists of hexadecimal values. Is ISO8601Time Format Checks whether the transferred string corresponds to the standardized ISO8601 time format. [} 189] Parse [} 189] Starts the SAX reader parsing process. Parse Values [} 190] Starts the SAX reader parsing process. Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4022 x86, x64, ARM Tc3_Json Xml 5.2.1.3.1 Decode Base64 This method converts a Base64-formated string to binary data. If the conversion was successful the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Decode Base64 : BOOL VAR_INPUT s Base64 : STRING; p Bytes : POINTER TO BYTE; n Bytes : REFERENCE TO DINT; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Decode Base64 BOOL 184 Version: 1.12.0 TF6701
## Page 185

PLC API Inputs Name Type s Base64 STRING p Bytes POINTER TO BYTE n Bytes REFERENCE TO DINT Outputs Name Type hr Error Code HRESULT Sample call: b Success := fb Json. Decode Base64('SGVsb G8g VHdpbk NBVA==', ADR(byte Array), byte Array Size); 5.2.1.3.2 Decode Date Time This method enables the generation of a PLC variable of the type DATE_AND_TIME or DT from a standardized ISO8601 time format (e.g. YYYY-MM-DDThh:mm:ss). DT corresponds to the number of seconds starting from the date 01.01.1970. If the conversion was successful the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Decode Date Time : BOOL VAR_IN_OUT CONSTANT s DT : STRING; END_VAR VAR_OUTPUT n DT : DATE_AND_TIME; hr Error Code : HRESULT; END_VAR Return value Name Type Decode Date Time BOOL / Inputs/Outputs Name Type s DT STRING Outputs Name Type n DT DATE_AND_TIME hr Error Code HRESULT Sample call: b Success := fb Json. Decode Date Time('2017-08-09T06:54:00', n DT => date Time); TF6701 Version: 1.12.0 185
## Page 186

PLC API 5.2.1.3.3 Decode Dc Time This method enables the generation of a PLC variable of the type DCTIME from a standardized ISO8601 time format (e.g. YYYY-MM-DDThh:mm:ss). DCTIME corresponds to the number of nanoseconds starting from the date 01.01.2000. If the conversion was successful the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Decode Dc Time : BOOL VAR_IN_OUT CONSTANT s DC : STRING; END_VAR VAR_OUTPUT n DC : DCTIME; hr Error Code : HRESULT; END_VAR Return value Name Type Decode Dc Time BOOL / Inputs/Outputs Name Type s DC STRING Outputs Name Type n DC DCTIME hr Error Code HRESULT Sample call: b Success := fb Json. Decode Dc Time('2017-08-09T06:54:00', n Dc => dc Time); 5.2.1.3.4 Decode File Time This method enables the generation of a PLC variable of the type FILETIME from a standardized ISO8601 time format (e.g. YYYY-MM-DDThh:mm:ss). FILETIME corresponds to the number of nanoseconds starting from the date 01.01.1601 – measured in 100 nanoseconds. If the conversion was successful the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Decode Date Time : BOOL VAR_IN_OUT CONSTANT s FT : STRING; END_VAR VAR_OUTPUT 186 Version: 1.12.0 TF6701
## Page 187

PLC API n FT : FILETIME; hr Error Code : HRESULT; END_VAR Return value Name Type Decode Date Time BOOL / Inputs/Outputs Name Type s FT STRING Outputs Name Type n FT FILETIME hr Error Code HRESULT Sample call: b Success := fb Json. Decode File Time('2017-08-09T06:54:00', n FT => file Time); 5.2.1.3.5 Decode Hex Binary This method converts a string containing hexadecimal values into binary data. If the conversion was successful the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Decode Hex Binary : BOOL VAR_IN_OUT CONSTANT s Hex : STRING; END_VAR VAR_INPUT p Bytes : POINTER TO BYTE; n Bytes : REFERENCE TO DINT; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Decode Hex Binary BOOL Inputs Name Type p Bytes POINTER TO BYTE n Bytes REFERENCE TO DINT TF6701 Version: 1.12.0 187
## Page 188

PLC API / Inputs/Outputs Name Type s Hex STRING Outputs Name Type hr Error Code HRESULT Sample call: b Success := fb Json. Decode Hex Binary('ABCEF93A', ADR(byte Array), byte Array Size); 5.2.1.3.6 Is Base64 This method checks whether the transferred string corresponds to the Base64 format. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Base64 : BOOL VAR_IN_OUT CONSTANT s Base64 : STRING; END_VAR Return value Name Type Is Base64 BOOL / Inputs/Outputs Name Type s Base64 STRING Sample call: b Is Base64 := fb Json. Is Base64('SGVsb G8g VHdpbk NBVA=='); 5.2.1.3.7 Is Hex Binary This method checks whether the transferred string consists of hexadecimal values. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is Hex Binary : BOOL VAR_IN_OUT CONSTANT s Hex : STRING; END_VAR 188 Version: 1.12.0 TF6701
## Page 189

PLC API Return value Name Type Is Hex Binary BOOL / Inputs/Outputs Name Type s Hex STRING Sample call: b Success := fb Json. Is Hex Binary('ABCEF93A'); 5.2.1.3.8 Is ISO8601Time Format This method checks whether the transferred string corresponds to the standardized ISO8601 time format. If that is the case, the method returns TRUE, otherwise it returns FALSE. Syntax METHOD Is ISO8601Time Format : BOOL VAR_IN_OUT CONSTANT s DT : STRING; END_VAR Return value Name Type Is ISO8601Time Format BOOL / Inputs/Outputs Name Type s DT STRING Sample call: b Success := fb Json. Is ISO8601Time Format('2017-08-09T06:54:00'); 5.2.1.3.9 Parse This method starts the SAX reader parsing procedure. The JSON object to be parsed and a reference to a function block, which was derived from the interface ITc Json Sax Handler, are transferred as input parameters. This function block is then used for the callback methods of the SAX reader. Syntax METHOD Parse : BOOL VAR_IN_OUT CONSTANT s Json : STRING; END_VAR TF6701 Version: 1.12.0 189
## Page 190

PLC API VAR_INPUT ip Hdl : ITc Json Sax Handler; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Parse BOOL Inputs Name Type ip Hdl ITc Json Sax Handler / Inputs/Outputs Name Type s Json STRING Outputs Name Type hr Error Code HRESULT 5.2.1.3.10 Parse Values This method starts the SAX reader parsing procedure. The JSON object to be parsed and a reference to a function block, which was derived from the interface ITc Json Sax Values, are transferred as input parameters. This function block is then used for the callback methods of the SAX reader. What is special about this method is that exclusively values are taken into account in the callback methods, i.e. there are no On Key() or On Start Object() callbacks. Syntax METHOD Parse Values : BOOL VAR_IN_OUT CONSTANT s Json : STRING; END_VAR VAR_INPUT ip Hdl : ITc Json Sax Values; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Parse Values BOOL 190 Version: 1.12.0 TF6701
## Page 191

PLC API Inputs Name Type ip Hdl ITc Json Sax Values / Inputs/Outputs Name Type s Json STRING Outputs Name Type hr Error Code HRESULT 5.2.1.4 FB_Json Sax Writer Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Syntax FUNCTION_BLOCK FB_Json Sax Writer VAR_OUTPUT init Status : HRESULT; END_VAR Outputs Name Type init Status HRESULT TF6701 Version: 1.12.0 191
## Page 192

PLC API Methods 192 Version: 1.12.0 TF6701
## Page 193

PLC API Name Description Add Base64 [} 194] Adds a value of the data type Base64 to a property. Add Bool [} 194] Adds a value of the data type BOOL to a property. Add Date Time [} 195] Adds a value of the data type DATE_AND_TIME to a property. Add Dc Time [} 195] Adds a value of the data type DCTIME to a property. Add Dint [} 195] Adds a value of the data type DINT to a property. Add File Time [} 196] Adds a value of the data type FILETIME to a property. Add Hex Binary [} 196] Adds a Hex Binary value to a property. Add Key [} 197] Adds a new property key at the current position of the SAX Writer. Add Key Bool [} 197] Creates a new property key and at the same time a value of the data type BOOL. Add Key Date Time [} 198] Creates a new property key and at the same time a value of the data type DATE_AND_TIME. Add Key Dc Time [} 198] Creates a new property key and at the same time a value of the data type DCTIME. Add Key File Time [} 199] Creates a new property key and at the same time a value of the data type FILETIME. Add Key Lreal [} 199] Creates a new property key and at the same time a value of the data type LREAL. Add Key Null [} 200] Creates a new property key and initializes its value with null. Add Key Number [} 200] Creates a new property key and at the same time a value of the data type DINT. Add Key String [} 201] Creates a new property key and at the same time a value of the data type STRING. Add Lint [} 201] Adds a value of the data type LINT to a property. Add Lreal [} 202] Adds a value of the data type LREAL to a property. Add Null [} 202] Adds the value null to a property. Add Raw Array [} 202] Adds a valid JSON array to a given property as a value. Add Raw Object [} 203] Adds a valid JSON object to a given property as a value. Add Real [} 203] Adds a value of the data type REAL to a property. Add String [} 204] Adds a value of the data type STRING to a property. Add Udint [} 204] Adds a value of the data type UDINT to a property. Add Ulint [} 204] Adds a value of the data type ULINT to a property. Copy Document [} 205] Copies the contents of the JSON object currently created with the SAX Writer into a target variable of the data type STRING. End Array [} 206] Creates the end of a started JSON array and inserts it at the current position of the SAX Writer. End Object [} 206] Creates the end of a started JSON object and inserts it at the current position of the SAX Writer. Get Document [} 206] Returns the content of the JSON object that is currently created with the SAX Writer and returns it as data type STRING(255). Get Document Length [} 207] Returns the length of the JSON object that is currently created with the SAX Writer and returns it as data type UDINT. Get Max Decimal Places [} 207] Is Complete Reset Document [} 208] Resets the JSON object currently created with the SAX Writer. Set Max Decimal Places [} 208] TF6701 Version: 1.12.0 193
## Page 194

PLC API Name Description Start Array [} 208] Creates the start of a new JSON array and inserts it at the current position of the SAX Writer. Start Object [} 209] Creates the start of a new JSON object and inserts it at the current position of the SAX Writer. Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4022 x86, x64, ARM Tc3_Json Xml 5.2.1.4.1 Add Base64 This method adds a value of the data type Base64 to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Base64 VAR_INPUT p Bytes : Pointer TO BYTE; n Bytes : DINT; END_VAR Inputs Name Type p Bytes POINTER TO BYTE n Bytes DINT 5.2.1.4.2 Add Bool This method adds a value of the data type BOOL to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Bool VAR_INPUT value : BOOL; END_VAR Inputs Name Type value BOOL Sample call: fb Json. Add Key('b Switch'); fb Json. Add Bool(TRUE); 194 Version: 1.12.0 TF6701
## Page 195

PLC API 5.2.1.4.3 Add Date Time This method adds a value of the data type DATE_AND_TIME to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Date Time VAR_INPUT value : DATE_AND_TIME; END_VAR Inputs Name Type value DATE_AND_TIME Sample call: fb Json. Add Key('Timestamp'); fb Json. Add Date Time(dt Time); // dt Time is of type DATE_AND_TIME 5.2.1.4.4 Add Dc Time This method adds a value of the data type DCTIME to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Dc Time VAR_INPUT value : DCTIME; END_VAR Inputs Name Type value DCTIME Sample call: fb Json. Add Key('Timestamp'); fb Json. Add Dc Time(dc Time); // dc Time is of type DCTIME 5.2.1.4.5 Add Dint This method adds a value of the data type DINT to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. TF6701 Version: 1.12.0 195
## Page 196

PLC API Syntax METHOD Add Dint VAR_INPUT value : DINT; END_VAR Inputs Name Type value DINT Sample call: fb Json. Add Key('n Number'); fb Json. Add Dint(42); 5.2.1.4.6 Add File Time This method adds a value of the data type FILETIME to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add File Time VAR_INPUT value : FILETIME; END_VAR Inputs Name Type value FILETIME Sample call: fb Json. Add Key('Timestamp'); fb Json. Add File Time(ft Time); // ft Time is of type FILETIME 5.2.1.4.7 Add Hex Binary This method adds a hex binary value to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Hex Binary VAR_INPUT p Bytes : POINTER TO BYTE; n Bytes : DINT; END_VAR 196 Version: 1.12.0 TF6701
## Page 197

PLC API Inputs Name Type p Bytes POINTER TO BYTE n Bytes DINT Sample call: fb Json. Add Key('Hex Binary'); fb Json. Add Hex Binary(ADR(byte Hex Bin), SIZEOF(byte Hex Bin)); 5.2.1.4.8 Add Key This method adds a new property key at the current position of the SAX writer. The value of the new property is usually set afterwards. This can be done using one of the following methods, for example: Add Base64 [} 194], Add Bool [} 194], Add Date Time [} 195], Add Dc Time [} 195], Add Dint [} 195], Add File Time [} 196], Add Hex Binary [} 196], Add Lint [} 201], Add Lreal [} 202], Add Null [} 202], Add Raw Array [} 202], Add Raw Object [} 203], Add Real [} 203], Add String [} 204], Add Udint [} 204], Add Ulint [} 204]. Syntax METHOD Add Key VAR_IN_OUT CONSTANT key : STRING; END_VAR / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key('Property Name'); 5.2.1.4.9 Add Key Bool This method creates a new property key and at the same time a value of the data type BOOL. Syntax METHOD Add Key Bool VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : BOOL; END_VAR Inputs Name Type value BOOL TF6701 Version: 1.12.0 197
## Page 198

PLC API / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Bool('b Switch', TRUE); 5.2.1.4.10 Add Key Date Time This method creates a new property key and at the same time a value of the data type DATE_AND_TIME. Syntax METHOD Add Key Date Time VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : DATE_AND_TIME; END_VAR Inputs Name Type value DATE_AND_TIME / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Date Time('Timestamp', dt Time); 5.2.1.4.11 Add Key Dc Time This method creates a new property key and at the same time a value of the data type DCTIME. Syntax METHOD Add Key Dc Time VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : DCTIME; END_VAR 198 Version: 1.12.0 TF6701
## Page 199

PLC API Inputs Name Type value DCTIME / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Dc Time('Timestamp', dc Time); 5.2.1.4.12 Add Key File Time This method creates a new property key and at the same time a value of the data type FILETIME. Syntax METHOD Add Key File Time VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : FILETIME; END_VAR Inputs Name Type value FILETIME / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key File Time('Timestamp', ft Time); 5.2.1.4.13 Add Key Lreal This method creates a new property key and at the same time a value of the data type LREAL. Syntax METHOD Add Key Lreal VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : LREAL; END_VAR TF6701 Version: 1.12.0 199
## Page 200

PLC API Inputs Name Type value LREAL / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Lreal('Property Name', 42.42); 5.2.1.4.14 Add Key Null This method creates a new property key and initializes its value with null. Syntax METHOD Add Key Null VAR_IN_OUT CONSTANT key : STRING; END_VAR / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Null('Property Name'); 5.2.1.4.15 Add Key Number This method creates a new property key and at the same time a value of the data type DINT. Syntax METHOD Add Key Number VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : DINT; END_VAR Inputs Name Type value DINT 200 Version: 1.12.0 TF6701
## Page 201

PLC API / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Number('Property Name', 42); 5.2.1.4.16 Add Key String This method creates a new property key and at the same time a value of the data type STRING. Syntax METHOD Add Key String VAR_IN_OUT CONSTANT key : STRING; value : STRING; END_VAR / Inputs/Outputs Name Type key STRING value STRING Sample call: fb Json. Add Key String('Property Name', 'Hello World'); 5.2.1.4.17 Add Lint This method adds a value of the data type LINT to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Lint VAR_INPUT value : LINT; END_VAR Inputs Name Type value LINT Sample call: fb Json. Add Key('Property Name'); fb Json. Add Lint(42); TF6701 Version: 1.12.0 201
## Page 202

PLC API 5.2.1.4.18 Add Lreal This method adds a value of the data type LREAL to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Lreal VAR_INPUT value : LREAL; END_VAR Inputs Name Type value LREAL Sample call: fb Json. Add Key('Property Name'); fb Json. Add Lreal(42.42); 5.2.1.4.19 Add Null This method adds the value null to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Null Sample call: fb Json. Add Key('Property Name'); fb Json. Add Null(); 5.2.1.4.20 Add Raw Array This method adds a valid JSON array to a given property as a value. The array to be added must be in a valid JSON format and may only be added if the SAX Writer is at a correspondingly valid position, e.g. directly after a preceding Add Key() [} 197], Start Array() [} 208] or as the first call after a Reset Document() [} 208]. Syntax METHOD Add Raw Array VAR_IN_OUT CONSTANT raw Json : STRING; END_VAR 202 Version: 1.12.0 TF6701
## Page 203

PLC API Return value Name Type Add Raw Array BOOL / Inputs/Outputs Name Type raw Json STRING Sample call: fb Json. Add Key('Property Name'); fb Json. Add Raw Array('[1, 2, {"x":42, "y":42}, 4'); 5.2.1.4.21 Add Raw Object This method adds a valid JSON object to a given property as a value. The object to be added must be in a valid JSON format and may only be added if the SAX Writer is in an appropriately valid position, e.g. directly after a preceding Add Key() [} 197], Start Array() [} 208] or as the first call after a Reset Document() [} 208]. Syntax METHOD Add Raw Object VAR_IN_OUT CONSTANT raw Json : STRING; END_VAR / Inputs/Outputs Name Type raw Json STRING Sample call: fb Json. Add Key('Property Name'); fb Json. Add Raw Object('{"x":42, "y":42}'); 5.2.1.4.22 Add Real This method adds a value of the data type REAL to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Real VAR_INPUT value : REAL; END_VAR Inputs Name Type value REAL TF6701 Version: 1.12.0 203
## Page 204

PLC API Sample call: fb Json. Add Key('Property Name'); fb Json. Add Real(42.42); 5.2.1.4.23 Add String This method adds a value of the data type STRING to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add String VAR_IN_OUT CONSTANT value : STRING; END_VAR / Inputs/Outputs Name Type value STRING Sample call: fb Json. Add Key('Property Name'); fb Json. Add String('Hello World'); 5.2.1.4.24 Add Udint This method adds a value of the data type UDINT to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. Syntax METHOD Add Udint VAR_INPUT value : UDINT; END_VAR Inputs Name Type value UDINT Sample call: fb Json. Add Key('Property Name'); fb Json. Add Udint(42); 5.2.1.4.25 Add Ulint This method adds a value of the data type ULINT to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 197]. 204 Version: 1.12.0 TF6701
## Page 205

PLC API Syntax METHOD Add Ulint VAR_INPUT value : ULINT; END_VAR Inputs Name Type value ULINT Sample call: fb Json. Add Key('Property Name'); fb Json. Add Ulint(42); 5.2.1.4.26 Copy Document This method copies the content of the current JSON object created with the SAX Writer to a target variable of the data type STRING, which can be of any length. The method returns the length of the string (including null termination). If the destination buffer is too small, it is emptied by a null termination and returned as length 0. Syntax METHOD Copy Document : UDINT VAR_IN_OUT CONSTANT p Doc : STRING; END_VAR VAR_INPUT n Doc : UDINT; END_VAR VAR_OUTPUT hr Error Code: HRESULT; END_VAR Return value Name Type Copy Document UDINT Inputs Name Type n Doc UDINT / Inputs/Outputs Name Type p Doc STRING Outputs Name Type hr Error Code HRESULT Sample call: TF6701 Version: 1.12.0 205
## Page 206

PLC API fb Json. Copy Document(s Target String, SIZEOF(s Target String)); 5.2.1.4.27 End Array This method generates the end of a started JSON array ("square closing bracket") and inserts it at the current position of the SAX writer. Syntax METHOD End Array : HRESULT Return value Name Type End Array HRESULT Sample call: fb Json. End Array(); 5.2.1.4.28 End Object This method generates the end of a started JSON object ("curly closing bracket") and inserts it at the current position of the SAX writer. Syntax METHOD End Object : HRESULT Return value Name Type End Object HRESULT Sample call: fb Json. End Object(); 5.2.1.4.29 Get Document This method returns the content of the JSON object that is currently created with the SAX Writer and returns it as data type STRING(255). The maximum size of the string returned by the method is 255 characters. With longer strings, the method will return a NULL string. In this case the method Copy Document [} 205]() must be used. Syntax METHOD Get Document : STRING(255) VAR_OUTPUT hr Error Code: HRESULT; END_VAR 206 Version: 1.12.0 TF6701
## Page 207

PLC API Return value Name Type Get Document STRING(255) Outputs Name Type hr Error Code HRESULT Sample call: s Target String := fb Json. Get Document(); 5.2.1.4.30 Get Document Length This method returns the length of the JSON object that is currently created with the SAX Writer and returns it as data type UDINT. Syntax METHOD Get Document Length : UDINT VAR_OUTPUT hr Error Code: HRESULT; END_VAR Return value Name Type Get Document Length UDINT Outputs Name Type hr Error Code HRESULT Sample call: n Length := fb Json. Get Document Length(); 5.2.1.4.31 Get Max Decimal Places This function queries the currently set number of decimal places after which a floating point number is truncated. Syntax METHOD Get Max Decimal Places : DINT TF6701 Version: 1.12.0 207
## Page 208

PLC API Return value Name Type Description Get Max Decimal Places DINT The currently set number of digits after which a floating point number is truncated. 5.2.1.4.32 Reset Document This method resets the JSON object currently created with the SAX writer. Syntax METHOD Reset Document : HRESULT Return value Name Type Reset Document HRESULT Sample call: fb Json. Reset Document(); 5.2.1.4.33 Set Max Decimal Places This function determines the number of decimal places after which a floating-point number is truncated. Syntax METHOD Set Max Decimal Places : HRESULT VAR_INPUT decimal Places: DINT; END_VAR Return value Name Type Set Max Decimal Places HRESULT Inputs Name Type Description decimal Pla DINT The number of decimal places to be set after which a floating- ces point number is truncated. 5.2.1.4.34 Start Array 208 Version: 1.12.0 TF6701
## Page 209

PLC API This method generates the start of a new JSON array ("square opening bracket") and inserts it at the current position of the SAX writer. Syntax METHOD Start Array : HRESULT Return value Name Type Start Array HRESULT Sample call: fb Json. Start Array(); 5.2.1.4.35 Start Object This method generates the start of a new JSON object ("curly opening bracket") and inserts it at the current position of the SAX writer. Syntax METHOD Start Object : HRESULT Return value Name Type Start Object HRESULT Sample call: fb Json. Start Object(); 5.2.1.5 FB_Json Sax Pretty Writer This function block has a difference from FB_Json Sax Writer [} 191]: it adds matching whitespaces for better readability of a JSON document. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. TF6701 Version: 1.12.0 209
## Page 210

PLC API Syntax FUNCTION_BLOCK FB_Json Sax Pretty Writer VAR_OUTPUT init Status : HRESULT; END_VAR Outputs Name Type init Status HRESULT Methods Name Description Set Format Options Adjusts the general formatting options for an instance of the [<=>] FB_Json Sax Pretty Writer. [} 224] Set Indent [} 225] Customizes the indentation. All other methods can be found at FB_Json Sax Writer [} 191]. Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4022 x86, x64, ARM Tc3_Json Xml 5.2.1.5.1 Add Base64 This method adds a value of the data type Base64 to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Base64 VAR_INPUT p Bytes : Pointer TO BYTE; n Bytes : DINT; END_VAR Inputs Name Type p Bytes POINTER TO BYTE n Bytes DINT 5.2.1.5.2 Add Bool This method adds a value of the data type BOOL to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. 210 Version: 1.12.0 TF6701
## Page 211

PLC API Syntax METHOD Add Bool VAR_INPUT value : BOOL; END_VAR Inputs Name Type value BOOL Sample call: fb Json. Add Key('b Switch'); fb Json. Add Bool(TRUE); 5.2.1.5.3 Add Date Time This method adds a value of the data type DATE_AND_TIME to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Date Time VAR_INPUT value : DATE_AND_TIME; END_VAR Inputs Name Type value DATE_AND_TIME Sample call: fb Json. Add Key('Timestamp'); fb Json. Add Date Time(dt Time); // dt Time is of type DATE_AND_TIME 5.2.1.5.4 Add Dc Time This method adds a value of the data type DCTIME to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Dc Time VAR_INPUT value : DCTIME; END_VAR Inputs Name Type value DCTIME TF6701 Version: 1.12.0 211
## Page 212

PLC API Sample call: fb Json. Add Key('Timestamp'); fb Json. Add Dc Time(dc Time); // dc Time is of type DCTIME 5.2.1.5.5 Add Dint This method adds a value of the data type DINT to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Dint VAR_INPUT value : DINT; END_VAR Inputs Name Type value DINT Sample call: fb Json. Add Key('n Number'); fb Json. Add Dint(42); 5.2.1.5.6 Add File Time This method adds a value of the data type FILETIME to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add File Time VAR_INPUT value : FILETIME; END_VAR Inputs Name Type value FILETIME Sample call: fb Json. Add Key('Timestamp'); fb Json. Add File Time(ft Time); // ft Time is of type FILETIME 5.2.1.5.7 Add Hex Binary 212 Version: 1.12.0 TF6701
## Page 213

PLC API This method adds a hex binary value to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Hex Binary VAR_INPUT p Bytes : POINTER TO BYTE; n Bytes : DINT; END_VAR Inputs Name Type p Bytes POINTER TO BYTE n Bytes DINT Sample call: fb Json. Add Key('Hex Binary'); fb Json. Add Hex Binary(ADR(byte Hex Bin), SIZEOF(byte Hex Bin)); 5.2.1.5.8 Add Key This method adds a new property key at the current position of the SAX writer. The value of the new property is usually set afterwards. This can be done using one of the following methods, for example: Add Base64 [} 210], Add Bool [} 210], Add Date Time [} 211], Add Dc Time [} 211], Add Dint [} 212], Add File Time [} 212], Add Hex Binary [} 212], Add Lint [} 217], Add Lreal [} 218], Add Null [} 218], Add Raw Array [} 218], Add Raw Object [} 219], Add Real [} 219], Add String [} 220], Add Udint [} 220], Add Ulint [} 221]. Syntax METHOD Add Key VAR_IN_OUT CONSTANT key : STRING; END_VAR / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key('Property Name'); 5.2.1.5.9 Add Key Bool This method creates a new property key and at the same time a value of the data type BOOL. Syntax METHOD Add Key Bool VAR_IN_OUT CONSTANT key : STRING; END_VAR TF6701 Version: 1.12.0 213
## Page 214

PLC API VAR_INPUT value : BOOL; END_VAR Inputs Name Type value BOOL / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Bool('b Switch', TRUE); 5.2.1.5.10 Add Key Date Time This method creates a new property key and at the same time a value of the data type DATE_AND_TIME. Syntax METHOD Add Key Date Time VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : DATE_AND_TIME; END_VAR Inputs Name Type value DATE_AND_TIME / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Date Time('Timestamp', dt Time); 5.2.1.5.11 Add Key Dc Time This method creates a new property key and at the same time a value of the data type DCTIME. 214 Version: 1.12.0 TF6701
## Page 215

PLC API Syntax METHOD Add Key Dc Time VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : DCTIME; END_VAR Inputs Name Type value DCTIME / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Dc Time('Timestamp', dc Time); 5.2.1.5.12 Add Key File Time This method creates a new property key and at the same time a value of the data type FILETIME. Syntax METHOD Add Key File Time VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : FILETIME; END_VAR Inputs Name Type value FILETIME / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key File Time('Timestamp', ft Time); 5.2.1.5.13 Add Key Lreal This method creates a new property key and at the same time a value of the data type LREAL. TF6701 Version: 1.12.0 215
## Page 216

PLC API Syntax METHOD Add Key Lreal VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : LREAL; END_VAR Inputs Name Type value LREAL / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Lreal('Property Name', 42.42); 5.2.1.5.14 Add Key Null This method creates a new property key and initializes its value with null. Syntax METHOD Add Key Null VAR_IN_OUT CONSTANT key : STRING; END_VAR / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Null('Property Name'); 5.2.1.5.15 Add Key Number This method creates a new property key and at the same time a value of the data type DINT. Syntax METHOD Add Key Number VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT value : DINT; END_VAR 216 Version: 1.12.0 TF6701
## Page 217

PLC API Inputs Name Type value DINT / Inputs/Outputs Name Type key STRING Sample call: fb Json. Add Key Number('Property Name', 42); 5.2.1.5.16 Add Key String This method creates a new property key and at the same time a value of the data type STRING. Syntax METHOD Add Key String VAR_IN_OUT CONSTANT key : STRING; value : STRING; END_VAR / Inputs/Outputs Name Type key STRING value STRING Sample call: fb Json. Add Key String('Property Name', 'Hello World'); 5.2.1.5.17 Add Lint This method adds a value of the data type LINT to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Lint VAR_INPUT value : LINT; END_VAR Inputs Name Type value LINT TF6701 Version: 1.12.0 217
## Page 218

PLC API Sample call: fb Json. Add Key('Property Name'); fb Json. Add Lint(42); 5.2.1.5.18 Add Lreal This method adds a value of the data type LREAL to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Lreal VAR_INPUT value : LREAL; END_VAR Inputs Name Type value LREAL Sample call: fb Json. Add Key('Property Name'); fb Json. Add Lreal(42.42); 5.2.1.5.19 Add Null This method adds the value null to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Null Sample call: fb Json. Add Key('Property Name'); fb Json. Add Null(); 5.2.1.5.20 Add Raw Array This method adds a valid JSON array to a given property as a value. The array to be added must be in a valid JSON format and may only be added if the SAX Writer is at a correspondingly valid position, e.g. directly after a preceding Add Key() [} 213], Start Array() [} 226] or as the first call after a Reset Document() [} 224]. 218 Version: 1.12.0 TF6701
## Page 219

PLC API Syntax METHOD Add Raw Array VAR_IN_OUT CONSTANT raw Json : STRING; END_VAR Return value Name Type Add Raw Array BOOL / Inputs/Outputs Name Type raw Json STRING Sample call: fb Json. Add Key('Property Name'); fb Json. Add Raw Array('[1, 2, {"x":42, "y":42}, 4'); 5.2.1.5.21 Add Raw Object This method adds a valid JSON object to a given property as a value. The object to be added must be in a valid JSON format and may only be added if the SAX Writer is in an appropriately valid position, e.g. directly after a preceding Add Key() [} 213], Start Array() [} 226] or as the first call after a Reset Document() [} 224]. Syntax METHOD Add Raw Object VAR_IN_OUT CONSTANT raw Json : STRING; END_VAR / Inputs/Outputs Name Type raw Json STRING Sample call: fb Json. Add Key('Property Name'); fb Json. Add Raw Object('{"x":42, "y":42}'); 5.2.1.5.22 Add Real This method adds a value of the data type REAL to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Real VAR_INPUT value : REAL; END_VAR TF6701 Version: 1.12.0 219
## Page 220

PLC API Inputs Name Type value REAL Sample call: fb Json. Add Key('Property Name'); fb Json. Add Real(42.42); 5.2.1.5.23 Add String This method adds a value of the data type STRING to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add String VAR_IN_OUT CONSTANT value : STRING; END_VAR / Inputs/Outputs Name Type value STRING Sample call: fb Json. Add Key('Property Name'); fb Json. Add String('Hello World'); 5.2.1.5.24 Add Udint This method adds a value of the data type UDINT to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Udint VAR_INPUT value : UDINT; END_VAR Inputs Name Type value UDINT Sample call: fb Json. Add Key('Property Name'); fb Json. Add Udint(42); 220 Version: 1.12.0 TF6701
## Page 221

PLC API 5.2.1.5.25 Add Ulint This method adds a value of the data type ULINT to a property. Usually, a corresponding property was created beforehand with the method Add Key() [} 213]. Syntax METHOD Add Ulint VAR_INPUT value : ULINT; END_VAR Inputs Name Type value ULINT Sample call: fb Json. Add Key('Property Name'); fb Json. Add Ulint(42); 5.2.1.5.26 Copy Document This method copies the content of the current JSON object created with the SAX Writer to a target variable of the data type STRING, which can be of any length. The method returns the length of the string (including null termination). If the destination buffer is too small, it is emptied by a null termination and returned as length 0. Syntax METHOD Copy Document : UDINT VAR_IN_OUT CONSTANT p Doc : STRING; END_VAR VAR_INPUT n Doc : UDINT; END_VAR VAR_OUTPUT hr Error Code: HRESULT; END_VAR Return value Name Type Copy Document UDINT Inputs Name Type n Doc UDINT TF6701 Version: 1.12.0 221
## Page 222

PLC API / Inputs/Outputs Name Type p Doc STRING Outputs Name Type hr Error Code HRESULT Sample call: fb Json. Copy Document(s Target String, SIZEOF(s Target String)); 5.2.1.5.27 End Array This method generates the end of a started JSON array ("square closing bracket") and inserts it at the current position of the SAX writer. Syntax METHOD End Array : HRESULT Return value Name Type End Array HRESULT Sample call: fb Json. End Array(); 5.2.1.5.28 End Object This method generates the end of a started JSON object ("curly closing bracket") and inserts it at the current position of the SAX writer. Syntax METHOD End Object : HRESULT Return value Name Type End Object HRESULT Sample call: fb Json. End Object(); 222 Version: 1.12.0 TF6701
## Page 223

PLC API 5.2.1.5.29 Get Document This method returns the content of the JSON object that is currently created with the SAX Writer and returns it as data type STRING(255). The maximum size of the string returned by the method is 255 characters. With longer strings, the method will return a NULL string. In this case the method Copy Document [} 221]() must be used. Syntax METHOD Get Document : STRING(255) VAR_OUTPUT hr Error Code: HRESULT; END_VAR Return value Name Type Get Document STRING(255) Outputs Name Type hr Error Code HRESULT Sample call: s Target String := fb Json. Get Document(); 5.2.1.5.30 Get Document Length This method returns the length of the JSON object that is currently created with the SAX Writer and returns it as data type UDINT. Syntax METHOD Get Document Length : UDINT VAR_OUTPUT hr Error Code: HRESULT; END_VAR Return value Name Type Get Document Length UDINT Outputs Name Type hr Error Code HRESULT Sample call: n Length := fb Json. Get Document Length(); TF6701 Version: 1.12.0 223
## Page 224

PLC API 5.2.1.5.31 Get Max Decimal Places This function queries the currently set number of decimal places after which a floating point number is truncated. Syntax METHOD Get Max Decimal Places : DINT Return value Name Type Description Get Max Decimal Places DINT The currently set number of digits after which a floating point number is truncated. 5.2.1.5.32 Reset Document This method resets the JSON object currently created with the SAX writer. Syntax METHOD Reset Document : HRESULT Return value Name Type Reset Document HRESULT Sample call: fb Json. Reset Document(); 5.2.1.5.33 Set Format Options This method is used to customize the general formatting options for an instance of the FB_Json Sax Pretty Writer [} 209]. In addition to the default configuration, there is also the possibility that no line breaks are generated within an array. The array is then output in one line despite the inserted indentations. Syntax METHOD Set Format Options : HRESULT VAR_INPUT options : EJson Pretty Format Options; END_VAR TYPE EJson Pretty Format Options: ( e Format Default :=0, e Format Single Line Array:=1 ) DINT; 224 Version: 1.12.0 TF6701
## Page 225

PLC API Return value Name Type Set Format Options HRESULT Inputs Name Type options EJson Pretty Format Options Sample call: fb Json. Set Format Options(EJson Pretty Format Options.e Format Single Line Array); 5.2.1.5.34 Set Indent This method is used to customize the indentation. Syntax METHOD Set Indent : HRESULT VAR_INPUT indent Char : SINT; indent Char Count : UDINT; END_VAR Return value Name Type Set Indent HRESULT Inputs Name Type indent Char SINT indent Char Count UDINT Sample call: fb Json. Set Indent(1,5); 5.2.1.5.35 Set Max Decimal Places This function determines the number of decimal places after which a floating-point number is truncated. Syntax METHOD Set Max Decimal Places : HRESULT VAR_INPUT decimal Places: DINT; END_VAR TF6701 Version: 1.12.0 225
## Page 226

PLC API Return value Name Type Set Max Decimal Places HRESULT Inputs Name Type Description decimal Pla DINT The number of decimal places to be set after which a floating- ces point number is truncated. 5.2.1.5.36 Start Array This method generates the start of a new JSON array ("square opening bracket") and inserts it at the current position of the SAX writer. Syntax METHOD Start Array : HRESULT Return value Name Type Start Array HRESULT Sample call: fb Json. Start Array(); 5.2.1.5.37 Start Object This method generates the start of a new JSON object ("curly opening bracket") and inserts it at the current position of the SAX writer. Syntax METHOD Start Object : HRESULT Return value Name Type Start Object HRESULT Sample call: fb Json. Start Object(); 5.2.1.6 FB_Json Read Write Data Type 226 Version: 1.12.0 TF6701
## Page 227

PLC API In order to use UTF-8 characters, e.g. in the automatic generation of metadata via the function block FB_Json Read Write Data Type [} 226], the check box for the support of UTF-8 in the symbolism must be activated in the Twin CAT project. To do this, double-click on SYSTEM in the project tree, open the Settings tab and activate the corresponding check box. Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Outputs Name Type init Status HRESULT TF6701 Version: 1.12.0 227
## Page 228

PLC API Methods Name Description FB_Json Read Write Data Type Metadata can be added via PLC attributes to the JSON representation of a PLC data structure on an FB_Json Sax Writer object. Add Json Key Value From Symbol [} 229] Creates the JSON representation of a PLC data structure on an FB_Json Sax Writer object. Add Json Value From Symbol [} 230] Creates the JSON representation of a PLC data structure on an FB_Json Sax Writer object. Copy Json String From Symbol [} 231] Creates the JSON representation of a symbol and copies it to a variable of data type STRING. Copy Json String From Symbol Properties Creates a corresponding JSON representation of PLC attributes on a symbol. [} 232] Copy Symbol Name By Address [} 233] Returns the complete (ADS) symbol name of a transferred symbol. Get Data Type Name By Address [} 234] Returns the data type name of a transferred symbol. Get Json From Symbol [} 235] Creates the corresponding JSON representation of a symbol. Get Json String From Symbol [} 236] Creates the corresponding JSON representation of a symbol. Get Json String From Symbol Properties Creates a corresponding JSON representation of PLC attributes on a symbol. [} 237] Get Size Json String From Symbol [} 238] Reads the size of the JSON representation of a symbol. Get Size Json String From Symbol Properti Reads the size of the JSON representation of PLC attributes on a symbol. es [} 239] Get Symbol Name By Address [} 239] Returns the complete (ADS) symbol name of a transferred symbol. Set Symbol From Json [} 240] Extracts a string containing a valid JSON message. Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4022 x86, x64, ARM Tc3_Json Xml 5.2.1.6.1 Add Json Key Properties From Symbol With the aid of this method, metadata can be added via PLC attributes to the JSON representation of a PLC data structure on an FB_Json Sax Writer [} 191] object. The method receives as its input parameters the instance of the FB_Json Sax Writer function block, the desired name of the JSON property that is to contain the metadata, the data type name of the structure and a string variable s Properties, which contains a list of the PLC attributes to be extracted, separated by a cross bar. Syntax METHOD Add Json Value From Symbol : BOOL VAR_IN_OUT fb Writer : FB_Json Sax Writer; END_VAR VAR_IN_OUT CONSTANT s Key : STRING; s Datatype : STRING; s Properties : STRING; END_VAR 228 Version: 1.12.0 TF6701
## Page 229

PLC API VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Add Json Value From Symbol BOOL / Inputs/Outputs Name Type fb Writer FB_Json Sax Writer s Key STRING s Datatype STRING s Properties STRING Outputs Name Type hr Error Code HRESULT The PLC attributes can be specified in the following form on the structure elements: {attribute 'Unit' := 'm/s'} {attribute 'Display Name' := 'Speed'} Sensor1 : REAL; A complete sample of how to use this method can be found in section Tc3Json Xml Sample Json Data Type [} 334]. Sample call: fb Json Sax Writer. Reset Document() fb Json Data Type. Add Json Key Properties From Symbol(fb Json Sax Writer, 'Meta Data','ST_Values','Unit| Display Name'); 5.2.1.6.2 Add Json Key Value From Symbol This method generates the JSON representation of a PLC data structure on an FB_Json Sax Writer [} 191] object. The method receives as its input parameters the instance of the FB_Json Sax Writer function block, the data type name of the structure, and the address and size of the source structure instance. As a result, the FB_Json Sax Writer instance contains a valid JSON representation of the structure. Unlike the method Add Json Value From Symbol() [} 230], the elements of the source structure are nested here in a JSON sub- object whose name can be specified via the input/output parameter s Key. Syntax METHOD Add Json Value From Symbol : BOOL VAR_IN_OUT fb Writer : FB_Json Sax Writer; END_VAR VAR_IN_OUT CONSTANT s Key : STRING; s Datatype : STRING; END_VAR VAR_INPUT TF6701 Version: 1.12.0 229
## Page 230

PLC API n Data : UDINT; p Data : PVOID; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Add Json Value From Symbol BOOL Inputs Name Type n Data UDINT p Data PVOID / Inputs/Outputs Name Type fb Writer FB_Json Sax Writer s Key STRING s Datatype STRING Outputs Name Type hr Error Code HRESULT A complete sample of how to use this method can be found in section Tc3Json Xml Sample Json Data Type [} 334]. Sample call: fb Json Sax Writer. Reset Document() fb Json Data Type. Add Json Key Value From Symbol(fb Json Sax Writer, 'Values','ST_Values',SIZEOF(st Values), ADR(st Values)); 5.2.1.6.3 Add Json Value From Symbol This method generates the JSON representation of a PLC data structure on an FB_Json Sax Writer [} 191] object. The method receives as its input parameters the instance of the FB_Json Sax Writer function block, the data type name of the structure, and the address and size of the source structure instance. As a result, the FB_Json Sax Writer instance contains a valid JSON representation of the structure. Syntax METHOD Add Json Value From Symbol : BOOL VAR_IN_OUT fb Writer : FB_Json Sax Writer; END_VAR VAR_IN_OUT CONSTANT s Datatype : STRING; END_VAR VAR_INPUT 230 Version: 1.12.0 TF6701
## Page 231

PLC API n Data : UDINT; p Data : PVOID; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Add Json Value From Symbol BOOL Inputs Name Type n Data UDINT p Data PVOID / Inputs/Outputs Name Type fb Writer FB_Json Sax Writer s Datatype STRING Outputs Name Type hr Error Code HRESULT A complete sample of how to use this method can be found in section Tc3Json Xml Sample Json Data Type [} 334]. Sample call: fb Json Sax Writer. Reset Document() fb Json Data Type. Add Json Value From Symbol(fb Json Sax Writer,'ST_Values',SIZEOF(st Values), ADR(st Values)); 5.2.1.6.4 Copy Json String From Symbol This method generates the JSON representation of a symbol and copies it into a variable of the data type STRING, which can be of any length. The method returns the length of the string (including null termination). If the destination buffer is too small, it is emptied by a null termination and returned as length 0. Syntax METHOD Copy Json String From Symbol : UDINT VAR_INPUT n Data : UDINT; n Doc : UDINT; p Data : PVOID; END_VAR VAR_IN_OUT CONSTANT p Doc : STRING; s Datatype : STRING; END_VAR TF6701 Version: 1.12.0 231
## Page 232

PLC API VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Copy Json String From Symbol UDINT Inputs Name Type n Data UDINT n Doc UDINT p Data PVOID / Inputs/Outputs Name Type p Doc STRING s Datatype STRING Outputs Name Type hr Error Code HRESULT Sample call: n Len := fb Json Data Type. Copy Json String From Symbol('ST_Test',SIZEOF(st Test),ADR(st Test),s String,SIZEOF(s String) ); 5.2.1.6.5 Copy Json String From Symbol Properties This method generates a corresponding JSON representation of PLC attributes on a symbol. In contrast to the Add Json Key Properties From Symbol [} 228] method, the result is not written to an instance of the function block FB_Json Sax Writer, but to a string variable. The method receives as its input parameters the data type name of the symbol and a string variable that represents a list of the PLC attributes to be extracted, separated by a cross bar. The method copies this JSON representation into a variable of the data type STRING, which can be of any length. The method returns the length of the string (including null termination). If the destination buffer is too small, it is emptied by a null termination and returned as length 0. Syntax METHOD Copy Json String From Symbol Properties : UDINT VAR_INPUT n Doc : UDINT; END_VAR VAR_IN_OUT CONSTANT p Doc : STRING; s Datatype : STRING; s Properties : STRING; END_VAR 232 Version: 1.12.0 TF6701
## Page 233

PLC API VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Copy Json String From Symbol Properties UDINT Inputs Name Type n Doc UDINT / Inputs/Outputs Name Type p Doc STRING s Datatype STRING s Properties STRING Outputs Name Type hr Error Code HRESULT Sample call: n Len := fb Json Data Type. Copy Json String From Symbol Properties('ST_Test','Unit| Display Name',s String,SIZEOF(s String)); 5.2.1.6.6 Copy Symbol Name By Address This method returns the complete (ADS) symbol name of a transferred symbol. The method returns the size of the string (including null termination). If the destination buffer is too small, it is emptied by a null termination and returned as length 0. Syntax METHOD Copy Symbol Name By Address : UDINT VAR_INPUT n Data : UDINT; // size of symbol p Data : PVOID; // address of symbol END_VAR VAR_IN_OUT CONSTANT s Name : STRING; // target string buffer where the symbol name should be copied to END_VAR VAR_INPUT n Name : UDINT; // size in bytes of target string buffer END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR TF6701 Version: 1.12.0 233
## Page 234

PLC API Return value Name Type Copy Symbol Name By Address UDINT Inputs Name Type n Data UDINT p Data PVOID n Name UDINT / Inputs/Outputs Name Type s Name STRING Outputs Name Type hr Error Code HRESULT Sample call: n Symbol Size := fb Json Data Type. Copy Symbol Name By Address(n Data:=SIZEOF(st Values), p Data:=ADR(st Values), s Name:=s Symbol Name, n Name:=SIZEOF(s Symbol Name)); Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4024.20 x86, x64, ARM Tc3_Json Xml 3.3.15.0 5.2.1.6.7 Get Data Type Name By Address This method returns the data type name of a transferred symbol. Structures with a single variable If structures with a single variable are used, the data type cannot be read correctly using this method. The size and address information cannot be used to distinguish between the structure itself and the individual variables. Syntax METHOD Get Data Type Name By Address : STRING VAR_INPUT n Data : UDINT; p Data : PVOID; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR 234 Version: 1.12.0 TF6701
## Page 235

PLC API Return value Name Type Get Data Type Name By Address STRING Inputs Name Type n Data UDINT p Data PVOID Outputs Name Type hr Error Code HRESULT Sample call: s Buffer := fb Json Data Type. Get Data Type Name By Address(SIZEOF(st Values),ADR(st Values)); 5.2.1.6.8 Get Json From Symbol This method generates the corresponding JSON representation of a symbol. In contrast to the Add Json Value From Symbol() [} 230] method, the result is not written to an instance of the function block FB_Json Sax Writer, but to a string variable. The method receives as its input parameters the data type name of the symbol as well as the address and size of the source symbol, e.g. of a structure instance. The address and size of the destination buffer that contains the JSON representation of the symbol after the call are transferred as further input parameters. Syntax METHOD Get Json From Symbol : BOOL VAR_IN_OUT CONSTANT s Datatype : STRING; END_VAR VAR_INPUT n Data : UDINT; p Data : PVOID; n Json : REFERENCE TO UDINT; p Json : POINTER TO STRING; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Get Json From Symbol BOOL TF6701 Version: 1.12.0 235
## Page 236

PLC API Inputs Name Type n Data UDINT p Data PVOID n Json REFERENCE TO UDINT p Json POINTER TO STRING / Inputs/Outputs Name Type s Datatype STRING Outputs Name Type hr Error Code HRESULT Input parameter n Json The input parameter n Json contains the size of the destination buffer when the method is called, and the size of the actually written JSON object in the destination buffer when the method call is completed. Sample call: fb Json Data Type. Get Json From Symbol('ST_Values',SIZEOF(st Values), ADR(st Values), n Buffer Length, ADR(s Buffer)); 5.2.1.6.9 Get Json String From Symbol This method generates the corresponding JSON representation of a symbol. In contrast to the Add Json Value From Symbol() [} 230] method, the result is not written to an instance of the function block FB_Json Sax Writer, but to a string variable. The method receives as its input parameters the data type name of the symbol as well as the address and size of the source symbol of a structure instance, for example. The maximum size of the string returned by the method is 255 characters. With longer strings, the method will return a NULL string. In this case the method Copy Json String From Symbol [} 231]() must be used. Syntax METHOD Get Json String From Symbol : STRING(255) VAR_IN_OUT CONSTANT s Datatype : STRING; END_VAR VAR_INPUT n Data : UDINT; p Data : PVOID; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Get Json String From Symbol STRING(255) 236 Version: 1.12.0 TF6701
## Page 237

PLC API Inputs Name Type n Data UDINT p Data PVOID / Inputs/Outputs Name Type s Datatype STRING Outputs Name Type hr Error Code HRESULT Sample call: s Buffer := fb Json Data Type. Get Json String From Symbol('ST_Values',SIZEOF(st Values), ADR(st Values)); 5.2.1.6.10 Get Json String From Symbol Properties This method generates a corresponding JSON representation of PLC attributes on a symbol. In contrast to the Add Json Key Properties From Symbol [} 228] method, the result is not written to an instance of the function block FB_Json Sax Writer, but to a string variable. The method receives as its input parameters the data type name of the symbol and a string variable that represents a list of the PLC attributes to be extracted, separated by a cross bar. The result is returned directly as the return value of the method. The maximum size of the string returned by the method is 255 characters. With longer strings, the method will return a NULL string. In this case the method Copy Json String From Symbol Properties [} 232]() must be used. Syntax METHOD Get Json String From Symbol Properties : STRING(255) VAR_IN_OUT CONSTANT s Datatype : STRING; s Properties : STRING; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Get Json String From Symbol Properties STRING(255) / Inputs/Outputs Name Type s Datatype STRING s Properties STRING TF6701 Version: 1.12.0 237
## Page 238

PLC API Outputs Name Type hr Error Code HRESULT Sample call: s Buffer := fb Json Data Type. Get Json String From Symbol Properties('ST_Values', 'Unit|Display Name'); 5.2.1.6.11 Get Size Json String From Symbol This method reads the size of the JSON representation of a symbol. The value is specified with null termination. Syntax METHOD Get Size Json String From Symbol : UDINT VAR_INPUT n Data :UDINT; p Data :PVOID; END_VAR VAR_IN_OUT CONSTANT s Datatype : STRING; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Get Size Json String From Symbol UDINT Inputs Name Type n Data UDINT p Data PVOID / Inputs/Outputs Name Type s Datatype STRING Outputs Name Type hr Error Code HRESULT Sample call: n Len := fb Json Data Type. Get Size Json String From Symbol('BOOL',SIZEOF(b Bool),ADR(b Bool)); 238 Version: 1.12.0 TF6701
## Page 239

PLC API 5.2.1.6.12 Get Size Json String From Symbol Properties This method reads the size of the JSON representation of PLC attributes on a symbol. The value is specified with null termination. Syntax METHOD Get Size Json String From Symbol Properties : UDINT VAR_IN_OUT CONSTANT s Datatype : STRING; s Properties : STRING; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Get Size Json String From Symbol Properties UDINT / Inputs/Outputs Name Type s Datatype STRING s Properties STRING Outputs Name Type hr Error Code HRESULT Sample call: n Len := fb Json Data Type. Get Size Json String From Symbol Properties('ST_Test','Display Name|Unit'); 5.2.1.6.13 Get Symbol Name By Address This method returns the complete (ADS) symbol name of a transferred symbol. The maximum size of the string returned by the method is 255 characters. With longer strings, the method will return a null string. In this case the method Copy Symbol Name By Address() [} 233] must be used. Syntax METHOD Get Symbol Name By Address : STRING(255) VAR_INPUT n Data : UDINT; p Data : PVOID; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR TF6701 Version: 1.12.0 239
## Page 240

PLC API Return value Name Type Get Symbol Name By Address STRING(255) Inputs Name Type n Data UDINT p Data PVOID Outputs Name Type hr Error Code HRESULT Sample call: s Buffer := fb Json Data Type. Get Symbol Name By Address(SIZEOF(st Values), ADR(st Values)); 5.2.1.6.14 Set Symbol From Json This method extracts a string containing a valid JSON message and attempts to save the contents of the JSON object to an equivalent data structure. The method receives as its input parameters the string with the JSON object, the data type name of the target structure, and the address and size of the target structure instance. Syntax METHOD Set Symbol From Json : BOOL VAR_IN_OUT CONSTANT s Json : STRING; s Datatype : STRING; END_VAR VAR_INPUT n Data : UDINT; p Data : PVOID; END_VAR VAR_OUTPUT hr Error Code : HRESULT; END_VAR Return value Name Type Set Symbol From Json BOOL Inputs Name Type n Data UDINT p Data PVOID 240 Version: 1.12.0 TF6701
## Page 241

PLC API / Inputs/Outputs Name Type s Json STRING s Datatype STRING Outputs Name Type hr Error Code HRESULT Sample call: fb Json Data Type. Set Symbol From Json(s Json,'ST_Values',SIZEOF(st Values Receive), ADR(st Values Receive)); 5.2.1.7 FB_Xml Dom Parser Strings in UTF-8 format The variables of type STRING used here are based on the UTF-8 format. This STRING formatting is common for MQTT communication as well as for JSON documents. In order to be able to receive special characters and texts from a wide range of languages, the character set in the Tc3_Iot Base and Tc3_Json Xml libraries is not limited to the typical character set of the data type STRING. Instead, the Unicode character set in UTF-8 format is used in conjunction with the data type STRING. If the ASCII character set is used, there is no difference between the typical formatting of a STRING and the UTF-8 formatting of a STRING. Further information on the UTF-8 STRING format and available display and conversion options can be found in the documentation for the Tc2_Utilities PLC library. Outputs Name Type init Status HRESULT TF6701 Version: 1.12.0 241
## Page 242

PLC API Methods 242 Version: 1.12.0 TF6701
## Page 243

PLC API Name Description Append Attribute [} 247] Appends a new attribute to an existing node. Append Attribute As Bool [} 248] Appends a new attribute to an existing node (Boolean). Append Attribute As Double Appends a new attribute to an existing node (Double). [} 249] Append Attribute As Float [} 249] Appends a new attribute to an existing node (Float). Append Attribute As Int [} 250] Appends a new attribute to an existing node (Integer). Append Attribute As Lint [} 251] Appends a new attribute to an existing node (Integer64). Append Attribute As Uint [} 252] Appends a new attribute to an existing node (Unsigned Integer). Append Attribute As Ulint [} 252] Appends a new attribute to an existing node (Unsigned Integer64). Append Attribute Copy [} 253] Appends a new attribute to an existing node. Append Child [} 254] Appends a new node below an existing node. Append Child As Bool [} 254] Appends a new node below an existing node (Boolean). Append Child As Double [} 255] Appends a new node below an existing node (Double). Append Child As Float [} 256] Appends a new node below an existing node (Float). Append Child As Int [} 257] Appends a new node below an existing node (Integer). Append Child As Lint [} 257] Appends a new node below an existing node (Integer64). Append Child As Uint [} 258] Appends a new node below an existing node (Unsigned Integer). Append Child As Ulint [} 259] Appends a new node below an existing node (Unsigned Integer64). Append Copy [} 259] Appends a new node below an existing node. Append Node [} 260] Appends a new node below an existing node. Attributes [} 261] Reads the attribute of a given XML node. Attribute As Bool [} 261] Returns the value of an attribute as data type Boolean. Attribute As Double [} 262] Returns the value of an attribute as data type Double. Attribute As Float [} 262] Returns the value of an attribute as data type Float. Attribute As Int [} 263] Returns the value of an attribute as data type Integer. Attribute As Lint [} 263] Returns the value of an attribute as data type Integer64. Attribute As Uint [} 264] Returns the value of an attribute as data type Unsigned Integer. Attribute As Ulint [} 264] Returns the value of an attribute as data type Unsigned Integer64. Attribute Begin [} 265] Returns an iterator over all attributes of an XML node. Attribute From Iterator [} 265] Converts the current position of an iterator to an XML attribute object. Attribute Name [} 266] Returns the name of a given attribute. Attributes [} 266] Used to navigate the DOM and returns an iterator for all attributes found at an XML node. Attribute Text [} 267] Returns the text of a given attribute. Begin [} 268] Returns an iterator over all child elements of an XML node. Begin By Name [} 268] Returns an iterator over all child elements of an XML node, starting at a particular element. Child [} 269] Used to navigate through the DOM. It returns a reference to the (first) child element of the current node. Child By Attribute [} 269] Used to navigate through the DOM. It returns a reference to a child element in the XML document. Child By Attribute And Name Used to navigate through the DOM. It returns a reference to a child element in the XML document. [} 270] Child By Name [} 271] Used to navigate through the DOM. It returns a reference to a child element in the XML document. TF6701 Version: 1.12.0 243
## Page 244

PLC API Name Description Children [} 271] Used to navigate through the DOM. It returns an iterator for several child elements found in the XML document. Children By Name [} 272] Used to navigate through the DOM. It returns an iterator for several child elements found in the XML document. Clear Iterator [} 273] This method resets iterators that have already been used so that they can be used again the next time the program is run. Compare [} 273] Checks two iterators for equality. Copy Attribute Text [} 274] Reads the value of an XML attribute and writes it to a variable of data type String. Copy Document [} 275] Copies the contents of the DOM memory into a variable of data type String. Copy Node Text [} 275] Reads the value of an XML node and writes it to a variable of data type String. Copy Node Xml [} 276] Reads the XML structure of an XML node and writes it to a variable of data type String. End First Node By Path [} 277] Navigates through an XML document using a path that was transferred to the method. Get Attribute Text Length [} 277] Returns the length of the value of an XML attribute. Get Document Length [} 278] Returns the length of an XML document in bytes. Get Document Node [} 278] Returns the root node of an XML document. Get Node Text Length [} 279] Returns the length of the value of an XML node. Get Node Xml Length [} 279] Returns the length of the XML structure of an XML node. Get Root Node [} 280] Returns a reference to the first XML node in the XML document. Insert Attribute Copy [} 280] Inserts an attribute to an XML node, copying the name and value of an existing attribute. Insert Attribute [} 281] Inserts an attribute to an XML node. Insert Child [} 281] Inserts a node to an existing XML node. Insert Copy [} 282] Inserts a new node to an existing XML node and copies an existing node. Is End [} 283] Checks whether a given XML iterator is at the end of the iteration that is to be performed. Load Document From File [} 283] Loads a XML document from a file. New Document [} 284] Generates a new empty XML document in the DOM memory. Next [} 284] Sets an XML iterator for the next object that is to be processed. Next Attribute [} 285] Returns the next attribute for a given XML attribute. Next By Name [} 285] Sets an XML iterator for the next object that is to be processed, which is identified by its name. Next Sibling [} 286] Returns the next direct node for a given XML node at the same XML level. Next Sibling By Name [} 287] Returns the next direct node for a given XML node with a particular name at the same XML level. Node [} 287] Used in conjunction with an iterator to navigate through the DOM. Node As Bool [} 288] Returns the text of an XML node as data type Boolean. Node As Double [} 288] Returns the text of an XML node as data type Double. Node As Float [} 289] Returns the text of an XML node as data type Float. Node As Int [} 289] Returns the text of an XML node as data type Integer. Node As Lint [} 290] Returns the text of an XML node as data type Integer64. Node As Uint [} 290] Returns the text of an XML node as data type Unsigned Integer. Node As Ulint [} 291] Returns the text of an XML node as data type Unsigned Integer64. 244 Version: 1.12.0 TF6701
## Page 245

PLC API Name Description Node Name [} 291] Returns the name of an XML node. Node Text [} 292] Returns the text of an XML node. Parse Document [} 292] Loads an XML object into the DOM memory for further processing. Remove Attribute Remove Attribute By Name Remove Child [} 293] Removes an XML child node from a given XML node. Remove Child By Name [} 293] Removes an XML child node from a given XML node. Save Document To File [} 294] Saves the current XML document in a file. Set Attribute [} 295] Sets the value of an attribute. Set Attribute As Bool [} 296] Sets the value of an attribute (Boolean). Set Attribute As Double [} 296] Sets the value of an attribute (double). Set Attribute As Float [} 297] Sets the value of an attribute (float). Set Attribute As Int [} 297] Sets the value of an attribute (integer). Set Attribute As Lint [} 298] Sets the value of an attribute (Integer64). Set Attribute As Uint [} 298] Sets the value of an attribute (Unsigned Integer). Set Attribute As Ulint [} 299] Sets the value of an attribute (Unsigned Integer64). Set Child [} 299] Sets the value of an XML node (String). Set Child As Bool [} 300] Sets the value of an XML node (Boolean). Set Child As Double [} 300] Sets the value of an XML node (Double). Set Child As Float [} 301] Sets the value of an XML node (Float). Set Child As Int [} 302] Sets the value of an XML node (Integer). Set Child As Lint [} 302] Sets the value of an XML node (Integer64). Set Child As Uint [} 303] Sets the value of an XML node (Unsigned Integer). Set Child As Ulint [} 303] Sets the value of an XML node (Unsigned Integer64). Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4022 x86, x64, ARM Tc3_Json Xml Also see about this 2 Append Attribute [} 247] 2 Append Attribute As Bool [} 248] 2 Append Attribute As Double [} 249] 2 Append Attribute As Float [} 249] 2 Append Attribute As Int [} 250] 2 Append Attribute As Lint [} 251] 2 Append Attribute As Uint [} 252] 2 Append Attribute As Ulint [} 252] 2 Append Attribute Copy [} 253] 2 Append Child [} 254] 2 Append Child As Bool [} 254] 2 Append Child As Double [} 255] 2 Append Child As Float [} 256] 2 Append Child As Int [} 257] TF6701 Version: 1.12.0 245
## Page 246

PLC API 2 Append Child As Lint [} 257] 2 Append Child As Uint [} 258] 2 Append Child As Ulint [} 259] 2 Append Copy [} 259] 2 Append Node [} 260] 2 Attributes [} 261] 2 Attribute As Bool [} 261] 2 Attribute As Double [} 262] 2 Attribute As Float [} 262] 2 Attribute As Int [} 263] 2 Attribute As Lint [} 263] 2 Attribute As Uint [} 264] 2 Attribute As Ulint [} 264] 2 Attribute Begin [} 265] 2 Attribute From Iterator [} 265] 2 Attribute Name [} 266] 2 Attributes [} 266] 2 Attribute Text [} 267] 2 Begin [} 268] 2 Begin By Name [} 268] 2 Child [} 269] 2 Child By Attribute [} 269] 2 Child By Attribute And Name [} 270] 2 Child By Name [} 271] 2 Children [} 271] 2 Children By Name [} 272] 2 Compare [} 273] 2 Copy Attribute Text [} 274] 2 Copy Document [} 275] 2 Copy Node Text [} 275] 2 Copy Node Xml [} 276] 2 First Node By Path [} 277] 2 Get Attribute Text Length [} 277] 2 Get Document Length [} 278] 2 Get Document Node [} 278] 2 Get Node Text Length [} 279] 2 Get Node Xml Length [} 279] 2 Get Root Node [} 280] 2 Insert Attribute Copy [} 280] 2 Insert Attribute [} 281] 2 Insert Child [} 281] 2 Insert Copy [} 282] 2 Is End [} 283] 2 Load Document From File [} 283] 2 New Document [} 284] 2 Next [} 284] 246 Version: 1.12.0 TF6701
## Page 247

PLC API 2 Next Attribute [} 285] 2 Next By Name [} 285] 2 Next Sibling [} 286] 2 Next Sibling By Name [} 287] 2 Node [} 287] 2 Node As Bool [} 288] 2 Node As Double [} 288] 2 Node As Float [} 289] 2 Node As Int [} 289] 2 Node As Lint [} 290] 2 Node As Uint [} 290] 2 Node As Ulint [} 291] 2 Node Name [} 291] 2 Node Text [} 292] 2 Parse Document [} 292] 2 Remove Child [} 293] 2 Remove Child By Name [} 293] 2 Save Document To File [} 294] 2 Set Attribute [} 295] 2 Set Attribute As Bool [} 296] 2 Set Attribute As Double [} 296] 2 Set Attribute As Float [} 297] 2 Set Attribute As Int [} 297] 2 Set Attribute As Lint [} 298] 2 Set Attribute As Uint [} 298] 2 Set Attribute As Ulint [} 299] 2 Set Child [} 299] 2 Set Child As Bool [} 300] 2 Set Child As Double [} 300] 2 Set Child As Float [} 301] 2 Set Child As Int [} 302] 2 Set Child As Lint [} 302] 2 Set Child As Uint [} 303] 2 Set Child As Ulint [} 303] 5.2.1.7.1 Append Attribute This method adds a new attribute to an existing node. The name and value of the new attribute and the existing XML node are transferred to the method as input parameters. The method returns a reference to the newly added attribute. Syntax METHOD Append Attribute : SXml Attribute VAR_INPUT n : SXml Node; END_VAR TF6701 Version: 1.12.0 247
## Page 248

PLC API VAR_IN_OUT CONSTANT name : STRING; value : STRING; END_VAR Return value Name Type Append Attribute SXml Attribute Inputs Name Type n SXml Node / Inputs/Outputs Name Type name STRING value STRING Sample call: obj Attribute := fb Xml. Append Attribute(obj Machine, 'Name', 'some value'); 5.2.1.7.2 Append Attribute As Bool This method adds a new attribute to an existing node. The value of the attribute has the data type Boolean. The name and value of the new attribute and the existing XML node are transferred to the method as input parameters. The method returns a reference to the newly added attribute. Syntax METHOD Append Attribute As Bool : SXml Attribute VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : BOOL; END_VAR Return value Name Type Append Attribute As Bool SXml Attribute Inputs Name Type n SXml Node value BOOL 248 Version: 1.12.0 TF6701
## Page 249

PLC API / Inputs/Outputs Name Type name STRING Sample call: obj Attribute := fb Xml. Append Attribute As Bool(obj Machine, 'Name', TRUE); 5.2.1.7.3 Append Attribute As Double This method adds a new attribute to an existing node. The value of the attribute has the data type Double. The name and value of the new attribute and the existing XML node are transferred to the method as input parameters. The method returns a reference to the newly added attribute. Syntax METHOD Append Attribute As Double : SXml Attribute VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : LREAL; END_VAR Return value Name Type Append Attribute As Double SXml Attribute Inputs Name Type n SXml Node value LREAL / Inputs/Outputs Name Type name STRING Sample call: obj Attribute := fb Xml. Append Attribute As Double(obj Machine, 'Name', 42.42); 5.2.1.7.4 Append Attribute As Float TF6701 Version: 1.12.0 249
## Page 250

PLC API This method adds a new attribute to an existing node. The value of the attribute has the data type Float. The name and value of the new attribute and the existing XML node are transferred to the method as input parameters. The method returns a reference to the newly added attribute. Syntax METHOD Append Attribute As Float : SXml Attribute VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : REAL; END_VAR Return value Name Type Append Attribute As Float SXml Attribute Inputs Name Type n SXml Node value REAL / Inputs/Outputs Name Type name STRING Sample call: obj Attribute := fb Xml. Append Attribute As Float(obj Machine, 'Name', 42.42); 5.2.1.7.5 Append Attribute As Int This method adds a new attribute to an existing node. The value of the attribute has the data type Integer. The name and value of the new attribute and the existing XML node are transferred to the method as input parameters. The method returns a reference to the newly added attribute. Syntax METHOD Append Attribute As Int : SXml Attribute VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : DINT; END_VAR 250 Version: 1.12.0 TF6701
## Page 251

PLC API Return value Name Type Append Attribute As Int SXml Attribute Inputs Name Type n SXml Node value DINT / Inputs/Outputs Name Type name STRING Sample call: obj Attribute := fb Xml. Append Attribute As Int(obj Machine, 'Name', 42); 5.2.1.7.6 Append Attribute As Lint This method adds a new attribute to an existing node. The value of the attribute has the data type Integer64. The name and value of the new attribute and the existing XML node are transferred to the method as input parameters. The method returns a reference to the newly added attribute. Syntax METHOD Append Attribute As Lint : SXml Attribute VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : LINT; END_VAR Return value Name Type Append Attribute As Lint SXml Attribute Inputs Name Type n SXml Node value LINT / Inputs/Outputs Name Type name STRING TF6701 Version: 1.12.0 251
## Page 252

PLC API Sample call: obj Attribute := fb Xml. Append Attribute As Lint(obj Machine, 'Name', 42); 5.2.1.7.7 Append Attribute As Uint This method adds a new attribute to an existing node. The value of the attribute has the data type Unsigned Integer. The name and value of the new attribute and the existing XML node are transferred to the method as input parameters. The method returns a reference to the newly added attribute. Syntax METHOD Append Attribute As Uint : SXml Attribute VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : UDINT; END_VAR Return value Name Type Append Attribute As Uint SXml Attribute Inputs Name Type n SXml Node value UDINT / Inputs/Outputs Name Type name STRING Sample call: obj Attribute := fb Xml. Append Attribute As Uint(obj Machine, 'Name', 42); 5.2.1.7.8 Append Attribute As Ulint This method adds a new attribute to an existing node. The value of the attribute has the data type Unsigned Integer64. The name and value of the new attribute and the existing XML node are transferred to the method as input parameters. The method returns a reference to the newly added attribute. 252 Version: 1.12.0 TF6701
## Page 253

PLC API Syntax METHOD Append Attribute As Ulint : SXml Attribute VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : ULINT; END_VAR Return value Name Type Append Attribute As Ulint SXml Attribute Inputs Name Type n SXml Node value ULINT / Inputs/Outputs Name Type name STRING Sample call: obj Attribute := fb Xml. Append Attribute As Ulint(obj Machine, 'Name', 42); 5.2.1.7.9 Append Attribute Copy This method adds a new attribute to an existing node. The name and value of the new attribute are copied from an existing attribute. The existing attribute is transferred to the method as input parameter. Syntax METHOD Append Attribute Copy : SXml Attribute INPUT_VAR n : SXml Node; copy : SXml Attribute; END_VAR Return value Name Type Append Attribute Copy SXml Attribute Inputs Name Type n SXml Node copy SXml Attribute Sample call: TF6701 Version: 1.12.0 253
## Page 254

PLC API xml New Attribute := fb Xml. Append Attribute Copy(xml Node, xml Existing Attribute); 5.2.1.7.10 Append Child This method inserts a new node below an existing node. The value of the new node is of the data type STRING. The name and the value of the new node as well as a reference to the existing node are transferred to the method as input parameters. The method returns a reference to the newly added node. The input parameter cdata indicates whether the value of the node is to be encapsulated in a CDATA function block, so that certain special characters such as "<" and ">" are allowed as values. Syntax METHOD Append Child : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; value : STRING; END_VAR VAR_INPUT cdata : BOOL; END_VAR Return value Name Type Append Child SXml Node Inputs Name Type n SXml Node cdata BOOL / Inputs/Outputs Name Type name STRING value STRING Sample call: xml New Node := fb Xml. Append Child(xml Existing, 'Controller', 'CX5120', FALSE); 5.2.1.7.11 Append Child As Bool This method inserts a new node below an existing node. The value of the new node has the data type Boolean. The name and value of the new node and a reference to the existing node are transferred to the method as input parameters. The method returns a reference to the newly added node. 254 Version: 1.12.0 TF6701
## Page 255

PLC API Syntax METHOD Append Child As Bool : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : BOOL; END_VAR Return value Name Type Append Child As Bool SXml Node Inputs Name Type n SXml Node value BOOL / Inputs/Outputs Name Type name STRING Sample call: xml New Node := fb Xml. Append Child As Bool(xml Existing, 'Some Name', TRUE); 5.2.1.7.12 Append Child As Double This method inserts a new node below an existing node. The value of the new node has the data type Double. The name and value of the new node and a reference to the existing node are transferred to the method as input parameters. The method returns a reference to the newly added node. Syntax METHOD Append Child As Double : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : LREAL; END_VAR Return value Name Type Append Child As Double SXml Node TF6701 Version: 1.12.0 255
## Page 256

PLC API Inputs Name Type n SXml Node value LREAL / Inputs/Outputs Name Type name STRING Sample call: xml New Node := fb Xml. Append Child As Double(xml Existing, 'Some Name', 42.42); 5.2.1.7.13 Append Child As Float This method inserts a new node below an existing node. The value of the new node has the data type Float. The name and value of the new node and a reference to the existing node are transferred to the method as input parameters. The method returns a reference to the newly added node. Syntax METHOD Append Child As Float : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : REAL; END_VAR Return value Name Type Append Child As Float SXml Node Inputs Name Type n SXml Node value REAL / Inputs/Outputs Name Type name STRING Sample call: xml New Node := fb Xml. Append Child As Float(xml Existing, 'Some Name', 42.42); 256 Version: 1.12.0 TF6701
## Page 257

PLC API 5.2.1.7.14 Append Child As Int This method inserts a new node below an existing node. The value of the new node has the data type Integer. The name and value of the new node and a reference to the existing node are transferred to the method as input parameters. The method returns a reference to the newly added node. Syntax METHOD Append Child As Int : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : DINT; END_VAR Return value Name Type Append Child As Int SXml Node Inputs Name Type n SXml Node value DINT / Inputs/Outputs Name Type name STRING Sample call: xml New Node := fb Xml. Append Child As Int(xml Existing, 'Some Name', 42); 5.2.1.7.15 Append Child As Lint This method inserts a new node below an existing node. The value of the new node has the data type Integer64. The name and value of the new node and a reference to the existing node are transferred to the method as input parameters. The method returns a reference to the newly added node. Syntax METHOD Append Child As Lint : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR TF6701 Version: 1.12.0 257
## Page 258

PLC API VAR_INPUT value : LINT; END_VAR Return value Name Type Append Child As Lint SXml Node Inputs Name Type n SXml Node value LINT / Inputs/Outputs Name Type name STRING Sample call: xml New Node := fb Xml. Append Child As Lint(xml Existing, 'Some Name', 42); 5.2.1.7.16 Append Child As Uint This method inserts a new node below an existing node. The value of the new node has the data type Unsigned Integer. The name and value of the new node and a reference to the existing node are transferred to the method as input parameters. The method returns a reference to the newly added node. Syntax METHOD Append Child As Uint : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : UDINT; END_VAR Return value Name Type Append Child As Uint SXml Node Inputs Name Type n SXml Node value UDINT 258 Version: 1.12.0 TF6701
## Page 259

PLC API / Inputs/Outputs Name Type name STRING Sample call: xml New Node := fb Xml. Append Child As Uint(xml Existing, 'Some Name', 42); 5.2.1.7.17 Append Child As Ulint This method inserts a new node below an existing node. The value of the new node has the data type Unsigned Integer64. The name and value of the new node and a reference to the existing node are transferred to the method as input parameters. The method returns a reference to the newly added node. Syntax METHOD Append Child As Ulint : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR VAR_INPUT value : ULINT; END_VAR Return value Name Type Append Child As Ulint SXml Node Inputs Name Type n SXml Node value ULINT / Inputs/Outputs Name Type name STRING Sample call: xml New Node := fb Xml. Append Child As Ulint(xml Existing, 'Some Name', 42); 5.2.1.7.18 Append Copy TF6701 Version: 1.12.0 259
## Page 260

PLC API This method inserts a new node below an existing node. The name and value of the new node are copied from an existing node. The references to the existing nodes are transferred to the method as input parameters. The method returns a reference to the newly added node. Syntax METHOD Append Copy : SXml Node VAR_INPUT n : SXml Node; copy : SXml Node; END_VAR Return value Name Type Append Copy SXml Node Inputs Name Type n SXml Node copy SXml Node Sample call: xml New Node := fb Xml. Append Copy(xml Parent Node, xml Existing Node); 5.2.1.7.19 Append Node This method adds a new node to an existing node. The existing node and the name of the new node are transferred to the method as input parameters. The method returns a reference to the newly added node. Syntax METHOD Append Node : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR Return value Name Type Append Node SXml Node Inputs Name Type n SXml Node / Inputs/Outputs Name Type name STRING 260 Version: 1.12.0 TF6701
## Page 261

PLC API Sample call: obj Machines := fb Xml. Append Node(obj Root, 'Machines'); 5.2.1.7.20 Attributes This method can be used to read the attribute of a given XML node. The XML node and the name of the attribute are transferred to the method as input parameters. After the method has been called, further methods have to be called, for example to read the value of the attribute, e.g. Attribute As Int(). Syntax METHOD Attribute : SXml Attribute VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR Return value Name Type Attributes SXml Attribute Inputs Name Type n SXml Node / Inputs/Outputs Name Type name STRING Sample call: xml Machine1Attribute := fb Xml. Attribute(xml Machine1, 'Type'); 5.2.1.7.21 Attribute As Bool This method returns the value of an attribute as data type Boolean. The attribute is transferred to the method as input parameter. Syntax METHOD Attribute As Bool : BOOL VAR_INPUT a : SXml Attribute; END_VAR TF6701 Version: 1.12.0 261
## Page 262

PLC API Return value Name Type Attribute As Bool BOOL Inputs Name Type a SXml Attribute Sample call: b Value := fb Xml. Attribute As Bool(xml Attr); 5.2.1.7.22 Attribute As Double This method returns the value of an attribute as data type Double. The attribute is transferred to the method as input parameter. Syntax METHOD Attribute As Double : LREAL VAR_INPUT a : SXml Attribute; END_VAR Return value Name Type Attribute As Double LREAL Inputs Name Type a SXml Attribute Sample call: lr Value := fb Xml. Attribute As Double(xml Attr); 5.2.1.7.23 Attribute As Float This method returns the value of an attribute as data type Float. The attribute is transferred to the method as input parameter. Syntax METHOD Attribute As Float: REAL VAR_INPUT a : SXml Attribute; END_VAR 262 Version: 1.12.0 TF6701
## Page 263

PLC API Return value Name Type Attribute As Float REAL Inputs Name Type a SXml Attribute Sample call: r Value := fb Xml. Attribute As Float(xml Attr); 5.2.1.7.24 Attribute As Int This method returns the value of an attribute as a data type Integer. The attribute is transferred to the method as input parameter. Syntax METHOD Attribute As Int : DINT VAR_INPUT a : SXml Attribute; END_VAR Return value Name Type Attribute As Int DINT Inputs Name Type a SXml Attribute Sample call: n Value := fb Xml. Attribute As Int(xml Attr); 5.2.1.7.25 Attribute As Lint This method returns the value of an attribute as a data type Integer64. The attribute is transferred to the method as input parameter. Syntax METHOD Attribute As Lint : LINT VAR_INPUT a : SXml Attribute; END_VAR TF6701 Version: 1.12.0 263
## Page 264

PLC API Return value Name Type Attribute As Lint LINT Inputs Name Type a SXml Attribute Sample call: n Value := fb Xml. Attribute As Lint(xml Attr); 5.2.1.7.26 Attribute As Uint This method returns the value of an attribute as data type Unsigned Integer. The attribute is transferred to the method as input parameter. Syntax METHOD Attribute As Uint : UDINT VAR_INPUT a : SXml Attribute; END_VAR Return value Name Type Attribute As Uint UDINT Inputs Name Type a SXml Attribute Sample call: n Value := fb Xml. Attribute As Uint(xml Attr); 5.2.1.7.27 Attribute As Ulint This method returns the value of an attribute as data type Unsigned Integer64. The attribute is transferred to the method as input parameter. Syntax METHOD Attribute As Ulint : ULINT VAR_INPUT a : SXml Attribute; END_VAR 264 Version: 1.12.0 TF6701
## Page 265

PLC API Return value Name Type Attribute As Ulint ULINT Inputs Name Type a SXml Attribute Sample call: n Value := fb Xml. Attribute As Ulint(xml Attr); 5.2.1.7.28 Attribute Begin This method returns an iterator over all attributes of an XML node. The XML node is transferred to the method as input parameter. Syntax METHOD Attribute Begin : SXml Iterator VAR_INPUT n : SXml Node; END_VAR Return value Name Type Attribute Begin SXml Iterator Inputs Name Type n SXml Node Sample call: xml Iterator := fb Xml. Attribute Begin(xml Node); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Attr := fb Xml. Attribute From Iterator(xml Iterator); n Attr Value := fb Xml. Attribute As Int(xml Attr); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.29 Attribute From Iterator This method converts the current position of an iterator to an XML attribute object. The iterator is transferred to the method as input parameter. TF6701 Version: 1.12.0 265
## Page 266

PLC API Syntax METHOD Attribute From Iterator : SXml Attribute VAR_INPUT it : SXml Iterator; END_VAR Return value Name Type Attribute From Iterator SXml Attribute Inputs Name Type it SXml Iterator Sample call: xml Iterator := fb Xml. Attribute Begin(xml Node); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Attr := fb Xml. Attribute From Iterator(xml Iterator); n Attr Value := fb Xml. Attribute As Int(xml Attr); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.30 Attribute Name This method returns the name of a given attribute. The attribute is transferred to the method as input parameter. Syntax METHOD Attribute Name : STRING VAR_INPUT a : SXml Attribute; END_VAR Return value Name Type Attribute Name STRING Inputs Name Type a SXml Attribute Sample call: s Name := fb Xml. Attribute Name(xml Attr); 5.2.1.7.31 Attributes 266 Version: 1.12.0 TF6701
## Page 267

PLC API This method is used to navigate through the DOM and returns an iterator for all attributes found at an XML node. The iterator can then be used for further navigation through the elements that were found. The node and a reference to the iterator are transferred to the method as input parameters. Syntax METHOD Attributes : SXml Attribute VAR_INPUT n : SXml Node; it : REFERENCE TO SXml Iterator; END_VAR Return value Name Type Attributes SXml Attribute Inputs Name Type it REFERENCE TO SXml Iterator Sample call: xml Ret := fb Xml. Attributes(xml Node, xml Iterator); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Machine Attr Ref := fb Xml. Attribute(xml Iterator); xml Machine Attr Text := fb Xml. Attribute Text(xml Machine Attr Ref); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.32 Attribute Text This method returns the text of a given attribute. The attribute is transferred to the method as input parameter. Syntax METHOD Attribute Text : STRING(255) VAR_INPUT a : SXml Attribute; END_VAR Return value Name Type Attribute Text STRING(255) Inputs Name Type a SXml Attribute Sample call: s Text := fb Xml. Attribute Text(xml Attr); TF6701 Version: 1.12.0 267
## Page 268

PLC API 5.2.1.7.33 Begin This method returns an iterator over all child elements of an XML node, always starting from the first child element. The XML node is transferred to the method as input parameter. Syntax METHOD Begin : SXml Iterator VAR_INPUT n : SXml Node; END_VAR Return value Name Type Begin SXml Iterator Inputs Name Type n SXml Node Sample call: xml Iterator := fb Xml. Begin(xml Node); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Node Ref := fb Xml. Node(xml Iterator); xml Node Value := fb Xml. Node Text(xml Node Ref); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.34 Begin By Name This method returns an iterator over all child elements of an XML node, starting at a particular element. The XML node is transferred to the method as input parameter. Syntax METHOD Begin By Name : SXml Iterator VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR Return value Name Type Begin By Name SXml Iterator 268 Version: 1.12.0 TF6701
## Page 269

PLC API Inputs Name Type n SXml Node / Inputs/Outputs Name Type name STRING Sample call: xml Node := fb Xml. Child By Name(xml Doc, 'Machines'); xml Iterator := fb Xml. Begin By Name(xml Node, 'Name X'); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Node Ref := fb Xml. Node(xml Iterator); xml Node Value := fb Xml. Node Text(xml Node Ref); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.35 Child This method is used to navigate through the DOM. It returns a reference to the (first) child element of the current node. The start node is transferred to the method as input parameter. Syntax METHOD Child By Name : SXml Node VAR_INPUT n : SXml Node; END_VAR Return value Name Type Inputs Name Type n SXml Node Sample call: xml Child := fb Xml. Child(xml Node); 5.2.1.7.36 Child By Attribute This method is used to navigate through the DOM. It returns a reference to a child element in the XML document. The start node and the name and value of the attribute are transferred to the method as input parameters. TF6701 Version: 1.12.0 269
## Page 270

PLC API Syntax METHOD Child By Attribute : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT attr : STRING; value : STRING; END_VAR Return value Name Type Child By Attribute SXml Node Inputs Name Type n SXml Node / Inputs/Outputs Name Type attr STRING value STRING Sample call: xml Machine1 := fb Xml. Child By Attribute(xml Machines, 'Type', '1'); 5.2.1.7.37 Child By Attribute And Name This method is used to navigate through the DOM. It returns a reference to a child element in the XML document. The start node, the name and value of the attribute, and the name of the child element are transferred to the method as input parameters. Syntax METHOD Child By Attribute And Name : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT attr : STRING; value : STRING; child : STRING; END_VAR Return value Name Type Child By Attribute And Name SXml Node 270 Version: 1.12.0 TF6701
## Page 271

PLC API Inputs Name Type n SXml Node / Inputs/Outputs Name Type attr STRING value STRING child STRING Sample call: xml Machine2 := fb Xml. Child By Attribute And Name(xml Machines, 'Type', '2', 'Machine'); 5.2.1.7.38 Child By Name This method is used to navigate through the DOM. It returns a reference to a child element in the XML document. The start node and the name of the element to be returned are transferred to the method as input parameters. Syntax METHOD Child By Name : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR Return value Name Type Child By Name SXml Node Inputs Name Type n SXml Node / Inputs/Outputs Name Type name STRING Sample call: xml Machines := fb Xml. Child By Name(xml Doc, 'Machines'); 5.2.1.7.39 Children TF6701 Version: 1.12.0 271
## Page 272

PLC API This method is used to navigate through the DOM. It returns an iterator for several child elements found in the XML document. The iterator can then be used for further navigation through the elements that were found. The start node and a reference to the iterator are transferred to the method as input parameters. Syntax METHOD Children : SXml Node VAR_INPUT n : SXml Node; it : REFERENCE TO SXml Iterator; END_VAR Return value Name Type Children SXml Node Inputs Name Type n SXml Node Sample call: xml Ret := fb Xml. Children(xml Node, xml Iterator); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Machine Node Ref := fb Xml. Node(xml Iterator); xml Machine Node Text := fb Xml. Node Text(xml Machine Node Ref); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.40 Children By Name This method is used to navigate through the DOM. It returns an iterator for several child elements found in the XML document. The iterator can then be used for further navigation through the elements that were found. The start node, the name of the child elements to be found and a reference to the iterator are transferred to the method as input parameters. Syntax METHOD Children By Name : SXml Node VAR_INPUT n : SXml Node; it : REFERENCE TO SXml Iterator; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR Return value Name Type Children By Name SXml Node Inputs Name Type n SXml Node it REFERENCE TO SXml Iterator 272 Version: 1.12.0 TF6701
## Page 273

PLC API / Inputs/Outputs Name Type name STRING Sample call: xml Machine Node := fb Xml. Children By Name(xml Machines, xml Iterator, 'Machine'); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Machine Node Ref := fb Xml. Node(xml Iterator); xml Machine Node Text := fb Xml. Node Text(xml Machine Node Ref); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.41 Clear Iterator This method resets iterators that have already been used so that they can be used again the next time the program is run. Syntax METHOD Clear Iterator : BOOL VAR_INPUT it : SXml Iterator; END_VAR Return value Name Type Clear Iterator BOOL Inputs Name Type it SXml Iterator Sample call: b Result := fb Xml. Clear Iterator(xml It); Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4024.56 x86, x64, ARM Tc3_Json Xml 3.4.5.0 5.2.1.7.42 Compare This method checks two iterators for equality. TF6701 Version: 1.12.0 273
## Page 274

PLC API Syntax METHOD Compare : BOOL VAR_INPUT it1 : SXml Iterator; it2 : SXml Iterator; END_VAR Return value Name Type Compare BOOL Inputs Name Type It1 SXml Iterator It2 SXml Iterator Sample call: b Result := fb Xml. Compare(xml It1, xml It2); 5.2.1.7.43 Copy Attribute Text This method reads the value of an XML attribute and writes it to a variable of data type String. The XML attribute as well as the target variable and the length to be written are passed to the method as input parameters. The method returns the actual size. Syntax METHOD Copy Attribute Text : UDINT VAR_INPUT a : SXml Attribute; END_VAR VAR_IN_OUT CONSTANT s Xml : STRING; END_VAR VAR_INPUT n Xml : UDINT; END_VAR Return value Name Type Copy Attribute Text UDINT Inputs Name Type a SXml Attribute n Xml UDINT 274 Version: 1.12.0 TF6701
## Page 275

PLC API / Inputs/Outputs Name Type s Xml STRING Sample call: n Length := fb Xml. Copy Attribute Text(xml Attr, s Target, SIZEOF(s Target)); 5.2.1.7.44 Copy Document This method copies the contents of the DOM memory into a variable of data type String. The length to be written and the variable into which the resulting string is to be written are passed to the method as input parameters. The method returns the actually written length. Note that the size of the string variable is at least equal to the size of the XML document in the DOM. Syntax METHOD Copy Document : UDINT VAR_IN_OUT CONSTANT s Xml : STRING; END_VAR VAR_INPUT n Xml : UDINT; END_VAR Return value Name Type Copy Document UDINT Inputs Name Type n Xml UDINT / Inputs/Outputs Name Type s Xml STRING Sample call: n Length := fb Xml. Copy Document(s Target, SIZEOF(s Target)); 5.2.1.7.45 Copy Node Text This method reads the value of an XML node and writes it to a variable of data type String. The XML node as well as the target variable and the length to be written are passed to the method as input parameters. The method returns the actual size. TF6701 Version: 1.12.0 275
## Page 276

PLC API Syntax METHOD Copy Node Text : UDINT VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT s Xml : STRING; END_VAR VAR_INPUT n Xml : UDINT; END_VAR Return value Name Type Copy Node Text UDINT Inputs Name Type n SXml Node n Xml UDINT / Inputs/Outputs Name Type s Xml STRING Sample call: n Length := fb Xml. Copy Node Text(xml Node, s Target, SIZEOF(s Target)); 5.2.1.7.46 Copy Node Xml This method reads the XML structure of an XML node and writes it to a variable of data type String. The XML node as well as the target variable and the length to be written are passed to the method as input parameters. The method returns the actual size. Syntax METHOD Copy Node Xml : UDINT VAR_INPUT a : SXml Node; END_VAR VAR_IN_OUT CONSTANT s Xml : STRING; END_VAR VAR_INPUT n Xml : UDINT; END_VAR Return value Name Type Copy Node Xml UDINT 276 Version: 1.12.0 TF6701
## Page 277

PLC API Inputs Name Type a SXml Node n Xml UDINT / Inputs/Outputs Name Type s Xml STRING Sample call: n Length := fb Xml. Copy Node Xml(xml Node, s Target, SIZEOF(s Target)); 5.2.1.7.47 First Node By Path This method navigates through an XML document using a path that was transferred to the method. The path and the start node are transferred to the method as input parameters. The path is specified with "/" as separator. The method returns a reference to the XML node that was found. Syntax METHOD First Node By Path : SXml Node VAR_INPUT n : SXml Node; path : STRING; END_VAR Return value Name Type First Node By Path SXml Node Inputs Name Type n SXml Node path STRING Sample call: xml Found Node := fb Xml. First Node By Path(xml Start Node, 'Level1/Level2/Level3'); 5.2.1.7.48 Get Attribute Text Length This method returns the length of the value of an XML attribute. The XML attribute is transferred to the method as input parameter. TF6701 Version: 1.12.0 277
## Page 278

PLC API Syntax METHOD Get Attribute Text Length : UDINT VAR_INPUT a : SXml Attribute; END_VAR Return value Name Type Get Attribute Text Length UDINT Inputs Name Type a SXml Attribute Sample call: n Length := fb Xml. Get Attribute Text Length(xml Attr); 5.2.1.7.49 Get Document Length This method returns the length of an XML document in bytes. Syntax METHOD Get Document Length : UDINT Return value Name Type Get Document Length UDINT Sample call: n Length := fb Xml. Get Document Length(); 5.2.1.7.50 Get Document Node This method returns the root node of an XML document. This is not the same as the first XML node in the document (the method Get Root Node() should be used for this). The method can also be used to create an empty XML document in the DOM. Syntax METHOD Get Document Node : SXml Node Return value Name Type Get Document Node SXml Node Sample call: 278 Version: 1.12.0 TF6701
## Page 279

PLC API obj Root := fb Xml. Get Document Node(); 5.2.1.7.51 Get Node Text Length This method returns the length of the value of an XML node. The XML node is transferred to the method as input parameter. Syntax METHOD Get Node Text Length : UDINT VAR_INPUT n : SXml Node; END_VAR Return value Name Type Get Node Text Length UDINT Inputs Name Type n SXml Node Sample call: n Length := fb Xml. Get Node Text Length(xml Node); 5.2.1.7.52 Get Node Xml Length This method returns the length of the XML structure of an XML node. The XML node is transferred to the method as input parameter. Syntax METHOD Get Node Xml Length : UDINT VAR_INPUT n : SXml Node; END_VAR Return value Name Type Get Node Xml Length UDINT Inputs Name Type n SXml Node Sample call: n Length := fb Xml. Get Node Xml Length(xml Node); TF6701 Version: 1.12.0 279
## Page 280

PLC API 5.2.1.7.53 Get Root Node This method returns a reference to the first XML node in the XML document. Syntax METHOD Get Root Node : SXml Node Return value Name Type Get Root Node SXml Node Sample call: xml Root Node := fb Xml. Get Root Node(); 5.2.1.7.54 Insert Attribute Copy This method adds an attribute to an XML node. The name and value of an existing attribute are copied. The attribute can be placed at a specific position. The XML node, the position and a reference to the existing attribute object are transferred to the method as input parameters. The method returns a reference to the newly added attribute. Syntax METHOD Insert Attribute Copy : SXml Attribute VAR_INPUT n : SXml Node; before : SXml Attribute; copy : SXml Attribute; END_VAR Return value Name Type Insert Attribute Copy SXml Attribute Inputs Name Type n SXml Node before SXml Attribute copy SXml Attribute Sample call: xml New Attr := fb Xml. Insert Attribute Copy(xml Node, xml Before Attr, xml Copy Attr); 280 Version: 1.12.0 TF6701
## Page 281

PLC API 5.2.1.7.55 Insert Attribute This method adds an attribute to an XML node. The attribute can be placed at a specific position. The XML node and the position and name of the new attribute are transferred to the method as input parameters. The method returns a reference to the newly added attribute. A value for the attribute can then be entered using the Set Attribute() method, for example. Syntax METHOD Insert Attribute : SXml Attribute VAR_INPUT n : SXml Node; before : SXml Attribute; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR Return value Name Type Insert Attribute SXml Attribute Inputs Name Type n SXml Node before SXml Attribute / Inputs/Outputs Name Type name STRING Sample call: xml New Attr := fb Xml. Insert Attribute(xml Node, xml Before Attr, 'Some Name'); 5.2.1.7.56 Insert Child This method adds a node to an existing XML node. The new node can be placed at a specific location. The existing XML node and the position and name of the new node are transferred to the method as input parameters. The method returns a reference to the newly added node. A value for the node can then be entered using the Set Child() method, for example. Syntax METHOD Insert Child : SXml Node VAR_INPUT n : SXml Node; before : SXml Node; END_VAR TF6701 Version: 1.12.0 281
## Page 282

PLC API VAR_IN_OUT CONSTANT name : STRING; END_VAR Return value Name Type Insert Child SXml Node Inputs Name Type n SXml Node before SXml Attribute / Inputs/Outputs Name Type name STRING Sample call: xml New Node := fb Xml. Insert Child(xml Node, xml Before Node, 'Some Name'); 5.2.1.7.57 Insert Copy This method adds a new node to an existing XML node and copies an existing node. The new node can be placed anywhere in the existing node. The XML node, the position and a reference to the existing node object are transferred to the method as input parameters. The method returns a reference to the newly added node. Syntax METHOD Insert Copy : SXml Node VAR_INPUT n : SXml Node; before : SXml Node; copy : SXml Node; END_VAR Return value Name Type Insert Copy SXml Node Inputs Name Type n SXml Node before SXml Node copy SXml Node Sample call: xml New Node := fb Xml. Insert Copy(xml Node, xml Before Node, xml Copy Node); 282 Version: 1.12.0 TF6701
## Page 283

PLC API 5.2.1.7.58 Is End This method checks whether a given XML iterator is at the end of the iteration that is to be performed. Syntax METHOD Is End : BOOL VAR_INPUT it : SXml Iterator; END_VAR Return value Name Type Is End BOOL Inputs Name Type nit SXml Iterator Sample call: xml Iterator := fb Xml. Begin(xml Node); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Node Ref := fb Xml. Node(xml Iterator); xml Node Value := fb Xml. Node Text(xml Node Ref); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.59 Load Document From File This method loads an XML document from a file. The absolute path to the file is transferred to the method as input parameter. A rising edge on the input parameter b Exec triggers the loading procedure. The asynchronous process is terminated as soon as the reference b Exec is set back to FALSE from the method. When the process ends, the return value of the method indicates whether the loading of the file was successful (TRUE) or failed (FALSE) for the duration of one call. Encoding Please note that the imported files must be formatted in UTF-8. Formats such as UTF-16 are not supported. Syntax METHOD Load Document From File : BOOL VAR_IN_OUT CONSTANT s File : STRING; END_VAR VAR_INPUT b Exec : REFERENCE TO BOOL; END_VAR VAR_OUTPUT hr Error Code: HRESULT; END_VAR TF6701 Version: 1.12.0 283
## Page 284

PLC API Return value Name Type Load Document From File BOOL Inputs Name Type b Exec REFERENCE TO BOOL / Inputs/outputs Name Type s File STRING Outputs Name Type hr Error Code HRESULT Sample call: IF b Load THEN b Loaded := fb Xml. Load Document From File('C:\Test.xml', b Load); END_IF 5.2.1.7.60 New Document This method creates an empty XML document in the DOM memory. Syntax METHOD New Document : BOOL Return value Name Type New Document BOOL Sample call: fb Xml. New Document(); 5.2.1.7.61 Next This method sets an XML iterator for the next object that is to be processed. Syntax METHOD Next : SXml Iterator VAR_INPUT it : SXml Iterator; END_VAR 284 Version: 1.12.0 TF6701
## Page 285

PLC API Return value Name Type Next SXml Iterator Inputs Name Type it SXml Iterator Sample call: xml Iterator := fb Xml. Begin(xml Node); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Node Ref := fb Xml. Node(xml Iterator); xml Node Value := fb Xml. Node Text(xml Node Ref); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.62 Next Attribute This method returns the next attribute for a given XML attribute. Syntax METHOD Next Attribute : SXml Attribute VAR_INPUT a : SXml Attribute; END_VAR Return value Name Type Next Attribute SXml Attribute Inputs Name Type a SXml Attribute Sample call: xml Next Attr := fb Xml. Next Attribute(xml Attr); 5.2.1.7.63 Next By Name This method sets an XML iterator for the next object that is to be processed, which is identified by its name. Syntax METHOD Next By Name : SXml Iterator VAR_INPUT it : SXml Iterator; END_VAR TF6701 Version: 1.12.0 285
## Page 286

PLC API VAR_IN_OUT CONSTANT name : STRING; END_VAR Return value Name Type Next By Name SXml Iterator Inputs Name Type it SXml Iterator / Inputs/Outputs Name Type name STRING Sample call: xml Iterator := fb Xml. Begin(xml Node); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Node Ref := fb Xml. Node(xml Iterator); xml Node Value := fb Xml. Node Text(xml Node Ref); xml Iterator := fb Xml. Next By Name(xml Iterator, 'Some Name'); END_WHILE 5.2.1.7.64 Next Sibling This method returns the next direct node for a given XML node at the same XML level. Syntax METHOD Next Sibling : SXml Node VAR_INPUT n : SXml Node; END_VAR Return value Name Type Next Sibling SXml Node Inputs Name Type n SXml Node Sample call: xml Sibling := fb Xml. Next Sibling(xml Node); 286 Version: 1.12.0 TF6701
## Page 287

PLC API 5.2.1.7.65 Next Sibling By Name This method returns the next direct node for a given XML node with a particular name at the same XML level. Syntax METHOD Next Sibling By Name : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR Return value Name Type Next Sibling By Name SXml Node Inputs Name Type n SXml Node / Inputs/Outputs Name Type name STRING Sample call: xml Sibling := fb Xml. Next Sibling By Name(xml Node, 'Some Name'); 5.2.1.7.66 Node This method is used in conjunction with an iterator to navigate through the DOM. The iterator is transferred to the method as input parameter. The method then returns the current XML node as return value. Syntax METHOD Node : SXml Node VAR_INPUT it : SXml Iterator; END_VAR Return value Name Type Node SXml Node TF6701 Version: 1.12.0 287
## Page 288

PLC API Inputs Name Type it SXml Iterator Sample call: xml Machine Node := fb Xml. Children By Name(xml Machines, xml Iterator, 'Machine'); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Machine Node := fb Xml. Node(xml Iterator); xml Machine Node Value := fb Xml. Node Text(xml Machine Node); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE 5.2.1.7.67 Node As Bool This method returns the text of an XML node as data type Boolean. The XML node is transferred to the method as input parameter. Syntax METHOD Node As Bool : BOOL VAR_INPUT n : SXml Node; END_VAR Return value Name Type Node As Bool BOOL Inputs Name Type n SXml Node Sample call: b Xml Node:= fb Xml. Node As Bool(xml Machine1); 5.2.1.7.68 Node As Double This method returns the text of an XML node as data type Double. The XML node is transferred to the method as input parameter. Syntax METHOD Node As Double : LREAL VAR_INPUT n : SXml Node; END_VAR Return value Name Type Node As Double LREAL 288 Version: 1.12.0 TF6701
## Page 289

PLC API Inputs Name Type n SXml Node Sample call: lr Xml Node:= fb Xml. Node As Double(xml Machine1); 5.2.1.7.69 Node As Float This method returns the text of an XML node as data type Float. The XML node is transferred to the method as input parameter. Syntax METHOD Node As Float : REAL VAR_INPUT n : SXml Node; END_VAR Return value Name Type Node As Float REAL Inputs Name Type n SXml Node Sample call: r Xml Node:= fb Xml. Node As Float(xml Machine1); 5.2.1.7.70 Node As Int This method returns the text of an XML node as a data type Integer. The XML node is transferred to the method as input parameter. Syntax METHOD Node As Int : DINT VAR_INPUT n : SXml Node; END_VAR Return value Name Type Node As Int DINT TF6701 Version: 1.12.0 289
## Page 290

PLC API Inputs Name Type n SXml Node Sample call: n Xml Node:= fb Xml. Node As Int(xml Machine1); 5.2.1.7.71 Node As Lint This method returns the text of an XML node as a data type Integer64. The XML node is transferred to the method as input parameter. Syntax METHOD Node As Lint : LINT VAR_INPUT n : SXml Node; END_VAR Return value Name Type Node As Lint LINT Inputs Name Type n SXml Node Sample call: n Xml Node:= fb Xml. Node As Lint(xml Machine1); 5.2.1.7.72 Node As Uint This method returns the text of an XML node as data type Unsigned Integer. The XML node is transferred to the method as input parameter. Syntax METHOD Node As Uint : UDINT VAR_INPUT n : SXml Node; END_VAR Return value Name Type Node As Uint UDINT 290 Version: 1.12.0 TF6701
## Page 291

PLC API Inputs Name Type n SXml Node Sample call: n Xml Node:= fb Xml. Node As Uint(xml Machine1); 5.2.1.7.73 Node As Ulint This method returns the text of an XML node as data type Unsigned Integer64. The XML node is transferred to the method as input parameter. Syntax METHOD Node As Ulint : ULINT VAR_INPUT n : SXml Node; END_VAR Return value Name Type Node As Ulint ULINT Inputs Name Type n SXml Node Sample call: n Xml Node:= fb Xml. Node As Ulint(xml Machine1); 5.2.1.7.74 Node Name This method returns the name of an XML node. A reference to the XML node is transferred to the method as input parameter. Syntax METHOD Node Name : STRING VAR_INPUT n : SXml Node; END_VAR Return value Name Type Node Name STRING TF6701 Version: 1.12.0 291
## Page 292

PLC API Inputs Name Type n SXml Node Sample call: s Node Name := fb Xml. Node Name(xml Machine1); 5.2.1.7.75 Node Text This method returns the text of an XML node. The XML node is transferred to the method as input parameter. If the text of an XML node is longer than 255 characters, the method Copy Node Text [} 275] must be used. Syntax METHOD Node Text : STRING(255) VAR_INPUT n : SXml Node; END_VAR Return value Name Type Node Text STRING(255) Inputs Name Type n SXml Node Sample call: s Machine1Name := fb Xml. Node Text(xml Machine1); 5.2.1.7.76 Parse Document This method loads an XML document into the DOM memory for further processing. The XML document exists as a string and is transferred to the method as input parameter. A reference to the XML document in the DOM is returned to the caller. Syntax METHOD Parse Document : SXml Node VAR_IN_OUT CONSTANT s Xml : STRING; END_VAR Return value Name Type Parse Document SXml Node 292 Version: 1.12.0 TF6701
## Page 293

PLC API / Inputs/Outputs Name Type s Xml STRING Sample call: xml Doc := fb Xml. Parse Document(s Xml To Parse); 5.2.1.7.77 Remove Child This method removes an XML child node from a given XML node. The two XML nodes are transferred to the method as input parameters. The method returns TRUE if the operation was successful and the XML node was removed. Syntax METHOD Remove Child : BOOL VAR_INPUT n : SXml Node; child : SXml Node; END_VAR Return value Name Type Remove Child BOOL Inputs Name Type n SXml Node child SXml Node Sample call: b Removed := fb Xml. Remove Child(xml Parent, xml Child); 5.2.1.7.78 Remove Child By Name This method removes an XML child node from a given XML node. The node to be removed is addressed by its name. If there is more than one child node, the last child node is removed. The method returns TRUE if the operation was successful and the XML node was removed. Syntax METHOD Remove Child By Name : BOOL VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT name : STRING; END_VAR TF6701 Version: 1.12.0 293
## Page 294

PLC API Return value Name Type Remove Child By Name BOOL Inputs Name Type n SXml Node / Inputs/Outputs Name Type name STRING Sample call: b Removed := fb Xml. Remove Child By Name(xml Parent, 'Some Name'); 5.2.1.7.79 Save Document To File This method saves the current XML document in a file. The absolute path to the file is transferred to the method as input parameter. A rising edge at the input parameter b Exec triggers the saving procedure. The asynchronous process is terminated as soon as the reference b Exec is set back to FALSE from the method. When the process ends, the return value of the method indicates for one call whether saving of the file was successful (TRUE) or failed (FALSE). Syntax METHOD Save Document To File : BOOL VAR_IN_OUT CONSTANT s File : STRING; END_VAR VAR_INPUT b Exec : REFERENCE TO BOOL; END_VAR VAR_OUTPUT hr Error Code: HRESULT; END_VAR Return value Name Type Save Document To File BOOL Inputs Name Type b Exec REFERENCE TO BOOL / Inputs/Outputs Name Type s File STRING 294 Version: 1.12.0 TF6701
## Page 295

PLC API Outputs Name Type hr Error Code HRESULT Sample call: IF b Save THEN b Saved = fb Xml. Save Document To File('C:\Test.xml', b Save); END_IF 5.2.1.7.80 Set Ads Provider Syntax METHOD Set Ads Provider : BOOL VAR_IN_OUT CONSTANT oid : OTCID; END_VAR Return value Name Type Set Ads Provider BOOL / Inputs/Outputs Name Type oid OTCID 5.2.1.7.81 Set Attribute This method sets the value of an attribute. The value has the data type String. Syntax METHOD Set Attribute : SXml Attribute VAR_INPUT a : SXml Attribute; END_VAR VAR_IN_OUT CONSTANT value : STRING; END_VAR Return value Name Type Set Attribute SXml Attribute Inputs Name Type a SXml Attribute TF6701 Version: 1.12.0 295
## Page 296

PLC API / Inputs/Outputs Name Type value STRING Sample call: xml Attr := fb Xml. Set Attribute(xml Existing Attr, 'Test'); 5.2.1.7.82 Set Attribute As Bool This method sets the value of an attribute. The value has the data type Boolean. Syntax METHOD Set Attribute As Bool : SXml Attribute VAR_INPUT a : SXml Attribute; value : BOOL; END_VAR Return value Name Type Set Attribute As Bool SXml Attribute Inputs Name Type a SXml Attribute value BOOL Sample call: xml Attr := fb Xml. Set Attribute As Bool(xml Existing Attr, TRUE); 5.2.1.7.83 Set Attribute As Double This method sets the value of an attribute. The value here has the data type Double. Syntax METHOD Set Attribute As Double : SXml Attribute VAR_INPUT a : SXml Attribute; value : LREAL; END_VAR Return value Name Type Set Attribute As Double SXml Attribute 296 Version: 1.12.0 TF6701
## Page 297

PLC API Inputs Name Type a SXml Attribute value LREAL Sample call: xml Attr := fb Xml. Set Attribute As Double(xml Existing Attr, 42.42); 5.2.1.7.84 Set Attribute As Float This method sets the value of an attribute. The value has the data type Float. Syntax METHOD Set Attribute As Float : SXml Attribute VAR_INPUT a : SXml Attribute; value : REAL; END_VAR Return value Name Type Set Attribute As Float SXml Attribute Inputs Name Type a SXml Attribute value REAL Sample call: xml Attr := fb Xml. Set Attribute As Float(xml Existing Attr, 42.42); 5.2.1.7.85 Set Attribute As Int This method sets the value of an attribute. The value has the data type Integer. Syntax METHOD Set Attribute As Int : SXml Attribute VAR_INPUT a : SXml Attribute; value : DINT; END_VAR Return value Name Type Set Attribute As Int SXml Attribute TF6701 Version: 1.12.0 297
## Page 298

PLC API Inputs Name Type a SXml Attribute value DINT Sample call: xml Attr := fb Xml. Set Attribute As Int(xml Existing Attr, 42); 5.2.1.7.86 Set Attribute As Lint This method sets the value of an attribute. The value has the data type Integer64. Syntax METHOD Set Attribute As Lint : SXml Attribute VAR_INPUT a : SXml Attribute; value : LINT; END_VAR Return value Name Type Set Attribute As Lint SXml Attribute Inputs Name Type a SXml Attribute value LINT Sample call: xml Attr := fb Xml. Set Attribute As Lint(xml Existing Attr, 42); 5.2.1.7.87 Set Attribute As Uint This method sets the value of an attribute. The value has the data type Unsigned Integer. Syntax METHOD Set Attribute As Uint : SXml Attribute VAR_INPUT a : SXml Attribute; value : UDINT; END_VAR Return value Name Type Set Attribute As Uint SXml Attribute 298 Version: 1.12.0 TF6701
## Page 299

PLC API Inputs Name Type a SXml Attribute value UDINT Sample call: xml Attr := fb Xml. Set Attribute As Uint(xml Existing Attr, 42); 5.2.1.7.88 Set Attribute As Ulint This method sets the value of an attribute. The value has the data type Unsigned Integer64. Syntax METHOD Set Attribute As Ulint : SXml Attribute VAR_INPUT a : SXml Attribute; value : ULINT; END_VAR Return value Name Type Set Attribute As Ulint SXml Attribute Inputs Name Type a SXml Attribute value ULINT Sample call: xml Attr := fb Xml. Set Attribute As Ulint(xml Existing Attr, 42); 5.2.1.7.89 Set Child This method sets the value of an XML node. The value is transferred to the method as input parameter of data type String. The input parameter cdata indicates whether the value of the node is to be encapsulated in a CDATA function block, so that certain special characters such as "<" and ">" are allowed as values. Syntax METHOD Set Child : SXml Node VAR_INPUT n : SXml Node; END_VAR VAR_IN_OUT CONSTANT value : STRING; END_VAR VAR_INPUT cdata : BOOL; END_VAR TF6701 Version: 1.12.0 299
## Page 300

PLC API Return value Name Type Set Child SXml Node Inputs Name Type n SXml Node cdata BOOL / Inputs/Outputs Name Type value STRING Sample call: xml Node := fb Xml. Set Child(xml Existing Node, 'Some Text', FALSE); 5.2.1.7.90 Set Child As Bool This method sets the value of an XML node. The value is transferred to the method as input parameter of data type Boolean. Syntax METHOD Set Child As Bool : SXml Node VAR_INPUT n : SXml Node; value : BOOL; END_VAR Return value Name Type Set Child As Bool SXml Node Inputs Name Type n SXml Node value BOOL Sample call: xml Node := fb Xml. Set Child(xml Existing Node, TRUE); 5.2.1.7.91 Set Child As Double 300 Version: 1.12.0 TF6701
## Page 301

PLC API This method sets the value of an XML node. The value is transferred to the method as input parameter of data type Double. Syntax METHOD Set Child As Double : SXml Node VAR_INPUT n : SXml Node; value : LREAL; END_VAR Return value Name Type Set Child As Double SXml Node Inputs Name Type n SXml Node value LREAL Sample call: xml Node := fb Xml. Set Child As Double(xml Existing Node, 42.42); 5.2.1.7.92 Set Child As Float This method sets the value of an XML node. The value is transferred to the method as input parameter of data type Float. Syntax METHOD Set Child As Float : SXml Node VAR_INPUT n : SXml Node; value : REAL; END_VAR Return value Name Type Set Child As Float SXml Node Inputs Name Type n SXml Node value REAL Sample call: xml Node := fb Xml. Set Child As Float(xml Existing Node, 42.42); TF6701 Version: 1.12.0 301
## Page 302

PLC API 5.2.1.7.93 Set Child As Int This method sets the value of an XML node. The value is transferred to the method as input parameter of data type Integer. Syntax METHOD Set Child As Int : SXml Node VAR_INPUT n : SXml Node; value : DINT; END_VAR Return value Name Type Set Child As Int SXml Node Inputs Name Type n SXml Node value DINT Sample call: xml Node := fb Xml. Set Child As Int(xml Existing Node, 42); 5.2.1.7.94 Set Child As Lint This method sets the value of an XML node. The value is transferred to the method as input parameter of data type Integer64. Syntax METHOD Set Child As Lint : SXml Node VAR_INPUT n : SXml Node; value : LINT; END_VAR Return value Name Type Set Child As Lint SXml Node Inputs Name Type n SXml Node value LINT 302 Version: 1.12.0 TF6701
## Page 303

PLC API Sample call: xml Node := fb Xml. Set Child As Lint(xml Existing Node, 42); 5.2.1.7.95 Set Child As Uint This method sets the value of an XML node. The value is transferred to the method as input parameter of data type Unsigned Integer. Syntax METHOD Set Child As Uint : SXml Node VAR_INPUT n : SXml Node; value : UDINT; END_VAR Return value Name Type Set Child As Uint SXml Node Inputs Name Type n SXml Node value UDINT Sample call: xml Node := fb Xml. Set Child As Uint(xml Existing Node, 42); 5.2.1.7.96 Set Child As Ulint This method sets the value of an XML node. The value is transferred to the method as input parameter of data type Unsigned Integer64. Syntax METHOD Set Child As Ulint : SXml Node VAR_INPUT n : SXml Node; value : ULINT; END_VAR Return value Name Type Set Child As Ulint SXml Node TF6701 Version: 1.12.0 303
## Page 304

PLC API Inputs Name Type n SXml Node value ULINT Sample call: xml Node := fb Xml. Set Child As Ulint(xml Existing Node, 42); 5.2.1.8 FB_Jwt Encode The function block enables the creation and signing of a JSON Web Token (JWT). Syntax Definition: FUNCTION_BLOCK FB_Jwt Encode VAR_INPUT b Execute : BOOL; s Header Alg : STRING(46); s Payload : STRING(1023); s Key File Path : STRING(511); t Timeout : TIME; p Key : PVOID; n Key Size : UDINT; n Jwt Size : UDINT; END_VAR VAR_IN_OUT CONSTANT s Jwt : STRING; END_VAR VAR_OUTPUT b Busy : BOOL; b Error : BOOL; hr Error Code : HRESULT; init Status : HRESULT; END_VAR 304 Version: 1.12.0 TF6701
## Page 305

PLC API Inputs Name Type Description b Execute BOOL A rising edge activates processing of the function block. s Header Alg STRING(46) The algorithm to be used for the JWT header, e.g. RS256. s Payload STRING(1023) The JWT payload to be used. s Key File Path STRING(511) Path to the private key to be used for the signature of the JWT. t Timeout TIME ADS timeout, which is used internally for file access to the private key. p Key PVOID Buffer for the private key to be read. n Key Size UDINT Maximum size of the buffer. s Jwt STRING [} 62] Contains the fully coded and signed JWT after the function block has been processed. n Jwt Size UDINT [} 63] Size of the generated JWT including zero termination. Outputs Name Type Description b Busy BOOL Is TRUE as long as processing of the function block is in progress. b Error BOOL Becomes TRUE as soon as an error situation occurs. hr Error Code HRESULT Returns an error code if the b Error output is set. An explanation of the possible error codes [} 339] can be found in the Appendix. init Status HRESULT Returns an error code in case of a failed initialization of the function block. Requirements Twin CAT version Hardware Libraries to be integrated Twin CAT 3.1, Build 4024.4 x86, x64, ARM Tc3_Json Xml 3.3.6.0 5.2.2 Interfaces 5.2.2.1 ITc Json Sax Handler 5.2.2.1.1 On Bool This callback method is triggered if a value of the data type BOOL was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Bool : HRESULT VAR_INPUT value : BOOL; END_VAR TF6701 Version: 1.12.0 305
## Page 306

PLC API 5.2.2.1.2 On Dint This callback method is triggered if a value of the data type DINT was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Dint : HRESULT VAR_INPUT value : DINT; END_VAR 5.2.2.1.3 On End Array This callback method is triggered if a square closing bracket, which corresponds to the JSON synonym for an ending array, was found at the position of the SAX reader. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On End Array : HRESULT 5.2.2.1.4 On End Object This callback method is triggered if a curly closing bracket, which corresponds to the JSON synonym for an ending object, was found at the position of the SAX reader. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On End Object : HRESULT 5.2.2.1.5 On Key This callback method is triggered if a property was found at the position of the SAX reader. The property name lies on the input/output parameter key and its length on the input parameter len. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Key : HRESULT VAR_IN_OUT CONSTANT key : STRING; END_VAR VAR_INPUT len : UDINT; END_VAR 5.2.2.1.6 On Lint This callback method is triggered if a value of the data type LINT was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Lint : HRESULT VAR_INPUT value : LINT; END_VAR 306 Version: 1.12.0 TF6701
## Page 307

PLC API 5.2.2.1.7 On Lreal This callback method is triggered if a value of the data type LREAL was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Lreal : HRESULT VAR_INPUT value : LREAL; END_VAR 5.2.2.1.8 On Null This callback method is triggered if a NULL value was found at the position of the SAX reader. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Null : HRESULT 5.2.2.1.9 On Start Array This callback method is triggered if a square opening bracket, which corresponds to the JSON synonym for a starting array, was found at the position of the SAX reader. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Start Array : HRESULT 5.2.2.1.10 On Start Object This callback method is triggered if a curly opening bracket, which corresponds to the JSON synonym for a starting object, was found at the position of the SAX reader. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Start Object : HRESULT 5.2.2.1.11 On String This callback method is triggered if a value of the data type STRING was found at the position of the SAX reader. The In/Out parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On String : HRESULT VAR_IN_OUT CONSTANT value : STRING; END_VAR VAR_INPUT len : UDINT; END_VAR 5.2.2.1.12 On Udint This callback method is triggered if a value of the data type UDINT was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. TF6701 Version: 1.12.0 307
## Page 308

PLC API Syntax METHOD On Udint : HRESULT VAR_INPUT value : UDINT; END_VAR 5.2.2.1.13 On Ulint This callback method is triggered if a value of the data type ULINT was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Ulint : HRESULT VAR_INPUT value : ULINT; END_VAR 5.2.2.2 ITc Json Sax Values 5.2.2.2.1 On Bool Value This callback method is triggered if a value of the data type BOOL was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Bool Value : HRESULT VAR_INPUT level : UDINT; infos : POINTER TO Tc Json Level Info; value : BOOL; END_VAR 5.2.2.2.2 On Dint Value This callback method is triggered if a value of the data type DINT was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Dint Value : HRESULT VAR_INPUT level : UDINT; infos : POINTER TO Tc Json Level Info; value : DINT; END_VAR 5.2.2.2.3 On Lint Value This callback method is triggered if a value of the data type LINT was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Lint Value : HRESULT VAR_INPUT level : UDINT; infos : POINTER TO Tc Json Level Info; value : LINT; END_VAR 308 Version: 1.12.0 TF6701
## Page 309

PLC API 5.2.2.2.4 On Lreal Value This callback method is triggered if a value of the data type LREAL was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Lreal Value : HRESULT VAR_INPUT level : UDINT; infos : POINTER TO Tc Json Level Info; value : LREAL; END_VAR 5.2.2.2.5 On Null Value This callback method is triggered if a NULL value was found at the position of the SAX reader. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Null : HRESULT VAR_INPUT level : UDINT; infos : POINTER TO Tc Json Level Info; END_VAR 5.2.2.2.6 On String Value This callback method is triggered if a value of the data type STRING was found at the position of the SAX reader. The input/output parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On String Value : HRESULT VAR_IN_OUT CONSTANT value : STRING; END_VAR VAR_INPUT len : UDINT; level : UDINT; infos : POINTER TO Tc Json Level Info; END_VAR 5.2.2.2.7 On Udint Value This callback method is triggered if a value of the data type UDINT was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. Syntax METHOD On Udint Value : HRESULT VAR_INPUT level : UDINT; infos : POINTER TO Tc Json Level Info; value : UDINT; END_VAR 5.2.2.2.8 On Ulint Value This callback method is triggered if a value of the data type ULINT was found at the position of the SAX reader. The input parameter value contains the value found. The SAX parsing procedure is aborted by setting the return value HRESULT to S_FALSE. TF6701 Version: 1.12.0 309
## Page 310

PLC API Syntax METHOD On Ulint Value : HRESULT VAR_INPUT level : UDINT; infos : POINTER TO Tc Json Level Info; value : ULINT; END_VAR 310 Version: 1.12.0 TF6701
## Page 311

Samples 6 Samples The following samples illustrate the communication with an MQTT broker. Messages are sent and received. There are two different implementation options, which can be chosen based on purely subjective criteria. The two options are compared in the first two samples. Overview Sample Link Description 1 Iot Mqtt Sample Using Queue [} 312] MQTT communication based on a messages queue 2 Iot Mqtt Sample Using Callback [} 314] MQTT communication based on a callback method 3 Iot Mqtt Sample Tls Psk [} 316] MQTT communication via a secure TLS connection and PSK (Pre Shared Key) 4 Iot Mqtt Sample Tls Ca [} 317] MQTT communication via a secure TLS connection and CA (certificate authority) certificate 5 Iot Mqtt Sample Aws Io T [} 317] MQTT communication with AWS Io T 6 Iot Mqtt Sample Azure Iot Hub [} 320] MQTT communication with the Microsoft Azure Io T Hub 7 Iot Mqtt Sample Ibm Watson Io T [} 323] MQTT communication with IBM Watson Io T 8 Iot Mqtt Sample Mathworks Thingspeak MQTT communication with the Thing Speak Io T platform from Math Works [} 324] 9 Iot Mqttv5Sample [} 325] MQTTv5 communication based on a messages queue 10 Iot Mqttv5Last Will Sample [} 328] Demonstrates the use of Last Will in interaction with the MQTTv5 function blocks. 11 Iot Mqttv5Req Res Sample [} 328] Demonstrates the request/response mechanism of MQTTv5, as well as the handling of User Properties and Correlation Data 12 Iot Mqttv5User Props Sample [} 329] Demonstrates the use of user properties, which are part of MQTTv5. 13 Json Xml Samples [} 330] Contains various samples demonstrating the use of the JSON/XML parsers from the PLC library Tc3_Json Xml. Downloads Sample code and configurations for this product can be obtained from the corresponding repository on Git Hub: https://www.github.com/Beckhoff/TF6701_Samples. There you have the option to clone the repository or download a ZIP file containing the sample. TF6701 Version: 1.12.0 311
## Page 312

Samples 6.1 Iot Mqtt Sample Using Queue Sample for MQTT communication via a message queue This sample illustrates the communication with an MQTT broker. Messages are sent (publish mode) and received. This is done in two steps. First, a general decision is made on which types of messages are to be received ("Subscribe"). Then, received messages are collected in a message queue, from where they can be read and evaluated. Project structure 1. Create a Twin CAT project with a PLC and add Tc3_Iot Base as library reference. 2. Create a program block and declare an instance of FB_Iot Mqtt Client [} 55] and two auxiliary variables to control the program sequence, if required. PROGRAM Prg Mqtt Com VAR fb Mqtt Client : FB_Iot Mqtt Client; b Set Parameter : BOOL := TRUE; b Connect : BOOL := TRUE; END_VAR 3. Declare two variables (for topic and payload) for the MQTT message to be sent. In the sample a message is to be sent every second. (* published message *) s Topic Pub : STRING(255) := 'My Topic'; s Payload Pub : STRING(255); i : UDINT; fb Timer : TON := (PT:=T#1S); 4. For message reception, declare a variable that contains the topic to be received and two other variables that indicate the topic and payload of the last received message. The received messages are to be collected in a queue so that they can be evaluated one after the other. For this you declare an instance of FB_Iot Mqtt Message Queue [} 64] and an instance of FB_Iot Mqtt Message [} 66]. (* received message *) b Subscribed : BOOL; s Topic Sub : STRING(255) := 'My Topic'; {attribute 'Tc Encoding':='UTF-8'} s Topic Rcv : STRING(255); {attribute 'Tc Encoding':='UTF-8'} s Payload Rcv : STRING(255); fb Message Queue : FB_Iot Mqtt Message Queue; fb Message : FB_Iot Mqtt Message; 312 Version: 1.12.0 TF6701
## Page 313

Samples 5. In the program part, the MQTT client must be triggered cyclically, in order to ensure that a connection to the broker is established and maintained and the message is received. Set the parameters of the desired connection and initialize the connection with the transfer parameter b Connect := TRUE. In the sample the parameters are assigned once in the program code before the client call. Since this is usually only required once, the parameters can already be specified in the declaration part during instantiation of the MQTT client. Not all parameters have to be assigned. In the sample the broker is local. The IP address or the name can also be specified. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.s Host Name := 'localhost'; fb Mqtt Client.n Host Port := 1883; // fb Mqtt Client.s Client Id := 'My Tc Mqtt Client'; fb Mqtt Client.s Topic Prefix := ''; // fb Mqtt Client.n Keep Alive := 60; // fb Mqtt Client.s User Name := ; // fb Mqtt Client.s User Password := ; // fb Mqtt Client.st Will := ; // fb Mqtt Client.st TLS := ; fb Mqtt Client.ip Message Queue := fb Message Queue; END_IF fb Mqtt Client. Execute(b Connect); 6. As soon as the connection to the broker is established, the client should subscribe to a particular topic. Likewise, a message is to be sent every second. In the sample s Topic Pub = s Topic Sub, so that a loopback is created. In other applications the topics usually differ. IF fb Mqtt Client.b Connected THEN IF NOT b Subscribed THEN b Subscribed := fb Mqtt Client. Subscribe(s Topic:=s Topic Sub, e Qo S:=Tc Iot Mqtt Qos. At Most Once De livery); END_IF fb Timer(IN:=TRUE); IF fb Timer. Q THEN // publish new payload every second fb Timer(IN:=FALSE); i := i + 1; s Payload Pub := CONCAT('My Message', TO_STRING(i)); fb Mqtt Client. Publish( s Topic:= s Topic Pub, p Payload:= ADR(s Payload Pub), n Payload Size:= LEN2(ADR(s Payload Pub ))+1, e Qo S:= Tc Iot Mqtt Qos. At Most Once Delivery, b Retain:= FALSE, b Queue: = FALSE ); END_IF END_IF 7. The cyclic call of the MQTT client ensures that the messages are received. The client receives all messages with topics to which it has previously subscribed with the broker and places them in the message queue. Once messages are available, call the method Dequeue() to gain access to the message properties such as topic or payload via the message object fb Message. IF fb Message Queue.n Queued Messages > 0 THEN IF fb Message Queue. Dequeue(fb Message:=fb Message) THEN fb Message. Get Topic(p Topic:=ADR(s Topic Rcv), n Topic Size:=SIZEOF(s Topic Rcv) ); fb Message. Get Payload(p Payload:=ADR(s Payload Rcv), n Payload Size:=SIZEOF(s Payload Rcv), b Set Null Termination:=FALSE); END_IF END_IF If message evaluation is implemented as described above, one received message is evaluated per cycle. If several messages were accumulated in the message queue, the evaluation is distributed over several cycles. The sample can be modified for applications in which subscriptions to several topics exist. In this case MQTT messages with different topics are received. Message evaluation can be expanded as follows: VAR (* received payload for each subscribed topic *) s Payload Rcv1 : STRING(255); s Payload Rcv2 : STRING(255); END_VAR VAR CONSTANT (* subscriptions *) s Topic Sub1 : STRING(255) := 'my first topic'; s Topic Sub2 : STRING(255) := 'my second topic'; END_VAR ---------------------------------------------------------------- TF6701 Version: 1.12.0 313
## Page 314

Samples IF fb Message Queue.n Queued Messages > 0 THEN IF fb Message Queue. Dequeue(fb Message:=fb Message) THEN IF fb Message. Compare Topic(s Topic:=s Topic Sub1) THEN fb Message. Get Payload(p Payload:=ADR(s Payload Rcv1), n Payload Size:=SIZEOF(s Payload Rcv1), b S et Null Termination:=FALSE); ELSIF fb Message. Compare Topic(s Topic:=s Topic Sub2) THEN fb Message. Get Payload(p Payload:=ADR(s Payload Rcv2), n Payload Size:=SIZEOF(s Payload Rcv2), b S et Null Termination:=FALSE); END_IF END_IF END_IF Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base, Tc2_Utilities (>= v3.3.19.0) 6.2 Iot Mqtt Sample Using Callback Sample for MQTT communication via a callback method This sample illustrates the communication with an MQTT broker. Messages are sent (publish mode) and received. This is done in two steps. First, a general decision is made on which types of messages are to be received ("Subscribe"). Subsequently, new messages are received via a callback method during the cyclic call of the FB_Iot Mqtt Client. Execute() method. Project structure 1. Create a Twin CAT project with a PLC and add Tc3_Iot Base as library reference. 2. The callback method, in which the received MQTT messages are provided, should be implemented by users themselves. The inheritance principle is used to ensure that the Twin CAT driver can call this method. First, create a function block and let the function block FB_Iot Mqtt Client inherit it. Part of the MQTT communication can already be encapsulated in this function block. In the sample, received messages are evaluated here. It is therefore advisable to declare variables for topic and payload. {attribute 'c++_compatible'} FUNCTION_BLOCK FB_My Mqtt EXTENDS FB_Iot Mqtt Client VAR (* received message *) {attribute 'Tc Encoding':='UTF-8'} s Topic Rcv : STRING(255); {attribute 'Tc Encoding':='UTF-8'} s Payload Rcv : STRING(255); END_VAR 3. Create the method On Mqtt Message() and overwrite the basic implementation. 314 Version: 1.12.0 TF6701
## Page 315

Samples 4. The method with the implementation to be carried out by the user is not called in the application, but implicitly by the driver. This callback takes place during the cyclic triggering of the client and can take place either not at all, once or several times, depending on the number of messages received since the last trigger. This sample only implements a simple evaluation, as shown in the following code snippet. {attribute 'c++_compatible'} {attribute 'pack_mode' := '4'} {attribute 'show'} {attribute 'minimal_input_size' := '4'} METHOD On Mqtt Message : HRESULT VAR_IN_OUT CONSTANT topic : STRING; END_VAR VAR_INPUT payload : PVOID; length : UDINT; qos : Tc Iot Mqtt Qos; repeated : BOOL; END_VAR VAR n Payload Rcv Len : UDINT; END_VAR ----------------------------------------------------------------------- SUPER^.n Messages Rcv := SUPER^.n Messages Rcv + 1; STRNCPY( ADR(s Topic Rcv), ADR(topic), SIZEOF(s Topic Rcv) ); n Payload Rcv Len := MIN(length, DINT_TO_UDINT(SIZEOF(s Payload Rcv))-1); MEMCPY( ADR(s Payload Rcv), payload, n Payload Rcv Len ); s Payload Rcv[n Payload Rcv Len] := 0; // ensure a null termination of received string On Mqtt Message := S_OK; 5. The other steps are similar to the sample MQTT communication via a message queue [} 312]. Create a program block and declare an instance of the previously declared function block FB_My Mqtt and two auxiliary variables to control the program sequence, if required. PROGRAM Prg Mqtt Com VAR fb Mqtt Client : FB_My Mqtt; b Set Parameter : BOOL := TRUE; b Connect : BOOL := TRUE; END_VAR 6. Declare two variables (for topic and payload) for the MQTT message to be sent. In the sample a message is to be sent every second. (* published message *) s Topic Pub : STRING(255) := 'My Topic'; s Payload Pub : STRING(255); i: UDINT; fb Timer : TON := (PT:=T#1S); 7. To receive messages, declare a variable that contains the topic to be received. b Subscribed : BOOL; s Topic Sub : STRING(255) := 'My Topic'; 8. In the program part, the MQTT client must be triggered cyclically, in order to ensure that a connection to the broker is established and maintained and the message is received. Set the parameters of the desired connection and initialize the connection with the transfer parameter b Connect := TRUE. In the sample the parameters are assigned once in the program code before the client call. Since this is usually only required once, the parameters can already be specified in the declaration part during instantiation of the MQTT client. Not all parameters have to be assigned. In the sample the broker is local. The IP address or the name can also be specified. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.s Host Name := 'localhost'; fb Mqtt Client.n Host Port := 1883; // fb Mqtt Client.s Client Id := 'My Tc Mqtt Client'; fb Mqtt Client.s Topic Prefix := ''; // fb Mqtt Client.n Keep Alive := 60; // fb Mqtt Client.s User Name := ; // fb Mqtt Client.s User Password := ; // fb Mqtt Client.st Will := ; // fb Mqtt Client.st TLS := ; END_IF fb Mqtt Client. Execute(b Connect); TF6701 Version: 1.12.0 315
## Page 316

Samples 9. As soon as the connection to the broker is established, the client should subscribe to a particular topic. A message should be sent every second. In the sample s Topic Pub = s Topic Sub applies, so that a loop-back occurs. In other applications the topics usually differ. IF fb Mqtt Client.b Connected THEN IF NOT b Subscribed THEN b Subscribed := fb Mqtt Client. Subscribe(s Topic:=s Topic Sub, e Qo S:=Tc Iot Mqtt Qos. At Most Once De livery); END_IF fb Timer(IN:=TRUE); IF fb Timer. Q THEN // publish new payload every second fb Timer(IN:=FALSE); i := i + 1; s Payload Pub := CONCAT('My Message', TO_STRING(i)); fb Mqtt Client. Publish( s Topic:= s Topic Pub, p Payload:= ADR(s Payload Pub), n Payload Size:= LEN2(ADR(s Payload Pub ))+1, e Qo S:= Tc Iot Mqtt Qos. At Most Once Delivery, b Retain:= FALSE, b Queue: = FALSE ); END_IF END_IF Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base, Tc2_Utilities (>= v3.3.19.0) 6.3 Iot Mqtt Sample Tls Psk Sample for MQTT communication via a secure TLS connection and PSK (Pre Shared Key) This sample illustrates the communication with an MQTT broker that requires authentication via TLS PSK. The sample is basically limited to establishing the connection and publishing of values. Project structure 1. Create a Twin CAT project with a PLC and add Tc3_Iot Base as library reference. 2. Create a program block and declare an instance of FB_Iot Mqtt Client [} 55] and two auxiliary variables to control the program sequence, if required. PROGRAM Prg Mqtt Com VAR fb Mqtt Client : FB_Iot Mqtt Client; b Set Parameter : BOOL := TRUE; b Connect : BOOL := TRUE; END_VAR 3. Declare two variables (for topic and payload) for the MQTT message to be sent. In the sample a message is to be sent every second. s Topic Pub : STRING(255) := 'My Topic'; s Payload Pub : STRING(255); i : UDINT; fb Timer : TON := (PT:=T#1S); 4. In the program part the MQTT client must be triggered cyclically, in order to ensure that a connection to the broker is established and maintained. Set the parameters of the desired connection and initialize the connection with the transfer parameter b Connect := TRUE. In the sample the parameters are assigned once in the program code before the client call. Since this is usually only required once, the parameters can already be specified in the declaration part during instantiation of the MQTT client. Not all parameters have to be assigned. In the sample the broker is local. The IP address or the name can also be specified. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.st TLS.s Psk Identity := 'my_Identity'; fb Mqtt Client.st TLS.a Psk Key := c My Psk Key; fb Mqtt Client.st TLS.n Psk Key Len := 15; fb Mqtt Client.n Host Port := 8883; 316 Version: 1.12.0 TF6701
## Page 317

Samples END_IF fb Mqtt Client. Execute(b Connect); 5. The structure element a Psk Key receives the Pre Shared Key, which is required for establishing a connection to the broker. Accordingly, this must be specified as an ARRAY OF BYTE with a length of 64. The actual length of the keys is then transferred to the structure element n Psk Key Len. 6. Once the connection to the broker is established, the client should send a message to a particular topic every second. IF fb Mqtt Client.b Connected THEN fb Timer(IN:=TRUE); IF fb Timer. Q THEN // publish new payload every second fb Timer(IN:=FALSE); i := i + 1; s Payload Pub := CONCAT('My Message', TO_STRING(i)); fb Mqtt Client. Publish(s Topic:= s Topic Pub, p Payload:= ADR(s Payload Pub), n Payload Size:= LEN2(ADR(s Payload Pub))+1, e Qo S:= Tc Iot Mqtt Qos. At Most Once Delivery, b Retain:= FALSE, b Queue:= FALSE); END_IF END_IF Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base, Tc2_Utilities (>= v3.3.19.0) 6.4 Iot Mqtt Sample Tls Ca Sample for MQTT communication via a secured TLS connection and CA This sample illustrates the communication with an MQTT broker that requires authentication via TLS and a client certificate. This sample is not available as a separate download, since it is essentially based on the existing samples Iot Mqtt Sample Using Queue [} 312] and in particular Iot Mqtt Sample Aws Io T [} 317]. The latter demonstrates the application of client certificates with TF6701 and can be used in the same way for all other MQTT brokers. Parameters for establishing a connection The following code snippet shows the parameters required for establishing a TLS connection to an MQTT broker via client certificate. The parameters are essentially static parameters. These can also be specified in the declaration part during instantiation of the MQTT client. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.st TLS.s CA := 'c:\Twin CAT\3.1\Config\Certificates\root Ca.pem'; fb Mqtt Client.st TLS.s Cert := 'c:\Twin CAT\3.1\Config\Certificates\client Cert.pem.crt'; fb Mqtt Client.st TLS.s Key File := 'c:\Twin CAT\3.1\Config\Certificates\client Priv Key.pem.key'; END_IF Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base, Tc2_Utilities (>= v3.3.19.0) 6.5 Iot Mqtt Sample Aws Io T Sample for MQTT communication with AWS Io T Core TF6701 Version: 1.12.0 317
## Page 318

Samples This sample illustrates the communication with the AWS Io T Core message broker, which is part of the AWS Io T platform. The message broker requires authentication via a TLS client certificate. As a prerequisite for this, the corresponding certificate must have been created and be known and activated on the AWS Io T platform. You can use self-signed certificates on the AWS Io T Management Console or have certificates signed by your own Certificate Authority (CA). In the latter case, your own CA must be trusted accordingly by the AWS Io T Core platform. Initial setup of AWS Io T Core Information on creating and registering client certificates and the initial setup of AWS Io T Core can be found in the official AWS Io T Core documentation. The certificate created and activated there is used by the MQTT function blocks to establish a connection with the message broker. Ensure that you have linked a valid AWS Io T policy with the certificate you created. Further information can be found in the following articles, which are part of the AWS Io T Core documentation: AWS Io T Core Security and Identity X.509 Certificates Authentication Topic structure The topic structure of the AWS Io T Core message broker is essentially freely selectable, although some restrictions apply. There are certain system topics that may not be used. Please refer to the AWS Io T Core documentation for more information. We also recommend the AWS documentation on AWS Io T Core MQTT topic design. Qo S and Retain AWS Io T Core currently does not support Qo S 2 or Retain messages. To store persistent messages, additional services, such as AWS Io T Device Shadow or a database service, must be used. AWS Io T Core Service Limits When using AWS Io T Core, please also refer to the notes on AWS Service Limits. In this sample, messages are sent to and received from the AWS Io T Core message broker. Since this sample is essentially based on the sample Iot Mqtt Sample Using Queue [} 312], only the parts that are relevant for establishing a connection to AWS Io T Core are explained in this section. Parameters for establishing a connection The following code snippet shows the parameters required for establishing a connection to AWS Io T Core. The parameters are essentially static parameters. These can also be specified in the declaration part during instantiation of the MQTT client. The following information is required for establishing a connection to AWS Io T Core. 318 Version: 1.12.0 TF6701
## Page 319

Samples Parameter Description fb Mqtt Client.st TLS.s CA Amazon Root CA certificate, which can be downloaded from the AWS Io T Management Console. fb Mqtt Client.st TLS.s Cert Certificate of the device, which is required for authentication to establish a connection to AWS Io T. Both self-signed certificates and CA-signed certificates can be used. In the case of CA-signed certificates, the own CA must be classified as trustworthy on the AWS Io T Core Management Console. For more information, please refer to the AWS Io T Core documentation. fb Mqtt Client.st TLS.s Key File Private key of the device. fb Mqtt Client.s Hostname Host name of the AWS Io T broker instance fb Mqtt Client.n Host Port Since a connection to the AWS Io T broker can only be established via TLS, the default MQTT TLS port must be used here (8883). fb Mqtt Client.s Client Id The MQTT client ID can be the same as the name of the "thing". Exponential backoff The use of an exponential backoff algorithm, as shown in the code snippet, is optional but recommended. See below. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.st TLS.s CA := 'c:\Twin CAT\3.1\Config\Certificates\Amazon Root CA1.pem'; fb Mqtt Client.st TLS.s Cert := 'c:\Twin CAT\3.1\Config\Certificates\7613eee18a-certificate.pem.crt'; fb Mqtt Client.st TLS.s Key File := 'c:\Twin CAT\3.1\Config\Certificates\7613eee18a-private.pem.key'; fb Mqtt Client.s Host Name:= 'a35raby201xp77.iot.eu-west-1.amazonaws.com'; fb Mqtt Client.n Host Port:= 8883; fb Mqtt Client.s Client Id:= 'CX-12345'; fb Mqtt Client.ip Message Queue := fb Message Queue; fb Mqtt Client. Activate Exponential Backoff(T#1S, T#30S); END_IF Exponential backoff A feature referred to as "exponential backoff" can be used to avoid burdening the message broker with unnecessary connection requests in case of a connection error. In the event of a TLS connection error involving the message broker, the reconnect rate is adjusted multiplicatively. This function can be activated using the Activate Exponential Backoff() [} 61] method. The parameters of the method specify the minimum and maximum time for the algorithm. The minimum time describes the initial delay value for the new connection attempt. The maximum time describes the highest delay value. The delay values are doubled until the maximum value is reached. Once a connection has been established, the backoff rate is reset to the original value. The Deactivate Exponential Backoff() [} 62] method can be used to deactivate this function programmatically. Device Shadow Service The AWS Io T Device Shadow Service enables persistent storage of status information of a connected device. A separate shadow is managed for each device. The shadow of a device can be read and updated via MQTT. Certain system topics of the AWS Io T Core must be used for this purpose. For example, the following topic enables updating the shadow. s Topic Shadow Update : STRING(255) := '$$aws/things/CX-12345/shadow/update'; The message sent to this topic describes the new shadow of the device. It is specified in JSON notation and corresponds to a particular format, e.g.: { "state": { "reported": { "Vendor": "Beckhoff Automation", "Cpu Temperature": 42, "Operating System": "Windows 10" } } } The PLC library Tc3_Json Xml can be used to create and adapt this format to suit your application. In the PLC code provided here, the device shadow is updated once at the start of the sample and then on request (depending on the variable b Update Shadow). TF6701 Version: 1.12.0 319
## Page 320

Samples For more information about the AWS Io T Device Shadow Service and its topics and data formats see the AWS Io T Device Shadow Service documentation. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base, Tc2_Utilities (>= v3.3.19.0) 6.6 Iot Mqtt Sample Azure Iot Hub Sample of MQTT communication with the Microsoft Azure Io T Hub This sample shows communication with the Microsoft Azure Io T Hub, which is part of the Microsoft Azure cloud. The message broker can be reached via MQTT and requires authentication via an SAS token, which can be generated via the Azure Io T Hub platform, e.g. using the Azure Io T Explorer. Initial setup of Azure Io T Hub For information on the initial setup of the Microsoft Azure Io T Hub and corresponding access data for devices to be connected, see the official Microsoft Azure Io T Hub documentation. We also recommend the Microsoft documentation article on using MQTT with the Azure Io T Hub. Topic structure The topic structure for sending and receiving messages is predefined by the Microsoft Azure Io T Hub. Authentication You can use either a SAS token or X509 certificates to authenticate the MQTT client. Qo S and Retain The Azure Io T Hub does not support Qo S 2 and Retain messages. In this sample, messages are sent to the Azure Io T Hub and received from it. Since this sample is essentially based on the Iot Mqtt Sample Using Queue [} 312] sample, only the parts that are relevant for establishing a connection to the Io T Hub are explained in this section. Parameters for establishing a connection The following code snippet shows the parameters required for establishing a connection to the Azure Io T Hub. The parameters are essentially static parameters. These can also be specified in the declaration part during instantiation of the MQTT client. IF b Set Parameter THEN b Set Parameter := FALSE; (* Option 1: authentication via Device SAS Token *) fb Mqtt Client.st TLS.s CA := 'c: \Twin CAT\3.1\Config\Certificates\Digi Cert Global Root G2.cer'; // CA certificate fb Mqtt Client.st TLS.s Azure Sas := 'Place Device Sas Token Here'; // Device SAS Token (* Option 2: authentication via X509 certificate *) //fb Mqtt Client.st TLS.s CA := 'c: \Twin CAT\3.1\Config\Certificates\Digi Cert Global Root G2.cer'; // CA certificate //fb Mqtt Client.st TLS.s Cert := 'c:\Twin CAT\3.1\Config\Certificates\My Device Cert.pem'; //fb Mqtt Client.st TLS.s Key File := 'c:\Twin CAT\3.1\Config\Certificates\My Device Cert.key'; //fb Mqtt Client.s Host Name:= my Iot Hub.azure-devices.net'; //fb Mqtt Client.n Host Port:= 8883; //fb Mqtt Client.s Client Id := 'My Device'; //fb Mqtt Client.s User Name := 'my Iot Hub.azure-devices.net/My Device/?api-version=2021-04-12'; fb Mqtt Client.ip Message Queue := fb Message Queue; END_IF 320 Version: 1.12.0 TF6701
## Page 321

Samples You can use either a SAS token or X509 certificates to authenticate the MQTT client on the Azure Io T hub. Depending on the authentication type, certain connection parameters must be set. The following table provides an overview of the parameters to be set. SAS token X509 certificate st TLS.s CA Path to the CA certificate used by Path to the CA certificate used by the Azure Io T Hub. See below. the Azure Io T Hub. See below. st TLS.s Azure Sas SAS token, which can be --- generated via the Azure File Explorer. st TLS.s Cert --- Path to the client certificate. st TLS.s Key --- Path to the private key. s Hostname Does not have to be set explicitly. Host name of the Azure Io T Hub The host name is derived from the instance. SAS token. n Host Port Does not have to be set explicitly. 8883 The port is automatically set to 8883 when using a SAS token. s Client Id Does not have to be set explicitly. Corresponds to the device name of The client ID is derived from the the created device in the Azure Io T SAS token. Hub. s User Name Does not have to be set explicitly. Corresponds to a fixed naming The user name is derived from the scheme, which includes both the SAS token. Io T hub name and device name. For more information, please refer to the Azure Io T Hub documentation. CA certificate When establishing a connection to the Microsoft Azure Io T Hub via MQTT, the specification of a CA certificate is mandatory, both when using a SAS token and when using X509 certificates for client authentication. Please always consult the Microsoft documentation to find out the currently valid root CA. In most cases, the associated public key of the respective root CA can be extracted from the Microsoft Windows Certificate Console (Start > Run > mmc.exe, then add the Snap In "Certificates"). The root CA can then be found under the heading Trusted Root Certification Authorities. See also screenshot below for comparison. Publish When data are published to the Io T Hub, the topic must be specified in the following form: devices / device Id / messages / events / readpipe The Device Id corresponds to the Device Id of the registered device, as specified in the Azure Io T Explorer, for example. TF6701 Version: 1.12.0 321
## Page 322

Samples Subscribe When subscribing to data from the Io T Hub, the topic must be specified in the following form: devices / device Id / messages / devicebound / # The Device Id corresponds to the Device Id of the registered device, as specified in the Azure Io T Explorer, for example. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base, Tc2_Utilities (>= v3.3.19.0) 6.7 Iot Mqtt Sample Bosch Io T Sample for MQTT communication with the Bosch Io T Hub This sample shows the communication with the Bosch Io T Hub, which is part of the Bosch Io T Suite. This message broker requires the use of TLS and user name/password authentication. Initial setup of the Bosch Io T Hub Information on the initial setup of the Bosch Io T Hub can be found in the official Bosch Io T Suite documentation. Topic structure The topic structure for sending and receiving messages is predefined by the message broker of the Bosch Io T Suite. In this sample messages are sent to the Bosch Io T Hub and received from it. Since this sample is essentially based on the sample Iot Mqtt Sample Using Queue [} 312], only the parts that are relevant for establishing a connection to the Bosch Io T Hub are explained in this section. Parameters for establishing a connection The following code snippet shows the parameters required for establishing a connection to the Bosch Io T Hub. The parameters are essentially static parameters. These can also be specified in the declaration part during instantiation of the MQTT client. 322 Version: 1.12.0 TF6701
## Page 323

Samples IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.st TLS.s CA := 'C:\Twin CAT\3.1\Config\Certificates\Bosch Iot Hub.crt'; fb Mqtt Client.s Host Name:= 'mqtt.bosch-iot-hub.com'; fb Mqtt Client.n Host Port:= 8883; fb Mqtt Client.s Client Id:= 'CX-12345'; fb Mqtt Client.s User Name:= 'com.some Name_CX@t42c3e689c5c64c34b13084b9504ed3c8_hub'; fb Mqtt Client.s User Password:= 'some Password'; END_IF The parameters required for authentication can be generated on the Bosch Io T platform. 6.8 Iot Mqtt Sample Ibm Watson Io T Sample for MQTT communication with IBM Watson Io T This sample shows the communication with IBM Watson Io T. Topic structure The topic structure for sending and receiving messages is predefined by the IBM Watson Io T message broker. Messages are sent to and received from IBM Watson Io T. Since this sample is essentially based on the sample Iot Mqtt Sample Using Queue [} 312], only the parts that are relevant for establishing a connection are explained in this section. Parameters for establishing a connection The following code snippet shows the parameters required for establishing a connection to IBM Watson Io T. The parameters are essentially static parameters. These can also be specified in the declaration part during instantiation of the MQTT client. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.s Host Name := 'orgid.messaging.internetofthings.ibmcloud.com'; fb Mqtt Client.n Host Port := 1883; fb Mqtt Client.s Client Id := 'd:orgid:IPC:device Id'; fb Mqtt Client.s User Name := 'use-token-auth'; fb Mqtt Client.s User Password := '12342y?c12Gfq_8r12'; END_IF The topics for publish and subscribe are specified by IBM Watson Io T and cannot be changed. The “org ID” placeholder must be replaced with the organization ID of the IBM Watson account. The “device ID” placeholder is replaced with the ID of the device, as created in IBM Watson. Publish When data are published to IBM Watson Io T, the topic must be specified in the following form: iot-2 / evt / event Id / fmt / json The event ID corresponds to the event ID as configured and expected by IBM Watson Io T. If an IBM Watson dashboard is used, the event ID is generated dynamically and can be linked to a chart on IBM Watson Io T. Subscribe When subscribing to IBM Watson Io T commands, the topic must be specified in the following form: iot-2 / cmd / cmd Id / fmt / json The Cmd ID corresponds to the ID of the command sent by IBM Watson Io T to the device. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base, Tc2_Utilities (>= v3.3.19.0) TF6701 Version: 1.12.0 323
## Page 324

Samples 6.9 Iot Mqtt Sample Mathworks Thingspeak Communication with the Math Works Thing Speak Cloud is illustrated in this sample. Since this sample is essentially based on the sample Iot Mqtt Sample Using Queue [} 312], only the parts that are relevant for establishing a connection to the Thing Speak Cloud are explained in this section. Sample code can be downloaded as archive here: https://infosys.beckhoff.com/content/1033/ tf6701_tc3_iot_communication_mqtt/Resources/11990435339.zip. MQTT device configuration To transfer MQTT data to Thing Speak, you must first register your MQTT device. Log in to Thing Speak with your Math Works account and select Devices > MQTT from the top menu. Select Add new Device. Name your device and authorize publish and subscribe on the appropriate Thing Speak channels. Save your credentials. Parameters for establishing a connection The following code snippet illustrates the parameters that are necessary for establishing a connection with the Math Works Thing Speak Cloud. The parameters are essentially static parameters. These can also be specified in the declaration part during instantiation of the MQTT client. The data to be used in the following <Client ID>, <Username> and <Password> will be provided to you when you configure an MQTT device on Thing Speak. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.s Host Name:= 'mqtt3.thingspeak.com'; fb Mqtt Client.n Host Port:= 1883; fb Mqtt Client.s Client Id:= '<Client ID as provided by MQTT Device on Thing Speak>'; fb Mqtt Client.s Username:= '<username as provided by MQTT Device on Thing Speak>'; fb Mqtt Client.s User Password:= '<password as provided by MQTT Device on Thing Speak>'; END_IF Thing Speak also supports protection of the communication connection via TLS. The CA certificate must be downloaded from Thing Speak and referenced in the function block via the TLS structure. For more information about the Thing Speak CA certificate we recommend referring to the Mathworks Thing Speak documentation. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.s Host Name:= 'mqtt3.thingspeak.com'; fb Mqtt Client.n Host Port:= 8883; fb Mqtt Client.s Client Id:= '<Client ID as provided by MQTT Device on Thing Speak>'; fb Mqtt Client.s Username:= '<username as provided by MQTT Device on Thing Speak>'; fb Mqtt Client.s User Password:= '<password as provided by MQTT Device on Thing Speak>'; st Mqtt Tls.s Version:= 'tlsv1.2'; st Mqtt Tls.s CA:= 'C:\Twin CAT\3.1\Config\Certificates\<thing Speak Cert.pem>; fb Mqtt Client.st TLS := st Mqtt Tls; END_IF Publish When publishing data to the Math Works Thing Speak Cloud, the topic must be specified in the following form: channels / <channel ID> / publish <channel ID> corresponds here to the ID of the channel that was designated and configured for data reception in the Math Works Thing Speak portal. Your device must be authorized for publish on the specified channel. You can change the authorization via Devices > MQTT in the top menu if you are logged in to the Thing Speak website. Subscribe When subscribing to data, the topic must be specified in the following form: channels / <channel ID> / subscribe / fields / <field Key> 324 Version: 1.12.0 TF6701
## Page 325

Samples <channel ID> corresponds here to the ID of the channel that was designated and configured for data reception in the Math Works Thing Speak portal. <field Key> corresponds to the name of the field from which a value is to be received. Your device must be authorized for a subscribe on the specified channel. You can change the authorization via Devices > MQTT in the top menu when you are logged in to the Thing Speak website Data format The Math Works Thing Speak Cloud uses its own string-based data format as payload. This data format is generated in the sample code referenced above in the F_Mqtt_Thing Speak_Create Payload Str() function and can be used directly. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base, Tc2_Utilities (>= v3.3.19.0) 6.10 Iot Mqtt Sample Azure Iot Hub Device Twin Sample for MQTT communication with the Device Twin of the Azure Io T Hub This sample illustrates the communication with the Device Twin. The Device Twin is accessible via the Azure Io T Hub, which is part of the Microsoft Azure Cloud. The message broker can be reached via MQTT and requires authentication via an SAS token, which can be generated via the Azure Io T Hub platform, e.g. using the Azure Io T Explorer. The following sample connects to the Azure Io T Hub, just like the sample Iot Mqtt Sample Azure Iot Hub [} 320]. All relevant information for establishing the connection and further configuration options can be found in this article. The official MQTT documentation from Microsoft can be downloaded from here: https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-mqtt-support 6.11 Iot Mqttv5Sample Sample for MQTTv5 communication via a message queue In this sample, the communication to an MQTT broker using MQTTv5 is shown. As a prerequisite, the message broker used must support MQTTv5. Messages are sent ("Publish") and received ("Subscribe"). This is done in two steps. First, the topic is used to decide which messages are to be received. Then, the received messages are collected in a message queue, from where they can be read and evaluated. The sample sends and receives messages on the same topic for demonstration purposes. Handling the Message Queue In contrast to the FB_Iot Mqtt Client function block for MQTTv3, in the FB_Iot Mqtt5Client function block you no longer have to instantiate the message queue separately as an object and link it to the function block. Instead, you can directly access the corresponding output of the function block to work with the message queue. Project structure 1. Create a Twin CAT project with a PLC and attach the Tc3_Iot Base and Tc3_Json Xml as library references. 2. Create a program block and declare an instance of FB_Iot Mqtt5Client Base [} 79] and two auxiliary variables to control the program sequence, if required. TF6701 Version: 1.12.0 325
## Page 326

Samples PROGRAM Prg Mqtt Com VAR fb Mqtt Client : FB_Iot Mqtt5Client; b Set Parameter : BOOL := TRUE; b Connect : BOOL := TRUE; END_VAR 3. Declare two variables (for topic and payload) for the MQTT message to be sent. In the sample a message is to be sent every second. Three imaginary sensor values are used for the message, which are to be packaged into a JSON document via the F_Create Message function, which is yet to be created. (* published message *) s Topic Pub : STRING(255) := 'My Topic'; s Payload Pub : STRING(255); fb Timer : TON := (PT:=T#1S); r Sensor1 : REAL; n Sensor2 : DINT; b Sensor3 : BOOL; 4. For message reception, declare a variable containing the topic to which the client should subscribe and two other variables indicating the topic and payload of the last received message. The received messages should be collected in a queue to be evaluated one after the other. For this you declare an instance of FB_Iot Mqtt5Message Queue and an instance of FB_Iot Mqtt5Message. (* received message *) b Subscribed : BOOL; s Topic Sub : STRING(255) := 'My Topic'; {attribute 'Tc Encoding':='UTF-8'} s Topic Rcv : STRING(255); {attribute 'Tc Encoding':='UTF-8'} s Payload Rcv : STRING(255); fb Message : FB_Iot Mqtt5Message; 5. In the program part, the MQTT client must be triggered cyclically, in order to ensure that a connection to the broker is established and maintained and the message is received. Set the parameters of the desired connection and initialize the connection with the transfer parameter b Connect := TRUE. In the sample the parameters are assigned once in the program code before the client call. Since this is usually only required once, the parameters can already be specified in the declaration part during instantiation of the MQTT client. Not all parameters have to be assigned. In the sample the broker is local. The IP address or the name can also be specified. IF b Set Parameter THEN b Set Parameter := FALSE; fb Mqtt Client.s Host Name := 'localhost'; fb Mqtt Client.n Host Port := 1883; END_IF fb Mqtt Client. Execute(b Connect); 6. As soon as the connection to the broker is established, the client should subscribe to a particular topic. Likewise, a message is to be sent every second. In the sample s Topic Pub = s Topic Sub, so that a loopback is created. In other applications the topics usually differ. IF fb Mqtt Client.b Connected THEN IF NOT b Subscribed THEN b Subscribed := fb Mqtt Client. Subscribe(s Topic:=s Topic Sub, e Qo S:=Tc Iot Mqtt Qos. At Most Once De livery); END_IF fb Timer(IN:=TRUE); IF fb Timer. Q THEN // publish new payload every second fb Timer(IN:=FALSE); r Sensor1 := r Sensor1 + 0.1; n Sensor2 := n Sensor2 + 1; b Sensor3 := NOT b Sensor3; s Payload Pub := F_Create Message(r Sensor1, n Sensor2, b Sensor3); fb Mqtt Client. Publish(s Topic:= s Topic Pub, p Payload:= ADR(s Payload Pub), n Payload Size:= LEN2(ADR(s Payload Pub)) +1, e Qo S:= Tc Iot Mqtt Qos. At Most Once Delivery, b Retain:= FALSE, b Queue:= FALSE ); END_IF END_IF 7. The cyclic call of the MQTT client ensures that the messages are received. The client receives all messages with topics to which it has previously subscribed with the broker and places them in the message queue. Once messages are available, call the method Dequeue() to gain access to the message properties such as topic or payload via the message object fb Message. 326 Version: 1.12.0 TF6701
## Page 327

Samples IF fb Mqtt Client.fb Message Queue.n Queued Messages > 0 THEN IF fb Mqtt Client.fb Message Queue. Dequeue(fb Message:=fb Message) THEN fb Message. Get Topic(p Topic:=ADR(s Topic Rcv), n Topic Size:=SIZEOF(s Topic Rcv)); fb Message. Get Payload(p Payload:=ADR(s Payload Rcv), n Payload Size:=SIZEOF(s Payload Rcv), b Set Null Termination:=FALSE); END_IF END_IF 8. If message evaluation is implemented as described above, one received message is evaluated per cycle. If several messages were accumulated in the message queue, the evaluation is distributed over several cycles. 9. Finally, add a new function called F_Create Message. The function shall have the return value STRING(255) and shall be provided with the following function signature: FUNCTION F_Create Message : STRING(255) VAR_INPUT Sensor1 : REAL; Sensor2 : DINT; Sensor3 : BOOL; END_VAR VAR dt Timestamp : DATE_AND_TIME; time As File Time : T_FILETIME64; fb Json : FB_Json Sax Writer; END_VAR 10. The function first generates a timestamp based on the F_Get System Time function and then packages the passed sensor values and timestamp into a JSON document. time As File Time := F_Get System Time(); dt Timestamp := FILETIME64_TO_DT( time As File Time ); fb Json. Start Object(); fb Json. Add Key('Timestamp'); fb Json. Add Date Time(dt Timestamp); fb Json. Add Key('Values'); fb Json. Start Object(); fb Json. Add Key('Sensor1'); fb Json. Add Real(Sensor1); fb Json. Add Key('Sensor2'); fb Json. Add Dint(Sensor2); fb Json. Add Key('Sensor3'); fb Json. Add Bool(Sensor3); fb Json. End Object(); fb Json. End Object(); F_Create Message := fb Json. Get Document(); fb Json. Reset Document(); Further steps The sample can be modified for applications in which subscriptions to several topics exist. In this case MQTT messages with different topics are received. Message evaluation can be expanded as follows: VAR (* received payload for each subscribed topic *) s Payload Rcv1 : STRING(255); s Payload Rcv2 : STRING(255); END_VAR VAR CONSTANT (* subscriptions *) s Topic Sub1 : STRING(255) := 'my first topic'; s Topic Sub2 : STRING(255) := 'my second topic'; END_VAR ---------------------------------------------------------------- IF fb Mqtt Client.fb Message Queue.n Queued Messages > 0 THEN IF fb Mqtt Client.fb Message Queue. Dequeue(fb Message:=fb Message) THEN IF fb Message. Compare Topic(s Topic:=s Topic Sub1) THEN fb Message. Get Payload(p Payload:=ADR(s Payload Rcv1), n Payload Size:=SIZEOF(s Payload Rcv1), b S et Null Termination:=FALSE); ELSIF fb Message. Compare Topic(s Topic:=s Topic Sub2) THEN fb Message. Get Payload(p Payload:=ADR(s Payload Rcv2), n Payload Size:=SIZEOF(s Payload Rcv2), b S et Null Termination:=FALSE); END_IF END_IF END_IF TF6701 Version: 1.12.0 327
## Page 328

Samples Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0), Tc2_Utilities (>= v3.4.4.0) 6.12 Iot Mqttv5Last Will Sample Sample for the use of MQTTv5 User Properties The communication to an MQTT broker using MQTTv5 is shown in this sample. In particular, the Last Will mechanism of MQTTv5 is demonstrated. As a prerequisite, the message broker used must support MQTTv5. The basic flow of the sample is as follows: • There is a PLC project that connects to a local message broker based on MQTTv5 and publishes messages to it. At the same time, the application subscribes to the same topic to receive the sent messages again. The structure of the program corresponds to the sample Iot Mqttv5Sample [} 325]. • When a connection is established, a Last Will message is specified and some properties are set for the Last Will message. The Last Will is then transmitted to the message broker in the event of a Connect, and to interested clients in the event of a Disconnect. The following code snippet once again shows the relevant part for specifying the Last Will message, as well as the associated properties. This code position is used for the initialization (only once) of the connection parameters. fb Mqtt Client.st Will.s Topic := 'My Last Will Topic'; fb Mqtt Client.st Will.s Content Type := 'My Content Type'; fb Mqtt Client.st Will.e Qo S := Tc Iot Mqtt Qo S. Exactly Once Delivery; fb Mqtt Client.st Will.fb Payload. Set Data(ADR(s Last Will Msg), SIZEOF(s Last Will Msg)); fb Mqtt Client.st Will.fb User Properties. Add User Property('My First', 'User Property'); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0), Tc2_Utilities (>= v3.4.4.0) 6.13 Iot Mqttv5Req Res Sample Sample for the use of MQTTv5 Request/Response In this sample, the communication to an MQTT broker using MQTTv5 is shown. In particular, the Request/ Response [} 33] mechanism of MQTTv5 is demonstrated. As a prerequisite, the message broker used must support MQTTv5. The basic flow of the sample is as follows: • There is a PLC project that demonstrates the request function and also receives and evaluates the response from the remote terminal. The project first subscribes to the so-called response topic (on which it expects a response from the remote terminal) and then sends the request, which contains the name of the response topic. Advanced properties of the MQTTv5 message, such as User Properties or Correlation Data, are also demonstrated here. • A second PLC project is responsible for receiving the request and sending a corresponding response to the response topic. The MQTT client first subscribes to the topic on which the request is received and prepares the corresponding response when a request is received. The response topic and the extended properties of the MQTTv5 message are extracted from the received message and used for the response. The following figure once again illustrates the basic flow of communication. More information about individual lines of code can be found directly in the comments of the corresponding sample download. 328 Version: 1.12.0 TF6701
## Page 329

Samples Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0), Tc2_Utilities (>= v3.4.4.0) 6.14 Iot Mqttv5User Props Sample Sample for the use of MQTTv5 User Properties The communication to an MQTT broker using MQTTv5 is shown in this sample. In particular, the User Properties mechanism of MQTTv5 is demonstrated. As a prerequisite, the message broker used must support MQTTv5. The basic flow of the sample is as follows: • There is a PLC project that connects to a local message broker based on MQTTv5 and publishes messages to it. At the same time, the application subscribes to the same topic to receive the sent messages again. • The structure of the program corresponds to the sample Iot Mqttv5Sample [} 325]. In addition to the actual payload, the messages also contain User Properties, the handling of which is demonstrated both when sending and receiving messages. The following code snippet once again shows the relevant part for specifying the User Properties on a message to be sent. fb Pub Props.s Content Type := s Content Type; fb Pub Props.n Msg Expiry Interval := 7; fb Pub Props.b Payload Utf8 := TRUE; fb Pub Props. Clear User Properties(); FOR m:=1 TO 10 DO hr Prop Set := fb Pub Props. Add User Property(a User Name[m], a User Value[m]); IF FAILED(hr Prop Set) THEN EXIT; END_IF END_FOR In this sample, 10 User Properties whose key/value values are taken from the a User Name and a User Value arrays are thus added to a message to be sent. The user properties are then passed to the message to be sent as input parameters to the Publish() method. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4026.0 IPC or CX (x86, x64, ARM) Tc3_Iot Base (>= v3.4.2.0), Tc2_Utilities (>= v3.4.4.0) TF6701 Version: 1.12.0 329
## Page 330

Samples 6.15 Json Xml Samples 6.15.1 Tc3Json Xml Sample Xml Dom Writer This sample illustrates how an XML document can be created programmatically based on DOM. The function block FB_Xml Dom Parser is used as a basis. Declaration range PROGRAM MAIN VAR fb Xml : FB_Xml Dom Parser; obj Root : SXml Node; obj Machines : SXml Node; obj Machine : SXml Node; obj Controllers : SXml Node; obj Controller : SXml Node; obj Attribute : SXml Attribute; s Xml String : STRING(1000); b Create : BOOL := FALSE; b Save : BOOL := TRUE; n Length : UDINT; new Attr : SXml Attribute; END_VAR Implementation range The implementation section shows various options for creating an XML document. IF b Create THEN (* Create an empty XML document *) obj Root := fb Xml. Get Document Node(); (* Create a new XML node 'Machines' and add to the empty document *) obj Machines := fb Xml. Append Node(obj Root, 'Machines'); (* Create a new XML node 'Machine' and add an attribute to this node. Append node to 'Machines' *) obj Machine := fb Xml. Append Node(obj Machines, 'Machine'); obj Attribute := fb Xml. Append Attribute(obj Machine, 'Name', 'Wilde Nelli'); (* Create a new XML node 'Controllers' and add to the 'Machine' node *) obj Controllers := fb Xml. Append Node(obj Machine, 'Controllers'); (* Create a new XML node 'Controller' and add some attributes. Append node to 'Controllers'. *) obj Controller := fb Xml. Append Child(obj Controllers, 'Controller', 'CX5120', FALSE); obj Attribute := fb Xml. Append Attribute(obj Controller, 'Type', 'EPC'); obj Attribute := fb Xml. Append Attribute(obj Controller, 'OS', 'Windows Embedded Compact 7'); (* Create a new XML node 'Controller' and add some attributes. Append node to 'Controllers'. *) obj Controller := fb Xml. Append Child(obj Controllers, 'Controller', 'CX2040', FALSE); obj Attribute := fb Xml. Append Attribute(obj Controller, 'Type', 'EPC'); obj Attribute := fb Xml. Append Attribute(obj Controller, 'OS', 'Windows Embedded Standard 7'); (* Create a new XML node 'Controller' and add some attributes. Append node to 'Controllers'. *) obj Controller := fb Xml. Append Child(obj Controllers, 'Controller', 'C6015', FALSE); obj Attribute := fb Xml. Append Attribute(obj Controller, 'Type', 'IPC'); obj Attribute := fb Xml. Append Attribute(obj Controller, 'OS', 'Windows 10 Io T Enterprise'); (* Create a new XML node 'Machine' and add an attribute to this node. Append node to 'Machines' *) obj Machine := fb Xml. Append Node(obj Machines, 'Machine'); obj Attribute := fb Xml. Append Attribute(obj Machine, 'Name', 'Stanze Oscar'); (* Create a new XML node 'Controllers' and add to the 'Machine' node *) obj Controllers := fb Xml. Append Node(obj Machine, 'Controllers'); (* Create a new XML node 'Controller' and add some attributes. Append node to 'Controllers'. *) obj Controller := fb Xml. Append Child(obj Controllers, 'Controller', 'C6017', FALSE); obj Attribute := fb Xml. Append Attribute(obj Controller, 'Type', 'IPC'); obj Attribute := fb Xml. Append Attribute(obj Controller, 'OS', 'Windows 10 Io T Enterprise'); new Attr := fb Xml. Insert Attribute(obj Controller, obj Attribute, 'Add Attribute'); fb Xml. Set Attribute(new Attr, 'Hola'); (* Retrieve XML document and store in a variable of data type STRING(1000) *) n Length := fb Xml. Copy Document(s Xml String, SIZEOF(s Xml String)); b Create := FALSE; END_IF 330 Version: 1.12.0 TF6701
## Page 331

Samples 6.15.2 Tc3Json Xml Sample Xml Dom Reader This sample illustrates how an XML document can be processed programmatically based on DOM. The function block FB_Xml Dom Parser is used as a basis. Declaration range PROGRAM MAIN VAR fb Xml : FB_Xml Dom Parser; xml Doc : SXml Node; xml Machines : SXml Node; xml Machine1 : SXml Node; xml Machine2 : SXml Node; xml Iterator : SXml Iterator; xml Machine Node : SXml Node; xml Machine Node Value : STRING; xml Machine Attribute Ref : SXml Attribute; xml Machine1Attribute : SXml Attribute; xml Machine2Attribute : SXml Attribute; s Machine1Name : STRING; s Machine2Name : STRING; n Machine Attribute : DINT; n Machine1Attribute : DINT; n Machine2Attribute : DINT; s Message To Parse : STRING(255) := '<Machines><Machine Type="1" Test="3">Wilde Nelli</ Machine><Machine Type="2">Huber8</Machine></Machines>'; END_VAR Implementation range The implementation section shows various options for parsing an XML document. (* Load XML content *) xml Doc := fb Xml. Parse Document(s Message To Parse); (* Parse XML nodes - Option 1 *) xml Machines := fb Xml. Child By Name(xml Doc, 'Machines'); xml Machine1 := fb Xml. Child By Attribute(xml Machines, 'Type', '1'); xml Machine2 := fb Xml. Child By Attribute And Name(xml Machines, 'Type', '2', 'Machine'); (* Parse XML nodes - Option 2 *) xml Machines := fb Xml. Child By Name(xml Doc, 'Machines'); xml Machine Node := fb Xml. Children(xml Machines, xml Iterator); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Machine Node := fb Xml. Node(xml Iterator); xml Machine Node Value := fb Xml. Node Text(xml Machine Node); xml Machine Node := fb Xml. Children(xml Machines, xml Iterator); END_WHILE (* Parse XML nodes - Option 3 *) xml Machines := fb Xml. Child By Name(xml Doc, 'Machines'); xml Iterator := fb Xml. Begin(xml Machines); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Machine Node := fb Xml. Node(xml Iterator); xml Machine Node Value := fb Xml. Node Text(xml Machine Node); xml Iterator := fb Xml. Next(xml Iterator); xml Iterator := fb Xml. End(xml Machines); END_WHILE (* Parse XML attributes - Option 1*) xml Machine1Attribute := fb Xml. Attribute(xml Machine1, 'Type'); xml Machine2Attribute := fb Xml. Attribute(xml Machine2, 'Type'); (* Parse XML attributes - Option 2*) xml Iterator := fb Xml. Attribute Begin(xml Machine1); WHILE NOT fb Xml. Is End(xml Iterator) DO xml Machine Attribute Ref := fb Xml. Attribute From Iterator(xml Iterator); n Machine Attribute := fb Xml. Attribute As Int(xml Machine Attribute Ref); xml Iterator := fb Xml. Next(xml Iterator); END_WHILE (* Retrieve node values *) s Machine1Name := fb Xml. Node Text(xml Machine1); s Machine2Name := fb Xml. Node Text(xml Machine2); TF6701 Version: 1.12.0 331
## Page 332

Samples (* Retrieve attribute values *) n Machine1Attribute := fb Xml. Attribute As Int(xml Machine1Attribute); n Machine2Attribute := fb Xml. Attribute As Int(xml Machine2Attribute); 6.15.3 Tc3Json Xml Sample Json Dom Reader This sample illustrates how a JSON message can be run through programmatically on the basis of DOM. The function block FB_Json Dom Parser is used as the basis. Declaration range PROGRAM MAIN VAR fb Json : FB_Json Dom Parser; json Doc : SJson Value; json Prop : SJson Value; json Value : SJson Value; b Has Member : BOOL; s Message : STRING(255) := '{"serial Number":"G030PT028191AC4R","battery Voltage":"1547m V","click Ty pe":"SINGLE"}'; st Received Data : ST_Received Data; END_VAR Implementation range The JSON message is loaded into the DOM tree using the Parse Document() method. You can subsequently check whether it contains a certain property using the Has Member() method. The Find Member() method selects the property. The Get String() method extracts its value. json Doc := fb Json. Parse Document(s Message); b Has Member := fb Json. Has Member(json Doc, 'serial Number'); IF (b Has Member) THEN b Has Member := FALSE; json Prop := fb Json. Find Member(json Doc, 'serial Number'); st Received Data.serial Number := fb Json. Get String(json Prop); END_IF b Has Member := fb Json. Has Member(json Doc, 'battery Voltage'); IF (b Has Member) THEN b Has Member := FALSE; json Prop := fb Json. Find Member(json Doc, 'battery Voltage'); st Received Data.battery Voltage := fb Json. Get String(json Prop); END_IF b Has Member := fb Json. Has Member(json Doc, 'click Type'); IF (b Has Member) THEN b Has Member := FALSE; json Prop := fb Json. Find Member(json Doc, 'click Type'); st Received Data.click Type := fb Json. Get String(json Prop); END_IF The use of the method Has Member() is not absolutely necessary, since the method Find Member() already returns 0 if a property was not found. The code shown above can also be implemented as follows: json Doc := fb Json. Parse Document(s Message); json Prop := fb Json. Find Member(json Doc, 'serial Number'); IF (json Prop <> 0) THEN st Received Data.serial Number := fb Json. Get String(json Prop); END_IF json Prop := fb Json. Find Member(json Doc, 'battery Voltage'); IF (json Prop <> 0) THEN st Received Data.battery Voltage := fb Json. Get String(json Prop); END_IF json Prop := fb Json. Find Member(json Doc, 'click Type'); IF (json Prop <> 0) THEN st Received Data.click Type := fb Json. Get String(json Prop); END_IF Nested JSON objects The approach is similar with nested JSON objects. Since the entire document is located in the DOM, it is simple to navigate. Let's take a JSON object that looks like this: 332 Version: 1.12.0 TF6701
## Page 333

Samples s Message : STRING(255) := '{"Values":{"serial":"G030PT028191AC4R"}}'; The property we are looking for is located in the sub-object "Values". The following code shows how to extract the property. json Doc := fb Json. Parse Document(s Message); b Has Member := fb Json. Has Member(json Doc, 'Values'); IF (b Has Member) THEN b Has Member := FALSE; json Prop := fb Json. Find Member(json Doc, 'Values'); IF json Prop <> 0 THEN json Serial := fb Json. Find Member(json Prop, 'serial'); st Received Data.serial Number := fb Json. Get String(json Serial); END_IF END_IF 6.15.4 Tc3Json Xml Sample Json Sax Writer Sample of the creation of JSON documents via SAX Writer This sample illustrates how a JSON message can be created over the DAX mechanism. The function block FB_Json Sax Writer is used as the basis. Declaration range PROGRAM MAIN VAR dt Timestamp : DATE_AND_TIME := DT#2017-04-04-12:42:42; fb Json : FB_Json Sax Writer; s Json Doc : STRING(255); END_VAR Implementation range The SAX mechanism runs sequentially through the JSON document to be created, i.e. the corresponding elements are run though and created one after the other. fb Json. Start Object(); fb Json. Add Key('Timestamp'); fb Json. Add Date Time(dt Timestamp); fb Json. Add Key('Values'); fb Json. Start Object(); fb Json. Add Key('Sensor1'); fb Json. Add Real(42.42); fb Json. Add Key('Sensor2'); fb Json. Add Dint(42); fb Json. Add Key('Sensor3'); fb Json. Add Bool(TRUE); fb Json. End Object(); fb Json. End Object(); s Json Doc := fb Json. Get Document(); fb Json. Reset Document(); Resulting JSON message { "Timestamp": "2017-04-04T12:42:42", "Values": { "Sensor1": 42.42, "Sensor2": 42, "Sensor3": true } } 6.15.5 Tc3Json Xml Sample Json Sax Reader Sample of the parsing of JSON documents via SAX Reader This sample illustrates how a JSON message can be run through programmatically. The function block FB_Json Sax Reader is used as the basis. TF6701 Version: 1.12.0 333
## Page 334

Samples Declaration range PROGRAM MAIN VAR fb Json : FB_Json Sax Reader; p Json Parse : Json Sax Handler; s Json Doc : STRING(255) := '{"Values": {"Timestamp":"2017-04-04T12:42:42","Sensor1":42.42,"Sensor2":42}}'; END_VAR Implementation range Through the calling of the Parse() method, the transfer of the JSON message as a STRING and the interface pointer to a function block instance that implements the interface Itc Json Sax Handler, the SAX Reader is activated and the corresponding callback methods are run through. fb Json. Parse(s Json := s Json Doc, ip Hdl := p Json Parse); Callback methods The callback methods are called on the instance of the function block that implements the interface Itc Json Sax Handler. Each callback method represents a "found" element in the JSON message. For example, the callback method On Start Object() is called as soon as an opening curly bracket has been detected. According to the example JSON message mentioned above, therefore, the following callback methods are run through in this order: 1. On Start Object(), due to the first opening curly bracket 2. On Key(), due to the property "Values" 3. On Start Object(), due to the second opening curly bracket 4. On Key(), due to the property "Timestamp" 5. On String(), due to the value of the property "Timestamp" 6. On Key(), due to the property "Sensor1" 7. On Lreal(), due to the value of the property "Sensor1" 8. On Key(), due to the property "Sensor2" 9. On Udint(), due to the value of the property "Sensor2" 10. On End Object(), due to the first closing curly bracket 11. On End Object(), due to the second closing curly bracket Within the callback methods the current state is defined and saved via an instance of the enum E_Json States. This can also be used to determine whether the JSON message is valid. For example, if the callback method On Lreal() is called and the state is not the expected State 70 (JSON_STATE_ONLREAL), the return value S_FALSE can be returned to the method. The SAX Reader then automatically cancels the further processing. 6.15.6 Tc3Json Xml Sample Json Data Type Sample of the automatic conversion of structures into a JSON message This sample illustrates how a data structure can be converted into a JSON message (and vice versa). In the conversion the layout of a structure is converted one-to-one into a corresponding JSON equivalent. Additional metadata can be created via PLC attributes on the member variables of the structure. Layout of the data structure to be converted TYPE ST_Values : STRUCT {attribute 'Unit' := 'm/s'} {attribute 'Display Name' := 'Speed'} Sensor1 : REAL; {attribute 'Unit' := 'V'} {attribute 'Display Name' := 'Voltage'} Sensor2 : DINT; {attribute 'Unit' := 'A'} 334 Version: 1.12.0 TF6701
## Page 335

Samples {attribute 'Display Name' := 'Current'} Sensor3 : DINT; END_STRUCT END_TYPE Declaration range PROGRAM MAIN VAR dt Timestamp : DATE_AND_TIME := DT#2017-04-04-12:42:42; fb Json : FB_Json Sax Writer; fb Json Data Type : FB_Json Read Write Data Type; s Json Doc : STRING(255); s Json Doc2 : STRING(2000); st Values : ST_Values; END_VAR Implementation range Two ways of generating the JSON message are shown, starting with the instance fb Json of the function block FB_Json Sax Writer. The Get Document() method can be used with a JSON message with no more than 255 characters. However, the Copy Document() method must be used with larger JSON messages. fb Json. Reset Document(); fb Json. Start Object(); fbjson. Add Key Date Time('Timestamp', dt Timestamp); fb Json Data Type. Add Json Key Value From Symbol(fb Json, 'Values', 'ST_Values', SIZEOF(st Values), ADR(st Valu es)); fb Json Data Type. Add Json Key Properties From Symbol(fb Json, 'Meta Data', 'ST_Values', 'Unit|Display Name'); fb Json. End Object(); s Json Doc := fb Json. Get Document(); fb Json. Copy Document(s Json Doc2, SIZEOF(s Json Doc2)); Resulting JSON message { "Timestamp": "2017-04-04T12:42:42", "Values": { "Sensor1": 0.0, "Sensor2": 0, "Sensor3": 0 }, "Meta Data": { "Sensor1": { "Unit": "m/s", "Display Name": "Speed" }, "Sensor2": { "Unit": "V", "Display Name": "Voltage" }, "Sensor3": { "Unit": "A", "Display Name": "Current" } } } Alternative As an alternative, the method Add Json Value From Symbol() can also be used to generate a JSON format directly from a data structure. fb Json. Reset Document(); fb Json Data Type. Add Json Value From Symbol(fb Json, 'ST_Values', SIZEOF(st Values), ADR(st Values)); s Json Doc := fb Json. Get Document(); fb Json. Copy Document(s Json Doc2, SIZEOF(s Json Doc2)); The resulting JSON object looks like this: { "Sensor1": 0.0, "Sensor2": 0, "Sensor3": 0 } TF6701 Version: 1.12.0 335
## Page 336

Samples Conversion of a JSON message back to a data structure The above samples show how a JSON object can be generated from a data structure in a simple manner. There is also a corresponding method in the Tc3_Json Xml library for the reverse process, i.e. the extraction of values from a (received) JSON object back into a data structure. This application is made possible by calling the method Set Symbol From Json(). fb Json Data Type. Set Symbol From Json(some Json, 'ST_Values', SIZEOF(st Values Receive), ADR(st Values Receive)); The string variable s Json Doc2 contains the JSON object, which is transferred into the structure instance st Values Receive by calling the method. Target data structure The target data structure must match the structure of the JSON document. Otherwise Set Symbol From Json() returns FALSE. 336 Version: 1.12.0 TF6701
## Page 337

Appendix 7 Appendix 7.1 Sample configurations 7.1.1 Mosquitto Below are some sample configurations for the Mosquitto Message Broker. The configurations were created based on the official Mosquitto documentation. The configuration file (mosquitto.conf) of the broker can be found in the installation directory of the broker (for example C:\Program Files\mosquitto). This can be opened and edited with a text editor of your choice, for example Notepad. We recommend creating a backup before making changes to the configuration file. Alternatively, you can create additional configuration files and load them from the command line when starting the broker: mosquitto.exe -c mosquitto.conf For debugging and testing purposes, we recommend starting the broker in a command line, since verbose output can also be enabled here: mosquitto.exe -c mosquitto.conf -v Mosquitto start in the command line Before starting Mosquitto Broker from the command line, please make sure that no active Mosquitto process is running on your system. This may be the case, for example, if Mosquitto Broker was installed and started as a Windows service. Therefore, please check Windows Task Manager and Windows Services Manager. In the following you will now find some sample configurations for different use cases. These configurations were created based on Mosquitto Message Broker version 2.0.15 and are also available in our TF6701_Samples repository on Git Hub. Unsecured connection The following configuration file content configures the broker for an unsecured connection without TLS and without user authentication. listener 1883 allow_anonymous true Unsecured connection with user authentication The following configuration file content configures the broker for an unsecured connection without TLS, but with user authentication. listener 1883 allow_anonymous false password_file C:\Program Files\mosquitto\users.pwd The user database specified with the password_file parameter can be created with the mosquitto_passwd tool, which is also located in the broker installation directory. The following call creates a new user database and adds the user My User1 with the password Secure Password: mosquitto_passwd.exe -b -c "C:\Program Files\mosquitto\users.pwd" My User1 Secure Password By using the -b parameter, a password can be passed directly in the call. The -c parameter creates a new password file. If a new user is to be added to an existing file, this parameter is omitted. mosquitto_passwd.exe -b "C:\Program Files\mosquitto\users.pwd" My User2 Another Secure Password Plain text transmission of the password Please note that in case of an insecure, i.e. non-encrypted MQTT connection, the password is transmitted in plain text during user authentication. We therefore recommend encrypting the MQTT communication using TLS, see sample configurations below. TF6701 Version: 1.12.0 337
## Page 338

Appendix Unsecured connection with user authentication and ACL The following configuration file content configures the broker for an unsecured connection without TLS, but with user authentication and using an Access Control List (ACL) that regulates user access to specific topics. listener 1883 allow_anonymous false password_file C:\Program Files\mosquitto\users.pwd acl_file C:\Program Files\mosquitto\user Access.acl As described in the previous sample, the user database referenced as password_file can be created using the mosquitto_passwd tool. The access list file referenced as acl_file is a plain text file which is constructed according to a specific format. This format is also described in more detail in the Mosquitto documentation. The following file shows a sample of what an access list for two users might look like. Each user is granted access to his own topic area. However, an administrator user should have access to all topics. user Admin topic # user My User1 topic users/My User1/# user My User2 topic users/My User2/# Access to a topic that is not allowed Please note that the client does not receive any feedback from the Mosquitto Message Broker when accessing (Publish/Subscribe) a topic that is not allowed. From the client's point of view, the process appears to be successful, but the broker does not transmit or forward any messages to the client other than the regular MQTT command packages. TLS connection with PSK The following configuration file content configures the broker for a secured connection with TLS using a pre- shared key (PSK). No user authentication is configured. listener 8883 allow_anonymous true psk_hint Twin CATrocks psk_file C:\Program Files\mosquitto\my Keys.psk The file referenced as psk_file then contains a list of pre-shared keys. This is a plain text file in which the PSKs are listed line by line in the identity:key format. The key is specified in hexadecimal format. Example: My Identity1:ab123456789cd My Identity2:ef987654321ab The psk_hint parameter is important because it enables TLS-PSK for the listener. TLS connection with certificate The following configuration file content configures the broker for a secured connection with TLS using a certificate. No user authentication is configured. This sample assumes that you have a Certificate Authority (CA) that can issue server certificates. There are various tutorials on the web which demonstrate, for example, how you can create such a CA using Open SSL and issue corresponding certificates. listener 8883 allow_anonymous true cafile C:\ca\certs\full Chain.pem crlfile C:\ca\crl\intermediate CA.crl certfile C:\Program Files\mosquitto\certs\mosquitto.pem keyfile C:\Program Files\mosquitto\certs\mosquitto.key TLS connection with certificate and user authentication The following configuration file content configures the broker for a secured connection with TLS using a certificate. In addition, user authentication is configured specifying the user database file. This sample assumes that you have a Certificate Authority (CA) that can issue server certificates. There are various tutorials on the web which demonstrate, for example, how you can create such a CA using Open SSL and issue corresponding certificates. 338 Version: 1.12.0 TF6701
## Page 339

Appendix listener 8883 allow_anonymous false password_file C:\Program Files\mosquitto\users.pwd cafile C:\ca\certs\full Chain.pem crlfile C:\ca\crl\intermediate CA.crl certfile C:\Program Files\mosquitto\certs\mosquitto.pem keyfile C:\Program Files\mosquitto\certs\mosquitto.key Clients attempting to connect to this broker must have a valid certificate issued by the same Certificate Authority. TLS connection with certificate, user authentication and ACL The following configuration file content configures the broker for a secured connection with TLS using a certificate. In addition, user authentication is configured specifying the user database file, as well as an Access Control List (ACL) which configures various access rights for the users (see sample above). This sample assumes that you have a Certificate Authority (CA) that can issue server certificates. There are various tutorials on the web which demonstrate, for example, how you can create such a CA using Open SSL and issue corresponding certificates. listener 8883 allow_anonymous false use_identity_as_username true password_file C:\Program Files\mosquitto\users.pwd acl_file C:\Program Files\mosquitto\user Access.acl cafile C:\ca\certs\full Chain.pem crlfile C:\ca\crl\intermediate CA.crl certfile C:\Program Files\mosquitto\certs\mosquitto.pem keyfile C:\Program Files\mosquitto\certs\mosquitto.key Clients attempting to connect to this broker must have a valid certificate issued by the same Certificate Authority. Building on this sample, you can now also use the use_identity_as_username parameter, which causes the Common Name from the client certificate to be used as the user name. 7.2 Error Codes In the event of an error, the function block FB_Iot Mqtt Client [} 55] sets the output b Error and indicates the error with hr Error Code. All errors are listed in section "ADS Return Codes [} 340]". In addition, the output e Connection State indicates the state of the connection between the client and the MQTT broker at all times. The enumeration offers the following possible states: TYPE ETc Iot Mqtt Client State : ( MQTT_ERR_CONN_PENDING:=-1, MQTT_ERR_SUCCESS:=0, MQTT_ERR_NOMEM:=1, MQTT_ERR_PROTOCOL:=2, MQTT_ERR_INVAL:=3, MQTT_ERR_NO_CONN:=4, MQTT_ERR_CONN_REFUSED:=5, MQTT_ERR_NOT_FOUND:=6, MQTT_ERR_CONN_LOST:=7, MQTT_ERR_TLS:=8, MQTT_ERR_PAYLOAD_SIZE:=9, MQTT_ERR_NOT_SUPPORTED:=10, MQTT_ERR_AUTH:=11, MQTT_ERR_ACL_DENIED:=12, MQTT_ERR_UNKNOWN:=13, MQTT_ERR_ERRNO:=14, MQTT_ERR_EAI:=15, MQTT_ERR_PROXY:=16 ) DINT; END_TYPE TF6701 Version: 1.12.0 339
## Page 340

Appendix 7.3 ADS Return Codes Grouping of error codes: Global error codes: ADS Return Codes [} 340]... (0x9811_0000 ...) Router error codes: ADS Return Codes [} 340]... (0x9811_0500 ...) General ADS errors: ADS Return Codes [} 341]... (0x9811_0700 ...) RTime error codes: ADS Return Codes [} 343]... (0x9811_1000 ...) Global error codes Hex Dec HRESULT Name Description 0x0 0 0x98110000 ERR_NOERROR No error. 0x1 1 0x98110001 ERR_INTERNAL Internal error. 0x2 2 0x98110002 ERR_NORTIME No real time. 0x3 3 0x98110003 ERR_ALLOCLOCKEDMEM Allocation locked – memory error. 0x4 4 0x98110004 ERR_INSERTMAILBOX Mailbox full – the ADS message could not be sent. Reducing the number of ADS messages per cycle will help. 0x5 5 0x98110005 ERR_WRONGRECEIVEHMSG Wrong HMSG. 0x6 6 0x98110006 ERR_TARGETPORTNOTFOUND Target port not found – ADS server is not started or is not reachable. 0x7 7 0x98110007 ERR_TARGETMACHINENOTFOUND Target computer not found – AMS route was not found. 0x8 8 0x98110008 ERR_UNKNOWNCMDID Unknown command ID. 0x9 9 0x98110009 ERR_BADTASKID Invalid task ID. 0x A 10 0x9811000A ERR_NOIO No IO. 0x B 11 0x9811000B ERR_UNKNOWNAMSCMD Unknown AMS command. 0x C 12 0x9811000C ERR_WIN32ERROR Win32 error. 0x D 13 0x9811000D ERR_PORTNOTCONNECTED Port not connected. 0x E 14 0x9811000E ERR_INVALIDAMSLENGTH Invalid AMS length. 0x F 15 0x9811000F ERR_INVALIDAMSNETID Invalid AMS Net ID. 0x10 16 0x98110010 ERR_LOWINSTLEVEL Installation level is too low –Twin CAT 2 license error. 0x11 17 0x98110011 ERR_NODEBUGINTAVAILABLE No debugging available. 0x12 18 0x98110012 ERR_PORTDISABLED Port disabled – Twin CAT system service not started. 0x13 19 0x98110013 ERR_PORTALREADYCONNECTED Port already connected. 0x14 20 0x98110014 ERR_AMSSYNC_W32ERROR AMS Sync Win32 error. 0x15 21 0x98110015 ERR_AMSSYNC_TIMEOUT AMS Sync Timeout. 0x16 22 0x98110016 ERR_AMSSYNC_AMSERROR AMS Sync error. 0x17 23 0x98110017 ERR_AMSSYNC_NOINDEXINMAP No index map for AMS Sync available. 0x18 24 0x98110018 ERR_INVALIDAMSPORT Invalid AMS port. 0x19 25 0x98110019 ERR_NOMEMORY No memory. 0x1A 26 0x9811001A ERR_TCPSEND TCP send error. 0x1B 27 0x9811001B ERR_HOSTUNREACHABLE Host unreachable. 0x1C 28 0x9811001C ERR_INVALIDAMSFRAGMENT Invalid AMS fragment. 0x1D 29 0x9811001D ERR_TLSSEND TLS send error – secure ADS connection failed. 0x1E 30 0x9811001E ERR_ACCESSDENIED Access denied – secure ADS access denied. Router error codes 340 Version: 1.12.0 TF6701
## Page 341

Appendix Hex Dec HRESULT Name Description 0x500 1280 0x98110500 ROUTERERR_NOLOCKEDMEMORY Locked memory cannot be allocated. 0x501 1281 0x98110501 ROUTERERR_RESIZEMEMORY The router memory size could not be changed. 0x502 1282 0x98110502 ROUTERERR_MAILBOXFULL The mailbox has reached the maximum number of possible messages. 0x503 1283 0x98110503 ROUTERERR_DEBUGBOXFULL The Debug mailbox has reached the maximum number of possible messages. 0x504 1284 0x98110504 ROUTERERR_UNKNOWNPORTTYPE The port type is unknown. 0x505 1285 0x98110505 ROUTERERR_NOTINITIALIZED The router is not initialized. 0x506 1286 0x98110506 ROUTERERR_PORTALREADYINUSE The port number is already assigned. 0x507 1287 0x98110507 ROUTERERR_NOTREGISTERED The port is not registered. 0x508 1288 0x98110508 ROUTERERR_NOMOREQUEUES The maximum number of ports has been reached. 0x509 1289 0x98110509 ROUTERERR_INVALIDPORT The port is invalid. 0x50A 1290 0x9811050A ROUTERERR_NOTACTIVATED The router is not active. 0x50B 1291 0x9811050B ROUTERERR_FRAGMENTBOXFULL The mailbox has reached the maximum number for fragmented messages. 0x50C 1292 0x9811050C ROUTERERR_FRAGMENTTIMEOUT A fragment timeout has occurred. 0x50D 1293 0x9811050D ROUTERERR_TOBEREMOVED The port is removed. General ADS error codes TF6701 Version: 1.12.0 341
## Page 342

Appendix Hex Dec HRESULT Name Description 0x700 1792 0x98110700 ADSERR_DEVICE_ERROR General device error. 0x701 1793 0x98110701 ADSERR_DEVICE_SRVNOTSUPP Service is not supported by the server. 0x702 1794 0x98110702 ADSERR_DEVICE_INVALIDGRP Invalid index group. 0x703 1795 0x98110703 ADSERR_DEVICE_INVALIDOFFSET Invalid index offset. 0x704 1796 0x98110704 ADSERR_DEVICE_INVALIDACCESS Reading or writing not permitted. 0x705 1797 0x98110705 ADSERR_DEVICE_INVALIDSIZE Parameter size not correct. 0x706 1798 0x98110706 ADSERR_DEVICE_INVALIDDATA Invalid data values. 0x707 1799 0x98110707 ADSERR_DEVICE_NOTREADY Device is not ready to operate. 0x708 1800 0x98110708 ADSERR_DEVICE_BUSY Device is busy. 0x709 1801 0x98110709 ADSERR_DEVICE_INVALIDCONTEXT Invalid operating system context. This can result from use of ADS blocks in different tasks. It may be possible to resolve this through multitasking synchronization in the PLC. 0x70A 1802 0x9811070A ADSERR_DEVICE_NOMEMORY Insufficient memory. 0x70B 1803 0x9811070B ADSERR_DEVICE_INVALIDPARM Invalid parameter values. 0x70C 1804 0x9811070C ADSERR_DEVICE_NOTFOUND Not found (files, ...). 0x70D 1805 0x9811070D ADSERR_DEVICE_SYNTAX Syntax error in file or command. 0x70E 1806 0x9811070E ADSERR_DEVICE_INCOMPATIBLE Objects do not match. 0x70F 1807 0x9811070F ADSERR_DEVICE_EXISTS Object already exists. 0x710 1808 0x98110710 ADSERR_DEVICE_SYMBOLNOTFOUND Symbol not found. 0x711 1809 0x98110711 ADSERR_DEVICE_SYMBOLVERSIONINVALID Invalid symbol version. This can occur due to an online change. Create a new handle. 0x712 1810 0x98110712 ADSERR_DEVICE_INVALIDSTATE Device (server) is in invalid state. 0x713 1811 0x98110713 ADSERR_DEVICE_TRANSMODENOTSUPP Ads Trans Mode not supported. 0x714 1812 0x98110714 ADSERR_DEVICE_NOTIFYHNDINVALID Notification handle is invalid. 0x715 1813 0x98110715 ADSERR_DEVICE_CLIENTUNKNOWN Notification client not registered. 0x716 1814 0x98110716 ADSERR_DEVICE_NOMOREHDLS No further handle available. 0x717 1815 0x98110717 ADSERR_DEVICE_INVALIDWATCHSIZE Notification size too large. 0x718 1816 0x98110718 ADSERR_DEVICE_NOTINIT Device not initialized. 0x719 1817 0x98110719 ADSERR_DEVICE_TIMEOUT Device has a timeout. 0x71A 1818 0x9811071A ADSERR_DEVICE_NOINTERFACE Interface query failed. 0x71B 1819 0x9811071B ADSERR_DEVICE_INVALIDINTERFACE Wrong interface requested. 0x71C 1820 0x9811071C ADSERR_DEVICE_INVALIDCLSID Class ID is invalid. 0x71D 1821 0x9811071D ADSERR_DEVICE_INVALIDOBJID Object ID is invalid. 0x71E 1822 0x9811071E ADSERR_DEVICE_PENDING Request pending. 0x71F 1823 0x9811071F ADSERR_DEVICE_ABORTED Request is aborted. 0x720 1824 0x98110720 ADSERR_DEVICE_WARNING Signal warning. 0x721 1825 0x98110721 ADSERR_DEVICE_INVALIDARRAYIDX Invalid array index. 0x722 1826 0x98110722 ADSERR_DEVICE_SYMBOLNOTACTIVE Symbol not active. 0x723 1827 0x98110723 ADSERR_DEVICE_ACCESSDENIED Access denied. 0x724 1828 0x98110724 ADSERR_DEVICE_LICENSENOTFOUND Missing license. 0x725 1829 0x98110725 ADSERR_DEVICE_LICENSEEXPIRED License expired. 0x726 1830 0x98110726 ADSERR_DEVICE_LICENSEEXCEEDED License exceeded. 0x727 1831 0x98110727 ADSERR_DEVICE_LICENSEINVALID Invalid license. 0x728 1832 0x98110728 ADSERR_DEVICE_LICENSESYSTEMID License problem: System ID is invalid. 0x729 1833 0x98110729 ADSERR_DEVICE_LICENSENOTIMELIMIT License not limited in time. 0x72A 1834 0x9811072A ADSERR_DEVICE_LICENSEFUTUREISSUE Licensing problem: time in the future. 0x72B 1835 0x9811072B ADSERR_DEVICE_LICENSETIMETOLONG License period too long. 0x72C 1836 0x9811072C ADSERR_DEVICE_EXCEPTION Exception at system startup. 0x72D 1837 0x9811072D ADSERR_DEVICE_LICENSEDUPLICATED License file read twice. 0x72E 1838 0x9811072E ADSERR_DEVICE_SIGNATUREINVALID Invalid signature. 0x72F 1839 0x9811072F ADSERR_DEVICE_CERTIFICATEINVALID Invalid certificate. 0x730 1840 0x98110730 ADSERR_DEVICE_LICENSEOEMNOTFOUND Public key not known from OEM. 0x731 1841 0x98110731 ADSERR_DEVICE_LICENSERESTRICTED License not valid for this system ID. 0x732 1842 0x98110732 ADSERR_DEVICE_LICENSEDEMODENIED Demo license prohibited. 0x733 1843 0x98110733 ADSERR_DEVICE_INVALIDFNCID Invalid function ID. 0x734 1844 0x98110734 ADSERR_DEVICE_OUTOFRANGE Outside the valid range. 0x735 1845 0x98110735 ADSERR_DEVICE_INVALIDALIGNMENT Invalid alignment. 0x736 1846 0x98110736 ADSERR_DEVICE_LICENSEPLATFORM Invalid platform level. 342 Version: 1.12.0 TF6701
## Page 343

Appendix Hex Dec HRESULT Name Description 0x737 1847 0x98110737 ADSERR_DEVICE_FORWARD_PL Context – forward to passive level. 0x738 1848 0x98110738 ADSERR_DEVICE_FORWARD_DL Context – forward to dispatch level. 0x739 1849 0x98110739 ADSERR_DEVICE_FORWARD_RT Context – forward to real time. 0x740 1856 0x98110740 ADSERR_CLIENT_ERROR Client error. 0x741 1857 0x98110741 ADSERR_CLIENT_INVALIDPARM Service contains an invalid parameter. 0x742 1858 0x98110742 ADSERR_CLIENT_LISTEMPTY Polling list is empty. 0x743 1859 0x98110743 ADSERR_CLIENT_VARUSED Var connection already in use. 0x744 1860 0x98110744 ADSERR_CLIENT_DUPLINVOKEID The called ID is already in use. 0x745 1861 0x98110745 ADSERR_CLIENT_SYNCTIMEOUT Timeout has occurred – the remote terminal is not responding in the specified ADS timeout. The route setting of the remote terminal may be configured incorrectly. 0x746 1862 0x98110746 ADSERR_CLIENT_W32ERROR Error in Win32 subsystem. 0x747 1863 0x98110747 ADSERR_CLIENT_TIMEOUTINVALID Invalid client timeout value. 0x748 1864 0x98110748 ADSERR_CLIENT_PORTNOTOPEN Port not open. 0x749 1865 0x98110749 ADSERR_CLIENT_NOAMSADDR No AMS address. 0x750 1872 0x98110750 ADSERR_CLIENT_SYNCINTERNAL Internal error in Ads sync. 0x751 1873 0x98110751 ADSERR_CLIENT_ADDHASH Hash table overflow. 0x752 1874 0x98110752 ADSERR_CLIENT_REMOVEHASH Key not found in the table. 0x753 1875 0x98110753 ADSERR_CLIENT_NOMORESYM No symbols in the cache. 0x754 1876 0x98110754 ADSERR_CLIENT_SYNCRESINVALID Invalid response received. 0x755 1877 0x98110755 ADSERR_CLIENT_SYNCPORTLOCKED Sync Port is locked. 0x756 1878 0x98110756 ADSERR_CLIENT_REQUESTCANCELLED The request was cancelled. RTime error codes Hex Dec HRESULT Name Description 0x1000 4096 0x98111000 RTERR_INTERNAL Internal error in the real-time system. 0x1001 4097 0x98111001 RTERR_BADTIMERPERIODS Timer value is not valid. 0x1002 4098 0x98111002 RTERR_INVALIDTASKPTR Task pointer has the invalid value 0 (zero). 0x1003 4099 0x98111003 RTERR_INVALIDSTACKPTR Stack pointer has the invalid value 0 (zero). 0x1004 4100 0x98111004 RTERR_PRIOEXISTS The request task priority is already assigned. 0x1005 4101 0x98111005 RTERR_NOMORETCB No free TCB (Task Control Block) available. The maximum number of TCBs is 64. 0x1006 4102 0x98111006 RTERR_NOMORESEMAS No free semaphores available. The maximum number of semaphores is 64. 0x1007 4103 0x98111007 RTERR_NOMOREQUEUES No free space available in the queue. The maximum number of positions in the queue is 64. 0x100D 4109 0x9811100D RTERR_EXTIRQALREADYDEF An external synchronization interrupt is already applied. 0x100E 4110 0x9811100E RTERR_EXTIRQNOTDEF No external sync interrupt applied. 0x100F 4111 0x9811100F RTERR_EXTIRQINSTALLFAILED Application of the external synchronization interrupt has failed. 0x1010 4112 0x98111010 RTERR_IRQLNOTLESSOREQUAL Call of a service function in the wrong context 0x1017 4119 0x98111017 RTERR_VMXNOTSUPPORTED Intel VT-x extension is not supported. 0x1018 4120 0x98111018 RTERR_VMXDISABLED Intel VT-x extension is not enabled in the BIOS. 0x1019 4121 0x98111019 RTERR_VMXCONTROLSMISSING Missing function in Intel VT-x extension. 0x101A 4122 0x9811101A RTERR_VMXENABLEFAILS Activation of Intel VT-x fails. Specific positive HRESULT Return Codes: HRESULT Name Description 0x0000_0000 S_OK No error. 0x0000_0001 S_FALSE No error. Example: successful processing, but with a negative or incomplete result. 0x0000_0203 S_PENDING No error. Example: successful processing, but no result is available yet. 0x0000_0256 S_WATCHDOG_TIMEOUT No error. Example: successful processing, but a timeout occurred. TCP Winsock error codes TF6701 Version: 1.12.0 343
## Page 344

Appendix Hex Dec Name Description 0x274C 10060 WSAETIMEDOUT A connection timeout has occurred - error while establishing the connection, because the remote terminal did not respond properly after a certain period of time, or the established connection could not be maintained because the connected host did not respond. 0x274D 10061 WSAECONNREFUSED Connection refused - no connection could be established because the target computer has explicitly rejected it. This error usually results from an attempt to connect to a service that is inactive on the external host, that is, a service for which no server application is running. 0x2751 10065 WSAEHOSTUNREACH No route to host - a socket operation referred to an unavailable host. More Winsock error codes: Win32 error codes 7.4 Error diagnosis The following chapter provides useful information for error diagnosis, if application scenarios are not functioning as expected. 344 Version: 1.12.0 TF6701
## Page 345

Appendix Behavior Category Description Connection to message Establishing the Check whether the message broker can be reached in broker cannot be connection principle from the system on which the Tc3_Iot Base is established executed (e.g. using another MQTT client). If the message broker cannot be reached, check your firewall settings. For an MQTT communication, the outgoing TCP port (1883 or 8883 if TLS is used) must be open by default on the MQTT client (the computer that runs the Tc3_Iot Base). On the message broker side, these ports must be open for incoming messages. If the Tc3_Iot Base is used, the port configuration can be checked via the input parameter n Host Port at the function block FB_Iot Mqtt Client [} 55]. Connection to AWS Io T Establishing the Check whether the AWS Io T URL can be reached in cannot be established connection principle from the system on which the Tc3_Iot Base is executed (e.g. using another MQTT client). This also provides an opportunity for verifying the certificates for the connection. If the other MQTT client cannot establish a connection, check on the AWS Io T management website whether the certificates are valid and active. If AWS Io T cannot be reached, check your firewall settings. For an MQTT communication with AWS Io T, the outgoing TCP port (8883) must be open by default on the MQTT client (the computer that runs the Tc3_Iot Base). If the Tc3_Iot Base is used, the port configuration can be checked via the input parameter n Host Port at the function block FB_Iot Mqtt Client [} 55]. Connection to Azure Io T Establishing the Check whether the AWS Io T URL can be reached in Hub cannot be connection principle from the system on which the Tc3_Iot Base is established executed (e.g. using another MQTT client). This also provides an opportunity for verifying the CA certificate for the connection. If the other MQTT client cannot establish a connection, check whether the CA certificate is valid. If the Azure Io T Hub cannot be reached, check your firewall settings. For an MQTT communication with the Azure Io T Hub, the outgoing TCP port (8883) must be open by default on the MQTT client (the computer that runs the Tc3_Iot Base). If the Tc3_Iot Base is used, the port configuration can be checked via the input parameter n Host Port at the function block FB_Iot Mqtt Client [} 55]. The connection cannot Establishing the The certificate of the message broker was revoked. In be established after a connection this case, please contact the operator of the message CRL update. The broker for further information. variable e Connection State shows the following value: MQTT_ERR_TLS_VERI FY_FAIL TF6701 Version: 1.12.0 345
## Page 346

Appendix Behavior Category Description After using an invalid Establishing the After using an invalid topic Twin CAT must be restarted. topic in the meantime connection Please make sure that no invalid topics are used. (e.g. a wildcard at the wrong position "testtopic#") the connection of the MQTT client to the broker toggles Messages do not arrive Publish Check whether the messages are published to the at the Azure Io T Hub correct topic. The topic structure is fixed for the Azure Io T Hub, based on a naming scheme that cannot be changed. Check whether your MQTT settings are valid and whether the Azure Io T Hub supports them. For further information consult the Beckhoff notes on establishing a connection to the Azure Io T Hub or the MSDN documentation. Messages do not arrive Publish Check whether the messages are published to the at IBM Watson Io T correct topic. The topic structure is fixed for IBM Watson Io T, based on a naming scheme that cannot be changed. Check whether your MQTT settings are valid and whether IBM Watson Io T supports them. For further information consult the Beckhoff notes on establishing a connection to IBM Watson Io T or the IBM Watson documentation. Messages content is not Publish Check whether the JSON document you are trying to detected as a valid JSON send is valid. The Tc3_Json Xml library from Beckhoff message by the provides support for creating valid JSON documents. subscriber Check whether the correct length information (n Payload Size) is transferred when the publish method is called and that not too many data (null) are located after the actual payload. No properties for the Publish Check whether the correct length information corresponding event are (n Payload Size) is transferred when the publish method detected at IBM Watson is called and that not too many data (null) are located Io T after the actual payload, in which case IBM Watson may not be able to recognize the message as a valid JSON message. During the conversion of Publish Check whether the correct length information incoming MQTT (n Payload Size) is transferred when the publish method messages, Node-RED is called and that not too many data (null) are located reports to the JSON after the actual payload, in which case Node-RED may function "Ignored non- not be able to recognize the message as a valid JSON object payload" message. The connection to the Subscribe Check if on the topics you subscribed to, a message message broker is exceeding the maximum message size suddenly interrupted in (c Max Size Of Mqtt Message [} 111]) may have been between. received. In this case, the MQTT client driver disconnects from the broker. 7.5 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. 346 Version: 1.12.0 TF6701
## Page 347

Appendix Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com TF6701 Version: 1.12.0 347
## Page 349

More Information: www.beckhoff.com/tf6701.html Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
