---
title: "TF3650 Twin CAT 3"
product: "TF3650"
category: "Analytics"
tags: ["CAT", "TWIN"]
language: "EN"
document_type: "Manual"
version: "1.5"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF3650_TC3_Power_Monitoring_EN.pdf"
release_date: "2023-01-31"
---
Manual | EN TF3650 Twin CAT 3 | Power Monitoring 2023-01-31 | Version: 1.5
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation............................................................................................................. 5 1.2 Safety instructions............................................................................................................................. 6 1.3 Notes on information security............................................................................................................ 7 2 Overview.................................................................................................................................................... 8 3 Installation................................................................................................................................................. 9 3.1 System requirements........................................................................................................................ 9 3.2 Installation......................................................................................................................................... 9 3.3 Licensing......................................................................................................................................... 12 4 Technical introduction............................................................................................................................ 15 4.1 Memory Management..................................................................................................................... 15 5 PLC API.................................................................................................................................................... 17 5.1 General function blocks................................................................................................................... 17 5.1.1 FB_PMA_Scaling............................................................................................................. 17 5.1.2 FB_PMA_Scaling_EL3773............................................................................................... 22 5.1.3 FB_PMA_Scaling_EL3783............................................................................................... 26 5.1.4 FB_PMA_Task Transfer_Send......................................................................................... 31 5.1.5 FB_PMA_Task Transfer_Receive..................................................................................... 34 5.2 Function blocks, single-phase......................................................................................................... 36 5.2.1 FB_PMA_Source_1Ph..................................................................................................... 36 5.2.2 Based on the signal period............................................................................................... 40 5.2.3 Based on the frequency range......................................................................................... 59 5.3 Function blocks, three-phase.......................................................................................................... 79 5.3.1 FB_PMA_Source_3Ph..................................................................................................... 79 5.3.2 Based on the signal period............................................................................................... 82 5.3.3 Based on the frequency range....................................................................................... 102 5.4 Data types..................................................................................................................................... 123 5.4.1 E_PMA_Scaling Type..................................................................................................... 123 5.4.2 E_PMA_Window Type.................................................................................................... 124 5.4.3 Init Parameters................................................................................................................ 124 5.4.4 Single-phase.................................................................................................................. 136 5.4.5 Three-phase................................................................................................................... 138 5.4.6 E_PMA_Input Select....................................................................................................... 140 5.4.7 ST_PMA_Energy........................................................................................................... 141 5.4.8 E_PMA_Pqf Mode........................................................................................................... 141 5.5 Global constants........................................................................................................................... 141 5.5.1 GVL_PMA...................................................................................................................... 141 6 Examples............................................................................................................................................... 143 6.1 Samples of calculations based on the signal period..................................................................... 143 6.2 Samples of calculations based on the frequency range................................................................ 144 6.3 Samples reuse.............................................................................................................................. 145 7 Appendix................................................................................................................................................ 147 7.1 FAQ............................................................................................................................................... 147 TF3650 Version: 1.5 3
## Page 4

Table of contents 7.2 Support and Service...................................................................................................................... 147 4 Version: 1.5 TF3650
## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is only intended for the use of trained specialists in control and automation engineering who are familiar with applicable national standards. It is essential that the documentation and the following notes and explanations are followed when installing and commissioning the components. It is the duty of the technical personnel to use the documentation published at the respective time of each installation and commissioning. The responsible staff must ensure that the application or use of the products described satisfy all the requirements for safety, including all the relevant laws, regulations, guidelines and standards. Disclaimer The documentation has been prepared with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without prior announcement. No claims for the modification of products that have already been supplied may be made on the basis of the data, diagrams and descriptions in this documentation. Trademarks Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered trademarks of and licensed by Beckhoff Automation Gmb H. Other designations used in this publication may be trademarks whose use by third parties for their own purposes could violate the rights of the owners. Patent Pending The Ether CAT Technology is covered, including but not limited to the following patent applications and patents: EP1590927, EP1789857, EP1456722, EP2137893, DE102015105702 with corresponding applications or registrations in various other countries. Ether CAT® is a registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The reproduction, distribution and utilization of this document as well as the communication of its contents to others without express authorization are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event of the grant of a patent, utility model or design. TF3650 Version: 1.5 5
## Page 6

Foreword 1.2 Safety instructions Safety regulations Please note the following safety instructions and explanations! Product-specific safety instructions can be found on following pages or in the areas mounting, wiring, commissioning etc. Exclusion of liability All the components are supplied in particular hardware and software configurations appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. Personnel qualification This description is only intended for trained specialists in control, automation and drive engineering who are familiar with the applicable national standards. Description of symbols In this documentation the following symbols are used with an accompanying safety instruction or note. The safety instructions must be read carefully and followed without fail! DANGER Serious risk of injury! Failure to follow the safety instructions associated with this symbol directly endangers the life and health of persons. WARNING Risk of injury! Failure to follow the safety instructions associated with this symbol endangers the life and health of per- sons. CAUTION Personal injuries! Failure to follow the safety instructions associated with this symbol can lead to injuries to persons. NOTE Damage to the environment or devices Failure to follow the instructions associated with this symbol can lead to damage to the environment or equipment. Tip or pointer This symbol indicates information that contributes to better understanding. 6 Version: 1.5 TF3650
## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. TF3650 Version: 1.5 7
## Page 8

Overview 2 Overview Beckhoff offers various terminals for implementing supply network analysis and monitoring in its I/O portfolio. In a single- or three-phase grid, power measurement terminals such as the EL3403 or EL3413 directly provide RMS values for current and voltage, as well as active, reactive and apparent power. The EL3773 and EL3783 power monitoring terminals can also be used to log the raw data for current and voltage, so that grid events can be detected even more accurately, and various values can be calculated in the controller itself. The TC3 Power Monitoring function is a PLC library for evaluating raw current and voltage data provided by the power monitoring terminals. The library provides function blocks for calculating RMS values for current, voltage and power. These can be output as instantaneous or average values. The function block also offers maximum and minimum values. Frequency and frequency spectra can be determined, such as e.g. harmonics in the network and their load in the form of the Total Harmonic Distortion (THD). Furthermore, the library offers function blocks which can be used to determine frequencies and rotary fields. Product information The current version of the power monitoring library is available for download from the Beckhoff website. The PLC library offers various algorithms for analyzing current and voltage in a single- or three-phase grid. Some algorithms are based on implementations of the Twin CAT Condition Monitoring library. Product components The TF3650 power monitoring product consists of the following components: PLC libraries Tc3_Power Monitoring.compiled-library Tc3_Multi Array.compiled-library Drivers Tc Power Monitoring.sys Tc Multi Array.sys 8 Version: 1.5 TF3650
## Page 9

Installation 3 Installation 3.1 System requirements Engineering system An engineering system describes a computer that is used for the development of program code and does not execute program code. An engineering system must meet the following requirements: • Twin CAT 3 XAE (engineering installation) build 4024.0 or higher • Installation of TF3650 power monitoring • A 7-day trial license can be repeatedly activated for the engineering (see also Licensing [} 12]) Runtime system A runtime system describes an industrial or embedded PC on which program code is executed. A runtime system must meet the following requirements: • Twin CAT 3 XAR (runtime installation) build 4024.0 or higher • 32-bit and 64-bit systems are supported • Operating systems Win10 and Twin CAT/BSD • License for TC1200 PLC and for TF3650 Power Monitoring • A 7-day trial license can be activated repeatedly for testing purposes. Engineering and runtime on the same system To use engineering and runtime on the same system, the following system requirements have to be met: • Twin CAT 3 XAE (engineering installation) build 4024.0 or higher • License for TC1200 PLC and for TF3650 Power Monitoring • A 7-day trial license can be activated repeatedly for testing purposes. 3.2 Installation The following section describes how to install the Twin CAT 3 Function for Windows-based operating systems. ü The Twin CAT 3 Function setup file was downloaded from the Beckhoff website. 1. Run the setup file as administrator. To do this, select the command Run as administrator in the context menu of the file. ð The installation dialog opens. TF3650 Version: 1.5 9
## Page 10

Installation 2. Accept the end user licensing agreement and click Next. 3. Enter your user data. 10 Version: 1.5 TF3650
## Page 11

Installation 4. If you want to install the full version of the Twin CAT 3 Function, select Complete as installation type. If you want to install the Twin CAT 3 Function components separately, select Custom. 5. Select Next, then Install to start the installation. ð A dialog box informs you that the Twin CAT system must be stopped to proceed with the installation. TF3650 Version: 1.5 11
## Page 12

Installation 6. Confirm the dialog with Yes. 7. Select Finish to exit the setup. ð The Twin CAT 3 Function has been successfully installed and can be licensed (see Licensing [} 12]). 3.3 Licensing The Twin CAT 3 function can be activated as a full version or as a 7-day test version. Both license types can be activated via the Twin CAT 3 development environment (XAE). Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. 12 Version: 1.5 TF3650
## Page 13

Installation 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. TF3650 Version: 1.5 13
## Page 14

Installation 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. 14 Version: 1.5 TF3650
## Page 15

Technical introduction 4 Technical introduction 4.1 Memory Management The power monitoring library uses parts of the Condition Monitoring library, which internally uses Tc COM objects. The Tc COM objects are provided by the installed drivers. The instances are created dynamically in the Twin CAT AMS router memory. Necessity for dynamic memory management All memory requirements and initializations are implemented or performed during the initialization phase. Since the number of elements of the input data and the internal structures depend on the configuration of the respective function blocks, the memory space for them is allocated dynamically as a matter of principle. This happens automatically when the Condition Monitoring library is used. Since all memory allocations occur during initialization, and therefore the initialization of function blocks may require a relatively large amount of memory under certain circumstances, the initialization at this point may fail due to lack of memory, but not later. The allocated memory is released again once the object is deleted. Twin CAT router memory for dynamically generated objects The buffers reserved by the Condition Monitoring library are created in the Twin CAT AMS router memory when function blocks are initialized, so that they are available for execution under real-time conditions. Certain functions, such as high-resolution histograms and quantiles as well as the calculation of spectra with very high resolutions, require considerably more router memory than conventional control programs. Therefore, the router memory may need to be increased. Adapting the router memory The standard size of the router memory is 32 MB. The current setting is shown in the AMS Router Information dialog. To open the dialog, right-click on the Twin CAT System Service icon in the system tray and select the command Router > Info in the system menu that opens. To increase the router memory, open the real-time settings in Twin CAT Engineering and enter a value in MB in the Twin CAT configuration (Twin CAT project tree > SYSTEM > Real-Time > Settings tab > Router Memory). Then activate the configuration. TF3650 Version: 1.5 15
## Page 16

Technical introduction The adjustment of the router memory necessitates a reboot of the target device. 16 Version: 1.5 TF3650
## Page 17

PLC API 5 PLC API 5.1 General function blocks 5.1.1 FB_PMA_Scaling The function block FB_PMA_Scaling is used for scaling raw values. The raw values can be scaled individually or as an array, for example as oversampling values. In addition, it is possible to use single-phase and three-phase input signals. Alternatively, the specialized function blocks FB_PMA_Scaling_EL3773 [} 22] can be used for inputs of the EL3773 Ether CAT Terminal and FB_PMA_Scaling_EL3783 [} 26] for inputs of the EL3783 Ether CAT Terminal. Syntax Definition: FUNCTION BLOCK FB_PMA_Scaling VAR_INPUT st Init Pars : ST_PMA_Scaling_Init Pars END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 21] method). They may only be assigned once. A change at runtime is possible by calling the Init [} 21] method again. Name Type Description st Init Pars ST_PMA_Scaling_Init Pars [} 125] Function block-specific structure with initialization parameters Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE when new results were calculated. Methods Methods can be used to scale different systems (single-phase or three-phase) and different resolutions (16- bit or 32-bit). Name Description Call_1Ph_16Bit [} 18] The method is called to scale the 16-bit input data of type INT according to the configured parameters. Call_1Ph_32Bit [} 18] The method is called to scale the 32-bit input data of type DINT according to the configured parameters. TF3650 Version: 1.5 17
## Page 18

PLC API Name Description Call_3Ph_16Bit [} 19] The method is called to scale the 16-bit input data of type INT according to the configured parameters. Call_3Ph_32Bit [} 20] The method is called to scale the 32-bit input data of type DINT according to the configured parameters. Init [} 21] Alternative to the function block initialization Reconfigure [} 21] The method is called in order to reconfigure the function block during the runtime. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.1.1.1 Call_1Ph_16Bit The method is called to scale the 16-bit input data of type INT according to the configured parameters. Syntax METHOD Call_1Ph_16Bit : BOOL VAR_INPUT p Input Buffer_U : POINTER TO INT; p Input Buffer_I : POINTER TO INT; n Input Buffer Size : UDINT; p Output Buffer_U : POINTER TO LREAL; p Output Buffer_I : POINTER TO LREAL; n Output Buffer Size : UDINT; END_VAR Inputs Name Type Description p Input Buffer_U POINTER TO INT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_I POINTER TO INT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. p Output Buffer_U POINTER TO LREAL Pointer to an array in which the scaled voltage values are to be stored. p Output Buffer_I POINTER TO LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. Return value Name Type Description Call_1Ph_16Bit BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.1.2 Call_1Ph_32Bit The method is called to scale the 32-bit input data of type DINT according to the configured parameters. 18 Version: 1.5 TF3650
## Page 19

PLC API Syntax METHOD Call_1Ph_32Bit : BOOL VAR_INPUT p Input Buffer_U : POINTER TO DINT; p Input Buffer_I : POINTER TO DINT n Input Buffer Size : UDINT; p Output Buffer_U : POINTER TO LREAL; p Output Buffer_I : POINTER TO LREAL; n Output Buffer Size : UDINT; END_VAR VAR_OUTPUT END_VAR Inputs Name Type Description p Input Buffer_U POINTER TO DINT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_I POINTER TO DINT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. p Output Buffer_U POINTER TO LREAL Pointer to an array in which the scaled voltage values are to be stored. p Output Buffer_I POINTER TO LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. Return value Name Type Description Call_1Ph_32Bit BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.1.3 Call_3Ph_16Bit The method is called to scale the 16-bit input data of type INT according to the configured parameters. Syntax METHOD Call_3Ph_16Bit : BOOL VAR_INPUT p Input Buffer_UL1 : POINTER TO INT; p Input Buffer_UL2 : POINTER TO INT; p Input Buffer_UL3 : POINTER TO INT; p Input Buffer_IL1 : POINTER TO INT p Input Buffer_IL2 : POINTER TO INT p Input Buffer_IL3 : POINTER TO INT n Input Buffer Size : UDINT; p Output Buffer_UL1 : POINTER TO LREAL; p Output Buffer_UL2 : POINTER TO LREAL; p Output Buffer_UL3 : POINTER TO LREAL; p Output Buffer_IL1 : POINTER TO LREAL; p Output Buffer_IL2 : POINTER TO LREAL; p Output Buffer_IL3 : POINTER TO LREAL; n Output Buffer Size : UDINT; END_VAR VAR_OUTPUT END_VAR TF3650 Version: 1.5 19
## Page 20

PLC API Inputs Name Type Description p Input Buffer_UL1 .. UL3 POINTER TO INT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_IL1 .. IL3 POINTER TO INT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. p Output Buffer_UL1 .. POINTER TO LREAL Pointer to an array in which the scaled voltage UL3 values are to be stored. p Output Buffer_IL1 .. IL3 POINTER TO LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. Return value Name Type Description Call_3Ph_16Bit BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.1.4 Call_3Ph_32Bit The method is called to scale the 32-bit input data of type DINT according to the configured parameters. Syntax METHOD Call_3Ph_32Bit : BOOL VAR_INPUT p Input Buffer_UL1 : POINTER TO DINT; p Input Buffer_UL2 : POINTER TO DINT; p Input Buffer_UL3 : POINTER TO DINT; p Input Buffer_IL1 : POINTER TO DINT p Input Buffer_IL2 : POINTER TO DINT p Input Buffer_IL3 : POINTER TO DINT n Input Buffer Size : UDINT; p Output Buffer_UL1 : POINTER TO LREAL; p Output Buffer_UL2 : POINTER TO LREAL; p Output Buffer_UL3 : POINTER TO LREAL; p Output Buffer_IL1 : POINTER TO LREAL; p Output Buffer_IL2 : POINTER TO LREAL; p Output Buffer_IL3 : POINTER TO LREAL; n Output Buffer Size : UDINT; END_VAR VAR_OUTPUT END_VAR Inputs Name Type Description p Input Buffer_UL1 .. UL3 POINTER TO DINT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_IL1 .. IL3 POINTER TO DINT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. 20 Version: 1.5 TF3650
## Page 21

PLC API Name Type Description p Output Buffer_UL1 .. POINTER TO LREAL Pointer to an array in which the scaled voltage UL3 values are to be stored. p Output Buffer_IL1 .. IL3 POINTER TO LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. Return value Name Type Description Call_3Ph_32Bit BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.1.5 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). Syntax METHOD Init : BOOL VAR_INPUT st Init Pars : ST_PMA_Scaling_Init Pars; END_VAR Inputs Name Type Description st Init Pars ST_PMA_Scaling_Init Pars [} 125] Function block-specific structure with initialization parameters Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.1.6 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Offset Voltage : LREAL := 0.0; f Gain Voltage : LREAL := 1.0; f Offset Current : LREAL := 0.0; f Gain Current : LREAL := 1.0; END_VAR TF3650 Version: 1.5 21
## Page 22

PLC API Inputs Name Type Description f Offset Voltage LREAL Indicates a user-defined offset for the voltage scaling. f Gain Voltage LREAL Indicates a user-defined gain factor for the voltage scaling. f Offset Current LREAL Indicates a user-defined offset for the current scaling. f Gain Current LREAL Specifies a user-defined gain factor for the current scaling. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.2 FB_PMA_Scaling_EL3773 The function block FB_PMA_Scaling_EL3773 is a special version of the function block FB_PMA_Scaling [} 17]. It is used for scaling raw values provided by the EL3773 Ether CAT Terminal. The raw values can be scaled individually or as an array, for example as oversampling values. In addition, it is possible to use single-phase and three-phase input signals. Syntax Definition: FUNCTION BLOCK FB_PMA_Scaling_EL3773 VAR_INPUT st Init Pars : ST_PMA_Scaling_EL3773_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 25] method). They may only be assigned once. A change at runtime is possible by calling the Init [} 25] method again. Name Type Description st Init Pars ST_PMA_Scaling_EL3773_Init Par Function block-specific structure with initialization parameters s [} 124] Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. 22 Version: 1.5 TF3650
## Page 23

PLC API Name Type Description b New Result BOOL TRUE when new results were calculated. Methods Methods can be used to scale different systems (single-phase or three-phase). Name Description Call_1Ph [} 23] The method is called to scale the input data in a single-phase system of type INT according to the configured parameters. Call_3Ph [} 24] The method is called to scale the input data in a three-phase system of type INT according to the configured parameters. Init [} 25] Alternative to the function block initialization Reconfigure [} 25] The method is called in order to reconfigure the function block during the runtime. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.1.2.1 Call_1Ph The method is called to scale the input data in a single-phase system of type INT according to the configured parameters. LREAL is output. Syntax METHOD Call_1Ph : BOOL VAR_INPUT p Input Buffer_U : POINTER TO INT; p Input Buffer_I : POINTER TO INT; n Input Buffer Size : UDINT; p Output Buffer_U : POINTER TO LREAL; p Output Buffer_I : POINTER TO LREAL; n Output Buffer Size : UDINT; END_VAR Inputs Name Type Description p Input Buffer_U POINTER TO INT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_I POINTER TO INT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. p Output Buffer_U POINTER_TO_LREAL Pointer to an array in which the scaled voltage values are to be stored. p Output Buffer_I POINTER_TO_LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. TF3650 Version: 1.5 23
## Page 24

PLC API Return value Name Type Description Call_1Ph BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.2.2 Call_3Ph The method is called to scale the input data in a three-phase system of type INT according to the configured parameters. LREAL is output. Syntax METHOD Call_3Ph : BOOL VAR_INPUT p Input Buffer_UL1 : POINTER TO INT; p Input Buffer_UL2 : POINTER TO INT; p Input Buffer_UL3 : POINTER TO INT; p Input Buffer_IL1 : POINTER TO INT p Input Buffer_IL2 : POINTER TO INT p Input Buffer_IL3 : POINTER TO INT n Input Buffer Size : UDINT; p Output Buffer_UL1 : POINTER TO LREAL; p Output Buffer_UL2 : POINTER TO LREAL; p Output Buffer_UL3 : POINTER TO LREAL; p Output Buffer_IL1 : POINTER TO LREAL; p Output Buffer_IL2 : POINTER TO LREAL; p Output Buffer_IL3 : POINTER TO LREAL; n Output Buffer Size : UDINT; END_VAR VAR_OUTPUT END_VAR Inputs Name Type Description p Input Buffer_UL1 .. UL3 POINTER TO INT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_IL1 .. IL3 POINTER TO INT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. p Output Buffer_UL1 .. POINTER_TO_LREAL Pointer to an array in which the scaled voltage UL3 values are to be stored. p Output Buffer_IL1 .. IL3 POINTER_TO_LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. Return value Name Type Description Call_3Ph BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 24 Version: 1.5 TF3650
## Page 25

PLC API 5.1.2.3 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). Syntax METHOD Init : BOOL VAR_INPUT st Init Pars : ST_PMA_Scaling_EL3773_Init Pars; END_VAR Inputs Name Type Description st Init Pars Function block-specific structure with initialization ST_PMA_Scaling_EL3773_Init Par parameters s [} 124] Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.2.4 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Offset Voltage : LREAL := 0.0; f Gain Voltage : LREAL := 1.0; f Offset Current : LREAL := 0.0; f Gain Current : LREAL := 1.0; END_VAR Inputs Name Type Description f Offset Voltage LREAL Indicates a user-defined offset for the voltage scaling. f Gain Voltage LREAL Indicates a user-defined gain factor for the voltage scaling. f Offset Current LREAL Indicates a user-defined offset for the current scaling. f Gain Current LREAL Specifies a user-defined gain factor for the current scaling. TF3650 Version: 1.5 25
## Page 26

PLC API Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.3 FB_PMA_Scaling_EL3783 The function block FB_PMA_Scaling_EL3783 is a special version of the function block FB_PMA_Scaling [} 17]. It is used for scaling raw values provided by the EL3783 Ether CAT Terminal. The raw values can be scaled individually or as an array, for example as oversampling values. In addition, it is possible to use single-phase and three-phase input signals. The function block supports the Autorange functionality of the EL3783, which can operate in two current measurement ranges. Syntax Definition: FUNCTION BLOCK FB_PMA_Scaling_EL3783 VAR_INPUT st Init Pars : ST_PMA_Scaling_EL3783_Init Pars; VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 30] method). They may only be assigned once. A change at runtime is possible by calling the Init [} 30] method again. Name Type Description st Init Pars ST_PMA_Scaling_EL3783_Init Par Function block-specific structure with initialization parameters s [} 125] Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE when new results were calculated. Methods Methods can be used to scale different systems (single-phase or three-phase). Name Description Call_1Ph [} 27] The method is called to scale the input data in a single-phase system of type INT according to the configured parameters. Call_1Ph_Autorange The method is called to scale the input data in a single-phase system of type INT according to the configured parameters. [} 28] Call_3Ph [} 28] The method is called to scale the input data in a three-phase system of type INT according to the configured parameters. 26 Version: 1.5 TF3650
## Page 27

PLC API Name Description Call_3Ph_Autorange The method is called to scale the input data in a three-phase system of type INT according to the configured parameters. [} 29] Init [} 30] Alternative to the function block initialization Reconfigure [} 31] The method is called in order to reconfigure the function block during the runtime. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.1.3.1 Call_1Ph The method is called to scale the input data in a single-phase system of type INT according to the configured parameters. LREAL is output. Syntax METHOD Call_1Ph : BOOL VAR_INPUT p Input Buffer_U : POINTER TO INT; p Input Buffer_I : POINTER TO INT; n Input Buffer Size : UDINT; p Output Buffer_U : POINTER TO LREAL; p Output Buffer_I : POINTER TO LREAL; n Output Buffer Size : UDINT; b Use_5A_Range : BOOL; END_VAR Inputs Name Type Description p Input Buffer_U POINTER TO INT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_I POINTER TO INT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. p Output Buffer_U POINTER_TO_LREAL Pointer to an array in which the scaled voltage values are to be stored. p Output Buffer_I POINTER_TO_LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. b Use_5A_Range BOOL If the value is TRUE, the 5 A measuring range of the EL3783 is used. If it is FALSE, the 1 A measurement range is used. Return value Name Type Description Call_1Ph BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. TF3650 Version: 1.5 27
## Page 28

PLC API 5.1.3.2 Call_1Ph_Autorange The method is called to scale the input data in a single-phase system of type INT according to the configured parameters. LREAL is output. The EL3783 operates in Autorange mode. Syntax METHOD Call_1Ph_Autorange : BOOL VAR_INPUT p Input Buffer_U : POINTER TO INT; p Input Buffer_I : POINTER TO INT; n Input Buffer Size : UDINT; p Output Buffer_U : POINTER TO LREAL; p Output Buffer_I : POINTER TO LREAL; n Output Buffer Size : UDINT; b EL3783_Hc Range Active : BOOL; a EL3783_Hc Range : ARRAY [0..3] OF USINT; END_VAR VAR_OUTPUT END_VAR Inputs Name Type Description p Input Buffer_U POINTER TO INT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_I POINTER TO INT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. p Output Buffer_U POINTER_TO_LREAL Pointer to an array in which the scaled voltage values are to be stored. p Output Buffer_I POINTER_TO_LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. b EL3783_Hc Range Acti BOOL Autorange mode is active at the terminal. ve a EL3783_Hc Range ARRAY [0..3] OF USINT The current measuring range information for the EL3783. Return value Name Type Description Call_1Ph_Autorange BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.3.3 Call_3Ph The method is called to scale the input data in a three-phase system of type INT according to the configured parameters. LREAL is output. Syntax METHOD Call_3Ph : BOOL VAR_INPUT p Input Buffer_UL1 : POINTER TO INT; p Input Buffer_UL2 : POINTER TO INT; p Input Buffer_UL3 : POINTER TO INT; 28 Version: 1.5 TF3650
## Page 29

PLC API p Input Buffer_IL1 : POINTER TO INT p Input Buffer_IL2 : POINTER TO INT p Input Buffer_IL3 : POINTER TO INT n Input Buffer Size : UDINT; p Output Buffer_UL1 : POINTER TO LREAL; p Output Buffer_UL2 : POINTER TO LREAL; p Output Buffer_UL3 : POINTER TO LREAL; p Output Buffer_IL1 : POINTER TO LREAL; p Output Buffer_IL2 : POINTER TO LREAL; p Output Buffer_IL3 : POINTER TO LREAL; n Output Buffer Size : UDINT; b Use_5A_Range : BOOL; END_VAR VAR_OUTPUT END_VAR Inputs Name Type Description p Input Buffer_UL1 .. UL3 POINTER TO INT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_IL1 .. IL3 POINTER TO INT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. p Output Buffer_UL1 .. POINTER_TO_LREAL Pointer to an array in which the scaled voltage UL3 values are to be stored. p Output Buffer_IL1 .. IL3 POINTER_TO_LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. b Use_5A_Range BOOL If the value is TRUE, the 5 A measuring range of the EL3783 is used. If it is FALSE, the 1 A measurement range is used. Return value Name Type Description Call_3Ph BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.3.4 Call_3Ph_Autorange The method is called to scale the input data in a three-phase system of type INT according to the configured parameters. LREAL is output. The EL3783 operates in Autorange mode. Syntax METHOD Call_3Ph : BOOL VAR_INPUT p Input Buffer_UL1 : POINTER TO INT; p Input Buffer_UL2 : POINTER TO INT; p Input Buffer_UL3 : POINTER TO INT; p Input Buffer_IL1 : POINTER TO INT p Input Buffer_IL2 : POINTER TO INT p Input Buffer_IL3 : POINTER TO INT n Input Buffer Size : UDINT; p Output Buffer_UL1 : POINTER TO LREAL; p Output Buffer_UL2 : POINTER TO LREAL; p Output Buffer_UL3 : POINTER TO LREAL; p Output Buffer_IL1 : POINTER TO LREAL; p Output Buffer_IL2 : POINTER TO LREAL; TF3650 Version: 1.5 29
## Page 30

PLC API p Output Buffer_IL3 : POINTER TO LREAL; n Output Buffer Size : UDINT; b EL3783_Hc Range Active : BOOL; a EL3783_Hc Range : ARRAY [0..3] OF USINT; END_VAR VAR_OUTPUT END_VAR Inputs Name Type Description p Input Buffer_UL1 .. UL3 POINTER TO INT Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Input Buffer_IL1 .. IL3 POINTER TO INT Pointer to an array of current values. These can be added individually or as an oversampling array. n Input Buffer Size UDINT Indicates the size of a single input buffer in bytes. p Output Buffer_UL1 .. POINTER_TO_LREAL Pointer to an array in which the scaled voltage UL3 values are to be stored. p Output Buffer_IL1 .. IL3 POINTER_TO_LREAL Pointer to an array in which the scaled current values are to be stored. n Output Buffer Size UDINT Indicates the size of a single output buffer in bytes. b EL3783_Hc Range Acti BOOL Autorange mode is active at the terminal. ve a EL3783_Hc Range ARRAY [0..3] OF USINT The current measuring range information for the EL3783. Return value Name Type Description Call_3Ph_Autorange BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.3.5 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). Syntax METHOD Init : BOOL VAR_INPUT st Init Pars : ST_PMA_Scaling_EL3783_Init Pars; END_VAR Inputs Name Type Description st Init Pars ST_PMA_Scaling_EL3783_Init Par Function block-specific structure with initialization parameters s [} 125] 30 Version: 1.5 TF3650
## Page 31

PLC API Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.3.6 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Offset Voltage : LREAL := 0.0; f Gain Voltage : LREAL := 1.0; f Offset Current : LREAL := 0.0; f Gain Current : LREAL := 1.0; END_VAR Inputs Name Type Description f Offset Voltage LREAL Indicates a user-defined offset for the voltage scaling. f Gain Voltage LREAL Indicates a user-defined gain factor for the voltage scaling. f Offset Current LREAL Indicates a user-defined offset for the current scaling. f Gain Current LREAL Specifies a user-defined gain factor for the current scaling. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.4 FB_PMA_Task Transfer_Send The function block FB_PMA_Task Transfer_Send can be used to transfer data from a slow task back to a fast task. This may be necessary if computationally intensive algorithms were swapped out to a slow task and the results are required in another task. Together with the function block FB_PMA_Task Transfer_Receive [} 34], it forms a function block pair for sending and receiving data. The data is passed to a function block with the target analysis ID after each call of the Call [} 33] method. The output buffers are provided for the function blocks whose ID is entered in the array of target IDs. The buffer to be initialized must be sufficient to cover the data to be transmitted. Syntax Definition: TF3650 Version: 1.5 31
## Page 32

PLC API FUNCTION BLOCK FB_PMA_Task Transfer_Send VAR_INPUT n Own ID : UDINT; a Dest IDs : ARRAY[1.. GVL_PMA.c MA_Max Dest] OF UDINT; n Result Buffers : UDINT := 4; t Transfer Timeout : LTIME := LTIME#40US; st Init Pars : ST_PMA_Task Transfer_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 33] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. a Dest IDs ARRAY[1.. GVL_PMA.c MA_Max The data of the function block is sent to the IDs of Dest] OF UDINT the function block instances of the type specified here as an array FB_PMA_Task Transfer_Receive [} 34]. n Result Buffers UDINT Number of multi-array buffers that are initialized for the results. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Task Transfer_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 127] definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been provided. n Cnt Results ULINT Count value is incremented with new output data. Methods Name Description Call [} 33] The method is called in each cycle to write the values to the output buffer. Init [} 33] Alternative to the function block initialization Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 32 Version: 1.5 TF3650
## Page 33

PLC API 5.1.4.1 Call The method is called in each cycle to write the values to the output buffer. The output buffer is sent cyclically. Syntax METHOD CALL : HRESULT VAR_INPUT p Input Data : POINTER TO LREAL, n Data In Size : UDINT; n Option Pars : DWORD; END_VAR Inputs Name Type Description p Input Data POINTER TO LREAL Pointer to an input buffer of the data to be sent. n Data In Size UDINT Indicates the size of the input buffer in bytes. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.4.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : HRESULT VAR_INPUT n Own ID : UDINT; a Dest IDs : ARRAY[1.. GVL_PMA.c MA_Max Dest] OF UDINT; n Result Buffers : UDINT := 4; st Init Pars : ST_PMA_Task Transfer_Init Pars, END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. a Dest IDs ARRAY[1.. GVL_PMA.c MA_Max The data of the function block is sent to the IDs of Dest] OF UDINT the function block instances of the type specified here as an array FB_PMA_Task Transfer_Receive [} 34]. n Result Buffers UDINT Number of available multi-arrays TF3650 Version: 1.5 33
## Page 34

PLC API Name Type Description st Init Pars ST_PMA_Task Transfer_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 127] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.1.5 FB_PMA_Task Transfer_Receive The function block FB_PMA_Task Transfer_Receive can be used to transfer data from a slow task back to a fast task. This may be necessary if computationally intensive algorithms were swapped out to a slow task and the results are required in another task. The input buffer is provided via the function block FB_PMA_Task Transfer_Send [} 31]. The buffer to be initialized must be sufficient to cover the data to be transmitted. Syntax Definition: FUNCTION BLOCK FB_PMA_Task Transfer_Receive VAR_INPUT n Own ID : UDINT t Transfer Timeout : LTIME := LTIME#500US st Init Pars : ST_PMA_Task Transfer_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 36] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. a Dest IDs ARRAY[1.. GVL_PMA.c MA_Max Identifies the function block instance with a Dest] OF UDINT unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. n Result Buffers UDINT Number of multi-array buffers that are initialized for the results. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. 34 Version: 1.5 TF3650
## Page 35

PLC API Name Type Description st Init Pars ST_PMA_Task Transfer_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 127] definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been provided. n Cnt Results ULINT Count value is incremented with new output data. Methods Name Description Call [} 35] The method is called in each cycle to read the values from the input buffer when new data is present. Init [} 36] Alternative to the function block initialization Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.1.5.1 Call The method is called in each cycle to read the values from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD CALL : HRESULT VAR_INPUT p Output Data : POINTER TO LREAL, n Data Out Size : UDINT; END_VAR Inputs Name Type Description p Output Data POINTER TO LREAL Pointer to the output buffer. n Data Out Size UDINT Indicates the size of the output buffer in bytes. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. TF3650 Version: 1.5 35
## Page 36

PLC API 5.1.5.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : HRESULT VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Source_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Task Transfer_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 127] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2 Function blocks, single-phase 5.2.1 FB_PMA_Source_1Ph The function block FB_PMA_Source_1Ph writes data from an external PLC data buffer into a multi-array buffer. It accumulates input data continuously, until the maximum size of the multi-array is reached. When the multi- array is completely filled, it is passed to a function block with the target analysis ID. The output buffers are provided for the function blocks whose ID is entered in the array of target IDs. They contain the current and voltage values. The required size of the output buffer may vary depending on the analysis block used. It depends either on the FFT length used or the buffer size. Syntax Definition: FUNCTION BLOCK FB_PMA_Source_1Ph VAR_INPUT n Own ID : UDINT; a Dest IDs : ARRAY[1.. GVL_PMA.c MA_Max Dest] OF UDINT; n Result Buffers : UDINT := 4; t Transfer Timeout : LTIME := LTIME#40US; 36 Version: 1.5 TF3650
## Page 37

PLC API st Init Pars : ST_PMA_Source_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Results : BOOL; n Cnt Results : ULINT; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 38] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. a Dest IDs ARRAY[1.. GVL_PMA.c MA_Max Identifies the function block instance with a Dest] OF UDINT unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. n Result Buffers UDINT Number of multi-array buffers that are initialized for the results. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. st Init Pars ST_PMA_Source_Init Pars [} 126] Function block-specific structure with initialization parameters. The parameters must match the definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been provided. n Cnt Results ULINT Count value is incremented with new output data. Methods Name Description Call [} 38] The method is called in each cycle to write the values to the output buffer. Reset Data [} 38] This method can be used to reset the data currently in the buffer. Reset Analysis Chain Calling this method causes an automatic reset of all algorithms in the full analysis chain. [} 39] Init [} 38] Alternative to the function block initialization Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring TF3650 Version: 1.5 37
## Page 38

PLC API 5.2.1.1 Call The method is called in each cycle to write the values to the output buffer. The output buffer is sent as soon as it is filled. Syntax METHOD CALL : BOOL VAR_INPUT p Buffer_U : POINTER TO LREAL; p Buffer_I : POINTER TO LREAL; n Data In Size Per Ch : UDINT; n Option Pars : DWORD; END_VAR Inputs Name Type Description p Buffer_U POINTER TO LREAL Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Buffer_I POINTER TO LREAL Pointer to an array of current values. These can be added individually or as an oversampling array. n Data In Size Per Ch UDINT Indicates the size of a single input buffer in bytes. 5.2.1.2 Reset Data This method can be used to reset the data currently in the buffer. Syntax METHOD Reset Data : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset Data BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.1.3 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; a Dest IDs : ARRAY[1.. GVL_PMA.c MA_Max Dest] OF UDINT; n Result Buffers : UDINT := 4; st Init Pars : ST_PMA_Source_Init Pars; END_VAR 38 Version: 1.5 TF3650
## Page 39

PLC API Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. a Dest IDs ARRAY[1 - The result data is forwarded to the IDs of other GVL_PMA.c MA_Max Dest] OF function block instances specified here as an UDINT array. n Result Buffers UDINT Number of available multi-arrays. st Init Pars ST_PMA_Source_Init Pars [} 126] Function-block-specific structure with initialization parameters. The parameters must match the definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.1.4 Reset Analysis Chain Calling this method causes an automatic reset of all algorithms in the full analysis chain. Internally, a Reset Data() is carried out each time before accepting the new data set. If the analysis chain is only to be active for a certain period, this method offers the option to reset all algorithms before the next execution. Errors can occur when calling an input method and cause interruptions in the time series collection. If the following algorithms in the analysis chain calculate spectra, then the Reset Analysis Chain() method can be called in the case of an error when calling an input method. Because it is not possible to calculate correct spectra on the basis of fragmented time series. Syntax METHOD Reset Analysis Chain : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset Analysis Chain BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. TF3650 Version: 1.5 39
## Page 40

PLC API 5.2.2 Based on the signal period 5.2.2.1 FB_PMA_Frequency_Period_1Ph The function block FB_PMA_Frequency_Period_1Ph calculates the base frequency of the given input signal. To do this, the signal is first filtered with a Butterworth low-pass filter. The zero crossings of the input signal are then determined from the filtered values, and the frequency is calculated from their difference. The results refer to one or more periods, depending on the configuration. The statistical results refer to the entire runtime or the time at which the statistical results were last reset. The input buffer is provided via the function block FB_PMA_Source_1Ph [} 36]. This can include one or more signal periods or individual fragments of oversampling arrays. Syntax Definition: FUNCTION BLOCK FB_PMA_Frequency_Period_1Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Frequency_Period_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; f Freq : LREAL; f Freq_Min : LREAL; f Freq_Max : LREAL; f Rocof : LREAL; b Valid Statistics : BOOL; b Out Of Range : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 42] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Frequency_Period_Init P Function block-specific structure with initialization parameters. The parameters must correlate to the ars [} 128] above definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. 40 Version: 1.5 TF3650
## Page 41

PLC API Name Type Description n Cnt Results ULINT Count value is incremented with new output data. f Freq LREAL Frequency determined by two or more zero crossings. f Freq_Min LREAL Smallest value of f Freq that has occurred. Can be reset via b Reset Statistics of the Call method. f Freq_Max LREAL Largest value of f Freq that has occurred. Can be reset via b Reset Statistics of the Call method. f Rocof LREAL Rate of change of frequency (ROCOF). b Valid Statistics BOOL TRUE if the Min and Max value calculation has been performed. These values are valid. b Out Of Range BOOL TRUE as soon as the input value or the frequency is not within the configured limits. Methods Name Description Call [} 42] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 42] Alternative to the function block initialization Pass Inputs [} 43] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 43] The method is called in order to reconfigure the function block during the runtime. Reset [} 44] The current calculations are reset with the method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Oversamples); c Frequency Init Pars : ST_PMA_Frequency_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Freq := 45.0, f Max Freq := 55.0, n Periods := 1, n Filter Order := 2, f Cut Off := 70.0, e Input Select := E_PMA_Input Select. Voltage, f Min Input := 200.0); END_VAR VAR a Voltage AT%I* : ARRAY[1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_1Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Frequency : FB_PMA_Frequency_Period_1Ph := (n Own ID := 2, st Init Pars := c Frequency Init Pars); END_VAR // Call source fb Source. Call(ADR(a Voltage), ADR(a Current), SIZEOF(a Voltage), 0); // Call algorithm fb Frequency. Call(FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring TF3650 Version: 1.5 41
## Page 42

PLC API 5.2.2.1.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT b Reset Statistics : BOOL; END_VAR Inputs Name Type Description b Reset Statistics BOOL TRUE resets the minimum and maximum values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.1.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Frequency_Period_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Frequency_Period_Init P Function block-specific structure with initialization parameters. The parameters must match the ars [} 128] definition of the input and output buffers. 42 Version: 1.5 TF3650
## Page 43

PLC API Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.1.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_1Ph [} 36] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.1.4 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Min Freq : LREAL; f Max Freq : LREAL; n Periods : UDINT; n Filter Order : UINT; f Cutoff : LREAL; e Input Select : E_PMA_Input Select; f Min Input : LREAL; END_VAR Inputs Name Type Description f Min Freq LREAL Minimum expected measuring frequency f Max Freq LREAL Maximum expected measuring frequency n Periods UDINT Number of periods that influence the calculation. (Period length = sample rate/frequency) n Filter Order UINT Indicates the order of the low-pass filter. The stability of the filter must be considered for the setting. Only values up to the tenth order are allowed. f Cutoff LREAL Specifies the limit frequency of the low-pass filter. TF3650 Version: 1.5 43
## Page 44

PLC API Name Type Description e Input Select E_PMA_Input Select [} 140] Here you can configure whether the frequency of the voltage or the current should be calculated. f Min Input LREAL Minimum input value (RMS) over one period. This prevents the calculation of input values that are too small. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.1.5 Reset The current calculations are reset with the method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.2 FB_PMA_Basic Values_Period_1Ph The function block FB_PMA_Basic Values_Period_1Ph calculates analysis values for the signal sequence of current and voltage in a single-phase system. These include the mean value, the RMS value, the peak value, the rectified value, the crest factor and the form factor for current and voltage. The results refer to a configurable number of signal periods. The period duration refers to the frequency specified at the start of the period at the input of the Call [} 47] method. The statistical results refer to the entire runtime or the time at which the statistical results were last reset. The input buffer is provided via the function block FB_PMA_Source_1Ph [} 36]. This can include one or more signal periods or individual fragments of oversampling arrays. Syntax Definition: FUNCTION BLOCK FB_PMA_Basic Values_Period_1Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Basic Values_Period_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; f Mean Value_U : LREAL; f RMS_U : LREAL; f RMS_U_Min : LREAL; 44 Version: 1.5 TF3650
## Page 45

PLC API f RMS_U_Max : LREAL; f Peak Value_U : LREAL; f Peak Hold_U : LREAL; f Rectified Value_U : LREAL; f Crest Factor_U : LREAL; f Form Factor_U : LREAL; f Mean Value_I : LREAL, f RMS_I : LREAL, f RMS_I_Min : LREAL, f RMS_I_Max : LREAL, f Peak Value_I : LREAL, f Peak Hold_I : LREAL; f Rectified Value_I : LREAL; f Crest Factor_I : LREAL; f Form Factor_I : LREAL; b Valid Statistics : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 90] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Basic Values_Period_Init Function-block-specific structure with initialization parameters. The parameters must correlate to the Pars [} 127] above definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. f Mean Value_U LREAL Mean voltage value over n periods f RMS_U LREAL RMS value of the voltage over n periods f RMS_U_Min LREAL Smallest value of f RMS_U that has occurred. Can be reset via b Reset Statistics of the Call method. f RMS_U_Max LREAL Largest value of f RMS_U that has occurred. Can be reset via b Reset Statistics of the Call method. f Peak Value_U LREAL Peak voltage value over n periods f Peak Hold_U LREAL All-time peak voltage value over n periods. Can be reset via b Reset Statistics of the Call method. f Rectified Value_U LREAL Rectified voltage value over n periods f Crest Factor_U LREAL Crest factor of the voltage (peak/RMS value) f Form Factor_U LREAL Form factor of the voltage (RMS/rectified value) f Mean Value_I LREAL Mean value of the current over n periods f RMS_I LREAL RMS value of the current over n periods TF3650 Version: 1.5 45
## Page 46

PLC API Name Type Description f RMS_I_Min LREAL Smallest value of f RMS_I that has occurred. Can be reset via b Reset Statistics of the Call method. f RMS_I_Max LREAL Largest value of f RMS_I that has occurred. Can be reset via b Reset Statistics of the Call method. f Peak Value_I LREAL Peak value of the current over n periods f Peak Hold_I LREAL All-time peak current value. Can be reset via b Reset Statistics of the Call method. f Rectified Value_I LREAL Rectified value of the current over n periods f Crest Factor_I LREAL Crest factor of current (peak/RMS value) f Form Factor_I LREAL Form factor of the current (RMS/rectified value) b Valid Statistics BOOL TRUE if the Min, Max and Hold value calculation has been performed. These values are valid. Methods Name Description Call [} 47] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 90] Alternative to the function block initialization Pass Inputs [} 90] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 48] The method is called in order to reconfigure the function block during the runtime. Reset [} 49] The current calculations are reset with the method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Oversamples); c Frequency Init Pars : ST_PMA_Frequency_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Freq := 45.0, f Max Freq := 55.0, n Periods := 1, n Filter Order := 2, f Cut Off := 70.0, e Input Select := E_PMA_Input Select. Voltage, f Min Input := 200.0); c Basic Values Init Pars : ST_PMA_Basic Values_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Input Current := 0.01, n Periods := 1); END_VAR VAR a Voltage AT%I* : ARRAY[1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_1Ph := (n Own ID := 1, a Dest IDs := [2,3], st Init Pars := c Source Init Pars); fb Frequency : FB_PMA_Frequency_Period_1Ph := (n Own ID := 2, st Init Pars := c Frequency Init Pars); fb Basic Values : FB_PMA_Basic Values_Period_1Ph := (n Own ID := 3, st Init Pars := c Basic Values Init Par s); END_VAR // Call source fb Source. Call(ADR(a Voltage), ADR(a Current), SIZEOF(a Voltage), 0); // Call algorithms fb Frequency. Call(FALSE); fb Basic Values. Call(fb Frequency.f Freq, FALSE); 46 Version: 1.5 TF3650
## Page 47

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.2.2.2.1 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Basic Values_Period_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Basic Values_Period_Init Function block-specific structure with initialization parameters. The parameters must match the Pars [} 127] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.2.2 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT f Freq : LREAL; b Reset Statistics : BOOL; END_VAR TF3650 Version: 1.5 47
## Page 48

PLC API Inputs Name Type Description f Freq LREAL Current frequency of the input signal. Is used to determine the length of the period at the beginning of a period. The output of the function block FB_CMA_Frequency_Period_1Ph [} 40] can be used. b Reset Statistics BOOL TRUE resets the minimum, maximum and hold values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.2.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_1Ph [} 36] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.2.4 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Min Input Current : LREAL; END_VAR 48 Version: 1.5 TF3650
## Page 49

PLC API Inputs Name Type Description f Min Input Current LREAL Minimum input value (RMS) of the current. This prevents the calculation of input values that are too small. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.2.5 Reset The current calculations are reset with the method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.3 FB_PMA_Power Values_Period_1Ph The function block FB_PMA_Power Values_Period_1Ph calculates the power values of the connected consumer. These include the fundamental components and the phase shift angle. For this purpose, only the first harmonics of the input signal are used for the calculation in addition to the signal sequence in the time domain. The advantage of these algorithms is the high dynamics of the calculations. The results refer to a configurable number of signal periods. The period duration refers to the frequency specified at the start of the period at the input of the Call [} 52] method. The statistical results refer to the entire runtime or the time at which the statistical results were last reset. Alternatively, the function block FB_PMA_Power Values_1Ph [} 63] can be used. This uses the individual harmonics internally to calculate the power values. The input buffer is provided via the function block FB_PMA_Source_1Ph [} 36]. This can include one or more signal periods or individual fragments of oversampling values. Syntax Definition: FUNCTION BLOCK FB_PMA_Power Values_Period_1Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Power Values_Period_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; TF3650 Version: 1.5 49
## Page 50

PLC API b New Result : BOOL; n Cnt Results : ULINT; f Apparent Power : LREAL; f Apparent Power_1 : LREAL; f Apparent Power_1_Min : LREAL; f Apparent Power_1_Max : LREAL; f Active Power : LREAL; f Active Power_Min : LREAL; f Active Power_Max : LREAL; f Reactive Power_d : LREAL; f Reactive Power_1 : LREAL; f Reactive Power_1_Min : LREAL; f Reactive Power_1_Max : LREAL; f Total Reactive Power : LREAL; f Phi : LREAL; f Cos Phi : LREAL; f Power Factor : LREAL; f Power Quality Factor : LREAL; b Valid Statistics : BOOL; END_VAR VAR_OUTPUT PERSISTENT st Energy_Pos : ST_PMA_Energy; st Energy_Neg : ST_PMA_Energy; st Energy_Res : ST_PMA_Energy; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 53] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Power Values_Period_In Function block-specific structure with initialization parameters. The parameters must correlate to the it Pars [} 129] above definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. f Apparent Power LREAL Total apparent power f Apparent Power_1 LREAL Fundamental apparent power f Apparent Power_1_Min LREAL Smallest value of f Apparent Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. f Apparent Power_1_Max LREAL Largest value of f Apparent Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. f Active Power LREAL Active power 50 Version: 1.5 TF3650
## Page 51

PLC API Name Type Description f Active Power_Min LREAL Smallest value of f Active Power that has occurred. Can be reset via b Reset Statistics of the Call method. f Active Power_Max LREAL Largest value of f Active Power that has occurred. Can be reset via b Reset Statistics of the Call method. f Reactive Power_d LREAL Distortion reactive power f Reactive Power_1 LREAL Fundamental shift reactive power f Reactive Power_1_Min LREAL Smallest value of f Reactive Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. f Reactive Power_1_Max LREAL Largest value of f Reactive Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. f Total Reactive Power LREAL Total reactive power f Phi LREAL Phase shift angle f Cos Phi LREAL Cos Phi (active power/fundamental apparent power) f Power Factor LREAL Power factor (active power/total apparent power) f Power Quality Factor LREAL Power Quality Factor. Represents the quality of the power supply simplified in a value range between 0 and 1. The frequency, the RMS value of the voltage and the THD of the voltage are also included. b Valid Statistics BOOL TRUE if the Min and Max value calculation has been performed. These values are valid. st Energy_Pos ST_PMA_Energy [} 141] Energy in positive direction. The output is saved persistently and can be reset via b Reset Energy Calc of the Call method. st Energy_Neg ST_PMA_Energy [} 141] Energy in negative direction. The output is saved persistently and can be reset via b Reset Energy Calc of the Call method. st Energy_Res ST_PMA_Energy [} 141] Resulting energy. The output is saved persistently and can be reset via b Reset Energy Calc of the Call method. Methods Name Description Call [} 52] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 53] Alternative to the function block initialization Pass Inputs [} 53] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 54] The method is called in order to reconfigure the function block during the runtime. Reset [} 54] The current calculations are reset with the method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Oversamples); c Frequency Init Pars : ST_PMA_Frequency_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, TF3650 Version: 1.5 51
## Page 52

PLC API f Min Freq := 45.0, f Max Freq := 55.0, n Periods := 1, n Filter Order := 2, f Cut Off := 70.0, e Input Select := E_PMA_Input Select. Voltage, f Min Input := 200.0); c Power Values Init Pars : ST_PMA_Power Values_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Input Current := 0.01, n Periods := 1); END_VAR VAR a Voltage AT%I* : ARRAY[1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_1Ph := (n Own ID := 1, a Dest IDs := [2,3], st Init Pars := c Source Init Pars); fb Frequency : FB_PMA_Frequency_Period_1Ph := (n Own ID := 2, st Init Pars := c Frequency Init Pars); fb Power Values : FB_PMA_Power Values_Period_1Ph := (n Own ID := 3, st Init Pars := c Power Values Init Par s); END_VAR // Call source fb Source. Call(ADR(a Voltage), ADR(a Current), SIZEOF(a Voltage), 0); // Call algorithms fb Frequency. Call(FALSE); fb Power Values. Call(fb Frequency.f Freq, FALSE, FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.2.2.3.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT f Freq : LREAL; b Reset Energy Calc : LREAL; b Reset Statistics : BOOL; END_VAR Inputs Name Type Description f Freq LREAL Current frequency of the input signal. Is used to determine the length of the period at the beginning of a period. The output of the function block FB_CMA_Frequency_Period_1Ph [} 40] can be used. b Reset Energy Calc LREAL TRUE resets the calculated values of the energy measurement. b Reset Statistics BOOL TRUE resets the minimum and maximum values of the outputs. 52 Version: 1.5 TF3650
## Page 53

PLC API Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.3.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT st Init Pars : ST_PMA_Power Values_Period_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Power Values_Period_In Function block-specific structure with initialization parameters. The parameters must match the it Pars [} 129] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.3.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_1Ph [} 36] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR TF3650 Version: 1.5 53
## Page 54

PLC API Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.3.4 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Min Input Current : LREAL; END_VAR Inputs Name Type Description f Min Input Current LREAL Minimum input value (RMS) of the current. This prevents the calculation of input values that are too small. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.3.5 Reset The current calculations are reset with the method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.4 FB_PMA_Harmonics_Period_1Ph The function block FB_PMA_Harmonics_Period_1Ph calculates the current and voltage harmonics. In addition, the THD of the input values is calculated from the harmonics. In contrast to the function block FB_PMA_Harmonics_1Ph [} 59], the results refer to a configurable number of signal periods. The period value refers to the frequency specified at the start of the period at the input of the Call [} 56] method. The statistical results refer to the entire runtime or the time at which the statistical results were last reset. 54 Version: 1.5 TF3650
## Page 55

PLC API The input buffer is provided via the function block FB_PMA_Source_1Ph [} 36]. This can include one or more signal periods or individual fragments of oversampling values. Syntax Definition: FUNCTION BLOCK FB_PMA_Harmonics_Period_1Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Harmonics_Period_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; f THD_U : LREAL; f THD_U_Min : LREAL; f THD_U_Max : LREAL; f THD_I : LREAL; f THD_I_Min : LREAL; f THD_I_Max : LREAL; b Valid Statistics : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 57] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Harmonics_Period_Init Function-block-specific structure with initialization parameters. The parameters must correlate to the Pars [} 130] above definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. f THD_U LREAL THD of the voltage. The output is in percent. f THD_U_Min LREAL Smallest value of f THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. f THD_U_Max LREAL Largest value of f THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. f THD_I LREAL THD of the current. The output is in percent. f THD_U_Min LREAL Smallest value of f THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. TF3650 Version: 1.5 55
## Page 56

PLC API Name Type Description f THD_U_Max LREAL Largest value of f THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. b Valid Statistics BOOL TRUE if the Min and Max value calculation has been performed. These values are valid. Methods Name Description Call [} 56] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 57] Alternative to the function block initialization Pass Inputs [} 58] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reset [} 58] The current calculations are reset with the method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Oversamples); c Frequency Init Pars : ST_PMA_Frequency_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Freq := 45.0, f Max Freq := 55.0, n Periods := 1, n Filter Order := 2, f Cut Off := 70.0, e Input Select := E_PMA_Input Select. Voltage, f Min Input := 200.0); c Harmonics Init Pars : ST_PMA_Harmonics_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, n Num Harmonics := 20, n Periods := 10, b Transform To Percent := TRUE); END_VAR VAR a Voltage AT%I* : ARRAY[1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_1Ph := (n Own ID := 1, a Dest IDs := [2,3], st Init Pars := c Source Init Pars); fb Frequency : FB_PMA_Frequency_Period_1Ph := (n Own ID := 2, st Init Pars := c Frequency Init Pars); fb Harmonics : FB_PMA_Harmonics_Period_1Ph := (n Own ID := 3, st Init Pars := c Harmonics Init Pars); a Harmonics Voltage : ARRAY[1..20] OF LREAL; a Harmonics Current : ARRAY[1..20] OF LREAL; END_VAR // Call source fb Source. Call(ADR(a Voltage), ADR(a Current), SIZEOF(a Voltage), 0); // Call algorithms fb Frequency. Call(FALSE); fb Harmonics. Call(fb Frequency.f Freq, ADR(a Harmonics Voltage), ADR(a Harmonics Current), SIZEOF(a Harmonic s Voltage), FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.2.2.4.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. 56 Version: 1.5 TF3650
## Page 57

PLC API The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT f Freq : LREAL; p Harmonics RMS_U : POINTER TO LREAL; p Harmonics RMS_I : POINTER TO LREAL; n Harmonics RMSSize : UDINT; END_VAR Inputs Name Type Description f Freq LREAL Current frequency of the input signal. Is used to determine the length of the period at the beginning of a period. The output of the function block FB_CMA_Frequency_Period_1Ph [} 40] can be used. p Harmonics RMS_U POINTER TO LREAL Pointer to an array of type LREAL with dimension: number of harmonics. If the individual harmonics are not to be output, the input can be set to 0. p Harmonics RMS_I POINTER TO LREAL Pointer to an array of type LREAL with dimension: number of harmonics. If the individual harmonics are not to be output, the input can be set to 0. n Harmonics RMSSize UDINT Indicates the size of an output array for the harmonics. b Reset Statistics BOOL TRUE resets the minimum and maximum values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.4.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT st Init Pars : ST_PMA_Harmonics_Period_Init Pars; END_VAR TF3650 Version: 1.5 57
## Page 58

PLC API Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Harmonics_Period_Init Function-block-specific structure with initialization parameters. The parameters must match the Pars [} 130] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.4.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_1Ph [} 36] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.2.4.4 Reset The current calculations are reset with the method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 58 Version: 1.5 TF3650
## Page 59

PLC API 5.2.3 Based on the frequency range 5.2.3.1 FB_PMA_Harmonics_1Ph The function block FB_PMA_Harmonics_1Ph calculates the RMS bands of the individual current and voltage harmonics. In addition, the calculated RMS bands are used to calculate the THD of the input variables. The input buffer is provided via the function block FB_PMA_Source_1Ph [} 36]. The size of the input buffer is half the window length. By way of example, possible FFT and window lengths are shown in the following table: FFT length Window length Buffer length 512 29 400 200 1024 210 800 400 2048 211 1600 800 4096 212 3200 1600 8192 213 6400 3200 16384 214 12800 6400 Memory properties Since the Welch method is used, in each case the current input buffer together with the last transferred buffer is used for the calculation. The frequency analysis takes step changes in the time series into account. In order to achieve a correct result, the last two input buffers should therefore be consecutive without step changes. Syntax Definition: FUCNTION BLOCK FB_PMA_Harmonics_1Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Harmonics_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; f THD_U : LREAL; f THD_U_Min : LREAL; f THD_U_Max : LREAL; f THD_I : LREAL; f THD_I_Min : LREAL; f THD_I_Max : LREAL; b Valid Statistics : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 62] method). They may only be assigned once. A change at runtime is not possible. Name Type Description t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. TF3650 Version: 1.5 59
## Page 60

PLC API Name Type Description st Init Pars ST_PMA_Harmonics_Init Pars Function-block-specific structure with initialization parameters. The parameters must match the [} 130] definition of the input and output buffers. n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. f THD_U LREAL THD of the voltage. The output is in percent. f THD_U_Min LREAL Smallest value of f THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. f THD_U_Max LREAL Largest value of f THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. f THD_I LREAL THD of the current. The output is in percent. f THD_U_Min LREAL Smallest value of f THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. f THD_U_Max LREAL Largest value of f THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. b Valid Statistics BOOL TRUE if the Min, Max and Hold value calculation has been performed. These values are valid. Methods Name Description Call [} 61] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 62] Alternative to the function block initialization Pass Inputs [} 62] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 63] The method is called in order to reconfigure the function block during the runtime. Reset [} 63] This method deletes all the data sets already added. In addition, the calculated output values are reset. Sample VAR CONSTANT c Oversamples : UDINT := 10; c FFT_Length : UDINT := 4096; c Window Length : UDINT := 3200; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Window Length/2); c Harmonics Init Pars : ST_PMA_Harmonics_Init Pars := ( n FFT_Length := c FFT_Length, n Window Length := c Window Length, f Sample Rate := c Oversamples * 1000, f Base Freq := 50.0, n Num Bands := 40, f Bandwidth := 20.0, e Window Type := E_PMA_Window Type. Hann Window, 60 Version: 1.5 TF3650
## Page 61

PLC API b Transform To Decibel := FALSE, f Decibel Threshold := GVL_PMA.c Min Arg Log10, b Transform To Percent := TRUE); END_VAR VAR a Voltage AT%I* : ARRAY[1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_1Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Harmonics : FB_PMA_Harmonics_1Ph := (n Own ID := 2, st Init Pars := c Harmonics Init Pars); a Harmonics Voltage : ARRAY[1..40] OF LREAL; a Harmonics Current : ARRAY[1..40] OF LREAL; END_VAR // Call source fb Source. Call(ADR(a Voltage), ADR(a Current), SIZEOF(a Voltage), 0); // Call algorithm fb Harmonics. Call(ADR(a Harmonics Voltage), ADR(a Harmonics Current), SIZEOF(a Harmonics Voltage), FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.2.3.1.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT p Harmonics RMS_U : POINTER TO LREAL; p Harmonics RMS_I : POINTER TO LREAL; n Harmonics RMSSize : UDINT; b Reset Statistics : BOOL; END_VAR Inputs Name Type Description p Harmonics RMS_U POINTER TO LREAL Pointer to an array of type LREAL with the dimension: Number of harmonics. If the individual harmonics are not to be output, the input can be set to 0. p Harmonics RMS_I POINTER TO LREAL Pointer to an array of type LREAL with the dimension: Number of harmonics. If the individual harmonics are not to be output, the input can be set to 0. n Harmonics RMSSize UDINT Indicates the size of an output array for the harmonics. b Reset Statistics BOOL TRUE resets the minimum, maximum and hold values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. TF3650 Version: 1.5 61
## Page 62

PLC API 5.2.3.1.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Harmonics_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Harmonics_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 130] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.1.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_1Ph [} 36] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 62 Version: 1.5 TF3650
## Page 63

PLC API 5.2.3.1.4 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Base Freq : LREAL; f Bandwidth : LREAL; END_VAR Inputs Name Type Description f Base Freq LREAL Frequency of the first harmonic. f Bandwidth LREAL Total bandwidth of each RMS band. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.1.5 Reset This method deletes all the data sets already added. In addition, the calculated output values are reset. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.2 FB_PMA_Power Values_1Ph The function block FB_PMA_Power Values_1Ph calculates the power values of the connected consumer. These include the fundamental components and the phase shift angle. Internally, the individual harmonics and their phase angle are determined for the calculations. Alternatively, the function block FB_PMA_Power Values_Period_1Ph [} 49] can be used for the calculation. It uses simpler calculation methods for enhanced dynamics. The input buffer is provided via the function block FB_PMA_Source_1Ph [} 36]. The size of the input buffer is half the window length. By way of example, possible FFT and window lengths are shown in the following table: FFT length Window length Buffer length 512 29 400 200 TF3650 Version: 1.5 63
## Page 64

PLC API FFT length Window length Buffer length 1024 210 800 400 2048 211 1600 800 4096 212 3200 1600 8192 213 6400 3200 16384 214 12800 6400 Memory properties Since the Welch method is used, in each case the current input buffer together with the last transferred buffer is used for the calculation. The frequency analysis takes step changes in the time series into account. In order to achieve a correct result, the last two input buffers should therefore be consecutive without step changes. Syntax Definition: FUNCTION BLOCK FB_PMA_Power Values_1Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Power Values_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; f Apparent Power : LREAL; f Apparent Power_1 : LREAL; f Apparent Power_1_Min : LREAL; f Apparent Power_1_Max : LREAL; f Active Power : LREAL; f Active Power_Min : LREAL; f Active Power_Max : LREAL; f Reactive Power_d : LREAL; f Reactive Power_1 : LREAL; f Reactive Power_1_Min : LREAL; f Reactive Power_1_Max : LREAL; f Total Reactive Power : LREAL; f Phi : LREAL; f Cos Phi : LREAL; f Power Factor : LREAL; b Valid Statistics : BOOL; END_VAR VAR_OUTPUT PERSISTENT st Energy_Pos : ST_PMA_Energy; st Energy_Neg : ST_PMA_Energy; st Energy_Res : ST_PMA_Energy; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 67] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. 64 Version: 1.5 TF3650
## Page 65

PLC API Name Type Description st Init Pars ST_PMA_Power Values_Init Pars Function-block-specific structure with initialization parameters. The parameters must match the [} 132] definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. f Apparent Power LREAL Total apparent power f Apparent Power_1 LREAL Fundamental apparent power f Apparent Power_1_Min LREAL Smallest value of f Apparent Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. f Apparent Power_1_Max LREAL Largest value of f Apparent Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. f Active Power LREAL Active power f Active Power_Min LREAL Smallest value of f Active Power that has occurred. Can be reset via b Reset Statistics of the Call method. f Active Power_Max LREAL Largest value of f Active Power that has occurred. Can be reset via b Reset Statistics of the Call method. f Reactive Power_d LREAL Distortion reactive power f Reactive Power_1 LREAL Fundamental shift reactive power f Reactive Power_1_Min LREAL Smallest value of f Reactive Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. f Reactive Power_1_Max LREAL Largest value of f Reactive Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. f Total Reactive Power LREAL Total reactive power f Phi LREAL Phase shift angle f Cos Phi LREAL Cos Phi (active power/fundamental apparent power) f Power Factor LREAL Power factor (active power/total apparent power) b Valid Statistics BOOL TRUE if the Min and Max value calculation has been performed. These values are valid. st Energy_Pos ST_PMA_Energy [} 141] Energy in positive direction. The output is saved persistently and can be reset via b Reset Energy Calc of the Call method. st Energy_Neg ST_PMA_Energy [} 141] Energy in negative direction. The output is saved persistently and can be reset via b Reset Energy Calc of the Call method. st Energy_Res ST_PMA_Energy [} 141] Resulting energy. The output is saved persistently and can be reset via b Reset Energy Calc of the Call method. TF3650 Version: 1.5 65
## Page 66

PLC API Methods Name Description Call [} 66] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 67] Alternative to the function block initialization Pass Inputs [} 67] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 68] The method is called in order to reconfigure the function block during the runtime. Reset [} 68] This method deletes all the data sets already added. In addition, the calculated output values are reset. Sample VAR CONSTANT c Oversamples : UDINT := 10; c FFT_Length : UDINT := 4096; c Window Length : UDINT := 3200; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Window Length/2); c Power Values Init Pars : ST_PMA_Power Values_Init Pars := ( n FFT_Length := c FFT_Length, n Window Length := c Window Length, f Sample Rate := c Oversamples * 1000, f Base Freq := 50.0, n Num Bands := 40, f Bandwidth := 20.0, e Window Type := E_PMA_Window Type. Hann Window, f Time Lag Current Transformer := 0.0, f Min Input Current := 0.01); END_VAR VAR a Voltage AT%I* : ARRAY[1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_1Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Power Values : FB_PMA_Power Values_1Ph := (n Own ID := 2, st Init Pars := c Power Values Init Pars); END_VAR // Call source fb Source. Call(ADR(a Voltage), ADR(a Current), SIZEOF(a Voltage), 0); // Call algorithm fb Power Values. Call(FALSE, FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.2.3.2.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT b Reset Energy Calc : BOOL; b Reset Statistics : BOOL; END_VAR 66 Version: 1.5 TF3650
## Page 67

PLC API Inputs Name Type Description b Reset Energy Calc BOOL TRUE resets the calculated values of the energy measurement. b Reset Statistics BOOL TRUE resets the minimum and maximum values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.2.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Power Values_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Power Values_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 132] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.2.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_1Ph [} 36] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). TF3650 Version: 1.5 67
## Page 68

PLC API Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.2.4 Reset This method deletes all the data sets already added. In addition, the calculated output values are reset. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.2.5 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Base Freq : LREAL; f Bandwidth : LREAL; f Min Input Current : LREAL; END_VAR Inputs Name Type Description f Base Freq LREAL Frequency of the first harmonic. f Bandwidth LREAL Total bandwidth of each RMS band. f Min Input Current LREAL Minimum input value (RMS) of the current. This prevents the calculation of input values that are too small. 68 Version: 1.5 TF3650
## Page 69

PLC API Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.3 FB_PMA_Spectrum_1Ph The function block FB_PMA_Spectrum_1Ph calculates the magnitude spectra of the current and voltage values. These are suitable for analyzing the input signals in the frequency range. The input buffer is provided via the function block FB_PMA_Source_1Ph [} 36]. The size of the input buffer is half the window length. By way of example, possible FFT and window lengths are shown in the following table: FFT length Window length Buffer length 512 29 400 200 1024 210 800 400 2048 211 1600 800 4096 212 3200 1600 8192 213 6400 3200 16384 214 12800 6400 Memory properties Since the Welch method is used, in each case the current input buffer together with the last transferred buffer is used for the calculation. The frequency analysis takes step changes in the time series into account. In order to achieve a correct result, the last two input buffers should therefore be consecutive without step changes. Syntax Definition: FUNCTION BLOCK FB_PMA_Spectrum_1Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Spectrum_Init Pars; VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 71] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. TF3650 Version: 1.5 69
## Page 70

PLC API Name Type Description t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Spectrum_Init Pars Function-block-specific structure with initialization parameters. The parameters must match the [} 133] definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. Methods Name Description Call [} 71] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 71] Alternative to the function block initialization Pass Inputs [} 72] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reset [} 72] This method deletes all the data sets already added. Sample VAR CONSTANT c Oversamples : UDINT := 10; c FFT_Length : UDINT := 4096; c Window Length : UDINT := 3200; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Window Length/2); c Spectrum Init Pars : ST_PMA_Spectrum_Init Pars := ( n FFT_Length := c FFT_Length, n Window Length := c Window Length, f Sample Rate := c Oversamples * 1000, e Scaling Type := E_PMA_Scaling Type. Peak Amplitude, e Window Type := E_PMA_Window Type. Hann Window, b Transform To Decibel := FALSE, f Decibel Threshold := GVL_PMA.c Min Arg Log10); END_VAR VAR a Voltage AT%I* : ARRAY[1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_1Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Spectrum : FB_PMA_Spectrum_1Ph := (n Own ID := 2, st Init Pars := c Spectrum Init Pars); a Spectrum Voltage : ARRAY[1..c FFT_Length/2 + 1] OF LREAL; a Spectrum Current : ARRAY[1..c FFT_Length/2 + 1] OF LREAL; END_VAR // Call source fb Source. Call(ADR(a Voltage), ADR(a Current), SIZEOF(a Voltage), 0); // Call algorithm fb Spectrum. Call(ADR(a Spectrum Voltage), ADR(a Spectrum Current), SIZEOF(a Spectrum Voltage)); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 70 Version: 1.5 TF3650
## Page 71

PLC API 5.2.3.3.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT p Magnitude Spectrum_U : POINTER TO LREAL; p Magnitude Spectrum_I : POINTER TO LREAL; n Magnitude Spectrum Size : UDINT; END_VAR Inputs Name Type Description p Magnitude Spectrum_U POINTER TO LREAL Pointer to an array of type LREAL with the dimension: FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. p Magnitude Spectrum_I POINTER TO LREAL Pointer to an array of type LREAL with the dimension: FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. n Magnitude Spectrum Si UDINT Indicates the size of the output array of a ze spectrum. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.3.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Spectrum_Init Pars; END_VAR TF3650 Version: 1.5 71
## Page 72

PLC API Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Spectrum_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 133] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.3.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_1Ph [} 36] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.3.4 Reset This method deletes all the data sets already added. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 72 Version: 1.5 TF3650
## Page 73

PLC API 5.2.3.4 FB_PMA_Spectrum_Quantiles_1Ph The function block FB_PMA_Spectrum_Quantiles_1Ph calculates the magnitude spectra of the current and voltage values like the function block FB_PMA_Spectrum_1Ph [} 69]. In addition, p-quantiles of the spectrum distribution can be calculated. The quantiles and their number can be configured individually. The input buffer is provided via the function block FB_PMA_Source_1Ph [} 36]. The size of the input buffer is half the window length. By way of example, possible FFT and window lengths are shown in the following table: FFT length Window length Buffer length 512 29 400 200 1024 210 800 400 2048 211 1600 800 4096 212 3200 1600 8192 213 6400 3200 16384 214 12800 6400 Memory properties The function block takes into account all input values since the instantiation. If the Reset [} 78] method has been called since the start, all input values since its last call will be taken into account. Syntax Definition: FUNCTION BLOCK FB_PMA_Spectrum_Quantiles_1Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Spectrum_Quantiles_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 76] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Spectrum_Quantiles_Ini Function block-specific structure with initialization parameters. The parameters must match the t Pars [} 134] definition of the input and output buffers. TF3650 Version: 1.5 73
## Page 74

PLC API Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. Methods Name Description Call [} 75] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Call Ex [} 77] To minimize CPU usage, it may be necessary to use the Call Ex method. In contrast to the Call method, the quantiles are not calculated after each spectrum calculation, but only after a configurable number of calculations. Init [} 76] Alternative to the function block initialization Pass Inputs [} 76] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 78] The method is called in order to reconfigure the function block during the runtime. Reset [} 78] This method deletes all the data sets already added. Alternatively, automatic resetting can be used on the Call Ex method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c FFT_Length : UDINT := 4096; c Window Length : UDINT := 3200; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Window Length/2); c Spectrum Quantiles Init Pars : ST_PMA_Spectrum_Quantiles_Init Pars := ( n FFT_Length := c FFT_Length, n Window Length := c Window Length, f Sample Rate := c Oversamples * 1000, e Scaling Type := E_PMA_Scaling Type. Peak Amplitude, e Window Type := E_PMA_Window Type. Hann Window, b Transform To Decibel := FALSE, f Decibel Threshold := GVL_PMA.c Min Arg Log10, f Min Binned Voltage := 0.0, f Max Binned Voltage := 300, f Min Binned Current := 0.0, f Max Binned Current := 2, n Bins := 10, n Num Quantiles := 2, a Quantiles := [0.5, 0.9]); END_VAR VAR a Voltage AT%I* : ARRAY[1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_1Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Spectrum Quantiles : FB_PMA_Spectrum_Quantiles_1Ph := (n Own ID := 2, st Init Pars := c Spectrum Quan tiles Init Pars); a Spectrum Voltage : ARRAY[1..c FFT_Length/2 + 1] OF LREAL; a Spectrum Current : ARRAY[1..c FFT_Length/2 + 1] OF LREAL; a Spectrum Quantiles Voltage : ARRAY[1..c FFT_Length/2 + 1, 1..2] OF LREAL; a Spectrum Quantiles Current : ARRAY[1..c FFT_Length/2 + 1, 1..2] OF LREAL; b New Result_Spectrum : BOOL; b New Result_Quantiles : BOOL; END_VAR // Call source fb Source. Call(ADR(a Voltage), ADR(a Current), SIZEOF(a Voltage), 0); // Call algorithm fb Spectrum Quantiles. Call Ex( 74 Version: 1.5 TF3650
## Page 75

PLC API 5, FALSE, ADR(a Spectrum Voltage), ADR(a Spectrum Current), SIZEOF(a Spectrum Voltage), ADR(a Spectrum Quantiles Voltage), ADR(a Spectrum Quantiles Current), SIZEOF(a Spectrum Quantiles Voltage), ADR(b New Result_Spectrum), ADR(b New Result_Quantiles)); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.2.3.4.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. The Call Ex [} 77] method may be suitable as an alternative. It calculates the quantiles only after a defined number of spectrum calculation results, in order to minimize CPU usage. Syntax METHOD Call : BOOL VAR_INPUT p Magnitude Spectrum_U : POINTER TO LREAL; p Magnitude Spectrum_I : POINTER TO LREAL; n Magnitude Spectrum Size : UDINT p Spectrum Quantiles_U : POINTER TO LREAL; p Spectrum Quantiles_I : POINTER TO LREAL; n Spectrum Quantiles Size : UDINT; END_VAR Inputs Name Type Description p Magnitude Spectrum_U POINTER TO LREAL Pointer to an array of type LREAL with the dimension: FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. p Magnitude Spectrum_I POINTER TO LREAL Pointer to an array of type LREAL with the dimension: FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. n Magnitude Spectrum Si UDINT Indicates the size of the output array of a ze spectrum. p Spectrum Quantiles_U POINTER TO LREAL Pointer to an array of type LREAL with the dimension: FFT length/2+1 x quantile. If these values are not to be output, the input can be set to 0. p Spectrum Quantiles_I POINTER TO LREAL Pointer to an array of type LREAL with the dimension: FFT length/2+1 x quantile. If these values are not to be output, the input can be set to 0. n Spectrum Quantiles Siz UDINT Indicates the size of the output array for a e quantile calculation. TF3650 Version: 1.5 75
## Page 76

PLC API Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.4.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Spectrum_Quantiles_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Spectrum_Quantiles_Ini Function block-specific structure with initialization parameters. The parameters must match the t Pars [} 134] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.4.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_1Ph [} 36] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR 76 Version: 1.5 TF3650
## Page 77

PLC API Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.4.4 Call Ex The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. In contrast to the Call [} 75] method, the Call Ex method collects a variable number of results from the spectrum calculation and calculates the quantiles only afterwards. This may be required to minimize CPU load. Syntax METHOD Call Ex : BOOL VAR_INPUT n Append Data : UDINT; b Reset Data : BOOL; p Magnitude Spectrum_U : POINTER TO LREAL; p Magnitude Spectrum_I : POINTER TO LREAL; n Magnitude Spectrum Size : UDINT p Spectrum Quantiles_U : POINTER TO LREAL; p Spectrum Quantiles_I : POINTER TO LREAL; n Spectrum Quantiles Size : UDINT; END_VAR Inputs Name Type Description n Append Data UDINT Number of spectra to be calculated until the quantile is calculated. A value of 1 means that the quantiles are calculated after each result of the spectrum calculation. b Reset Data BOOL Automatic resetting of records after each quantile calculation p Magnitude Spectrum_U POINTER TO LREAL Pointer to an array of the type LREAL with the dimension FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. p Magnitude Spectrum_I POINTER TO LREAL Pointer to an array of the type LREAL with the dimension FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. n Magnitude Spectrum Si UDINT Indicates the size of the output array of a ze spectrum. p Spectrum Quantiles_U POINTER TO LREAL Pointer to an array of the type LREAL with the dimension FFT length/2+1 x quantile. If these values are not to be output, the input can be set to 0. p Spectrum Quantiles_I POINTER TO LREAL Pointer to an array of the type LREAL with the dimension FFT length/2+1 x quantile. If these values are not to be output, the input can be set to 0. n Spectrum Quantiles Siz UDINT Indicates the size of the output array for a e quantile calculation. TF3650 Version: 1.5 77
## Page 78

PLC API Return value Name Type Description Call Ex BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.4.5 Reset This method deletes all the data sets already added. Alternatively, automatic resetting can be used on the Call Ex [} 77] method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.2.3.4.6 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT a Quantiles : ARRAY[0.. GVL_PMA.c Max Quantiles - 1] OF LREAL; END_VAR Inputs Name Type Description a Quantiles ARRAY[0 - Indicates the quantile limit. It must be between GVL_PMA.c Max Quantiles-1] 0.0 and 1.0. For example, 0.2 corresponds to the OF LREAL 20% quantile. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 78 Version: 1.5 TF3650
## Page 79

PLC API 5.3 Function blocks, three-phase 5.3.1 FB_PMA_Source_3Ph The function block FB_PMA_Source_3Ph writes data from an external PLC data buffer into a multi-array buffer. It accumulates input data continuously, until the maximum size of the multi-array is reached. When the multi- array is completely filled, it is passed to a function block with the target analysis ID. The output buffers are provided for the function blocks whose ID is entered in the array of target IDs. They contain the current and voltage values. The requirements for the size of the output buffers may vary depending on the analysis function block used. They depends either on the FFT-length used or the buffer size. Syntax Definition: FUNCTION BLOCK FB_PMA_Source_3Ph VAR_INPUT n Own ID : UDINT; a Dest IDs : ARRAY[1.. GVL_PMA.c MA_Max Dest] OF UDINT; n Result Buffers : UDINT := 4; t Transfer Timeout : LTIME := LTIME#40US; st Init Pars : ST_PMA_Source_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Results : BOOL; n Cnt Results : ULINT; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 81] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. a Dest IDs ARRAY[1.. GVL_PMA.c MA_Max Identifies the function block instance with a Dest] OF UDINT unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. n Result Buffers UDINT Number of multi-array buffers that are initialized for the results. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray). st Init Pars ST_PMA_Source_Init Pars [} 126] Function block-specific structure with initialization parameters. The parameters must match the definition of the input and output buffers. TF3650 Version: 1.5 79
## Page 80

PLC API Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been provided. n Cnt Results ULINT Count value is incremented with new output data. Methods Name Description Call [} 80] The method is called in each cycle to write the values to the output buffer. Reset Data [} 80] This method can be used to reset the data currently in the buffer. Reset Analysis Chain Calling this method causes an automatic reset of all algorithms in the full analysis chain. [} 81] Init [} 81] Alternative to the function block initialization Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.3.1.1 Call The method is called in each cycle to write the values to the output buffer. The output buffer is sent as soon as it is filled. Syntax METHOD CALL : BOOL VAR_INPUT p Buffer_UL1 : POINTER TO LREAL; p Buffer_UL2 : POINTER TO LREAL; p Buffer_UL3 : POINTER TO LREAL; p Buffer_IL1 : POINTER TO LREAL; p Buffer_IL2 : POINTER TO LREAL; p Buffer_IL3 : POINTER TO LREAL; n Data In Size Per Ch : UDINT; n Option Pars : DWORD; END_VAR Inputs Name Type Description p Buffer_UL1 - UL3 POINTER TO LREAL Pointer to an array of voltage values. These can be added individually or as an oversampling array. p Buffer_IL1 - IL3 POINTER TO LREAL Pointer to an array of current values. These can be added individually or as an oversampling array. n Data In Size Per Ch UDINT Indicates the size of a single input buffer in bytes. 5.3.1.2 Reset Data This method can be used to reset the data currently in the buffer. 80 Version: 1.5 TF3650
## Page 81

PLC API Syntax METHOD Reset Data : BOOL VAR_INPUT ENC_VAR Return value Name Type Description Reset Data BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.1.3 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; a Dest IDs : ARRAY[1.. GVL_PMA.c MA_Max Dest] OF UDINT; n Result Buffers : UDINT := 4; st Init Pars : ST_PMA_Source_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. a Dest IDs ARRAY[1 - The result data is forwarded to the IDs of other GVL_PMA.c MA_Max Dest] OF function block instances specified here as an UDINT array. n Result Buffers UDINT Number of available multi-arrays. st Init Pars ST_PMA_Source_Init Pars [} 126] Function-block-specific structure with initialization parameters. The parameters must match the definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.1.4 Reset Analysis Chain Calling this method causes an automatic reset of all algorithms in the full analysis chain. Internally, a Reset Data() is carried out each time before accepting the new data set. TF3650 Version: 1.5 81
## Page 82

PLC API If the analysis chain is only to be active for a certain period, this method offers the option to reset all algorithms before the next execution. Errors can occur when calling an input method and cause interruptions in the time series collection. If the following algorithms in the analysis chain calculate spectra, then the Reset Analysis Chain() method can be called in the case of an error when calling an input method. Because it is not possible to calculate correct spectra on the basis of fragmented time series. Syntax METHOD Reset Analysis Chain : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset Analysis Chain BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2 Based on the signal period 5.3.2.1 FB_PMA_Frequency_Period_3Ph The function block FB_PMA_Frequency_Period_3Ph calculates the base frequency of the given input signal for all three phases. To do this, the signal is first filtered with a Butterworth low-pass filter. The zero crossings of the input signal are then determined from the filtered values, and the frequency is calculated from their difference. The results refer to one or more periods, depending on the configuration. The statistical results refer to the entire runtime or the time at which the statistical results were last reset. The input buffer is provided via the function block FB_PMA_Source_3Ph [} 79]. This can include one or more signal periods or individual fragments of oversampling arrays. Syntax Definition: FUNCTION BLOCK FB_PMA_Frequency_Period_3Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Frequency_Period_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; a Freq : ARRAY[0..2] OF LREAL; a Freq_Min : ARRAY[0..2] OF LREAL; a Freq_Max : ARRAY[0..2] OF LREAL; a Rocof : ARRAY[0..2] OF LREAL; e Rot Direction : E_PMA_Rotational Direction_3Ph; b Valid Statistics : BOOL; a Out Of Range : ARRAY[0..2] OF BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 85] method). They may only be assigned once. A change at runtime is not possible. 82 Version: 1.5 TF3650
## Page 83

PLC API Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Frequency_Period_Init P Function-block-specific structure with initialization parameters. The parameters must correlate to the ars [} 128] above definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. a Freq ARRAY[0..2] OF LREAL Frequency determined by two or more zero crossings. a Freq_Min ARRAY[0..2] OF LREAL Smallest value of f Freq that has occurred. Can be reset via b Reset Statistics of the Call method. a Freq_Max ARRAY[0..2] OF LREAL Largest value of f Freq that has occurred. Can be reset via b Reset Statistics of the Call method. a Rocof ARRAY[0..2] OF LREAL Rate of change of frequency (ROCOF) e Rot Direction E_PMA_Rotational Direction_3Ph Direction of rotation [} 138] b Valid Statistics BOOL TRUE if the Min and Max value calculation has been performed. These values are valid. a Out Of Range ARRAY[0..2] OF TRUE as soon as the input value or the frequency is not within the configured limits. Methods Name Description Call [} 84] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 85] Alternative to the function block initialization Pass Inputs [} 85] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 86] The method is called in order to reconfigure the function block during the runtime. Reset [} 86] The current calculations are reset with the method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Oversamples); c Frequency Init Pars : ST_PMA_Frequency_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Freq := 45.0, f Max Freq := 55.0, TF3650 Version: 1.5 83
## Page 84

PLC API n Periods := 1, n Filter Order := 2, f Cut Off := 70.0, e Input Select := E_PMA_Input Select. Voltage, f Min Input := 200.0); END_VAR VAR a Voltage AT%I* : ARRAY [0..2] OF ARRAY[1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY [0..2] OF ARRAY[1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_3Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Frequency : FB_PMA_Frequency_Period_3Ph := (n Own ID := 2, st Init Pars := c Frequency Init Pars); END_VAR // Call source fb Source. Call( ADR(a Voltage[0]), ADR(a Voltage[1]), ADR(a Voltage[2]), ADR(a Current[0]), ADR(a Current[1]), ADR(a Current[2]), SIZEOF(a Voltage[0]), 0); // Call algorithms fb Frequency. Call(FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.3.2.1.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT b Reset Statistics : BOOL; END_VAR Inputs Name Type Description b Reset Statistics BOOL TRUE resets the minimum and maximum values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 84 Version: 1.5 TF3650
## Page 85

PLC API 5.3.2.1.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Frequency_Period_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Frequency_Period_Init P Function block-specific structure with initialization parameters. The parameters must match the ars [} 128] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.1.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_3Ph [} 79] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. TF3650 Version: 1.5 85
## Page 86

PLC API 5.3.2.1.4 Reset The current calculations are reset with the method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.1.5 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Min Freq : LREAL; f Max Freq : LREAL; n Periods : UDINT; n Filter Order : UINT; f Cutoff : LREAL; e Input Select : E_PMA_Input Select; f Min Input : LREAL; END_VAR Inputs Name Type Description f Min Freq LREAL Minimum expected measuring frequency f Max Freq LREAL Maximum expected measuring frequency n Periods UDINT Number of periods that influence the calculation. (Period length = sample rate/frequency) n Filter Order UINT Indicates the order of the low-pass filter. The stability of the filter must be considered for the setting. Only values up to the tenth order are allowed. f Cutoff LREAL Specifies the limit frequency of the low-pass filter. e Input Select E_PMA_Input Select [} 140] Here you can configure whether the frequency of the voltage or the current should be calculated. f Min Input LREAL Minimum input value (RMS) over one period. This prevents the calculation of input values that are too small. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 86 Version: 1.5 TF3650
## Page 87

PLC API 5.3.2.2 FB_PMA_Basic Values_Period_3Ph The function block FB_PMA_Basic Values_Period_3Ph calculates analysis values for the signal sequence of current and voltage in a three-phase system. These include the mean value, the RMS value, the peak value, the rectified value, the crest factor and the form factor for the individual currents and voltages. In addition, the voltage values between the individual phases are calculated. The results refer to a configurable number of signal periods. The period duration refers to the frequency specified at the start of the period at the input of the Call [} 89] method. The statistical results refer to the entire runtime or the time at which the statistical results were last reset. The input buffer is provided via the function block FB_PMA_Source_3Ph [} 79]. This can include one or more signal periods or individual fragments of oversampling arrays. Syntax Definition: FUNCTION BLOCK FB_PMA_Basic Values_Period_3Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Basic Values_Period_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; a Mean Value_U : ARRAY[0..2] OF LREAL; a RMS_U : ARRAY[0..2] OF LREAL; a RMS_U_Min : ARRAY[0..2] OF LREAL; a RMS_U_Max : ARRAY[0..2] OF LREAL; a RMS_U_PP : ARRAY[0..2] OF LREAL a Peak Value_U : ARRAY[0..2] OF LREAL; a Peak Hold_U : ARRAY[0..2] OF LREAL; a Rectified Value_U : ARRAY[0..2] OF LREAL; a Crest Factor_U : ARRAY[0..2] OF LREAL; a Form Factor_U : ARRAY[0..2] OF LREAL; a Mean Value_I : ARRAY[0..2] OF LREAL, a RMS_I : ARRAY[0..2] OF LREAL, a RMS_I_Min : ARRAY[0..2] OF LREAL, a RMS_I_Max : ARRAY[0..2] OF LREAL, a Peak Value_I : ARRAY[0..2] OF LREAL, a Peak Hold_I : ARRAY[0..2] OF LREAL; a Rectified Value_I : ARRAY[0..2] OF LREAL; a Crest Factor_I : ARRAY[0..2] OF LREAL; a Form Factor_I : ARRAY[0..2] OF LREAL; b Valid Statistics : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 90] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Basic Values_Period_Init Function block-specific structure with initialization parameters. The parameters must correlate to the Pars [} 127] above definition of the input and output buffers. TF3650 Version: 1.5 87
## Page 88

PLC API Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. a Mean Value_U ARRAY[0..2] OF LREAL Mean voltage value over n periods a RMS_U ARRAY[0..2] OF LREAL RMS value of the voltage over n periods a RMS_U_Min ARRAY[0..2] OF LREAL Smallest value of f RMS_U that has occurred. Can be reset via b Reset Statistics of the Call method. a RMS_U_Max ARRAY[0..2] OF LREAL Largest value of f RMS_U that has occurred. Can be reset via b Reset Statistics of the Call method. a RMS_UPP ARRAY[0..2] OF LREAL RMS value of the voltage between two phases. Index 0: L1-L2, Index 1: L2-L3, Index 2: L3-L1 a Peak Value_U ARRAY[0..2] OF LREAL Peak voltage value over n periods a Peak Hold_U ARRAY[0..2] OF LREAL All-time peak voltage value over n periods. Can be reset via b Reset Statistics of the Call method. a Rectified Value_U ARRAY[0..2] OF LREAL Rectified voltage value over n periods a Crest Factor_U ARRAY[0..2] OF LREAL Crest factor of the voltage (peak/RMS value) a Form Factor_U ARRAY[0..2] OF LREAL Form factor of the voltage (RMS/rectified value) a Mean Value_I ARRAY[0..2] OF LREAL Mean value of the current over n periods a RMS_I ARRAY[0..2] OF LREAL RMS value of the current over n periods a RMS_I_Min ARRAY[0..2] OF LREAL Smallest value of f RMS_I that has occurred. Can be reset via b Reset Statistics of the Call method. a RMS_I_Max ARRAY[0..2] OF LREAL Largest value of f RMS_I that has occurred. Can be reset via b Reset Statistics of the Call method. a Peak Value_I ARRAY[0..2] OF LREAL Peak value of the current over n periods a Peak Hold_I ARRAY[0..2] OF LREAL All-time peak current value. Can be reset via b Reset Statistics of the Call method. a Rectified Value_I ARRAY[0..2] OF LREAL Rectified value of the current over n periods a Crest Factor_I ARRAY[0..2] OF LREAL Crest factor of current (peak/RMS value) a Form Factor_I ARRAY[0..2] OF LREAL Form factor of the current (RMS/rectified value) b Valid Statistics BOOL TRUE if the Min, Max and Hold value calculation has been performed. These values are valid. Methods Name Description Call [} 89] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 90] Alternative to the function block initialization Pass Inputs [} 90] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 91] The method is called in order to reconfigure the function block during the runtime. Reset [} 91] The current calculations are reset with the method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c Source Init Pars: ST_PMA_Source_Init Pars := ( 88 Version: 1.5 TF3650
## Page 89

PLC API n Buffer Length := c Oversamples); c Frequency Init Pars : ST_PMA_Frequency_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Freq := 45.0, f Max Freq := 55.0, n Periods := 1, n Filter Order := 2, f Cut Off := 70.0, e Input Select := E_PMA_Input Select. Voltage, f Min Input := 200.0); c Basic Values Init Pars : ST_PMA_Basic Values_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Input Current := 0.01, n Periods := 1); END_VAR VAR a Voltage AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_3Ph := (n Own ID := 1, a Dest IDs := [2,3], st Init Pars := c Source Init Pars); fb Frequency : FB_PMA_Frequency_Period_3Ph := (n Own ID := 2, st Init Pars := c Frequency Init Pars); fb Basic Values : FB_PMA_Basic Values_Period_3Ph := (n Own ID := 3, st Init Pars := c Basic Values Init Par s); END_VAR // Call source fb Source. Call( ADR(a Voltage[0]), ADR(a Voltage[1]), ADR(a Voltage[2]), ADR(a Current[0]), ADR(a Current[1]), ADR(a Current[2]), SIZEOF(a Voltage[0]), 0); // Call algorithms fb Frequency. Call(FALSE); fb Basic Values. Call(fb Frequency.a Freq[0], FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.3.2.2.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT f Freq : LREAL; b Reset Statistics : BOOL; END_VAR Inputs Name Type Description f Freq LREAL Current frequency of the input signal. Is used to determine the length of the period at the beginning of a period. The output of the function block FB_PMA_Frequency_Period_3Ph [} 82] can be used. TF3650 Version: 1.5 89
## Page 90

PLC API Name Type Description b Reset Statistics BOOL TRUE resets the minimum, maximum and hold values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.2.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Basic Values_Period_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Basic Values_Period_Init Function block-specific structure with initialization parameters. The parameters must match the Pars [} 127] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.2.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_3Ph [} 79] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. 90 Version: 1.5 TF3650
## Page 91

PLC API Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.2.4 Reset The current calculations are reset with the method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.2.5 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Min Input Current : LREAL; END_VAR Inputs Name Type Description f Min Input Current LREAL Minimum input value (RMS) of the current. This prevents the calculation of input values that are too small. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. TF3650 Version: 1.5 91
## Page 92

PLC API 5.3.2.3 FB_PMA_Power Values_Period_3Ph The function block FB_PMA_Power Values_Period_3Ph calculates the power values of the connected consumer in a three-phase grid. These include the fundamental components and the phase shift angle. For this purpose, only the first harmonics of the input signal are used for the calculation in addition to the signal sequence in the time domain. The advantage of these algorithms is the high dynamics of the calculations. The results refer to a configurable number of signal periods. The period duration refers to the frequency specified at the start of the period at the input of the Call [} 84] method. The statistical results refer to the entire runtime or the time at which the statistical results were last reset. Alternatively, the function block FB_PMA_Power Values_3Ph [} 107] can be used. This uses the individual harmonics internally to calculate the power values. The input buffer is provided via the function block FB_PMA_Source_3Ph [} 79]. This can include one or more signal periods or individual fragments of oversampling values. Syntax Definition: FUNCTION BLOCK FB_PMA_Power Values_Period_3Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Power Values_Period_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; a Apparent Power : ARRAY[0..2] OF LREAL; a Apparent Power_1 : ARRAY[0..2] OF LREAL; a Apparent Power_1_Min : ARRAY[0..2] OF LREAL; a Apparent Power_1_Max : ARRAY[0..2] OF LREAL; a Active Power : ARRAY[0..2] OF LREAL; a Active Power_Min : ARRAY[0..2] OF LREAL; a Active Power_Max : ARRAY[0..2] OF LREAL; a Reactive Power_d : ARRAY[0..2] OF LREAL; a Reactive Power_1 : ARRAY[0..2] OF LREAL; a Reactive Power_1_Min : ARRAY[0..2] OF LREAL; a Reactive Power_1_Max : ARRAY[0..2] OF LREAL; a Total Reactive Power : ARRAY[0..2] OF LREAL; a Phi : ARRAY[0..2] OF LREAL; a Cos Phi : ARRAY[0..2] OF LREAL; a Power Factor : ARRAY[0..2] OF LREAL; f Power Quality Factor : LREAL; f Sum Apparent Power : LREAL; f Sum Active Power : LREAL; f Sum Total Reactive Power : LREAL; f Sum Reactive Power_1 : LREAL; b Valid Statistics : BOOL; END_VAR VAR_OUTPUT PERSISTENT a Energy_Pos : ARRAY[0..2] OF ST_PMA_Energy; a Energy_Neg : ARRAY[0..2] OF ST_PMA_Energy; a Energy_Res : ARRAY[0..2] OF ST_PMA_Energy; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 95] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. 92 Version: 1.5 TF3650
## Page 93

PLC API Name Type Description t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Power Values_Period_In Function block-specific structure with initialization parameters. The parameters must correlate to the it Pars [} 129] above definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. a Apparent Power ARRAY[0..2] OF LREAL Total apparent power a Apparent Power_1 ARRAY[0..2] OF LREAL Fundamental apparent power a Apparent Power_1_Min ARRAY[0..2] OF LREAL Smallest value of f Apparent Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. a Apparent Power_1_Ma ARRAY[0..2] OF LREAL Largest value of f Apparent Power_1 that has x occurred. Can be reset via b Reset Statistics of the Call method. a Active Power ARRAY[0..2] OF LREAL Active power a Active Power_Min ARRAY[0..2] OF LREAL Smallest value of f Active Power that has occurred. Can be reset via b Reset Statistics of the Call method. a Active Power_Max ARRAY[0..2] OF LREAL Largest value of f Active Power that has occurred. Can be reset via b Reset Statistics of the Call method. a Reactive Power_d ARRAY[0..2] OF LREAL Distortion reactive power a Reactive Power_1 ARRAY[0..2] OF LREAL Fundamental shift reactive power a Reactive Power_1_Min ARRAY[0..2] OF LREAL Smallest value of f Reactive Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. a Reactive Power_1_Max ARRAY[0..2] OF LREAL Largest value of f Reactive Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. a Total Reactive Power ARRAY[0..2] OF LREAL Total reactive power a Phi ARRAY[0..2] OF LREAL Phase shift angle a Cos Phi ARRAY[0..2] OF LREAL Cos Phi (active power/fundamental apparent power) a Power Factor ARRAY[0..2] OF LREAL Power factor (active power/total apparent power) f Power Quality Factor LREAL Power Quality Factor. Represents the quality of the power supply simplified in a value range between 0 and 1. The frequency, the RMS values of the voltages, the THD of the voltages and optionally the voltage unbalance are included. f Sum Apparent Power LREAL Sum of the total apparent power of all phases. f Sum Active Power LREAL Sum of the active power of all phases. f Sum Total Reactive Pow LREAL Sum of the total reactive power of all phases. er TF3650 Version: 1.5 93
## Page 94

PLC API Name Type Description f Sum Reactive Power_1 LREAL Sum of the values of the fundamental shift reactive power of all phases. b Valid Statistics BOOL TRUE if the Min and Max value calculation has been performed. These values are valid. a Energy_Pos ARRAY[0..2] OF Energy in positive direction. The output is saved ST_PMA_Energy [} 141] persistently and can be reset via b Reset Energy Calc of the Call method. a Energy_Neg ARRAY[0..2] OF Energy in negative direction. The output is saved ST_PMA_Energy [} 141] persistently and can be reset via b Reset Energy Calc of the Call method. a Energy_Res ARRAY[0..2] OF Resulting energy. The output is saved ST_PMA_Energy [} 141] persistently and can be reset via b Reset Energy Calc of the Call method. Methods Name Description Call [} 95] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 95] Alternative to the function block initialization Pass Inputs [} 96] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 97] The method is called in order to reconfigure the function block during the runtime. Reset [} 96] The current calculations are reset with the method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Oversamples); c Frequency Init Pars : ST_PMA_Frequency_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Freq := 45.0, f Max Freq := 55.0, n Periods := 1, n Filter Order := 2, f Cut Off := 70.0, e Input Select := E_PMA_Input Select. Voltage, f Min Input := 200.0); c Power Values Init Pars : ST_PMA_Power Values_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Input Current := 0.01, n Periods := 1); END_VAR VAR a Voltage AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_3Ph := (n Own ID := 1, a Dest IDs := [2,3], st Init Pars := c Source Init Pars); fb Frequency : FB_PMA_Frequency_Period_3Ph := (n Own ID := 2, st Init Pars := c Frequency Init Pars); fb Power Values : FB_PMA_Power Values_Period_3Ph := (n Own ID := 3, st Init Pars := c Power Values Init Par s); END_VAR // Call source fb Source. Call( ADR(a Voltage[0]), ADR(a Voltage[1]), ADR(a Voltage[2]), ADR(a Current[0]), ADR(a Current[1]), ADR(a Current[2]), SIZEOF(a Voltage[0]), 0); 94 Version: 1.5 TF3650
## Page 95

PLC API // Call algorithms fb Frequency. Call(FALSE); fb Power Values. Call(fb Frequency.a Freq[0], FALSE, FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.3.2.3.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT f Freq : LREAL; b Reset Energy Calc : LREAL; b Reset Statistics : BOOL; END_VAR Inputs Name Type Description f Freq LREAL Current frequency of the input signal. Is used to determine the length of the period at the beginning of a period. The output of the function block FB_PMA_Frequency_Period_3Ph [} 82] can be used. b Reset Energy Calc LREAL TRUE resets the calculated values of the energy measurement. b Reset Statistics BOOL TRUE resets the minimum and maximum values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.3.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. TF3650 Version: 1.5 95
## Page 96

PLC API Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT st Init Pars : ST_PMA_Power Values_Period_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Power Values_Period_In Function block-specific structure with initialization parameters. The parameters must match the it Pars [} 129] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.3.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_3Ph [} 79] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.3.4 Reset The current calculations are reset with the method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR 96 Version: 1.5 TF3650
## Page 97

PLC API Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.3.5 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Min Input Current : LREAL; END_VAR Inputs Name Type Description f Min Input Current LREAL Minimum input value (RMS) of the current. This prevents the calculation of input values that are too small. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.4 FB_PMA_Harmonics_Period_3Ph The function block FB_PMA_Harmonics_Period_3Ph calculates the current and voltage harmonics. In addition, the THD of the input values is calculated from the harmonics. In contrast to the function block FB_PMA_Harmonics_3Ph [} 102], the results refer to a configurable number of signal periods. The period value refers to the frequency specified at the start of the period at the input of the Call [} 84] method. The statistical results refer to the entire runtime or the time at which the statistical results were last reset. The input buffer is provided via the function block FB_PMA_Source_3Ph [} 79]. This can include one or more signal periods or individual fragments of oversampling values. Syntax Definition: FUNCTION BLOCK FB_PMA_Power Values_Period_3Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Harmonics_Period_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; a THD_U : ARRAY[0..2] OF LREAL; a THD_U_Min : ARRAY[0..2] OF LREAL; a THD_U_Max : ARRAY[0..2] OF LREAL; TF3650 Version: 1.5 97
## Page 98

PLC API a THD_I : ARRAY[0..2] OF LREAL; a THD_I_Min : ARRAY[0..2] OF LREAL; a THD_I_Max : ARRAY[0..2] OF LREAL; b Valid Statistics : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 100] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Harmonics_Period_Init Function-block-specific structure with initialization parameters. The parameters must correlate to the Pars [} 130] above definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. a THD_U ARRAY[0..2] OF LREAL THD of the voltage. The output is in percent. a THD_U_Min ARRAY[0..2] OF LREAL Smallest value of a THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. a THD_U_Max ARRAY[0..2] OF LREAL Largest value of a THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. a THD_I ARRAY[0..2] OF LREAL THD of the current. The output is in percent. a THD_U_Min ARRAY[0..2] OF LREAL Smallest value of a THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. a THD_U_Max ARRAY[0..2] OF LREAL Largest value of a THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. b Valid Statistics BOOL TRUE if the Min and Max value calculation has been performed. These values are valid. Methods Name Description Call [} 99] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 100] Alternative to the function block initialization Pass Inputs [} 101] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. 98 Version: 1.5 TF3650
## Page 99

PLC API Name Description Reset [} 101] The current calculations are reset with the method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Oversamples); c Frequency Init Pars : ST_PMA_Frequency_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Freq := 45.0, f Max Freq := 55.0, n Periods := 1, n Filter Order := 2, f Cut Off := 70.0, e Input Select := E_PMA_Input Select. Voltage, f Min Input := 200.0); c Power Values Init Pars : ST_PMA_Power Values_Period_Init Pars := ( n Buffer Length := c Oversamples, f Sample Rate := c Oversamples * 1000, f Min Input Current := 0.01, n Periods := 1); END_VAR VAR a Voltage AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_3Ph := (n Own ID := 1, a Dest IDs := [2,3], st Init Pars := c Source Init Pars); fb Frequency : FB_PMA_Frequency_Period_3Ph := (n Own ID := 2, st Init Pars := c Frequency Init Pars); fb Power Values : FB_PMA_Power Values_Period_3Ph := (n Own ID := 3, st Init Pars := c Power Values Init Par s); END_VAR // Call source fb Source. Call( ADR(a Voltage[0]), ADR(a Voltage[1]), ADR(a Voltage[2]), ADR(a Current[0]), ADR(a Current[1]), ADR(a Current[2]), SIZEOF(a Voltage[0]), 0); // Call algorithms fb Frequency. Call(FALSE); fb Power Values. Call(fb Frequency.a Freq[0], FALSE, FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.3.2.4.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT f Freq : LREAL; p Harmonics RMS_UL1 : POINTER TO LREAL; p Harmonics RMS_UL2 : POINTER TO LREAL; p Harmonics RMS_UL3 : POINTER TO LREAL; p Harmonics RMS_IL1 : POINTER TO LREAL; p Harmonics RMS_IL2 : POINTER TO LREAL; p Harmonics RMS_IL3 : POINTER TO LREAL; TF3650 Version: 1.5 99
## Page 100

PLC API n Harmonics RMSSize : UDINT; b Reset Statistics : BOOL; END_VAR Inputs Name Type Description f Freq LREAL Current frequency of the input signal. Is used to determine the length of the period at the beginning of a period. The output of the function block FB_PMA_Frequency_Period_3Ph [} 82] can be used. p Harmonics RMS_UL1 .. POINTER TO LREAL Pointer to an array of type LREAL with UL3 dimension: number of harmonics. If the individual harmonics are not to be output, the input can be set to 0. p Harmonics RMS_IL1 .. POINTER TO LREAL Pointer to an array of type LREAL with IL3 dimension: number of harmonics. If the individual harmonics are not to be output, the input can be set to 0. n Harmonics RMSSize UDINT Indicates the size of an output array for the harmonics. b Reset Statistics BOOL TRUE resets the minimum and maximum values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.4.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT st Init Pars : ST_PMA_Harmonics_Period_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. 100 Version: 1.5 TF3650
## Page 101

PLC API Name Type Description st Init Pars ST_PMA_Harmonics_Period_Init Function-block-specific structure with initialization parameters. The parameters must match the Pars [} 130] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.4.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_3Ph [} 79] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.2.4.4 Reset The current calculations are reset with the method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. TF3650 Version: 1.5 101
## Page 102

PLC API 5.3.3 Based on the frequency range 5.3.3.1 FB_PMA_Harmonics_3Ph The function block FB_PMA_Harmonics_3Ph calculates the RMS bands of the individual current and voltage harmonics in a three-phase system. In addition, the calculated RMS bands are used to calculate the THD of the input variables. The input buffer is provided via the function block FB_PMA_Source_3Ph [} 79]. The size of the input buffer is half the window length. By way of example, possible FFT and window lengths are shown in the following table: FFT length Window length Buffer length 512 29 400 200 1024 210 800 400 2048 211 1600 800 4096 212 3200 1600 8192 213 6400 3200 16384 214 12800 6400 Memory properties Since the Welch method is used, in each case the current input buffer together with the last transferred buffer is used for the calculation. The frequency analysis takes step changes in the time series into account. In order to achieve a correct result, the last two input buffers should therefore be consecutive without step changes. Syntax Definition: FUCNTION BLOCK FB_PMA_Harmonics_3Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Harmonics_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; a THD_U : ARRAY[0..2] OF LREAL; a THD_U_Min : ARRAY[0..2] OF LREAL; a THD_U_Max : ARRAY[0..2] OF LREAL; a THD_I : ARRAY[0..2] OF LREAL; a THD_I_Min : ARRAY[0..2] OF LREAL; a THD_I_Max : ARRAY[0..2] OF LREAL; b Valid Statistics : BOOL; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 105] method). They may only be assigned once. A change at runtime is not possible. Name Type Description t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. 102 Version: 1.5 TF3650
## Page 103

PLC API Name Type Description st Init Pars ST_PMA_Harmonics_Init Pars Function-block-specific structure with initialization parameters. The parameters must match the [} 130] definition of the input and output buffers. n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. a THD_U ARRAY[0..2] OF LREAL THD of the voltage. The output is in percent. a THD_U_Min ARRAY[0..2] OF LREAL Smallest value of a THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. a THD_U_Max ARRAY[0..2] OF LREAL Largest value of a THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. a THD_I ARRAY[0..2] OF LREAL THD of the current. The output is in percent. a THD_U_Min ARRAY[0..2] OF LREAL Smallest value of a THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. a THD_U_Max ARRAY[0..2] OF LREAL Largest value of a THD_U that has occurred. Can be reset via b Reset Statistics of the Call method. b Valid Statistics BOOL TRUE if the Min, Max and Hold value calculation has been performed. These values are valid. Methods Name Description Call [} 104] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 105] Alternative to the function block initialization Pass Inputs [} 106] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 106] The method is called in order to reconfigure the function block during the runtime. Reset [} 107] This method deletes all the data sets already added. In addition, the calculated output values are reset. Sample VAR CONSTANT c Oversamples : UDINT := 10; c FFT_Length : UDINT := 4096; c Window Length : UDINT := 3200; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Window Length/2); c Harmonics Init Pars : ST_PMA_Harmonics_Init Pars := ( n FFT_Length := c FFT_Length, n Window Length := c Window Length, f Sample Rate := c Oversamples * 1000, f Base Freq := 50.0, TF3650 Version: 1.5 103
## Page 104

PLC API n Num Bands := 40, f Bandwidth := 20.0, e Window Type := E_PMA_Window Type. Hann Window, b Transform To Decibel := FALSE, f Decibel Threshold := GVL_PMA.c Min Arg Log10, b Transform To Percent := TRUE); END_VAR VAR a Voltage AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_3Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Harmonics : FB_PMA_Harmonics_3Ph := (n Own ID := 2, st Init Pars := c Harmonics Init Pars); a Harmonics Voltage : ARRAY[0..2] OF ARRAY[1..40] OF LREAL; a Harmonics Current : ARRAY[0..2] OF ARRAY[1..40] OF LREAL; END_VAR // Call source fb Source. Call( ADR(a Voltage[0]), ADR(a Voltage[1]), ADR(a Voltage[2]), ADR(a Current[0]), ADR(a Current[1]), ADR(a Current[2]), SIZEOF(a Voltage[0]), 0); // Call algorithm fb Harmonics. Call( ADR(a Harmonics Voltage[0]), ADR(a Harmonics Voltage[1]), ADR(a Harmonics Voltage[2]), ADR(a Harmonics Current[0]), ADR(a Harmonics Current[1]), ADR(a Harmonics Current[2]), SIZEOF(a Harmonics Voltage[0]), FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.3.3.1.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT p Harmonics RMS_UL1 : POINTER TO LREAL; p Harmonics RMS_UL2 : POINTER TO LREAL; p Harmonics RMS_UL3 : POINTER TO LREAL; p Harmonics RMS_IL1 : POINTER TO LREAL; p Harmonics RMS_IL2 : POINTER TO LREAL; p Harmonics RMS_IL3 : POINTER TO LREAL; n Harmonics RMSSize : UDINT; b Reset Statistics : BOOL; END_VAR 104 Version: 1.5 TF3650
## Page 105

PLC API Inputs Name Type Description p Harmonics RMS_UL1 .. POINTER TO LREAL Pointer to an array of type LREAL with the UL3 dimension: Number of harmonics. If the individual harmonics are not to be output, the input can be set to 0. p Harmonics RMS_IL1 .. POINTER TO LREAL Pointer to an array of type LREAL with the IL3 dimension: Number of harmonics. If the individual harmonics are not to be output, the input can be set to 0. n Harmonics RMSSize UDINT Indicates the size of an output array for the harmonics. b Reset Statistics BOOL TRUE resets the minimum, maximum and hold values of the outputs. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.1.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Harmonics_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Harmonics_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 130] definition of the input and output buffers. TF3650 Version: 1.5 105
## Page 106

PLC API Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.1.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_3Ph [} 79] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.1.4 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Base Freq : LREAL; f Bandwidth : LREAL; END_VAR Inputs Name Type Description f Base Freq LREAL Frequency of the first harmonic. f Bandwidth LREAL Total bandwidth of each RMS band. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 106 Version: 1.5 TF3650
## Page 107

PLC API 5.3.3.1.5 Reset This method deletes all the data sets already added. In addition, the calculated output values are reset. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.2 FB_PMA_Power Values_3Ph The function block FB_PMA_Power Values_3Ph calculates the power values of the connected consumer in a three-phase grid. These include the fundamental components and the phase shift angle. Internally, the individual harmonics and their phase angle are determined for the calculations. Alternatively, the function block FB_PMA_Power Values_Period_3Ph [} 92] can be used for the calculation. It uses simpler calculation methods for enhanced dynamics. The input buffer is provided via the function block FB_PMA_Source_3Ph [} 79]. The size of the input buffer is half the window length. By way of example, possible FFT and window lengths are shown in the following table: FFT length Window length Buffer length 512 29 400 200 1024 210 800 400 2048 211 1600 800 4096 212 3200 1600 8192 213 6400 3200 16384 214 12800 6400 Memory properties Since the Welch method is used, in each case the current input buffer together with the last transferred buffer is used for the calculation. The frequency analysis takes step changes in the time series into account. In order to achieve a correct result, the last two input buffers should therefore be consecutive without step changes. Syntax Definition: FUNCTION BLOCK FB_PMA_Power Values_3Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Power Values_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; a Apparent Power : ARRAY[0..2] OF LREAL; TF3650 Version: 1.5 107
## Page 108

PLC API a Apparent Power_1 : ARRAY[0..2] OF LREAL; a Apparent Power_1_Min : ARRAY[0..2] OF LREAL; a Apparent Power_1_Max : ARRAY[0..2] OF LREAL; a Active Power : ARRAY[0..2] OF LREAL; a Active Power_Min : ARRAY[0..2] OF LREAL; a Active Power_Max : ARRAY[0..2] OF LREAL; a Reactive Power_d : ARRAY[0..2] OF LREAL; a Reactive Power_1 : ARRAY[0..2] OF LREAL; a Reactive Power_1_Min : ARRAY[0..2] OF LREAL; a Reactive Power_1_Max : ARRAY[0..2] OF LREAL; a Total Reactive Power : ARRAY[0..2] OF LREAL; a Phi : ARRAY[0..2] OF LREAL; a Cos Phi : ARRAY[0..2] OF LREAL; a Power Factor : ARRAY[0..2] OF LREAL; f Sum Apparent Power : LREAL; f Sum Active Power : LREAL; f Sum Total Reactive Power : LREAL; f Sum Reactive Power_1 : LREAL; b Valid Statistics : BOOL; END_VAR VAR_OUTPUT PERSISTENT a Energy_Pos : ARRAY[0..2] OF ST_PMA_Energy; a Energy_Neg : ARRAY[0..2] OF ST_PMA_Energy; a Energy_Res : ARRAY[0..2] OF ST_PMA_Energy; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 111] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Power Values_Init Pars Function-block-specific structure with initialization parameters. The parameters must match the [} 132] definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. a Apparent Power ARRAY[0..2] OF LREAL Total apparent power a Apparent Power_1 ARRAY[0..2] OF LREAL Fundamental apparent power a Apparent Power_1_Min ARRAY[0..2] OF LREAL Smallest value of f Apparent Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. a Apparent Power_1_Ma ARRAY[0..2] OF LREAL Largest value of f Apparent Power_1 that has x occurred. Can be reset via b Reset Statistics of the Call method. a Active Power ARRAY[0..2] OF LREAL Active power 108 Version: 1.5 TF3650
## Page 109

PLC API Name Type Description a Active Power_Min ARRAY[0..2] OF LREAL Smallest value of f Active Power that has occurred. Can be reset via b Reset Statistics of the Call method. a Active Power_Max ARRAY[0..2] OF LREAL Largest value of f Active Power that has occurred. Can be reset via b Reset Statistics of the Call method. a Reactive Power_d ARRAY[0..2] OF LREAL Distortion reactive power a Reactive Power_1 ARRAY[0..2] OF LREAL Fundamental shift reactive power a Reactive Power_1_Min ARRAY[0..2] OF LREAL Smallest value of f Reactive Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. a Reactive Power_1_Max ARRAY[0..2] OF LREAL Largest value of f Reactive Power_1 that has occurred. Can be reset via b Reset Statistics of the Call method. a Total Reactive Power ARRAY[0..2] OF LREAL Total reactive power a Phi ARRAY[0..2] OF LREAL Phase shift angle a Cos Phi ARRAY[0..2] OF LREAL Cos Phi (active power/fundamental apparent power) a Power Factor ARRAY[0..2] OF LREAL Power factor (active power/total apparent power) f Sum Apparent Power LREAL Sum of the total apparent power of all phases. f Sum Active Power LREAL Sum of the active power of all phases. f Sum Total Reactive Pow LREAL Sum of the total reactive power of all phases. er f Sum Reactive Power_1 LREAL Sum of the values of the fundamental shift reactive power of all phases. b Valid Statistics BOOL TRUE if the Min and Max value calculation has been performed. These values are valid. a Energy_Pos ARRAY[0..2] OF Energy in positive direction. The output is saved ST_PMA_Energy [} 141] persistently and can be reset via b Reset Energy Calc of the Call method. a Energy_Neg ARRAY[0..2] OF Energy in negative direction. The output is saved ST_PMA_Energy [} 141] persistently and can be reset via b Reset Energy Calc of the Call method. a Energy_Res ARRAY[0..2] OF Resulting energy. The output is saved ST_PMA_Energy [} 141] persistently and can be reset via b Reset Energy Calc of the Call method. Methods Name Description Call [} 110] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 111] Alternative to the function block initialization Pass Inputs [} 111] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 112] The method is called in order to reconfigure the function block during the runtime. Reset [} 112] This method deletes all the data sets already added. In addition, the calculated output values are reset. Sample VAR CONSTANT c Oversamples : UDINT := 10; c FFT_Length : UDINT := 4096; c Window Length : UDINT := 3200; TF3650 Version: 1.5 109
## Page 110

PLC API c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Window Length/2); c Power Values Init Pars : ST_PMA_Power Values_Init Pars := ( n FFT_Length := c FFT_Length, n Window Length := c Window Length, f Sample Rate := c Oversamples * 1000, f Base Freq := 50.0, n Num Bands := 40, f Bandwidth := 20.0, e Window Type := E_PMA_Window Type. Hann Window, f Time Lag Current Transformer := 0.0, f Min Input Current := 0.01); END_VAR VAR a Voltage AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_3Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Power Values : FB_PMA_Power Values_3Ph := (n Own ID := 2, st Init Pars := c Power Values Init Pars); END_VAR // Call source fb Source. Call( ADR(a Voltage[0]), ADR(a Voltage[1]), ADR(a Voltage[2]), ADR(a Current[0]), ADR(a Current[1]), ADR(a Current[2]), SIZEOF(a Voltage[0]), 0); // Call algorithm fb Power Values. Call(FALSE, FALSE); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.3.3.2.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT b Reset Energy Calc : BOOL; b Reset Statistics : BOOL; END_VAR Inputs Name Type Description b Reset Energy Calc BOOL TRUE resets the calculated values of the energy measurement. b Reset Statistics BOOL TRUE resets the minimum and maximum values of the outputs. 110 Version: 1.5 TF3650
## Page 111

PLC API Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.2.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Power Values_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Power Values_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 132] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.2.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_3Ph [} 79] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR TF3650 Version: 1.5 111
## Page 112

PLC API Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.2.4 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT f Base Freq : LREAL; f Bandwidth : LREAL; f Min Input Current : LREAL; END_VAR Inputs Name Type Description f Base Freq LREAL Frequency of the first harmonic. f Bandwidth LREAL Total bandwidth of each RMS band. f Min Input Current LREAL Minimum input value (RMS) of the current. This prevents the calculation of input values that are too small. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.2.5 Reset This method deletes all the data sets already added. In addition, the calculated output values are reset. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 112 Version: 1.5 TF3650
## Page 113

PLC API 5.3.3.3 FB_PMA_Spectrum_3Ph The function block FB_PMA_Spectrum_3Ph calculates the magnitude spectra of the current and voltage values. These are suitable for analyzing the input signals in the frequency range. The input buffer is provided via the function block FB_PMA_Source_3Ph [} 79]. The size of the input buffer is half the window length. By way of example, possible FFT and window lengths are shown in the following table: FFT length Window length Buffer length 512 29 400 200 1024 210 800 400 2048 211 1600 800 4096 212 3200 1600 8192 213 6400 3200 16384 214 12800 6400 Memory properties Since the Welch method is used, in each case the current input buffer together with the last transferred buffer is used for the calculation. The frequency analysis takes step changes in the time series into account. In order to achieve a correct result, the last two input buffers should therefore be consecutive without step changes. Syntax Definition: FUNCTION BLOCK FB_PMA_Spectrum_3Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Spectrum_Init Pars; VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; END_VAR Inputs The input parameters of this function block represent initialization parameters and must be assigned when declaring the function block instance (alternative: Init [} 115] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Spectrum_Init Pars Function-block-specific structure with initialization parameters. The parameters must match the [} 133] definition of the input and output buffers. TF3650 Version: 1.5 113
## Page 114

PLC API Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. Methods Name Description Call [} 115] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Init [} 115] Alternative to the function block initialization Pass Inputs [} 116] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reset [} 116] This method deletes all the data sets already added. Sample VAR CONSTANT c Oversamples : UDINT := 10; c FFT_Length : UDINT := 4096; c Window Length : UDINT := 3200; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Window Length/2); c Spectrum Init Pars : ST_PMA_Spectrum_Init Pars := ( n FFT_Length := c FFT_Length, n Window Length := c Window Length, f Sample Rate := c Oversamples * 1000, e Scaling Type := E_PMA_Scaling Type. Peak Amplitude, e Window Type := E_PMA_Window Type. Hann Window, b Transform To Decibel := FALSE, f Decibel Threshold := GVL_PMA.c Min Arg Log10); END_VAR VAR a Voltage AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_3Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Spectrum : FB_PMA_Spectrum_3Ph := (n Own ID := 2, st Init Pars := c Spectrum Init Pars); a Spectrum Voltage : ARRAY[0..2] OF ARRAY[1..c FFT_Length/2 + 1] OF LREAL; a Spectrum Current : ARRAY[0..2] OF ARRAY[1..c FFT_Length/2 + 1] OF LREAL; END_VAR // Call source fb Source. Call( ADR(a Voltage[0]), ADR(a Voltage[1]), ADR(a Voltage[2]), ADR(a Current[0]), ADR(a Current[1]), ADR(a Current[2]), SIZEOF(a Voltage[0]), 0); // Call algorithm fb Spectrum. Call( ADR(a Spectrum Voltage[0]), ADR(a Spectrum Voltage[1]), ADR(a Spectrum Voltage[2]), ADR(a Spectrum Current[0]), ADR(a Spectrum Current[1]), ADR(a Spectrum Current[2]), SIZEOF(a Spectrum Voltage[0])); 114 Version: 1.5 TF3650
## Page 115

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.3.3.3.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. Syntax METHOD Call : BOOL VAR_INPUT p Magnitude Spectrum_UL1 : POINTER TO LREAL; p Magnitude Spectrum_UL2 : POINTER TO LREAL; p Magnitude Spectrum_UL3 : POINTER TO LREAL; p Magnitude Spectrum_IL1 : POINTER TO LREAL; p Magnitude Spectrum_IL2 : POINTER TO LREAL; p Magnitude Spectrum_IL3 : POINTER TO LREAL; n Magnitude Spectrum Size : UDINT; END_VAR Inputs Name Type Description p Magnitude Spectrum_U POINTER TO LREAL Pointer to an array of type LREAL with the L1 .. UL3 dimension: FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. p Magnitude Spectrum_I POINTER TO LREAL Pointer to an array of type LREAL with the L1 .. IL3 dimension: FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. n Magnitude Spectrum Si UDINT Indicates the size of the output array of a ze spectrum. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.3.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. TF3650 Version: 1.5 115
## Page 116

PLC API Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Spectrum_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Spectrum_Init Pars Function block-specific structure with initialization parameters. The parameters must match the [} 133] definition of the input and output buffers. Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.3.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_3Ph [} 79] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.3.4 Reset This method deletes all the data sets already added. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR 116 Version: 1.5 TF3650
## Page 117

PLC API Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.4 FB_PMA_Spectrum_Quantiles_3Ph The function block FB_PMA_Spectrum_Quantiles_3Ph calculates the magnitude spectra of the current and voltage values like the function block FB_PMA_Spectrum_3Ph [} 113]. In addition, p-quantiles of the spectrum distribution can be calculated. The quantiles and their number can be configured individually. The input buffer is provided via the function block FB_PMA_Source_3Ph [} 79]. The size of the input buffer is half the window length. By way of example, possible FFT and window lengths are shown in the following table: FFT-length Window length Buffer length 512 29 400 200 1024 210 800 400 2048 211 1600 800 4096 212 3200 1600 8192 213 6400 3200 16384 214 12800 6400 Memory properties The function block takes into account all input values since the instantiation. If the Reset [} 122] method has been called since the start, all input values since its last call will be taken into account. Syntax Definition: FUNCTION BLOCK FB_PMA_Spectrum_Quantiles_3Ph VAR_INPUT n Own ID : UDINT; t Transfer Timeout : LTIME := LTIME#500US; st Init Pars : ST_PMA_Spectrum_Quantiles_Init Pars; END_VAR VAR_OUTPUT b Error : BOOL; ip Result Message : I_Tc Message; b New Result : BOOL; n Cnt Results : ULINT; END_VAR Inputs The input parameters of this function block represent initialization parameters and have to be assigned during the declaration of the function block instance (alternatively: Init [} 120] method). They may only be assigned once. A change at runtime is not possible. Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. TF3650 Version: 1.5 117
## Page 118

PLC API Name Type Description t Transfer Timeout LTIME Setting of the synchronous timeout for internal multi-array forwardings. See Parallel Processing in Transfer Tray. st Init Pars ST_PMA_Spectrum_Quantiles_Ini Function block-specific structure with initialization parameters. The parameters must match the t Pars [} 134] definition of the input and output buffers. Outputs Name Type Description b Error BOOL TRUE if an error occurs. ip Result Message I_Tc Message The interface offers detailed information about the return value. b New Result BOOL TRUE once new results have been calculated. n Cnt Results ULINT Count value is incremented with new output data. Methods Name Description Call [} 119] The method is called in each cycle to execute the calculations from the input buffer when new data is present. Call Ex [} 121] To minimize CPU usage, it may be necessary to use the Call Ex method. In contrast to the Call method, the quantiles are not calculated after each spectrum calculation, but only after a configurable number of calculations. Init [} 120] Alternative to the function block initialization. Pass Inputs [} 121] As an alternative to the Call method, the method can be called in each cycle if no calculation is to take place. The incoming input buffer is then forwarded accordingly. Reconfigure [} 123] The method is called in order to reconfigure the function block during the runtime. Reset [} 122] This method deletes all the data sets already added. Alternatively, automatic resetting can be used on the Call Ex method. Sample VAR CONSTANT c Oversamples : UDINT := 10; c FFT_Length : UDINT := 4096; c Window Length : UDINT := 3200; c Source Init Pars: ST_PMA_Source_Init Pars := ( n Buffer Length := c Window Length/2); c Spectrum Quantiles Init Pars : ST_PMA_Spectrum_Quantiles_Init Pars := ( n FFT_Length := c FFT_Length, n Window Length := c Window Length, f Sample Rate := c Oversamples * 1000, e Scaling Type := E_PMA_Scaling Type. Peak Amplitude, e Window Type := E_PMA_Window Type. Hann Window, b Transform To Decibel := FALSE, f Decibel Threshold := GVL_PMA.c Min Arg Log10, f Min Binned Voltage := 0.0, f Max Binned Voltage := 300, f Min Binned Current := 0.0, f Max Binned Current := 2, n Bins := 10, n Num Quantiles := 2, a Quantiles := [0.5, 0.9]); END_VAR VAR a Voltage AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; a Current AT%I* : ARRAY[0..2] OF ARRAY [1..c Oversamples] OF LREAL; fb Source : FB_PMA_Source_3Ph := (n Own ID := 1, a Dest IDs := [2], st Init Pars := c Source Init Pars); fb Spectrum Quantiles : FB_PMA_Spectrum_Quantiles_3Ph := (n Own ID := 2, st Init Pars := c Spectrum Quan tiles Init Pars); a Spectrum Voltage : ARRAY[0..2] OF ARRAY[1..c FFT_Length/2 + 1] OF LREAL; 118 Version: 1.5 TF3650
## Page 119

PLC API a Spectrum Current : ARRAY[0..2] OF ARRAY[1..c FFT_Length/2 + 1] OF LREAL; a Spectrum Quantiles Voltage : ARRAY[0..2] OF ARRAY[1..c FFT_Length/2 + 1, 1..2] OF LREAL; a Spectrum Quantiles Current : ARRAY[0..2] OF ARRAY[1..c FFT_Length/2 + 1, 1..2] OF LREAL; b New Result_Spectrum : BOOL; b New Result_Quantiles : BOOL; END_VAR // Call source fb Source. Call( ADR(a Voltage[0]), ADR(a Voltage[1]), ADR(a Voltage[2]), ADR(a Current[0]), ADR(a Current[1]), ADR(a Current[2]), SIZEOF(a Voltage[0]), 0); // Call algorithm fb Spectrum Quantiles. Call Ex( 5, FALSE, ADR(a Spectrum Voltage[0]), ADR(a Spectrum Voltage[1]), ADR(a Spectrum Voltage[2]), ADR(a Spectrum Current[0]), ADR(a Spectrum Current[1]), ADR(a Spectrum Current[2]), SIZEOF(a Spectrum Voltage[0]), ADR(a Spectrum Quantiles Voltage[0]), ADR(a Spectrum Quantiles Voltage[1]), ADR(a Spectrum Quantiles Voltage[2]), ADR(a Spectrum Quantiles Current[0]), ADR(a Spectrum Quantiles Current[1]), ADR(a Spectrum Quantiles Current[2]), SIZEOF(a Spectrum Quantiles Voltage[0]), ADR(b New Result_Spectrum), ADR(b New Result_Quantiles)); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.3.3.4.1 Call The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. The Call Ex [} 121] method may be suitable as an alternative. It calculates the quantiles only after a defined number of spectrum calculation results, in order to minimize CPU usage. Syntax METHOD Call : BOOL VAR_INPUT p Magnitude Spectrum_UL1 : POINTER TO LREAL; p Magnitude Spectrum_UL2 : POINTER TO LREAL; p Magnitude Spectrum_UL3 : POINTER TO LREAL; p Magnitude Spectrum_IL1 : POINTER TO LREAL; p Magnitude Spectrum_IL2 : POINTER TO LREAL; p Magnitude Spectrum_IL3 : POINTER TO LREAL; n Magnitude Spectrum Size : UDINT p Spectrum Quantiles_UL1 : POINTER TO LREAL; p Spectrum Quantiles_UL2 : POINTER TO LREAL; p Spectrum Quantiles_UL3 : POINTER TO LREAL; p Spectrum Quantiles_IL1 : POINTER TO LREAL; p Spectrum Quantiles_IL2 : POINTER TO LREAL; p Spectrum Quantiles_IL3 : POINTER TO LREAL; n Spectrum Quantiles Size : UDINT; END_VAR TF3650 Version: 1.5 119
## Page 120

PLC API Inputs Name Type Description p Magnitude Spectrum_U POINTER TO LREAL Pointer to an array of type LREAL with the L1 .. UL3 dimension: FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. p Magnitude Spectrum_I POINTER TO LREAL Pointer to an array of type LREAL with the L1 .. IL3 dimension: FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. n Magnitude Spectrum Si UDINT Indicates the size of the output array of a ze spectrum. p Spectrum Quantiles_U POINTER TO LREAL Pointer to an array of type LREAL with the L1 .. UL3 dimension: FFT length/2+1 x quantile. If these values are not to be output, the input can be set to 0. p Spectrum Quantiles_IL POINTER TO LREAL Pointer to an array of type LREAL with the 1 .. IL3 dimension: FFT length/2+1 x quantile. If these values are not to be output, the input can be set to 0. n Spectrum Quantiles Siz UDINT Indicates the size of the output array for a e quantile calculation. Return value Name Type Description Call BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.4.2 Init The Init method is usually not required in a Power Monitoring application. It offers an alternative to function block initialization, which enables encapsulation of the function block. The method FB_init or the attribute 'call_after_init' must be used for this (see Twin CAT 3 PLC > Programming Reference). The Init method may only be called during the initialization phase of the PLC. It cannot be used at runtime. The input parameters of the function block instance may not be assigned in the declaration if the initialization is to take place using the Init method. Syntax METHOD Init : BOOL VAR_INPUT n Own ID : UDINT; st Init Pars : ST_PMA_Spectrum_Quantiles_Init Pars; END_VAR Inputs Name Type Description n Own ID UDINT Identifies the function block instance with a unique ID. This must always be greater than zero. A proven approach is to define an enumeration for this purpose. st Init Pars ST_PMA_Spectrum_Quantiles_Ini Function block-specific structure with initialization parameters. The parameters must match the t Pars [} 134] definition of the input and output buffers. 120 Version: 1.5 TF3650
## Page 121

PLC API Return value Name Type Description Init BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.4.3 Pass Inputs As long as an instance of the function block FB_PMA_Source_3Ph [} 79] is called and thus signal data is transferred to a target block, all other function blocks of the analysis chain must be called cyclically (see Parallel Processing in Transfer Tray). Sometimes it is useful not to be execute an algorithm for a certain time. Although the function block must nevertheless be called cyclically, it is sufficient to forward the incoming input data. This is done using the Pass Inputs method instead of the Call method. No result is generated. Syntax METHOD Pass Inputs : BOOL VAR_INPUT END_VAR Return value Name Type Description Pass Inputs BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.4.4 Call Ex The method is called in each cycle to execute the calculations from the input buffer when new data is present. The function block waits for input data if the method outputs neither new results nor an error. This is a regular behavior in the process of the analysis chain. In contrast to the Call [} 119] method, the Call Ex method collects a variable number of results from the spectrum calculation and calculates the quantiles only afterwards. This may be required to minimize CPU load. Syntax METHOD Call Ex : BOOL VAR_INPUT n Append Data : UDINT; b Reset Data : BOOL; p Magnitude Spectrum_UL1 : POINTER TO LREAL; p Magnitude Spectrum_UL2 : POINTER TO LREAL; p Magnitude Spectrum_UL3 : POINTER TO LREAL; p Magnitude Spectrum_IL1 : POINTER TO LREAL; p Magnitude Spectrum_IL2 : POINTER TO LREAL; p Magnitude Spectrum_IL3 : POINTER TO LREAL; n Magnitude Spectrum Size : UDINT p Spectrum Quantiles_UL1 : POINTER TO LREAL; p Spectrum Quantiles_UL2 : POINTER TO LREAL; p Spectrum Quantiles_UL3 : POINTER TO LREAL; p Spectrum Quantiles_IL1 : POINTER TO LREAL; p Spectrum Quantiles_IL2 : POINTER TO LREAL; p Spectrum Quantiles_IL3 : POINTER TO LREAL; n Spectrum Quantiles Size : UDINT; END_VAR TF3650 Version: 1.5 121
## Page 122

PLC API Inputs Name Type Description n Append Data UDINT Number of spectra to be calculated until the quantile is calculated. A value of 1 means that the quantiles are calculated after each result of the spectrum calculation. b Reset Data BOOL Automatic resetting of records after each quantile calculation p Magnitude Spectrum_U POINTER TO LREAL Pointer to an array of the type LREAL with the L1 .. UL3 dimension FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. p Magnitude Spectrum_I POINTER TO LREAL Pointer to an array of the type LREAL with the L1 .. IL3 dimension FFT length/2+1. If the spectrum is not to be output, the input can be set to 0. n Magnitude Spectrum Si UDINT Indicates the size of the output array of a ze spectrum. p Spectrum Quantiles_U POINTER TO LREAL Pointer to an array of the type LREAL with the L1 .. UL3 dimension FFT length/2+1 x quantile. If these values are not to be output, the input can be set to 0. p Spectrum Quantiles_IL POINTER TO LREAL Pointer to an array of the type LREAL with the 1 .. IL3 dimension FFT length/2+1 x quantile. If these values are not to be output, the input can be set to 0. n Spectrum Quantiles Siz UDINT Indicates the size of the output array for a e quantile calculation. Return value Name Type Description Call Ex BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.3.3.4.5 Reset This method deletes all the data sets already added. Alternatively, automatic resetting can be used on the Call Ex [} 121] method. Syntax METHOD Reset : BOOL VAR_INPUT END_VAR Return value Name Type Description Reset BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 122 Version: 1.5 TF3650
## Page 123

PLC API 5.3.3.4.6 Reconfigure The method is called in order to reconfigure the function block during the runtime. Syntax METHOD Reconfigure : BOOL VAR_INPUT a Quantiles : ARRAY[0.. GVL_PMA.c Max Quantiles - 1] OF LREAL; END_VAR Inputs Name Type Description a Quantiles ARRAY[0 - Indicates the quantile limit. It must be between GVL_PMA.c Max Quantiles-1] 0.0 and 1.0. For example, 0.2 corresponds to the OF LREAL 20% quantile. Return value Name Type Description Reconfigure BOOL Indicates whether the method was executed successfully. Further information is provided in the Event interface of the function block. 5.4 Data types 5.4.1 E_PMA_Scaling Type The enumeration E_PMA_Scaling Type lists all scaling options for spectral calculations. It is used in the structures of the initialization parameters. Further details can be found in the appendix to the "TF3600 Condition Monitoring" documentation. Syntax Definition: {attribute 'qualified_only'} {attribute 'strict'} TYPE E_PMA_Scaling Type : ( No Scaling := 0, Dirac Scaling := 1, Peak Amplitude := 2, Root Power Sum := 3, RMS := 4, Gain Correction := 5, Power Spectral Density := 6, Unitary Scaling := 7 ) UDINT; END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring TF3650 Version: 1.5 123
## Page 124

PLC API 5.4.2 E_PMA_Window Type The enumeration E_PMA_Window Type can be used to select the window type for the spectral calculations. It is used in the structures of the initialization parameters. Further details can be found in the appendix to the "TF3600 Condition Monitoring" documentation. Syntax Definition: {attribute 'qualified_only'} {attribute 'strict'} TYPE E_PMA_Window Type : ( Hann Window := 16#05300901, Rectangular Window := 16#05300902 ) UDINT; END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3 Init Parameters 5.4.3.1 General 5.4.3.1.1 ST_PMA_Scaling_EL3773_Init Pars Function block-specific structure with initialization parameters which are evaluated when the function block FB_PMA_Scaling_EL3773 [} 22] is initialized. Syntax Definition: TYPE ST_PMA_Scaling_EL3773_Init Pars : STRUCT n Oversamples : UDINT := 10; // Oversampling factor f Offset Voltage : LREAL := 0.0; // Output = (input * gain) + offset f Gain Voltage : LREAL := 1.0; // || f Offset Current : LREAL := 0.0; // Output = (input * gain) + offset f Gain Current : LREAL := 1.0; // || f Factor Current Transformer : LREAL := 1.0; // Factor of current tranformer (input / output) END_STRUCT END_TYPE Parameter Name Type Description n Oversamples UDINT Oversampling factor f Offset Voltage LREAL Indicates a user-defined offset for the voltage scaling. f Gain Voltage LREAL Indicates a user-defined gain factor for the voltage scaling. f Offset Current LREAL Indicates a user-defined offset for the current scaling. f Gain Current LREAL Specifies a user-defined gain factor for the current scaling. 124 Version: 1.5 TF3650
## Page 125

PLC API Name Type Description f Factor Current Transfor LREAL Current transformer factor. This is calculated from mer the input current and output current. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.1.2 ST_PMA_Scaling_EL3783_Init Pars Function block-specific structure with initialization parameters which are evaluated when the function block FB_PMA_Scaling_EL3783 [} 26] is initialized. Syntax Definition: TYPE ST_PMA_Scaling_EL3783_Init Pars : STRUCT n Oversamples : UDINT := 20; // Oversampling factor f Offset Voltage : LREAL := 0.0; // Output = (input * gain) + offset f Gain Voltage : LREAL := 1.0; // || f Offset Current : LREAL := 0.0; // Output = (input * gain) + offset f Gain Current : LREAL := 1.0; // || f Factor Current Transformer : LREAL := 1.0; // Factor of current tranformer (input / output) END_STRUCT END_TYPE Parameter Name Type Description n Oversamples UDINT Oversampling factor f Offset Voltage LREAL Indicates a user-defined offset for the voltage scaling. f Gain Voltage LREAL Indicates a user-defined gain factor for the voltage scaling. f Offset Current LREAL Indicates a user-defined offset for the current scaling. f Gain Current LREAL Specifies a user-defined gain factor for the current scaling. f Factor Current Transfor LREAL Current transformer factor. This is calculated from mer the input current and output current. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.1.3 ST_PMA_Scaling_Init Pars Function block-specific structure with initialization parameters which are evaluated when the function block FB_PMA_Scaling [} 17] is initialized. Syntax Definition: TYPE ST_PMA_Scaling_Init Pars : STRUCT n Oversamples : UDINT := 10; // Oversampling factor TF3650 Version: 1.5 125
## Page 126

PLC API n Resolution Voltage : UDINT := (1..32); // in bit f Max Voltage : LREAL; // Max input amplitude f Offset Voltage : LREAL := 0; // Output = (input * gain) + offset f Gain Voltage : LREAL := 1; // || n Resolution Current : UDINT := (1..32); // in bit f Max Current : LREAL; // Max input amplitude f Offset Current : LREAL := 0; // Output = (input * gain) + offset f Gain Current : LREAL := 1; // || f Factor Current Transformer : LREAL := 1; // Factor of current transformer (input / output) END_STRUCT END_TYPE Parameter Name Type Parameter n Oversamples UDINT Oversampling factor n Resolution Voltage UDINT Resolution of the voltage in bits. Range of values: 0-32 f Max Voltage LREAL Indicated the maximum amplitude of the input voltage. f Offset Voltage LREAL Indicates a user-defined offset for the voltage scaling. f Gain Voltage UDINT Indicates a user-defined gain factor for the voltage scaling. n Resolution Current LREAL Resolution of the current in bits. Range of values: 0-32 f Max Current LREAL Indicates the maximum amplitude of the input current. f Offset Current LREAL Indicates a user-defined offset for the current scaling. f Gain Current LREAL Specifies a user-defined gain factor for the current scaling. f Factor Current Transfor LREAL Current transformer factor. This is calculated from mer the input current and output current. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.1.4 ST_PMA_Source_Init Pars Function block-specific structure with initialization parameters which are evaluated when the function blocks FB_PMA_Source_1Ph [} 36] and FB_PMA_Source_3Ph [} 79] are initialized. Syntax Definition: TYPE ST_PMA_Source_Init Pars : STRUCT n Buffer Length : UDINT := 200; // Length of output buffer END_STRUCT END_TYPE Parameter Name Type Parameter n Bufferlength UDINT Length of the output buffer 126 Version: 1.5 TF3650
## Page 127

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.1.5 ST_PMA_Task Transfer_Init Pars Function block-specific structure with initialization parameters which are evaluated when the function blocks FB_PMA_Task Transfer_Send [} 31] and FB_PMA_Task Transfer_Receive [} 34] are initialized. Syntax Definition: TYPE ST_PMA_Task Transfer_Init Pars : STRUCT n Input Size : UDINT; // Size of input data END_STRUCT END_TYPE Parameter Name Type Parameter n Input Size UDINT Number of elements which are exchanged via the function blocks for task transfer Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.2 Based on the signal period 5.4.3.2.1 ST_PMA_Basic Values_Period_Init Pars Function block-specific structure with initialization parameters which are evaluated when the function blocks FB_PMA_Basic Values_Period_1Ph [} 44] and FB_PMA_Basic Values_Period_3Ph [} 87] are initialized. Syntax Definition: TYPE ST_PMA_Basic Values_Period_Init Pars : STRUCT n Buffer Length : UDINT := 200; // Length of input buffer f Sample Rate : LREAL := 1000; // in Hz f Min Input Current : LREAL := 0.0; // Minimal input of current (RMS) to calculate outputs n Periods : UDINT := 1; // Amount of signal periods to calculate outputs END_STRUCT END_TYPE Parameter Name Type Parameter n Buffer Length UDINT Length of the input buffer f Sample Rate LREAL Indicates the sampling rate (samples per second) of the input signal. TF3650 Version: 1.5 127
## Page 128

PLC API Name Type Parameter f Min Input Current LREAL Minimum input value (RMS) of the current. This prevents the calculation of input values that are too small. n Periods UDINT Number of signal periods for calculating the RMS Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.2.2 ST_PMA_Frequency_Period_Init Pars Function block-specific structure with initialization parameters that are evaluated when the function blocks FB_PMA_Frequency_Period_1Ph [} 40] and FB_PMA_Frequency_Period_3Ph [} 82] are initialized. Syntax Definition: TYPE ST_PMA_Frequency_Period_Init Pars : STRUCT n Buffer Length : UDINT := 200; // Length of input buffer f Sample Rate : LREAL := 1_000; // in Hz f Min Freq : LREAL := 45; // Min measured Freq f Max Freq : LREAL := 65; // Max measured Freq n Periods : UDINT := 2; // Number of periods to be considered n Filter Order : UINT := 3; // Filter order of butterworth lowpass filter f Cutoff : LREAL := 70.0; // Cutoff frequency of filter e Input Select : E_PMA_Input Select := E_PMA_Input Select. Voltage; // Select input: Voltage | Current f Min Input : LREAL := 200.0; // Minimal input (RMS) over one period to calculate outputs n Rocof Avg Window : UDINT := 25; // Window length of elements to calculate moving average of ROCOF END_STRUCT END_TYPE Parameters Name Type Parameters n Buffer Length UDINT Length of the input buffer f Sample Rate LREAL Indicates the sampling rate (samples per second) of the input signal. f Min Freq LREAL Minimum expected measuring frequency f Max Freq LREAL Maximum expected measuring frequency n Periods UDINT Number of periods that influence the calculation. (Period length = sample rate/frequency) n Filter Order UINT Indicates the order of the low-pass filter. The stability of the filter must be considered for the setting. Only values up to the tenth order are allowed. f Cutoff LREAL Specifies the cut-off frequency of the low-pass filter. e Input Select E_PMA_Input Select [} 140] Voltage: The voltage is used as the basis for the frequency calculation Current: The current is used as the basis for the frequency calculation f Min Input LREAL Minimum input value (RMS) over one period. This prevents the calculation of input values that are too small. 128 Version: 1.5 TF3650
## Page 129

PLC API Name Type Parameters n Rocof Avg Window UDINT Window size of the sliding average value for the calculation of the ROCOF Resulting period: n Periods * n Rocof Avg Window / avgeraged Freq) Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.2.3 ST_PMA_Power Values_Period_Init Pars Function block-specific structure with initialization parameters which are evaluated when the function blocks FB_PMA_Power Values_Period_1Ph [} 49] and FB_PMA_Power Values_Period_3Ph [} 92] are initialized. Syntax Definition: TYPE ST_PMA_Power Values_Period_Init Pars : STRUCT n Buffer Length : UDINT := 200; // Length of input buffer f Sample Rate : LREAL := 1000; // in Hz f Min Input Current : LREAL := 0.0; // Minimal input of current (RMS) to calculate outp uts n Periods : UDINT := 1; // Amount of signal periods to calculate outputs f Nominal Voltage : LREAL := 230.0; // Nominal voltage, required for PQF calculation f Nominal Freq : LREAL := 50.0; // Nominal frequency, required for PQF calculation e Pqf Mode : E_PMA_Pqf Mode := E_PMA_Pqf Mode. Default; // Mode of PQF calculation u Time Lag Current Transformer : U_PMA_Timelag := (f Time Lag := 0); // Timelag caused by induct ivity of current transformer ( in s END_STRUCT END_TYPE Parameters Name Type Parameters n Buffer Length UDINT Length of the input buffer f Sample Rate LREAL Indicates the sampling rate (samples per second) of the input signal. f Min Input Current LREAL Minimum input value (RMS) of the current. This prevents the calculation of input values that are too small. n Periods UDINT Number of signal periods for calculating the output values f Nominal Voltage LREAL Nominal voltage value. Is required for the calculation of the Power Quality Factor. f Nominal Freq LREAL Nominal frequency. Is required for the calculation of the Power Quality Factor. e Pqf Mode E_PMA_Pqf Mode [} 141] Mode for calculating the Power Quality Factor. Default: Calculation of the Power Quality Factor with the frequency, the RMS value of the voltage as well as the THD of the voltage. Default And Unbalance: As Default, but in a three- phase system the voltage unbalance is also included in the calculation. u Time Lag Current Transf U_PMA_Timelag Here, the possible delay due to the inductance of ormer the current transformer can be specified in seconds. TF3650 Version: 1.5 129
## Page 130

PLC API Name Type Parameters U_PMA_Timelag.f Time Lag: Identical for all phases U_PMA_Timelag.a Time Lag: Individual per phase Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.2.4 ST_PMA_Harmonics_Period_Init Pars Function block-specific structure with initialization parameters that is evaluated when the function blocks FB_PMA_Harmonics_Period_1Ph [} 54] and FB_PMA_Harmonics_Period_3Ph [} 97] are initialized. Syntax Definition: TYPE ST_PMA_Harmonics_Period_Init Pars : STRUCT n Buffer Length : UDINT := 200; // Length of input buffer f Sample Rate : LREAL := 1000; // in Hz n Num Harmonics : UDINT := 20; // Number of harmonics n Periods : UDINT := 10; // Amount of signal periods to calculate outputs b Transform To Percent : BOOL := TRUE; // transform results to percent (1st harmonic=100%) END_STRUCT END_TYPE Parameters Name Type Parameters n Buffer Length UDINT Length of the input buffer f Sample Rate LREAL Indicates the sampling rate (samples per second) of the input signal. n Num Harmonics UDINT Number of harmonics to be calculated n Periods UDINT Number of signal periods for calculating the output values. b Transform To Percent BOOL Boolean value indicating whether the result should be output in percent. The first harmonic corresponds to 100%. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.3 Based on the frequency range 5.4.3.3.1 ST_PMA_Harmonics_Init Pars Function block-specific structure with initialization parameters that are evaluated when the function blocks FB_PMA_Harmonics_1Ph [} 59] and FB_PMA_Harmonics_3Ph [} 102] are initialized. Syntax Definition: 130 Version: 1.5 TF3650
## Page 131

PLC API TYPE ST_PMA_Harmonic Analysis_Init Pars : STRUCT f Sample Rate : LREAL := 1000; // Sample rate f Base Freq : LREAL := 50.0; // Multiple of base frequence is used for band limit de finition n FFT_Length : UDINT := 512; // Length of FFT n Window Length : UDINT := 400; // Length of FFT window n Num Bands : UDINT := 10; // Number of bands f Bandwidth : LREAL := 4.0; // Whole bandwidth for each frequency band, min 1.0 e Window Type : E_PMA_Window Type := E_PMA_Window Type. Hann Window; // Window function used b Transform To Decibel : BOOL := TRUE; // Transform result to decibel f Decibel Threshold : LREAL := 1.3E-308;// Logarithm threshold for decibel transformation b Transform To Percent : BOOL := FALSE; // Transform result to percent (1st harmonic=100%) END_STRUCT END_TYPE Parameter Name Type Parameter f Sample Rate LREAL Indicates the sampling rate (samples per second) of the input signal. f Base Freq LREAL Frequency of the first harmonic. n FFT_Length UDINT Length of the FFT. It must be greater than one and an integral power of two. n Window Length UDINT Length of the analysis window in samples. The length must be greater than one and an even number. n Num Bands UDINT Indicates the number of bands for which the RMS is calculated. f Bandwidth LREAL Total bandwidth of each RMS band e Window Type E_PMA_Window Type [} 124] Defines the window function that is used. The window type "„Hann Window" is a good default value. The windowing can be switched off by the use of the window type "Rectangular Window". Further explanations and the list of possible window functions can be found in the introductory section Window functions. b Transform To Decibel BOOL Boolean value that indicates whether the result of the FFT is to be transformed to the decibel scale, according to transformation x → 20 * log10(x). f Decibel Threshold LREAL Very small floating point value greater than zero. Values that are less than this number are replaced with this value before any transformation to the decibel scale, since the logarithm of zero is not defined mathematically. The smallest possible value is 3.75e-324. b Transform To Percent BOOL Boolean value indicating whether the result should be output in percent. The first harmonic corresponds to 100%. Window length The value of n Window Length must be less or equal the value of n FFT_Length. The length of the FFT can orient itself to the required frequency resolution. Typically a value of about 3/4 of the FFT length is used as the window length. If n FFT_Length is greater than n Window Length, the frequency resolution of the FFT (and therefore also the length of the return values vector) is increased. The length difference is filled with zeros before the Fourier transform . This can be useful for achieving a higher frequency resolution, or for avoiding circular aliasing in calculations with inverse transformation in the time domain . Despite the higher frequency resolution, however, the result contains no more information. TF3650 Version: 1.5 131
## Page 132

PLC API 5.4.3.3.2 ST_PMA_Power Values_Init Pars Function block-specific structure with initialization parameters which are evaluated when the function blocks FB_PMA_Power Values_1Ph [} 63] and FB_PMA_Power Values_3Ph [} 107] are initialized. Syntax Definition: TYPE ST_PMA_Power Values_Init Pars : STRUCT f Sample Rate : LREAL := 1000; // in Hz f Base Freq : LREAL := 50.0; // in HZ n FFT_Length : UDINT := 512; // Length of FFT n Window Length : UDINT := 400; // Length of FFT window n Num Bands : UDINT := 10, // Number of bands f Bandwidth : LREAL := 4.0 // Whole bandwidth of each frequency band e Window Type : E_PMA_Window Type := E_PMA_Window Type. Hann Window; // Window funct ion used f Min Input Current : LREAL := 0.0; // Minimal input of current (RMS) to calculate outputs u Time Lag Current Transformer : U_PMA_Timelag := (f Time Lag := 0); // Timelag caused by induct ivity of current transformer ( in s ) END_STRUCT END_TYPE Parameters Name Type Parameters f Sample Rate LREAL Indicates the sampling rate (samples per second) of the input signal. f Freq LREAL Frequency of the first harmonic (fundamental) n FFT_Length UDINT Length of the FFT. It must be greater than one and an integral power of two. n Window Length UDINT Length of the analysis window in samples. The length must be greater than one and an even number. It must be not greater than n FFT_Length. n Num Bands UDINT Indicates the number of bands for which the RMS is calculated. f Bandwidth LREAL Total bandwidth of a single RMS band e Window Type E_PMA_Window Type [} 124] Defines the window function used. The window type "Hann Window" is a good default value. The windowing can be switched off by the use of the window type "Rectangular Window". Further explanations and the list of possible window functions can be found in the introductory section Window functions. f Min Input Current LREAL Minimum input value (RMS) of the current. This prevents the calculation of input values that are too small. u Time Lag Current Transf U_PMA_Timelag Here, the possible delay due to the inductance of ormer the current transformer can be specified in seconds. U_PMA_Timelag.f Time Lag: Identical for all phases U_PMA_Timelag.a Time Lag: Individual per phase Window length The value of n Window Length must be less or equal the value of n FFT_Length. The length of the FFT can orient itself to the required frequency resolution. Typically a value of about 3/4 of the FFT- length is used as the window length. 132 Version: 1.5 TF3650
## Page 133

PLC API If n FFT_Length is greater than n Window Length, the frequency resolution of the FFT (and therefore also the length of the return values vector) is increased. The difference in the length is filled with zeros by the Fourier transformation. This can be useful for achieving a higher frequency resolution, or for avoiding circular aliasing in calculations with inverse transformation in the time domain. Despite the higher frequency resolution, however, the result contains no more information. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.3.3 ST_PMA_Spectrum_Init Pars Function block-specific structure with initialization parameters that are evaluated when the function blocks FB_PMA_Spectrum_1Ph [} 69] and FB_PMA_Spectrum_3Ph [} 113] are initialized. Syntax Definition: TYPE ST_PMA_Spectrum_Init Pars : STRUCT n FFT_Length : UDINT := 512; // Length of FFT n Window Length : UDINT := 400; // Length of FFT window f Sample Rate : LREAL := 1000; // in Hz e Scaling Type : E_PMA_Scaling Type := E_PMA_Scaling Type. No Scaling; // Scaling type used e Window Type : E_PMA_Window Type := E_PMA_Window Type. Hann Window; // Window function used b Transform To Decibel : BOOL := TRUE; // Transform result to decibel f Decibel Threshold : LREAL := 1.3E-308; // Logarithm threshold for decibel transformation END_STRUCT END_TYPE Parameter Name Type Parameter n FFT_Length UDINT Length of the FFT. It must be greater than one and an integral power of two. n Window Length UDINT Length of the analysis window in samples. The length must be greater than one and an even number. It must be not greater than n FFT_Length. f Sample Rate LREAL Indicates the sampling rate (samples per second) of the input signal. e Scaling Type E_PMA_Scaling Type [} 123] Allows selection of the scaling used if absolute scaling is required. e Window Type E_PMA_Window Type [} 124] Defines the window function that is used. The window type "„Hann Window" is a good default value. The windowing can be switched off by the use of the window type "Rectangular Window". Further explanations and the list of possible window functions can be found in the introductory section Window functions. b Transform To Decibel BOOL Boolean value that indicates whether the result of the FFT is to be transformed to the decibel scale, according to transformation x → 20 * log10(x). f Decibel Threshold LREAL Very small floating point value greater than zero. Values that are less than this number are replaced with this value before any transformation to the decibel scale, since the logarithm of zero is TF3650 Version: 1.5 133
## Page 134

PLC API Name Type Parameter not defined mathematically. The smallest possible value is 3.75e-324, which is equivalent to the constant c CM_Min Arg Log10. Window length The value of n Window Length must be less or equal the value of n FFT_Length. The length of the FFT can orient itself to the required frequency resolution. Typically a value of about 3/4 of the FFT- length is used as the window length. If n FFT_Length is greater than n Window Length, the frequency resolution of the FFT (and therefore also the length of the return values vector) is increased. The difference in the length is filled with zeros by the Fourier transformation. This can be useful for achieving a higher frequency resolution, or for avoiding circular aliasing in calculations with inverse transformation in the time domain. Despite the higher frequency resolution, however, the result contains no more information. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.3.3.4 ST_PMA_Spectrum_Quantiles_Init Pars Lefeld Function block-specific structure with initialization parameters which are evaluated when the function blocks FB_PMA_Spectrum_Quantiles_1Ph [} 73] and FB_PMA_Spectrum_Quantiles_3Ph [} 117] are initialized. Syntax Definition: TYPE ST_PMA_Spectrum_Quantiles_Init Pars : STRUCT n FFT_Length : UDINT := 512; // Length of FFT n Window Length : UDINT := 400; // Length of FFT window f Sample Rate : LREAL := 1000; // in Hz e Scaling Type : E_PMA_Scaling Type := E_PMA_Scaling Type. No Scaling; // Scaling type used e Window Type : E_PMA_Window Type := E_PMA_Window Type. Hann Window; // Window function used b Transform To Decibel : BOOL := TRUE; // Transform result to decibel f Decibel Threshold : LREAL := 1.3E-308; // Log threshold for decibel transformation f Min Binned Voltage : LREAL; // Minimum binned voltage f Max Binned Voltage : LREAL; // Maximum binned voltage f Min Binned Current : LREAL; // Minimum binned current f Max Binned Current : LREAL; // Maximum binned current n Bins : UDINT := 1; // Number of bins in interval n Num Quantiles : UDINT := 1; // Maximum number of quantile values a Quantiles : ARRAY[0.. GVL_PMA.c Max Quantiles-1] OF LREAL; // 0.0 < a Quantiles[x] <1.0 END_STRUCT END_TYPE Parameter Name Type Parameter n FFT_Length UDINT Length of the FFT. It must be greater than one and an integral power of two. n Window Length UDINT Length of the analysis window in samples. The length must be greater than one and an even number. It must be not greater than n FFT_Length. f Sample Rate LREAL Indicates the sampling rate (samples per second) of the input signal. e Scaling Type E_PMA_Scaling Type [} 123] Enables the selection of the scaling to be used, in case absolute scaling is required. 134 Version: 1.5 TF3650
## Page 135

PLC API Name Type Parameter e Window Type E_PMA_Window Type [} 124] Defines the window function used. The window type „Hann Window" is a good default value. The windowing can be switched off by the use of the window type "Rectangular Window". Further explanations and the list of possible window functions can be found in the introductory section Window functions. b Transform To Decibel BOOL Boolean value that indicates whether the result of the FFT is to be transformed to the decibel scale, according to transformation x → 20 * log10(x). f Decibel Threshold LREAL Very small floating point value greater than zero. Values that are less than this number are replaced with this value before any transformation to the decibel scale, since the logarithm of zero is not defined mathematically. The smallest possible value is 3.75e-324. f Min Binned Voltage LREAL Lower limit value for which the output data of the spectrum calculation of the voltage are counted in the regular histogram bins. f Max Binned Voltage LREAL Upper limit value for which the output data of the spectrum calculation of the voltage are counted in the regular histogram bins. f Max Binned Voltage must be larger than f Min Binned Voltage. f Min Binned Current LREAL Lower limit value for which the output data of the spectrum calculation of the current are counted in the regular histogram bins. f Max Binned Current LREAL Upper limit value for which the output data of the spectrum calculation of the current are counted in the regular histogram bins. f Max Binned Current must be larger than f Min Binned Current. n Bins UDINT number of bins in a histogram. The minimum number is 1. In many cases, values between ten and twenty are a sensible choice. The two special bins for values that lie below f Min Binned or above f Max Binned are not included in this value. n Num Quantiles UDINT Number of quantiles to calculate for each channel. This must be an integer greater than zero. a Quantiles ARRAY[0 - Indicates the quantile limit. It must be between GVL_PMA.c Max Quantiles-1] 0.0 and 1.0. For example, 0.2 corresponds to the OF LREAL 20% quantile. Window length The value of n Window Length must be less or equal the value of n FFT_Length. The length of the FFT can orient itself to the required frequency resolution. Typically a value of about 3/4 of the FFT- length is often used as the window length. If n FFT_Length is greater than n Window Length, the frequency resolution of the FFT (and therefore also the length of the return values vector) is increased. The difference in the length is filled with zeros by the Fourier transformation. This can be useful for achieving a higher frequency resolution, or for avoiding circular aliasing in calculations with inverse transformation in the time domain. Despite the higher frequency resolution, however, the result contains no more information. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring TF3650 Version: 1.5 135
## Page 136

PLC API 5.4.4 Single-phase 5.4.4.1 ST_PMA_Basic Values_Period_1Ph Structure that summarizes the results of the corresponding function block and which can be queried via the property st Results. Details on the values contained can be found in the comment or in the description of the function block FB_PMA_Basic Values_Period_1Ph [} 44]. Syntax Definition: TYPE ST_PMA_Basic Values_Period_1Ph : STRUCT f Mean Value_U : LREAL; // [V] | Mean value over n periods f RMS_U : LREAL; // [V] | Root mean square over n periods f RMS_U_Min : LREAL; // [V] | Min value of f RMS_U f RMS_U_Max : LREAL; // [V] | Max value of f RMS_U f Peak Value_U : LREAL; // [V] | Peak value of U over n periods f Peak Hold_U : LREAL; // [V] | All time peak of U f Rectified Value_U : LREAL; // [V] | Rectified value over n periods f Crest Factor_U : LREAL; // [] | Peak_value / RMS f Form Factor_U : LREAL; // [] | RMS / rectified_value f Mean Value_I : LREAL; // [A] | Mean value over n periods f RMS_I : LREAL; // [A] | Root mean square over n periods f RMS_I_Min : LREAL; // [A] | Min value of f RMS_I f RMS_I_Max : LREAL; // [A] | Max value of f RMS_I f Peak Value_I : LREAL; // [A] | Peak value of I over n periods f Peak Hold_I : LREAL; // [A] | All time peak of I f Rectified Value_I : LREAL; // [A] | Rectified value over n periods f Crest Factor_I : LREAL; // [] | Peak_value / RMS f Form Factor_I : LREAL; // [] | RMS / rectified_value END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.4.2 ST_PMA_Frequency_Period_1Ph Structure that summarizes the results of the corresponding function block. It can be queried via the property st Results. Details on the values contained can be found in the comment or in the description of the function block FB_PMA_Frequency_Period_1Ph [} 40]. Syntax Definition: TYPE ST_PMA_Frequency_Period_1Ph : STRUCT f Freq : LREAL; // [Hz] | f | Frequency calculated by zero crossings f Freq_Min : LREAL; // [Hz] | f_min | Min value of f Freq f Freq_Max : LREAL; // [Hz] | f_max | Max value of f Freq f Rocof : LREAL; // [Hz/s] | | Rate of change of frequency (ROCOF) END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 136 Version: 1.5 TF3650
## Page 137

PLC API 5.4.4.3 ST_PMA_Power Values_1Ph Structure that summarizes the results of the corresponding function block. It can be queried via the property st Results. Details on the values contained can be found in the comment or in the descriptions of the function blocks FB_PMA_Power Values_Period_1Ph [} 49] or FB_PMA_Power Values_1Ph [} 63]. Syntax Definition: Type ST_PMA_Power Values_1Ph STRUCT f Apparent Power : LREAL; // [VA] | S | apparent power f Apparent Power_1 : LREAL; // [VA] | S_1 | fundamental apparent power f Apparent Power_1_Min : LREAL; // [VA] | S_1_min | Min value of S_1 f Apparent Power_1_Max : LREAL; // [VA] | S_1_max | Max value of S_1 f Active Power : LREAL; // [W] | P | active power f Active Power_Min : LREAL; // [W] | P_min | Min value of P f Active Power_Max : LREAL; // [W] | P_max | Max value of P f Reactive Power_d : LREAL; // [var] | Q_d | distortion reactive power f Reactive Power_1 : LREAL; // [var] | Q_1 | fundamental reactive power f Reactive Power_1_Min : LREAL; // [var] | Q_1_min | Min value of Q_1 f Reactive Power_1_Max : LREAL; // [var] | Q1_max | Max value of Q_1 f Total Reactive Power : LREAL; // [var] | Q_tot | total reactive power f Phi : LREAL; // [°] | phi | phase difference f Cos Phi : LREAL; // [] | COS(phi)|(P / S_1) f Power Factor : LREAL; // [] | PF | power factor (P / S) st Energy_Pos : ST_PMA_Energy; // [k Wh] | W_pos | Energy in positive direction st Energy_Neg : ST_PMA_Energy; // [k Wh] | W_neg | Energy in negative direction st Energy_Res : ST_PMA_Energy; // [k Wh] | W | Resulting energy END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.4.4 ST_PMA_THD_1Ph Structure that summarizes the results of the corresponding function block. It can be queried via the property st Results. Details on the values contained can be found in the comment or in the description of the function block FB_PMA_Harmonics_1Ph [} 59]. Syntax Definition: TYPE ST_PMA_THD_1Ph : STRUCT f THD_U : LREAL; // [] | THD_U | Total harmonic distortion of voltage | in percent f THD_U_Min : LREAL; // [] | THD_U_min | Min value of THD_U f THD_U_Max : LREAL; // [] | THD_U_max | Max value of THD_U f THD_I : LREAL; // [] | THD_I | Total harmonic distortion of current | in percent f THD_I_Min : LREAL; // [] | THD_I_min | Min value of THD_I f THD_I_Max : LREAL; // [] | THD_I_max | Max value of THD_I END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring TF3650 Version: 1.5 137
## Page 138

PLC API 5.4.5 Three-phase 5.4.5.1 E_PMA_Rotational Direction_3Ph Syntax Definition: {attribute 'qualified_only'} {attribute 'strict'} TYPE E_PMA_Rotational Direction_3Ph : ( No_Direction := 0; // no rotational direction detected Right := 1; Left := 2; ) UDINT; END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.5.2 ST_PMA_Basic Values_Period_3Ph Structure that summarizes the results of the corresponding function block. It can be queried via the property st Results. Details on the values contained can be found in the comment or in the description of the function block FB_PMA_Basic Values_Period_3Ph [} 87]. Syntax Definition: TYPE ST_PMA_Basic Values_Period_3Ph : STRUCT a Mean Value_U : ARRAY[0..2] OF LREAL; // [V] | Mean value over n periods a RMS_U : ARRAY[0..2] OF LREAL; // [V] | Root mean square over n periods a RMS_U_Min : ARRAY[0..2] OF LREAL; // [V] | Min value of a RMS_U a RMS_U_Max : ARRAY[0..2] OF LREAL; // [V] | Max value of a RMS_U a RMS_UPP : ARRAY[0..2] OF LREAL; // [V] | 0: L1 - L2 | 1: L2 - L3 | 2: L3 - L1 a Peak Value_U : ARRAY[0..2] OF LREAL; // [V] | Peak value of U over n periods a Peak Hold_U : ARRAY[0..2] OF LREAL; // [V] | All time peak of U a Rectified Value_U : ARRAY[0..2] OF LREAL; // [V] | Rectified value over n periods a Crest Factor_U : ARRAY[0..2] OF LREAL; // [] | Peak_value / RMS a Form Factor_U : ARRAY[0..2] OF LREAL; // [] | RMS / rectified_value a Mean Value_I : ARRAY[0..2] OF LREAL; // [A] | Mean value over n periods [A] a RMS_I : ARRAY[0..2] OF LREAL; // [A] | Root mean square over n periods [A] a RMS_I_Min : ARRAY[0..2] OF LREAL; // [A] | Min value of a RMS_I [A] a RMS_I_Max : ARRAY[0..2] OF LREAL; // [A] | Max value of a RMS_I [A] a Peak Value_I : ARRAY[0..2] OF LREAL; // [A] | Peak value of I over n periods [A] a Peak Hold_I : ARRAY[0..2] OF LREAL; // [A] | All time peak of I [A] a Rectified Value_I : ARRAY[0..2] OF LREAL; // [A] | Rectified value over n periods [A] a Crest Factor_I : ARRAY[0..2] OF LREAL; // [] | Peak_value / RMS a Form Factor_I : ARRAY[0..2] OF LREAL; // [] | RMS / rectified_value END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 138 Version: 1.5 TF3650
## Page 139

PLC API 5.4.5.3 ST_PMA_Frequency_Period_3Ph Structure that summarizes the results of the corresponding function block. It can be queried via the property st Results. Details on the values contained can be found in the comment or in the description of the function block FB_PMA_Frequency_Period_3Ph [} 82]. Syntax Definition: TYPE ST_PMA_Frequency_Period_3Ph : STRUCT a Freq : ARRAY[0..2] OF LREAL; // [Hz] | f | Frequency calculated by zero crossings a Freq_Min : ARRAY[0..2] OF LREAL; // [Hz] | f_min | Min value of a Freq a Freq_Max : ARRAY[0..2] OF LREAL; // [Hz] | f_max | Max value of a Freq a Rocof : ARRAY[0..2] OF LREAL; // [Hz/s] | | Rate of change of frequency (ROCOF) e Rot Direction : E_PMA_Rotational Direction_3Ph; // Rotational direction END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.5.4 ST_PMA_Power Values_3Ph Structure that summarizes the results of the corresponding function block. It can be queried via the property st Results. Details on the values contained can be found in the comment or in the descriptions of the function blocks FB_PMA_Power Values_Period_3Ph [} 92] or FB_PMA_Power Values_3Ph [} 107]. Syntax Definition: TYPE ST_PMA_Power Values_3Ph : STRUCT a Apparent Power : ARRAY[0..2] OF LREAL; // [VA] | S | apparent power a Apparent Power_1 : ARRAY[0..2] OF LREAL; // [VA] | S_1 | fundamental apparent power a Apparent Power_1_Min : ARRAY[0..2] OF LREAL; // [VA] | S_1_min | Min value of S_1 a Apparent Power_1_Max : ARRAY[0..2] OF LREAL; // [VA] | S_1_max | Max value of S_1 a Active Power : ARRAY[0..2] OF LREAL; // [W] | P | active power a Active Power_Min : ARRAY[0..2] OF LREAL; // [W] | P_min | Min value of P a Active Power_Max : ARRAY[0..2] OF LREAL; // [W] | P_max | Max value of P a Reactive Power_d : ARRAY[0..2] OF LREAL; // [var] | Q_d | distortion reactive power a Reactive Power_1 : ARRAY[0..2] OF LREAL; // [var] | Q_1 | fundamental reactive power a Reactive Power_1_Min : ARRAY[0..2] OF LREAL; // [var] | Q_1_min | Min value of Q_1 a Reactive Power_1_Max : ARRAY[0..2] OF LREAL; // [var] | Q1_max | Max value of Q_1 a Total Reactive Power : ARRAY[0..2] OF LREAL; // [var] | Q_tot | total reactive power a Phi : ARRAY[0..2] OF LREAL; // [°] | phi | phase difference a Cos Phi : ARRAY[0..2] OF LREAL; // [] | COS(phi) |(P / S_1) a Power Factor : ARRAY[0..2] OF LREAL; // [] | PF | power factor (P / S) f Sum Apparent Power : LREAL; // [VA] | S_sum | Sum of apparent power 1..3 f Sum Active Power : LREAL; // [W] | P_sum | Sum of active power 1..3 f Sum Total Reactive Power : LREAL; // [var] | Qtot_sum | Sum of total reactive power 1..3 f Sum Reactive Power_1 : LREAL; // [var] | Q1_sum | Sum of abs fundamental reactive power 1..3 a Energy_Pos : ARRAY[0..2] OF ST_PMA_Energy; // [k Wh] | W_pos | Energy in positive direction a Energy_Neg : ARRAY[0..2] OF ST_PMA_Energy; // [k Wh] | W_neg | Energy in negative direction TF3650 Version: 1.5 139
## Page 140

PLC API a Energy_Res : ARRAY[0..2] OF ST_PMA_Energy; // [k Wh] | W | Resulting energy END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.5.5 ST_PMA_THD_3Ph Structure that summarizes the results of the corresponding function block. It can be queried via the property st Results. Details on the values contained can be found in the comment or in the description of the function block FB_PMA_Harmonics_Ph3 [} 102]. Syntax Definition: TYPE ST_PMA_THD_3Ph : STRUCT a THD_U : ARRAY[0..2] OF LREAL; // [] | THD_U | Total harmonic distortion of voltage | in percent a THD_U_Min : ARRAY[0..2] OF LREAL; // [] | THD_U_min | Min value of THD_U a THD_U_Max : ARRAY[0..2] OF LREAL; // [] | THD_U_max | Max value of THD_U a THD_I : ARRAY[0..2] OF LREAL; // [] | THD_I | Total harmonic distortion of current | in percent a THD_I_Min : ARRAY[0..2] OF LREAL; // [] | THD_I_min | Min value of THD_I a THD_I_Max : ARRAY[0..2] OF LREAL; // [] | THD_I_max | Max value of THD_I END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.6 E_PMA_Input Select The enumeration E_PMA_Input Select can be used to select whether the results to be calculated should relate to the current or voltage values. Syntax Definition: {attribute 'qualified_only'} {attribute 'strict'} TYPE E_PMA_Input Select : ( Voltage := 0, // Voltage selected Current := 1 // Current selected ) UDINT; END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 140 Version: 1.5 TF3650
## Page 141

PLC API 5.4.7 ST_PMA_Energy Structure for the output of energy values. The full kilowatt hours (k Wh) and the decimal places are output. Syntax Definition: TYPE ST_PMA_Energy : STRUCT n Energy : LINT; // Energy in k Wh f Energy Fraction : LREAL; // Fraction of energy in k Wh END_STRUCT END_TYPE Parameter Name Type Description n Energy LINT Energy in kilowatt hours (k Wh) as an integral value. f Energy Fraction LREAL Decimal places of the energy in kilowatt hours (k Wh). Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.4.8 E_PMA_Pqf Mode The E_PMA_Pqf Mode enumeration can be used to set the calculation mode for the Power Quality Factor (PQF). Syntax Definition: {attribute 'qualified_only'} {attribute 'strict'} TYPE E_PMA_Scaling Type : ( Default := 0, Default And Unbalance := 1, ) UDINT; END_TYPE Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 5.5 Global constants 5.5.1 GVL_PMA The power monitoring library contains the following constants in the PLC: {attribute 'qualified_only'} VAR_GLOBAL e Event Trace Level : Tc Event Severity := Tc Event Severity. Info; END_VAR TF3650 Version: 1.5 141
## Page 142

PLC API VAR_GLOBAL CONSTANT c MA_Max Dest : UDINT := 20; // maximum destinations for one analysis block c MA_Max ID : UDINT := 600; // maximum ID which can be used (=maximum numb er of analysis blocks c Mb RMS_Max Bands : UDINT := 300; // maximum number of bands usable in multiband rms c Max Quantiles : UDINT := 40; // maximum number of quantiles c Min Arg Log10 : LREAL := 2.3E-308; // min value to calculate logarithm END_VAR Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 142 Version: 1.5 TF3650
## Page 143

Examples 6 Examples General Two samples are available for single or three-phase systems. In the first sample, the highly dynamic analysis of electrical systems is shown. In the second sample, a combination of the high dynamic analysis with the frequency range analysis is used. On account of the higher computing power required for the frequency- based algorithms, these are executed in a separate, slower task. 6.1 Samples of calculations based on the signal period The samples show the highly dynamic analysis of electrical systems. For this purpose, we use the algorithms of the Power Monitoring library, whose calculations are based on the signal period. Overview An analysis chain is used in the samples. The function block IDs for linking the algorithms are defined in the structure E_Analysis IDs. The analysis chain begins either with an input from a bus terminal, for example the EL3783, or with the signal generator. Switching is done with the variable e Input Select. The input signal is transferred to the source function block (fb Source), which subsequently forwards the signal to the analysis function blocks assigned to it. This includes the frequency calculation with the function block (fb Frequency), the calculation of basic values with the function block (fb Basic Values), the calculation of power values with the function block (fb Power Values) and the calculation of harmonics with the function block (fb Harmonics). Program parameters The most important parameters for influencing the input signal are shown in the following table. Variable Description Default value e Input Select Selection of the input signal E_Input Select. Signal Generator f Frequency Base frequency of the generated signals 50 Hz f Amplitude Voltage Amplitude of the generated voltage signal 325.27 V f Amplitude Current Amplitude of the generated current signal 1.414 A f Phase Difference Cur Phase shift between the generated current and voltage signals 5 ° rent b Enable Harmonics Generation of harmonic components in the current and voltage FALSE signals Global constants The following global constants are defined: Variable Description Default value c Oversamples Number of oversamples of the input channels 10 c Samplerate Sample rate of the input channels in Hz 10000 c Num Harmonics Number of harmonics to be calculated 20 Download Single-phase sample program https://infosys.beckhoff.com/content/1033/ TF3650_TC3_Power_Monitoring/Resources/ 5517982603/.zip Three-phase sample program https://infosys.beckhoff.com/content/1033/ TF3650_TC3_Power_Monitoring/Resources/ 5517987211/.zip TF3650 Version: 1.5 143
## Page 144

Examples Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 6.2 Samples of calculations based on the frequency range The samples show the highly dynamic analysis of electrical systems in combination with the analysis in the frequency range. Overview Two analysis chains are used in the samples. The function block IDs for linking the algorithms are defined in the structure E_Analysis IDs. The analysis chains begin either with an input from a bus terminal, for example the EL3783, or with the signal generator. Switching is done with the variable e Input Select. The analysis chain for the high dynamic analysis is only executed in the MAIN program. The input signal is transferred to the source function block (fb Source_Period), which subsequently forwards the signal to the analysis function blocks assigned to it. This includes the frequency calculation with the function block (fb Frequency), the calculation of basic values with the function block (fb Basic Values), the calculation of power values with the function block (fb Power Values) and the calculation of harmonics with the function block (fb Harmonics). The buffer lengths correspond to the oversampling factor. The slower analysis chain for the analysis in the frequency range also starts in the MAIN program with the source function block (fb Source). This collects the incoming data up to the configured buffer length c Buffer Length and then sends them to the frequency-based function blocks for the power calculation (fb Power Values), for the calculation of the spectrum (fb Spectrum) and for the calculation of the harmonics (fb Harmonics) in the slower program MAIN_SLOW. Program parameters The most important parameters for influencing the input signal are shown in the following table. Variable Description Default value e Input Select Selection of the input signal E_Input Select. Signal Generator f Frequency Base frequency of the generated signals 50 Hz f Amplitude Voltage Amplitude of the generated voltage signal 325.27 V f Amplitude Current Amplitude of the generated current signal 1.414 A f Phase Difference Cur Phase shift between the generated current and voltage signals 5 ° rent b Enable Harmonics Generation of harmonic components in the current and voltage FALSE signals Global constants The following global constants are defined: Variable Description Default value c Oversamples Number of oversamples of the input channels 10 c Samplerate Sample rate of the input channels in Hz 10000 c FFTLength Length of the FFT 4096 c Window Length Internal buffer length with 50% overlap 3200 c Buffer Length Length of the input buffer for the FFT calculation 1600 c Harmonic Bands Number of harmonics to be calculated 20 c Freq Mode Base frequency for the calculation of harmonics 50.0 144 Version: 1.5 TF3650
## Page 145

Examples Download Single-phase sample program https://infosys.beckhoff.com/content/1033/ TF3650_TC3_Power_Monitoring/Resources/ 5517984907/.zip Three-phase sample program https://infosys.beckhoff.com/content/1033/ TF3650_TC3_Power_Monitoring/Resources/ 5517989515/.zip Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 6.3 Samples reuse The samples show the highly dynamic analysis of electrical systems in combination with the analysis in the frequency range. In addition, it shows how the analysis chains can be encapsulated and thus reused. Overview In this sample, two analysis chains are implemented for high dynamic analysis and two analysis chains for frequency range analysis. The function blocks FB_Power Monitoring_Fast and FB_Power Monitoring_Slow encapsulate the analysis chains and provide the option of instantiating the analysis chains multiple times. This requires an additional ID that internally adds an offset to the function block IDs. The additional ID is assigned in the programs MAIN as well as MAIN_SLOW. The function block IDs for linking the algorithms are defined in the structures E_Analysis IDs_Fast and E_Analysis IDs_Slow. The analysis chains begin either with an input from a bus terminal, for example the EL3783, or with the signal generator. Switching is done with the variable e Input Select. The analysis chain for the high dynamic analysis is only executed in the MAIN program. The input signal is transferred to the source function block (fb Source_Period), which subsequently forwards the signal to the analysis function blocks assigned to it. This includes the frequency calculation with the function block (fb Frequency), the calculation of basic values with the function block (fb Basic Values), the calculation of power values with the function block (fb Power Values) and the calculation of harmonics with the function block (fb Harmonics). The buffer lengths correspond to the oversampling factor. The slower analysis chain for the analysis in the frequency range also starts in the MAIN program with the source function block (fb Source). This collects the incoming data up to the configured buffer length c Buffer Length and then sends them to the frequency-based function blocks for the power calculation (fb Power Values), for the calculation of the spectrum (fb Spectrum) and for the calculation of the harmonics (fb Harmonics) in the slower program MAIN_SLOW. Program parameters The most important parameters for influencing the input signal are shown in the following table. Variable Description Default value e Input Select Selection of the input signal E_Input Select. Signal Generator f Frequency Base frequency of the generated 50 Hz signals f Amplitude Voltage Amplitude of the generated voltage 325.27 V signal f Amplitude Current Amplitude of the generated current 1.414 A signal f Phase Difference Current Phase shift between the generated 5 ° current and voltage signals TF3650 Version: 1.5 145
## Page 146

Examples Variable Description Default value b Enable Harmonics Generation of harmonic FALSE components in the current and voltage signals Global constants The following global constants are defined: Variable Description Default value c Oversamples Number of oversamples of the input channels 10 c Samplerate Sample rate of the input channels in Hz 10000 c FFTLength Length of the FFT 4096 c Window Length Internal buffer length with 50% overlap 3200 c Buffer Length Length of the input buffer for the FFT calculation 1600 c Harmonic Bands Number of harmonics to be calculated 20 c Freq Mode Base frequency for the calculation of harmonics 50.0 Download Single-phase sample program https://infosys.beckhoff.com/content/1033/ TF3650_TC3_Power_Monitoring/Resources/ 13424000011/.zip Three-phase sample program https://infosys.beckhoff.com/content/1033/ TF3650_TC3_Power_Monitoring/Resources/ 13424000523/.zip Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.0 PC or CX (x86, x64) Tc3_Power Monitoring 146 Version: 1.5 TF3650
## Page 147

Appendix 7 Appendix 7.1 FAQ In this section frequently asked questions are answered, in order to facilitate your work with the Twin CAT 3 power monitoring library. If you have further questions, please contact our support (-157). Which characteristic values can be calculated with the Twin CAT 3 power monitoring library? [} 147] Which characteristic values can be calculated with the Twin CAT 3 power monitoring library? The following characteristic values can be calculated: RMS, mean, maximum and minimum values of current, voltage, active, reactive, distortion reactive and apparent power, as well as frequencies and frequency spectra, total harmonic distortion, and the harmonic. 7.2 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on her internet pages: https://www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963 157 Fax: +49 5246 963 9157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service • repair service • spare parts service • hotline service Hotline: +49 5246 963 460 Fax: +49 5246 963 479 e-mail: service@beckhoff.com TF3650 Version: 1.5 147
## Page 148

Appendix Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963 0 Fax: +49 5246 963 198 e-mail: info@beckhoff.com web: https://www.beckhoff.com 148 Version: 1.5 TF3650
## Page 150

More Information: www.beckhoff.com/tf3650 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
