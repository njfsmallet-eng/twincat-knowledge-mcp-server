---
title: "TF6100 Twin CAT 3"
product: "TF6100"
category: "Communication"
tags: ["CAT", "OPC", "OPC_UA", "TWIN"]
language: "EN"
document_type: "Manual"
version: "1.4.0"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF6100_TC3_OPC_UA_Server_EN.pdf"
release_date: "2025-09-16"
---
Manual | EN TF6100 Twin CAT 3 | OPC UA Server 2025-09-16 | Version: 1.4.0
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 7 1.1 Notes on the documentation............................................................................................................. 7 1.2 For your safety.................................................................................................................................. 7 1.3 Notes on information security............................................................................................................ 9 1.4 Documentation issue status.............................................................................................................. 9 2 Overview.................................................................................................................................................. 10 3 Installation............................................................................................................................................... 12 3.1 System requirements...................................................................................................................... 12 3.2 Installation....................................................................................................................................... 13 3.3 Update installation........................................................................................................................... 16 3.4 Installation variants......................................................................................................................... 16 3.5 Licensing......................................................................................................................................... 17 4 Technical introduction............................................................................................................................ 21 4.1 Quick start....................................................................................................................................... 21 4.2 Quick Start (Twin CAT 2)................................................................................................................. 24 4.3 Initialization..................................................................................................................................... 28 4.4 Recommended steps...................................................................................................................... 34 4.5 Supported features.......................................................................................................................... 37 4.6 Software architecture...................................................................................................................... 39 4.7 Configurator.................................................................................................................................... 40 4.8 Optimizations.................................................................................................................................. 42 4.9 Application directories..................................................................................................................... 47 4.10 Data Access.................................................................................................................................... 49 4.10.1 Overview.......................................................................................................................... 49 4.10.2 Connection with the runtime............................................................................................. 50 4.10.3 Enabling symbols............................................................................................................. 53 4.10.4 Nodesets.......................................................................................................................... 70 4.10.5 Data types........................................................................................................................ 71 4.10.6 Arrays............................................................................................................................... 72 4.10.7 Enums.............................................................................................................................. 75 4.10.8 Structures......................................................................................................................... 76 4.10.9 Properties......................................................................................................................... 79 4.10.10 Status Code...................................................................................................................... 80 4.10.11 Analog Item Type............................................................................................................... 83 4.10.12 Description....................................................................................................................... 84 4.10.13 Read Only......................................................................................................................... 85 4.10.14 Pointers and references................................................................................................... 86 4.10.15 Type system..................................................................................................................... 86 4.10.16 DI Components................................................................................................................ 90 4.10.17 Device State...................................................................................................................... 91 4.10.18 Server State...................................................................................................................... 91 4.11 Historical Access............................................................................................................................. 92 4.11.1 Overview.......................................................................................................................... 92 TF6100 Version: 1.4.0 3
## Page 4

Table of contents 4.11.2 Supported functions......................................................................................................... 93 4.11.3 Configuration.................................................................................................................... 94 4.11.4 History Update.................................................................................................................. 96 4.11.5 Twin CAT Analytics........................................................................................................... 96 4.11.6 Access to historical data.................................................................................................. 97 4.12 Alarms and Conditions.................................................................................................................... 99 4.12.1 Overview.......................................................................................................................... 99 4.12.2 Supported functions......................................................................................................... 99 4.12.3 Configuration.................................................................................................................. 100 4.12.4 Additional application data............................................................................................. 103 4.12.5 Access to alarms and events......................................................................................... 105 4.13 Method calls.................................................................................................................................. 106 4.13.1 Overview........................................................................................................................ 106 4.13.2 Job methods................................................................................................................... 106 4.13.3 RPC methods................................................................................................................. 109 4.14 Twin CAT Event Logger.................................................................................................................. 112 4.14.1 Overview........................................................................................................................ 112 4.14.2 Configuration.................................................................................................................. 112 4.14.3 Access to alarms and events......................................................................................... 113 4.15 Global Discovery Server............................................................................................................... 117 4.15.1 Overview........................................................................................................................ 117 4.15.2 Push............................................................................................................................... 117 4.15.3 Pull................................................................................................................................. 118 4.16 Security......................................................................................................................................... 122 4.16.1 Overview........................................................................................................................ 122 4.16.2 Endpoints....................................................................................................................... 122 4.16.3 Certificate exchange...................................................................................................... 123 4.16.4 Authentication................................................................................................................ 125 4.16.5 Access rights.................................................................................................................. 127 4.17 File Transfer.................................................................................................................................. 130 4.17.1 Overview........................................................................................................................ 130 4.17.2 Configuration.................................................................................................................. 131 4.18 Reverse Connect.......................................................................................................................... 132 4.19 Redundancy.................................................................................................................................. 135 4.20 Logging......................................................................................................................................... 138 4.21 System Tray.................................................................................................................................. 140 5 PLC API.................................................................................................................................................. 141 5.1 Tc2_Opc Ua................................................................................................................................... 141 5.1.1 Data types...................................................................................................................... 141 5.1.2 Function blocks.............................................................................................................. 142 6 Samples................................................................................................................................................. 145 7 Tutorials................................................................................................................................................. 146 8 Appendix................................................................................................................................................ 147 8.1 Attributes and comments.............................................................................................................. 147 8.2 32-bit and 64-bit process............................................................................................................... 148 4 Version: 1.4.0 TF6100
## Page 5

Table of contents 8.3 Error diagnosis.............................................................................................................................. 150 8.4 ADS Return Codes........................................................................................................................ 153 8.5 Support and Service...................................................................................................................... 157 TF6100 Version: 1.4.0 5
## Page 6

Table of contents 6 Version: 1.4.0 TF6100
## Page 7

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. The documentation and the following notes and explanations must be complied with when installing and commissioning the components. The trained specialists must always use the current valid documentation. The trained specialists must ensure that the application and use of the products described is in line with all safety requirements, including all relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been compiled with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. Claims to modify products that have already been supplied may not be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, ATRO® , Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, MX-System®, Safety over Ether CAT®, TC/BSD®, Twin CAT®, Twin CAT/BSD®, Twin SAFE®, XFC®, XPlanar®, and XTS® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of the designations or trademarks contained in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Ether CAT® is a registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany. Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document, as well as the use and communication of its contents without express authorization, are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. Third-party trademarks Trademarks of third parties may be used in this documentation. You can find the trademark notices here: https://www.beckhoff.com/trademarks. 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. TF6100 Version: 1.4.0 7
## Page 8

Foreword Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 8 Version: 1.4.0 TF6100
## Page 9

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. 1.4 Documentation issue status Version Change 1.4.x New: Strings [} 72] 1.3.x Installation/System requirements [} 12]: Change system requirements server 1.2.x New: Installation [} 13]: Twin CAT 2 Setup Licensing [} 17]: Licensing under Twin CAT 2 Redundancy [} 135] 1.1.0 New: Quick Start [} 24] (Twin CAT 2) Supported features [} 37] Tutorials [} 146] TF6100 Version: 1.4.0 9
## Page 10

Overview 2 Overview OPC Unified Architecture (OPC UA) is the next generation of the familiar OPC standard. This is a globally standardized communication protocol via which machine data can be exchanged irrespective of the manufacturer and platform. OPC UA already integrates common security standards directly in the protocol. Another major advantage of OPC UA over the conventional OPC standard is its independence from the COM/DCOM system. Detailed information on OPC UA can be found on the web pages of the OPC Foundation. The Twin CAT 3 Function TF6100 OPC UA consists of several software components that enable data exchange with Twin CAT based on OPC UA. The following table provides an overview of the individual product components. Software component Description Twin CAT OPC UA Server Provides an OPC UA Server interface so that UA clients can access the Twin CAT runtime. Twin CAT OPC UA Client Provides OPC UA Client functionality to enable communication with other OPC UA Servers based on PLCopen-standardized function blocks and an easy- to-configure I/O device. Twin CAT OPC UA Configurator Graphical user interface for configuring the Twin CAT OPC UA Server. Twin CAT OPC UA Sample Client Graphical sample implementation of an OPC UA Client in order to carry out a first connection test with the Twin CAT OPC UA Server. Twin CAT OPC UA Gateway Wrapper technology that provides both an OPC COM DA Server interface and OPC UA Server aggregation capabilities. This documentation describes the Twin CAT OPC UA Server, which is an OPC UA server application that enables access to symbols from the Twin CAT real-time environment. The server can be operated either directly on the controller or on a gateway PC. Both relationships are shown in simplified form in the following diagram and are explained in more detail in chapter Installation variants [} 16]. 10 Version: 1.4.0 TF6100
## Page 11

Overview TF6100 Version: 1.4.0 11
## Page 12

Installation 3 Installation 3.1 System requirements The following system requirements apply for the installation and operation of this product. Server Technical data Description Operating system Windows 10 Windows CE 6/7 (only up to and including setup version 5.1.x) Windows Server 2022 Twin CAT/BSD Twin CAT/Beckhoff RT Linux® Target platforms PC architecture (x86, x64, Arm®) . NET Framework --- Twin CAT version Twin CAT 2, Twin CAT 3 Twin CAT installation level Twin CAT 2 CP, PLC, NC-PTP Twin CAT 3 XAE, XAR, ADS Required Twin CAT license TS6100 Twin CAT OPC UA (for Twin CAT 2) TF6100 TC3 OPC UA (for Twin CAT 3) Sample Client Technical data Description Operating system Windows 10 Windows Server 2022 Target platforms PC architecture (x86, x64, Arm®) . NET Framework 4.7.2 Twin CAT version Twin CAT 2, Twin CAT 3 Twin CAT installation level Twin CAT 2 CP, PLC, NC-PTP Twin CAT 3 XAE, XAR, ADS Required Twin CAT license --- Twin CAT 2/Twin CAT 3 compatibility This documentation is valid for both the Twin CAT 2 Supplement (TS6100) and the Twin CAT 3 Function (TF6100). If there are differences in individual sub-functions, a information box indicates this directly and provides additional explanations if necessary. Firewall port To enable communication with the Twin CAT OPC UA Server, the following network port must be opened in the firewall of the device: 4840/tcp (incoming) If, for example, the Twin CAT OPC UA Server is installed on a Beckhoff Industrial PC, this port must be opened as incoming communication in the operating system firewall. Hardware requirements The requirements of the Twin CAT OPC UA Server on the underlying industrial PC hardware depend strongly on the respective application scenario. In general, there are two metrics that are critical to server utilization: Main memory and CPU load. 12 Version: 1.4.0 TF6100
## Page 13

Installation The main memory load of the server varies depending on the number of symbols that are imported into the address space of the server via the Data Access [} 49] devices and on the number of simultaneous connections, subscriptions, historical access calls, … that an OPC UA client creates. However, the basic load of the server is based on the number of symbols and can be set to about 1024 bytes per symbol. With a symbol count of 1,000,000 symbols, for example, this means a main memory use of approx. 1024 Bytes * 1.000.000 Symbole = 1.024 Mbyte Note the main memory load of the industrial PC Please ensure that the industrial PC you are using has enough main memory. For an initial test, you can start up your project on your engineering PC and read the main memory load of the Twin CAT OPC UA Server in the Windows Task Manager. Be aware of operating system limitations, such as the 2 GB main memory limit for 32-bit processes. This affects, for example, the 32-bit variant of the Twin CAT OPC UA Server. If you need more than 2 GB of main memory for the process, you must use the 64-bit version of the server. The CPU load of the server, on the other hand, depends solely on the conditions prevailing at runtime, in particular the number of subscriptions and Monitored Items and their configuration parameters that an OPC UA client requests from the server. See chapter Optimizations [} 42] for more information. 3.2 Installation Depending on the Twin CAT version and operating system used, this Twin CAT 3 Function can be installed in different ways, which are described in more detail below. NOTICE Update installation An update installation always uninstalls the previous installation. Please make sure that you have backed up your configuration files beforehand. Twin CAT 2 Setup If you are using Twin CAT 2, you can install this supplement via a setup package, which you can download from the Beckhoff website at https://www.beckhoff.com/download. The installation can be done on either the engineering or runtime side, depending on the system you need the supplement for. Please note that under Twin CAT 2, the supplement is licensed directly during installation. A separate dialog prompts you to enter the license key. If you would like to install a 30-day trial version of the supplement, please enter DEMO as the license key. There is a separate setup download for Twin CAT 2 on Windows CE with the name TS6100-0030 OPC UA. This setup installs the CAB files, which you can then transfer to a Windows CE device and install them there. TF6100 Version: 1.4.0 13
## Page 14

Installation Twin CAT 3 Package Manager If you are using Twin CAT 3.1 Build 4026 (and higher) on the Microsoft Windows operating system, you can install this function via the Twin CAT Package Manager, see Installation documentation. Normally you install the function via the corresponding workload; however, you can also install the packages contained in the workload individually. This documentation briefly describes the installation process via the workload. NOTICE Unprepared Twin CAT restart can cause data loss The installation of this function may result in a Twin CAT restart. Make sure that no critical Twin CAT applications are running on the system or shut them down in an orderly manner first. Command line program Tc Pkg You can use the Tc Pkg Command Line Interface (CLI) to display the available workloads on the system and to install a specific workload. tcpkg list -t workload tcpkg install TF6100. Opc Ua Server. XAE tcpkg install TF6100. Opc Ua Server. XAR Twin CAT Package Manager UI You can use the User Interface (UI) to display all available workloads and install them if required. To do this, follow the corresponding instructions in the interface. Twin CAT 3 Setup If you are using Twin CAT 3.1 Build 4024 on the Microsoft Windows operating system, you can install this function via a setup package, which you can download from the Beckhoff website at https:// www.beckhoff.com/download. Depending on the system on which you need the function, the installation can be done on either the engineering or runtime side. The following screenshot shows an example of the setup interface using the TF6100 Twin CAT OPC UA Client setup. 14 Version: 1.4.0 TF6100
## Page 15

Installation To complete the installation process, follow the instructions in the Setup dialog. NOTICE Unprepared Twin CAT restart can cause data loss The installation of this function may result in a Twin CAT restart. Make sure that no critical Twin CAT applications are running on the system or shut them down in an orderly manner first. Twin CAT/BSD If you use Twin CAT/BSD as your operating system, you can install this function via the Twin CAT/BSD Package Server. For further information on the Twin CAT/BSD Package Server and its configuration, please refer to the Twin CAT/BSD documentation. To search for a package, you can use the following call in the Twin CAT/BSD console: pkg search TF6100 To install a function, you can use the following call in the Twin CAT/BSD console: doas pkg install TF6100-OPC-UA-Server-<version> Windows CE If you are using Microsoft Windows CE as your operating system, you can install this function via the respective CAB files, which you can download as separate files from the Beckhoff website at https:// www.beckhoff.com/download. After the download, the CAB files can be transferred to the Windows CE device via file transfer and executed there. The CAB files then install and register the function on the respective system. TF6100 Version: 1.4.0 15
## Page 16

Installation Always use the appropriate CAB file for your system. Specifically, this means: • CE-ARMV4I: Arm®-based devices, e.g. CX8190, CX9020 • CE-X86: x86-based devices, e.g. CX51xx, CX52xx, CX20xx The CAB file can be transferred to the device either via the CF/SD card or the FTP server integrated in Windows CE. Device restart After installing this function, a device restart is required so that the function can be used. 3.3 Update installation During an update installation, old application files are replaced by new ones. Backups of existing configuration files are created and saved in the form *.xml.bak in the application directory [} 47]. This also applies to the certificate directories. 3.4 Installation variants In the following, two installation variants are described, according to which the Twin CAT OPC UA Server can be installed depending on the application and infrastructure. 1. Server integrated directly into the control system 2. Operation of the server on a gateway PC Server integrated directly into the control system This scenario describes how the Twin CAT OPC UA Server should normally be operated. One of the biggest advantages of this software is that it can be integrated into even the smallest embedded platform, e.g. the CX8000 series. Thanks to this integration, general handling is very simple and convenient. OPC UA clients, e.g. HMI or MES/ERP systems, can establish a connection with the corresponding Twin CAT OPC UA Servers in the network and read and write symbol information originating from the Twin CAT runtime. This scenario has the following advantages: • Optimized network load, as OPC UA mechanisms such as subscriptions ("On Data Change communication") can be used. • Decentralized memory usage. Each Twin CAT OPC UA Server device is exclusively responsible for its own memory requirements, as only its "own" PLC symbols need to be provided in the server's address space. 16 Version: 1.4.0 TF6100
## Page 17

Installation • Secure communication right up to the control system. OPC UA features security mechanisms that are directly integrated in the protocol. Only the OPC UA server port is enabled in the controller firewall, which is then used for secure communication. In the case of the Reverse Connect [} 132] functionality, there is even no need to open the (incoming) firewall port. Operation of the server on a gateway PC This scenario describes the use of the Twin CAT OPC UA Server on a gateway PC. This use case is often used in Brownfield scenarios where existing control systems are to be given an OPC UA interface. In this case, the Twin CAT OPC UA Server is installed on a gateway PC (often referred to as an "edge PC") and connects one or more subordinate Twin CAT PLC controllers. Communication between the server and PLC then takes place via Twin CAT ADS. From a financial perspective, this scenario is very attractive, as only one Twin CAT OPC UA Server software license needs to be purchased. However, this scenario also has some technical disadvantages compared to integrating the server into the controller: • Network load can be very high depending on the number of devices and symbols present. The Twin CAT OPC UA Server uses cyclic ADS sampling to query symbol values quickly and efficiently from the Twin CAT runtime and must also be able to serve thousands of symbols simultaneously. The more symbols (and the more connected PLC controllers) there are, the more cyclic communication there is in the network. • The memory requirement on the central server is very high because the Twin CAT OPC UA Server has to import the symbol information from each Twin CAT PLC and store it in its address space. • Communication between the server and PLC is based on Twin CAT ADS, which only enables integrated encryption of the transport channel in newer Twin CAT versions. This may not yet be available for older systems as part of a Brownfield application. • The symbol files must be exchanged between the Twin CAT PLC and the central server each time the PLC program is changed. This step is not necessary if the server is operated directly in the PLC controller. 3.5 Licensing This Twin CAT product requires a license for full operation. In addition, a trial license can be activated in order to evaluate the product. For more information about licensing the product, see the following sections: • Licensing under Twin CAT 2 • Licensing of a 7-day trial version under Twin CAT 3 • Licensing of a full version under Twin CAT 3 TF6100 Version: 1.4.0 17
## Page 18

Installation Further information on Twin CAT 3 licensing can be found in the "Licensing" documentation in the Beckhoff Information System (Twin CAT 3 > Licensing). Licensing under Twin CAT 2 The product is licensed under Twin CAT 2 during installation; a corresponding text field allows you to enter a license key. To evaluate this product, you can activate it for a period of 30 days. To do this, enter "Demo" as the license key. Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 18 Version: 1.4.0 TF6100
## Page 19

Installation 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. TF6100 Version: 1.4.0 19
## Page 20

Installation 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". 20 Version: 1.4.0 TF6100
## Page 21

Technical introduction 4 Technical introduction 4.1 Quick start The following chapter provides a quick start to the Twin CAT OPC UA Server. In these instructions, you initialize the Twin CAT OPC UA Server in the delivery state, then create a Twin CAT PLC project and finally enable a PLC variable by setting a pragma via OPC UA. The variable is then available in the address space of the server. The action steps are described in more detail below in the order in which they are performed: • Initialization of the server • Creating a Twin CAT PLC project • Activating the download of the symbol files • Adding a product license • Enabling a variable • Connecting an OPC UA client Initialization of the server After installation, the server needs to be initialized [} 28] once according to the so-called TOFU principle (Trust-On-First-Use). Here you configure a user account, which is then required to establish a connection with the server. As this is a central and security-relevant topic, initialization [} 28] is explained in detail in a separate documentation chapter. The further steps in this section assume that this process has been carried out once and that you have initialized the server with a user account. Tools for initializing the server You can use the Twin CAT OPC UA Configurator to initialize the server. This may require the installation of an additional software package. Creating a Twin CAT PLC project (download of symbol files) 1. Open the Twin CAT XAE Shell (or Visual Studio). 2. In the File menu, select the command New > Project. 3. Add an empty PLC project to the project. 4. Activate the automatic download of the TMC file in the properties of the PLC project, as shown in the following screenshot. ð A new Twin CAT project has been created. TF6100 Version: 1.4.0 21
## Page 22

Technical introduction Adding a product license ü Check whether a TF6100 license is available in the Twin CAT XAE license dialog. 1. If not, you can use a 7-day trial license as part of this Quick Start Tutorial. Enabling a variable 2. Add a new variable of data type INT to the MAIN program. 3. Set the pragma on this variable to enable the variables via OPC UA. {attribute 'OPC. UA. DA' := '1'} n My Counter : INT; 4. In the implementation part of the MAIN program, increment this variable by 1 each cycle. n My Counter := n My Counter + 1; 5. Activate the Twin CAT project on your system. Connecting an OPC UA client An OPC UA client uses the so-called Server URL to connect to a server. The Server URL contains the IP address or the host name of the device on which the server was installed. In this tutorial, we assume that the client and server are running on the same system. The client thus connects to the following Server URL: opc.tcp://localhost:4840 As a client, we use the Twin CAT OPC UA Sample Client, which is part of the TF6100 product package. After installation, it can be called up via the Windows start menu. 22 Version: 1.4.0 TF6100
## Page 23

Technical introduction The Server URL to the local host is already entered by default in the Twin CAT OPC UA Sample Client. 1. Click on the Get Endpoints button. ð If you are using the Sample Client for the first time, a dialog box appears to accept settings for generating application certificates. 2. Confirm the dialog box with the Create button. ð All connection endpoints are now read from the server and displayed. 3. Select the endpoint "Sign And Encrypt:Basic256Sha256:Binary" and click on the Connect button. TF6100 Version: 1.4.0 23
## Page 24

Technical introduction 4. Enter the data for the user account that you configured in the first step of this documentation article for initializing the server. 5. Click OK. ð You are now connected to the server. The address space of the server is displayed in a tree structure on the left-hand side of the application and you can navigate through the symbolism of the PLC program. In this example, we have enabled a PLC variable for OPC UA. These can be found at the following path: Root \ Objects \ PLC1 \ MAIN \ n My Counter You can add the variable to the "Watchlist" by double-clicking on it. This means that a subscription is created for the variable and the variable value is transferred from the server to the client in the event of a value change. 4.2 Quick Start (Twin CAT 2) The following chapter provides a quick start to the Twin CAT OPC UA Server if it is operated under Twin CAT 2. In these instructions, you initialize the Twin CAT OPC UA Server in the delivery state, then create a Twin CAT PLC project and finally enable a PLC variable by setting a comment via OPC UA. The variable is then available in the address space of the server. The action steps are described in more detail below in the order in which they are performed: • Initialization of the server • Creating a Twin CAT PLC project • Activating the download of the symbol files • Enabling a variable • Connecting an OPC UA client 24 Version: 1.4.0 TF6100
## Page 25

Technical introduction Initialization of the server After installation, the server needs to be initialized [} 28] once according to the so-called TOFU principle (Trust-On-First-Use). Here you configure a user account, which is then required to establish a connection with the server. As this is a central and security-relevant topic, initialization [} 28] is explained in detail in a separate documentation chapter. The further steps in this section assume that this process has been carried out once and that you have initialized the server with a user account. Tools for initializing the server You can use the Twin CAT OPC UA Configurator to initialize the server. This may require the installation of an additional software package. Creating a Twin CAT PLC project and activating the download of the symbol files Create a new project in Twin CAT PLC Control or open your existing PLC project. Open the project properties and activate the “Download Symbol description” option so that the symbol file (*.tpy) of the PLC program is transferred to the boot directory of the target device when it is activated. Enabling a variable 1. Add a new variable of data type INT to the MAIN program. 2. Set the comment on this variable to enable the variables via OPC UA. A text can be defined via the "Description", which is also displayed as a Description attribute at the respective node in the OPC UA address space. n My Counter : INT; (*~ (OPC:1:some description) *) 3. You can mark the variable as read-only with an additional comment. Write operations via OPC UA are then rejected by the server with the status code Bad Not Writeable. n My Counter : INT; (*~ (OPC:1:some description) (OPC_PROP[0005]:1:read-only flag) *) 4. You can use the following comment to define an alias for the variable, i.e. specify a different name for the variable in the OPC UA namespace. The value you specify for x then corresponds to the new variable name. n My Counter : INT; (*~ (OPC:1:some description) (OPC_PROP[0005]:1:read-only flag) (OPC_UA_PROP[5100]:x:alias name) *) TF6100 Version: 1.4.0 25
## Page 26

Technical introduction 5. In the implementation part of the MAIN program, increment this variable by 1 each cycle. n My Counter := n My Counter + 1; 6. Activate the Twin CAT project on your system. Connecting an OPC UA client An OPC UA client uses the so-called Server URL to connect to a server. The Server URL contains the IP address or the host name of the device on which the server was installed. In this tutorial, we assume that the client and server are running on the same system. The client thus connects to the following Server URL: opc.tcp://localhost:4840 As a client, we use the Twin CAT OPC UA Sample Client, which is part of the TF6100 product package. After installation, it can be called up via the Windows start menu. The Server URL to the local host is already entered by default in the Twin CAT OPC UA Sample Client. 1. Click on the Get Endpoints button. ð If you are using the Sample Client for the first time, a dialog box appears to accept settings for generating application certificates. 26 Version: 1.4.0 TF6100
## Page 27

Technical introduction 2. Confirm the dialog box with the Create button. ð All connection endpoints are now read from the server and displayed. 3. Select the endpoint "Sign And Encrypt:Basic256Sha256:Binary" and click on the Connect button. 4. Enter the data for the user account that you configured in the first step of this documentation article for initializing the server. 5. Click OK. ð You are now connected to the server. The address space of the server is displayed in a tree structure on the left-hand side of the application and you can navigate through the symbolism of the PLC program. In this example, we have enabled a PLC variable for OPC UA. These can be found at the following path: Root \ Objects \ PLC1 \ MAIN \ n My Counter You can add the variable to the "Watchlist" by double-clicking on it. This means that a subscription is created for the variable and the variable value is transferred from the server to the client in the event of a value change. TF6100 Version: 1.4.0 27
## Page 28

Technical introduction 4.3 Initialization Starting with setup version 4.4.0, the Twin CAT OPC UA Server requires an initialization phase, which is based on the TOFU principle (Trust On First Use). This means that the server must be actively initialized by the user so that it can be used for its various functions (Data Access, Historical Access, etc.). By default, the server allows clients to establish an unauthenticated connection ("Anonymous"). The one- time TOFU initialization now requires the configuration of an operating system user that an OPC UA client must subsequently use to successfully log on to the server. For this purpose, the server provides only a special initialization namespace in the uninitialized state. This namespace contains an object "Initialization" with a method "Trust On First Use". The method defines the following input/output parameters: 28 Version: 1.4.0 TF6100
## Page 29

Technical introduction Parameter Description [in] Username Username for the operating system user to be created. If the user already exists, the server attempts to perform a test login with the specified password and, if successful, transfers the existing user to its security configuration. [in] Password Password for the operating system user. The password is not stored in the server configuration, but is only available in the user database of the operating system. Please note that the type of password may depend on any security settings of the operating system (keyword "complex passwords"). [out] Add Status Indicates whether the creation of the operating system user was successful or whether the user already exists. [out] Logon Result Indicates whether the server was able to login to the operating system with the specified username/password combination. This is a good way to check if you have entered the wrong password if the user already exists. [out] OPC UA Statuscode The regular OPC UA Status Code when calling a method. If the method has been called successfully on OPC UA level, this status code returns GOOD, otherwise BAD. The server is initialized by calling this method. The method tries to create a user specified by the user in the lower-level operating system of the server. If this is successful, the user is automatically added to the security configuration (Tc Ua Security Config.xml) of the server and defined as server administrator. After an automatic restart of the server at the end of the method call, an OPC UA client can then log on to the server with this user. If a specified user already exists in the operating system, this is indicated by an output parameter (Add Status). In this case, the server attempts to log on to the operating system with the specified password. If this logon process is successful, the user is entered in the server's security configuration and the initialization is successfully completed by an automatic restart of the server. If the logon to the operating system fails (e.g. because the wrong password was entered), this is indicated by an output parameter (Logon Result) and the initialization is not continued. This prevents you from accidentally trying to initialize the server with a wrong username/password combination and thus "locking yourself out". TF6100 Version: 1.4.0 29
## Page 30

Technical introduction Expiration of a user password When the OPC UA server creates an operating system user, it is not explicitly enabled for this user that the password does not expire. Here the settings of the operating system are adopted, where the maximum password age is defined in the password policies. If the maximum password age is set to 0, passwords do not expire; otherwise they do so after the number of days specified in the operating system. The following diagram illustrates this process once again in a highly simplified form: 30 Version: 1.4.0 TF6100
## Page 31

Technical introduction After restarting the server, an OPC UA client must use the operating system user used for initialization for authentication when establishing a connection. The following screenshots show the entire process using the OPC UA client "UA Expert" as an example. In this example, we assume that the user does not yet exist in the operating system and is therefore created by the server. TF6100 Version: 1.4.0 31
## Page 32

Technical introduction Step 1: OPC UA Client connects to the server for the first time The server has been installed and UA Expert connects to the server for the first time. Anonymous access can still be used for this connection. After the connection has been established, the initialization object together with the Trust On First Use method can be found in the server's address space. Step 2: OPC UA Client starts Trust On First Use The Trust On First Use method can be called via any OPC UA client, e.g. the UA Expert. However, Beckhoff's own configuration tools also allow the use of this initialization interface. The Twin CAT OPC UA Configurator (standalone or Visual Studio integrated) automatically detects an uninitialized server when a connection is established and enables initialization via a corresponding configuration interface: 32 Version: 1.4.0 TF6100
## Page 33

Technical introduction The following steps show the same process as it can be done manually e.g. in the UA Expert software: In the UA Expert, the Trust On First Use method is called to create a user and configure the server for this user. "My Opc Ua Server User" was used as the username in this example. The password must meet the complexity requirements of the operating system, otherwise the initialization will fail. The following screenshot shows the successful call of the method. The parameter Add Status indicates that the user was successfully created in the operating system's user database. The parameter Logon Result indicates that an initial test authentication of the server with the specified user information was successful. The server restarts automatically after this successful method call. Step 3: OPC UA client logs on to the initialized server Username/password disables anonymous access Please note that the UA Expert cannot automatically reconnect to the server after the method call, because the anonymous access has been disabled and from now on the logon must be done using the specified username. TF6100 Version: 1.4.0 33
## Page 34

Technical introduction Once the connection has been established, the regular namespaces and objects can be found again in the server's address space and the configuration of the application can begin. Permissions of the TOFU user The user configured by the TOFU mechanism has full access to the server, which may not be desirable. Beckhoff therefore recommends creating an explicit user for pure data access in the next step, see Recommended steps. 4.4 Recommended steps After the initial commissioning, Beckhoff recommends that you pay attention to the following points to further configure the server and ensure a stable and secure operating environment. Data Access Data Access describes a function of OPC UA for displaying symbols and the corresponding access to them in the address space of the server. In the Twin CAT OPC UA Server, the configuration of data access devices is an elementary component and the basis for further functionalities. We therefore recommend that you read our chapter on Data Access [} 49] in the next step, which also describes how you can establish a connection with the runtime [} 50]. Only use secure Identity Tokens The one-time initialization of the server disables the Identity Token "Anonymous". For security reasons, you should leave this disabled. The server should only be accessed by authenticated client applications, such as the username/password authentication configured by default during initialization. 34 Version: 1.4.0 TF6100
## Page 35

Technical introduction Creation of a user for pure data access The aforementioned initialization of the server configures a user for access to the server and then disables anonymous access to the server. The configured user has full access to all objects in the server namespace. In most application scenarios, this is not desired and the administrator user should be separated from the application user. Beckhoff therefore recommends configuring an additional, dedicated user who is given the necessary permissions to access variables on a Data Access device, but who is not allowed to access the configuration namespace. This setting can be made via the configurator by adding a new user who is assigned to the "Users" group. The newly configured user then has all the necessary permissions to access Twin CAT variables, to read the type system, but not to influence the configuration of the server. Please note that if you use the authentication provider "OS", you must also create the user in the operating system, i.e. it must exist there. NOTICE Leave insecure endpoints disabled ü Endpoints classified as unsafe are not offered by the Twin CAT OPC UA Server by default. These can be made available in the server via a configuration switch - Beckhoff does not recommend this! a)Only use endpoints that are currently considered secure. b)Observe and follow the other safety-relevant recommendations in the following section. The following screenshot shows you how to enable older server endpoints in the Twin CAT OPC UA Configurator. TF6100 Version: 1.4.0 35
## Page 36

Technical introduction You can then add the insecure endpoints back to the server configuration, for example via the context menu in the configurator in the "Security Settings" area: The None/None endpoint is already disabled when the server is delivered. For security reasons, Beckhoff recommends that you also leave this endpoint disabled and only allow access to the server via a secure endpoint. If required, the None/None endpoint can be added back to the server configuration using the method described above. Disable 'Automatically Trust All Client Certificates' By default, the server is configured for easy commissioning so that it automatically trusts all client certificates without having to manually exchange certificates on the server side. For security reasons, Beckhoff recommends disabling this setting. This setting can be made via the Twin CAT OPC UA Configurator, as shown in the following screenshot: After disabling this setting, a trust relationship must be established between the client and server by both applications trusting each other's certificates. 36 Version: 1.4.0 TF6100
## Page 37

Technical introduction 4.5 Supported features OPC UA offers a large number of features. This product may not support all features from the very beginning. Further features will be added over time through product updates. The following table shows a list of all currently supported functionalities of the current product version. Compatibility with the OPC UA Pub/Sub specification The current version of this product is compatible with the OPC UA Pub/Sub specification version 1.05.03. Certification profile The current version of this product is certified for the "Standard UA Server" profile. The Conformance Units checked in this certification are documented by the OPC Foundation. Specification The OPC UA specification is divided into different parts. Parts 1 to 5 define the core functionalities of OPC UA. The following table provides an overview of the various parts of the specification and indicates whether this product offers corresponding support. Below you will find additional detailed information on the supported functions from the respective part, if applicable. Please note that not all parts can be supported, as some parts of the specification are outside the product definition. Part Supported OPC10000-1 Overview and Concepts Yes OPC10000-2 Security Model Yes OPC10000-3 Address Space Model Yes OPC10000-4 Services Yes OPC10000-5 Information Model Yes OPC10000-6 Mappings Yes OPC10000-7 Profiles Yes OPC10000-8 Data Access Yes OPC10000-9 Alarms & Conditions Yes OPC10000-10 Programs No OPC10000-11 Historical Access Yes OPC10000-12 Discovery and Global Services Yes OPC10000-13 Aggregates No OPC10000-14 Pub/Sub No *1 OPC10000-15 Safety No OPC10000-16 State Machines No OPC10000-17 Alias Names No OPC10000-18 Role-Based Security No *2 OPC10000-19 Dictionary References No OPC10000-20 File Transfer Yes OPC10000-21 Device Onboarding No OPC10000-22 Base Network Model --- OPC10000-23 Common Reference Types --- OPC10000-24 Scheduler No *1: OPC UA Pub/Sub is mapped by the product TF6105 TC3 OPC UA Pub/Sub *2: This product includes its own user rights implementation, which already existed before the release of Part 18 and implements a user/group-based authorization system [} 127]. TF6100 Version: 1.4.0 37
## Page 38

Technical introduction OPC10000-4 Services The following table provides an overview of the services (Service Sets, Service Behaviors, etc.) supported by this product as described in Part 4 of the OPC UA specification. Feature Supported Attributes Read/Write Yes Attributes History Read Yes (Value attribute) Attributes History Update Yes (Value attribute) Subscriptions Yes Durable Subscriptions No Monitored items Yes Method Calls Yes Auditing No Redundancy No OPC10000-8 Data Access The following table provides an overview of the Data Access functions supported by this product as described in Part 8 of the OPC UA specification. Feature Supported Data Item Type Yes Analog Item Type Yes Discrete Item Type Yes *1 Array Item Type Yes EUInformation Yes *1 Complex Number Type Yes *1 Double Complex Number Type Yes *1 Axis Information Yes *1 Axis Scale Enumeration Yes *1 XVType Yes *1 Object Types Yes (Function Blocks) Structured Types Yes Server Timestamp Yes Source Timestamp Yes Quality Yes *1: Supported via the Nodeset import and TE6100 OPC UA Nodeset Editor. OPC10000-9 Alarms & Conditions The following table provides an overview of the Alarms & Conditions functions supported by this product as described in Part 9 of the OPC UA specification. Feature Supported Limit Alarm Type Yes Off Normal Alarm Type Yes Multi-Language Alarm-/Eventtexts Yes Twin CAT 3 Event Logger Yes *1 Custom Event Types Yes *2 Custom Alarm Types Yes *2 *1: Support of the Twin CAT 3 Event Logger via proprietary Alarm/Event Types *2: Supported via the Nodeset import and TE6100 OPC UA Nodeset Editor. 38 Version: 1.4.0 TF6100
## Page 39

Technical introduction OPC10000-11 Historical Access The following table provides an overview of the Historical Access functions supported by this product as described in Part 11 of the OPC UA specification. Feature Supported Historical Data Nodes [} 92] Yes Historical Event Nodes No Historical Audit Events No History Update [} 96] Yes External History Sources No OPC10000-20 File Transfer This product supports the OPC UA-side exchange of configuration files, which are used for commissioning the product. A generic File Transfer [} 130] functionality is implemented in the OPC UA server of the Beckhoff Device Manager software. Security The following table provides an overview of the Security features supported by this product. Some of the features shown here are split across several parts of the specification. Feature Supported Secure Channel Yes Secure Endpoints [} 122] Yes Application Instance Certificate Yes Certificate Trust Relationship Yes Identity Token Anonymous Yes Identity Token Username/Password Yes Identity Token user certificates Yes User rights at Namespace level Yes User rights at Node level Yes 4.6 Software architecture You do not need to know the internal software architecture of this product to use it, but it may be of interest in some cases. This is why we will briefly introduce you to them below. The Twin CAT OPC UA Server essentially consists of the following components: • The process in the operating system • The application in the Windows System Tray [} 140] • The PLC library Tc2_Opc Ua [} 141] The interaction of the individual components is described in more detail in the following diagram: TF6100 Version: 1.4.0 39
## Page 40

Technical introduction Process in the operating system The process in the operating system (Tc Opc Ua Server.exe) takes care of the OPC UA protocol functions (i.e. communication with the OPC UA clients), the provision of the OPC UA address space and communication with the lower-level devices [} 49]. Furthermore, the process provides an ADS server interface so that the PLC library Tc2_Opc Ua and the Windows System Tray application can interact with the server application. Windows System Tray application This application enables the triggering of a restart of the Twin CAT OPC UA Server. The corresponding function can be called up via the icon in the Windows System Tray. PLC library The PLC library Tc2_Opc Ua enables interaction with the Twin CAT OPC UA Server both for retrieving status information and for triggering a restart. 4.7 Configurator Two graphical user interfaces are available for simple configuration of the Twin CAT OPC UA Server as part of the Twin CAT OPC UA Configurator: an interface integrated into Visual Studio (or the XAE Shell) and a standalone tool. Documentation for the Twin CAT OPC UA Configurator Although the Twin CAT OPC UA Configurator is discussed in various sections of this documentation, it also has its own product documentation, which can be found in the Beckhoff information system. Configuration via OPC UA The Twin CAT OPC UA Server contains a so-called configuration namespace, which enables local and remote configuration of the server via OPC UA. The Twin CAT OPC UA Configurator makes use of this interface to access the individual configuration files of the server. The following functionalities are mapped in the configuration namespace: • Management of the server configuration files 40 Version: 1.4.0 TF6100
## Page 41

Technical introduction • Management of the certificates • Restarting the server After initializing [} 28] the server, the user configured there has access to the configuration namespace and can be used to further configure the server. The following screenshot shows the configuration namespace from the perspective of an OPC UA client (in this example, the UA Expert from Unified Automation): All server configuration files are available as objects of type File Type. This object type and access to it is standardized by OPC UA. Certificate files are created in the configuration namespace as Certificate Type. Management of certificates Client certificates are divided into "Rejected" and "Trusted" certificates, which is represented by a separate folder in the namespace. A certificate can be moved between the trusted lists by calling the method Move() on a certificate object. In addition, various properties provide additional information about the certificates themselves for easier identification. TF6100 Version: 1.4.0 41
## Page 42

Technical introduction The Twin CAT OPC UA Configurator provides you with a user interface to make it easier to trust/reject certificates. Further information can be found in chapter Certificate exchange [} 123]. Restarting the server The configuration namespace contains a method with which the Twin CAT OPC UA Server can be restarted without the need for a Twin CAT restart. 4.8 Optimizations There are various ways to optimize the communication connection between OPC UA client and server or PLC. The runtime behavior, in particular the CPU and memory load of the Twin CAT OPC UA Server, can also be optimized using various parameters. This chapter presents various optimization options, in particular on the following topics: • Sampling Interval vs. Publishing Interval • Structured Types • Structured Types and their member variables 42 Version: 1.4.0 TF6100
## Page 43

Technical introduction The screenshots and performance values shown here represent examples under laboratory conditions, which were run on different hardware devices. Therefore, they cannot be transferred 1:1 to customer projects and only serve to illustrate certain facts. Sampling Interval vs. Publishing Interval When creating a subscription, an OPC UA client uses various parameters for the subscription and the so- called Monitored Items contained in it to receive notifications about variable changes. The following table explains two of these parameters, which will then be described in more detail. Parameter Description Publishing Interval The Publishing Interval specifies the rate at which an OPC UA client is informed about value changes by the server. The Publishing Interval is described in detail in Part 4 of the OPC UA specification. Sampling Interval The Sampling Interval specifies the rate at which the OPC UA server should sample its underlying data source for value changes, in the case of the Twin CAT OPC UA Server via the ADS connection. The Sampling Interval is described in detail in Part 4 of the OPC UA specification. The following figure illustrates the relationship between these two parameters once again. It is assumed here that the Twin CAT OPC UA Server has been installed on the PLC controller and that the OPC UA client accesses the server from an external system. As can be seen in the figure, the situation can arise that the OPC UA client does not notice certain value changes in the PLC, e.g. if they happen "too fast" in the PLC or the sampling rate is not high enough or a variable value returns to the original value (as can be seen above). Via another parameter, the so-called Queue Size, several value changes between the Publishing Intervals can be recorded and transferred to the OPC UA client. In the above example, a Queue Size of 1 was selected, i.e. the "Last Known Value" is always transferred to the client. In the following figure, on the other hand, a Queue Size of 2 was selected, i.e. the last two known value changes are transmitted to the client. TF6100 Version: 1.4.0 43
## Page 44

Technical introduction With the first Publish Response it can be seen that only one value change is transmitted to the client, because also only one value change has taken place in the PLC. With the second Publish Response it can be seen that two value changes have occurred in the PLC and both are also transmitted to the client. The parameters described above are settings that the client usually controls and requests from the server. And it is exactly here that many optimizations can be made, because both parameters have a strong influence on how much CPU time the OPC UA client and server need, since a corresponding amount of information has to be processed or requested. Depending on the application scenario used, the two parameters should be set appropriately. For example, if the OPC UA client is a visualization, then fast Publishing Intervals and Sampling Rates make only limited sense, since the human eye cannot process information faster than ~200 ms anyway. The use of the Queue Size should also be chosen sensibly depending on the situation. If the OPC UA client does not process any values from the queue anyway, a Queue Size of 1 is sufficient and makes sense, since correspondingly less information has to be transferred and this further optimizes the system. In the following example an OPC UA client has created a subscription with 10,000 variables on the Twin CAT OPC UA Server. 500 ms was selected as the Publishing Interval and 250 ms as the Sampling Interval. The CPU load of the Twin CAT OPC UA Server was at an average value of about 6.9%, see the following screenshot of the Windows Performance Monitor. 44 Version: 1.4.0 TF6100
## Page 45

Technical introduction Then the Publishing Interval was set to 200 ms and the Sampling Interval to 100 ms. This increased the CPU load of the Twin CAT OPC UA Server to an average value of approx. 19%. Structured Types By default, the Twin CAT OPC UA Server provides structures [} 76] as Folder Type in its address space. The member variables are then displayed as separate nodes below the folder and can be accessed. The server also allows the use of Structured Types for the structure, whereby the type information of the structure is processed by the client and the structure can be read/written in a data-consistent manner. When communicating with the PLC (via the Twin CAT ADS protocol), the two variants behave fundamentally differently. TF6100 Version: 1.4.0 45
## Page 46

Technical introduction When an OPC UA client accesses individual member variables, the ADS communication may well be split into multiple ADS read/write commands, depending on the number of variables. This in turn can result in the ADS commands being processed by the PLC in different PLC cycles. Data consistency cannot therefore be guaranteed. When an OPC UA client accesses a Structured Type, on the other hand, it is ensured that the Structured Type is processed by the PLC in a single ADS Read/Write command, thus ensuring data consistency. When using Structured Types for large PLC data structures, the following should be considered: • Depending on the structure size, the ADS read/write command or the corresponding response can become very large and require a correspondingly large amount of memory in the Twin CAT ADS router. Therefore, please pay attention to the router memory. • Structured Types must be encoded or decoded by the Twin CAT OPC UA Server when communicating with the Twin CAT real-time environment, which requires additional CPU time. • Depending on the size of the structure, read/write commands can take a long time, which is also heavily dependent on the time the server needs to encode/decode. For these reasons, the maximum size of a Structured Type is limited in the delivery state of the server, but can be adjusted as required using the parameter <Max Structure Size> in the configuration file Tc Ua Da Config.xml. This parameter specifies the maximum size of a structure in bytes. If a structure exceeds <Max Structure Size>, it is imported as Folder Type, where each structure element is available as a single node. For more information, see the chapter Structures [} 76]. Especially in connection with the parameters for the Sampling Interval and Publishing Interval that can be set for a subscription, some optimizations can be made with Structured Types, which can have a major influence on the runtime behavior of the server. In the following sample, an OPC UA client has created a subscription to a Structured Type. The lower-level PLC data structure is structured as follows: TYPE ST_TEST : STRUCT st Complex : ST_Complex_1; str String5 : STRING[5]; e Enum : E_Enum_1; str String3 : STRING[3]; arr Complex : ARRAY[0..9999] OF ST_Complex_1; arr Dint : ARRAY[0..9999] OF DINT; END_STRUCT END_TYPE The structure ST_Complex_1 used as member variable is about 91 bytes. In total, this is a data structure with a size of about 1 MB. 500 ms was selected as the Publishing Interval and 250 ms as the Sampling Interval. The CPU load of the Twin CAT OPC UA Server after creating the subscription was at an average value of about 54.6%, see the following screenshot of the Windows Performance Monitor. 46 Version: 1.4.0 TF6100
## Page 47

Technical introduction According to the selected Sampling Interval, an ADS Read is sent every 250 ms for the lower-level ADS communication. In the corresponding response you can clearly see the size of the data structure of approx. 1 MB, i.e. every 250 ms a 1 MB data packet is transported through the Twin CAT ADS router (and must be processed accordingly by the server). The encoding/decoding process from the server requires a lot of CPU power, which explains the high CPU load. Structured Types and their member variables By default, the member variables of a Structured Type are represented and made available as separate nodes in the server's address space. This requires additional main memory, because the Twin CAT OPC UA Server allocates main memory for each node. An OPC UA client that works exclusively with the Structured Type, i.e. the "root element" of a structure, does not require these additional nodes. These can be explicitly hidden using a special pragma, which reduces the server's memory load. The pragma is described in more detail in the chapter Structures [} 76]. 4.9 Application directories This application uses various directories to store relevant information, e.g. configuration or certificate files. Installation directory The base installation directory of the application is always relative to the Twin CAT installation directory on all operating systems. %Tc Install Dir%\Functions\TF6100-OPC-UA The application is then installed in the following directory below this directory. A distinction is made here according to platform (x86/x64). TF6100 Version: 1.4.0 47
## Page 48

Technical introduction %Tc Install Dir%\Functions\TF6100-OPC-UA\Win32\Server %Tc Install Dir%\Functions\TF6100-OPC-UA\Win64\Server Base directory for PKI infrastructure Certificate files, which are used to establish a secure communication connection, are stored in the following directory on all operating systems: %Tc Install Dir%\Functions\TF6100-OPC-UA\Win32\Server\PKI %Tc Install Dir%\Functions\TF6100-OPC-UA\Win64\Server\PKI Directory for trusted certificates Client certificates in this directory are declared as "trusted". This path is identical on all operating systems. %Tc Install Dir%\Functions\TF6100-OPC-UA\Win32\Server\PKI\CA\trusted %Tc Install Dir%\Functions\TF6100-OPC-UA\Win64\Server\PKI\CA\trusted Directory for rejected certificates Client certificates in this directory are declared as "rejected". This path is identical on all operating systems. %Tc Install Dir%\Functions\TF6100-OPC-UA\Win32\Server\PKI\CA\rejected %Tc Install Dir%\Functions\TF6100-OPC-UA\Win64\Server\PKI\CA\rejected Directory for the server certificate The directories for the server certificate are defined as follows, whereby a distinction is made between the directory for the public key ("certs") and private key ("private"). %Tc Install Dir%\Functions\TF6100-OPC-UA\Win32\Server\PKI\CA\own\certs %Tc Install Dir%\Functions\TF6100-OPC-UA\Win64\Server\PKI\CA\own\private Log files Log files are stored in the following directory. There is a distinction according to the operating system. %Tc Install Dir%\Functions\TF6100-OPC-UA\Win32\Server (Windows) %Tc Install Dir%\Functions\TF6100-OPC-UA\Win64\Server (Windows) /var/log/TF6100-OPC-UA-Server (Twin CAT/BSD) Configuration files The Twin CAT OPC UA Server uses various configuration files to configure the individual functions, which are defined as listed in the table below. All configuration files are located in the installation directory of the server (see above) and are usually configured via the Twin CAT OPC UA Configurator. 48 Version: 1.4.0 TF6100
## Page 49

Technical introduction File Description Tc Ua Ac Config.xml Configuration file for the Alarms & Conditions [} 99] (A&C) functionality of the server. The nodes configured for A&C are saved in this file. Tc Ua Da Config.xml Configuration file for the Data Access [} 49] (DA) functionality of the server. The communication connections with the lower-level ADS devices are configured in this file. Tc Ua Gds Client Config.xml Configuration file for the Global Discovery Server [} 117] configuration. The connection to a GDS is configured in this file. Tc Ua Ha Config.xml Configuration file for the Historical Access [} 92] (HA) configuration of the server. This file stores both the data memories used for HA and the nodes configured for this purpose. Tc Ua Nodeset Config.xml Configuration file for the Nodeset [} 70] import of the server. The Nodesets to be imported and their link to an ADS device are defined in this file. Tc Ua Security Config.xml Configuration file for users, groups and Access Control Lists (ACL) as part of the definition of access rights [} 127] and authentication [} 125] mechanisms. Tc Ua Server Config.xml Configuration file for various parameters of the server, e.g. configuration of the endpoints [} 122], Logging [} 138], Reverse Connect [} 132]. 4.10 Data Access 4.10.1 Overview This chapter describes the steps required to configure the variables in the Twin CAT OPC UA Server namespace for Data Access (DA). Data Access is an OPC UA function that describes the representation and use of variable values. For example, this is about the service functionalities, how an OPC UA client can access variable values. The Twin CAT OPC UA Server can provide variables from all Twin CAT real-time environments. These include, for example, the Twin CAT PLC, Twin CAT 3 C++, Twin CAT 3 Matlab®/Simulink® or a Twin CAT I/O task. The server can access several real-time environments and provide their symbolism in its address space. Basis for further functions The Connection with the runtime [} 50] and enabling symbols [} 53] for Data Access is the basis for other functions, such as Historical Access and Alarms & Conditions. Please make sure you are familiar with the settings required here. The different real-time environments do not necessarily have to be on the same system, but can be distributed across different controllers. In this case, an ADS route must be set up for each system. The following figure illustrates this relationship. TF6100 Version: 1.4.0 49
## Page 50

Technical introduction In the Twin CAT OPC UA Configurator, the Data Access configuration can be carried out in the Data Access tab. All connected real-time environments are displayed there as a separate "device". The chapter Connection with the runtime [} 50] describes how to add data access devices and which parameters are required for this. You can then start with Enabling symbols [} 53]. Also see about this 2 Overview [} 92] 4.10.2 Connection with the runtime The Twin CAT OPC UA Server can provide symbols from one or more real-time environments. These can also be located on different physical control systems. In this case, an ADS route must be established to the respective target system. The so-called "AMS Net ID" uniquely identifies a control system in the network and is required to establish an ADS route to the system. The ADS port, on the other hand, then identifies a specific application on this system, e.g. the Twin CAT PLC. The following figure illustrates this relationship. 50 Version: 1.4.0 TF6100
## Page 51

Technical introduction In this example, there are three control devices. The Twin CAT OPC UA Server is installed on the first device and this device is identified by the AMS Net ID 192.168.1.1.1.1. On the second device, which is identified by the AMS Net ID 192.168.1.2.1.1, two PLC runtimes are started and are each addressed by their own ADS port. Only one PLC runtime is running on the third device (192.168.1.3.1.1). Configuration The configuration for a Data Access device can be carried out using the Twin CAT OPC UA Configurator. The Data Access tab gives you an overview of all configured devices and allows you to add or remove devices. TF6100 Version: 1.4.0 51
## Page 52

Technical introduction In this screenshot, for example, you can see a configuration with three Data Access devices. These have been configured as follows: • PLC1: Local PLC runtime (127.0.0.1.1.1) on port 851 • PLC2: Remote PLC runtime (3.76.187.234.1.1) on port 851 • PLC3: Remote PLC runtime (3.76.187.234.1.1) on port 852 All parameters required for the connection with a device and its symbolism can now be configured in the properties of the device. 52 Version: 1.4.0 TF6100
## Page 53

Technical introduction Depending on the real-time environment used, you can, for example, choose a symbol file here, select the ADS route to be used and enter the ADS port of the respective application. You can find more information on the various symbol files in the chapter Enabling symbols [} 53]. 4.10.3 Enabling symbols As you have already learned in the Quick Start [} 21] tutorial, symbols are enabled in the Twin CAT 3 PLC via a so-called pragma (also known as an "attribute"). In other real-time environments, the enabling mechanism may be different. The following chapter provides an overview. The term "Symbol" The term "Symbol" is used in this documentation as a substitute for variable, structure, function block instance, method, etc. Symbols The Twin CAT OPC UA Server receives its information via real-time variables (e.g. addresses and data types), the so-called "symbolism". Depending on the real-time environment used (e.g. Twin CAT PLC or Twin CAT 3 C++), various so-called "symbol files" are available for reading the symbolism (also known as "offline symbolism"). In addition, the symbolism can be read via Twin CAT ADS when the runtime environment is started (also referred to as "online symbolism"). TF6100 Version: 1.4.0 53
## Page 54

Technical introduction The advantage of using online symbolism is that no symbol files need to be exchanged. Especially in the installation variant [} 16], in which the Twin CAT OPC UA Server is operated on a gateway PC, the manual copying process of the symbol files of all connected controllers is no longer necessary. The disadvantage of online symbolism is that the symbols are only available when the PLC environment is running. The symbol file must be imported by the server to access the address information of the symbols. Alternatively, the server can also work directly with the online symbolism. The symbols are then only available in the server's address space when the real-time environment is available. The Twin CAT OPC UA Configurator can be used to configure the server and which symbol file it should read. The corresponding path to the symbol file can be configured there as part of the data access device. Depending on the real-time environment used, the symbol file that must be imported from the server in order to obtain address information for the existing symbols and the symbol enabling mechanism will vary. While the Twin CAT 3 PLC works with so-called pragmas to enable a symbol for OPC UA, Twin CAT 2 still uses specially formatted comments on the symbol for this purpose. Twin CAT 3 C++, on the other hand, uses the so-called TMC code generator to enable symbols for OPC UA. Symbol files can be configured in the Twin CAT engineering interface so that they are automatically copied to the boot directory of the target device when the project is activated. The Twin CAT OPC UA Server is usually configured to read the symbol file from the boot directory. The following table provides an overview of the various symbol files in relation to their real-time environment and the enabling mechanism. Real-time environment Symbol file Enable via... Path in the boot directory Twin CAT 2 PLC TPY Comment Current Plc_1.tpy Twin CAT 3 PLC [} 54] TMC Pragma Plc\Port_%Ads Port%.tmc Twin CAT 3 C++ [} 57] TMI TMC code generator Tmi\%Object Id%.tmi Twin CAT 3 Matlab®/ TMI TMC code generator Tmi\%Object Id%.tmi Simulink® [} 60] Twin CAT 3 I/O Task XML Comment Current Config.xml [} 67] Online symbolism [} 69] --- Pragma --- TMC code generator For more information, see the sub-chapters for each real-time environment. 4.10.3.1 PLC This section describes how to configure the namespace of the Twin CAT OPC UA Server in order to gain access to the symbols of a PLC project. This requires the following steps to be carried out: • Activating the symbol file • Enabling symbols 54 Version: 1.4.0 TF6100
## Page 55

Technical introduction • Configuration of the server Activating the symbol file To make the symbols of a PLC project available via OPC UA, you must first activate the download of the symbol file (TMC) in the properties of the PLC project. This means that the symbol file is automatically transferred to the corresponding target device when the project is activated and is then available there in the Twin CAT boot directory. The name of the symbol file is based, for example, on the ADS port (see below) of the PLC runtime: %Twin CATInstall Dir%\3.1\Boot\Plc\Port_851.tmc Quick start If the Twin CAT OPC UA Server is also installed on the same device, it always automatically reads the symbol file of the first PLC runtime in the delivery state, i.e. no further settings are required on the server. Activating the project thus transfers the symbol file to the target device and a subsequent Twin CAT restart also restarts the Twin CAT OPC UA Server. This will now find the symbol file in the boot directory during the boot process and read it. The server recognizes which symbols it should provide in its address space through the set pragmas. Enabling symbols In Twin CAT 3 PLC, symbols are enabled for OPC UA via so-called pragmas. Such a pragma was also used in the Quick Start [} 21] Tutorial, for example, to enable a variable for OPC UA. The pragma is inserted before the symbol to which it applies. The following pragma can be used to enable a variable, array, or structure for OPC UA. The Twin CAT OPC UA Server recognizes this pragma when reading the symbolism and imports the corresponding symbol into its namespace. The corresponding type information [} 71] is transferred and mapped to OPC UA. {attribute 'OPC. UA. DA' := '1'} n My Counter : INT; Additional pragmas may be required for individual sub-functions of data access, for example structures [} 76], properties [} 79], Analog Item Type [} 83], Status Code [} 80], setting a description [} 84], Alias or the read-only [} 85] flag of a node. The additional pragmas are then inserted in a separate line, for example: {attribute 'OPC. UA. DA' := '1'} {attribute 'OPC. UA. DA. Access' := '1'} n My Counter : INT; (Sets the read-only flag for this variable) The pragma for enabling a symbol is automatically inherited to all child symbols. If you want to block inheritance from a certain point, for example from a certain member of a structure, you can work with the following pragma: {attribute 'OPC. UA. DA' := '0'} st Child : ST_Child Struct; TF6100 Version: 1.4.0 55
## Page 56

Technical introduction In the case of function blocks and structures, the definition location of the pragma is decisive. If the pragma is defined on an instance, only this instance (and all child elements) is enabled for OPC UA. If, on the other hand, the pragma is defined at the function block or structure definition, all instances of the function block or structure are enabled. In the following sample, the two instances fb Test1 and fb Test2 of the function block FB_BLOCK1 are to be made available via OPC UA. When an entire instance is enabled, all its symbols are also available via OPC UA. The PLC program looks like the following: PROGRAM MAIN VAR {attribute 'OPC. UA. DA' := '1'} fb Test1 : FB_BLOCK1; fb Test2 : FB_BLOCK1; END_VAR FUNCTION_BLOCK FB_BLOCK1 VAR_INPUT {attribute 'OPC. UA. DA' := '1'} ni1 : INT; ni2 : INT; END_VAR VAR_OUTPUT {attribute 'OPC. UA. DA' := '1'} no1 : INT; no2 : INT; END_VAR VAR {attribute 'OPC. UA. DA' := '1'} nx1 : INT; nx2 : INT; END_VAR The instance fb Test1 now receives the pragma, which means that all the symbols it contains are also automatically enabled for OPC UA, i.e. fb Test.ni1, fb Test.ni2, etc. The instance fb Test2, on the other hand, does not receive the pragma, but the three variables ni1, no1 and nx1 it contains are marked with the pragma. They are therefore available in all instances via OPC UA. Configuration of the server You can now use the Twin CAT OPC UA Configurator to configure the Twin CAT OPC UA Server so that it reads the generated symbol file and makes the PLC runtime available as a data access device in its address space. To do this, add a new device in the Data Access tab of the Twin CAT OPC UA Configurator. Select the AMS Net ID of your device and enter the ADS port of the PLC runtime. You can find the ADS port in the properties of the PLC project: Now select the entry "Twin CAT 3 PLC (TMC) - Filtered" from the selection list in the "Type" field. In the "Symbol File" field, select the symbol file (TMC) that was created after activating the Twin CAT PLC project and should now be located in the boot directory. Alternatively, you can also use the online symbolism [} 69]. 56 Version: 1.4.0 TF6100
## Page 57

Technical introduction You can leave all other settings at their default values. 4.10.3.2 C++ This section describes how to configure the namespace of the Twin CAT OPC UA Server in order to obtain access to the symbols of a Twin CAT 3 C++ module. This requires the following steps to be carried out: • Activating the symbol file • Enabling symbols • Configuration of the server These steps are described in more detail below. Activating the symbol file To configure certain symbols contained in an instance of a C++ module so that they become accessible via OPC UA, you must first activate the download of the symbol file for the module instance. This copies the symbol file to the boot directory of the target device when the configuration is activated. Activate the download of the symbol file by setting the following option in the properties of the module instance: The generated symbol file (TMI) is always named after the Object Id of the module instance and is now copied to the boot directory of the target device when activated, for example: %Twin CATInstall Dir%\3.1\Boot\Tmi\Obj_01010010.tmi Enabling symbols You can use the TMC Code Generator to define which symbols are to be enabled via OPC UA. Two settings are required for this. First activate the "Create Symbol" checkbox for each symbol to be enabled in the TMC Code Generator. Then add an optional property with the key "OPC. UA. DA" and the value "1". TF6100 Version: 1.4.0 57
## Page 58

Technical introduction Configuration of the server You can now use the Twin CAT OPC UA Configurator to configure the Twin CAT OPC UA Server so that it reads the generated symbol file and makes the C++ module instance available as a data access device in its address space. To do this, add a new device in the Data Access tab of the Twin CAT OPC UA Configurator. Select the AMS Net ID of your device and enter the ADS port of the Twin CAT 3 C++ module instance. You can find the ADS port in the properties of the task connected to the C++ module instance: 58 Version: 1.4.0 TF6100
## Page 59

Technical introduction Now select the entry "Twin CAT 3 C++ (TMI) - Filtered" from the selection list in the "Type" field. In the "Symbol File" field, select the symbol file (TMI) that was created after activating the Twin CAT 3 C++ project and should now be located in the boot directory. Alternatively, you can also use the online symbolism [} 69]. You can leave all other settings at their default values. TF6100 Version: 1.4.0 59
## Page 60

Technical introduction 4.10.3.2.1 Arrays By default arrays are regarded as individual nodes in the UA namespace. This means that if you define, for example, an array dyn_BOOL[10] in the PLC (and have also enabled it for OPC UA), it will subsequently appear in the UA namespace as follows: The advantage of this approach is a considerable reduction in the complexity of the UA namespace and in memory consumption, since not every position of an array needs to be made available as an individual node in the namespace. However, modern UA Clients can continue to access the individual array positions via the so-called "Range Offset". In order to support older UA Clients that don’t offer this feature, however, you can also make the positions of an array available as individual nodes in the UA namespace. It is illustrated as follows: This setting is available by activating the Legacy Array Handling option in the UA Configurator within the respective namespace configuration. Depending on the scope of the PLC project, the UA namespace can become significantly more complex, which in turn is reflected in an increased memory utilization of the UA Server. Changes to the settings listed above only become active after restarting the UA Server. 4.10.3.3 Matlab®/Simulink® This section describes how to configure the namespace of the Twin CAT OPC UA Server in order to obtain access to the symbols of a Twin CAT 3 Matlab®/Simulink® module. This requires the following steps to be carried out: • Activating the symbol file • Enabling symbols • Configuration of the server These steps are described in more detail below. Activating the symbol file To configure certain symbols contained in an instance of a C++ module so that they become accessible via OPC UA, you must first activate the download of the symbol file for the module instance. This copies the symbol file to the boot directory of the target device when the configuration is activated. Activate the download of the symbol file by setting the following option in the properties of the module instance: 60 Version: 1.4.0 TF6100
## Page 61

Technical introduction The generated symbol file (TMI) is always named after the Object Id of the module instance and is now copied to the boot directory of the target device when activated, for example: %Twin CATInstall Dir%\3.1\Boot\Tmi\Obj_01010010.tmi Enabling symbols The TE1400 Target for Simulink® product offers various setting options for selecting variables that are to be enabled via OPC UA. These settings are described in the corresponding TE1400 product documentation. Configuration of the server You can now use the Twin CAT OPC UA Configurator to configure the Twin CAT OPC UA Server so that it reads the generated symbol file and makes the Matlab®/Simulink® module instance available as a data access device in its address space. To do this, add a new device in the Data Access tab of the Twin CAT OPC UA Configurator. Select the AMS Net ID of your device and enter the ADS port of the Twin CAT 3 Matlab®/Simulink® module instance. You can find the ADS port in the properties of the task connected to the module instance: Now select the entry "Twin CAT 3 C++ (TMI) - Filtered" from the selection list in the "Type" field. In the "Symbol File" field, select the symbol file (TMI) that was created after activating the Twin CAT 3 C++ project and should now be located in the boot directory. Alternatively, you can also use the online symbolism [} 69]. TF6100 Version: 1.4.0 61
## Page 62

Technical introduction You can leave all other settings at their default values. 4.10.3.4 Ether CAT Master This section describes how to configure the namespace of the Twin CAT OPC UA Server in order to obtain access to the symbols of an Ether CAT master. This requires the following steps to be carried out: • Activating the symbol file • Configuration of the server • [optional] Change the namespace structure These steps are described in more detail below. Activating the symbol file To make the symbols of an Ether CAT master available via OPC UA, you must first activate the ADS server in the image of the Ether CAT master and the generation of the symbols. This enables access to the symbols via ADS. In the same dialog, you will also find the ADS port, which will be required later in the configuration process. 62 Version: 1.4.0 TF6100
## Page 63

Technical introduction By activating the "Generate .tmc file" and "Copy .tmc file to target" parameters, a symbol file is generated and automatically downloaded to the target device when the configuration is activated. This is then located in the Twin CAT boot directory and has the ADS port in the file name for easy identification, for example: %Twin CATInstall Dir%\3.1\Boot\Io\Port_27905.tmc Configuration of the server You can now use the Twin CAT OPC UA Configurator to configure the Twin CAT OPC UA Server so that it reads the generated symbol file and makes the Ether CAT master available as a data access device in its address space. Add a new device in the Data Access tab of the Twin CAT OPC UA Configurator. Select the AMS Net ID of your device and enter the ADS port of the Ether CAT master image (see above). Now select the "Ether CAT Master (TMC)" entry from the selection list in the "Type" field. In the "Symbol File" field, select the symbol file (TMC) that was created after activating the Twin CAT project and should now be located in the boot directory. Alternatively, you can also use the online symbolism [} 69]. TF6100 Version: 1.4.0 63
## Page 64

Technical introduction You can leave all other settings at their default values. Changing the namespace structure The parameter "Generate hierarchical symbol names" enables a different structure of the symbol space, which also has a direct effect on the namespace of the Twin CAT OPC UA Server. 64 Version: 1.4.0 TF6100
## Page 65

Technical introduction Let's take the following Ether CAT master configuration in Twin CAT XAE as an example: If this option is activated, the namespace reflects the structure in Twin CAT XAE: TF6100 Version: 1.4.0 65
## Page 66

Technical introduction If this option is disabled, the namespace is structured "flatter": 66 Version: 1.4.0 TF6100
## Page 67

Technical introduction 4.10.3.5 I/O task This section describes how to configure the namespace of the Twin CAT OPC UA Server in order to gain access to the symbols of a task with process image. This requires the following steps to be carried out: • Activating the symbolism • Configuration of the server Activating the symbolism You can provide the variables of a task with a process image via OPC UA. To do this, you must enable the "Create symbols" option in the task settings. This generates symbols and makes them available via the online symbolism [} 69]. In the same dialog, you will also find the ADS port, which will be required later in the configuration process. TF6100 Version: 1.4.0 67
## Page 68

Technical introduction Configuration of the server You can now use the Twin CAT OPC UA Configurator to configure the Twin CAT OPC UA Server so that it accesses the online symbolism of the task and makes them available in its address space. Add a new device in the Data Access tab of the Twin CAT OPC UA Configurator. Select the AMS Net ID of your device and enter the ADS port of the task (see above). In the selection list of the "Type" field, select the "Twin CAT Symbol Server" entry. After activating the Twin CAT project, the symbols are ready and the Twin CAT OPC UA Server can read them and build up its address space accordingly. 68 Version: 1.4.0 TF6100
## Page 69

Technical introduction 4.10.3.6 Online symbolism The Twin CAT OPC UA Server enables symbol information to be read via the so-called "online symbolism". This is a standardized ADS interface, which is offered by some ADS servers in Twin CAT. This interface is often referred to as "Symbol Upload". The interface enables an ADS client to read all available symbols from the ADS server and process them further if necessary. In addition to the address information of the symbols, further information is also provided, such as data type descriptions and optional attributes. The optional attributes can be used to explicitly enable symbols or to make further settings for this purpose - the handling is identical to the use of symbol files and runs, for example, via pragmas in the PLC or the TMC Code Generator for Twin CAT 3 C++. This means that you can use all the enables that you have set there both via the symbol file import and the online symbols. Please note that not all real-time environments allow the explicit enabling of symbols. In this case, all symbols are always provided. The following table provides an overview of some ADS servers that provide the online symbolism interface and whether explicit symbol enabling is available. Type ADS Port Symbol enable Twin CAT 2 PLC 801, 811, 821, ... Yes Twin CAT 3 PLC 851, 852, 853, ... Yes Twin CAT 3 C++ / Matlab®/Simulink® 350, 351, 352, ... Yes Twin CAT 3 Ether CAT Master 27905, 27906, ... No (all symbols are enabled) Twin CAT 3 I/O Task with Image 301, 302, 303, ... No (all symbols are enabled) In the Twin CAT OPC UA Configurator, the online symbol mechanism is available in two forms when configuring a Data Access device: • Twin CAT Symbol Server: All symbols are imported • Twin CAT Symbol Server - Filtered: Only enabled symbols are imported TF6100 Version: 1.4.0 69
## Page 70

Technical introduction In the structure of its namespace, the Twin CAT OPC UA Server is based on the namespace of the ADS symbolism. As the data is available here, it is also provided via OPC UA. 4.10.4 Nodesets The Twin CAT OPC UA Server allows importing of OPC UA Nodeset files. A nodeset can define data types and instances, for example as part of a companion specification, which are available within the nodeset in an XML structure (standardized by the OPC Foundation). Using the TE6100 OPC UA Nodeset Editor software, nodeset files can be created, modified and linked with symbols from a Twin CAT real-time environment. The nodeset can then be exported to the Twin CAT OPC UA Server and used there. Further information on this topic can be found in the TE6100 OPC UA Nodeset Editor product documentation The following screenshot shows an example of the workflow for using both Twin CAT functions. 70 Version: 1.4.0 TF6100
## Page 71

Technical introduction 4.10.5 Data types The IEC 61131-3 data types are mapped to OPC UA data types in accordance with the PLCopen mapping specification. The following table shows the specified mapping. PLC OPC UA BOOL Boolean SINT SByte INT Int16 DINT Int32 LINT Int64 USINT Byte UINT UInt16 UDINT UInt32 ULINT UInt64 REAL Float LREAL Double TIME [} 71] Int64 LTIME [} 71] Int64 STRING [} 72] String WSTRING [} 72] String 4.10.5.1 TIME/LTIME TIME/LTIME For the TIME and LTIME data types, there are special features to observe with regard to mapping between PLC and OPC UA data types, see the following section. TIME and LTIME In the PLCopen mapping of IEC 61131-3, both TIME and LTIME are mapped to the Int64 data type. The data areas of the IEC61131-3 data types UDINT and ULINT, on the other hand, correspond to UInt32 and UInt64. Data type Lower limit Upper limit Mapping in time TIME (UDINT) 0 4294967295 49d17h2m47s295ms LTIME (ULINT) 0 18446744073709551615 213503d23h34m33s709m s551us615ns Int64 -9223372036854775808 9223372036854775807 - TF6100 Version: 1.4.0 71
## Page 72

Technical introduction The behavior of the server when handling these two data types is explained in the following list: TIME • The possible value range can be seen in the table. • For all other values (<0 and >4294967295), the server returns the status code Bad Out Of Range when written by an OPC UA client. LTIME • The possible value range can also be seen in the table. • For all values <0, the server returns the status code Bad Out Of Range when written by an OPC UA client. • Values >9223372036854775807 cannot be mapped with the value range of Int64 and therefore cannot be written via OPC UA. However, they can be written in the PLC. In this case, the value of the affected OPC UA variables in the server becomes null. In addition, the Status Code of the variable is set to Bad Out Of Range. 4.10.5.2 Strings According to the PLCopen mapping, the PLC data types STRING and WSTRING are both mapped to the OPC UA data types String. The difference lies in the internal storage: • STRING: Characters are 1 byte long. • WSTRING: Characters are 2 bytes long. Both data types are explained below. For more details, please refer to the Twin CAT 3 PLC documentation. STRING The STRING data type can be interpreted in Twin CAT as either Latin-1 or UTF-8. The interpretation is controlled via the {attribute 'Tc Encoding'} attribute: • Latin-1 is used without an attribute. • UTF-8 is used with attribute. Samples: // Standard: Latin-1 s My String Text : STRING := 'This is a STRING'; // UTF-8 from STRING {attribute 'Tc Encoding' := 'UTF-8'} s My UTF8Text1 : STRING := s Literal_TO_UTF8('The dinner costs 30 €.'); // UFT-8 from WSTRING {attribute 'Tc Encoding' := 'UTF-8'} s My UTF8Text2 : STRING := ws Literal_TO_UTF8("The dinner costs 30 €."); // UFT-8 simple STRING {attribute 'Tc Encoding' := 'UTF-8'} s My UTF8Text3 : STRING := 'Hello World.'; WSTRING The WSTRING data type follows the UCS2 coding (2 bytes per character). Initialization always takes place with double quotation marks. Sample: ws My WSTRING : WSTRING := "This is a WSTRING."; 4.10.6 Arrays By default, arrays are mapped as individual nodes in the server's address space. An OPC UA client still has the option of accessing individual elements of the array. 72 Version: 1.4.0 TF6100
## Page 73

Technical introduction The following array in the PLC would thus be displayed as a single node, with the array limits being defined via the node attributes. {attribute 'OPC. UA. DA' := '1'} arr My Array : ARRAY[0..3] OF INT; The advantage is a considerable reduction in the complexity of the server address space and memory consumption, since not every position of an array needs to be made available as an individual node in the namespace. Older OPC UA clients may not yet support this function. Therefore, a special configuration switch enables all individual elements of an array to be provided as individual nodes in the namespace. This is as follows: TF6100 Version: 1.4.0 73
## Page 74

Technical introduction In addition to the root element of the array, all individual elements are also available as separate nodes. This configuration switch is available by activating the "Legacy Array Handling" option on a data access device in the Twin CAT OPC UA Configurator. 74 Version: 1.4.0 TF6100
## Page 75

Technical introduction Increased storage requirements Activating this configuration switch significantly increases the address space of the server. Depending on the scope of the project and especially when using nested, complex arrays, this results in increased memory load of the Twin CAT OPC UA Server. Make sure that your hardware device has sufficient main memory. 4.10.7 Enums Enumerations in OPC UA always have the data type Int32. However, the IEC 61131-3 standard allows the definition of larger data types than Int32. To ensure that these enumerations are handled properly, the Twin CAT OPC UA Server offers the configuration option <Import Big Enums Numeric>, which can be enabled in its Data Access configuration file. This option is set to FALSE by default. This means that a status code exception Bad Out Of Range is triggered if the enumeration value is outside the Int32 range. If the option is set to TRUE, enumerations with data types greater than Int32 are treated as regular variables with this particular data type. Let's assume we have the following enumeration definitions in our PLC code: TYPE E_Enum_Normal : ( enum_member_0 := 0, enum_member_1 := 1, enum_member_2 := 2 ); END_TYPE TYPE E_Enum_Not So Big : ( enum_member_0 := 0, enum_member_1 := 1, enum_member_2 := 2 ) UINT; END_TYPE TYPE E_Enum_Very Big : TF6100 Version: 1.4.0 75
## Page 76

Technical introduction ( enum_member_0 := 0, enum_member_1 := 1, enum_member_2 := 2 ) LINT; END_TYPE If the above configuration option is activated, instances of E_Enum_Very Big are treated as regular variables of data type Int64 in the server namespace, while instances of E_Enum_Normal and E_Enum_Not So Big are treated as OPC UA enumeration (with data type Int32): 4.10.8 Structures Requirements This functionality is only available for Data Access [} 49] devices based on Twin CAT 3 and the import of TMC symbol files [} 53]. The Twin CAT OPC UA Server enables the use of so-called Structured Types for structures from the Twin CAT 3 PLC. Structured Types allow structures to be read or written in a data-consistent manner and the type description of the structure to be made available to the client. You can use a special pragma to define a structure as a Structured Type and make it available. If this pragma is not set, the structure is not loaded into the server's address space as a Structured Type, but is displayed as a Folder Type. The member variables of the structure are displayed as separate nodes that can be accessed. The following sample of a structure in the Twin CAT 3 PLC is given: TYPE ST_Communication : STRUCT a : INT; b : INT; c : INT; END_STRUCT END_TYPE This structure is now instantiated in the MAIN program and enabled for OPC UA via a pragma, as described in the chapter Enabling (PLC) symbols [} 54]. PROGRAM MAIN VAR {attribute 'OPC. UA. DA' := '1'} st Communication : ST_Communication; END_VAR The structure instance is now provided in the server as follows by default: The individual member variables of the structure can now be accessed, but not the root element of the structure. As a result, data-consistent access to the entire structure may not be possible. 76 Version: 1.4.0 TF6100
## Page 77

Technical introduction Using another pragma, this structure instance is now defined as a Structured Type. PROGRAM MAIN VAR {attribute 'OPC. UA. DA' := '1'} {attribute 'OPC. UA. DA. Structured Type' := '1'} st Communication : ST_Communication; END_VAR The instance is then provided in the Twin CAT OPC UA Server as follows: When the root element is read, the structure information is provided in a data-consistent manner via OPC UA and can be processed by a client. In addition, the member variables are also displayed as separate nodes and can be accessed. You can deactivate this via a special attribute. The member variables can then only be accessed via the Structured Type, as shown in the following sample: PROGRAM MAIN VAR {attribute 'OPC. UA. DA' := '2'} {attribute 'OPC. UA. DA. Structured Type' := '1'} st Communication : ST_Communication; END_VAR TF6100 Version: 1.4.0 77
## Page 78

Technical introduction This is primarily a memory optimization of the server, as also described in the chapter Optimizations [} 42], because main memory must be allocated for each node in the address space. You do not necessarily have to place the pragmas at every instance of a structure, but can also do this once at the structure definition. In this case, all instances of this structure are automatically enabled for OPC UA as Structured Type. {attribute 'OPC. UA. DA' := '1'} {attribute 'OPC. UA. DA. Structured Type' := '1'} TYPE ST_Communication : STRUCT a : INT; b : INT; c : INT; END_STRUCT END_TYPE In this case, you can also explicitly deactivate the Structured Type definition for certain instances by using the following attribute: PROGRAM MAIN VAR {attribute 'OPC. UA. DA. Structured Type' := '0'} st Communication : ST_Communication; END_VAR Structured Type for function blocks You can also use Structured Types with PLC function blocks. In this case, a function block instance receives a child node called "Function Block", which represents the entire function block as a Structured Type. Consider the following sample: FUNCTION_BLOCK FB_Function Block VAR_INPUT Input1 : INT; Input2 : LREAL; END_VAR VAR_OUTPUT Output1 : LREAL; END_VAR An instance of the function block is created in the MAIN program and both enabled for OPC UA and defined as a Structured Type via pragmas. 78 Version: 1.4.0 TF6100
## Page 79

Technical introduction PROGRAM MAIN VAR {attribute 'OPC. UA. DA' := '1'} {attribute 'OPC. UA. DA. Structured Type' := '1'} fb Function Block : FB_Function Block; END_VAR The Twin CAT OPC UA then provides the function block instance as follows: The definition locations of pragmas mentioned above for structures also apply to function blocks. You can also explicitly hide the member variables of a function block here. Restrictions The following restrictions apply when using Structured Types. Pointers and references If pointer and reference types are used in the structure, they cannot be converted into a Structured Type. The OPC UA Server then illustrates these structures as regular Folder Types with the corresponding member variables. Maximum size of the structure The maximum size of a structure is limited to 16 k B by default. If the size of the structure exceeds this limit, structure instances are displayed as Folder Type. You can increase this limit if necessary. The background is described in more detail in the chapter Optimizations [} 42]. Each STRUCT constantly exchanges data with the basic ADS device, i.e. a large ADS message is sent with each read/write command of a Structured Type. To prevent the ADS router from being flooded with large messages, the maximum size is limited. 4.10.9 Properties Requirements This functionality is only available for Data Access [} 49] devices based on Twin CAT 3 and the import of TMC [} 53] symbol files, as well as the online symbolism. The display of PLC properties in the server namespace has been supported since Twin CAT 3.1 Build 4024. All you need to do is set two special PLC attributes on the Property so that the Property is imported into the namespace and represented there as a UA Property. Sample: TF6100 Version: 1.4.0 79
## Page 80

Technical introduction {attribute 'OPC. UA. DA. Property' := '1'} {attribute 'monitoring' := 'call'} PROPERTY Property_1 : BOOL The function block on which the Property is defined must contain the normal PLC attribute for enabling symbols. In the configuration file Tc Ua Da Config.xml the handling of PLC properties can be defined globally. The "Import Plc Properties" flag is used for this purpose. Value Description false Displays all properties in the OPC UA namespace for which both the OPC. UA. DA. Property and the monitoring attribute have been set. true Displays all properties in the OPC UA namespace where the monitoring attribute has been set. 4.10.10 Status Code Requirements This functionality is only available for Data Access [} 49] devices based on Twin CAT 3 and the import of TMC symbol files [} 53]. New implementation in setup version 5.x The functionality for the Twin CAT OPC UA Server in setup version 5.x is described below. This is followed by a description [} 82] of the functionality for the Twin CAT OPC UA Server in setup version 4.x.. The Twin CAT OPC UA Server enables the adaptation of the OPC UA Status Code for a specific PLC symbol. Carry out the following steps to be able to change the Status Code of a symbol at runtime. Creating a structure To ensure data consistency, the concept is based on a structure (see Structured Types). Each symbol for which the Status Code is to be changed must be packaged in a structure. Create a new structure and add the following pragma before the structure definition. The structure contains the symbol itself and a variable of data type DINT, which represents the Status Code in decimal form. {attribute 'OPC. UA. DA. Structured Type' := '1'} {attribute 'OPC. UA. DA. Status And Value' := '1'} TYPE ST_Status Code Simple : STRUCT value : REAL; status : DINT := -2147155968; // equals 'Bad Communication Error' END_STRUCT END_TYPE You can also use complex symbols, for example: {attribute 'OPC. UA. DA. Structured Type' := '1'} {attribute 'OPC. UA. DA. Status And Value' := '1'} TYPE ST_Status Code Complex : STRUCT {attribute 'OPC. UA. DA. Structured Type' := '1'} value : ST_Complex_1; status : DINT := -2146762752; // equals 'Bad Service Unsupported' END_STRUCT END_TYPE Now create an instance of this structure, e.g. in the MAIN program, and add the pragma to enable the instance via OPC UA. 80 Version: 1.4.0 TF6100
## Page 81

Technical introduction PROGRAM MAIN VAR {attribute 'OPC. UA. DA' := '1'} st Status Code Simple : ST_Status Code Simple; {attribute 'OPC. UA. DA' := '1'} st Status Code Complex : ST_Status Code Complex; END_VAR The defined structure instances are now provided with the data type of the member variables defined as "value" in the Twin CAT OPC UA Server. Changing the Status Code at runtime To change the Status Code at runtime, simply edit the value of the member variable "status". If you set this to "-2147155968", as in the sample above, the Status Code changes to "Bad Communication Error". TF6100 Version: 1.4.0 81
## Page 82

Technical introduction However, if you set the value to "0", the Status Code changes to "Good". The decimal value used here is defined by the OPC UA specification, here the current version of the Status Code mapping. The table below lists some common Status Codes and their numerical representation. Status Code Hex Decimal Good 0x00000000 0 Uncertain 0x40000000 1073741824 Bad 0x80000000 -2147483648 Bad Unexpected Error 0x80010000 -2147418112 Bad Internal Error 0x80020000 -2147352576 Bad Communication Error 0x80050000 -2147155968 Bad Timeout 0x800A0000 -2146828288 Bad Service Not Supported 0x800B0000 -2146762752 When calculating the decimal representation of a Status Code on the basis of its hexadecimal representation, please note that your computer is set to DWORD, for example the Windows computer ("Programmer" view). Use in Setup version 4.x In the "older" implementation in Setup version 4.x, the variable is not displayed as a single variable on the OPC UA side, but as a structure in the same way as on the PLC side. There are also differences in the configuration of the attributes. {attribute 'OPC. UA. DA. Structured Type' := '1'} {attribute 'OPC. UA. DA. STATUS' := 'Quality'} TYPE ST_Status Code Simple_V4 : STRUCT Value : REAL; Quality : DINT := -2147155968; // equals 'Bad Communication Error' END_STRUCT END_TYPE 82 Version: 1.4.0 TF6100
## Page 83

Technical introduction The Status Code is only made available at the structure variable via OPC UA. The Value and Quality values contain the value and the value of the status code. 4.10.11 Analog Item Type Requirements This functionality is only available for Data Access [} 49] devices based on Twin CAT 3 and the import of TMC symbol files [} 53]. Analog Item Types are part of the OPC UA specification and allow meta information such as units to be attached to a variable. You can define these items of meta information in the form of PLC attributes in the Twin CAT 3 PLC. The following parameters can be set: • Engineering Units: Units defined by the OPC UA specification • EURange: Maximum value range of the variables • Instrument Range: Maximum value range of the variables • Write Behavior: Behavior if the value range is exceeded during a write operation. The following sample shows how the fill Level variable is configured as an Analog Item Type. The following parameters are set: • Unit: 20529 ("Percent", defined in the OPC UA specification) • Max. value range: 0 to 100 • Normal value range: 10 to 90 • Write behavior: 1 (Clamping) {attribute 'OPC. UA. DA' := '1'} {attribute 'OPC. UA. DA. Analog Item Type' := '1'} {attribute 'OPC. UA. DA. Analog Item Type. Engineering Units' := '20529'} {attribute 'OPC. UA. DA. Analog Item Type. EURange' := '0:100'} {attribute 'OPC. UA. DA. Analog Item Type. Instrument Range' := '10:90'} {attribute 'OPC. UA. DA. Analog Item Type. Write Behavior' := '1'} fill Level : UINT; Engineering Units can be configured using the IDs specified in OPC UA (Part 8 of the OPC UA specification). The IDs are based on the widely used and accepted "Codes for Units of Measurement (Recommendation N.20)" published by the "United Nations Center for Trade Facilitation and Electronic Business". Common Code, which specifies the three-digit alphanumeric ID, is converted by OPC UA according to specification into an Int32 value and referenced (extract from OPC UA specification v1.02, pseudo-code): Int32 unit Id = 0; Int32 c; for (i=0; i<=3;i++) { c = Common Code[i]; if (c == 0) break; // end of Common Code unit Id = unit Id << 8; // shift left unit Id = unit Id | c; // OR operation } Write behavior When writing an Analog Item Type variable, you can define how the OPC UA Server should handle the new value in relation to the value range. The following options are available: • 0: All values are allowed and are accepted during a write operation. • 1: The value to be written is truncated according to the value range. TF6100 Version: 1.4.0 83
## Page 84

Technical introduction • 2: The value to be written is rejected if it exceeds the value range. 4.10.12 Description Requirements This functionality is only available for Data Access [} 49] devices based on Twin CAT 3 and the import of TMC and TMI [} 53] symbol files, as well as the online symbolism. The following Twin CAT 3 PLC [} 54] pragma can be used to set the OPC UA attribute "Description" for a symbol. {attribute 'OPC. UA. DA' := '1'} {attribute 'OPC. UA. DA. Description' := 'Some description for the symbol'} n My Counter : INT; In the case of Twin CAT 3 C++ [} 57], you can also use this pragma in the TMC Code Generator to set a description for the node. Please note that this feature is only available under Twin CAT 3 C++ when using online symbolism [} 69]. 84 Version: 1.4.0 TF6100
## Page 85

Technical introduction 4.10.13 Read Only Requirements This functionality is only available for Data Access [} 49] devices based on Twin CAT 3 and the import of TMC symbol files [} 53]. The following pragma can be used to set a symbol read-only. The server then acknowledges write operations by an OPC UA client with the Status Code Bad Not Writeable. {attribute 'OPC. UA. DA' := '1'} {attribute 'OPC. UA. DA. Access' := '1'} n My Counter : INT; TF6100 Version: 1.4.0 85
## Page 86

Technical introduction In the case of Twin CAT 3 C++ [} 57], you can also use this pragma in the TMC Code Generator to mark a node as read-only. Please note that this feature is only available under Twin CAT 3 C++ when using online symbols [} 69]. 4.10.14 Pointers and references Pointer Pointer variables (e.g. POINTER TO) are generally not represented by the server in the namespace. If a pointer variable is located in a structure and this structure has been configured as Structured Data Type, the structure will not be displayed as Structured Data Type but as Folder Type. References Reference variables (REFERENCE TO) are represented as single variables by the server in the namespace and can be read without restrictions. If a reference is inside a structure, this structure can no longer be made available as Structured Types in the server, but only as Folder Type. However, access to the individual reference variables within the structure works. 4.10.15 Type system Requirements This functionality is only available for Data Access [} 49] devices based on Twin CAT 3 and the import of TMC [} 53] symbol files, as well as the online symbolism. One of the biggest advantages of OPC UA is the meta-model, which can be used to provide base types as well as to extend the type system with custom models. The same mechanism is used to represent real objects (nodes) so that OPC UA clients can determine an object type. 86 Version: 1.4.0 TF6100
## Page 87

Technical introduction The OPC UA server publishes type information from the IEC61131 world in its namespace. This includes not only base types such as BOOL, INT, DINT or REAL, but also extended type information such as the current class (function block) or structure that represents an object. Type information Type information is part of the UA namespace. The OPC UA server extends the base type information as follows: • Local type information that is only valid for one runtime is stored in the same namespace as the runtime symbols. • Global type information that can be valid for different runtimes is stored in a separate global namespace. The type system is also virtually available and can be viewed in the Types area of the OPC UA server: Every non-standard data type is entered in the Beckhoff Ctrl Types area. Basics Assuming the Twin CAT 3 PLC consists of a PLC program with different STRUCTs. Each STRUCT is represented as a node in a UA namespace, with each element of the structure as a subordinate node. In this sample the STRUCT st Sample Struct consists of three subordinate elements: one variable n Value1 of the type INT, one variable b Value2 of the type BOOL and a further STRUCT st Sub Struct, which contains only one subordinate element (variable n Value of the type INT). TF6100 Version: 1.4.0 87
## Page 88

Technical introduction The structure itself is a regular variable in the UA namespace and has the data type Byte String. The clients can therefore simply be connected to the root element (the structure itself), and its values can be read/ written by interpreting the Byte String. To simplify the interpretation of each subordinate element, the type system contains more information about the structure itself, primarily in the instance reference: In addition, the type system contains more information about ST_Sample Struct: And in the references of ST_Sample Struct: Overall, the type system can offer very useful information if a Client wants to interpret the structure further. 88 Version: 1.4.0 TF6100
## Page 89

Technical introduction Object-orientated extensions Assuming the Twin CAT 3 PLC runtime contains a PLC program whose structure can be visualized as follows: The two function blocks Scanner and Drive are derived from the base class Device by using object-oriented extensions of IEC61131-3. The program MAIN now contains the following declarations: PROGRAM MAIN VAR {attribute 'OPC. UA. DA':='1'} Scanner1 : Scanner; {attribute 'OPC. UA. DA':='1'} Scanner2 : Scanner; {attribute 'OPC. UA. DA':='1'} Drive X : Drive; END_VAR All three objects are of type Device, but also of their special data type. The OPC UA server imports the objects as follows: The base data type can now be determined in the reference of each object, e.g. object Scanner1: TF6100 Version: 1.4.0 89
## Page 90

Technical introduction According to the basic IEC61131 program, the object Scanner1 is of the data type Scanner and also shows which variables are contained and what type the variable is: input, output or internal (local) variable. The diagram above shows that not only the variables of the actual function block are displayed here, but also the derived variables of the base class. The entire IEC61131-3 inheritance chain is represented in the UA namespace. 4.10.16 DI Components Each PLC namespace on the server contains a number of nodes that can be used to specify static meta- information about the PLC. This optional information can be specified in the Tc Ua Da Config.xml for each namespace. The following table provides more information about these nodes. The concrete value assignments of the individual nodes can be application-specific to a large extent, therefore only example values are used in the delivery state of the server. The server itself makes these nodes available in its namespace, but does not independently change their value assignments. 90 Version: 1.4.0 TF6100
## Page 91

Technical introduction Node Description Device Manual Allows you to specify an address where the device manual can be found, e.g. a path in the file system or a web address. Device Revision Contains the revision level of a hardware component or the entire device. Hardware Revision Contains the revision level of the hardware. Manufacturer Contains the name of the device manufacturer, usually as FQDN (Fully Qualified Domain Name), e.g. beckhoff.com. Model Includes the name of the "product" (if applicable). Revision Counter May include a counter of how many times the configuration of the device has been updated. Serial Number Unique serial number of the device, as assigned by the device manufacturer. Software Revision Contains the version or revision level of the software component, the firmware of a hardware component or even the firmware of the device. 4.10.17 Device State Each namespace in the Twin CAT OPC UA Server contains a Device State object. This object indicates the state of the lower-level ADS device by means of various properties. typedef enum { UADEV_NOTINIT = 0x0100, UADEV_STARTING = 0x0110, UADEV_CONNECTED = 0x0120, UADEV_SHUTDOWN = 0x0130, UADEV_ERROR = 0x F000 }Ua Device State; If the device is in an ERROR state, the Error Code Property returns the following values: #define UA_DEVSTATE_INVALID_STATE 0x80EB0010 #define UA_DEVSTATE_CREATE_NS_FAILED 0x80EB0011 #define UA_DEVSTATE_LOAD_NS_FAILED 0x80EB0012 #define UA_DEVSTATE_INVALID_IO_SETTING 0x80EB0100 A corresponding error message is displayed in the Error Message Property. 4.10.18 Server State The Server State variable in the server namespace indicates the current state of the server. The following table gives an overview of the possible variable values. TF6100 Version: 1.4.0 91
## Page 92

Technical introduction Variable value Description Running The server has been successfully booted. Failed A problem was found in one of the server configuration files, e.g. an invalid configuration in Tc Ua Security Config.xml. No Configuration The server has not yet been initialized. Suspended The server has not yet been completely booted, i.e. not all functions may be available yet. 4.11 Historical Access 4.11.1 Overview This chapter describes the steps required for configuring the variables in the namespace of the Twin CAT OPC UA Server for Historical Access (HA). Historical Access is an OPC UA function in which (historical) variable values are stored in a memory (e.g. a file or a database) and made accessible to clients via a standardized interface. Here you can configure how the Twin CAT OPC UA Server reads and saves the variable values. Requirements This configuration can be carried out for variables from any runtime system [} 50] (e.g. Twin CAT PLC or Twin CAT 3 C++, ...). As a prerequisite, the respective variable must first be enabled for OPC UA. You can find out how to do this in our Quick Start [} 21] tutorial. Memory types The individual memory types are configured as so-called "History Adapters" in the Twin CAT OPC UA Server. This is done via the Twin CAT OPC UA Server configurator. Each History Adapter (except for the adapter type "Main memory" (Volatile)) can be used multiple times, e.g. if the historical values for individual variables are to be stored in different data memories. 92 Version: 1.4.0 TF6100
## Page 93

Technical introduction Sampling of the variable values The Twin CAT OPC UA Server can receive variable values in two different ways: 1. Using its own sampling engine and 2. From an OPC UA client (via the so-called "History Update" function) The sampling rate at which the variable is to be sampled from the lower-level real-time system and stored in the memory is configured for each variable in the separate sampling engine. The time at which the server read the variable value from the real-time is used as the timestamp. With the History Update function, on the other hand, the server receives both the variable value and the timestamp from a connected OPC UA client and therefore does not perform its own sampling. 4.11.2 Supported functions The following prerequisites apply to the use of Historical Access: • The runtime system whose symbols are to be stored for Historical Access must be configured for Data Access (and the respective variables must be enabled). • In order to use an SQL Compact database as a storage medium, SQL Compact Runtime 3.5 SP2 must be installed on the computer on which the OPC UA Server is running. • SQL Compact databases are also supported under Windows CE. • SQL Server databases are not supported under Windows CE. • The following MS SQL Server versions are supported: 2017, 2019 • The following recommendations apply when using the respective memory type: Main memory: number of entries < 5000 File system: number of entries < 10000 Database: number of entries >= 10000 Memory types The following memory types are supported: TF6100 Version: 1.4.0 93
## Page 94

Technical introduction Memory type TF6100 Server Setup Operating systems Description version Main memory 4.x and 5.x Windows, Windows CE, Saves the values in the RAM Twin CAT/BSD of the device on which the OPC UA Server is running. No further parameters are required. After restarting the device, the stored values are no longer available. The storage medium is therefore not persistent. The above requirements and recommendations apply. File system 4.x Windows, Windows CE Saves the values in several files, the location of which can be specified. Each symbol configured for this storage medium is assigned its own file in this directory. In addition, there is a backup copy of the file for each symbol, which is created when the buffer size is reached. The contents of the data file are then saved as a backup copy, and a new file is created. The above requirements and recommendations apply. SQL Compact 4.x Windows, Windows CE Saves the values to an SQL database Compact database, the location of which can be specified. The above requirements and recommendations apply. MS SQL Server 4.x Windows Saves the values in an SQL database Server database that is referenced with various parameters. The above requirements and recommendations apply. Twin CAT Analytics 5.x Windows, Twin CAT/BSD Saves the values in a file format that corresponds to the [} 96] Twin CAT Analytics storage format. The data can therefore be used further with the Twin CAT Analytics Toolchain. This format has replaced the old file-based storage format since TF6100 version 5.x (see above). 4.11.3 Configuration You can use the Twin CAT OPC UA Configurator to configure the Historical Access functionality. To configure a symbol for Historical Access, you must perform three steps: 1. The symbol must have been enabled for Data Access (see chapter Enabling symbols [} 53]). 2. A memory type must be created in which the symbol values are to be saved. 3. Configuration parameters must be defined for the symbol. 94 Version: 1.4.0 TF6100
## Page 95

Technical introduction Creating a memory type In the standalone version of the Twin CAT OPC UA Configurator you can configure the memory types (so- called "History Adapters") via the Historical Access tab. In the following screenshot, for example, the memory type "Main memory" ("Volatile") has been configured. Additional memory types can be created or existing memory types can be edited or removed from the configuration via the context menu. Configuring a symbol In the "History Nodes" section of the same dialog, you can configure the symbols and link them to a memory type. You can either create a symbol manually (assuming you know its "address" or Node ID), or simply drag and drop an existing symbol into the configuration area using the integrated Target Browser. The symbol is then added with default configuration values. You can modify these configuration values by double-clicking on the symbol entry. Here you can also create the link to a memory type, which is referenced via its ID. TF6100 Version: 1.4.0 95
## Page 96

Technical introduction 4.11.4 History Update With the History Update function, the server does not independently sample variable values and save them for Historical Access. Instead, the server receives both the variable values and the timestamps from an OPC UA client. A variable can be enabled for this function by setting the attribute History Writeable="true" in the Twin CAT OPC UA Configurator. In this case, the server no longer performs its own sampling for this variable and "waits" for an OPC UA client to provide the values plus timestamp. Such a call can be made, for example, by the Twin CAT OPC UA Client via the function block UA_History Update. 4.11.5 Twin CAT Analytics When using the "Twin CAT Analytics" memory type, a binary file is written as memory, the format of which corresponds to the Twin CAT Analytics data format. Although this has no relevance for the OPC UA client (as it accesses the historical data via OPC UA), it does open up interesting possibilities for further use of the historical data, as you can read the binary file into the Twin CAT Analytics Toolchain and process it there. The following diagram illustrates this relationship. 96 Version: 1.4.0 TF6100
## Page 97

Technical introduction Twin CAT Target Browser If you use the Twin CAT Analytics storage format in your Historical Access configuration, you can also get the stored values via the Twin CAT Analytics Toolchain, for example the Twin CAT Target Browser. To do this, add the directory that you have defined in your configuration for saving the historical values in the Tc Analytics File tab of the Twin CAT Target Browser. The saved values are then displayed as records in the usual Twin CAT Analytics form and can be processed further. 4.11.6 Access to historical data You can use any OPC UA client that supports the OPC UA Historical Access function to get historical data. In the following example, the "UA Expert" software from Unified Automation is used to read historical data from the Twin CAT OPC UA Server and display it visually. Displaying Historical Access values in an OPC UA client The following step-by-step instructions describe how to configure the UA Expert software in order to access historical data. 1. Start the UA Expert software and connect to the OPC UA Server. TF6100 Version: 1.4.0 97
## Page 98

Technical introduction 2. Add a new History Trend View. 3. Browse the PLC1 namespace and use drag & drop to add the PLC variables _History DB, _History DBcompact, _History Fast and _History Slow Persist. 98 Version: 1.4.0 TF6100
## Page 99

Technical introduction ð You can now use the Start Time and End Time controls to specify the desired time period for which the symbol values are to be displayed, or you can start a Cyclic Update for these variables if necessary. 4.12 Alarms and Conditions 4.12.1 Overview This chapter describes the configuration steps for using OPC UA Alarms and Conditions (A&C) on the Twin CAT OPC UA Server. OPC UA A&C describes a model for monitoring symbol values and issuing alarms and events when values change or threshold values of a symbol are exceeded. Requirements This configuration can be carried out for variables from any runtime system [} 50] (e.g. Twin CAT PLC or Twin CAT 3 C++, ...). As a prerequisite, the respective variable must first be enabled for OPC UA. You can find out how to do this in our Quick Start [} 21] tutorial. 4.12.2 Supported functions The following table lists the supported standard Alarm Types of the Alarms & Conditions function of the Twin CAT OPC UA Server. TF6100 Version: 1.4.0 99
## Page 100

Technical introduction Alarm Type Description Limit Alarm Type Allows you to define different threshold values for a symbol. If a threshold value is exceeded, the alarm is triggered with a configurable alarm text and severity level. Off Normal Alarm Type Enables the definition of “normal” and “non-normal” threshold values for a symbol. If the value of the symbol deviates from the defined value, the alarm is triggered. BOOL usage with Off Normal Alarm Type If a BOOL is to be used for the Off Normal Alarm type, the notation true and false must be used. If capitalized, the Twin CAT OPC UA Server assumes a STRING and no longer interprets the value as a BOOL. In addition to the Alarms & Conditions function, the Twin CAT OPC UA Server also offers the option to connect to the Twin CAT Event Logger [} 112] and forwarding the alarms or events received there accordingly as an OPC UA Alarm or Event. 4.12.3 Configuration You can use the Twin CAT OPC UA Configurator to configure the Alarms & Conditions functionality. To configure a symbol for Alarms & Conditions, you must perform two steps: 1. The symbol must have been enabled for Data Access (see chapter Enabling symbols [} 53]). 2. A Condition Controller must be created that allows alarms and events to be grouped. 3. Alarm and event texts must be created. 4. Configuration parameters must be defined for the symbol. Creating a Condition Controller In the stand-alone version of the Twin CAT OPC UA Configurator, you can configure the Condition Controller via the Alarms & Conditions tab. In the following screenshot, for example, a Condition Controller with the name "My Condition Controller" has been configured. Additional Condition Controllers can be created or existing Condition Controllers can be edited or removed from the configuration via the context menu. Creating alarm and event texts The texts that are to be used when reading an alarm or event can be stored as so-called "resources" in the Twin CAT OPC UA Server. These texts can be defined in several languages, whereby the language is identified by the respective country code. In the Twin CAT OPC UA Configurator, these resources are added via the Resources tab in the Alarms & Conditions configuration. 100 Version: 1.4.0 TF6100
## Page 101

Technical introduction You can add, delete or edit other languages as a resource via the context menu. In the screenshot above, two languages have been configured as resources: de-DE (German/Germany) and en-US (English/USA). The texts are maintained in tabular form within a language and can also be copied and pasted from Microsoft Excel. The configured texts are assigned across languages via their ID, for example: Use of the national language for an Alarm/Event The language text used when triggering an alarm or event depends on the country code used to connect an OPC UA client to the server. Configuring a symbol Once the alarm and event texts have been configured, you can also use them to configure a symbol. The symbol configuration is carried out in the Settings tab. You can configure an icon manually or simply drag and drop it onto the configuration area using the integrated Target Browser. TF6100 Version: 1.4.0 101
## Page 102

Technical introduction The symbol is then added to the selected Condition Controller. In the following configuration dialog, you can define the alarm type to be configured as well as the threshold values and also select the language texts. 102 Version: 1.4.0 TF6100
## Page 103

Technical introduction 4.12.4 Additional application data If you would like to attach additional data from your application to an alarm, you can configure this using the following special Alarm Types: Alarm Type Derived from Bk Ua Limit Alarm Type Limit Alarm Type Bk Ua Off Normal Alarm Type Off Normal Alarm Type Additional fields are defined in these Alarm Types, which you can fill with values from your application. If an OPC UA client is to be able to use these additional values, it must subscribe to and interpret the corresponding Alarm Types. The OPC UA client then receives the additional application data in the fields Bk Ua Event Data and Bk Ua Event Value of the incoming alarm, for example: TF6100 Version: 1.4.0 103
## Page 104

Technical introduction The user-defined Event Fields are appended as "User Event Data". This data can be received by OPC UA clients that are logged on to the Simple Event Type "User Event Type". To use this function, you must define a structure in the PLC that contains both the symbol value to be monitored and the additional values that are to be sent when the alarm is triggered. This structure must be defined as follows: TYPE ST_Custom Struct : STRUCT value : INT; data : ST_Some Struct; END_STRUCT END_TYPE TYPE ST_Some Struct : STRUCT 104 Version: 1.4.0 TF6100
## Page 105

Technical introduction Data1 : INT; Data2 : REAL; Data3 : LREAL; END_STRUCT END_TYPE The instance of the structure ST_Custom Struct is then enabled as a symbol for Data Access [} 53]. The structure must also be enabled as a Structured Type [} 76]. 4.12.5 Access to alarms and events To receive alarms and events, an OPC UA client on the Twin CAT OPC UA Server must log in to one of the configured Condition Controllers. The client then receives the alarms and events for symbols that have been configured in this Condition Controller. The following example shows how you can use the UA Expert software from Unified Automation to subscribe to a Condition Controller in order to receive alarms and events from it. After you have started the UA Expert and established a connection to the Twin CAT OPC UA Server, add a new document view of the type "Event View" to your working area. In the address space of the server, you will find all configured Condition Controllers below the "A&C" node. You can now drag and drop a Condition Controller from the "Event View" working area to subscribe to it. The alarms and events for this Condition Controller are then displayed in the Event Window. TF6100 Version: 1.4.0 105
## Page 106

Technical introduction 4.13 Method calls 4.13.1 Overview Two different concepts are available in the PLC for calling OPC UA methods: 1. RPC methods [} 109] and 2. Job methods [} 106] The fundamental difference between the two concepts is the context of processing in the PLC and the implementation in the PLC code. The following table illustrates this relationship. Type Processing PLC code RPC method Within a PLC cycle OPC UA method is represented by a PLC method. Job method Over several PLC cycles OPC UA method is represented by a PLC function block. Generally speaking, one can define: Job methods are the method of choice if a method call takes a "long" time, i.e. can take several PLC cycles. The processing of RPC methods, on the other hand, must be "fast", otherwise there is a risk of cycle overruns. So Job methods are usually selected. Programming in the PLC is somewhat more complex, but the decoupling from the PLC cycle is a great advantage that justifies this effort. 4.13.2 Job methods The concept of Job methods has a fundamental difference compared to regular method calls: the OPC UA methods are no longer mapped 1:1 to a PLC method, but instead to a function block with a specific signature. This also allows method calls to be realized that take longer than one cycle from the perspective of a PLC application. Requirements This functionality is only available for Data Access [} 49] devices based on Twin CAT 3 and the import of TMC [} 53] symbol files, as well as the online symbolism. The PLC-side structure of such a Job method is defined as follows: there is a function block which is defined as a Job method via a PLC attribute. The function block then contains various PLC methods that are accessed by the Twin CAT OPC UA Server in the form of a handshake mechanism in order to be able to provide them as OPC UA methods. 106 Version: 1.4.0 TF6100
## Page 107

Technical introduction Method Description Start Is called by the server as soon as an OPC UA client calls the OPC UA method. Contains the input parameters of the OPC UA method call as VAR_INPUT. The HRESULT return value of the method can be used to directly return an OPC UA Status Code in its decimal representation, e.g. “0” for the Status Code “Good”. The numerical value of a Status Code defined in the OPC UA specification is used as the value. A definition of all available Status Codes can be viewed here: http://www.opcfoundation.org/UA/schemas/Status Code.csv Typically, this method returns the value “0” (Good). However, the PLC developer can also decide to validate the input parameters, for example. In the event of an error, the OPC UA method call could then fail, e.g. with the return value “2158690304” (Bad Invalid Arguments). Check State Is called cyclically by the server to check whether the job is still being processed or not. As long as the job is still being processed, this method returns the value “Busy”, otherwise “Done”. Output parameters for the OPC UA method are declared here as VAR_OUTPUT. The HRESULT return value of the method can be used to directly return an OPC UA Status Code in its decimal representation, e.g. “0” for the Status Code “Good”. The numerical value of a Status Code defined in the OPC UA specification is used as the value. A definition of all available Status Codes can be viewed here: http://www.opcfoundation.org/UA/schemas/Status Code.csv If the job is processed successfully, this method typically returns the value “0” (Status Code “Good”). However, the PLC developer can also decide that the OPC UA method call should fail in the event of an error, e.g. with the return value “2151415808” (Bad Out Of Range) or the more general “2147483648” (Bad). Abort This method is called by the server if a job has to be aborted, for example if the server is shut down or restarted. The PLC developer then has the opportunity to clean up his PLC code accordingly. Workflow The handshake mechanism between server and PLC can be represented in simplified form as follows: TF6100 Version: 1.4.0 107
## Page 108

Technical introduction Example The following example is also available in executable form at Examples. This part of the documentation is intended to explain the basic concepts of how the system works. The example “simulates” a Job method call that takes about four seconds to be processed in the PLC. This was realized with the help of a timer, which was declared and used in the function block part of the job. The State Machine of the function block delays the completion of the job (the Check State handshake method returns “busy”) and the job is not completed until the timer has expired (the Check State handshake method returns “done”). In this example, a function block called FB_Job was created for the OPC UA method with the name “My Job”, which has the required signature mentioned above. The function block declaration contains the attribute OPC. UA. DA. Job Method and the name of the OPC UA method to be used as its value. {attribute 'OPC. UA. DA. Job Method' := 'My Job'} FUNCTION_BLOCK FB_Job VAR END_VAR The three methods Abort, Check State and Start contain the attribute Tc Rpc Enable in their declaration (so that the methods can also be called via ADS). Example: {attribute 'Tc Rpc Enable' := '1'} METHOD Start : HRESULT 108 Version: 1.4.0 TF6100
## Page 109

Technical introduction {attribute 'Tc Rpc Enable' := '1'} METHOD Abort : HRESULT {attribute 'Tc Rpc Enable' := '1'} METHOD Check State : HRESULT The input parameters of the OPC UA method are declared as VAR_INPUT in the PLC method Start(). Comments after the variables are used as a description of the respective OPC UA input parameter. Example: {attribute 'Tc Rpc Enable' := '1'} METHOD Start : HRESULT VAR_INPUT a : INT; // some description b : LREAL; // some description c : BOOL; // some description d : ST_Complex_1; // some description END_VAR VAR_OUTPUT hdl : UDINT; // handle, can be used for concurrent calls END_VAR The output parameters of the OPC UA method are declared as VAR_OUTPUT in the PLC method Check State(). Comments after the variables are used as a description of the respective OPC UA output parameter. Example: {attribute 'Tc Rpc Enable' := '1'} METHOD Check State : HRESULT VAR_INPUT hdl : UDINT; // handle, can be used for concurrent calls END_VAR VAR_OUTPUT b Busy : BOOL; // required a : INT; // some description b : LREAL; // some description c : BOOL; // some description d : ST_Complex_1; // some description END_VAR (In this example, the values of the input parameters are applied 1:1 to the output parameters for illustrative purposes. The input and output parameters are therefore identical.) Simultaneous method calls Simultaneous method calls can be managed via the PLC application. For this purpose, a handle (output variable hdl) can be returned to the server via a return value of the Start() method, which is then used as an input variable for all further calls to the Check State() method. This enables the PLC application to determine an execution context for the respective method call. In summary, the workflow is as follows: • The Start() method determines the execution context and returns a handle to the server via the output variable “hdl”. • The server now uses this handle for the cyclic Check State() calls and lets the PLC application know which execution context is involved. 4.13.3 RPC methods Method calls are a fundamental part of the OPC UA specification. With the introduction of these functionalities into the PLC world, Twin CAT 3 offers the possibility of efficiently executing RPC calls in the IEC61131 world and thus reduces the classic handshake patterns for communication between devices. With the concept of RPC methods, the Twin CAT OPC UA Server imports a method from the Twin CAT PLC/ C++ directly as an OPC UA method. Requirements This functionality is only available for Data Access [} 49] devices based on Twin CAT 3 and the import of TMC and TMI [} 53] symbol files, as well as the online symbolism. An RPC method call is handled at OPC UA level as follows: TF6100 Version: 1.4.0 109
## Page 110

Technical introduction • If an RPC method has been executed successfully, the server returns the status code "Good" as feedback for the OPC UA method call. • If the RPC method could not be called, the server returns an error message in the "Bad_***" format, depending on the error that occurred. • If the RPC method was called successfully but the response could not be read in the server, the status code "Opc Ua_Good Post Action Failed" is returned from the server. Processing context The Twin CAT PLC/C++ method is executed within the real-time context and therefore falls within the processing context of a real-time task. The Twin CAT developer must therefore take precautions so that the execution time of the method matches the task cycle time. Methods in Twin CAT 3 PLC Methods in the IEC61131 world are always configured below a function block. At high-level language level, the function block can be regarded as the surrounding class of the method. You have to declare the method itself with a special PLC attribute so that the Twin CAT system knows that the method is to be activated for a remote method call. {attribute 'Tc Rpc Enable':='1'} METHOD M_Sum : INT VAR_INPUT a : INT; b : INT; END_VAR Depending on the import mode used, you also have to enable the surrounding function block for the OPC UA access. This can be done by using the normal PLC attributes for OPC UA access. Note that you only need to use the PLC attributes if the filtered mode is used to enable symbols from the PLC to be accessed via OPC UA. This is the default setting of the OPC UA Server. Sample: The method M_Sum is located in the function block FB_Mathematics. The declaration of the function block instance uses the PLC attribute that has enabled the function block and thus the method for OPC UA access. PROGRAM MAIN VAR {attribute 'OPC. UA. DA':='1'} fb Mathematics : FB_Mathematics; END_VAR 110 Version: 1.4.0 TF6100
## Page 111

Technical introduction Pointer variables as VAR_IN_OUT Pointer variables defined as VAR_IN_OUT are not handled by the PLC or the Twin CAT OPC UA Server. A corresponding Trace event is written to the server trace. 08:47:37.677Z|1|11A0* Error when importing method 'METH_PArray': VAR_IN_OUT pointer variables are not allowed! Methods in Twin CAT 3 C++ Twin CAT modules could implement interfaces with predefined methods (see Tc COM modules). The method itself must be enabled for RPC calls during its definition (see Twin CAT Module Class Wizard documentation) so that the OPC UA Server knows that it is ready for execution. So that the return value of the method is available, the corresponding option Include Return Value must be activated. Note that the interface under which the method was created must be implemented. Depending on the import mode used, you have to declare the method for the access via OPC UA. This can be done by using the TMC Code editor and the usual OPC UA attributes as optional properties. TF6100 Version: 1.4.0 111
## Page 112

Technical introduction 4.14 Twin CAT Event Logger 4.14.1 Overview The Twin CAT OPC UA Server enables integration of the Twin CAT Event Logger for sending alarms and events. An alarm/event is converted by the Twin CAT Event Logger into an OPC UA alarm or event. Event Logger messages from more than one Twin CAT device can be configured in the Twin CAT OPC UA Server. Each device is identified by its AMS Net ID. The integration of the Twin CAT Event Logger is not available for the Twin CAT OPC UA Server under Windows CE. However, you can install the Twin CAT OPC UA Server on a non-CE device and then remotely receive Twin CAT Event Logger messages from a Windows CE device. The integration of the Twin CAT Event Logger is only available in connection with the Twin CAT 3 Event Logger. The Twin CAT 2 Event Logger is not supported. 4.14.2 Configuration To configure the server for a connection to the Event Logger, you have to create a new configuration file named "Tc Ua Event Log Config.xml" in the server directory. This file contains a list of Twin CAT Event Logger devices, which are identified by their AMS Net ID. The configuration has the following structure: <Tc Ua Event Log Config> <Event Logger Device Name="Local Event Logger" Ams Addr="127.0.0.1.1.1"/> <Event Logger Device Name="Remote Event Logger" Ams Addr="192.168.0.56.1.1"/> </Tc Ua Event Log Config> The individual device entries are then displayed in the "Event Logger Devices" folder in the server's namespace. 112 Version: 1.4.0 TF6100
## Page 113

Technical introduction An OPC UA client can now subscribe to the corresponding object in order to receive events and/or alarms from the respective Twin CAT Event Logger device. In contrast to an event, an alarm is additionally displayed as a child element by the respective Event Logger device. 4.14.3 Access to alarms and events When subscribing to the object and receiving alarms or events, a client must take into account that special object types are used. The respective types are defined as follows: Tc Event Logger Event Type The Tc Event Logger Event Type is derived from the Base Event Type and extends it with Twin CAT Event Logger-specific properties: Node ID: i=4200 Namespace Name: urn:Beckhoff Automation:Ua:Types:Global Types Tc Event Logger Alarm Condition Type The Tc Event Logger Alarm Condition Type is derived from the Alarm Condition Type and extends it with Twin CAT Event Logger-specific properties: TF6100 Version: 1.4.0 113
## Page 114

Technical introduction Node ID: i=4000 Namespace Name: urn:Beckhoff Automation:Ua:Types:Global Types Sample The following sample is based on the standard code sample of the Twin CAT Event Logger, which can be obtained from the Beckhoff Information System. This sample contains code snippets for the PLC, which can be used to fire an event as well as an alarm. Step 1: Configuration of the server Twin CAT OPC UA Server and the PLC are now running locally on the same system in this sample. Accordingly, the Tc Event Log Config.xml was also created: <Tc Ua Event Log Config> <Event Logger Device Name="Local Event Logger" Ams Addr="127.0.0.1.1.1"/> </Tc Ua Event Log Config> Step 2: Activating the Twin CAT Event Logger sample Before enabling the Twin CAT Event Logger sample, we first disabled the automatic firing of an event or alarm. In the present sample version this is done by initializing b Send and b Alm Raise with the value FALSE. The project is then activated and executed in the local PLC runtime. Step 3: Connecting an OPC UA Client to the Server The UA Expert was selected as the OPC UA client. After establishing a connection with the server, you now add a new "Event View" document in UA Expert. Then drag and drop the configured Twin CAT Event Logger device into the Event View. 114 Version: 1.4.0 TF6100
## Page 115

Technical introduction In order to receive the Twin CAT Event Logger-specific properties, the UA Expert must filter the corresponding Event or Alarm Type. You can find the Tc Event Logger Event Type or Tc Event Logger Alarm Condition Type in the type list of the Event View. Sample: By clicking on the Apply button, these filters are applied. Step 4: Firing an event In the Twin CAT Event Logger Sample, we set the variable b Send to the value TRUE in order to fire an event. The UA Expert receives this event automatically and displays it in the Event View together with the Twin CAT Event Logger-specific properties. TF6100 Version: 1.4.0 115
## Page 116

Technical introduction Step 5: Firing an alarm In the Twin CAT Event Logger sample, we set the variable b Alm Raise to the value TRUE in order to fire an alarm. The UA Expert receives this alarm automatically and displays it in the Event View together with the Twin CAT Event Logger-specific properties. In addition, the alarm is displayed as a separate object in the namespace below the Event Logger device. Step 6: Acknowledging an alarm In addition to receiving an alarm, it can also be acknowledged. The acknowledgement is also reported by the server to the Twin CAT Event Logger. In UA Expert, an alarm can be acknowledged via the context menu in the Event View. 116 Version: 1.4.0 TF6100
## Page 117

Technical introduction Acknowledge and Confirm Please note that only a Confirm is reported back to the Twin CAT Event Logger. The information about an acknowledge remains in the server, since the Twin CAT Event Logger currently only provides for the concept of a Confirm. After a Confirm the corresponding variable e Confirmation State is set in the Twin CAT Event Logger instance of type FB_Tc Alarm. 4.15 Global Discovery Server 4.15.1 Overview The Twin CAT OPC UA Server enables registration with a Global Discovery Server (GDS). A GDS provides a standardized, OPC UA-based interface for registering OPC UA applications and issuing application certificates as well as the associated revocation list information. A GDS has a connection to a Certificate Authority (CA) for this purpose. Applications are registered and certificates are issued (and updated) using a standardized OPC UA information model. When accessing the GDS, the Twin CAT OPC UA Server supports the two models Push [} 117] and Pull [} 118]. 4.15.2 Push In this model, the server includes a standardized interface that an OPC UA client (that supports the push model) can use to connect to a Global Discovery Server on behalf of the server, register the server application there and request a server certificate including the current Certificate Revocation List (CRL). TF6100 Version: 1.4.0 117
## Page 118

Technical introduction As a prerequisite for using this functionality, the OPC UA client must authenticate itself on the server with a user account that has administrator rights. OPC UA Client Any client that supports the Push model can be used as an OPC UA client. Various OPC UA toolkit manufacturers offer corresponding software packages. Alternatively, the OPC Foundation also provides a GDS Sample Client on Github. GDS Server Any GDS can be used as a Global Discovery Service. Various OPC UA toolkit manufacturers offer corresponding software packages. Alternatively, the OPC Foundation also provides a GDS Sample Server on Github. Configuration in the server No further special configuration steps are required in the Twin CAT OPC UA Server to use this functionality. The corresponding interface is activated by default and can be used by a user with administrator rights. The user configured during initialization [} 28] has all the necessary permissions for this. 4.15.3 Pull In this model, the server independently connects to the Global Discovery Server, registers there as a server application and obtains a suitable certificate. The Twin CAT OPC UA Server offers an option to enable and configure the GDS pull functions via its configuration namespace. 118 Version: 1.4.0 TF6100
## Page 119

Technical introduction Alternatively, the Twin CAT OPC UA Configurator can also be used to configure this function in the server. A corresponding user interface is available for this purpose. Configuration via OPC UA Client The following section describes the configuration via the address space of the server using a generic OPC UA client. The UA Expert from Unified Automation is used as the client software. In the first step, the Twin CAT OPC UA Server must be registered as an application at the GDS. This is done using the Register() method. By registering with the GDS, a server certificate is automatically requested for the server application. Depending on the implementation of the GDS application, such a certificate is issued either automatically or after manual approval by an administrator. The variables Registration State and TF6100 Version: 1.4.0 119
## Page 120

Technical introduction Certificate State can be used to check whether the server has already been registered with a Global Discovery Service and has received a certificate from it. The variable Crl State indicates the status of the Certificate Revocation List and whether it could be obtained from the GDS. The method expects the following input parameters: Input parameter Meaning Gds Url The URL of the Global Discovery Service in the format opc.tcp:// hostname Or Ip Address:port Gds User Username of a GDS user with the right to register new applications. Gds Password User password Save Credentials Saves the user password in a configuration file of the Twin CAT OPC UA Server. For security reasons, this setting is not recommended. It was developed exclusively for Global Discovery Services, which require mandatory username/password authentication. Username/ password authentication is usually only required once when registering the application. The issued server certificate is then used for all subsequent connections to the GDS. Re-initialization of the server endpoints After registering the server application with the Global Discovery Service and obtaining a server certificate, the server reinitializes its endpoints once, causing connected clients to momentarily lose connectivity. After the server application has been registered with a Global Discovery Service, a new file named "Tc Ua Gds Client Config.xml" is created in the installation directory of the Twin CAT OPC UA Server. It contains the connection information of the configured GDS and the registration information obtained from there, plus timestamp information for the server application, e.g., when the certificate and CRL were last updated. Unregistration at the Global Discovery Service The Unregister() method can be used to unregister the Twin CAT OPC UA Server application with the GDS. Successful execution of the method causes the server application to be unregistered on the GDS and the contents of the Tc Ua Gds Client Config.xml file to be deleted. The method expects the following input parameters: 120 Version: 1.4.0 TF6100
## Page 121

Technical introduction Input parameter Meaning Force Remove If the connection to the Global Discovery Service is no longer available, the connection to the GDS can be removed by setting this input parameter. The Twin CAT OPC UA Server removes the GDS from its configuration. The issued server certificate and the CRL remain valid after the Twin CAT OPC UA Server has been decoupled from the GDS. If you want to delete them and run the server with a self-signed certificate, you have to remove the corresponding files in the PKI directory of the server and restart the server. The server then creates another self-signed certificate. Updating the server certificate An update of the server certificate can be requested from the GDS outside the regular update interval by executing the method Update Certificate(). The method does not expect any further input parameters. Setting the update intervals for server certificate and CRL The update intervals for the server certificate and the certificate revocation list can be set by executing the Set Update Strategy() method. The method expects the following input parameters: TF6100 Version: 1.4.0 121
## Page 122

Technical introduction Input parameter Meaning Crl Update Interval Sets the update interval for the certificate revocation list (seconds). Certificate Check Interval Sets the update interval for the server certificate (seconds). 4.16 Security 4.16.1 Overview One of the reasons OPC UA has been so successful as a communication technology is because of its integrated security mechanisms. Data communication based on OPC UA can be secured on two layers: transport and application layer. When connecting to the server, the client first selects an endpoint, which specifies the security functions to be used. Endpoints A server offers the client a list of different endpoints [} 122] to which the client can connect. An endpoint describes, among other things, which security functions (e.g. Message Security mode, Security Policy and available Identity Tokens) the communication connection via this endpoint should fulfill. For example, an endpoint may require signing and encryption of data packets (transport layer), as well as additional authentication of the client based on username/password (application layer). Transport layer A communication connection based on OPC UA can be secured at the transport layer. This is done through the use of client/server certificates and a mutual trust relationship between client and server application. Here, the client must trust the server certificate and vice versa in order for a communication connection to be established. This requires a mutual certificate exchange [} 123]. Application layer In addition to the transport layer, a communication connection can also be secured at the application layer. For this purpose, various authentication mechanisms [} 125] are available, which are offered by the server endpoint. 4.16.2 Endpoints The Twin CAT OPC UA Server makes various endpoints available for OPC UA Clients via the default port 4840/tcp. The endpoints define the connection type between client and server and whether it should be secured or unsecured. Standard port Note that the standard port 4840 may be used by other OPC UA servers, such as the Local Discovery Server (LDS) from the OPC Foundation, which is used by some vendors with OPC UA software packages. Relationship of trust Note that in order to use the secure endpoints, a trust relationship must be established between server and client, which is usually done via their certificates. Here is how to configure such a trust relationship on the server side [} 123]. Deprecated endpoints Please note that the security profiles currently available in the endpoints may be classified as potentially insecure over time and will be replaced by newer ones. In this case, an update of the Twin CAT OPC UA Server is recommended. A configuration switch (<Allow Deprecated Security Policies>) can be used to reactivate security policies that are deprecated and classified as insecure. For security reasons, Beckhoff recommends to leave this configuration switch disabled. 122 Version: 1.4.0 TF6100
## Page 123

Technical introduction List of endpoints The following list summarizes the endpoints of the Twin CAT OPC UA Server. This includes endpoints that have already been discontinued. By default, the Twin CAT OPC UA Server only offers endpoints that are currently considered secure. Since setup version 4.3.28, the unencrypted endpoint has also been disabled by default for security and certification reasons. Security profile Security mode Short description None None No encryption or signing of messages is carried out at this endpoint. Authentication, on the other hand, is possible. Basic128Rsa15 (deprecated) Sign This endpoint has been classified as deprecated from a security Sign & Encrypt perspective and is disabled by default. If necessary, the endpoint can be enabled again. Basic256 (deprecated) Sign This endpoint has been classified as deprecated from a security Sign & Encrypt perspective and is disabled by default. If necessary, the endpoint can be enabled again. Basic256Sha256 Sign Endpoint currently present in the server for secure signing and Sign & Encrypt encryption. Additional authentication is possible. Aes256_Sha256_Rsa Pss Sign Endpoint currently present in the server for secure signing and Sign & Encrypt encryption. Additional authentication is possible. Aes256_Sha256_Rsa Oaep Sign Endpoint currently present in the server for secure signing and Sign & Encrypt encryption. Additional authentication is possible. All endpoints in the list can be enabled or disabled via the server configuration. In the following figure, all endpoints are enabled. 4.16.3 Certificate exchange In order to establish a secure communication connection at the transport layer via a secure endpoint [} 122], mutual trust must be established between the client and the server. By default, both the Twin CAT OPC UA Server and the Twin CAT OPC UA Client generate a machine-specific, self-signed key pair consisting of a public and a private key when they are started for the first time, with the corresponding certificate having a validity period. TF6100 Version: 1.4.0 123
## Page 124

Technical introduction Validity period of the certificate The self-signed certificate has a default validity period of 20 years. This is a server-specific setting that can be adjusted as necessary. Instead of using the self-signed certificate, you can also have a certificate issued by any certification authority and use it. However, we recommend using a Global Discovery Server [} 117] to reduce the administrative workload. To establish a trust relationship between an OPC UA Client and the Twin CAT OPC UA Server, you need the public key of the client certificate. The server must trust this certificate. The server manages the trust settings for client certificates in a subdirectory of the application directory [} 47]. The following diagram illustrates the relationship between the client and server certificate when establishing a secure communication connection: The client transmits its public key with the Create Session request. The server then has the option of checking the trust relationship. If the server trusts the client, it transmits its own public key in its response. The client therefore also has the option of checking the trust relationship with the server. If mutual trust is ensured, the communication connection is initiated. The server’s public key is used to encrypt a request from the client to the server. The response from the server to the client is then encrypted with the client’s public key. Both communication participants have the option of decrypting the received message with their private key. Messages are signed in reverse: a message is signed with the sender’s private key. Since the recipient recognizes the sender’s public key, the signature can be verified. Configure trust relationship via file system By moving client certificates between the trusted/rejected directories, the trust settings can be adjusted accordingly. The public key of a client certificate is automatically stored in the directory for rejected certificates the first time the client attempts to connect to a secure endpoint. By subsequently moving the public key to the directory for trusted certificates, the client is trusted at the next connection attempt and can connect. Automatically Trust All Client Certificates If this configuration option is enabled on the server, it automatically trusts all client certificates. In this case, they will not be listed in any of the above directories. Configure the trust relationship using the configurator You can also adjust the trust settings via Configurator [} 40]. The Twin CAT OPC UA Configurator includes a graphical user interface for configuring the trust settings. 124 Version: 1.4.0 TF6100
## Page 125

Technical introduction 4.16.4 Authentication An OPC UA client application can authenticate itself to the Twin CAT OPC UA Server via various Identity Tokens. The following Identity Tokens are supported: • Anonymous • Username/Password • User certificate Delivery state The "Anonymous" Identity Token is enabled when the server is delivered; however, the server requires a one-time initialization to get started. This Identity Token is then disabled and client applications must authenticate themselves with a username on the server. Anonymous This type of authentication allows any OPC UA client to connect to the server application. It is not necessary to specify a user identity, which means that there are no options for defining access rights on the server. Beckhoff recommends disabling this authentication type after commissioning the server. This can be done via the Twin CAT OPC UA Configurator. Below you will find an example screenshot from the OPC UA client application "UA Expert": TF6100 Version: 1.4.0 125
## Page 126

Technical introduction Username/Password This type of authentication uses a username/password combination to authenticate the client to the server application. On the server, access rights can then be defined for the respective user identity. The user identity can be defined on different levels: • User identity is defined in the server • User identity comes from the lower-level operating system (e.g. a local Windows user) • User identity comes from the Active Directory (e.g. if the industrial PC is part of a Windows domain) Recommendation when using User Identity Tokens If User Identity Tokens are to be used to authenticate client applications, Beckhoff recommends against the user identity being defined in the OPC-UA server. Instead, the user account should be defined in the operating system or, if applicable, Active Directory. Below you will find an example screenshot from the OPC UA client application "UA Expert": User certificate This type of authentication uses a certificate to authenticate to the server application. The handling of user certificates on the server side is identical to the use of certificates on the transport layer, i.e. the server must trust the (user) certificate before the client can successfully authenticate itself to the server with the certificate. A separate directory ("pkiuser") for the administration of user certificates is available in the server for this purpose. Below you will find an example screenshot from the OPC UA client application "UA Expert": In addition, an X.509 user must be created via the Twin CAT OPC UA Configurator in order to use this authentication method. The name of the user must match the Common Name of the certificate. 126 Version: 1.4.0 TF6100
## Page 127

Technical introduction NOTICE Authentication and server certificate When using the unencrypted endpoint in combination with authentication, the Twin CAT OPC UA Client still requires the public key from the OPC UA Server certificate in order to encrypt the password during transmission. To this end the certificate must be trusted in the Twin CAT OPC UA Client (see Certificate exchange [} 123]). Configuration The Identity Token is usually configured via the Twin CAT OPC UA Configurator. A graphical user interface is available here to enable Identity Token, for example in the standalone configurator: 4.16.5 Access rights The Twin CAT OPC UA Server enables the configuration of access rights for specific authenticated user identities [} 125]. These access rights can be configured for entire namespaces as well as for individual nodes. This allows both access to ADS devices (e.g. to different PLC runtimes) and individual symbols to be set with fine granularity. These security settings are available for all Data-Access [} 49] devices that can be represented in the server namespace. TF6100 Version: 1.4.0 127
## Page 128

Technical introduction This functionality is configured via the Twin CAT OPC UA Configurator. In the standalone version of the configurator, the corresponding configuration interface can be found under the Security tab. Configuring access to namespaces The configuration of user access to individual namespaces is always based on the configured user groups. You can manage the corresponding access rights for individual namespaces in the user group settings. Some groups come preconfigured and you can use their configuration parameters as a guide. The following table provides an overview of the permissions that are defined for each of the user groups as they are delivered. 128 Version: 1.4.0 TF6100
## Page 129

Technical introduction User group Description Administrators Predefined user group for server administrators. This user group has full access to all namespaces. Guests Predefined user group for guest users. This user group has limited access to the server and only to the default namespace "0" with the permissions Read Attribute, Read Value and Browse. Users Predefined user group for normal users. This user group has extended access rights to all namespaces, in particular full access to the namespace of the preconfigured Data Access [} 49] device. By adding users to the user groups, they automatically inherit the corresponding permissions from the group. Configuring access at the node level The Node permissions tab can be used to configure extended and very fine-grained permissions at node level. Sub-elements can inherit the permissions. You can use the Target Browser to transfer nodes to be configured from the server to the configuration using drag and drop. The individual permissions on the node can be linked to a configured user group. TF6100 Version: 1.4.0 129
## Page 130

Technical introduction 4.17 File Transfer 4.17.1 Overview The OPC UA specification contains a special data type for transferring files. This special Object Type called "File Type" describes the information model for the data transmission. Files can be modeled as simple variables in OPC UA with Byte Strings. File Type is a file with methods for accessing the file. The OPC UA specification provides further information about File Type and the structure and handling of the underlying methods and properties for accessing a file in the OPC UA namespace. Beckhoff has implemented a generic way to load files and folders from a local hard disk into the OPC UA namespace. Each file is represented by a File Type and allows read and write operations for this file. In addition, each folder contains a Create File() method to create new files on the hard disk and a separate Folder Path to specify the actual path to the folder on the OPC UA Server. 130 Version: 1.4.0 TF6100
## Page 131

Technical introduction File Transfer in the OPC UA Server Device Manager Only the OPC UA Server of the Beckhoff Device Manager (IPC diagnostics) has this function. The Twin CAT OPC UA Server also provides some parts of this file transfer. However, the general function that enables disclosure of all files and folders is only available in the OPC UA Server, which is part of the device manager that is automatically available on every Beckhoff Industrial PC or Embedded PC. See the Device manager documentation for more information. 4.17.2 Configuration File Type objects are created in a separate namespace called "File Transfer". An XML file (files.xml) is used to configure this namespace and to select the files and folders available via OPC UA. The file must be located in the same directory as the executable file of the OPC UA server. The system must be restarted in order to activate the configuration. The XML file contains information about the folder path and a search mask that defines which files are published in the OPC UA namespace: <Files> <Folder Object Display Name="Twin CAT"> <Folder Object Display Name="3.1"> <Folder Object Display Name="Boot" Path="c:/Twin CAT/3.1/Boot" Search="*.*" > <Folder Object Display Name="Plc" Path="c:/Twin CAT/3.1/Boot/Plc" Search="*.*" ></Folder Object> <Folder Object Display Name="Tmi" Path="c:/Twin CAT/3.1/Boot/Tmi" Search="*.*" ></Folder Object> </Folder Object> </Folder Object> </Folder Object> </Files> Reading a file with an OPC UA client General file handling is described in Appendix C of the OPC UA specification. Reading a file via OPC UA can therefore be divided into the following steps: • Calling the Open method of a file. This method returns a file handle that must be saved for later access. The mode defines whether the file is read or written to (see File modes). TF6100 Version: 1.4.0 131
## Page 132

Technical introduction • Determining the file size with the property "Size". In this way, the entire file can be read when the Read method is called. • Calling the Read method. Inserting the file handle and file size as inputs. Selecting the destination folder in which the file contents are to be saved AFTER the method call. • Calling the Close method to enable the file handle. File modes The following table shows all available file modes: Field Bit Description Read 1 The file is opened for reading. If this bit is not set, Read cannot be executed. Write 4 The file is opened for writing. If this bit is not set, Write cannot be executed. Erase Existing 6 The existing file contents are deleted, and an empty file is made available. Append 10 The file is opened and positioned at the end, otherwise it is moved to the beginning. This position can be changed with Set Position. General behavior The number of files opened in parallel is in principle unlimited and is subject only to any restrictions of the underlying operating system. However, files are subject to a 60 seconds timeout. After this timeout, open files are not automatically closed immediately. Instead, they are marked as "to close". If the corresponding File Handle is used for a read/write operation during this time, the timeout is reset and the File Handle remains valid. If an Open operation is performed on the same file during this time, the old File Handle is enabled. If an OPC UA Client disconnects from the server and still has files open, all File Handles belonging to this session will be closed automatically. 4.18 Reverse Connect The Twin CAT OPC UA Server supports the Reverse Connect function of OPC UA to establish a backward communication connection from the server to the client. To activate this function, a list of client addresses must be stored in the server. Then the server establishes an OPC UA TCP connection for each client in the list. This type of connection setup is often used when an OPC UA client needs to establish connections with servers that are located behind a firewall or NAT device. The following figure illustrates this relationship. 132 Version: 1.4.0 TF6100
## Page 133

Technical introduction In this example, there is an OPC UA client that needs to connect to two servers, each of which is behind a firewall. The firewall blocks all incoming communication traffic and does not open any ports in the internal network. The client is now configured for Reverse Connect and opens its own network port under the client endpoint URL opc.tcp://172.17.1.1:48061. Each of the lower-level servers has also been set up for Reverse Connect and has entered the client endpoint URL as the Reverse Connect URL. The server now opens and maintains a TCP connection to the client using this URL. The actual OPC UA client communication with the server is tunneled through this TCP connection. From the firewall's point of view, this is an "outgoing" communication due to the initially established TCP connection. Only the outgoing communication port (48061 in this example) needs to be enabled in the firewall. Client compatibility Please note that the OPC UA client must also support this function and be accessible via its Client Endpoint URL. Configuration in the server A list of OPC UA Clients can be configured in the Tc Ua Server Config.xml within the <Ua Endpoint>. The Client Endpoint URL under which the respective clients can be reached is entered here. <Reverse Connect> <Url>opc.tcp://172.17.1.1:48061</Url> </Reverse Connect> Configuration in the OPC UA Client The following screenshot shows an example of the configuration of a Reverse Connect connection in the OPC UA client software "UA Expert" from Unified Automation. Reverse Connect is enabled in the connection settings and the client endpoint URL is entered under which the client can be reached by the server. In the Endpoint URL field, the Server Endpoint URL is entered which the client should use as soon as a Reverse Connect TCP connection has been established by the server. Referring to our figure above, opc.tcp://CX-12345:4840 or opc.tcp://CX-98765:4840 is entered here, for example. The settings for Security Settings, Message Security Mode and the authentication parameters then also apply to this connection. Please note that you may still need to import the server certificate. This is the server's public key, which is stored in the corresponding application directory [} 47]. TF6100 Version: 1.4.0 133
## Page 134

Technical introduction Communication history The following Wireshark® Trace shows an example of a connection setup based on Reverse Connect. The only difference to the above figure is that the client used in this recording was configured for the Client Endpoint URL opc.tcp://172.30.3.86:48061. The server is located behind a NAT device, which in turn has the IP address 178.200.200.59. When the TCP connection is established from the server to the client, a so-called "Reverse Hello" message is sent. In this, the server informs the client under which Server Endpoint URL it can be reached. This is the same Server Endpoint URL that you configured in the client (see above). The client uses this Server Endpoint URL for the further connection to the server. 134 Version: 1.4.0 TF6100
## Page 135

Technical introduction 4.19 Redundancy The OPC UA specification defines two types of server redundancy: transparent and non-transparent redundancy. With transparent redundancy, the transfer of functions from one server to another is transparent for the client, i.e. the client does not know that a failover process has occurred and therefore has no control over the failover behavior. In addition, the client does not need to take any action to continue sending or receiving data. With non-transparent redundancy, the failover process from one server to another and the actions to continue sending or receiving data are performed by the client. The client must know the redundancy configuration of the server and perform the necessary actions in order to benefit from the server redundancy in the event of a failover. The non-transparent redundancy defines various failover modes which, among other things, specify how many servers are actively involved in the communication or are available as purely passive systems in the event of a failover. The Twin CAT OPC UA Server supports non-transparent redundancy with the operation modes "cold", "warm" and "hot". The differences in these three operation modes are explained below. For non-transparent redundancy, OPC UA provides the data structures that allow the client to recognize which servers are available in the redundant server group, as well as server information that tells the client which failover modes the server supports. Based on this information, the client can determine what measures it needs to take to achieve failover. For this purpose, the Server Redundancy object exists in the server's address space and indicates the redundancy mode supported by the server and the redundancy set, i.e., all servers that are part of the redundancy configuration. TF6100 Version: 1.4.0 135
## Page 136

Technical introduction Failover modes The following table lists all supported failover modes for non-transparent redundancy. Mode Description Cold Only one server can be active at a time in Cold Failover mode. This can mean that redundant servers are not available (not switched on) or are available but not running (the PC is running but the application is not started). Warm In Warm Failover mode, the backup servers can be active but not make a connection to the actual data points (typically a system where the underlying devices are limited to a single connection). The underlying devices, such as the PLC, may have limited resources that only allow a single server connection. Therefore, only one server is able to retrieve data. Hot In Hot Failover mode, all servers are switched on and ready for operation. In scenarios where servers retrieve data from a downstream device, such as a PLC, one or more servers are active and connected in parallel to the downstream device(s). These servers have only minimal knowledge of the other servers in their group and work independently. If a server fails or a serious problem occurs, its Service Level drops (see below). After recovery, the server returns to the Redundant Server Set with an appropriate Service Level to indicate that it is available. Service Level The Service Level provides a client with information about the state of a server and its ability to deliver data. The Service Level is a node of the byte data type with a value range from 0 to 255. The Twin CAT OPC UA Server currently sets the Service Level statically to the value 255. The reason for this is that the server is able 136 Version: 1.4.0 TF6100
## Page 137

Technical introduction to retrieve data from more than one subordinate PLC controller. The Service Level can therefore only display the state of the server application itself, but not that of the subordinate PLC controllers. The Device State [} 91] object is available for the latter in the respective PLC address spaces. Configuration The server redundancy can be configured using the Twin CAT OPC UA Configurator. Two steps are necessary for this: • Configuration of redundancy • Adding the servers from the redundancy set as Additional Server Entry Configuration of redundancy When configuring server redundancy, you define which Failover mode the server provides and which other servers should be part of the redundancy configuration. These servers are identified via their Server URI. The Failover mode and a list of Server URIs are then stored by the server in its Server Redundancy object (see above). These settings can be configured via the Twin CAT OPC UA Configurator in the "Server Settings" tab, for example: As the Server URI itself does not yet contain any connection information (e.g. the server or discovery URL), this information must be made available to the client elsewhere. This is done via the so-called Additional Server Entry configuration. This allows a client to retrieve all necessary information from the server with a Find Servers call and identify the connection information for a specific Server URI. This configuration step is explained below. Adding the servers from the redundancy set as Additional Server Entry With the Additional Server Entry configuration, information from other Twin CAT OPC UA Servers is added to the Find Servers call of a server. This allows a client to locate all servers from the redundancy configuration and connect to them. The following screenshot shows an exemplary Find Servers call on the local Twin CAT OPC UA Server. The call returns three Twin CAT OPC UA Servers, which are also part of a redundancy configuration. TF6100 Version: 1.4.0 137
## Page 138

Technical introduction The client uses the Server URI from the redundancy configuration to identify a server. The Additional Server Entries can be configured via the Twin CAT OPC UA Configurator in the Server Settings tab, e.g: When adding a new entry, certain fields are already filled in with a template. Please adjust these entries according to your configuration. The specific values for Product Uri, Application Name, Application Uri and Application Type can be found in the Online Panel of the Twin CAT OPC UA Configurator: The Discovery URL corresponds to the Server URL that you usually use to connect to the respective server. 4.20 Logging You can activate a log file in the server for extended diagnostics, in which various information is then recorded on the basis of different log levels. 138 Version: 1.4.0 TF6100
## Page 139

Technical introduction Influence of logging on the operating behavior Please note that enabling the log file can have a negative impact on the speed and operating behavior of the Twin CAT OPC UA Server. The default path for the log files created depends on the operating system used and is described in more detail in the chapter Application directories [} 47]. Logging is usually enabled/disabled via the Twin CAT OPC UA Configurator. You can enable/disable logging both online on the server and offline using the corresponding configuration file, which means that logging is only enabled after a server restart. The following screenshot shows the configuration interface for online logging: The following screenshot shows the configuration interface for offline logging: TF6100 Version: 1.4.0 139
## Page 140

Technical introduction 4.21 System Tray The Twin CAT OPC UA Server contains an application that can be called up as an icon in the Windows system tray. This application enables the triggering of a server restart. The corresponding function can be called via the context menu. 140 Version: 1.4.0 TF6100
## Page 141

PLC API 5 PLC API 5.1 Tc2_Opc Ua 5.1.1 Data types 5.1.1.1 ST_Opc UAServer Info ST_Opc UAServer Info contains session information of a Twin CAT OPC UA Server. Syntax TYPE ST_Opc UAServer Info : STRUCT n Reserved : UDINT; n Cummulated Session Count : UDINT; n Current Session Count : UDINT; n Rejected Session Count : UDINT; n Security Rejected Session Count : UDINT; n Session Timeout Count : UDINT; n Current Subscription Count : UDINT; n Rejected Request Count : UDINT; n Security Rejected Request Count : UDINT; END_STRUCT END_TYPE Parameter Name Type Description n Reserved UDINT Placeholder. n Cummulated Session Count UDINT Total number of client sessions since the server was started. n Current Session Count UDINT Total number of current client sessions. n Rejected Session Count UDINT Total number of sessions rejected by the server. n Security Rejected Session Count UDINT Total number of sessions rejected by the server for security reasons (example: incorrect combination of user name and password). n Session Timeout Count UDINT Total number of sessions that had a timeout. n Current Subscription Count UDINT Total number of current subscriptions in the server. n Rejected Request Count UDINT Total number of failed requests. n Security Rejected Request Count UDINT Total number of failed requests for security reasons. 5.1.1.2 E_Opc UAServer Option E_Opc UAServer Option determines which command is to be sent to the Twin CAT OPC UA Server. Syntax TYPE E_Opc UAServer Option ( e OPCUAServer Option_None, e OPCUAServer Option_Restart, e OPCUAServer Option_Shutdown, e OPCUAServer Option_Refresh Cfg, e OPCUAServer Option_Server Info ); END_TYPE TF6100 Version: 1.4.0 141
## Page 142

PLC API Parameter Name Description e OPCUAServer Option_Non Initial state of the enumeration. e e OPCUAServer Option_Res This option triggers a restart of the OPC UA interface of the server. tart e OPCUAServer Option_Shu This option triggers the shutdown of the OPC UA interface of the server. As the tdown restart option above works via OPC UA, it is no longer available after using this option until a complete server restart. e OPCUAServer Option_Refr This option currently has no function. esh Cfg e OPCUAServer Option_Ser This option queries the server information contained in ST_Opc UAServer Info ver Info [} 141]. 5.1.1.3 E_Opc UAServer Status E_Opc UAServer Status represents the runtime status of a Twin CAT OPC UA Server. Syntax TYPE E_Opc UAServer Status ( e OPCUAServer Status_None, e OPCUAServer Status_Alive, e OPCUAServer Status_Not Responding ); END_TYPE Parameter Name Description e OPCUAServer Status_None Initial state of the enumeration. e OPCUAServer Status_Alive The ADS interface of the Twin CAT OPC UA Server is accessible. e OPCUAServer Status_Not Responding The ADS interface of the Twin CAT OPC UA Server is not accessible. 5.1.2 Function blocks 5.1.2.1 FB_Opc UAServer The function block enables status information to be read out and a Twin CAT OPC UA Server to be restarted. Syntax Definition: FUNCTION_BLOCK FB_Opc UAServer VAR_INPUT s Net Id : T_Ams Net Id; b Execute : BOOL; e Opc UAServer Option : E_Opc UAServer Option; t Timeout : TIME; END_VAR 142 Version: 1.4.0 TF6100
## Page 143

PLC API VAR_OUTPUT st Opc UAServer Info : ST_Opc UAServer Info; b Busy : BOOL; b Error : BOOL; n Error Id : UDINT; END_VAR Inputs Name Type Description s Net Id T_Ams Net Id Ams Net Id of the system on which the Twin CAT OPC UA Server runs. b Execute BOOL A rising edge activates processing of the function block. e Opc UAServer Option E_Opc UAServer Option Specifies the operation to be performed. [} 141] t Timeout TIME ADS Timeout Outputs Name Type Description st Opc UAServer Info ST_Opc UAServer Info Contains status information from the server when Server Info is selected at the e Opc UAServer Option input. [} 141] b Busy BOOL TRUE as long as processing of the function block is in progress. b Error BOOL Becomes TRUE as soon as an error situation occurs. n Error Id UDINT Contains the error code when an error (b Error) occurs. 5.1.2.2 FB_Opc UAServer Get Status The function block enables the current status (Running, Not Responding) of a Twin CAT OPC UA Server to be read. It should be noted at this point that this function block deals with the ADS interface of the OPC UA Server. If the OPC UA Server is restarted or shut down, the ADS interface of the server remains accessible. The ADS interface can only be closed by terminating the server process. Syntax Definition: FUNCTION_BLOCK FB_Opc UAServer Get Status VAR_INPUT s Net Id : T_Ams Net Id; b Get Status : BOOL; t Timeout : TIME; END_VAR VAR_OUTPUT e OPCUAServer Status : E_OPCUAServer Status; b Done : BOOL; b Busy : BOOL; b Error : BOOL; n Error Id : UDINT; END_VAR TF6100 Version: 1.4.0 143
## Page 144

PLC API Inputs Name Type Description s Net Id T_Ams Net Id Ams Net Id of the system on which the Twin CAT OPC UA Server runs. b Get Status BOOL A rising edge activates processing of the function block. t Timeout TIME ADS Timeout Outputs Name Type Description e OPCUAServer Statu E_Opc UAServer Status Contains status information about the server. s [} 142] b Done BOOL TRUE when processing of the function block is complete. b Busy BOOL TRUE as long as processing of the function block is in progress. b Error BOOL Becomes TRUE as soon as an error situation occurs. n Error Id UDINT Contains the error code when an error (b Error) occurs. 144 Version: 1.4.0 TF6100
## Page 145

Samples 6 Samples Sample code and configurations for this product can be obtained from the corresponding repository on Git Hub: https://github.com/Beckhoff/TF6100_Samples. There you have the possibility to clone the repository or download a ZIP file with the sample. The following samples exist: Name Twin CAT Ver- Description sion TF6100_Opc Ua_Client_Sample Twin CAT 3 This sample contains sample code for various functions of the Twin CAT OPC UA Client (PLCOpen function blocks). These include Browse, Connect, History Update, Method Call, Read and Write. The server sample for access is also included. TF6100_Opc Ua_Server_Sample Twin CAT 3 This sample contains a PLC with extensive provision of PLC data for the Twin CAT OPC UA Server (OPC UA Data Access). TS6100_Opc Ua_Client_Sample Twin CAT 2 This sample contains sample code for various functions of the Twin CAT OPC UA Client (PLCOpen function blocks). These include Method Call, Read and Write. TS6100_Opc Ua_Server_Sample Twin CAT 2 This sample demonstrates the use of PLC comments to release variables via the Twin CAT OPC UA Server. TF6100 Version: 1.4.0 145
## Page 146

Tutorials 7 Tutorials Video tutorials for this product can be found on our website at https://www.beckhoff.com/tutorials. The video tutorials offer a quick start to the product and the individual product facets. 146 Version: 1.4.0 TF6100
## Page 147

Appendix 8 Appendix 8.1 Attributes and comments The following table provides an overview of all pragmas and comments that can be configured in the server. These can be defined in the various real-time environments of Twin CAT to enable different functionalities. A detailed description of the use of attributes and comments can be found in chapter Enabling symbols [} 53]. Using the tags in the PLC When using the pragmas in the PLC, please ensure that you place the key and value in quotation marks. You can find an example in the chapter Enabling symbols\PLC [} 54]. Twin CAT 3 Key Value Meaning OPC. UA. DA 0 Blocks a symbol explicitly for OPC UA. OPC. UA. DA 1 Enables a symbol for OPC UA. OPC. UA. DA 2 Enables a symbol for OPC UA. In the case of a structure and the Structured Data Type, member variables are not loaded into the server's address space as separate nodes. OPC. UA. DA. Access 1 Sets a node read-only [} 85]. OPC. UA. DA. Access 2 Sets a node write-only. OPC. UA. DA. Access 3 Enables read/write access to a node (default if not set). OPC. UA. DA. Alias <string> Defines a different name (alias) for a node. OPC. UA. DA. Description <string> Defines the content of the OPC UA attribute "Description [} 84]". OPC. UA. DA. Structured Type 0 Disables the Structured Data Type for a structure [} 76]. OPC. UA. DA. Structured Type 1 Enables the Structured Data Type for a structure [} 76]. OPC. UA. DA. Status quality Manually define the Status Code [} 80] of a symbol in the OPC UA namespace. TF6100 Version: 1.4.0 147
## Page 148

Appendix Twin CAT 2 PLC comment Meaning (*~ (OPC:0:not available) *) Locks a variable for OPC UA, whereupon it is no longer visible in the UA namespace. (*~ (OPC:1:available) *) Enables a variable for OPC UA, whereupon it becomes visible in the UA namespace. This tag must always be set if you want to use a variable for UA. (*~ (OPC_PROP[0005]:1:read-only) *) Sets the write protection for a variable. Must be used together with (*~ (OPC: 1: available) *). (*~ (OPC_UA_PROP[5100] : x: Alias name) *) Specifies x as node name in the UA namespace, so-called alias mapping. (*~ (OPC_UA_PROP[5000]:x:Storage media) *) Enables a variable for "Historical Access". Must be used together with (*~ (OPC: 1: available) *). x defines the storage medium for storing the data values: 1 = RAM 2 = File 3 = SQL Compact Database 4 = SQL Server Database (*~ (OPC_UA_PROP[5000][1]:x:Sampling Rate) *) Determines the sampling rate at which the variable values are to be stored, in [ms] depending on the parameter "x" (*~ (OPC_UA_PROP[5000][2]:x:Buffer) *) Defines the maximum number of values that remain in the data memory, depending on the parameter "x". 8.2 32-bit and 64-bit process The Twin CAT OPC UA Server is available as a 32-bit and 64-bit process. The corresponding files are installed automatically via the setup or package. Which variant is active on your system? ü A little trick in the Windows Task Manager allows you to easily recognize which variant is currently active on your system. 1. Open the Task Manager. 2. Navigate to the "Twin CAT OPC UA Server" process. 3. Open the file location via the context menu. ð In the address bar of the File Explorer you can now see which variant of Tc Opc Ua Server.exe is currently registered on your system and is therefore active: 148 Version: 1.4.0 TF6100
## Page 149

Appendix Register/unregister To register or unregister another variant of the Twin CAT OPC UA Server, please follow the steps below. Before changing the variant, please note that you must first end the running process. Switch from 32-bit to 64-bit process: • End the running process of the Tc Opc Ua Server.exe file in the Task Manager. • Open the Windows command prompt as an administrator and change to the installation directory [} 47] of the 32-bit version. • Enter the following command to unregister the process: Tc Opc Ua Server.exe /Un Reg Tc Server2 A dialog box informs you that the Twin CAT system service must be restarted for unregistration. Confirm this dialog box with Yes. TF6100 Version: 1.4.0 149
## Page 150

Appendix As a result of this command, the Twin CAT OPC UA Server is no longer started automatically with Twin CAT. In the next step, you will learn how to register the 64-bit variant of the server with the Twin CAT system service. • Change to the server installation directory [} 47] of the 64-bit variant and enter the following command to register the process: Tc Opc Ua Server.exe /Reg Tc Server2 A dialog box informs you once again that the Twin CAT system service must be restarted for unregistration. Confirm this dialog box with "Yes". As a result of this command, the Twin CAT OPC UA Server is registered with the Twin CAT system service and starts automatically together with Twin CAT. If you get the error message when entering this command, make sure that you are not inadvertently trying to register the 64-bit process on a 32-bit system. Conversely, the 32-bit process can of course be registered on a 64-bit system. 8.3 Error diagnosis In the event of undesirable operating behavior, an extended diagnosis may be necessary. Depending on the situation, this may include the following measures: ADS Trace, Wireshark® Trace, log file, Memory Dump. A log function may also be available and useful on the client side. The appropriateness of the action depends heavily on the appearance of the behavior. Take another look at the software architecture of the Twin CAT OPC UA Server and compare it with the operating behavior. The following figure illustrates where the individual measures (described in more detail in the table) could be helpful. 150 Version: 1.4.0 TF6100
## Page 151

Appendix Measure Use case Link Client Log Useful for recording extended Please contact the manufacturer of protocol functions on the client the client for more information side. about its logging functions. Wireshark Trace Useful for examining https://www.wireshark.org/ communication between client and server. Server Log Useful for logging advanced See chapter Logging [} 138] in this server-side logging functions. documentation. Memory Dump It can be useful to create a Memory Microsoft Debug Diagnostics Dump in case the Twin CAT OPC UA Server is unexpectedly terminated. The tools required for this depend on the operating system. ADS Trace Useful for examining the Beckhoff Download Finder (TF6010 communication between server TC3 ADS Monitor) and PLC. Support The Beckhoff support department [} 157] will be happy to assist you in implementing the appropriate measures. The following table provides an overview of possible unexpected operating behavior and measures to resolve it. TF6100 Version: 1.4.0 151
## Page 152

Appendix Behavior Action(s) An OPC UA client does not see the PLC TF6100 Setup Version 3.x and older: this status indicates namespace. a missing license. Check whether you have activated a valid TF6100 license. An OPC UA client is assigned the Status Code TF6100 Setup Version 4.x: this status indicates a missing 0x810e0000 when reading nodes. license. Check whether you have activated a valid TF6100 license. The variables enabled via comments/attributes Check whether the symbol file has been correctly are not displayed in the OPC UA server. transferred to the controller (e.g., check boxes in the PLC project), verify that it exists in the boot directory and that the path to the symbol file in the configuration file of the server refers to the correct symbol file. You can also use the Device State Node in the respective namespace to check any error messages that may have occurred. An entry is made here if the symbol file was not found. Also check that the comments/attributes are spelled correctly. The server does not comply with the sampling OPC UA client/server is not a real-time protocol, i.e., there rate/publishing interval required by the is no guarantee that the server will always meet 100% of OPC UA Client. the sampling rate or publishing interval required by the client. The available sampling rates and publishing intervals can be viewed in the server configuration file and modified if required (<Available Sampling Rates> and <Min Publishing Interval>). An OPC UA Client cannot connect to the server Check whether firewall settings prevent communication although the server is displayed in the Windows with the server. The server port must be open for incoming Task Manager. The error message “Host TCP communication so that a client can connect. unreachable” (or similar) is displayed. An OPC UA client sees the server’s endpoints, Check that the name resolution in your network is working but a connection with them fails with the error properly and that the server is accessible under its host message “Host unreachable”. name. Even if the OPC UA Client apparently connects to the IP address of the server (e.g., opc.tcp:// 192.168.0.1:4840) to access the server’s endpoints, the server always returns its own host name in its endpoints. If the client connects directly to one of the endpoints, it will use the host name of the server again. If the name resolution does not work, the connection fails. An OPC UA Client sees the endpoints of the Check whether the server trusts the client certificate. The server, but a connection to a secure endpoint required configuration steps can be found in section fails. The error message Certificate exchange. In this case, it must also be ensured “Bad Security Checks Failed” is displayed. that a signature hash algorithm of the SHA2 group (SHA256, SHA364, SHA512) is used to sign the client certificate. If deprecated algorithms such as SHA1 are used, the Twin CAT OPC UA Server does not allow a connection. When using an SQL server to store Historical Check the access data to the SQL Server and verify that Access information, the values are not added to the SQL Server is also accessible in the network. Also the SQL database. make sure that you are using a “Big Windows” operating system on the Twin CAT OPC UA Server, since SQL Server cannot be used for Historical Access under Windows CE (although SQL Compact is OK). When reading nodes, an OPC UA client This is an indication that the associated ADS device receives the error message “Bad Device Failure”. cannot be reached, for example if no PLC program has been started. Check the connectivity with the ADS device and make sure that the appropriate runtime is active. When reading nodes, an OPC UA client This is an indication that no TF6100 license is active on receives the error message the system or that it has expired. Please make sure that “Bad License Expired”. you have activated a TF6100 license on the device on which the server was installed. 152 Version: 1.4.0 TF6100
## Page 153

Appendix Behavior Action(s) Arrays are not displayed in the namespace with By default, arrays of simple data types are not displayed in full resolution. expanded form in the namespace. However, individual array indices can still be addressed using the Index Range function of OPC UA. An OPC UA Client should therefore support this function. If this is not the case, a radio button in the configuration file of the server can be used to display an array in expanded form, so that each individual array element can be addressed as a separate node. This radio button is described in the chapter Arrays [} 60]. The following message appears repeatedly in This message is an indication that the server cannot the error log: process the variables added by the client to a subscription “CBk Ua Plc Sampling Engine_Poll : !! CRITICAL!! at the requested sampling rate. The reason for this is Sampling exceeded n times in a row, leaving no typically an excessive amount of data, e.g. when sampling time left to rest.” large data structures (Structured Types [} 76]). Please note that this message does not necessarily represent a problem. In many OPC UA Client applications, the sampling rate settings are generalized and made for all variables, even if they could be sampled more slowly. In any case, a first step towards optimization should always include checking and, if necessary, reducing the sampling rate. It should also be checked whether the amount of data can be reduced if large structured types are used. Upgrading to a faster CPU is also helpful. However, experience has shown that reducing the sampling rate and the amount of data is sufficient to achieve initial success. The call of a job method [} 106] fails with the If a job method returns with this status code, this is an status code “Bad Resource Unavailable” indication that the signature of the function block representing the job method has not been set correctly. First check the presence of the Start() method. Further note: in this case, you would see in an ADS trace that the associated call (Ads Read Write Request) of the method returns the result 0x710 (“Symbol not found”). 8.4 ADS Return Codes Grouping of error codes: Global error codes: 0x0000 [} 153]... (0x9811_0000 ...) Router error codes: 0x500 [} 154]... (0x9811_0500 ...) General ADS errors: 0x700 [} 154]... (0x9811_0700 ...) RTime error codes: 0x1000 [} 156]... (0x9811_1000 ...) Global error codes TF6100 Version: 1.4.0 153
## Page 154

Appendix Hex Dec HRESULT Name Description 0x0 0 0x98110000 ERR_NOERROR No error. 0x1 1 0x98110001 ERR_INTERNAL Internal error. 0x2 2 0x98110002 ERR_NORTIME No real time. 0x3 3 0x98110003 ERR_ALLOCLOCKEDMEM Allocation locked – memory error. 0x4 4 0x98110004 ERR_INSERTMAILBOX Mailbox full – the ADS message could not be sent. Reducing the number of ADS messages per cycle will help. 0x5 5 0x98110005 ERR_WRONGRECEIVEHMSG Wrong HMSG. 0x6 6 0x98110006 ERR_TARGETPORTNOTFOUND Target port not found – ADS server is not started, not reachable or not installed. 0x7 7 0x98110007 ERR_TARGETMACHINENOTFOUND Target computer not found – AMS route was not found. 0x8 8 0x98110008 ERR_UNKNOWNCMDID Unknown command ID. 0x9 9 0x98110009 ERR_BADTASKID Invalid task ID. 0x A 10 0x9811000A ERR_NOIO No IO. 0x B 11 0x9811000B ERR_UNKNOWNAMSCMD Unknown AMS command. 0x C 12 0x9811000C ERR_WIN32ERROR Win32 error. 0x D 13 0x9811000D ERR_PORTNOTCONNECTED Port not connected. 0x E 14 0x9811000E ERR_INVALIDAMSLENGTH Invalid AMS length. 0x F 15 0x9811000F ERR_INVALIDAMSNETID Invalid AMS Net ID. 0x10 16 0x98110010 ERR_LOWINSTLEVEL Installation level is too low –Twin CAT 2 license error. 0x11 17 0x98110011 ERR_NODEBUGINTAVAILABLE No debugging available. 0x12 18 0x98110012 ERR_PORTDISABLED Port disabled – Twin CAT system service not started. 0x13 19 0x98110013 ERR_PORTALREADYCONNECTED Port already connected. 0x14 20 0x98110014 ERR_AMSSYNC_W32ERROR AMS Sync Win32 error. 0x15 21 0x98110015 ERR_AMSSYNC_TIMEOUT AMS Sync Timeout. 0x16 22 0x98110016 ERR_AMSSYNC_AMSERROR AMS Sync error. 0x17 23 0x98110017 ERR_AMSSYNC_NOINDEXINMAP No index map for AMS Sync available. 0x18 24 0x98110018 ERR_INVALIDAMSPORT Invalid AMS port. 0x19 25 0x98110019 ERR_NOMEMORY No memory. 0x1A 26 0x9811001A ERR_TCPSEND TCP send error. 0x1B 27 0x9811001B ERR_HOSTUNREACHABLE Host unreachable. 0x1C 28 0x9811001C ERR_INVALIDAMSFRAGMENT Invalid AMS fragment. 0x1D 29 0x9811001D ERR_TLSSEND TLS send error – secure ADS connection failed. 0x1E 30 0x9811001E ERR_ACCESSDENIED Access denied – secure ADS access denied. Router error codes Hex Dec HRESULT Name Description 0x500 1280 0x98110500 ROUTERERR_NOLOCKEDMEMORY Locked memory cannot be allocated. 0x501 1281 0x98110501 ROUTERERR_RESIZEMEMORY The router memory size could not be changed. 0x502 1282 0x98110502 ROUTERERR_MAILBOXFULL The mailbox has reached the maximum number of possible messages. 0x503 1283 0x98110503 ROUTERERR_DEBUGBOXFULL The Debug mailbox has reached the maximum number of possible messages. 0x504 1284 0x98110504 ROUTERERR_UNKNOWNPORTTYPE The port type is unknown. 0x505 1285 0x98110505 ROUTERERR_NOTINITIALIZED The router is not initialized. 0x506 1286 0x98110506 ROUTERERR_PORTALREADYINUSE The port number is already assigned. 0x507 1287 0x98110507 ROUTERERR_NOTREGISTERED The port is not registered. 0x508 1288 0x98110508 ROUTERERR_NOMOREQUEUES The maximum number of ports has been reached. 0x509 1289 0x98110509 ROUTERERR_INVALIDPORT The port is invalid. 0x50A 1290 0x9811050A ROUTERERR_NOTACTIVATED The router is not active. 0x50B 1291 0x9811050B ROUTERERR_FRAGMENTBOXFULL The mailbox has reached the maximum number for fragmented messages. 0x50C 1292 0x9811050C ROUTERERR_FRAGMENTTIMEOUT A fragment timeout has occurred. 0x50D 1293 0x9811050D ROUTERERR_TOBEREMOVED The port is removed. General ADS error codes 154 Version: 1.4.0 TF6100
## Page 155

Appendix Hex Dec HRESULT Name Description 0x700 1792 0x98110700 ADSERR_DEVICE_ERROR General device error. 0x701 1793 0x98110701 ADSERR_DEVICE_SRVNOTSUPP Service is not supported by the server. 0x702 1794 0x98110702 ADSERR_DEVICE_INVALIDGRP Invalid index group. 0x703 1795 0x98110703 ADSERR_DEVICE_INVALIDOFFSET Invalid index offset. 0x704 1796 0x98110704 ADSERR_DEVICE_INVALIDACCESS Reading or writing not permitted. Several causes are possible. For example, an incorrect password was entered when creating routes. 0x705 1797 0x98110705 ADSERR_DEVICE_INVALIDSIZE Parameter size not correct. 0x706 1798 0x98110706 ADSERR_DEVICE_INVALIDDATA Invalid data values. 0x707 1799 0x98110707 ADSERR_DEVICE_NOTREADY Device is not ready to operate. 0x708 1800 0x98110708 ADSERR_DEVICE_BUSY Device is busy. 0x709 1801 0x98110709 ADSERR_DEVICE_INVALIDCONTEXT Invalid operating system context. This can result from use of ADS blocks in different tasks. It may be possible to resolve this through multitasking synchronization in the PLC. 0x70A 1802 0x9811070A ADSERR_DEVICE_NOMEMORY Insufficient memory. 0x70B 1803 0x9811070B ADSERR_DEVICE_INVALIDPARM Invalid parameter values. 0x70C 1804 0x9811070C ADSERR_DEVICE_NOTFOUND Not found (files, ...). 0x70D 1805 0x9811070D ADSERR_DEVICE_SYNTAX Syntax error in file or command. 0x70E 1806 0x9811070E ADSERR_DEVICE_INCOMPATIBLE Objects do not match. 0x70F 1807 0x9811070F ADSERR_DEVICE_EXISTS Object already exists. 0x710 1808 0x98110710 ADSERR_DEVICE_SYMBOLNOTFOUND Symbol not found. 0x711 1809 0x98110711 ADSERR_DEVICE_SYMBOLVERSIONINVALID Invalid symbol version. This can occur due to an online change. Create a new handle. 0x712 1810 0x98110712 ADSERR_DEVICE_INVALIDSTATE Device (server) is in invalid state. 0x713 1811 0x98110713 ADSERR_DEVICE_TRANSMODENOTSUPP Ads Trans Mode not supported. 0x714 1812 0x98110714 ADSERR_DEVICE_NOTIFYHNDINVALID Notification handle is invalid. 0x715 1813 0x98110715 ADSERR_DEVICE_CLIENTUNKNOWN Notification client not registered. 0x716 1814 0x98110716 ADSERR_DEVICE_NOMOREHDLS No further handle available. 0x717 1815 0x98110717 ADSERR_DEVICE_INVALIDWATCHSIZE Notification size too large. 0x718 1816 0x98110718 ADSERR_DEVICE_NOTINIT Device not initialized. 0x719 1817 0x98110719 ADSERR_DEVICE_TIMEOUT Device has a timeout. 0x71A 1818 0x9811071A ADSERR_DEVICE_NOINTERFACE Interface query failed. 0x71B 1819 0x9811071B ADSERR_DEVICE_INVALIDINTERFACE Wrong interface requested. 0x71C 1820 0x9811071C ADSERR_DEVICE_INVALIDCLSID Class ID is invalid. 0x71D 1821 0x9811071D ADSERR_DEVICE_INVALIDOBJID Object ID is invalid. 0x71E 1822 0x9811071E ADSERR_DEVICE_PENDING Request pending. 0x71F 1823 0x9811071F ADSERR_DEVICE_ABORTED Request is aborted. 0x720 1824 0x98110720 ADSERR_DEVICE_WARNING Signal warning. 0x721 1825 0x98110721 ADSERR_DEVICE_INVALIDARRAYIDX Invalid array index. 0x722 1826 0x98110722 ADSERR_DEVICE_SYMBOLNOTACTIVE Symbol not active. 0x723 1827 0x98110723 ADSERR_DEVICE_ACCESSDENIED Access denied. Several causes are possible. For example, a unidirectional ADS route is used in the opposite direction. 0x724 1828 0x98110724 ADSERR_DEVICE_LICENSENOTFOUND Missing license. 0x725 1829 0x98110725 ADSERR_DEVICE_LICENSEEXPIRED License expired. 0x726 1830 0x98110726 ADSERR_DEVICE_LICENSEEXCEEDED License exceeded. 0x727 1831 0x98110727 ADSERR_DEVICE_LICENSEINVALID Invalid license. 0x728 1832 0x98110728 ADSERR_DEVICE_LICENSESYSTEMID License problem: System ID is invalid. 0x729 1833 0x98110729 ADSERR_DEVICE_LICENSENOTIMELIMIT License not limited in time. 0x72A 1834 0x9811072A ADSERR_DEVICE_LICENSEFUTUREISSUE Licensing problem: time in the future. 0x72B 1835 0x9811072B ADSERR_DEVICE_LICENSETIMETOLONG License period too long. 0x72C 1836 0x9811072C ADSERR_DEVICE_EXCEPTION Exception at system startup. 0x72D 1837 0x9811072D ADSERR_DEVICE_LICENSEDUPLICATED License file read twice. 0x72E 1838 0x9811072E ADSERR_DEVICE_SIGNATUREINVALID Invalid signature. 0x72F 1839 0x9811072F ADSERR_DEVICE_CERTIFICATEINVALID Invalid certificate. 0x730 1840 0x98110730 ADSERR_DEVICE_LICENSEOEMNOTFOUND Public key not known from OEM. 0x731 1841 0x98110731 ADSERR_DEVICE_LICENSERESTRICTED License not valid for this system ID. TF6100 Version: 1.4.0 155
## Page 156

Appendix Hex Dec HRESULT Name Description 0x732 1842 0x98110732 ADSERR_DEVICE_LICENSEDEMODENIED Demo license prohibited. 0x733 1843 0x98110733 ADSERR_DEVICE_INVALIDFNCID Invalid function ID. 0x734 1844 0x98110734 ADSERR_DEVICE_OUTOFRANGE Outside the valid range. 0x735 1845 0x98110735 ADSERR_DEVICE_INVALIDALIGNMENT Invalid alignment. 0x736 1846 0x98110736 ADSERR_DEVICE_LICENSEPLATFORM Invalid platform level. 0x737 1847 0x98110737 ADSERR_DEVICE_FORWARD_PL Context – forward to passive level. 0x738 1848 0x98110738 ADSERR_DEVICE_FORWARD_DL Context – forward to dispatch level. 0x739 1849 0x98110739 ADSERR_DEVICE_FORWARD_RT Context – forward to real-time. 0x740 1856 0x98110740 ADSERR_CLIENT_ERROR Client error. 0x741 1857 0x98110741 ADSERR_CLIENT_INVALIDPARM Service contains an invalid parameter. 0x742 1858 0x98110742 ADSERR_CLIENT_LISTEMPTY Polling list is empty. 0x743 1859 0x98110743 ADSERR_CLIENT_VARUSED Var connection already in use. 0x744 1860 0x98110744 ADSERR_CLIENT_DUPLINVOKEID The called ID is already in use. 0x745 1861 0x98110745 ADSERR_CLIENT_SYNCTIMEOUT Timeout has occurred – the remote terminal is not responding in the specified ADS timeout. The route setting of the remote terminal may be configured incorrectly. 0x746 1862 0x98110746 ADSERR_CLIENT_W32ERROR Error in Win32 subsystem. 0x747 1863 0x98110747 ADSERR_CLIENT_TIMEOUTINVALID Invalid client timeout value. 0x748 1864 0x98110748 ADSERR_CLIENT_PORTNOTOPEN Port not open. 0x749 1865 0x98110749 ADSERR_CLIENT_NOAMSADDR No AMS address. 0x750 1872 0x98110750 ADSERR_CLIENT_SYNCINTERNAL Internal error in Ads sync. 0x751 1873 0x98110751 ADSERR_CLIENT_ADDHASH Hash table overflow. 0x752 1874 0x98110752 ADSERR_CLIENT_REMOVEHASH Key not found in the table. 0x753 1875 0x98110753 ADSERR_CLIENT_NOMORESYM No symbols in the cache. 0x754 1876 0x98110754 ADSERR_CLIENT_SYNCRESINVALID Invalid response received. 0x755 1877 0x98110755 ADSERR_CLIENT_SYNCPORTLOCKED Sync Port is locked. 0x756 1878 0x98110756 ADSERR_CLIENT_REQUESTCANCELLED The request was canceled. RTime error codes Hex Dec HRESULT Name Description 0x1000 4096 0x98111000 RTERR_INTERNAL Internal error in the real-time system. 0x1001 4097 0x98111001 RTERR_BADTIMERPERIODS Timer value is not valid. 0x1002 4098 0x98111002 RTERR_INVALIDTASKPTR Task pointer has the invalid value 0 (zero). 0x1003 4099 0x98111003 RTERR_INVALIDSTACKPTR Stack pointer has the invalid value 0 (zero). 0x1004 4100 0x98111004 RTERR_PRIOEXISTS The request task priority is already assigned. 0x1005 4101 0x98111005 RTERR_NOMORETCB No free TCB (Task Control Block) available. The maximum number of TCBs is 64. 0x1006 4102 0x98111006 RTERR_NOMORESEMAS No free semaphores available. The maximum number of semaphores is 64. 0x1007 4103 0x98111007 RTERR_NOMOREQUEUES No free space available in the queue. The maximum number of positions in the queue is 64. 0x100D 4109 0x9811100D RTERR_EXTIRQALREADYDEF An external synchronization interrupt is already applied. 0x100E 4110 0x9811100E RTERR_EXTIRQNOTDEF No external sync interrupt applied. 0x100F 4111 0x9811100F RTERR_EXTIRQINSTALLFAILED Application of the external synchronization interrupt has failed. 0x1010 4112 0x98111010 RTERR_IRQLNOTLESSOREQUAL Call of a service function in the wrong context 0x1017 4119 0x98111017 RTERR_VMXNOTSUPPORTED Intel® VT-x extension is not supported. 0x1018 4120 0x98111018 RTERR_VMXDISABLED Intel® VT-x extension is not enabled in the BIOS. 0x1019 4121 0x98111019 RTERR_VMXCONTROLSMISSING Missing function in Intel® VT-x extension. 0x101A 4122 0x9811101A RTERR_VMXENABLEFAILS Activation of Intel® VT-x fails. Specific positive HRESULT Return Codes: 156 Version: 1.4.0 TF6100
## Page 157

Appendix HRESULT Name Description 0x0000_0000 S_OK No error. 0x0000_0001 S_FALSE No error. Example: successful processing, but with a negative or incomplete result. 0x0000_0203 S_PENDING No error. Example: successful processing, but no result is available yet. 0x0000_0256 S_WATCHDOG_TIMEOUT No error. Example: successful processing, but a timeout occurred. TCP Winsock error codes Hex Dec Name Description 0x274C 10060 WSAETIMEDOUT A connection timeout has occurred - error while establishing the connection, because the remote terminal did not respond properly after a certain period of time, or the established connection could not be maintained because the connected host did not respond. 0x274D 10061 WSAECONNREFUSED Connection refused - no connection could be established because the target computer has explicitly rejected it. This error usually results from an attempt to connect to a service that is inactive on the external host, that is, a service for which no server application is running. 0x2751 10065 WSAEHOSTUNREACH No route to host - a socket operation referred to an unavailable host. More Winsock error codes: Win32 error codes 8.5 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service TF6100 Version: 1.4.0 157
## Page 158

Appendix • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com 158 Version: 1.4.0 TF6100
## Page 159

Trademark statements Beckhoff®, ATRO®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, MX-System®, Safety over Ether CAT®, TC/BSD®, Twin CAT®, Twin CAT/BSD®, Twin SAFE®, XFC®, XPlanar® and XTS® are registered and licensed trademarks of Beckhoff Automation Gmb H. Third-party trademark statements Arm, Arm9 and Cortex are trademarks or registered trademarks of Arm Limited (or its subsidiaries or affiliates) in the US and/or elsewhere. DSP System Toolbox, Embedded Coder, MATLAB, MATLAB Coder, MATLAB Compiler, Math Works, Predictive Maintenance Toolbox, Simscape, Simscape™ Multibody™, Simulink, Simulink Coder, Stateflow and Thing Speak are registered trademarks of The Math Works, Inc. Intel, the Intel logo, Intel Core, Xeon, Intel Atom, Celeron and Pentium are trademarks of Intel Corporation or its subsidiaries. The registered trademark Linux® is used pursuant to a sublicense from the Linux Foundation, the exclusive licensee of Linus Torvalds, owner of the mark on a worldwide basis. Microsoft, Microsoft Azure, Microsoft Edge, Power Shell, Visual Studio, Windows and Xbox are trademarks of the Microsoft group of companies. Wireshark is a registered trademark of Sysdig, Inc.
## Page 160

More Information: www.beckhoff.com/tf6100 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
