---
title: "TF3685 Twin CAT 3"
product: "TF3685"
category: "Analytics"
tags: ["CAT", "TWIN"]
language: "EN"
document_type: "Library"
version: "1.0.2"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF3685_TC3_Weighing_Library_EN.pdf"
release_date: "2025-07-09"
---
Manual | EN TF3685 Twin CAT 3 | Weighing Library 2025-07-09 | Version: 1.0.2
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation............................................................................................................. 5 1.2 For your safety.................................................................................................................................. 5 1.3 Notes on information security............................................................................................................ 7 2 Overview.................................................................................................................................................... 8 3 Installation................................................................................................................................................. 9 3.1 Licensing......................................................................................................................................... 10 4 Technical introduction............................................................................................................................ 13 4.1 Measuring procedure...................................................................................................................... 13 5 PLC API.................................................................................................................................................... 17 5.1 Function blocks............................................................................................................................... 17 5.1.1 FB_WG_Combo Filter....................................................................................................... 19 5.1.2 FB_WG_Scaling............................................................................................................... 21 5.1.3 FB_WG_Weighing........................................................................................................... 27 5.2 Data types....................................................................................................................................... 31 5.2.1 Configuration structures................................................................................................... 31 5.2.2 E_WG_Calibrate.............................................................................................................. 35 5.2.3 E_WG_Auto Tare Type...................................................................................................... 36 6 Samples................................................................................................................................................... 37 6.1 Dynamic weighing........................................................................................................................... 37 7 Appendix.................................................................................................................................................. 40 7.1 Return codes................................................................................................................................... 40 7.2 FAQ - frequently asked questions and answers............................................................................. 42 7.3 Support and Service........................................................................................................................ 43 TF3685 Version: 1.0.2 3
## Page 4

Table of contents 4 Version: 1.0.2 TF3685
## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. The documentation and the following notes and explanations must be complied with when installing and commissioning the components. The trained specialists must always use the current valid documentation. The trained specialists must ensure that the application and use of the products described is in line with all safety requirements, including all relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been compiled with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. Claims to modify products that have already been supplied may not be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, ATRO® , Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, MX-System®, Safety over Ether CAT®, TC/BSD®, Twin CAT®, Twin CAT/BSD®, Twin SAFE®, XFC®, XPlanar®, and XTS® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of the designations or trademarks contained in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Ether CAT® is a registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany. Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document, as well as the use and communication of its contents without express authorization, are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. Third-party trademarks Trademarks of third parties may be used in this documentation. You can find the trademark notices here: https://www.beckhoff.com/trademarks. 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. TF3685 Version: 1.0.2 5
## Page 6

Foreword Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 6 Version: 1.0.2 TF3685
## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. TF3685 Version: 1.0.2 7
## Page 8

Overview 2 Overview The Twin CAT 3 Weighing PLC Library allows a scale for weight measurement to be integrated into the PC- based machine control system – particularly in conjunction with the I/Os of the ELM35xx and EL3356-0010 Ether CAT Terminals. The focus is primarily on the dynamic weighing process. Signal filtering is particularly demanding here, as the weighing time has a significant influence on the overall processing time of the machine. Rapid signal filtering with the same level of precision produces a faster weight result, which ultimately makes for faster machines. Since a load cell and a measured value acquisition via the corresponding Ether CAT Terminals do not yet constitute a scale, this is exactly where the PLC library comes in. It takes over the scaling of the measured values, while the new PLC function blocks cover functions such as zeroing and taring. In addition to manual triggering of the weight measurement, automatic measurement is also possible. The production material is detected and the measurement is taken directly. The main advantage is that, depending on the application, even external triggers such as photoelectric sensors and initiators can be omitted. The license of the TF3680 | Twin CAT 3 filter library is also included in this product. Components • Twin CAT Weighing PLC library: Tc3_Weighing.compiled-library • Twin CAT Filter PLC library: Tc3_Filter.compiled-library • Versioned driver: Tc Weighing.tmx • Description file: Tc Weighing.tmc 8 Version: 1.0.2 TF3685
## Page 9

Installation 3 Installation System requirements Technical data Description Operating system Windows 10, Twin CAT/BSD Target platform PC architecture (x86, x64) Twin CAT version 3.1.4024.50 Required Twin CAT license TF3685 Twin CAT 3 Weighing Twin CAT Package Manager: Installation (Twin CAT 3.1 Build 4026) Detailed instructions on installing products can be found in the chapter Installing workloads in the Twin CAT 3.1 Build 4026 installation instructions. Install the following workload to be able to use the product: • TF3685 | Twin CAT 3 Weighing Twin CAT setup: Installation (Twin CAT 3.1 build 4024 and earlier) If you are using Twin CAT 3.1 Build 4024 on the Microsoft Windows operating system, you can install this function via a setup package, which you can download from the Beckhoff website at https:// www.beckhoff.com/download. Depending on the system on which you need the function, the installation can be done on either the engineering or runtime side. The following screenshot shows the Setup interface. To complete the installation process, follow the instructions in the Setup dialog. NOTICE Unprepared Twin CAT restart can cause data loss The installation of this function may result in a Twin CAT restart. Make sure that no critical Twin CAT applications are running on the system or shut them down in an orderly manner first. TF3685 Version: 1.0.2 9
## Page 10

Installation 3.1 Licensing The Twin CAT 3 function can be activated as a full version or as a 7-day test version. Both license types can be activated via the Twin CAT 3 development environment (XAE). Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. 10 Version: 1.0.2 TF3685
## Page 11

Installation 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. TF3685 Version: 1.0.2 11
## Page 12

Installation 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. 12 Version: 1.0.2 TF3685
## Page 13

Technical introduction 4 Technical introduction 4.1 Measuring procedure A typical measuring procedure for determining the mass of a body consists of three main steps: filtering, scaling and evaluation. 1. Filtering The signal from the Ether CAT Terminals of the ELM35xx and EL3356 series typically has a level of noise that requires filtering to ensure valid measurement results. The function block FB_WG_Combo Filter [} 19] offers an effective solution for this by switching a combination of PTn, Moving Average and Notch filters in series. If these filter options are not sufficient, a selection of further filters from the Twin CAT 3 filter library is available. 2. Scaling The filtered input signal must then be scaled in order to specify the weight in the desired unit (e.g. grams [g]). Scaling is performed by the function block FB_WG_Scaling [} 21]. Accurate measurement also requires calibration of the PLC function block, which can be carried out using a two-point calibration, for example. 3. Evaluation In the final step, the scaled signal is analyzed using the function block FB_WG_Weighing [} 27]. It is necessary to provide the configuration structure ST_WG_Weighing [} 32] with the appropriate parameters. A key parameter in this structure is ST_WG_Weighing.n Window Length, which defines the number of samples used to calculate the moving average - a variable also known as the window size. This parameter determines how many past values are used to calculate the outputs f Weight, f Std, f Min and f Max of the function block FB_WG_Weighing [} 27]. Here, f Weight represents the average, f Std the standard deviation and f Min/f Max the minimum or maximum value of the last n Window Length input values. A supplementary figure can illustrate these relationships. TF3685 Version: 1.0.2 13
## Page 14

Technical introduction To obtain additional results from the function block, such as b Valid Measurement, b New Result, t Last Result, f Last Weight and f Last Std, it is necessary to configure the substructure ST_WG_Weighing_Validation [} 33] accordingly. Within ST_WG_Weighing_Validation [} 33], the parameters f Threshold Weight, f Max Weight Deviation and f Max Std define the criteria for a valid measurement. For a measurement to be considered valid, the following conditions must be met: • FB_WG_Weighing.f Weight must be greater than or equal to f Threshold Weight. • The difference FB_WG_Weighing.f Max - FB_WG_Weighing.f Min must not exceed f Max Weight Deviation. • FB_WG_Weighing.f Std must be less than or equal to f Max Std. These conditions must be met over the number of consecutive samples defined in n Validation Samples in order to set FB_WG_Weighing.b Valid Measurement to TRUE . The measurement is initiated as soon as FB_WG_Weighing.f Weight exceeds the value of ST_WG_Weighing_Validation.f Threshold Weight for the first time. As long as FB_WG_Weighing.b Valid Measurement has the value TRUE , the weight (f Weight) with the smallest standard deviation (f Std) is searched for and continuously updated in FB_WG_Weighing.f Last Weight and in FB_WG_Weighing.f Last Std. If the parameter ST_WG_Weighing_Validation.f Relative Weight Limit is defined, the measurement ends as soon as FB_WG_Weighing.f Weight falls below the value of f Threshold Weight * f Relative Weight Limit . If this parameter is not set, the measurement ends when f Weight falls below f Threshold Weight . At the end of the measurement, the timestamp is saved in FB_WG_Weighing.t Last Result and FB_WG_Weighing.b New Result is set to TRUE for exactly one cycle. If FB_WG_Weighing.f Weight exceeds the value f Threshold Weight again, FB_WG_Weighing.f Last Weight is reset and a new measurement begins. The following figure illustrates the process described above and shows the relationship between the parameters and the conditions for a valid measurement: 14 Version: 1.0.2 TF3685
## Page 15

Technical introduction ST_WG_Weighing_Auto Tare [} 34] can be configured in the same way as ST_WG_Weighing_Validation [} 33] to receive results such as f Auto Tare Offset and b New Auto Tare Result from the function block. These are essential for automatically taring the function block FB_WG_Scaling [} 21], for example by calling Auto Tare [} 30](fb Scaling,E_WG_Auto Tare Type [} 36].e End). The parameters f Threshold Weight, f Max Weight Deviation and f Max Std in ST_WG_Weighing_Auto Tare [} 34] define the criteria for the validation of a measurement. A measurement is considered valid if: • FB_WG_Weighing.f Weight does not exceed the value f Threshold Weight. • The difference FB_WG_Weighing.f Max - FB_WG_Weighing.f Min does not exceed the specified f Max Weight Deviation. • FB_WG_Weighing.f Std is less than or equal to the defined f Max Std. The update of f Auto Tare Offset begins as soon as f Weight falls below f Threshold Weight for the first time and the stated conditions are met over a series of consecutive samples defined in n Validation Samples . The system searches for the weight with the lowest standard deviation and updates continuously f Auto Tare Offset. The measurement ends as soon as FB_WG_Weighing.f Weight exceeds f Threshold Weight. FB_WG_Weighing.b New Auto Tare Result is then set once to TRUE , which signals the end of the measurement. If FB_WG_Weighing.f Weight falls below the threshold value f Threshold Weight,, FB_WG_Weighing.f Auto Tare Offset is reset and a new measurement is initiated. The figure below illustrates the process and clarifies the relationship between the parameters and the criteria for a valid measurement. TF3685 Version: 1.0.2 15
## Page 16

Technical introduction 16 Version: 1.0.2 TF3685
## Page 17

PLC API 5 PLC API 5.1 Function blocks Basic structure of the function blocks All function blocks in the Twin CAT Weighing PLC Library are based on the same basic structure. This simplifies the engineering process when changing from one Weighing type to another. Syntax FUNCTION_BLOCK FB_WG_<type> VAR_INPUT st Config : ST_WG_<type>; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs To configure the Weighing function block, a configuration structure of type ST_WG_<type> is transferred to the function blocks during instantiation. The configuration structure can be assigned in the declaration or via the method Configure() at runtime. See also: Data types [} 31] > Configuration structures [} 31] Sample of configuration in the declaration: (* define configure structure - exemplary for Combo Filter *) st Params : ST_WG_Combo Filter := ( n Order := n Order, f Cutoff := f Cutoff, f Sampling Rate := f Sample Rate, n Samples To Filter := n Samples To Filter); (* create filter instance with configure structure *) fb Filter : FB_WG_Combo Filter := (st Config := st Params); Outputs All function blocks have an error flag b Error and a flag b Configured of type BOOL as output parameters. These indicate whether an error has occurred and whether the corresponding function block instance has been successfully configured. The output ip Result Message of type I_Tc Message provides various properties for explaining the cause of an event and methods for processing the message (event list). See also: I_Tc Event Base und I_Tc Message Methods All function blocks in the Tc3_Weighing library have three methods. They return a positive value if they were executed without errors. Configure() The method can be used at runtime to initially configure the instance of a Weighing function block (if not already done in the declaration) or to reconfigure it. METHOD Configure : BOOL VAR_INPUT st Config : ST_WG_<type>; END_VAR Call() TF3685 Version: 1.0.2 17
## Page 18

PLC API The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; (*address of input array*) n Size In : UDINT; (*size of input array*) p Out : POINTER TO LREAL; (*address of output array*) n Size Out : UDINT; (*size of output array*) END_VAR Reset() The method resets the internal status of a Weighing function block. The influence of the past values on the current output value is eliminated. METHOD Reset : BOOL Properties The Tc3_Weighing library references the Twin CAT 3 Event Logger and thus ensures that information (events) is provided via the standardized interface I_Tc Message. Each function block has the properties e Trace Level of type Tc Event Severity and e Trace Level Default of type BOOL. The trace level determines the severity of an event (Verbose, Info, Warning, Error, Critical) and is set via the property e Trace Level. (* Sample of setting fb Filter to trace level info *) fb Filter.e Trace Level := Tc Event Severity. Info; The property e Trace Level Default can be used to set the trace level back to the default value (Tc Event Severity. Warning). The property can be read and written, i.e. the property e Trace Level Default can be used to query whether the default value is set. The properties can also be set in Online View. Dealing with oversampling All function blocks are oversampling-capable, whereby different types of use are possible. The declaration of the Weighing function block instance fb Filter is always the same here. 1-channel application with oversamples The input and output arrays can be declared as one-dimensional variables. VAR CONSTANT c Oversamples : UINT := 10; END_VAR VAR a Input : ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Oversamples] OF LREAL; END_VAR b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 1-channel application without oversamples 18 Version: 1.0.2 TF3685
## Page 19

PLC API If no oversampling is used, the input and output variables can also be declared as LREAL. VAR CONSTANT c Oversamples : UINT := 1; END_VAR VAR f Input : LREAL; f Output : LREAL; END_VAR b Succeed := fb Filter. Call(ADR(f Input), SIZEOF(f Input), ADR(f Output), SIZEOF(f Output)); 5.1.1 FB_WG_Combo Filter The function block FB_WG_Combo Filter implements a PTn, Moving Average and Notch filter connected in series. The filter specification is transferred with the structure ST_WG_Combo Filter [} 31]. Syntax Declaration: fb Filter : FB_WG_Combo Filter(st Config := ...) Definition: FUNCTION_BLOCK FB_WG_Combo Filter VAR_INPUT st Config : ST_WG_Combo Filter; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_WG_Combo Filter Structure for configuring the filter behavior [} 31] Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling. Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and configuration of the function block. Reset() Local Resets internal states. TF3685 Version: 1.0.2 19
## Page 20

PLC API Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE, if e Trace Level = Warning. e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.50 PC or CX (x64, x86) Tc3_Weighing 5.1.1.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset()cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_WG_Combo Filter; END_VAR Inputs Name Type Description st Config ST_WG_Combo Filter Structure for configuring the filter behavior [} 31] Sample (*Declaration without configuration*) fb Filter : FB_WG_Combo Filter(); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.n Samples To Filter := 11; (*change filter order*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF Return value Name Type Description Configure BOOL TRUE if the weighing instance was configured successfully. 5.1.1.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. 20 Version: 1.0.2 TF3685
## Page 21

PLC API Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input := ARRAY [1..c Oversamples] OF LREAL; a Output := ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Weighing. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.1.3 Reset The method resets the internal status of the weighing instance. By resetting the function block, the weighing instance is reset to its original state, i.e. without any influence from the past. The weighing instance is therefore reset to the last configuration status. Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the weighing instance has been successfully reset. 5.1.2 FB_WG_Scaling The function block FB_WG_Scaling is used for scaling raw values. The raw values can be scaled individually or as an array, for example as oversampling values. The configuration structure is transferred with ST_WG_Scaling [} 32]. TF3685 Version: 1.0.2 21
## Page 22

PLC API Syntax Declaration: fb Scaling : FB_WG_Scaling(st Config := ...) Definition: FUNCTION_BLOCK FB_WG_Scaling VAR_INPUT st Config : ST_WG_Scaling; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; e Calibrate State : ULINT; t Last Tare : ULINT; f Current Tare Offset : LREAL; END_VAR Inputs Name Type Description st Config ST_WG_Scaling [} 32] Function block-specific configuration structure Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling. e Calibrate State E_WG_Calibrate [} 35] Current calibrate/tare state. t Last Tare ULINT Timestamp of the last Tare()/ [} 26]Update Tare Offset() [} 27] method call. f Current Tare Offset LREAL Updates itself with every Tare()/ [} 26]Update Tare Offset() [} 27] method call. Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and configuration of the function block. Reset() Local Resets internal states. Apply Calibration() Local Ends the calibration process. Calibrate Ref High() Local Triggers the f Reference High calibration. Calibrate Ref Low() Local Triggers the f Reference Low calibration. Tare() Local Triggers the tare calibration. Update Tare Offset() Local Sets the tare offset value manually and updates the t Last Tare/f Current Tare Offset output. 22 Version: 1.0.2 TF3685
## Page 23

PLC API Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE, if e Trace Level = Warning e Trace Level Tc Event Severity Get, Set Local Warning Severity of an event n Time Stamp ULINT Get, Set Local 0 Timestamp of the oldest input value of the next Call(). Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.50 PC or CX (x64, x86) Tc3_Weighing 5.1.2.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a weighing instance is not configured, the methods Call() and Reset()cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_WG_Scaling; END_VAR Inputs Name Type Description st Config ST_WG_Scaling [} 32] Structure for configuring the filter behavior Sample (*Declaration without configuration*) fb Scaling : FB_WG_Scaling(); (* initial configuration of fb Scaling *) IF b Init THEN b Succeed := fb Scaling. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Scaling on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Raw High:= 10; (*change f Raw High*) b Succeed := fb Scaling. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF Return value Name Type Description Configure BOOL TRUE if the weighing instance was configured successfully. TF3685 Version: 1.0.2 23
## Page 24

PLC API 5.1.2.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input := ARRAY [1..c Oversamples] OF LREAL; a Output := ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Weighing. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.2.3 Reset The method resets the internal status of the weighing instance. By resetting the function block, the weighing instance is reset to its original state, i.e. without any influence from the past. The weighing instance is therefore reset to the last configuration status. Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the weighing instance has been successfully reset. 5.1.2.4 Apply Calibration The method can be used at runtime to complete or cancel the triggered calibration process ( Calibrate Ref High() [} 25]/Calibrate Ref Low() [} 25]). Syntax METHOD Apply Calibration : BOOL VAR_INPUT b Accept : BOOL; END_VAR 24 Version: 1.0.2 TF3685
## Page 25

PLC API Inputs Name Type Description b Accept BOOL If TRUE, the Calibrate Ref High()/Calibrate Ref Low() results are accepted. Otherwise discarded. Sample (*Declaration without configuration*) fb Scaling : FB_WG_Scaling(); (* accept calibration *) IF b Accept Calibration THEN fb Scaling. Apply Calibration(b Accept := TRUE); b Accept Calibration := FALSE; END_IF (* discard calibration *) IF b Discard Calibration THEN fb Scaling. Apply Calibration(b Accept := FALSE); b Discard Calibration:= FALSE; END_IF Return value Name Type Description Apply Calibration BOOL TRUE if the method was executed successfully. 5.1.2.5 Calibrate Ref High The method can be used at runtime to trigger the f Reference High calibration. Syntax METHOD Calibrate Ref High : BOOL VAR_INPUT n Duration In Samples : UDINT; f Ref High : LREAL; END_VAR Inputs Name Type Description n Duration In Samples UDINT Number of samples to be averaged. f Ref High LREAL New f Reference High value. Sample st Params Scale: T_WG_Scaling := (f Raw Low := 0, f Raw High := 1, f Reference High := 1, f Reference Low := 0); fb Scaling :FB_WG_Scaling:=(st Config:=st Params Scale); IF b Calibrate Reference High THEN fb Scaling. Calibrate Ref High(n Duration In Samples := 10, f Ref High := 1.1); b Calibrate Reference High := FALSE; END_IF Return value Name Type Description Calibrate Ref High BOOL TRUE if the method was executed successfully. 5.1.2.6 Calibrate Ref Low The method can be used at runtime to trigger the f Reference Low calibration. TF3685 Version: 1.0.2 25
## Page 26

PLC API Syntax METHOD Calibrate Ref Low : BOOL VAR_INPUT n Duration In Samples : UDINT; f Ref Low : LREAL; END_VAR Inputs Name Type Description n Duration In Samples UDINT Number of samples to be averaged. f Ref Low LREAL New f Reference Low value. Sample st Params Scale: ST_WG_Scaling := (f Raw Low := 0, f Raw High := 1, f Reference High := 1, f Reference Low := 0); fb Scaling :FB_WG_Scaling:=(st Config:=st Params Scale); IF b Calibrate Reference Low THEN fb Scaling. Calibrate Ref Low(n Duration In Samples := 10, f Ref Low := 0.1); b Calibrate Reference Low := FALSE; END_IF Return value Name Type Description Calibrate Ref Low BOOL TRUE if the method was executed successfully. 5.1.2.7 Tare The method can be used at runtime to tare the function block. The average is calculated via n Duration In Samples - output values. Finally, the result is passed to the method Update Tare Offset [} 27](). Syntax METHOD Tare : BOOL VAR_INPUT n Duration In Samples : UDINT; END_VAR Inputs Name Type Description n Duration In Samples UDINT Number of samples to be averaged. Sample st Params Scale: ST_WG_Scaling := (f Raw Low := 0, f Raw High := 1, f Reference High := 1, f Reference Low := 0); fb Scaling :FB_WG_Scaling:=(st Config:=st Params Scale); IF b Tare THEN fb Scaling. Tare(n Duration In Samples := 10); b Tare := FALSE; END_IF Return value Name Type Description Tare BOOL TRUE if the method was executed successfully. 26 Version: 1.0.2 TF3685
## Page 27

PLC API 5.1.2.8 Update Tare Offset The method can be used at runtime to perform manual taring. This means that the f Offset value (weight) is subtracted from the calculated output values. In addition, the function block outputs t Last Tare and f Current Tare Offset (= f Current Tare Offset- f Offset) are updated. Syntax METHOD Update Tare Offset := BOOL VAR_INPUT f Offset := LREAL; (* It corresponds to tare weight.*) END_VAR Inputs Name Type Description f Offset LREAL The new tare weight. Sample st Params Scale: ST_WG_Scaling := (f Raw Low := 0, f Raw High := 1, f Reference High := 1, f Reference Low := 0); fb Scaling :FB_WG_Scaling:=(st Config:=st Params Scale); IF b Update Tare Offset THEN fb Scaling. Update Tare Offset (f Offset := 5.0); b Update Tare Offset := FALSE; END_IF Return value Name Type Description Update Tare Offset BOOL TRUE if the method was executed successfully. 5.1.3 FB_WG_Weighing The function block FB_WG_Weighing is used to determine a measured weight. The configuration structure is transferred with ST_WG_Weighing [} 32]. Syntax Declaration: fb Weighing := FB_WG_Weighing(st Config := ...) Definition: FUNCTION_BLOCK FB_WG_Weighing VAR_INPUT st Config := ST_WG_Weighing; (*The input parameters of this function block represent initialization parameters and must already be assigned in the declaration of the FB instance! TF3685 Version: 1.0.2 27
## Page 28

PLC API (Alternative: Configure() method)*) END_VAR VAR_OUTPUT b Valid Measurement : BOOL := FALSE; // TRUE if ST_WG_Weighing_Validation-conditions are valid (only if n Window Length is full). b New Result : BOOL := FALSE; // TRUE if a new result has been occured (at the end of the Validation measurement). t Last Result : ULINT := 0; // Timestamp of new occured result. f Last Weight : LREAL := 0.0; // Last weighing result. f Last Std : LREAL := 0.0; // Last standard deviation result. f Weight : LREAL := 0.0; // Moving average of n Window Length input values. f Std : LREAL := 0.0; // Moving standard deviation of n Window Length input values. f Min : LREAL := 0.0; // Minimum value of moving n Window Length input values. f Max : LREAL := 0.0; // Maximum value of moving n Window Length input values. f Auto Tare Offset : LREAL := 0.0; // Last auto tare offset result. b New Auto Tare Result : BOOL := FALSE; // TRUE if a new result has been occured (at the end of the Auto Tare measurement). END_VAR VAR Inputs Name Type Description st Config ST_WG_Weighing [} 32] Function block-specific configuration structure Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling b Valid Measurement BOOL TRUE if the ST_WG_Weighing_Validation [} 33] conditions are met. b New Result BOOL TRUE, if a new result was calculated. t Last Result ULINT The timestamp of the last calculated result. f Last Weight LREAL The weight (moving average) of the last result. f Last Hour LREAL The standard deviation of the last result. f Weight LREAL The current weight (moving average) of the last result. f Std LREAL The current moving standard deviation. f Min LREAL Minimum f Weight weight in the sliding window. f Max LREAL Maximum f Weight weight in the sliding window. f Auto Tare Offset LREAL The tare weight of the last result. b New Auto Tare Resul BOOL TRUE if a new tare weight has been calculated. t Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and configuration of the function block. Reset() Local Resets internal states. 28 Version: 1.0.2 TF3685
## Page 29

PLC API Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE, if e Trace Level = Warning. e Trace Level Tc Event Severity Get, Set Local Warning Severity of an event n Time Stamp ULINT Get, Set Local 0 Timestamp of the oldest input value of the next Call(). Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4024.50 PC or CX (x64, x86) Tc3_Weighing Also see about this 2 ST_WG_Weighing_Auto Tare [} 34] 5.1.3.1 Configure The method can be used at runtime to initially configure the weighing instance (if not already done in the declaration) or to reconfigure it. If a weighing instance is not configured, the methods Call() and Reset()cannot be used. Syntax METHOD Configure := BOOL VAR_INPUT st Config := ST_WG_Weighing; END_VAR Inputs Name Type Description st Config ST_WG_Weighing [} 32] Configuration structure Sample (*Declaration without configuration*) fb Weighing : FB_WG_Weighing(); (* initial configuration of fb Weighing *) IF b Init THEN b Succeed := b Weighing. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Weighing on b Reconfigure := TRUE *) IF b Reconfigure THEN st Params.n Window Length := 50; (*change window length*) b Succeed := fb Weighing. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF Return value Name Type Description Configure BOOL TRUE if the weighing instance was configured successfully. TF3685 Version: 1.0.2 29
## Page 30

PLC API 5.1.3.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. If oversampling is used, not all information is displayed. The results of the function block outputs refer to the oldest input value of Call(). Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input := ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Weighing. Call(ADR(a Input), SIZEOF(a Input)); 5.1.3.3 Reset The method resets the internal status of the weighing instance. By resetting the function block, the weighing instance is reset to its original state, i.e. without any influence from the past. The weighing instance is therefore reset to the last configuration status. Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the weighing instance has been successfully reset. 5.1.3.4 Auto Tare The method can be used at runtime to automatically tare a FB_WG_Scaling [} 21] instance. Syntax //This method tares the function block with the interface I_WG_Scaling with the current f Auto Tare Offset-value automaticly if f Auto Tare Offset is not zero. //It calls I_WG_Scaling. Update Tare Offset(f Offset := f Auto Tare Offset) and FB_WG_Weighing. Reset(). //A new FB_WG_Weighing.f Auto Tare Offset value will be updated after ST_WG_Weighing.n Window Length + ST_WG_Weighing_Auto Tare.n Validation Samples at the earliest. METHOD Auto Tare := BOOL VAR_INPUT IScaling : I_WG_Scaling; //function block with the interface I_WG_Scaling e Auto Tare Type : E_WG_Auto Tare Type; // Auto Tare behaviour (end or continously) END_VAR 30 Version: 1.0.2 TF3685
## Page 31

PLC API Inputs Name Type Description IScaling I_WG_Scaling Function block with the interface I_WG_Scaling e Auto Tare Type E_WG_Auto Tare Type Behavior for automatic taring [} 36] Sample // Scaling st Params Scaling : ST_WG_Scaling := ( f Raw Low:=0.0, f Reference Low:=0.0, f Raw High:=1000.0, f Reference High:=100.0); fb Scaling : FB_WG_Scaling:=(st Config:=st Params Scale); // Weighing st Params Weighing : ST_WG_Weighing := ( n Window Length:=100, Validation:=(n Validation Samples:=100, f Threshold Weight:=20.0, f Max Std:=5.0, f Max Weight Deviat ion:=0.0), Auto Tare:=(n Validation Samples:=100, f Threshold Weight:=10.0, f Max Std:=1.0, f Max Weight Deviatio n:=0.0) ); fb Weighing : FB_WG_Weighing:=(st Config:=st Params Weighing); e Auto Tare Type : E_WG_Auto Tare Type : E_WG_Auto Tare Type.e Continously; fb Weighing. Auto Tare(fb Scaling, e Auto Tare Type) Return value Name Type Description Auto Tare BOOL TRUE if the method call was executed successfully. 5.2 Data types 5.2.1 Configuration structures General description There is an individual configuration structure ST_WG_<type> for each function block FB_WG_<type>. In the configuration structure all parameters are defined that are required for the calculation of the transfer function, the input and output variables (size and form of the arrays) as well as the internal states. 5.2.1.1 ST_WG_Combo Filter Configuration structure for the function block FB_WG_Combo Filter [} 19]. (* Optional parameters are ignored if they are zero.*) TYPE ST_WG_Combo Filter : STRUCT n Order : UDINT := 6; (* Order has to be between one and ten. *) f Cutoff : LREAL := 10.0; (* Cutoff frequency [Hz] has to be greater than zero and smaller or equal than f Samplingrate/2. *) f Sampling Rate : LREAL := 1000.0; (* Sampling rate [Hz] has to be greater than zero. *) n Samples To Filter : UDINT := 200; (* Number of samples must be greater than zero. It corresponds to the window size of the moving average filter (optional). *) f Notch Frequency : LREAL := 0.0; (* Notch frequency [Hz] has to be greater than zero and smaller or equal than f Samplingrate/2. The quality factor Q has a default value of 30.0 (optional). *) b Reset : BOOL := TRUE; (* Reset memory, if b Reset = TRUE *) END_STRUCT END_TYPE TF3685 Version: 1.0.2 31
## Page 32

PLC API • n Order is the filter order (1-10). • f Cutoff is the cut-off frequency in Hz (greater than 0 and less than f Sampling Rate /2) • f Sampling Rate is the sampling rate f in Hz. s • n Samples To Filter is the number of samples (greater than 0) to form the moving average (often referred to as the window size). • f Notch Frequency is the notch frequency in Hz (greater than 0 and less than f Sampling Rate /2) • b Reset is a Boolean parameter that specifies whether the internal past values should be reset on reconfiguration. 5.2.1.2 ST_WG_Scaling Configuration structure for the function block FB_WG_Scaling [} 21]. TYPE ST_WG_Scaling : STRUCT f Raw Low : LREAL := 0.0; (* f Raw Low must be smaller than f Raw High. *) f Raw High : LREAL := 1000.0; (* f Raw High must be greater than f Raw Low. *) f Reference Low : LREAL := 0; (* f Reference Low must be smaller than f Reference High. *) f Reference High : LREAL := 100.0; (* f Reference High must be greater than f Reference Low. *) END_STRUCT END_TYPE • f Raw Low must be smaller than f Raw High. • f Raw High must be greater than f Raw Low. • f Reference Low must be smaller than f Reference High. • f Reference High must be greater than f Reference Low. 5.2.1.3 ST_WG_Weighing Configuration structure for the function block FB_WG_Weighing [} 27]. TYPE ST_WG_Weighing : STRUCT n Window Length : UDINT := 100; (* Size in samples of a sliding window and must be greater than zero. It specifies over how many values the function block outputs f Weight, f Std, f Min and f Max should be calculated. If the amount of existing input values is smaller than n Window Length the calculation will be done with the already existing values. *) Validation : ST_WG_Weighing_Validation; Auto Tare : ST_WG_Weighing_Auto Tare; END_STRUCT END_TYPE • n Window Length is the number of samples used to form the moving average (often referred to as the window size). The parameter specifies how many values are to be used to calculate the function block outputs f Weight, f Std, f Min and f Max. If the number of existing input values is less than n Window Length, the calculation is carried out using the existing input values. • Validation is an optional substructure that influences the function block outputs b Valid Measurment, b New Result, t Last Result and f Last Weight. • Auto Tare is an optional substructure that influences the function block outputs f Auto Tare Offset and b New Auto Tare Result. 32 Version: 1.0.2 TF3685
## Page 33

PLC API 5.2.1.3.1 ST_WG_Weighing_Validation Substructure for the configuration structure ST_WG_Weighing [} 32]. Set parameters affect the function block outputs b Valid Measurement, b New Result, t Last Result, f Last Weight and f Last Std [} 28]. (*This configure struct helps to find the actual weight during one measuring cycle. A measuring cycle starts when FB_WG_Weighing.f Weight exceeds f Threshold Weight and ends when it falls below f Relative Weight Limit*FB_WG_Weighing.f Last Weight or f Threshold Weight (if f Relative Weight Limit is not set). The actual weight will be displayed in FB_WG_Weighing.f Last Weight (FB_WG_Weighing.f Weight with smallest FB_WG_Weighing.f Std). Optional parameters are ignored if they are zero. None of the parameters can be less than zero.*) TYPE ST_WG_Weighing_Validation : STRUCT f Threshold Weight : LREAL := 50.0; (* Minimum value for the measured weight. This condition is fulfilled if FB_WG_Weighing.f Weight is greater than or equal to f Threshold Weight. *) n Validation Samples : UDINT := 10; (* Number of input values for which the other ST_WG_Weighing_Validation parameter conditions (f Threshold Weight, f Max Std, f Max Weight Deviation) must be fulfilled so that FB_WG_Weighing.b Valid Measurement=TRUE (optional, recommended). *) f Max Std : LREAL := 5.0; (* Upper limit for the standard deviation. This condition is fulfilled if FB_WG_Weighing.f Std is less than or equal to f Max Std (optional, recommended). *) f Max Weight Deviation : LREAL := 0.0; (* Upper limit for the maximum weight deviation. This condition is fulfilled if FB_WG_Weighing.f Max - FB_WG_Weighing.f Min is less than or equal to f Max Weight Deviation (optional, recommended). *) f Relative Weight Limit : LREAL := 0.0; (* f Relative Weight Limit (> 0 and < 1) specifies that FB_WG_Weighing.b New Result and FB_WG_Weighing.t Last Result are updated if FB_WG_Weighing.f Weight falls below the f Relative Weight Limit * FB_WG_Weighing.f Last Weight limit value (optional). *) END_STRUCT END_TYPE • f Threshold Weight is the minimum value for the measured weight. This condition is met if FB_WG_Weighing.f Weight is greater than or equal to f Threshold Weight. • n Validation Samples is the number of input values for which the other ST_WG_Weighing_Validation parameter conditions (f Threshold Weight, f Max Std, f Max Weight Deviation) must be fulfilled so that FB_WG_Weighing.b Valid Measurement=TRUE (optional, recommended). • f Max Std is the upper limit for the standard deviation. This condition is met if FB_WG_Weighing.f Std is less than or equal to f Max Std (optional, recommended). • f Max Weight Deviation is the upper limit for the maximum weight deviation. This condition is met if FB_WG_Weighing.f Max - FB_WG_Weighing.f Min is less than or equal to f Max Weight Deviation (optional, recommended). TF3685 Version: 1.0.2 33
## Page 34

PLC API • f Relative Weight Limit (> 0 and < 1) specifies that FB_WG_Weighing.b New Result and FB_WG_Weighing.t Last Result are updated if FB_WG_Weighing.f Weight falls below the limit value f Relative Weight Limit-FB_WG_Weighing.f Last Weight (optional). If FB_WG_Weighing.f Weight rises above f Threshold Weight, the weight with the lowest FB_WG_Weighing.f Std is searched for until FB_WG_Weighing.f Weight leaves the f Threshold Weight limit again. If f Relative Weight Limit is set, the measurement ends when FB_WG_Weighing.f Weight falls below f Threshold Weight*f Relative Weight Limit. The weight determined is displayed for the first time on a rising edge of FB_WG_Weighing.b Valid Measurement in FB_WG_Weighing.f Last Weight and is updated until the measurement is complete. At the end of the measurement, the timestamp is set in FB_WG_Weighing.t Last Result and FB_WG_Weighing.b New Result is set to TRUE for one cycle. If FB_WG_Weighing.f Weight rises above f Threshold Weight again, FB_WG_Weighing.f Last Weight is set to zero and a new measurement begins. 5.2.1.3.2 ST_WG_Weighing_Auto Tare Substructure for the configuration structure ST_WG_Weighing [} 32]. If parameters are set, this only affects FB_WG_Weighing.f Auto Tare Offset and FB_WG_Weighing.b New Auto Tare Result. An instance of fb Scaling from FB_WG_Scaling [} 21] can be automatically tared, e.g. by calling Auto Tare [} 30](fb Scaling, E_WG_Auto Tare Type [} 36].e End). (* This configure struct helps to find the tare weight during one measuring cycle. A measuring cycle starts when the FB_WG_Weighing.f Weight falls below f Threshold Weight and ends when it exceeds f Threshold Weight. The tare weight will be updated (FB_WG_Weighing.f Weight with smallest FB_WG_Weighing.f Std) in FB_WG_Weighing.f Auto Tare Offset until the measuring cycle ends. FB_WG_Scaling can be automatically tared by calling fb Weighing. Auto Tare(fb Scale, E_WG_Auto Tare Type.e End). Optional parameters are ignored if they are zero. None of the parameters can be less than zero.*) TYPE ST_WG_Weighing_Auto Tare : STRUCT f Threshold Weight : LREAL := 20.0; (* Maximum value for the measured weight. This condition is fulfilled if FB_WG_Weighing.f Weight is smaller than or equal to f Threshold Weight. *) n Validation Samples : UDINT := 50; (* Number of input values for which the other ST_WG_Weighing_Auto Tare parameter conditions (f Threshold Weight, f Max Std, f Max Weight Deviation) must be fulfilled in order for FB_WG_Weighing.f Auto Tare Offset to be updated. (optional, recommended). *) f Max Std : LREAL := 0.0; (* Upper limit for the standard deviation. This condition is fulfilled if FB_WG_Weighing.f Std is less than or equal to f Max Std (optional, recommended). *) f Max Weight Deviation : LREAL := 0.0; (* Upper limit for the maximum weight deviation. This condition is fulfilled if FB_WG_Weighing.f Max - FB_WG_Weighing.f Min is less than or equal to 34 Version: 1.0.2 TF3685
## Page 35

PLC API f Max Weight Deviation (optional, recommended). *) END_STRUCT END_TYPE • f Threshold Weight is the maximum value for the measured weight. This condition is met if FB_WG_Weighing.f Weight is less than or equal to f Threshold Weight. • n Validation Samples is the number of input values for which the other ST_WG_Weighing_Auto Tare parameter conditions (f Threshold Weight, f Max Std, f Max Weight Deviation) must be fulfilled so that FB_WG_Weighing.f Auto Tare Offset (optional, recommended). • f Max Std is the upper limit for the standard deviation. This condition is met if FB_WG_Weighing.f Std is less than or equal to f Max Std (optional, recommended). • f Max Weight Deviation is the upper limit for the maximum weight deviation. This condition is met if FB_WG_Weighing.f Max - FB_WG_Weighing.f Min is less than or equal to f Max Weight Deviation (optional, recommended). If FB_WG_Weighing.f Weight falls below f Threshold Weight, the tare weight with the lowest FB_WG_Weighing.f Std is searched for until FB_WG_Weighing.f Weight leaves the f Threshold Weight limit again. The tare weight is displayed at the earliest after n Validation Samples values in FB_WG_Weighing.f Weight. 5.2.2 E_WG_Calibrate ENUM for the calibration output of FB_WG_Scaling [} 21] . Syntax Definition: TYPE E_WG_Calibrate : ( e Idle :=1, (* e Idle represents no calibration. *) e Calibrate Low :=2, (* e Calibrate Low represents that the Calibrate Ref Low() process is still running. *) e Calibrate High :=3, (* e Calibrate High that the Calibrate Ref High() process is still running. *) e Calibrate Idle :=4, (* e Calibrate Idle represents the temporary completed Calibrate Ref Low()/ Calibrate Ref High() process. Apply Calibration() completes or discards the process. *) e Tare :=5 (* e Tare represents the current Tare() process. *) ) UDINT END_TYPE TF3685 Version: 1.0.2 35
## Page 36

PLC API 5.2.3 E_WG_Auto Tare Type ENUM for the method input of FB_WG_Weighing. Auto Tare() [} 30]. Syntax Definition: TYPE E_WG_Auto Tare Type : ( e End := 0, // Tares at the end of the Auto Tare measurement (if FB_WG_Weighing.b New Auto Tare Result = TRUE). e Continously, // Tares continiously, if FB_WG_Weighing.f Auto Tare Offset is not 0. e Idle // Do nothing ) END_TYPE 36 Version: 1.0.2 TF3685
## Page 37

Samples 6 Samples 6.1 Dynamic weighing This sample shows how the dynamic weighing process works with the Weighing PLC library. Download: https://infosys.beckhoff.com/content/1033/TF3685_TC3_Weighing_Library/Resources/ 16127833867.zip (*.tnzip) Description The input signal, a noisy trapezoidal signal, is generated in the MAIN program using the method Generate Inputs() with a signal generator. The simulated signal is transferred to the function block FB_Dynamic Weighing (fb Dynamic Weighing), which forwards it internally to other function blocks. This includes filtering with the function block FB_WG_Combo Filter [} 19] (fb Combo Filter), scaling with the function block FB_WG_Scaling [} 21] (fb Scale) and evaluation with the function block FB_WG_Weighing [} 27] (fb Weighing). Program parameters The table below shows a list of important parameters for configuring the function blocks used. Variable Description Default value f Raw Amplitude Signa Amplitude of the trapezoidal signal 1000.0 l f Absolute Noise Absolute noise amount 200.0 f Frequency Base frequency of the trapezoidal signal 1.0 Hz b Activate Slope A drifting test signal is activated/deactivated FALSE b Add Weight Adds an offset value to the test signal once FALSE e Auto Tare Type Selection for automatic taring E_WG_Auto Tare Typ e.e Continously The following global constants are defined. Variable Description Default value c Oversamples Number of oversamples of the input channel 10 c Sampling Rate Sample rate of the input channel in Hz 1000 Implementation: First, the corresponding structures and function blocks are declared and initialized: // Filter st Params Combo Filter : ST_WG_Combo Filter := ( n Order : =6, f Cutoff : =10.0, f Sampling Rate : =TO_LREAL(c Sampling Rate), n Samples To Filter : =200, b Reset := FALSE ); fb Combo Filter := FB_WG_Combo Filter:=(st Config := st Params Combo Filter); // Scaling st Params Scale : ST_WG_Scaling : = ( f Raw Low : =0.0, f Reference Low : =0.0, f Raw High : =1000.0, f Reference High : =100.0 ); fb Scale : FB_WG_Scaling : =(st Config : =st Params Scale, e Trace Level : =Tc Event Severity. Info); TF3685 Version: 1.0.2 37
## Page 38

Samples // Weighing st Params Weighing : ST_WG_Weighing : = ( n Window Length : =100, Validation:=(n Validation Samples : =100, f Threshold Weight : =20.0, f Max Std : =5.0, f Max Weight Deviation : =0.0), Auto Tare : =(n Validation Samples : =100, f Threshold Weight : =10.0, f Max Std:=1.0, f Max Weight Deviation : =0.0) ); fb Weighing : FB_WG_Weighing : =(st Config : =st Params Weighing); In the implementation part, the function block instances are executed using the corresponding Call() methods. // Execute weighing IF NOT fb Combo Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Out Filter), SIZEOF(a Out Filter)) THEN Set Error(fb Combo Filter); END_IF IF NOT fb Scale. Call(ADR(a Out Filter), SIZEOF(a Out Filter), ADR(a Out Scaling), SIZEOF(a Out Scaling)) THEN Set Error(fb Scale); END_IF IF NOT fb Weighing. Call(ADR(a Out Scaling), SIZEOF(a Out Scaling)) THEN Set Error(fb Weighing); END_IF Automatic taring: The instance fb Scale can be automatically tared via the fb Weighing instance as follows: // Execute Auto Tare IF NOT fb Weighing. Auto Tare(fb Scale, e Auto Tare Type)THEN Set Error(fb Weighing); END_IF Depending on the e Auto Tare Type initialization value, there is the following case distinction: 38 Version: 1.0.2 TF3685
## Page 39

Samples E_WG_Auto Tare Type.e End (above): fb Scale is tared with the value f Auto Tare Offset if b New Auto Tare Result is equal to TRUE. E_WG_Auto Tare Type.e Continously (below): fb Scale is tared with the value f Auto Tare Offset if f Auto Tare Offset is not equal to 0. After taring, a fb Weighing. Reset() is automatically executed each time. TF3685 Version: 1.0.2 39
## Page 40

Appendix 7 Appendix 7.1 Return codes Return codes of the ip Result Message. Online Watch: Defined events: 40 Version: 1.0.2 TF3685
## Page 41

Appendix n Event Id Name s Event Text (hex) 16#0001 Dbg Message Dbg: {0}. 16#1001 Tc Com_Transition_PS_Failed Error in Transition PREOP->SAFEOP. 16#1002 Tc Com_Transition_SO_Faile Error in Transition SAFEOP->OP. d 16#1003 Tc Com_Transition_SO_Faile Error in Transition SAFEOP->OP: No Task assigned. Module d_No Task will not be executed cyclically. 16#1004 Tc Com_Transition_OS_Faile Error in Transition OP->SAFEOP. d 16#1005 Tc Com_Transition_SP_Failed Error in Transition SAFEOP->PREOP. 16#1006 Tc Com_Cyclic Caller Assigned Cyclic caller is assigned. Methods can not be called. 16#1007 Tc Com_Invalid Object State Invalid object state. 16#1008 Tc Com_Invalid Symbol Size Invalid symbol size. 16#1009 Tc Com_Invalid Data Area No Invalid data area number. 16#2001 Init_No Router Memory Memory could not be allocated dynamically. Check size of rotuer memory. 16#3001 Config_Invalid Pointer Null pointer was allocated. 16#3002 Config_No Router Memory Memory could not be allocated dynamically. Check size of rotuer memory. 16#3003 Config_Invalid Cut Off Cutoff must be greater than zero and smaller than Samplingrate/ 2. 16#3004 Config_Invalid Sampling Rate Sampling rate must be greater than zero. 16#3005 Config_Invalid Samples To Filte Samples To Filter must be greater than zero. r 16#3008 Config_Invalid Order Order must be greater than zero and smaller than eleven. 16#3009 Config_Invalid Window Length Window Length must be greater than zero. 16#3010 Config_Invalid Threshold Threshold must be equal or greater than zero. 16#3011 Config_Invalid Max Std Max Std must be equal or greater than zero. 16#3012 Config_Invalid Max Weight Devi Max Weight Deviation must be equal or greater than zero. ation 16#3013 Config_Invalid Reference Valu Reference High must be greater than Reference Low. e 16#3014 Config_Invalid Raw Value Raw High must be greater than Raw Low. 16#3015 Config_Invalid Calibration Valu Raw High must be greater than Raw Low. Reference High must es be greater than Reference Low. 16#3016 Config_Invalid Relative Weight Relative Weight Limit must be greater or equal than zero and Limit smaller than one. 16#3017 Config_Invalid Notch Frequenc Notch Frequency must be greater than zero and smaller than y f Samplingrate/2. 16#4001 Run_Missing Configuration Missing configuration. 16#4002 Run_Invalid Pointer Null pointer was allocated. 16#4003 Run_Invalid Input Size Invalid input size. 16#4004 Run_Invalid Output Size Output size array cant be smaller than input array size. 16#6001 Warning_Calibration Process F Calibration has not been processed successfully. Raw High must ailed be greater than Raw Low. Reference High must be greater than Reference Low. TF3685 Version: 1.0.2 41
## Page 42

Appendix n Event Id Name s Event Text (hex) 16#6002 Warning_Could Not Trigger Tar The tare process could not be triggered because the calibration e process had not yet been completed. 16#6003 Warning_Invalid State Invalid state. 16#7003 Warning_Invalid Cut Off Cutoff must be greater than zero and smaller than Samplingrate/ 2. 16#7004 Warning_Invalid Sampling Rat Sampling rate must be greater than zero. e 16#7005 Warning_Invalid Samples To Fil Samples To Filter must be greater than zero. ter 16#7008 Warning_Invalid Order Order must be greater than zero and smaller than eleven. 16#7009 Warning_Invalid Window Lengt Window Length must be greater than zero. h 16#7010 Warning_Invalid Threshold Threshold must be equal or greater than zero. 16#7011 Warning_Invalid Max Std Max Std must be equal or greater than zero. 16#7012 Warning_Invalid Max Weight D Max Weight Deviation must be equal or greater than zero. eviation 16#7013 Warning_Invalid Reference Val Reference High must be greater than Reference Low. ue 16#7014 Warning_Invalid Raw Value Raw High must be greater than Raw Low. 16#7015 Warning_Invalid Calibration Va Raw High must be greater than Raw Low. Reference High must lues be greater than Reference Low. 16#7016 Warning_Invalid Notch Freque Notch Frequency must be greater than zero and smaller than ncy f Samplingrate/2. 7.2 FAQ - frequently asked questions and answers Frequently asked questions are answered in this section to make it easier for you to work with the Twin CAT 3 Weighing Library. If you have further questions, please contact our support (-157). 1. Can I extend the filters of FB_WG_Combo Filter for more sophisticated applications? [} 42] Can I extend the filters of FB_WG_Combo Filter for more sophisticated applications? The FB_WG_Combo Filter already contains three different filter types that you can add depending on the application. If this is not enough, additional filters can be added using the TF3680 Twin CAT 3 filter library. For this application, the license for the TF3680 is already included in the license for the TF3685 Twin CAT 3 Weighing. An additional license is therefore not required. 42 Version: 1.0.2 TF3685
## Page 43

Appendix 7.3 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com TF3685 Version: 1.0.2 43
## Page 44

Trademark statements Beckhoff®, ATRO® , Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, MX-System®, Safety over Ether CAT®, TC/BSD®, Twin CAT®, Twin CAT/BSD®, Twin SAFE®, XFC®, XPlanar®, and XTS® are registered and licensed trademarks of Beckhoff Automation Gmb H. Third-party trademark statements Microsoft, Microsoft Azure, Microsoft Edge, Power Shell, Visual Studio, Windows and Xbox are trademarks of the Microsoft group of companies.
## Page 45

More Information: www.beckhoff.com/tf3685 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
