---
title: "Corrected_timestamps_EN"
product: "Corrected"
category: "Fundamentals"
tags: ["CORRECTED"]
language: "EN"
document_type: "Manual"
version: "1.4"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/Corrected_timestamps_EN.pdf"
release_date: "2021-11-15"
---
Manual | EN Twin CAT 3 Corrected timestamps 2021-11-15 | Version: 1.4

## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation.............................................................................................................. 5 1.2 Safety instructions............................................................................................................................. 6 1.3 Notes on information security............................................................................................................ 7 2 Overview..................................................................................................................................................... 8 3 System requirements................................................................................................................................ 9 4 Limitations................................................................................................................................................ 10 5 Technical introduction............................................................................................................................ 11 5.1 Consumers...................................................................................................................................... 11 5.1.1 Twin CAT components as offset consumers.................................................................... 11 5.1.2 Application implementation.............................................................................................. 11 5.2 Provider........................................................................................................................................... 12 5.2.1 NTP provider.................................................................................................................... 12 5.2.2 DC provider...................................................................................................................... 16 5.2.3 Application implementation.............................................................................................. 18 6 Real-time API............................................................................................................................................ 20 6.1 Structures........................................................................................................................................ 20 6.1.1 Enum Time Type.............................................................................................................. 20 6.2 Interfaces......................................................................................................................................... 20 6.2.1 ITc Set External Time interface.......................................................................................... 20 6.2.2 ITc External Time interface................................................................................................ 22 7 ADS API.................................................................................................................................................... 25 8 Samples.................................................................................................................................................... 27 8.1 ADS consumer................................................................................................................................ 27 8.2 PLC Consumer................................................................................................................................ 27 8.3 C++ consumer................................................................................................................................. 28 8.4 C++ provider.................................................................................................................................... 28 9 Appendix.................................................................................................................................................. 30 9.1 FAQ................................................................................................................................................. 30 9.1.1 Windows as NTP client.................................................................................................... 30 9.1.2 Windows as NTP server.................................................................................................. 30 Twin CAT 3 Version: 1.4 3

## Page 4

Table of contents 4 Version: 1.4 Twin CAT 3

## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is only intended for the use of trained specialists in control and automation engineering who are familiar with applicable national standards. It is essential that the documentation and the following notes and explanations are followed when installing and commissioning the components. It is the duty of the technical personnel to use the documentation published at the respective time of each installation and commissioning. The responsible staff must ensure that the application or use of the products described satisfy all the requirements for safety, including all the relevant laws, regulations, guidelines and standards. Disclaimer The documentation has been prepared with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without prior announcement. No claims for the modification of products that have already been supplied may be made on the basis of the data, diagrams and descriptions in this documentation. Trademarks Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered trademarks of and licensed by Beckhoff Automation Gmb H. Other designations used in this publication may be trademarks whose use by third parties for their own purposes could violate the rights of the owners. Patent Pending The Ether CAT Technology is covered, including but not limited to the following patent applications and patents: EP1590927, EP1789857, EP1456722, EP2137893, DE102015105702 with corresponding applications or registrations in various other countries. Ether CAT® is a registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The reproduction, distribution and utilization of this document as well as the communication of its contents to others without express authorization are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event of the grant of a patent, utility model or design. Twin CAT 3 Version: 1.4 5

## Page 6

Foreword 1.2 Safety instructions Safety regulations Please note the following safety instructions and explanations! Product-specific safety instructions can be found on following pages or in the areas mounting, wiring, commissioning etc. Exclusion of liability All the components are supplied in particular hardware and software configurations appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. Personnel qualification This description is only intended for trained specialists in control, automation and drive engineering who are familiar with the applicable national standards. Description of symbols In this documentation the following symbols are used with an accompanying safety instruction or note. The safety instructions must be read carefully and followed without fail! DANGER Serious risk of injury! Failure to follow the safety instructions associated with this symbol directly endangers the life and health of persons. WARNING Risk of injury! Failure to follow the safety instructions associated with this symbol endangers the life and health of per- sons. CAUTION Personal injuries! Failure to follow the safety instructions associated with this symbol can lead to injuries to persons. NOTE Damage to the environment or devices Failure to follow the instructions associated with this symbol can lead to damage to the environment or equipment. Tip or pointer This symbol indicates information that contributes to better understanding. 6 Version: 1.4 Twin CAT 3

## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. Twin CAT 3 Version: 1.4 7

## Page 8

Overview 2 Overview Controllers generate data to be collected and linked in modern, distributed systems. Since controllers start off as stand-alone devices, they have independent time bases. In a common database, it would not be possible to correlate data with respect to time. In order to counter this problem, it has been possible for quite some time to synchronize controllers with each other, for example using the network protocol IEEE1588 or PTP. However, in many scenarios it is sufficient to provide the data with a uniform timestamp. The controllers can be operated independently of each other, so that on the one hand the hardware costs associated with the protocols mentioned above are reduced, while on the other hand there is no technical dependency between the controllers. This chapter describes the Twin CAT components for adapting timestamps for storing time-synchronous data. The figure illustrates the basic idea: independent controllers obtain the local timestamp and adjust it using an offset, which is then used to store the common data. A central component, the external time interface, is available in Twin CAT real-time for this purpose. This component • receives the offset to the corrected time from a configured source (external time provider). • provides the external time consumer with a corrected time, depending on the current local time. This corrected time can then be used by different components inside and outside the real-time. The source is typically either an NTP server or a DC time signal based on Ether CAT, which is synchronized via EL6688 through PTP (IEEE1588), for example. However, a source can also be implemented by the customer, so that other time signals can be realized as a source. In addition to the central component in the Twin CAT real-time described above, the concept thus comprises two types of components: 1. External time providers: provide an offset for adjusting timestamps of the central component. For example, a provider obtains a timestamp via NTP (Network Time Protocol, see RFC 4330), from which it calculates an offset to the local system time and makes this available. 2. External time consumers: use an offset that they obtain from the central component. Thus a time- stamp can be used in the components that leads to comparable data on remote devices. All Twin CAT components that use timestamps can be consumers, and also customer applications. 8 Version: 1.4 Twin CAT 3

## Page 9

System requirements 3 System requirements Technical data Requirement Operating system Windows 7/10, Windows Embedded Standard 7 Target platform PC architecture (x86, x64) Twin CAT version Twin CAT 3.1 build 4024.0 or higher Required Twin CAT setup level Twin CAT 3 XAE, XAR Required Twin CAT license Any runtime license (PLC, C++) Twin CAT 3 Version: 1.4 9

## Page 10

Limitations 4 Limitations Some important limitations have to be taken into account: • The Twin CAT system time is not changed by the external time interface described here • The external time offsets are made available to the consumers as provided by the provider. It follows that ◦ the offset must be calculated correctly by the provider. ◦ no monotony can be guaranteed in the timestamps. • The external time offsets are not saved and subsequently made available for retrieval. This means that only the current offsets are managed in the Twin CAT system. 10 Version: 1.4 Twin CAT 3

## Page 11

Technical introduction 5 Technical introduction Twin CAT offers different interfaces for the external time provider and the external time consumer in order to utilize the concept of corrected timestamps. On the external time consumer side, different Twin CAT components are able to use the external timestamp. In addition, there are different access options for applications. On the external time provider side, modules are provided that can calculate and provide an offset via NTP. In addition, there is a module that can use the offset via DC. The corresponding interface for providing the offset is also offered for Twin CAT C++, so that customers can create their own external time providers. Timestamps for different use cases It should be noted that Twin CAT differentiates between four types of timestamps in this concept: 1. None: Local system time and no correction 2. Soft: Recommended use e.g. for NTP 3. Medium: Recommended use e.g. for IEEE1588 4. Hard: Recommended use e.g. for hardware synchronization where no drift should occur An external time provider provides one of the possible offsets; only one provider can be defined for each type. An external time consumer can then use any offset; all four offset types can be used as required. Thus it is possible to use different timestamps in different ensembles or operation modes. For example, a local diagnosis can take place with the local system time, while at the same time aggregated data from different systems can be corrected with the offset type Soft and stored in a common database. The interfaces of the corrected timestamps use data types with a length of 8 bytes and are counted from 1.1.1601 in 100 ns steps. 5.1 Consumers External time consumers are components that can correct the local system time with an offset. For this purpose, the components must select or configure an offset of type Soft, Medium or Hard and query it accordingly. 5.1.1 Twin CAT components as offset consumers The following Twin CAT components support the approach of corrected timestamps – the respective documentation describes how this functionality can be enabled: • Twin CAT 3 Event Logger This list will be extended. 5.1.2 Application implementation Applications can use the external time offsets in different components: • Real-time PLC: The PLC can query an offset or have a local timestamp corrected accordingly. • Real-time – C++: C++ Tc COM modules are able to query the offset and act accordingly. • User mode – ADS device notifications: The timestamps sent with the ADS device notifications can be corrected. • User mode – ADS Read: The corrected timestamp can be retrieved by an ADS Read. This can be used in ADS Sum commands to retrieve a timestamp along with data. The interfaces are documented in the corresponding API chapters. Twin CAT 3 Version: 1.4 11

## Page 12

Technical introduction 5.2 Provider External time providers are components that determine an external time offset in relation to the local system time through an external information source and make it available in Twin CAT. This allows external time consumers to receive a corrected time, independent of the provider. Twin CAT also supplies providers with: • NTP providers: an implementation that queries and provides a time signal from an NTP server via (S)NTP. • DC providers: An implementation that passes on the DC time from the Ether CAT master to Twin CAT as an offset (e.g. via IEEE1588 or PTP) • In addition, the customer is able to provide his own providers. 5.2.1 NTP provider The NTP provider is an (S)NTP client that cyclically receives a time signal from an NTP server. This allows it to calculate an offset of the system time from the time signal of the NTP server and make it available accordingly. Configuration The NTP provider is implemented as Tc COM module Tc Ntp External Time Provider. This module is commissioned as a Tc COM module as follows: ü Twin CAT project 1. Insert a Tc COM module under System->Tc COM Objects and select type Tc Ntp External Time Provider in the category External Time Provider. 12 Version: 1.4 Twin CAT 3

## Page 13

Technical introduction 2. The module requires a task from which it is called. This is parameterized via the Context tab of the module: ð The Tc COM module can be parameterized: The configuration takes place in the Parameter (Init) tab. The parameters have the following meanings: • Time Time: The type of offset for which this module is to determine an offset. Client Para: • b Enable: The module can be disabled to prevent NTP communication. • s Server Name: The name of the NTP server to be used as the source. • n Server Address: IP address of an NTP server (used if s Server Name is empty). • n Server Port: The UDP port of the NTP server to be used (default: 123). • t Poll Intervall: The interval in which the NTP queries are to be started. The maximum specified by the server is taken into account, which may slow down requests. This module passes a determined offset to Twin CAT via the ITc Set External Time [} 20] interface. In addition, outputs are available for mapping. Twin CAT 3 Version: 1.4 13

## Page 14

Technical introduction NTP provider as NTP server Optionally, the same module can also act as an NTP server. Thus, a time signal can be obtained from an external NTP server (as a client) and simultaneously provided to lower-level systems. For the external server, the NTP protocol typically requires a minimum query time of 8 seconds or more. The NTP provider as NTP server, on the other hand, allows more frequent query intervals. Server function The server functionality is normally hidden. It can be displayed and configured via Show Hidden Parameters: • b Enable: Enable NTP server functionality for this module. To do this, open the udp/123 port in the Windows firewall. • n Port: The UDP port that is used to offer the server (default: 123). The following parameters are used to adjust the NTP information provided. By default, the parameters are set as specified in the protocol; they can be overwritten here: • n Leap: Manual configuration of the Leap Indicator. • n Stratum: Manual configuration of the stratum. • n Root: Manual configuration of the root server information, as defined depending on the stratum. 14 Version: 1.4 Twin CAT 3

## Page 15

Technical introduction Filter function If offsets are determined by the NTP server query, the module can independently perform a transition from the old offset to the new offset. This functionality is normally hidden. It can be displayed and configured via Show Hidden Parameters: • e Mode: A selection of modes. Currently, either no adjustment or a linear adjustment is made (default). The following parameters apply if "Linear" is selected as e Mode: • n Filter: Number of values for which the average is taken, i.e. number of NTP responses. With a poll interval of 1 s, n Filter = 60 would effect a filter for one minute. (Default: 60). • n Limiter: The offset is changed by this value at the most per cycle. If the difference between the local and external clocks were to be 100 ms and the cycle time 1 ms, it would thus take 100,000 cycles or 1.6 minutes at n Limiter = 10 until the offset has settled. (Default: 1 µs). • n Modulo: Rounding of the offset. Usually this should be chosen depending on the cycle time. The offset is adjusted via this modulo so that no "un-round" times are created. The DC Time will return the modulo of the cycle time; corrected with the offset, the time stamp thus remains "round". The offset/ time stamp changes as a result, but also with small jumps if an adjustment takes place. As described under n Limiter and with n Modulo = 1000, the offset and thus the relative time stamp would increment every 100th cycle by 0.1 ms. Diagnostics Diagnostic information can be viewed under the Parameters (Online) tab. Twin CAT 3 Version: 1.4 15

## Page 16

Technical introduction For each line there is a corresponding description in the Comment column. In addition, corresponding symbols are available for programmatic evaluation: 5.2.2 DC provider The DC provider obtains an offset through mapping from an Ether CAT master. It can be used to use time values from the I/O range as offset, such as those provided by the Ether CAT master (DC time) or an EL6695. Configuration The DC provider is implemented as Tc COM module Tc Dc External Time Provider. This module is commissioned as a Tc COM module as follows: ü Twin CAT project 16 Version: 1.4 Twin CAT 3

## Page 17

Technical introduction 1. Insert a Tc COM module under System->Tc COM Objects and select type Tc Dc External Time Provider in the category External Time Provider. 2. The module requires a task from which it is called. This is parameterized via the context tab of the module: ð The module can be parameterized: The configuration takes place in the Parameters (Init) tab. The parameters have the following meanings: • Time Time: The type of offset for which this module is to determine an offset. Twin CAT 3 Version: 1.4 17

## Page 18

Technical introduction • This module obtains the offset itself through mapping: This module passes a determined offset to Twin CAT via the ITc Set External Time [} 20] interface. In addition, outputs are available for mapping. 5.2.3 Application implementation An application can provide its own Time Offset provider by using the ITc Set External Time interface in Twin CAT C++. This module provides a cyclic value for the respective offsets, if necessary. Sequence A module implements the following sequence ü A Tc COM module was instantiated 1. The module registers itself as provider of a certain type of offset (Soft/Medium/Hard) via Register External Time Provider 18 Version: 1.4 Twin CAT 3

## Page 19

Technical introduction 2. Set External Time Offset can be used to provide an offset cyclically, if necessary 3. The module logs off using Unregister External Time Provider Registration ensures that an offset of only one module can be used at a time. A more detailed description of the ITc Set External Time interface can be found in chapter ITc Set External Time interface [} 20]. Twin CAT 3 Version: 1.4 19

## Page 20

Real-time API 6 Real-time API At this point, interfaces and structures are documented to deal with the corrected timestamps from the real- time. 6.1 Structures 6.1.1 Enum Time Type Twin CAT provides four different timestamps. The Enum Time Type is used to distinguish between them. Syntax enum Time Type { System Time = 0, External Time Hard = 1, External Time Medium = 2, External Time Soft = 3, // e.g. NTP }; Values How the three external timestamp types are used in practice depends on application. The example below is merely a suggestion. Name Description External Time Hard Suggested use for hard offsets that have no drift External Time Medium Suggested use for accurate offsets such as IEE1588 External Time Soft Suggested use for general offsets, such as NTP 6.2 Interfaces At this point the interfaces are described which are used for the corrected time stamps. For the different time formats and representations there is a corresponding list in the C++ SDK. See: Infosys C/C++ 6.2.1 ITc Set External Time interface The ITc Set External Time interface is implemented by the Tc COM object server. It can be used to provide an externally determined offset. Syntax TCOM_DECL_INTERFACE("00000067-0000-0000-e000-000000000064", ITc Set External Time) struct __declspec(novtable) ITc Set External Time : public ITc External Time Methods Name Description Register External Time Provider [} 21] Registering a provider for an offset related to Time Type Unregister External Time Provider [} 21] Logging off a provider for an offset related to Time Type Set External Time Offset [} 21] Provide a new offset for the registered Time Type 20 Version: 1.4 Twin CAT 3

## Page 21

Real-time API Comments This interface is not available for the PLC. 6.2.1.1 Register External Time Provider method Registering a provider for an offset related to Time Type Syntax HRESULT TCOMAPI Register External Time Provider(OTCID oid Provider, Time Type type) = 0; Parameter oid Provider: (type: OTCID) The object ID of the provider; normally the object ID of the calling party type: (type: Time Type [} 20]) The Time Offset type to be registered. Return value Type: HRESULT Notifies the success of registration Description 6.2.1.2 Unregister External Time Provider method Logging off a provider for an offset related to Time Type Syntax HRESULT TCOMAPI Unregister External Time Provider(OTCID oid Provider, Time Type type) = 0; Parameter oid Provider: (type: OTCID) The object ID of the provider; normally the object ID of the calling party type: (type: Time Type [} 20]) The Time Offset type to be logged off. Return value Type: HRESULT Notifies the success of the deregistration Description 6.2.1.3 Set External Time Offset method Provide a new offset for the registered Time Type Syntax HRESULT TCOMAPI Set External Time Offset(OTCID oid Provider, Time Type type, __int64 offset) = 0; Parameter oid Provider: (type: OTCID) The object ID of the provider; normally the object ID of the calling party Twin CAT 3 Version: 1.4 21

## Page 22

Real-time API type: (type: Time Type [} 20]) The Time Offset type offset: (type: __int64) The new offset value. Return value Type: HRESULT Notifies the success. Description It is valid for the offset External Time = Internal Time + Offset. I.e. if the time in Twin CAT is in the past, the offset must be greater than 0. 6.2.2 ITc External Time interface The ITc External Time interface is implemented by the Tc COM object server. This can be used to retrieve and use an externally determined offset. Syntax TCOM_DECL_INTERFACE("00000066-0000-0000-e000-000000000064", ITc External Time) struct __declspec(novtable) ITc External Time : public ITc Unknown Methods Name Description System Time To External Time [} 22] Calculation of a corrected timestamp in relation to the system time External Time To System Time [} 23] Calculation of the system time in relation to a corrected timestamp Get External Time Offset [} 23] Retrieving an offset in relation to the Time Type Get External Time Provider [} 23] Queries the Object ID of the current provider 6.2.2.1 System Time To External Time method Calculation of a corrected timestamp in relation to the system time Syntax HRESULT TCOMAPI System Time To External Time(Time Type type, __int64& time) = 0; Parameter type: (type: Time Type [} 20]) The Time Offset type to be used for the calculation time: (type: __int64&) The timestamp to be corrected by offset Return value Type: HRESULT Notifies the success. 22 Version: 1.4 Twin CAT 3

## Page 23

Real-time API Description 6.2.2.2 External Time To System Time method Calculation of the system time in relation to a corrected timestamp Syntax HRESULT TCOMAPI External Time To System Time(Time Type type, __int64& time) = 0; Parameter Type: (type: Time Type [} 20]) The Time Offset type to be used for the calculation time: (type: __int64&) The corrected timestamp, adjusted by the offset. Return value Type: HRESULT Notifies the success. Description The offset valid at the time of the call is used to determine the local system time. 6.2.2.3 Get External Time Offset method Retrieving an offset in relation to the Time Type Syntax HRESULT TCOMAPI Get External Time Offset(Time Type type, __int64& offset) = 0; Parameter type: (type: Time Type [} 20]) The Time Offset type to be retrieved offset: (type: __int64&) The value set to the offset. Return value Type: HRESULT Notifies the success. Description 6.2.2.4 Get External Time Provider method Queries the Object ID of the current provider Syntax HRESULT TCOMAPI Get External Time Provider(Time Type type, OTCID& oid Provider) = 0; Parameter type: (type: Time Type [} 20]) The Time Offset type whose provider is to be queried. Twin CAT 3 Version: 1.4 23

## Page 24

Real-time API oid Provider: (type: OTCID&) The Object ID that is set to the Object ID of the provider. Return value Type: HRESULT Notifies the success. Description 24 Version: 1.4 Twin CAT 3

## Page 25

ADS API 7 ADS API The Time Offsets can also be queried via ADS. There are two ways to do this 1. ADS Notification: ADS notifications contain a time stamp that contains the time at which the data was changed. An ADS client sends an ADS command before the Add Device Notification. This causes the target sys- tem to register which type of corrected time stamp is required from this ADS client. 2. ADS Read: A corrected time stamp can be read out via ADS Read. This can be used to obtain a cor- rected time stamp in an ADS Sum command at the time when the ADS commands were executed. Index group Index offset Access Data type Description Note ADSIGRP_EXT ERNALTIME 0x F088 ADSIOFFS_EX R LONG Read the currently configured offset The return TERNALTIME_ type for the respective ADS client value is type 0 SET (Ams Net Addr incl. client port). = None, 1 = Hard, 2 = Medium, 3 = 0x0000 Soft ADSIOFFS_EX W Set the offset type for the __ is type 0 = TERNALTIME_ ADSDevice notifications of the None, 1 = SET respective ADS client (Ams Net Addr Hard, 2 = incl. client port). Medium, 3 = Soft 0x00__ ADSIOFFS_EX R LONGLON Reading the current offset for a type. __ is type: TERNALTIME_ G 0 = None, 1 = OFFSET Hard, 2 = Medium, 3 = 0x01__ Soft ADSIOFFS_EX W LONGLON Setting the current offset for a type. __ is type: TERNALTIME_ G 0 = None, 1 = OFFSET Hard, 2 = Medium, 3 = 0x01__ Soft ADSIOFFS_EX R LONGLON Reading the corrected time stamp. __ is type: TERNALTIME_ G 0 = None, 1 = ABSOLUTE Hard, 2 = Medium, 3 = 0x02__ Soft ADSIOFFS_EX R ULONG Reading the object ID from the __ is type: TERNALTIME_ Time Offset provider. 0 = None, 1 = PROVIDER Hard, 2 = Medium, 3 = 0x03__ Soft ADSIOFFS_EX R LONG Reads the type that is used if no The return TERNALTIME_ other type is set. value is type 0 SETALL = None, 1 = 0x0400 Hard, 2 = Medium, 3 = Soft ADSIOFFS_EX W Sets the type that is used if no other __ is type 0 = TERNALTIME_ type is set. None, 1 = SETALL Hard, 2 = Medium, 3 = 0x04__ Soft The Defines can be found in the file "Ads.h". Twin CAT 3 Version: 1.4 25

## Page 26

ADS API The ADS consumer sample [} 27] illustrates the application. 26 Version: 1.4 Twin CAT 3

## Page 27

Samples 8 Samples Various samples illustrating the use of the corrected timestamps are provided for the benefit of the user: • PLC Consumer [} 27]: A PLC program accesses corrected timestamps. • C++ Consumer [} 28]: A C++ Tc COM module accesses corrected timestamps. • ADS Consumer [} 27]: An ADS client in user mode accesses the corrected timestamps. • C++ Provider [} 28]: A C++ Tc COM module determines an offset and provides it. The corrected timestamps are also used by other components of the Twin CAT system. A required configuration can be found with the respective components. 8.1 ADS consumer The ADS Consumer sample retrieves corrected timestamps as described in the ADS API [} 25]. Download Here you can access the https://infosys.beckhoff.com/content/1033/tc3_Korrigierte-Zeitstempel /Resources/ zip/7705550603.zip for this sample. ü Start the Twin CAT target system with which the ADS Consumer sample is to communicate. The PLC Consumer [} 27] sample can be used. 1. Unpack the downloaded ZIP file. 2. Open the included vcxproj file in Visual Studio. 3. Adjust the target Ams Net ID. (Tc External Time Ads Client.cpp, line 119) ð The sample is ready for operation. Description The sample code can be found in the CPP file Tc External Time Ads Client.cpp Different Use Cases for receiving corrected timestamps are illustrated in the Main() method: • Reading of the provider, the offset and the corrected timestamp from the system service for the different offsets: uncorrected(0), soft(1), medium(2), hard(3), plus an invalid value (4) to illustrate the error behavior. • Reading the corrected timestamps from a PLC program for the different offsets. • Reading the provider used and all providers. • Subscribing to a variable in the PLC; the time provided via notification has a corrected timestamp. The output takes place in the Ads Notification Callback() method. 8.2 PLC Consumer The PLC Consumer sample retrieves a corrected timestamp from the Twin CAT system and uses it. Download Here you can access the https://infosys.beckhoff.com/content/1033/tc3_Korrigierte-Zeitstempel /Resources/ zip/7705583115.zip for this sample. 1. Open the tszip file that it contains in Twin CAT 3 by clicking on Open Project …. 2. Select your target system. 3. Build the sample on your local machine (e.g. Build->Build Solution). Twin CAT 3 Version: 1.4 27

## Page 28

Samples 4. Activate the configuration by clicking on . ð The sample is ready for operation. Description The Tc Ntp External Time Provider is configured under System > Tc COMObjects. Here you can parameterize your own NTP server under Parameter (Init), if the default pool.ntp.org cannot be reached. The PLC program essentially consists of the function block FB_Tc External Time. It provides functions for reading a corrected timestamp from the Twin CAT system. The variable _e Time Type represents the type (soft, medium, hard) and can be parameterized. In MAIN, this function block is used for the e Time Type "Soft" to ensure that the corrected time set by NTP is used. 8.3 C++ consumer The C++ Consumer sample retrieves a corrected timestamp from the Twin CAT system and uses it. Download Here you can access the https://infosys.beckhoff.com/content/1033/tc3_Korrigierte-Zeitstempel / Resources/zip/7705552907.zip for this sample. 1. Open the zip file that it contains in Twin CAT 3 by clicking on Open Project …. 2. Select your target system. 3. Build the sample on your local machine (e.g. Build->Build Solution). 4. Activate the configuration by clicking on . ð The sample is ready for operation. Description The Tc Ntp External Time Provider is configured under System > Tc COMObjects. Here you can parameterize your own NTP server under Parameter (Init), if the default pool.ntp.org cannot be reached. The C++ module cyclically determines a local timestamp in the Cycle Update() method and corrects it. It can be traced in the respective steps using the debugger. The corrected timestamp is provided as a parameter (online). The type required for this can be configured as parameter "Time Type" in the Tc COM object. 8.4 C++ provider The C++ provider sample determines an offset and stores it in the Twin CAT system so that it can be used by the consumers. Download Here you can access the https://infosys.beckhoff.com/content/1033/tc3_Korrigierte-Zeitstempel /Resources/ zip/7705555211.zip for this sample. 1. Unpack the downloaded .zip file. 2. Open the .zip file that it contains in Twin CAT 3 by clicking on Open Project …. 3. Select your target system. 28 Version: 1.4 Twin CAT 3

## Page 29

Samples 4. Build the sample on your local machine (e.g. Build->Build Solution). 5. Activate the configuration by clicking on . ð The sample is ready for operation. Description The offset provider receives the offset to be provided as Data Area "External Time.n Offset“. This is transferred to the Twin CAT system as a Time Type medium, which can also be configured at runtime under Parameter (Init). In the Cycle Update() method, the Set External Time Offset method is used for this after a corresponding register has been created using Register External Time Provider for a Time Type. Twin CAT 3 Version: 1.4 29

## Page 30

Appendix 9 Appendix 9.1 FAQ 9.1.1 Windows as NTP client Windows itself offers an NTP client for the system time. In addition, an NTP time can be retrieved using the following script, which is useful for debugging purposes: @echo off set /p Server=Server: w32tm /stripchart /computer:%Server% /packetinfo /samples:10 pause 9.1.2 Windows as NTP server Windows itself offers an NTP server to provide timestamps. Please note that only one component can use the port for NTP (udp/123). This means that either the Twin CAT NTP server functionality [} 12] or the Windows NTP server can be used. The Windows NTP server is disabled by default and can be activated later: ü Windows 7 / 10 1. The registry key is set: HKLM\System\Current Control Set\Services\W32Time\Time Providers\Ntp Server Enabled = 1 2. The Windows Time system service is started and set to Autostart, if appropriate. 30 Version: 1.4 Twin CAT 3

## Page 31

Appendix Twin CAT 3 Version: 1.4 31

## Page 33

Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
