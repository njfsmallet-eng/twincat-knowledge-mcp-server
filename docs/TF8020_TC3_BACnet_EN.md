---
title: "TF8020 Twin CAT 3"
product: "TF8020"
category: "Building_Automation"
tags: ["CAT", "TWIN"]
language: "EN"
document_type: "Manual"
version: "1.1.2"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF8020_TC3_BACnet_EN.pdf"
release_date: "2023-11-07"
---
Manual | EN TF8020 Twin CAT 3 | BACnet 2023-11-07 | Version: 1.1.2
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 9 1.1 Notes on the documentation............................................................................................................. 9 1.2 For your safety.................................................................................................................................. 9 1.3 Notes on information security.......................................................................................................... 11 2 Introduction............................................................................................................................................. 12 2.1 Overview......................................................................................................................................... 13 2.2 System Requirements..................................................................................................................... 13 3 Overview about BACnet properties....................................................................................................... 14 3.1 Input, Output, Value object types.................................................................................................... 14 3.2 Most commonly used BACnet properties........................................................................................ 14 3.2.1 Object_Identifier............................................................................................................... 14 3.2.2 Object_Name................................................................................................................... 15 3.2.3 Object_Type..................................................................................................................... 16 3.2.4 Present_Value.................................................................................................................. 16 3.2.5 Description....................................................................................................................... 16 3.2.6 Device_Type.................................................................................................................... 16 3.2.7 Status_Flags.................................................................................................................... 16 3.2.8 Event_State...................................................................................................................... 16 3.2.9 Reliability.......................................................................................................................... 16 3.2.10 Out_of_Service................................................................................................................ 17 3.2.11 Update_Interval................................................................................................................ 17 3.2.12 Units................................................................................................................................. 17 3.2.13 Min_Pres_Value............................................................................................................... 17 3.2.14 Max_Pres_Value.............................................................................................................. 17 3.2.15 Resolution........................................................................................................................ 17 3.2.16 COV_Increment............................................................................................................... 17 3.2.17 Time_Delay...................................................................................................................... 17 3.2.18 Notification_Class............................................................................................................ 17 3.2.19 High_Limit........................................................................................................................ 17 3.2.20 Low_Limit......................................................................................................................... 18 3.2.21 Deadband......................................................................................................................... 18 3.2.22 Limit_Enable.................................................................................................................... 18 3.2.23 Event_Enable................................................................................................................... 18 3.2.24 Acked_Transitions............................................................................................................ 18 3.2.25 Notify_Type...................................................................................................................... 18 3.2.26 Event_Time_Stamps........................................................................................................ 18 3.2.27 Event_Message_Texts..................................................................................................... 18 3.2.28 Profile_Name................................................................................................................... 19 3.2.29 Event_Message_Texts_Config........................................................................................ 19 3.2.30 Event_Detection_Enable.................................................................................................. 19 3.2.31 Event_Algorithm_Inhibit_Ref............................................................................................ 19 3.2.32 Event_Algorithm_Inhibit................................................................................................... 19 3.2.33 Time Delay_Normal.......................................................................................................... 19 3.2.34 Reliability_Evaluation_Inhibit........................................................................................... 19 TF8020 Version: 1.1.2 3
## Page 4

Table of contents 3.2.35 Property_List.................................................................................................................... 19 3.2.36 Priority_Array................................................................................................................... 19 3.2.37 Relinquish_Default........................................................................................................... 19 3.2.38 Inactive_Text.................................................................................................................... 20 3.2.39 Active_Text...................................................................................................................... 20 3.2.40 Change_Of_State_Time.................................................................................................. 20 3.2.41 Change_Of_State_Count................................................................................................. 20 3.2.42 Time_Of_State_Count_Reset.......................................................................................... 20 3.2.43 Elapsed_Active_Time...................................................................................................... 20 3.2.44 Time_Of_Active_Time_Reset.......................................................................................... 20 3.2.45 Alarm_Value..................................................................................................................... 20 3.2.46 Minimum_Off_Time.......................................................................................................... 20 3.2.47 Minimum_On_Time.......................................................................................................... 20 3.2.48 Feedback_Value.............................................................................................................. 20 3.2.49 Number_Of_States.......................................................................................................... 21 3.2.50 State_Text........................................................................................................................ 21 3.2.51 Alarm_Values................................................................................................................... 21 3.2.52 Fault_Values.................................................................................................................... 21 3.2.53 Date_List.......................................................................................................................... 21 3.2.54 Weekly_Schedule............................................................................................................ 21 3.2.55 Exception_Schedule........................................................................................................ 21 3.3 Understanding the PICS document................................................................................................. 21 4 Quickstart................................................................................................................................................ 23 4.1 Creating the Twin CAT project......................................................................................................... 23 4.1.1 Selecting the target system.............................................................................................. 24 4.1.2 Create a BACnet Adapter and Server.............................................................................. 29 4.1.3 IP address settings........................................................................................................... 31 4.1.4 Adjusting the BACnet Server settings.............................................................................. 33 4.1.5 Persistence...................................................................................................................... 34 4.2 Creating the BACnet PLC project................................................................................................... 34 4.2.1 Creating the PLC project.................................................................................................. 34 4.2.2 Testing the BACnet server............................................................................................... 42 4.2.3 Testing BACnet using the System Manager.................................................................... 43 4.2.4 Testing BACnet using a BACnet Explorer........................................................................ 45 5 PLC library: Tc3_BACnet Rev14............................................................................................................. 50 5.1 DUTs............................................................................................................................................... 50 5.1.1 Enumerations................................................................................................................... 50 5.1.2 Interfaces......................................................................................................................... 50 5.1.3 Types............................................................................................................................... 50 5.2 GVLs............................................................................................................................................... 50 5.2.1 Version............................................................................................................................. 50 5.2.2 BACnet_Globals............................................................................................................... 51 5.2.3 BACnet_Param................................................................................................................ 51 5.3 POUs............................................................................................................................................... 52 5.3.1 Naming conventions......................................................................................................... 52 4 Version: 1.1.2 TF8020
## Page 5

Table of contents 5.3.2 FB_BACnet_Adapter........................................................................................................ 53 6 Programming a BACnet server.............................................................................................................. 59 6.1 BACnet object POUs....................................................................................................................... 59 6.1.1 Function blocks without a suffix....................................................................................... 60 6.1.2 Primitive Value object types............................................................................................. 61 6.2 Typical BACnet scenarios............................................................................................................... 62 6.2.1 Command prioritization.................................................................................................... 62 6.2.2 Event reporting................................................................................................................. 63 6.2.3 Scheduling....................................................................................................................... 63 6.2.4 Trend-Logging.................................................................................................................. 64 6.2.5 Event-Logging.................................................................................................................. 64 6.2.6 Control Loops................................................................................................................... 64 6.2.7 Time Synchronization........................................................................................................ 65 6.2.8 Retrieving diagnosis information...................................................................................... 65 6.2.9 Scanning other BACnet devices...................................................................................... 66 6.2.10 Creating a structured view (DPAD).................................................................................. 66 6.2.11 Linking hardware using attributes.................................................................................... 69 6.3 Important notes using the library..................................................................................................... 69 6.3.1 Declaring properties at start-up........................................................................................ 69 6.4 Parameter dialogs........................................................................................................................... 71 6.4.1 Always call BACnet function blocks cyclically.................................................................. 71 6.4.2 Call BACnet function blocks using the same cycle time.................................................. 72 6.5 Calculating the router memory........................................................................................................ 72 6.5.1 Example calculation of required router memory............................................................... 72 6.6 Specific Functionality...................................................................................................................... 73 6.6.1 Generating an EDE file.................................................................................................... 73 6.6.2 Cycle time exceed counter............................................................................................... 74 6.6.3 Enable / Disable Properties.............................................................................................. 74 6.6.4 Writeprotect Properties.................................................................................................... 74 6.6.5 Enabling write access from the PLC................................................................................ 75 6.6.6 Adding a recipient to a recipient list................................................................................. 75 6.6.7 Using UTF-8 characters................................................................................................... 75 6.7 FB_BACnet_Server......................................................................................................................... 76 6.8 FB_BACnet_Device........................................................................................................................ 76 6.9 IO Code........................................................................................................................................... 76 6.10 Recommended workflow / BACnet persistence.............................................................................. 77 6.11 Persistence..................................................................................................................................... 78 6.12 Time synchronization...................................................................................................................... 82 6.13 Recommended cycle time of the PLC task..................................................................................... 84 7 Programming a BACnet client............................................................................................................... 85 7.1 Writemode....................................................................................................................................... 85 7.2 Readmode....................................................................................................................................... 85 7.2.1 Automatic mode............................................................................................................... 85 7.2.2 Applying the Readmode to the entire peer device........................................................... 86 7.2.3 Applying the Readmode to single objects........................................................................ 86 TF8020 Version: 1.1.2 5
## Page 6

Table of contents 7.2.4 COV-Reporting................................................................................................................. 87 7.3 Client POUs.................................................................................................................................... 87 7.4 FB Code.......................................................................................................................................... 89 7.5 Calling the function FB Code.......................................................................................................... 89 7.5.1 Calling FB Code from the Scan dialog............................................................................. 89 7.5.2 Calling FB Code from the Cyclic Data dialog................................................................... 90 7.6 The client FB Code dialog............................................................................................................... 90 7.6.1 The Select Objects window.............................................................................................. 91 7.6.2 Supported Services.......................................................................................................... 91 7.6.3 Service Settings............................................................................................................... 92 7.6.4 The Settings window........................................................................................................ 93 7.6.5 The FB Code window....................................................................................................... 93 7.6.6 Using the FB created by FB_Code.................................................................................. 94 7.6.7 Using FB_Code to create device templates..................................................................... 95 7.7 Client variables................................................................................................................................ 95 7.8 Remote schedule objects................................................................................................................ 96 7.9 Acyclic read..................................................................................................................................... 96 7.9.1 Example FB_BACnet RM_Read Property......................................................................... 96 7.9.2 Example FB_BACnet RM_Read Property Ex..................................................................... 97 7.10 Acyclic write..................................................................................................................................... 97 7.10.1 Example FB_BACnet RM_Write Property.......................................................................... 97 7.10.2 Example FB_BACnet RM_Write Property Ex..................................................................... 98 7.11 Monitoring a client connection......................................................................................................... 98 7.11.1 Example: Connection is successfully established............................................................ 99 7.11.2 Example: Connection is interrupted............................................................................... 100 7.12 Use of Read Property Multiple........................................................................................................ 101 8 Dynamic Object Manager..................................................................................................................... 102 8.1 FB_BACnet_Dyn Object Manager.................................................................................................. 102 8.2 Cyclic calls..................................................................................................................................... 102 8.3 Predefined object pool.................................................................................................................. 102 8.4 Example........................................................................................................................................ 103 8.5 Complete initialization of the dynamic objects.............................................................................. 104 8.6 Creating and deleting own BACnet function blocks (FB).............................................................. 104 9 Samples................................................................................................................................................. 106 9.1 Variable Declaration...................................................................................................................... 106 9.2 BACnet properties......................................................................................................................... 106 9.3 Link with the 'Tc Link To' attribute................................................................................................... 107 9.4 Property selection and write protection......................................................................................... 108 9.5 Priority controller........................................................................................................................... 108 9.6 Reset priorities.............................................................................................................................. 110 9.7 Control loops and loop objects...................................................................................................... 110 9.8 Set up alarm receiver.................................................................................................................... 111 9.9 Receiving alarms and events from other devices......................................................................... 112 9.10 Prewarning limits........................................................................................................................... 113 9.11 Calendar and schedule functions.................................................................................................. 114 6 Version: 1.1.2 TF8020
## Page 7

Table of contents 9.12 Logging objects............................................................................................................................. 116 9.13 Processing of the log memory in the PLC..................................................................................... 118 9.14 Primitive Value Objects................................................................................................................. 119 9.15 Structured View objects................................................................................................................ 120 9.16 Array initialization.......................................................................................................................... 122 10 Support and Service............................................................................................................................. 124 TF8020 Version: 1.1.2 7
## Page 8

Table of contents 8 Version: 1.1.2 TF8020
## Page 9

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. For installation and commissioning of the components, it is absolutely necessary to observe the documentation and the following notes and explanations. The qualified personnel is obliged to always use the currently valid documentation. The responsible staff must ensure that the application or use of the products described satisfies all requirements for safety, including all the relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been prepared with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. No claims to modify products that have already been supplied may be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of designations or trademarks used in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Patents The Ether CAT Technology is covered, including but not limited to the following patent applications and patents: EP1590927, EP1789857, EP1456722, EP2137893, DE102015105702 and similar applications and registrations in several other countries. Ether CAT® is registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document as well as the use and communication of its contents without express authorization are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. TF8020 Version: 1.1.2 9
## Page 10

Foreword Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 10 Version: 1.1.2 TF8020
## Page 11

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. TF8020 Version: 1.1.2 11
## Page 12

Introduction 2 Introduction The newly developed Twin CAT library Tc3_BACnet Rev14 implements a fully object-oriented engineering and configuration process to provide a convenient project planning of Beckhoff BACnet controllers. Using the library does not require any OOP (Object-Oriented Programming) skills. However, for advanced users, this architecture offers flexible extendable options. So far, using the older library Tc2_BACnet Rev12, the connection between the PLC variables and the BACnet supplement was established using the automapping process. The BACnet function blocks were complemented by comments describing the object properties which were parsed by the map or remap function in the System Manager. This process is still available in Twin CAT 4024 and can be used by adding the library Tc2_Bacnet Rev12. Please note that this function may no longer be supported in future Twin CAT versions! Using both libraries Tc3_BACnet Rev14 and Tc2_BACnet Rev12 within one project is not supported. BACnet® is a registered trademark of ASHRAE. 12 Version: 1.1.2 TF8020
## Page 13

Introduction 2.1 Overview The components are provided by two libraries: Tc3_BACnet Rev14: This library provides function blocks, data types, global variables and parameters required for the engineering of BACnet objects. This library is provided with the Twin CAT installation (4024.11 or higher) as compiled library (without source-code). The uncompiled source-code is provided upon request ( e-mail: buildingautomation@beckhoff.com). Please note, loading uncompiled libraries takes some time (the library is marked with a clock symbol in this case). Wait until the clock symbols disappears before using the library. Tc3_BA2_Common: This library contains all function blocks, data types, global variables and parameters commonly used by BACnet and Twin CAT 3 Building Automation (Tc3BA). E. g. engineering units and a PID controller are available in this library. Please add this library in addition to Tc3_BACnet_Rev14 if you want to use these options. Some function blocks may require additional libraries: Tc2_Utilities: Contains general helper functions, e. g. to access the operating system, create csv files or to convert and format data (like UTF-8 character set support). Tc2_SUPS: Contains functions to use an uninterruptable power supply (UPS). 2.2 System Requirements Target System: Twin CAT XAR 4024.17 or higher Engineering-PC: Twin CAT XAE 4024.17 or higher. TF8020 Version: 1.1.2 13
## Page 14

Overview about BACnet properties 3 Overview about BACnet properties BACnet objects are composed using properties which are either specified in the BACnet standard or may be proprietary. Some properties are required, where others may be optional. A few properties are required to be writable, others may be made writable if needed. The conformance code in the PICS document describes which properties belong to which group: R = required O = optional W = writable The column "CC" describes the requirements by the BACnet standard. "WA" describes the write access options in Twin CAT. The following table shows an example object (analog input, not all properties are shown) from the PICS document (the document can be downloaded here: www.beckhoff.com/bacnet). Analog Input Property Data Type CC WA Object_Identifier BACnet Object Identifier R R Object_Name Character String R W Object_Type BACnet Object Type R R Present_Value REAL R R Description Character String O W Device_Type Character String O W Status_Flags BACnet Status Flags R R Event_State BACnet Event State R R Reliability BACnet Reliability O R 3.1 Input, Output, Value object types Analog, Binary and Multistate objects are the most commonly used objects. Analog objects represent a floating point (REAL) information, Binary objects a digital (inactive / active) information and Multistate objects a set of multiple states. Input object types are typically used to represent a physical hardware input connected to the device, e. g. a temperature or brightness sensor. Output object types typically represent physical outputs like a 0-10V output or a percentage of a valve actuator. Value object types are used to represent virtual information like a setpoint or a control parameter. 3.2 Most commonly used BACnet properties This chapter explains the meaning of the most commonly used BACnet object properties. For a complete list of objects supported by Twin CAT, the supported properties of these objects and the implemented conformance code refer to the PICS document. 3.2.1 Object_Identifier This property consists of two elements, a 10-bit Object_Type and a 22-bit Object_Instance. The Object_Type is defined in the BACnet standard: Analog Input :=0 Analog Output :=1 Analog Value :=2 14 Version: 1.1.2 TF8020
## Page 15

Overview about BACnet properties Binary Input :=3 Binary Output :=4 Binary Value :=5 Calendar :=6 Command :=7 Device :=8 Event Enrollment :=9 File :=10 Group :=11 Loop :=12 Multi State Input :=13 Multi State Output :=14 Notification Class :=15 Program :=16 Schedule :=17 Averaging :=18 Multi State Value :=19 Trend Log :=20 Life Safety Point :=21 Life Safety Zone :=22 Accumulator :=23 Pulse Converter :=24 Event Log := 25 Global Group := 26 Trend Log Multiple := 27 Load Control := 28 Structured View := 29 Access Door := 30 unassigend31 := 31 Access Credential := 32 Access Point := 33 Access Rights := 34 Access User := 35 Access Zone := 36 Credential Data Input := 37 Network Security := 38 Bit String Value := 39 Character String Value := 40 Date Pattern Value := 41 Date Value := 42 Date Time Pattern Value := 43 Date Time Value := 44 Integer Value := 45 Large Analog Value := 46 Octet String Value := 47 Positive Integer Value := 48 Time Pattern Value := 49 Time Value := 50 Network Port := 51 Alert Enrollment := 52 Channel := 53 The Object_Instance is specified when the object is created and must be unique per object type. In the Twin CAT 3 library Tc3_BACnet Rev14 the instance numbers start at 10000 by default. The highest 22-bit value = 4194303 cannot be assigned to object instances. This value is reserved by the BACnet standard as a wildcard in case the actual object instance number is not known. In the case of the Device_Objects, the Object_Instance must be unique within the entire BACnet internetwork (across all BACnet data link layers). 3.2.2 Object_Name This property contains the name of the object. In many cases this property contains the Data Point Addressing Description (DPAD), i.e. it is a project or customer-specific naming convention for data points. The Object_Name must contain at least one printable character that must be unique within the device. In the case of the Object_Name of the device object, this property must be unique within the entire BACnet internetwork (across all BACnet data link layers). The default character set in Twin CAT is UTF-8. The maximum length of this string in Twin CAT is 255. TF8020 Version: 1.1.2 15
## Page 16

Overview about BACnet properties 3.2.3 Object_Type This property represents the 10 bit type information of the BACnet Object Identifier. If this property is requested, the response only contains the object type. If the property Object Identifier is requested, the 32 bit Identifier (10 bit type and 22 bit instance number) is returned in the response. 3.2.4 Present_Value This property is very likely the most important property. It represents the current process value of the object. The data-type of this property is: Analog objects: REAL (32-bit single accuracy floating point number according to ANSI-IEEE 754) Binary objects: ENUMERATED 0=inactive, 1=active * Multistate objects: UNSIGNED INT * Please note that the library uses a BOOL data type and provides automatic conversion to the BACnet enumeration. 3.2.5 Description This optional property may contain an additional text information describing the object. The default character set is UTF-8. The maximum length in Twin CAT is 255 characters. 3.2.6 Device_Type (Available in input and output object types) This optional text property may be used to specify the hardware type, e. g. a PT1000 sensor. It may contain other information like the order number or similar information about the hardware connected. The default character set is UTF-8. The maximum length in Twin CAT is 255 characters. 3.2.7 Status_Flags This property represents four boolean status flags: IN_ALARM: in case of an active alarm, this flag is set to TRUE. FAULT: if the Reliability property is not equal to NO_FAULT_DETECTED, this flag is set to TRUE. Error states include defect sensors, links, etc. OVERRIDDEN: If the Present_Value property of the object is overridden locally by the application, this flag is set to TRUE. The values of the properties Present_Value and Reliability are no longer taken from the hardware. The definition of the overwritten state is done locally by the application. OUT_OF_SERVICE: this value indicates the state of the property Out_of_Service. 3.2.8 Event_State This property represents the event state in case of an active alarm, e.g. LOW_LIMIT. In the normal state or in the absence of an alarm associated with the object, the value must be NORMAL. 3.2.9 Reliability This property indicates whether the value of the property Present_Value is reliable (NO_FAULT_DETECTED) and if not, why is not (e.g. short circuit, missing sensor, etc.). 16 Version: 1.1.2 TF8020
## Page 17

Overview about BACnet properties 3.2.10 Out_of_Service This Boolean property indicates whether the object is in service or not. In the case of Out_of_Service = TRUE, Present_Value is no longer tracked by hardware and Present_Value becomes writable, even for input object types. This allows to set a value in case of defective hardware. 3.2.11 Update_Interval This optional property specifies the maximum time in hundredths of a second between updates of the Present_Value if the input is not out of service and not overwritten. 3.2.12 Units This property specifies the technical unit of the object. As these units are used for BACnet and for general building automation purposes, the listed values can be retrieved from the library Tc3_BA2_Common. The list can be found in the section DUTs/Enumerations/Units/E_BA_Unit. 3.2.13 Min_Pres_Value This property specifies the lowest value in technical units that can be reliably determined for the Present_Value property of the object. Currently not available in Analog Value objects. 3.2.14 Max_Pres_Value This property specifies the highest value in technical units that can be reliably determined for the Present_Value property of the object. Currently not available in Analog Value objects. 3.2.15 Resolution This property specifies the lowest detectable change in the Present_Value property in technical units. 3.2.16 COV_Increment This property specifies the hysteresis for Change-of-Value notifications. If the new value of the Present_Value property exceeds the old value by COV_Increment, the recipients subscribed to this object are informed about the value change. Please note: a COV_Increment of zero means that every (even small) change is reported, which can lead to a message flood in the network! 3.2.17 Time_Delay This property specifies the minimum amount of time in seconds that Present_Value must be outside the range defined by the High_Limit and Low_Limit properties before a TO-OFFNORMAL event is generated, or within the same range, including the Deadband property, before a TO-NORMAL event is generated. 3.2.18 Notification_Class This property specifies the instance number of the Notification Class object for the event-notification- distribution. 3.2.19 High_Limit This property specifies the limit value that Present_Value must exceed before an event is generated. TF8020 Version: 1.1.2 17
## Page 18

Overview about BACnet properties 3.2.20 Low_Limit This property specifies the limit value below which Present_Value must fall before an event is generated. 3.2.21 Deadband This property specifies a range between the High_Limit and Low_Limit properties in which Present_Value must lie for a TO-NORMAL event to be generated. The following conditions apply to the event generation: • Present_Value must be below the High_Limit minus deadband and • Present_Value must exceed the Low_Limit plus deadband and • Present_Value must remain within this range for a minimum period specified in the Time_Delay property, and • either the High Limit Enable or the Low Limit Enable flag must be set in the Limit_Enable property, and • the TO-NORMAL flag must be set in the Event_Enable property. 3.2.22 Limit_Enable This property specifies two flags that enable and disable compliance with the upper alarm limit and lower alarm limit separately. Please note: up to BACnet revision 12 there was an error in the description of the Property Description in the BACnet standard. Only event reporting was enabled / disabled up to version 12. As of revision 13, this specification was changed in the BACnet standard. Now, observation of these properties is enabled / disabled. 3.2.23 Event_Enable This property specifies three flags that separately enable and disable the reporting of TO-OFFNORMAL, TO- FAULT and TO-NORMAL events. 3.2.24 Acked_Transitions This property specifies three flags that indicate the receipt of acknowledgements for the TO-OFFNORMAL, TO-FAULT and TO-NORMAL events separately. 3.2.25 Notify_Type This property specifies whether the notifications generated by the object should be Events or Alarms. 3.2.26 Event_Time_Stamps This property specifies the times of the last event notifications for the TO-OFFNORMAL, TO-FAULT and TO- NORMAL events, respectively. Please note: the property value can be a choice of Date Time (mostly used), Time (rarely used) or Sequence Number (if the device does not support a clock). 3.2.27 Event_Message_Texts This property specifies the message text of the last event notifications for the TO-OFFNORMAL, TO-FAULT and TO-NORMAL events, respectively. 18 Version: 1.1.2 TF8020
## Page 19

Overview about BACnet properties 3.2.28 Profile_Name This property is the name of an object profile to which this object conforms. To ensure uniqueness, a profile name must begin with a vendor identifier code (415 for Beckhoff Automation) in base-10 integer format, followed by a dash. 3.2.29 Event_Message_Texts_Config This property contains the strings that form the basis of the "Message Text" parameter for the event notifications of the TO_OFFNORMAL, TO_FAULT and TO_NORMAL events. 3.2.30 Event_Detection_Enable This property indicates whether or not intrinsic reporting is enabled in the object and controls whether or not the object will be considered by event summarization services. 3.2.31 Event_Algorithm_Inhibit_Ref This reference specifies the property that controls the value of the Event_Algorithm_Inhibit property. 3.2.32 Event_Algorithm_Inhibit This property indicates whether or not the event algorithm has been disabled for the object. 3.2.33 Time Delay_Normal This property specifies the minimum time in seconds that Present_Value must remain within the range defined by the properties High_Limit and Low_Limit, including the Deadband property, before a TO- NORMAL event is generated. Please note: up to BACnet revision 12, only Time_Delay was available in the BACnet standard for the two transitions TO_OFFNORMAL and TO_NORMAL. From revision 13, this optional Time Delay_Normal property is used to specify a separate hysteresis for TO_NORMAL events. 3.2.34 Reliability_Evaluation_Inhibit This property indicates whether or not reliability-evaluation is disabled in the object. 3.2.35 Property_List This property is a BACnet ARRAY of property identifiers. A property identifier for each property that exists within the object. 3.2.36 Priority_Array This property is a read-only array of prioritized values. See chapter Command prioritization [} 62]. 3.2.37 Relinquish_Default This property is the default value used for the Present_Value property when all command priority values in the Priority_Array property have the value NULL. See chapter Command prioritization [} 62]. TF8020 Version: 1.1.2 19
## Page 20

Overview about BACnet properties 3.2.38 Inactive_Text (Binary objects) This property represents a human-readable description of the INAKTIV state. For example, if the binary object represents a switch, the inactive state can be represented as AUS. 3.2.39 Active_Text (Binary objects) This property represents a human-readable description of the AKTIV state. For example, if the Binary object represents a switch, the active state may be represented as ON. 3.2.40 Change_Of_State_Time (Binary objects) This property represents the date and time at which the most recent change of state occurred. 3.2.41 Change_Of_State_Count (Binary objects) This property indicates how often the state of property Present_Value has changed since property Change_Of_State_Count was last set to a null value. 3.2.42 Time_Of_State_Count_Reset (Binary objects) This property represents the date and time when the Change_Of_State_Count property was last set to a null value. 3.2.43 Elapsed_Active_Time (Binary objects) This property represents the cumulative number of seconds Present_Value has had the value ACTIVE since the Elapsed_Active_Time property was last set to a null value. 3.2.44 Time_Of_Active_Time_Reset (Binary objects) This property represents the date and time when the Elapsed_Active_Time property was last set to a null value. 3.2.45 Alarm_Value (Binary objects) This property indicates the value Present_Value must have before an event is generated. 3.2.46 Minimum_Off_Time (Binary objects) This property specifies the minimum number of seconds that Present_Value remains in the INACTIVE state after a write operation in Present_Value has set this property to the INACTIVE state. See chapter Command prioritization [} 62]. 3.2.47 Minimum_On_Time (Binary objects) This property specifies the minimum number of seconds that Present_Value remains in the ACTIVE state after a write operation in Present_Value has set this property to the ACTIVE state. See chapter Command prioritization [} 62]. 3.2.48 Feedback_Value This property indicates the actual value of the unit controlled by Present_Value. 20 Version: 1.1.2 TF8020
## Page 21

Overview about BACnet properties 3.2.49 Number_Of_States (Multistate objects) This property defines the number of states Present_Value can have. 3.2.50 State_Text (Multistate objects) This property is a BACnet ARRAY of strings representing descriptions of all possible states of Present_Value. The number of descriptions corresponds to the number of states defined in the Number_Of_States property. 3.2.51 Alarm_Values (Multistate objects) This property specifies all states to which Present_Value must correspond before a TO-OFFNORMAL event is generated. 3.2.52 Fault_Values (Multistate objects) This property specifies all states to which Present_Value must correspond before a TO-FAULT- event is generated. 3.2.53 Date_List (Calendar object) This property is a BACnet LIST of BACnet Calendar Entry, each of which is either a specific date or date pattern (Date), range of dates (BACnet Date Range), or month/week-of-month/day-of-week specification (BACnet Week NDay). 3.2.54 Weekly_Schedule (Schedule object) This property is a BACnet ARRAY containing exactly seven elements. Each of the elements 1-7 contains a BACnet Daily Schedule. A BACnet Daily Schedule consists of a list of BACnet Time Values which describe the sequence of schedule actions on one day of the week when no Exception_Schedule is in effect. Monday equals the first element (day 1) where Sunday equals the last element (day 7). 3.2.55 Exception_Schedule (Schedule object) This property is a BACnet ARRAY of BACnet Special Events. Each BACnet Special Event describes a sequence of schedule actions that takes precedence over the normal day's behavior on a specific day or days. The special event may contain a Date, Date-range, Week NDay information or a Calendar reference (within the same BACnet device) to specify the exception period. 3.3 Understanding the PICS document A PICS (Protocol Implementation Conformance Statement) is the "BACnet data sheet". This document describes the scope of the BACnet device implementation. The PICS document for Beckhoff controllers can be downloaded here: https://download.beckhoff.com/ download/Document/certificates/beckhoff_bacnet_ip_pics_en_rev14_ver4.0.pdf The PICS describes the supported object types and for each object type, which properties are supported, the read or write access (so-called conformance code) and possible property limitations. In addition, the supported Data Link Layer, character sets, segmentation support, etc. is described as well. The third element of the PICS document is the list of supported BIBBs (BACnet Interoperability Building Blocks). The standard describes A-side and B-side BIBBs. A-side BIBBs are those issued by a client requesting something from or to a B-side device (server). TF8020 Version: 1.1.2 21
## Page 22

Overview about BACnet properties To use a specific functionality, such as Change-of-Value, both sides, client and server, must support the corresponding BIBB. Example: DS-COV-A: Client requests data using the subscribed Change-of-Value. DS-COV-B: The server responds to COV subscriptions from the client and provides the data to the client when the value has changed by sending a COV notification. 22 Version: 1.1.2 TF8020
## Page 23

Quickstart 4 Quickstart This example shows how to create a BACnet server containing a simple analog value object on a CX controller. 4.1 Creating the Twin CAT project 1. Start Twin CAT. 2. Create a new, empty project. TF8020 Version: 1.1.2 23
## Page 24

Quickstart 3. Select Twin CAT Projects in the list of project types, select Twin CAT XAE Project, name the project and change the directory if necessary. 4.1.1 Selecting the target system 1. Select the target system from the list of controllers already connected via an ADS route. 2. If no ADS route to the controller exists, select the function Choose Target System. 24 Version: 1.1.2 TF8020
## Page 25

Quickstart 3. Select Search (Ethernet) in this dialog. TF8020 Version: 1.1.2 25
## Page 26

Quickstart 4. Select Broadcast Search. 5. Select the network adapters which are used to search for controllers. 26 Version: 1.1.2 TF8020
## Page 27

Quickstart ð All available controllers in the network are shown in this list. The letter "x" in the Connected column means that an ADS route has already been set up. 6. Select the controller to be used for the BACnet project, select IP Address in the section Address Info and select Add Route. It is optionally possible to create a secure ADS route. Please refer to the Beckhoff Information System for further information how to use Secure ADS. TF8020 Version: 1.1.2 27
## Page 28

Quickstart This example uses a regular ADS route. The standard password for the user Administrator is the number 1. We strongly recommend changing the default to a more secure password and document it in the revision documents of the project, at the latest when finishing the project. The controller is now connected through ADS. 28 Version: 1.1.2 TF8020
## Page 29

Quickstart 7. Close the dialog and select the controller from the list of available target systems. 4.1.2 Create a BACnet Adapter and Server 1. Right click to Devices and select Add New Item. TF8020 Version: 1.1.2 29
## Page 30

Quickstart 2. Select BACnet IP Device from the list of available supplements. 3. Right click to menu item Device 1 (BACnet IP) and select Add New Item. 30 Version: 1.1.2 TF8020
## Page 31

Quickstart 4. From the list of available TCOM objects select BACnet Server (Module). 4.1.3 IP address settings 1. Double click to BACnet Adapter Device 1 (BACnet IP), select the Adapter tab and check, if the IP address was correctly set. ð In the figure below the MAC address and IP address are set to zero, no adapter was selected. TF8020 Version: 1.1.2 31
## Page 32

Quickstart 2. Select Search and select the network interface. Depending on the controller type the names and number of network interfaces may vary. 3. Check if the IP address was set correctly. 32 Version: 1.1.2 TF8020
## Page 33

Quickstart 4.1.4 Adjusting the BACnet Server settings 1. Double click to the BACnet server which was created in the Device 1 tree item. 2. Use the input box BACnet ID to set the instance number of the BACnet server. The BACnet instance number is a 22-bit value (valid range from 0 – 4194302, 4194303 is reserved as wildcard and cannot be used). Combined with the object type (10-bit), this information creates the unique address of the device (the Device Object Identifier). Every device in the network requires a unique Device Object Identifier. The uniqueness is required across the entire BACnet internetwork, this means across all BACnet networks connected by BACnet routers. Talk to the specialist planner or other parties involved in the BACnet installation to avoid duplicate addressing! TF8020 Version: 1.1.2 33
## Page 34

Quickstart 4.1.5 Persistence Persistent storage of values modified by BACnet clients (e. g. from the BMS) is provided as a file in the Twin CAT boot directory (BACnet Online_1010010.bootdata). To enable persistent storage, please activate “Persist Server Online Data in the BACnet Server settings (as shown above). In case a UPS is installed in the controller, the flag Use UPS may be activated. In this case, the UPS function block must assure that persistent data is written in case of a power loss. 4.2 Creating the BACnet PLC project This example shows how to create a first BACnet server project. 4.2.1 Creating the PLC project 1. Right click to PLC and select Add New Item. 34 Version: 1.1.2 TF8020
## Page 35

Quickstart 2. Select Standard PLC Project and name the project. 3. Right click to References and select Add Library to add libraries to a PLC project. 4. Select the library Tc3_BACnet Rev14. If you enter the text rev14 in the full-text search field, only this library will be displayed. Select this item and click OK. TF8020 Version: 1.1.2 35
## Page 36

Quickstart 5. Double click the POU MAIN in the PLC project. 6. Add the following declaration in the variable window: fb Av : FB_BACnet_AV, 36 Version: 1.1.2 TF8020
## Page 37

Quickstart ð This command creates an instance of the function block FB_BACnet_AV with the name fb Av (which represents an Analog Value object). 7. Add the following entry to the code window: fb Av(); ð This code is called at regular intervals according to the cycle time (default: 10 ms). 8. Build the project by selecting Build / Build Solution. ð Alternatively, you can also call this function by right-clicking on the project name. TF8020 Version: 1.1.2 37
## Page 38

Quickstart 9. Check if the build was successful and no error is displayed. If errors are displayed, check the project and correct the errors. 10. After successful compilation the variable Tc3_BACnet Rev14. BACnet_Globals. Default Adapter. BACnet_Ams Net Id is displayed in the process image. ð This variable is used to establish the BACnet connection between the PLC program and the BACnet adapter. 38 Version: 1.1.2 TF8020
## Page 39

Quickstart 11. Right click to this variable and select Change Link. 12. Select the variable of the same type in the BACnet adapter and create a link with OK. ð The connection is indicated by a connection icon. 13. You can check the link at any time with the function Go To Link Variable. TF8020 Version: 1.1.2 39
## Page 40

Quickstart ð Using this function, the cursor moves to the connected variable. 14. Activate the project using the function Activate Configuration in the Twin CAT menu. ð Alternatively this function is also available in the Twin CAT toolbar. 40 Version: 1.1.2 TF8020
## Page 41

Quickstart 15. Check that the correct target system is selected and click OK. ð If no licenses are available on the target system, so-called trial licenses can be generated. Trial licenses are valid for a period of 7 days. The Beckhoff Information System provides further information on Twin CAT licensing. 16. Enter the 5 letters from the upper field into the lower field. The entry is case sensitive. TF8020 Version: 1.1.2 41
## Page 42

Quickstart 17. To complete this process, Twin CAT requests a restart of the PLC. Click OK. ð With these few and simple steps, a fully functional BACnet server was created. The server and the contained objects are now available in the BACnet network. 4.2.2 Testing the BACnet server 1. Login into the PLC. Select Login from the PLC menu. ð Alternatively, this function is also available via the Twin CAT toolbar. 42 Version: 1.1.2 TF8020
## Page 43

Quickstart 2. Navigate to the POU MAIN, expand the display of the variable fb Av with the plus sign and check the content of this function block representing the BACnet object. ð The variable b Ready indicates a successful start of this object. In this example, no specific configuration of the object properties has been made, so the property values are default values. 4.2.3 Testing BACnet using the System Manager The BACnet objects created by the PLC are similar to the objects created dynamically by BACnet clients using the Create Object service. Follow these instructions to scan dynamic objects in the System Manager: TF8020 Version: 1.1.2 43
## Page 44

Quickstart 1. Double click the BACnet server and navigate to the Settings page. Use the function Scan in the section Dynamic Object Management. ð The tree below the BACnet Server now shows the object fb Av (the one created in the example above). 44 Version: 1.1.2 TF8020
## Page 45

Quickstart 2. Double-click on this object. ð The online view of this object opens. 4.2.4 Testing BACnet using a BACnet Explorer In this example, the tool YABE - Yet Another BACnet Explorer is used. The tool can be downloaded from here: https://sourceforge.net/projects/yetanotherbacnetexplorer/. ü Start YABE. 1. Select Add device. This function can be accessed via the Functions menu , the green button with the plus sign or by right-clicking on Devices. TF8020 Version: 1.1.2 45
## Page 46

Quickstart ð A dialog named Scan opens. 2. Select in the category BACnet/IP over UDP the standard BACnet port BAC0 (corresponds to 47808 in decimal notation) and select the network adapter of your engineering PC (Local endpoint). 3. Select the Add button (the button to the right of the BACnet port). ð The device created in Twin CAT should now appear. 4. Select the device. This resolves the Device Object Name and starts the evaluation of the BACnet objects contained in the device. ð In the device window the tree items represent the objects contained in the device. 5. Select ANALOG_VALUE:10000. 46 Version: 1.1.2 TF8020
## Page 47

Quickstart ð This starts the resolution of the object name (fb Av). Using CTRL-N after selecting a device resolves all object names of all objects in the device. This may take some time, especially if slower MS/TP devices are searched (MS/TP = Master Slave Token Passing = serial BACnet based on RS485). ð Selecting an object in the list of objects opens the object properties display in the right Properties window. This window does not update the property values automatically! To read the properties again, select another object and return to the observed object. TF8020 Version: 1.1.2 47
## Page 48

Quickstart Subscribe for Change of Value (COV) COV is a BACnet procedure to automatically report changes in Present Value and Status Flags to BACnet clients subscribed to the object. 1. To use COV in YABE, right-click on the object and select Subscribe. Alternatively, you can drag and drop the object into the Subscriptions window. ð The selected object is now displayed in the Subscriptions window and is automatically updated when the Present Value and/or the Status Flags of the object change. For analog object types, the COV Increment property is used to suppress minor value changes. The subscription lifetime can be adjusted in the Settings dialog (Subscriptions Lifetime). 2. Return to Twin CAT, log in to the PLC and open the POU MAIN. 3. Expand the display of FB fb Av by clicking on the plus symbol. 4. Navigate to the variables b En Pgm and f Val Pgm. 48 Version: 1.1.2 TF8020
## Page 49

Quickstart 5. Insert the following values in the Prepared value column. If b En Pgm is set to TRUE, the value f Val Pgm is set to the Present Value with the specified priority for the program (default: 15). 6. Select Write Values from the PLC menu. 7. Switch to the online view in the Twin CAT System Manager or switch back to YABE. ð The Present Value property should now display the value "42". TF8020 Version: 1.1.2 49
## Page 50

PLC library: Tc3_BACnet Rev14 5 PLC library: Tc3_BACnet Rev14 This library provides the following items: DUTs = Data Unit Types GVLs = Global Variable Lists POUs = Program Organizational Units Version = Global Version 5.1 DUTs The datatypes are separated into three major items: 5.1.1 Enumerations This section contains the required BACnet list. One exception is the list of enumerated technical units (E_BA_Unit). This can be found in the Tc3_BA2_Common library (as this is often shared between BACnet and the building automation libraries). 5.1.2 Interfaces This section provides al list of interfaces, most of them used in the Base Object Types. 5.1.3 Types This section provides a list of specific data-types, like Object Identifier or Property List. 5.2 GVLs The global variable lists are split into two parts: 5.2.1 Version The variable st Lib Version_Tc3_BACnet Rev14 of type ST_Lib Version can be used to compare the version of the library with the version stored as project information. The Twin CAT3 library version consists of the following elements: i Major = Major release number i Minor = Minor release number i Build = Build number i Revision = Revision number In addition, this structure contains the version information in the form of a string separated by dots. 50 Version: 1.1.2 TF8020
## Page 51

PLC library: Tc3_BACnet Rev14 5.2.2 BACnet_Globals This part of the library specifies global settings like the Default Adapter, BACnet-specific values like supported object types and Error-, Abort- and Reject-Codes. 5.2.3 BACnet_Param Global settings and parameters for the library instance in the project can be defined and changed in this part of the library. Variables declared as CONSTANT are called parameters in Twin CAT and can be changed and adapted according to the requirements of the specific project. Please note that the default parameters from the library repository remain unchanged. To restore the default values, simply remove the BACnet Rev14 library and add it back to the project. TF8020 Version: 1.1.2 51
## Page 52

PLC library: Tc3_BACnet Rev14 The default values provided by the library can be changed using the Value (Editable) column. Example: Extending the text length of state text properties. The following figure shows a default text length of 40 characters for text information provided in multistate and binary objects. For larger text information, the value can be changed from 40 to 60 characters by editing the value. Important: These parameters (like other variable initializations in Twin CAT) are only applied after activating the project or after a reset origin and restart of the PLC. 5.3 POUs The function blocks in the POUs library section are intended for programming BACnet servers and BACnet clients. The POUs section is divided into these sections: Dynamic Objects: The Dynamic Object Manager is mainly used for applications that create or delete objects based on a configuration file or at runtime (e.g. a visualization). Helper: This section contains helper functions such as conversion functions, functions for generating complex data types, etc. Local: This section contains function blocks for local / server applications. This means that Twin CAT provides BACnet objects as a server, which represent values from the PLC. Remote: This section contains function blocks for remote/client applications. This means that Twin CAT accesses other devices as a client and processes values from other devices in the PLC. FB_BACnet_Adapter: This function block represents a BACnet adapter in the System Manager. Please note that the Default Adapter is already present in the GVL BACnet_Globals and is automatically called as soon as a BACnet function block is called in the PLC code. 5.3.1 Naming conventions Local / server object function block names start with the prefix “FB_BACnet_” followed by the shortcut of the object type (e. g. ACC = Accumulator, AI = Analog Input, etc.). 52 Version: 1.1.2 TF8020
## Page 53

PLC library: Tc3_BACnet Rev14 Remote / client object function block names start with the prefix “FB_BACnet RM_” followed by the shortcut of the object type. 5.3.2 FB_BACnet_Adapter The function block FB_BACnet_Adapter represents one BACnet device configured under I/O devices in the Twin CAT system manager. To avoid confusion with BACnet’s device object, a BACnet device will be called BACnet adapter in the context of this library. A BACnet adapter is connected to a network adapter if BACnet/ IP is used and in case of MS/TP one BACnet adapter is connected to an EL6861 terminal. A connection between an instance of FB_BACnet_Adapter with its according I/O device can be established by connecting its Ams Net Id variables. 5.3.2.1 Default Adapter By adding the library Tc3_BACnet Rev14 a default adapter is automatically generated. This adapter is configured as global variable within the library. This adapter needs to be connected to the device (e. g. BACnet/IP). TF8020 Version: 1.1.2 53
## Page 54

PLC library: Tc3_BACnet Rev14 5.3.2.2 Using multiple BACnet adapters The following example illustrates how to use multiple BACnet adapters connecting to different devices. The example below uses a total of three adapters, 1 x BACnet/IP and 2 x MS/TP using terminals EL6861. The next picture shows the overview in the Twin CAT system manager. The device BACnet/IP is connected to the network adapter FEC1 of the CX9020. 54 Version: 1.1.2 TF8020
## Page 55

PLC library: Tc3_BACnet Rev14 The first MS/TP device Device 2 (BACnet MSTP) is connected to the terminal named Term 2 (EL6861). TF8020 Version: 1.1.2 55
## Page 56

PLC library: Tc3_BACnet Rev14 The second MS/TP device Device 3 (BACnet MSTP) is connected to the terminal named Term 3 (EL6861). 56 Version: 1.1.2 TF8020
## Page 57

PLC library: Tc3_BACnet Rev14 All three devices are now connected to the PLC. In this example devices connected to the network have already been scanned and are available as BACnet client references. Using the function FB Code (see separate chapter for details) code was generated to access the objects through function blocks from the BACnet library. The next window shows the variables and code in the POU MAIN copied from the created client function blocks. TF8020 Version: 1.1.2 57
## Page 58

PLC library: Tc3_BACnet Rev14 The code {attribute ‚Tc Link To‘ := … generates a dynamic connection to the referenced BACnet device. The dynamic connection symbol is marked in green in the system manager. The default adapter is connected using a manual connection. The three connections look like this: 58 Version: 1.1.2 TF8020
## Page 59

Programming a BACnet server 6 Programming a BACnet server A BACnet server is a device that provides objects and services for other devices, e.g. an MBE (management operating device). Each BACnet server requires a device object. The Object List and Structured Object List properties of the Device object provide access to the server "database" (the objects contained in the device). The function blocks that represent BACnet objects in a server are located in the folder POUs/Local/Objects. In the following, the function blocks for BACnet objects are presented, followed by typical use cases, how and which function blocks are used. 6.1 BACnet object POUs This chapter describes the function blocks used to program a BACnet server. TF8020 Version: 1.1.2 59
## Page 60

Programming a BACnet server 6.1.1 Function blocks without a suffix ACC Accumulator This object type represents accumulated (pulse) values. AI Analog Input This object type represents physical analog input information, e.g. a sensor value. AO Analog Output This object type represents physical analog output information, e.g. via a 0-10V output. AV Analog Value This object type represents a (virtual) analog value information, e.g. a setpoint. BI Binary Input This object type represents a binary input information, e.g. the state of a lamp or a fuse. BO Binary Output This object type represents a binary output information, e.g. via a switching output. BV Binary Value This object type represents a (virtual) binary value information, e.g. an error state. CAL Calendar This object type represents calendar (date-based) information. Device Device This object type represents the physical device. It contains information such as the local clock, vendor, model name and more. EE Event Enrollment This object type is used to apply event monitoring in addition to intrinsic reporting, e.g. to implement warning limits. ELOG Eventlog This object type represents an event log buffer, e.g. to store alarms locally. File File This object type represents files, e.g. the current configuration or persistent data. Loop Control Loop This object type represents control loops, e.g. a PI or PID loop. MI Multistate Input This object type represents a physical multistate input information, e.g. a local operating modes switch. MO Multistate Output This object type represents a physical multistate output information, e.g. an operating modes switch controlled by the PLC. MV Multistate Value This object type represents a (virtual) multistate value information, e.g. a program parameter. NC Notification Class This object type represents an alarm class to notify recipients. PC Pulse Converter This object type represents converted pulse information, e.g. energy consumption in k Wh. Prog Program This object type represents the PLC program. Sched A Schedule Analog This object type represents a schedule with analog values. Sched B Schedule Binary This object type represents a list of binary values. Sched M Schedule This object type represents a schedule with multistate values. Multistate TLM Trendlog Multiple This object type represents a trendlog object that supports multiple channels. Tlog Trendlog This object type represents a trendlog object that supports a single channel. View Structured View This object type represents a user-oriented object hierarchy. 60 Version: 1.1.2 TF8020
## Page 61

Programming a BACnet server 6.1.2 Primitive Value object types Date Single Date Value This object type represents a certain single date information (day, month, year-1900, weekday). Date P Date Pattern Value This object type represents a date pattern. The pattern value 255 can be used as a wildcard. Date Time Date and Time Value This object type represents a combination of a specific date and time. Date Time P Date and Time Pattern This object type represents a combination of date and time patterns. Value INT Signed Integer Value This object type represents a signed integer value. LAV Large Analog Value This object type represents a large analog value (8 BYTE LREAL). (LREAL) String Character String Value This object type represents string information. Time Time Value This object type represents a specific time (hour, minute, second, hundredths of a second). Time P Time Pattern Value This object type represents a time value that supports patterns. UINT Unsigned Integer Value This object type represents a positive integer value (UNSIGNED). Some function block names contain a suffix: _IO: These FBs are intended for connection to hardware terminal channels. The required AT%I* and AT%Q* variables are specified in the FB implementation. E.g. a Binary Output_IO provides these variables to connect to terminal channels: b Raw Ovrrd AT %I* : BOOL; // Raw overridden (Optional) b Raw Val Fdbk AT %I* : BOOL; // Raw feedback Value (Optional) b Raw Val AT %Q* : BOOL; // Raw value _ECAT: These FBs are intended for connection to Ether CAT hardware terminal channels. The difference to the FBs with the suffix _IO is the variable n Raw State, which is used to determine the Underrange/Overrange state. _Raw: If the PLC provides the value for the BACnet object, the raw value and the raw state can be provided by the PLC program. Example: FB_BACnet_AI_Raw: n Raw State : USINT; // Raw state // - Underrange: 0x01 // - Overrange: 0x02 // - Error: 0x04 n Raw Val : INT; // Raw value _Disp: These function blocks refer to value object types that represent read-only values such as the current room temperature. Present_Value is not writable. _Event: These function blocks refer to a value object similar to the type _Disp (read-only). In addition, these function blocks support Event Reporting. Present_Value is not writable. _Setp: These function blocks refer to setpoints. Setpoints are writable BACnet objects without command prioritization ("last writer wins"). Present_Value is writable, but not commandable. _Buf: These function blocks implement a log buffer in the PLC. This can be used for local visualizations of trend log or event log information. _5P: These function blocks refer to commandable output or value objects that provide a set of 5 priorities for command prioritization. The priority level of each of the 5 priorities can be set in the global BACnet_Param settings. Default settings: TF8020 Version: 1.1.2 61
## Page 62

Programming a BACnet server Priority category Default value Life-Safety 1 Critical Equipment Control 5 Minimum on/off times 6 (defined by the BACnet standard, cannot be changed) Manual Local Operator 7 (local visualization) Manual operator 8 (BMS) Program (PLC) 15 _IO5P: Same as _5P, but used for connection to hardware terminals. _Raw5P: Same as _5P, but the process value is provided by the PLC. _Ref: (Loop object type) These function blocks refer to loop objects that support external analog objects for the setpoint, manipulated variable and feedback value. See chapter Control loops. 6.2 Typical BACnet scenarios This chapter introduces typical scenarios which are commonly used for BACnet projects. 6.2.1 Command prioritization Command prioritization provides a mechanism to determine which process or user role has precedence over lower prioritized processes or user-roles. BACnet specifies 16 levels of priorities, where 1 is specified as the highest (Manual Life-Safety) Priority where 16 specifies the lowest and default priority. The Present_Value is always taken from the value in the highest prioritized slot. A client may remove a priority at a specific slot by writing a value of NULL at the given priority. If no priority is active (all 16 slots having a value NULL), the value for the Present_Value property is taken from the Relinquish_Default property. The priority is specified using a Write Property or Write Property Multiple service. If the priority is missing, 16 will be used as the default priority. Priority Meaning 1 Manual Life-Safety 2 Automatic Life-Safety 3 Available 4 Available 5 Critical Equipment Control, e. g. defrost 6 Minimum On-/Off 7 Available 8 Manual Operator, e. g. BMS 9 Available 10 Available 11 Available 12 Available 13 Available 14 Available 15 Available 16 Available (Default, if no priority is specified) Function blocks with the suffix “_5P” implement a total of 5 of the 16 possible priorities (which is normally enough for most projects). 62 Version: 1.1.2 TF8020
## Page 63

Programming a BACnet server 6.2.2 Event reporting BACnet provides two different procedures to implement event reporting: Intrinsic Reporting and Algorithmic Change Reporting. The determination whether an event is a non-critical information, e. g. an operational message or an abnormal state, e. g. an alarm is specified by the Notify_Type property. 6.2.2.1 Intrinsic Reporting Intrinsic reporting observes the Present_Value property, the event parameters are specified within the same object (e. g. High_Limit, Time Delay, Alarm_Value, etc.). Event generating objects have a connection to a Notification Class object within the same device (referenced by the same instance number in the event generating object and the Notification Class object). Events are being notified to recipients which are present in the Recipient_List property of the Notification Class and which match the active days / active time in the subscription. 6.2.2.2 Algorithmic Change Reporting Algorithmic Change Reporting uses the Event Enrollment object to specify the event algorithm and the event parameters. The Event Enrollment object has a logical connection to a Notification Class object like every other event-generating object. A typical scenario in projects implements an Event Enrollment providing warning limits notified to a Warning Notification Class. Intrinsic Reporting may then be used to detect alarm conditions (High- and Low-Limit) being notified to another Notification Class for alarms. 6.2.3 Scheduling BACnet time scheduling provides strategies to implement date- and/or time-based functionality. For this, BACnet uses two object types, Calendar and Schedule. The Calendar object type provides information if TODAY matches one or more entries in the Date_List property. This is used e. g. to determine, if TODAY is a public holiday or not (assuming the date-list contains this information). An entry in the Date_List property may be a single Date, a Date Range or a Week NDay (which is a combination of days, weeks and months). The Schedule object type is mainly based upon two properties. The Weekly_Schedule property represents a Schedule program (time/value list) for each of the days from Monday to Sunday. The Exception_Schedule property specifies a list of exceptions which have precedence over the Weekly Schedule. The exceptions may be specified as a single Date, Date Range or Week NDay or may be based upon a Calendar reference within the same device. Unfortunately, it is not possible from the BACnet standard to specify a global Calendar and refer to this object from other devices. If needed, the content of a global calendar may need to be copied to local calendar objects in every BACnet device. Schedule objects contain a Schedule_Default property which specifies the fallback value at midnight, except the value is repeated at 00.00.00:00 the next day. The schedule object has no specific data-type. The actual data-type is determined by the Weekly- and Exception Schedule, Schedule_Default and the list of Object Property References. Object Property References may contain properties in objects within the same or in foreign devices. The priority of the Schedule process is specified using the Priority_For_Writing property in the range from 1-16. TF8020 Version: 1.1.2 63
## Page 64

Programming a BACnet server 6.2.4 Trend-Logging Trendlog objects are used to log values from a single source, Trendlog Multiple objects provide multiple channels (but are rarely used). Logging can be based on cyclic polling, COV (Tlog only) or triggered data acquisition (Trigger). In addition to the values of the referenced object property, other events are also recorded (e.g. activation/ deactivation of recording, emptying the buffer, etc.). The size of the log buffer is determined by the BUFFER_SIZE property. Record_Count provides information about the current utilization of the log buffer. Writing a null value to Record_Count clears the buffer. Trendlog objects can be combined with event creation. In this case, a Notification_Threshold can be specified to notify clients to retrieve the values before logging ends or older values are overwritten. 6.2.5 Event-Logging Event logging provides strategies to locally store events or alarms e. g. in case the connection to the BMS is interrupted. In a BACnet server implementation specifying event log objects require to use the same instance number as the Notification Class objects. In this case the Event log object is automatically assigned and retrieves all events/alarms which are distributed through this notification class object. 6.2.6 Control Loops BACnet specifies a Loop object type to provide the parameters for control loops (e. g. P, I, D, Bias, Maximum_Output, etc.). These values are provided as properties of the Loop object type. In case the setpoint, manipulated variable value and the controlled variable value should be visible for BACnet clients, analog objects may be specified in addition to the loop object. Twin CAT provides two implementations for control loops: FB_BACnet_Loop: Loop object w/o external references, the setpoint and manipulated and control values are taken from internal variables. FB_BACnet_Loop_Ref: Loop object with external references. A typical implementation may include an Analog Value object for the setpoint, Analog Output for the manipulated variable value and an Analog Input for the controlled variable value. Example: VAR // control loop using internal variables fb Loop Internal : FB_BACnet_Loop := ( b En := TRUE, s Description := 'Loop using internal control parameters', e Output Unit := E_BA_Unit.e Other_Percent, e Action := E_BA_Action.e Reverse, f Proportional Constant := 5.0, f Integral Constant := 180, f Setpoint := 20 ); f Ctrl Val : REAL := 18; // control loop using external BACnet objects fb Loop Ref_Setpt : FB_BACnet_AV_Setp := (f Value := 20); fb Loop Ref_Ctrl Var : FB_BACnet_AI := (f Val := 18); fb Loop Ref_Y : FB_BACnet_AO := (); fb Loop Ref : FB_BACnet_Loop_Ref := ( b En := TRUE, s Description := 'Loop using reference objects', st Controlled Variable Reference := F_BACnet_Reference(fb Loop Ref_Ctrl Var, Prop Present Value), st Setpoint Reference := F_BACnet_Reference(fb Loop Ref_Setpt, Prop Present Value), 64 Version: 1.1.2 TF8020
## Page 65

Programming a BACnet server st Manipulated Variable Reference := F_BACnet_Reference(fb Loop Ref_Y, Prop Present Value), e Output Unit := E_BA_Unit.e Other_Percent, e Action := E_BA_Action.e Reverse, f Proportional Constant := 5.0, f Integral Constant := 180 ); END_VAR ------------------------------------------------------------------ // internal control loop fb Loop Internal.f Ctrl Var := f Ctrl Val; fb Loop Internal(); // control loop using external object references fb Loop Ref_Setpt(); fb Loop Ref_Ctrl Var(); fb Loop Ref_Y(); fb Loop Ref(); 6.2.7 Time Synchronization BACnet Time Synchronization may be based upon the local time. In this case both the time master and the time recipients must be location within the same time zone. If the devices are located in different time zones, UTC-Time Synchronization may be used instead. For this, the property UTC_Offset in the device object must be set to the offset in minutes to UTC. In addition, daylight saving information must be provided by the device and must be calculated in addition to the UTC time. Implementing a BACnet server does normally not require any specific action. In case a Time Synchronization message is received, the internal controller clock is updated. If the controller is acting as a time master, the function block FB_BACnet_Adapter provides two methods to synchronize clocks in other BACnet devices. Time Sync Time Sync Ex Time Synchronization is an unconfirmed service. A response from the time recipients to the time master is not expected. All devices receiving the time synchronization message shall adjust their local clock. Example for a time master functionality: VAR st Date Time Sync : ST_BA_Date Time; b Success : BOOL; b Sync : BOOL; END_VAR ------------------------------------------------------------------ If b Sync then b Sync := FALSE; b Success := BACnet_Globals. Default Adapter. Time Sync(p Date Time := ADR(st Date Time Sync), b Send Broadcast := TRUE); END_IF 6.2.8 Retrieving diagnosis information To retrieve BACnet diagnosis information the FB_BACnet_Adapter provides this method: Get Diagnosis. Get Diagnosis provides access to the built-in diagnosis in the Twin CAT System Manager, which can be viewed under the "Diagnosis" tab of a BACnet device. In addition, each FB_BACnet_Client provides additional diagnosis information (m_st Diag) for each client and thus offers two further options for monitoring client connections: Roundtrip measurement: It is possible to determine the time of a complete cyclic request. Diagnosis of the different request types, this is displayed per client connection in the diagnosis. Sample to retrieve diagnosis information: VAR fb Device : FB_BACnet_Device; st Diagnosis : ST_BACnet_Diagnosis; TF8020 Version: 1.1.2 65
## Page 66

Programming a BACnet server b Success : BOOL; b Get Diagnosis : BOOL; END_VAR ------------------------------------------------------------------ fb Device(); IF b Get Diagnosis THEN b Get Diagnosis := FALSE; b Success := BACnet_Globals. Default Adapter. Get Diagnosis( ADR( st Diagnosis ) ); END_IF 6.2.9 Scanning other BACnet devices In some cases it is necessary to scan the BACnet network (e. g. from a visualization) to identify external BACnet devices. The FB_BACnet_Adapter provides two methods to start a scan process: Start Scan Start Scan Ex Calling one of these functions generates a BACnet Who-Is request to the network. All devices receiving this request and matching the request parameters shall respond using the I-Am service. The result of this scan process can be retrieved using the FB_BACnet_Adapter method Get Scan Result after waiting an appropriate time. Get Scan Result returns the number of external devices found on the network, regardless of the buffer size to store the results. In case of an error this function returns -1. Example scanning for other BACnet devices: VAR fb Device : FB_BACnet_Device; a_st Scan Result : ARRAY[0.. MAX_SCANRESULTS] OF ST_BACnet RM_Scan Result; b Success Scan : BOOL; b Scan : BOOL; fb Wait Timer : TON; n Scan Result : DINT; END_VAR VAR CONSTANT MAX_SCANRESULTS : UDINT := 200; t Wait Time : TIME := T#5S; END_VAR ------------------------------------------------------------------ fb Device(); fb Wait Timer( IN := NOT fb Wait Timer. Q, PT := t Wait Time ); IF b Scan THEN b Scan := FALSE; n Scan Result := -1; b Success Scan := BACnet_Globals. Default Adapter. Start Scan(); END_IF IF b Success Scan AND fb Wait Timer. Q THEN b Success Scan := FALSE; n Scan Result := BACnet_Globals. Default Adapter. Get Scan Result( ADR( a_st Scan Result ), MAX_SCANRESULTS ); END_IF 6.2.10 Creating a structured view (DPAD) A DPAD (Data Point Addressing Description) is used to navigate to BACnet objects using the facility view, not the technical view. A facility manager knows in which facility, building, floor, room, etc. a BACnet object is located. It is good practice to place a shortcut for the DPAD into the object name property of the BACnet objects and a (most likely larger) information into the description property. In addition the object type Structured View (FB_BACnet_View) may be used to provide the user-view to the facility hierarchy. The following code illustrates how to create a navigation using the operator ‘\/’ (Backslash and Slash). This operator can be placed to the following properties (type Character String): Object Name 66 Version: 1.1.2 TF8020
## Page 67

Programming a BACnet server Description Event Message Text At runtime the separator is replaced by the characters specified in the Global / BACnet_Param section. Code example for creating a DPAD structure PROGRAM MAIN VAR fb DPADFirst Level : FB_BACnet_View := ( e Node Type := E_BACnet_Node Type.e Area, s Object Name := '\/A', s Description := '\/Facilities'); fb DPADSecond Level : FB_BACnet_View := ( i Parent := fb DPADFirst Level, e Node Type := E_BACnet_Node Type.e Organizational, s Object Name := '\/B', s Description := '\/Building'); fb DPADThird Level : FB_BACnet_View := ( i Parent := fb DPADSecond Level, e Node Type := E_BACnet_Node Type.e Network, s Object Name := '\/C', s Description := '\/Floor'); fb Ai : FB_BACnet_AI := ( i Parent := fb DPADThird Level, s Object Name := '\/Object Name', s Description := '\/Description', s Device Type := 'Temperature Sensor', e Unit := E_BA_Unit.e Temperature_Degrees Celsius, f Min Pres Value := -50.0, f Max Pres Value := 150.0, f High Limit := 100, f Low Limit := -25, b High Limit Enable := TRUE, b Low Limit Enable := TRUE, n Notification Class := 10, a Event Enable := [ TRUE, TRUE, FALSE ], a Event Message Texts Config := [ '\/Alarm', '\/Fault', '\/Normal' ]); END_VAR ------------------------------------------------------------------ fb DPADFirst Level(); fb DPADSecond Level(); fb DPADThird Level(); fb Ai(); This code generates three Structured View objects and one Analog Input object and connects the DPAD through the i Parent elements referring to the calling function block. The selection how the tree items are displayed in the system manager can be specified in the Global Params of the library instance: e Symbol Name: The symbol name from the PLC is used as tree item name. TF8020 Version: 1.1.2 67
## Page 68

Programming a BACnet server e Object Name: The BACnet object name is used as tree item name. e Description: The BACnet description is used as tree item name. The system manager tree looks like this (in the example below, the object name was used): The separators used for the three properties possibly containing a DPAD (Object Name, Description and Event Message Texts) can be individually specified in the Global Params setting of the library. 68 Version: 1.1.2 TF8020
## Page 69

Programming a BACnet server 6.2.11 Linking hardware using attributes Using the attribute “Tc Link To”, hardware terminals can be connected the raw value and raw state variables. To determine the TIID path, navigate to the terminal and copy the path. Example: {attribute 'Tc Link To' := '.n Raw Val := TIID^Device 2 (Ether CAT)^Term 1 (EK1200)^Term 4 (EL3214)^RTD Inputs Channel 1^Value; .n Raw State := TIID^Device 2 (Ether CAT)^Term 1 (EK1200)^Term 4 (EL3214)^RTD Inputs Channel 1^Status' } fb Ai_IO : FB_BACnet_AI_IO := ( f Min Pres Value := -150.0, f Max Pres Value := 150.0 ); The links established using this procedure are shown as green arrow symbols in the system manager. 6.3 Important notes using the library This chapter contains notes and recommendations how to use the library when programming a BACnet server. 6.3.1 Declaring properties at start-up In normal PLC programming you will probably find calls like this: TF8020 Version: 1.1.2 69
## Page 70

Programming a BACnet server If the values are constantly written by the PLC, writing from the BACnet would have no effect, the values would be overwritten immediately. Therefore, especially the properties that do not change often or at all should be declared as initial parameters in the variable area. The following code shows an example of initialization of properties at the time of the first PLC start. PROGRAM test VAR fb BI : FB_BACnet_BI := ( s Object Name := 'Name', s Description := 'Description', b Event Detection Enable := TRUE ); b Description Changed : BOOL; END_VAR -------------- fb BI(); IF b Description Changed THEN b Description Changed := FALSE; fb BI.s Description := 'New Description'; END_IF In the above example, the property values (only those that require configuration) are taken from the declaration at the time of the first PLC start. If a configuration property needs to be changed, we recommend a write-on-change procedure, as shown here, rather than cyclic writing. Furthermore, the implementation of a cyclic writing would lead to the fact that no more values are accepted that were written by BACnet. 70 Version: 1.1.2 TF8020
## Page 71

Programming a BACnet server 6.4 Parameter dialogs Using CFC (Continuous Function Chart), accessing the configuration parameters is provided by parameter dialogs. Open the parameter dialog by using the button in the left corner. Values shown in this dialog may be changed in the column Value and can be written to the PLC by using the write values function in the Twin CAT PLC menu. The values are also stored persistently using the PLC persistence. 6.4.1 Always call BACnet function blocks cyclically It is very important that all BACnet function blocks are called once per cycle and only once! TF8020 Version: 1.1.2 71
## Page 72

Programming a BACnet server Do not call the function blocks in this way: This would create a BACnet object that is no longer updated if b Condition is FALSE. The object looks faulty to the client trying to access it. However, it is possible to declare a BACnet object as a variable and not call it at all. In this case the BACnet object is not generated and therefore does not exist in the BACnet server. 6.4.2 Call BACnet function blocks using the same cycle time Calling different BACnet FBs using different cycle times leads to runtime errors caused by delayed library calls. The BACnet supplement and the PLC library require a synchronization at start-up. Calling BACnet FBs delayed in any way is not possible. If objects need to be created or deleted at runtime, refer to the section Dynamic Object Manager in this manual. 6.5 Calculating the router memory Memory for the BACnet object representation in the PLC is taken from the router memory. The default setting in Twin CAT is 32MB and may need to be increased in case of a larger BACnet object database. The log-buffer of Trendlog or Eventlog objects is taken from the router memory as well. As an average the properties of BACnet objects require 20 KB each. To reserve some memory space for other purposes, the library raises an error condition when more 60% of the available router memory is requested by the BACnet library. In this case, further BACnet objects are not created anymore so the project database may be incomplete. On Windows Embedded compact (Windows CE) systems, the maximum router memory is limited to 200MB. On Big-Windows (Windows 10) or BSD the router memory depends on the non-paged pool. E. g. if the total non-paged pool is 1 GB, the router memory may be increased to 600-700MB. Please note, increasing the router memory may require a reboot of the PLC. 6.5.1 Example calculation of required router memory The example below shows a calculation of the required router memory. Example requirement: 280 digital and analog objects = 280 x 20 KB = 5,600 KB 280 Trendlog = 280 x 20 KB = 5,600 KB (properties only) Trendlog buffer size (7 days / 10 min. interval) = 1440 / 10 * 7 = 1008 records per Trendlog Memory requirement for Trendlog buffer: 280 * 1008 * 56 = 15,805,440 (56 bytes per data record in log memory) Total Router Memory required 5,600,000 bytes normal objects 5,600,000 bytes Trendlog objects 15,805,440 bytes Trendlog buffer Total Router memory for BACnet 27,005,440 bytes 72 Version: 1.1.2 TF8020
## Page 73

Programming a BACnet server Please note that the total BACnet router memory is only 60 % of the total required router memory, so the default value of 32 MB would not be sufficient for this example and must be increased. The amount of router memory can be specified in the Real-Time settings of Twin CAT. Please note, that the router memory will be assigned after restarting the controller. 6.6 Specific Functionality This chapter describes specific functionality using the BACnet supplement or the library. 6.6.1 Generating an EDE file When exporting an EDE file, it is important to check the “Use Online Data” checkbox as shown below. Due to the dynamic creation by the BACnet Rev 14 library, the objects need to be visible at the time of the EDE file creation. TF8020 Version: 1.1.2 73
## Page 74

Programming a BACnet server 6.6.2 Cycle time exceed counter At the time of the PLC start exceeds of the cycle time may happen and are normal. The synchronization between the BACnet supplement and the PLC may take longer than the cycle time. Exceeds should not happen after the initialization phase though. 6.6.3 Enable / Disable Properties To disable properties that are not needed for a particular object instance, the "a Disabled" array of the "st Settings" structure can be used. The structure "st Settings" is also available in the Global Params. The settings in the Global Params affect all objects. Please note that related properties (with the same number in the footnotes of the BACnet standard) must all be disabled or enabled! 6.6.4 Writeprotect Properties To apply a write protection to specific properties, the array “a Write Protected” of the structure “st Settings” can be used. The structure “st Settings” is available in the Global Params, too. The settings in the Global Params affect all objects. In case of a Write Property or Write Property Multiple request to those properties an error message “Write_Access_Denied” is returned to the BACnet client. 6.6.4.1 Example Disable/Writeprotect The following example shows how to disable and writeprotect properties using st Settings. 74 Version: 1.1.2 TF8020
## Page 75

Programming a BACnet server fb Bi : FB_BACnet_BI := ( s Object Name := 'Example Binary Input Object', s Description := 'Objectname and Description properties are read-only', st Settings := ( a Disabled := [ E_BACnet Prop Identifier. Prop Change Of State Count, E_BACnet Prop Identifier. Prop Change Of State Time, E_BACnet Prop Identifier. Prop Time Of State Count Reset ], a Write Protected := [ E_BACnet Prop Identifier. Prop Object Name, E_BACnet Prop Identifier. Prop Description ] ) ); 6.6.5 Enabling write access from the PLC Objects representing an input information like ACC, AI, BI, etc. provide an input variable (n Val, f Val or b Val) whose value is transferred to the Present_Value property without further processing. Objects representing an output information like AO, AV, etc. provide an input variable representing the PLC value (n Val, f Val, b Val). In addition, to activate the value at the specified program priority the variable b En Pgm needs to be set to TRUE. In case the value of b En Pgm is set to FALSE, the value will be set to NULL at the specified program priority. In case of _5P function blocks for each of the priorities (with the exception of manual operator which is likely provided from the BMS) a separate flag is provided. The currently active Priority can be determined from the variable e Act Prio (1-16, 17=Relinquish_Default). 6.6.6 Adding a recipient to a recipient list Entries in the recipient list property of Notification Class objects are complex data-types supporting two options. Either the device instance number may be used to identify the recipient or, as an alternative, the BACnet MAC-address (physical address) may be specified. The example below shows both options for the variable a Recipient List: a Recipient List := [ ( st Valid Days := (b Monday:=TRUE, b Tuesday:=TRUE, b Wednesday:=TRUE, b Thursday:=TRUE, b Friday:=TRUE), st From Time := F_BA_To STTime(T#0H), st To Time := F_BA_To STTime(T#23H59M59S), st Recipient := F_BACnet_Device Recipient(n Device Instance:=42), n Process Id := 10000, b Issue Confirmed := FALSE, st Event Transitions := (b To Off Normal:=TRUE, b To Fault:=TRUE, b To Normal:=TRUE) ), ( st Valid Days := (b Sunday:=TRUE, b Saturday:=TRUE), st From Time := F_BA_To STTime(T#7H), st To Time := F_BA_To STTime(T#15H30M), st Recipient := F_BACnet_Ethernet Recipient(n IPAddress1:=192,168,10,200, n Port:=47808, n Network Nr:=444), n Process Id := 30100, b Issue Confirmed := TRUE, st Event Transitions := (b To Off Normal:=TRUE) ) ] 6.6.7 Using UTF-8 characters UTF-8 is the default character set used in the BACnet supplement. The UTF-8 character set covers all Unicode characters and requires up to 4 BYTE per character depending on the language. Regular strings without special characters do not need any specific handling. Latin-1 characters like äöüÄÖÜß©ÔØ, etc. do not require a specific handling either. TF8020 Version: 1.1.2 75
## Page 76

Programming a BACnet server In case of Cyrillic, African or Asian characters, a conversion is required. In this case the attribute ‘Tc Encoding’ needs to be set to ‘UTF-8’. Like every attribute this applies to the variable below the attribute and needs to be repeated for each variable containing UTF-8 characters. Example using UTF-8 characters: {attribute 'Tc Encoding' := 'UTF-8'} s My UTF8Text : STRING := ws Literal_TO_UTF8( "äöüßéèêµ€° Ἀθῆναι İstanbul Київ" ); Please note to use double quotation marks in case of WSTRING variables! 6.7 FB_BACnet_Server This function block represents the BACnet server in the PLC. In addition to information about memory usage and memory state, there are various options, such as acknowledging alarms, writing persistent data, resetting the server's error state, or iterating over the object database. This function block is called automatically and normally does not have to be called within the PLC program. If you want to access the properties of the server, use the already existing instance from the BACnet Globals. 6.8 FB_BACnet_Device This function block may be used to change settings of the device object at runtime. Example: VAR fb Device : FB_BACnet_Device; b Change Device Obj : BOOL; END_VAR ------------------------------------------------------------------ fb Device(); IF b Change Device Obj THEN b Change Device Obj := FALSE; fb Device.s Object Name := 'TEST_Obj Name'; fb Device.s Description := 'TEST_Description'; fb Device.s Location := 'TEST_Location'; END_IF 6.9 IO Code This function may be used to automatically generate the necessary program code for referencing hardware terminals to the PLC and BACnet objects. The generated code is created as a program in the PLC. 1. To start the IO Code generation, navigate to the BACnet server and select the Settings dialog. 76 Version: 1.1.2 TF8020
## Page 77

Programming a BACnet server 2. Select the hardware and use the button IO Code. ð Digital and Analog input and output terminals and channels are detected and the program code is generated. • Digital input channels are mapped to BACnet Binary-Input objects. • Digital output channels are mapped to BACnet Binary-Output objects. • Analog input channels are mapped to BACnet Analog-Input objects. • Analog output channels are mapped to BACnet Analog-Output objects. 3. Using the button Create in Plc generates the code as a program in the folder POUs/BACnet_Io Bus. 4. Call this program cyclically, e. g. from the POU MAIN. Io Bus_0_Device_2_Ether CAT(); 6.10 Recommended workflow / BACnet persistence In building automation projects, changes of parameter settings very often happen while programming and configuring the application. TF8020 Version: 1.1.2 77
## Page 78

Programming a BACnet server It is recommended to adjust parameters like P, I, D or Hi-Limit / Lo-Limit, even Description texts, etc. without using the BACnet persistence as long as possible. As final step before handing over the building automation application, the BACnet persistence should be activated. Normally the values are synchronized at start-up from the BACnet supplement to the PLC. If BACnet persistence is activated, values previously written from BACnet will overwrite values in the PLC. The FB_BACnet_Server provides a variable e Init Mode to define the direction of this synchronization: • e Init Reset: This value is set after a Reset to Origin was performed. BACnet objects in the stack will be removed and e Init Mode will be set to e Init To Plc. • e Init To Plc (default): Values are synchronized from BACnet to the PLC. • e Init Force From Plc: Values are synchronized from the PLC to BACnet. 6.11 Persistence The property values changed at runtime are stored in the file BACnet Online_1010010.bootdata in the Twin CAT boot folder. Additionally there is a backup file named BACnet Online_1010010.bootdata-old. Switch on and configure BACnet persistence In the settings of the BACnet server, persistence can be switched on and off in the dialog box Device Management. Without using an uninterruptible power supply (UPS), persistence is performed at a configurable interval. The default value of 30 minutes should not be undercut, otherwise the flash medium could be subject to greater wear. If a UPS is used, the property Use UPS can be activated. In this case, the PLC program must ensure that the function blocks of the UPS are used to detect a power supply failure. In this case, the function for persisting the data must be called on the part of the PLC. Calling persistence from the PLC program Two different methods are available to trigger persistence. 1. Setting the variable b Write Persistent:: BACnet_Globals. Default Server.b Write Persistent := TRUE; The variable must also be reset from the PLC program. 2. Calling the Save Persistent Stack Data method: b Success := BACnet_Globals. Default Server. Save Persistent Stack Data(); The return value can be used to detect whether the call was successful. View and edit persistence data ü You have opened the Device Management dialog box. 1. Select the Online Data > … option. ð The dialog for editing the persistence data appears, the contents of which are explained below. 78 Version: 1.1.2 TF8020
## Page 79

Programming a BACnet server Option Description Enable Switch on persistence. Disable Switch off persistence. Transfer Allows copying the persistent data to the default settings of the objects (Settings). Delete Deletes the files that contain the persistence data. Save Saves changed data in the persistence file. Open Can load and display a persistence file. Accessing the persistence file with the FILE object The persistence file is represented via BACnet within the server by the File object with instance number 1. 1. Double-click the Value field of the Object Name to view the currently existing contents of the persistence file. ð If the persistence file contains data, the Bootdata Viewer is called and the changed properties are displayed. Bootdata Viewer In the window Bootdata Viewer the changed properties from the persistence file are displayed and can also be marked and copied from there for further processing. TF8020 Version: 1.1.2 79
## Page 80

Programming a BACnet server In this example, in the Analog Value object with instance number 10000, the properties Object Name, Description, High Limit, Event Detection Enable and Plc Symbol Name have been changed. Delete persistence data Call Dialog Online Data 1. In the BACnet server, open the Settings tab. 80 Version: 1.1.2 TF8020
## Page 81

Programming a BACnet server 2. Click the menu item Online Data > … ð The dialog box Persistent Data Online Management opens. 3. Click the Disable button. TF8020 Version: 1.1.2 81
## Page 82

Programming a BACnet server 4. Then click the Delete button in the same menu. 5. Note the status display. This provides information on whether the function could be executed successfully. 6. Finally, restart via the Twin CAT main menu by clicking the Runtime Mode button. 6.12 Time synchronization In this description, the term time stands for the combination of date and time (Date and Time). BACnet time synchronization In BACnet, time synchronization is performed via two services: Time Synchronization synchronizes the time based on the local time, i.e. the timer and the time receiver must be in the same time zone. 82 Version: 1.1.2 TF8020
## Page 83

Programming a BACnet server When using UTCTime Synchronization (UTC=Universal Time Coordinated) the time is transmitted as GMT (Greenwich Mean Time = local time London). The timer converts the time to GMT before sending. Using the local settings UTC_Offset and Daylight Savings Status (in the device object of the server), the time receiver then converts back to the local time. UTC_Offset specifies the value in minutes relative to GMT. A positive value is to be used westward from GMT, a negative value eastward from GMT. Western Europe has an offset of -60 minutes from GMT. This is set as the default value in the Twin CAT BACnet server and may have to be adjusted when used in other time zones with the use of UTC. • The time synchronization has a direct effect on the recording of BACnet logging objects (Trendlog, Trendlog-Multiple and Eventlog). If the time changes, this is accepted as an entry in the log memory. Short time synchronization intervals can therefore result in many (unnecessary) entries in the log memory of the logging objects. • There should be only one timer in a BACnet network. This must be ensured by the operator or specialist planner. Even if it is basically possible according to the BACnet standard to send the time synchronization to only one group of participants (multicast) or to only one single participant (unicast), in practice the time is often sent as a broadcast to all participants of the network. Twin CAT as BACnet time receiver If a Twin CAT controller receives a BACnet time synchronization, the internal time of the controller is set with this time. Twin CAT as BACnet timer If a Twin CAT controller is used as a BACnet timer, it must determine the exact time from an external location, e.g. by using the NTP service on an external NTP server (NTP = Network Time Protocol). For example, time.windows.com is available as a publicly available time server. The method Time Sync Ex im FB_BACnet_Adapter is available for taking over the time and, if necessary, broadcasting in the network. The following values are passed to the call as parameters: TF8020 Version: 1.1.2 83
## Page 84

Programming a BACnet server Name Type Description p Date Time ST_BA_Date Time Pointer to a structure of type ST_BA_Date Time (see library Tc3_BA2_Common). In this structure the date and time to be set is passed or returned in case of e Sync Mode = 3. e Sync Mode E_BACnet_Time Sync Mod Enumeration e The value determines the type of synchronization: e Sync And Send Local Time := 0 Sets p Date Time in the BACnet stack (as Local Time) and sends the time as broadcast (Time Sync request) Use case: The controller receives the time via NTP and sends the local BACnet time to other controllers as broadcast. e Sync Only := 1 Sets p Date Time in the BACnet stack (as Local Time) Use case: All controllers receive the time via NTP and synchronize their own BACnet clock. e Sync And Send Utc Time := 2 Sets p Date Time in the BACnet stack (as UTC Time) and sends the time as broadcast (UTC Time Sync request) Use case: The controller receives the time via NTP and sends the BACnet time as UTC to other controllers as broadcast. e Sync Get Time := 3 Returns the current time in the BACnet stack in p Date Time. Use case: Is rather rarely used. A possible use case would be, for example, a comparison of the BACnet clock with the trend recording. 6.13 Recommended cycle time of the PLC task The default value for the PLC cycle time (PLC task) is 10 ms. In many cases this is not necessary for processing the BACnet data. It is recommended to use a cycle time of 40-50 ms for the PLC task. Even higher values (i.e. a slower cycle time) are not recommended, otherwise the communication via BACnet, e.g. with a MBE (Management Bedieneinrichtung, management operating equipment), will be slowed down. 84 Version: 1.1.2 TF8020
## Page 85

Programming a BACnet client 7 Programming a BACnet client A BACnet client is a reference to an external peer BACnet device. As a client, the Twin CAT BACnet supplement provides access to objects and services provided by an external device. For each external device one reference needs to be established. The function blocks to access BACnet objects as a client are located in the section POUs/Remote/Objects. Difference between server and client FBs Client FBs are designed to provide cyclic data-exchange to an external device, mostly the present value and status flags are transferred. Other properties like description, limits, state-texts, minimum-/maximum present value, etc. are not part of the standard FB implementation. Even though, the function blocks FB_BACnet_Read Property and FB_BACnet_Write Property may be used to access properties other than the standard ones provided in the FB implementation. These function blocks provide acyclic access to BACnet property data. 7.1 Writemode Writing to the third-party device is implemented as Write On Change by default. This means that values are only written if the value has changed. A periodic writing can be set in the client FBs. Typ E_BACnet_Writemode specifies write access to client properties: e Auto = Automatic, the mode is determined from the properties of the client device if TRUE e Cyclic = Cyclic writing, cycle time is taken from t Write Cycle Time e On Change = Writing is only triggered if the value has changed 7.2 Readmode Using the remote function blocks as a client requires specifying the access mode to the peer objects. The variable e Read Mode of type E_BACnet_Comm Mode specifies the access method. e Auto = Automatic e Cov = Unconfirmed COV e Cov C = Confirmed COV e Cov U = Unsubscribed COV e Rp = Read Property e Rpm = RPM=Read Property Multiple 7.2.1 Automatic mode The following description explains the implementation of the Automatic readmode. During startup in automatic mode important properties such as Protocol Services Supported, Apdu Size are read from the peer device. Using these property data the read mode will be calculated using the following rules. It will also be calculated how many properties in one Rpm request are optimal to avoid segmentation. 7.2.1.1 Case 1: Devices with small APDU size MS/TP or BACnet over Lon Talk devices support only small APDU (Application Protocol Data Unit) sizes. MS/ TP supports a maximum of 480 bytes, BACnet over Lon Talk only up to 206 Bytes. The maximum number of parallel requests is set to 1. This means only 1 request is sent and the response is awaited before continuing with the next request. TF8020 Version: 1.1.2 85
## Page 86

Programming a BACnet client If the APDU size is less or equal to 480 bytes (e. g. MS/TP devices), then the Read Property Multiple threshold will be set to 5. Change-of-Value will not be used in this case. The number of properties per RPM request is limited 20 properties. If the APDU size is less or equal to 206 bytes (BACnet over Lon Talk devices), the number of properties per RPM request is limited 10 properties. 7.2.1.2 Case 2: BACnet/IP devices BACnet/IP devices support an APDU size of up to 1476 bytes. If the APDU size is greater than 480 bytes (e. g. 1476 for BACnet/IP), then the number of parallel requests is set to 50, this means there may be up to 50 requests awaiting the responses. The Read Property Multiple threshold will be set to 300. This means, if more than 300 properties are requested cyclically RPM will be used in available instead of COV. 7.2.1.3 Read Property Multiple threshold and selected read service If the total number of properties to be read in one cycle exceeds the Read Property Multiple threshold and Read Property Multiple is supported by the peer device, the readmode is set to Read Property Multiple. If the total number of properties to be read in one cycle is less or equal than the Read Property Multiple threshold and Change Of Value is supported by the peer device, the readmode is set to Change Of Value. If the total number of properties to be read in one cycle is less or equal than the Read Property Multiple threshold and Change Of Value is not supported by the peer device, the readmode is set to Read Property Multiple. If the total number of properties to be read in one cycle is less or equal than the Read Property Multiple threshold and Read Property Multiple is not supported by the peer device, the readmode is set to Read Property. 7.2.2 Applying the Readmode to the entire peer device The access mode can be specified for the entire client connection (i.e. this setting is applied to all objects of the peer device). Client : FB_BACnet_Client := (e Read Mode:=E_BACnet_Comm Mode.e Cov U,b Supp Cov:=TRUE,b Supp Cov P:=TRUE,b Supp Rpm:=TRUE,t Read Cycle Time:=T# 2S550ms,t Write Cycle Time:=T#2S550ms); 7.2.3 Applying the Readmode to single objects Devices from various vendors claim support for Change-of-Value, but not for all objects in a device. In this is the case trying to apply COV to all objects fails. Knowing which objects support COV (taken from the device manual or from other sources like the PICS = Protocol Implementation Conformance Statement document) allows to setup a COV access to those objects supporting this feature. Example: Object AV:2 is requested using Readmode COVC (Confirmed COV). Actual_Flow_Rate_feedback : FB_BACnet RM_AV := (Client:=Client,n Object Instance:=2,e Read Mode:=E_BACnet_Comm Mode.e Cov C ); No fallback procedure is provided in case the peer device runs out of memory and is unable to accept further COV subscriptions. In this case the FB will enter an error state. In case you are uncertain, use RP/RPM polling instead of COV. 86 Version: 1.1.2 TF8020
## Page 87

Programming a BACnet client 7.2.4 COV-Reporting COV (Change-of-Value) reporting provides a functionality to automatically receive notifications in case of value changes. Normally only the Present_Value and Status_Flags properties are being notified. As a client, to receive COV-Notifications it is required to subscribe for COV for a period of time (even though infinite subscriptions are possible, it is good practice to use limited lifetimes only). If the subscription succeeds, a simple acknowledge is returned by the server. The current value is being reported as the initial value as soon as the device can provide it (normally within a few seconds). The list of active COV subscriptions can be obtained from the property Active_COV_Subscriptions from the Device object. In case the subscription is not repeated after the subscription lifetime expired, the subscription is silently removed and no COV messages are reported for this subscription anymore. After the subscription is renewed the current value will be provided again as the initial value, this can be used as a heartbeat, especially for binary objects which do not change very often. The number of subscriptions is not clearly specified in the BACnet standard. In addition, there are devices on the market which claim support for COV, but not for all objects. Or the number of subscriptions may be limited to just a few per object or per device. Other client processes like the BMS may use COV as well which may cause a BACnet device to run out of space for further subscriptions. In case of BACnet error messages, especially issued by smaller MS/TP devices we recommend using a Read Property / Read Property Multiple polling instead of using COV. 7.3 Client POUs Remote FBs for programming a BACnet client are named "FB_BACnet RM_" followed by the abbreviation given in the following table, e.g. the FB_BACnet RM_AI represents a remote FB for accessing an analog input object in a peer device. TF8020 Version: 1.1.2 87
## Page 88

Programming a BACnet client ACC Accumulator This object type represents accumulated (pulse) values. AI Analog Input This object type represents physical analog input information, e.g. a sensor value. AO Analog Output This object type represents physical analog output information, e.g. via a 0-10V output. AV Analog Value This object type represents a (virtual) analog value information, e.g. a setpoint. AV_Disp Analog Value This object type represents read-only analog value information. Display AV_Setp Analog Value This object type represents writable but not commandable analog value Setpoint information, priority array and relinquish default are not provided. AVG Averaging This object type represents an averaging object that provides statistical information. BI Binary Input This object type represents a binary input information, e.g. the state of a lamp or a fuse. BO Binary Output This object type represents a binary output information, e.g. via a switch. BV Binary Value This object type represents a (virtual) binary value information, e.g. an error state. BV_Disp Binary Value This object type represents read-only binary value information. Display BV_Setp Binary Value This object type represents a writable but not commandable binary value Setpoint information, priority array and relinquish default are not provided. CAL Calendar This object type represents calendar (date-based) information. CMD Command This object type represents command information (scene information). Device Device This object type represents the physical device. It contains information such as the local clock, vendor, model name and more. EE Event Enrollment This object type is used to apply event monitoring in addition to intrinsic reporting, e.g. to implement warning limits. ELOG Eventlog This object type represents an event log buffer, e.g. to store alarms locally. File File This object type represents files, e.g. the current configuration or persistent data. Group Group This object type represents a group of objects. Loop Control Loop This object type represents control loops, e.g. a PI or PID loop. Loop_Cnv Control Loop Like Loop object, additionally P, I and D and the respective units are provided. MI Multistate Input This object type represents a physical multistate input information, e.g. a local operating modes switch. MO Multistate Output This object type represents a physical multistate output information, e.g. an operating modes switch controlled by the PLC. MV Multistate Value This object type represents a (virtual) multistate value information, e.g. a program parameter. MV_Disp Multistate Value This object type represents read-only multistate value information. Display MV_Setp Multistate Value This object type represents writable but not commandable multistate value Setpoint information, priority array and relinquish default are not provided. NC Notification Class This object type represents an alarm class to notify recipients. PC Pulse Converter This object type represents converted pulse information, e.g. energy consumption in k Wh. Prog Program This object type represents the PLC program. Sched A Schedule Analog This object type represents a schedule with analog values. Sched B Schedule Binary This object type represents a list of binary values. Sched M Schedule This object type represents a schedule with multistate values. Multistate 88 Version: 1.1.2 TF8020
## Page 89

Programming a BACnet client TLM Trendlog Multiple This object type represents a trendlog object that supports multiple channels. Tlog Trendlog This object type represents a trendlog object that supports a single channel. 7.4 FB Code This function may be used to automatically generate the necessary function code for referencing BACnet clients in the PLC. The remote function blocks referring to the BACnet remote objects are automatically referenced in the code generation. 7.5 Calling the function FB Code FB Code may be called from different menu items in the system manager. 7.5.1 Calling FB Code from the Scan dialog Using the Scan function, BACnet devices are automatically detected using the BACnet services Who-Is / I- Am. After scanning for devices, the dialog shows all available devices found in the network. Right click to a device and select FB Code to start the code generation. Make sure, a PLC project already exists. TF8020 Version: 1.1.2 89
## Page 90

Programming a BACnet client 7.5.2 Calling FB Code from the Cyclic Data dialog If the device has been scanned and added to the System Manager as a BACnet client reference, the FB Code can be called via the Cyclic Data dialog. Select the client device in the System Manager tree and select the Cyclic Data dialog. 7.6 The client FB Code dialog After calling the function FB Code the dialog shown below opens the code generation window. The BACnet objects contained in the selected device are shown in the tree in the left window. If using FB Code from the Scan dialog, searching for all objects in a device may take some time. This is shown by animated dots. Please be patient to read the entire device, especially when scanning slower MS/TP devices! 90 Version: 1.1.2 TF8020
## Page 91

Programming a BACnet client After scanning the entire device, the dialog displays all objects contained in the device. 7.6.1 The Select Objects window This window shows the objects contained in the device. Objects which should not be included in the code generation may be disabled by using the checkboxes. 7.6.2 Supported Services This window displays the supported services of the peer device. Read Property TF8020 Version: 1.1.2 91
## Page 92

Programming a BACnet client Cyclic polling is performed to determine the property values. Read Property reads only individual properties. Read Property Polling is therefore very slow due to its principle. RPM = Read Property Multiple RPM is a cyclic polling that polls multiple values at once to determine the property values. This process is faster than polling with Read Property. In some cases, the Props RPM value must be lowered to a lower value, especially for devices with limited resources. COV = Change of Value This setting uses COV to poll the property values (Present Value and Status Flags). Note: Some devices, especially MS/TP devices, may support COV only for some, not all, objects contained in the device. In this case, deselect COV from the supported services and, if necessary, add COV support in the PLC code only to the objects that support COV. In the data sheet of the BACnet device you will find the corresponding objects. If you are not sure, disable COV and use RP/RPM polling instead. COV-P = Change of Value Property With this service Twin CAT subscribes as a client to individual properties. Note: Not all BACnet devices support this service! 7.6.3 Service Settings Resub (s) This setting specifies the interval to resubscribe for Change-of-Value. This value also specifies the heartbeat (every subscription causes a value update). Props/RPM This setting specifies the number of properties per Read Property Multiple request. Please note, some BACnet devices may not be able to handle higher quantities of properties per request. In this case this value may be decreased for a proper communication. Read Mode Automatic Unconfirmed COV Confirmed COV Unsubscribed COV Read Property RPM=Read Property Multiple The calculation of the number of Read Property Multiple requests is determined by the settings in the Read Property Multiple Settings dialog. 92 Version: 1.1.2 TF8020
## Page 93

Programming a BACnet client The first item specifies the maximum number of properties requested in a single RPM-request. The second item specifies the maximum number of RPM requests. Please note: These settings are optimized for Beckhoff peer devices and may be reduced in case other devices cannot handle large amounts of requests or properties per request. 7.6.4 The Settings window Max parallel Requests This setting specifies how many requests may be sent before waiting for the response of the peer device. Please note that some devices may not support a large number of parallel requests. If you are not sure, use the value 1 and watch for possible timeout messages in the error log window. Read Cycle (ms) This value specifies the read request interval in milliseconds. Write Cycle (ms) This value specifies the write interval in milliseconds. 7.6.5 The FB Code window This window displays the code generated from the object information of the selected device in structured text (ST). This window is divided into three sections. The (* Usage *) section shows how to create instances of this function block and adds a Tc Link To... attribute in the case of MS/TP Sample: {attribute 'Tc Link To' := '. BACnet_Ams Net Id := TIID^Device 3 BACnet MSTP)^Inputs^Ams Net Id'} fb Mstp Device_3 : FB_BACnet_Adapter; fb_101_Novos_Touch_BACnet_MSTP : FB_BACnet_101_Novos_Touch_BACnet_MSTP :=(Client:=(Adapter := fb Mstp Device_3, n Device Instance := 101)); The (* Declaration *) section shows the variables of the function blocks used. Sample: FUNCTION_BLOCK FB_BACnet_101_Novos_Touch_BACnet_MSTP VAR_INPUT CONSTANT Client : FB_BACnet_Client:= (t Read Cycle Time:=T#2S550ms,t Write Cycle Time:=T#2S550ms); _101_Novos_Touch_BACnet_MSTP: FB_BACnet RM_Device:= (Client:=Client); Internal_Fan_Stage: FB_BACnet RM_MI := (Client:=Client,n Object Instance:=104); ECO_Colour: FB_BACnet RM_MV := (Client:=Client,n Object Instance:=102); External_Fan_Stage: FB_BACnet RM_MV := (Client:=Client,n Object Instance:=105); END_VAR The (* Code *) section shows the instance calls of the function blocks. Sample: Client(); _101_Novos_Touch_BACnet_MSTP(); Internal_Fan_Stage(); ECO_Colour(); External_Fan_Stage(); The footer of this dialog contains a switch that influences the code generation. It is possible to generate the code for BACnet revision 12 using the automapping comments or for BACnet revision 14 using the PLC code. TF8020 Version: 1.1.2 93
## Page 94

Programming a BACnet client Selecting Create in PLC starts the code generation. After successful creation, a message is displayed in the footer. Click Close to close the dialog and return to the Twin CAT System Manager. After this step it is only necessary to place the function block call (e.g. in the POU MAIN) as shown above. The contents of the FB Code window can also be copied to the clipboard for further editing. 7.6.6 Using the FB created by FB_Code The code generated by FB_Code is not called automatically. The first lines in the variable declaration of the generated FB contain the usage information. Sample BACnet IP (* Usage : fb Beckhoff_1062412 : FB_BACnet_Beckhoff_1062412 :=(Client:=(n Device Instance := 42)); *) Cyclic call, e.g. in POU Main Sample BACnet MS/TP (* Usage : {attribute 'Tc Link To' := '. BACnet_Ams Net Id := TIID^Device 3 (BACnet MSTP)^Inputs^Ams Net Id'} fb Mstp Device_3 : FB_BACnet_Adapter; fb_101_Novos_Touch_BACnet_MSTP : FB_BACnet_101_Novos_Touch_BACnet_MSTP :=(Client:=(Adapter := fb Mstp Device_3, n Device Instance := 101)); *) Cyclic call, e.g. in POU Main 94 Version: 1.1.2 TF8020
## Page 95

Programming a BACnet client Please note that the MS/TP adapter FB must be called cyclically in addition to the FB representing the MS/TP device. 7.6.7 Using FB_Code to create device templates If there are several identical devices, FB_Code can be used to create a template. Multiple instances of the generated FB can be accessed via the device instance number of the peer device. In the following sample, the generated FB has been renamed to represent a more general FB implementation. It is recommended to use the refactoring function of Twin CAT to avoid naming conflicts. Three instances are declared in MAIN and called cyclically. Please note that you call the adapter FB only once! Sample: Rename FB_Code Cyclic calls in MAIN: 7.7 Client variables The client FBs provide various information about the status of the peer connection. TF8020 Version: 1.1.2 95
## Page 96

Programming a BACnet client Adapter: e Dev State: Describes the state machine in the connection phase. Should be e Complete if all steps were successful. b Eth Link: TRUE if the connection has been established. b Gateway: TRUE if the IP address setting contains gateway information (IT router). _b Has Started: TRUE if the state machine is started. _n Update Count: This value is incremented in each cycle. Client: b Auto Reset Obj Error: If set to TRUE, the client state machine is automatically reset in case of communication interruption. b Supp Rpm: TRUE, if the peer device supports Read Property Multiple. b Supp Cov: TRUE means that the peer device supports Change Of Value. b Supp Cov P: TRUE means that the peer device supports Change Of Value Property. b Ready: The FB is initialized and ready to request data from the peer device. b Connected: TRUE means that a connection to the peer device has been successfully established. If the client does not use automatic mode, these variables determine which services are used to retrieve the values: b Supp Rpm, b Supp Cov, b Supp Cov P 7.8 Remote schedule objects BACnet schedule objects do not have a specific data type. The data type used for the schedule is determined by the Weekly-Schedule, Exception-Schedule, Schedule-Default and Listof Object Property References properties. To reference external schedule objects, the corresponding function block must be selected manually (FB_BACnet RM_Sched A for analog schedule, FB_BACnet RM_Sched B for binary schedule, FB_BACnet RM_Sched M for multistate schedule). 7.9 Acyclic read To read properties from the object of a peer device, the library provides two functions for acyclic reading: FB_BACnet RM_Read Property FB_BACnet RM_Read Property Ex The BACnet object of the peer device is referenced by a pointer to the FB remote instance (variable i Object). Compared to the basic function block FB_BACnet RM_Read Property, the function block FB_BACnet RM_Read Property Ex provides two additional variables for specifying the object type and instance number (variables e Obj Type and n Obj Inst). 7.9.1 Example FB_BACnet RM_Read Property This sample shows how to use the FB_BACnet RM_Read Property function block to read the value of the high_limit property from the analog input object, instance number 1 in the peer device instance number 42. Please note that the object referenced by i Object must be called cyclically. VAR fb Client : FB_BACnet_Client := (n Device Instance := 2,t Read Cycle Time:=T#10S,n Max Parallel Requests:=255); fb Device : FB_BACnet RM_Device := (Client:=fb Client); fb AI : FB_BACnet RM_AI := (Client:=fb Client,n Object Instance:=1); fb Read : FB_BACnet RM_Read Property := (Client := fb Client); 96 Version: 1.1.2 TF8020
## Page 97

Programming a BACnet client b Read High Limit : BOOL; f High Limit : REAL; END_VAR ------------------------------------------------------------------ fb Client(); fb Device(); fb AI(); // Read High Limit using FB_BACnet RM_Read Property fb Read.b Execute := b Read High Limit; IF fb Read.b Execute THEN b Read High Limit := FALSE; fb Read.p Data:= ADR( f High Limit ); fb Read.n Data:= SIZEOF( f High Limit ); fb Read.e Prop ID:= E_BACnet_Property Identifier. Prop High Limit; fb Read.i Object := fb AI; END_IF fb Read(); 7.9.2 Example FB_BACnet RM_Read Property Ex The following example shows the use of the FB_BACnet RM_Read Property Ex function block. VAR fb Client : FB_BACnet_Client := (n Device Instance := 42,t Read Cycle Time:=T#10S,n Max Parallel Requests:=255); fb Device : FB_BACnet RM_Device := (Client:=fb Client); fb Read Ex : FB_BACnet RM_Read Property Ex := (Client := fb Client); b Read Low Limit Ex : BOOL; f Low Limit Ex : REAL; END_VAR ------------------------------------------------------------------ fb Client(); fb Device(); // Read Low Limit using FB_BACnet RM_Read Property Ex fb Read Ex.b Execute := b Read Low Limit Ex; IF fb Read Ex.b Execute THEN b Read Low Limit Ex := FALSE; fb Read Ex.p Data:= ADR( f Low Limit Ex ); fb Read Ex.n Data:= SIZEOF( f Low Limit Ex ); fb Read Ex.e Prop ID:= E_BACnet_Property Identifier. Prop Low Limit; fb Read Ex.n Obj Inst:= 1; fb Read Ex.e Obj Type:= E_BACnet_Object Type. Obj Analog Input; END_IF fb Read Ex(); 7.10 Acyclic write To write properties to the object of a peer device, the library provides two functions for acyclic writing: FB_BACnet RM_Write Property FB_BACnet RM_Write Property Ex The BACnet object of the peer device is referenced by a pointer to the FB remote instance (variable i Object). Compared to the basic function block FB_BACnet RM_Write Property, the function block FB_BACnet RM_Write Property Ex provides two additional variables for specifying the object type and instance number (variables e Obj Type and n Obj Inst). 7.10.1 Example FB_BACnet RM_Write Property This example shows how to use the function block FB_BACnet RM_Write Property to write the value of the out_of_service property of the object binary output, instance number 0 in the peer device instance number 42. Please note that the object referenced by i Object must be called cyclically. VAR fb Client : FB_BACnet_Client := (n Device Instance := 42,t Read Cycle Time:=T#10S,n Max Parallel Requests:=255); fb Device : FB_BACnet RM_Device := (Client:=fb Client); fb BO : FB_BACnet RM_BO := (Client:=fb Client,n Object Instance:=0); TF8020 Version: 1.1.2 97
## Page 98

Programming a BACnet client fb Write : FB_BACnet RM_Write Property := (Client := fb Client); b Write Oo S : BOOL; b Outof Service : BOOL; END_VAR ------------------------------------------------------------------ fb Client(); fb Device(); fb BO(); // Write Out Of Service using FB_BACnet RM_Write Property fb Write.b Execute := b Write Oo S; IF fb Write.b Execute THEN b Write Oo S := FALSE; fb Write.p Data:= ADR( b Out Of Service ); fb Write.n Data:= SIZEOF( b Out Of Service ); fb Write.e Prop ID:= E_BACnet_Property Identifier. Prop Out Of Service; fb Write.i Object := fb BO; END_IF fb Write(); 7.10.2 Example FB_BACnet RM_Write Property Ex The following example shows the usage of function block FB_BACnet RM_Write Property Ex. VAR fb Client : FB_BACnet_Client := (n Device Instance := 42,t Read Cycle Time:=T#10S,n Max Parallel Requests:=255); fb Device : FB_BACnet RM_Device := (Client:=fb Client); fb Write Ex : FB_BACnet RM_Write Property Ex := (Client := fb Client); b Write Oo SEx : BOOL; b Outof Service Ex : BOOL; END_VAR ------------------------------------------------------------------ fb Client(); fb Device(); // Write Out Of Service using FB_BACnet RM_Write Property Ex fb Write Ex.b Execute := b Write Oo SEx; IF fb Write Ex.b Execute THEN b Write Oo SEx := FALSE; fb Write Ex.p Data:= ADR( b Out Of Service Ex ); fb Write Ex.n Data:= SIZEOF( b Out Of Service Ex ); fb Write Ex.e Prop ID:= E_BACnet_Property Identifier. Prop Out Of Service; fb Write Ex.n Obj Inst:= 1; fb Write Ex.e Obj Type:= E_BACnet_Object Type. Obj Binary Output; END_IF fb Write Ex(); 7.11 Monitoring a client connection To monitor a client connection, it is necessary to call the FB_BACnet RM_Device function block cyclically. The current status of the connection can be taken from the FB_BACnet_Client function block. If the connection is interrupted, e.g. by disconnecting the peer device or by a defective network cable, the BACnet supplement attempts to re-establish the connection. If after these attempts (variable n Error Cnt in function block FB_BACnet RM_Device) the connection is still interrupted, it is assumed that the device or the network connection is no longer present. This process may take 30 seconds or longer to safely detect the interrupted connection. In this case the variable e Sys State of the FB_BACnet RM_Device takes the value e No Communication and b Operational is set to FALSE. The variables b Ready and b Connected of the function block FB_BACnet_Client are set to FALSE, the variable e State takes the value e Init. The BACnet supplement continues to attempt to connect to the peer device. Once the connection is re- established, the state machine behaves as it did when it was first started. 98 Version: 1.1.2 TF8020
## Page 99

Programming a BACnet client 7.11.1 Example: Connection is successfully established FB_BACnet_Client FB_BACnet RM_Device TF8020 Version: 1.1.2 99
## Page 100

Programming a BACnet client 7.11.2 Example: Connection is interrupted FB_BACnet_Client FB_BACnet RM_Device 100 Version: 1.1.2 TF8020
## Page 101

Programming a BACnet client 7.12 Use of Read Property Multiple If several properties are to be read from a connected BACnet device, it is recommended to use the service Read Property Multiple (RPM). In contrast to the use of the Read Property service, which can only read individual properties, Read Property Multiple combines several queries into one telegram and therefore works considerably more efficiently. The following example shows the use of RPM. However, it requires that connected devices support this service. The three read commands shown in this example are combined into a single RPM. Variables {attribute 'Tc Link To' := '. BACnet_Ams Net Id := TIID^Device 1 (BACnet MSTP)^Inputs^Ams Net Id'} fb Mstp Device_1 : FB_BACnet_Adapter; fb Client : FB_BACnet_Client := (Adapter := fb Mstp Device_1,n Device Instance := 116005, t Read Cycle Time:=T#10S, n Max Parallel Requests:=20); fb Device : FB_BACnet RM_Device := (Client:=fb Client); fb Ton : TON; fb Read Ex1 : FB_BACnet RM_Read Property Ex := (Client := fb Client); fb Read Ex2 : FB_BACnet RM_Read Property Ex := (Client := fb Client); fb Read Ex3 : FB_BACnet RM_Read Property Ex := (Client := fb Client); b Read : BOOL; f PVSupply Temp : REAL; f PVReturn Temp : REAL; f Design Flow : REAL; Code fb Mstp Device_1(); fb Client(); fb Device(); fb Ton( IN:= NOT fb Ton. Q, PT:= T#5S ); IF fb Ton. Q THEN b Read := TRUE; END_IF fb Read Ex1.b Execute := b Read; fb Read Ex2.b Execute := b Read; fb Read Ex3.b Execute := b Read; IF b Read THEN b Read := FALSE; fb Read Ex1.p Data:= ADR( f PVSupply Temp ); fb Read Ex1.n Data:= SIZEOF( f PVSupply Temp ); fb Read Ex1.e Prop ID:= E_BACnet_Property Identifier. Prop Present Value; fb Read Ex1.n Obj Inst:= 1; fb Read Ex1.e Obj Type:= E_BACnet_Object Type. Obj Analog Input; fb Read Ex2.p Data:= ADR( f PVReturn Temp ); fb Read Ex2.n Data:= SIZEOF( f PVReturn Temp ); fb Read Ex2.e Prop ID:= E_BACnet_Property Identifier. Prop Present Value; fb Read Ex2.n Obj Inst:= 2; fb Read Ex2.e Obj Type:= E_BACnet_Object Type. Obj Analog Input; fb Read Ex3.p Data:= ADR( f Design Flow ); fb Read Ex3.n Data:= SIZEOF( f Design Flow ); fb Read Ex3.e Prop ID:= E_BACnet_Property Identifier. Prop Present Value; fb Read Ex3.n Obj Inst:= 0; fb Read Ex3.e Obj Type:= E_BACnet_Object Type. Obj Analog Value; END_IF fb Read Ex1(); fb Read Ex2(); fb Read Ex3(); TF8020 Version: 1.1.2 101
## Page 102

Dynamic Object Manager 8 Dynamic Object Manager Using the Dynamic Object Manager allows to create or delete BACnet objects at runtime. To use this feature, the pragma “Dynamic Creation” needs to be set in the compiler settings as shown below: 8.1 FB_BACnet_Dyn Object Manager The FB_BACnet_Dyn Object Manager provides the ability to dynamically create or delete objects at runtime. Typical use cases are local visualizations or the creation of BACnet objects based on configuration files. It is possible to use the Dynamic Object Manager together with statically created objects. However, please note that the object instance numbers must be unique! 8.2 Cyclic calls The Dynamic Object Manager and all dynamically created objects must be called cyclically (like all other objects once and only once per cycle). Setting the b Cycle Objects := TRUE flag enables cyclic calls of the created objects. In this case, no further cyclic calls may be made (except calling the instance of FB_BACnet_Dyn Object Manager). 8.3 Predefined object pool Dynamic objects are created with the __NEW operator. If the number of objects to be created is known or can be estimated at the time of the first PLC start, the library provides a predefined object pool. This is more memory efficient than using the __NEW operator. The elements named n Pool_XX in the BACnet_Param section of the library GVLs can be set up to save resources. 102 Version: 1.1.2 TF8020
## Page 103

Dynamic Object Manager For example, if 42 instances of a FB_BACnet_AV are used, the variable n Pool AV can be set to 42 as the default value. If more objects are created than are available in the pool, the creation process will continue to use the __NEW operator. 8.4 Example The following code shows how to use the dynamic creation/deletion feature. Variables: PROGRAM DYN_OBJECTS VAR fb Dyn Object : FB_BACnet_Dyn Object Manager := (b Cycle Objects := TRUE); b Create : BOOL; b Delete : BOOL; Dyn View : POINTER TO FB_BACnet_View; Dyn AV01 : POINTER TO FB_BACnet_AV; Dyn BV01 : POINTER TO FB_BACnet_BV; n Counter : UDINT; END_VAR Code: // Management FB has to be called in every cycle fb Dyn Object(); IF (fb Dyn Object. Ready) THEN IF (b Create) THEN b Create := FALSE; // [Variant 1] Create standard object types: IF (fb Dyn Object. Create Object( Dyn View, E_BACnet_Create Obj Type.e Structured View, BACnet_Globals.n BACnet Inst Id_Auto, 'Dyn View', 'Dynamic View', 0)) THEN // [Optional] set object properties... END_IF IF (fb Dyn Object. Create Object( Dyn AV01, E_BACnet_Create Obj Type.e Analog Value, BACnet_Globals.n BACnet Inst Id_Auto, '\/Dyn AV01', '\/Dynamic AV 1', Dyn View)) THEN // [Optional] set object properties... Dyn AV01^.e Unit := E_BA_Unit.e Temperature_Degrees Celsius; END_IF IF (fb Dyn Object. Create Object( Dyn BV01, TF8020 Version: 1.1.2 103
## Page 104

Dynamic Object Manager E_BACnet_Create Obj Type.e Binary Value, BACnet_Globals.n BACnet Inst Id_Auto, '\/Dyn BV01', '\/Dynamic BV 1', Dyn View)) THEN // [Optional] set object properties... Dyn BV01^.s Inactive Text := 'Off'; Dyn BV01^.s Active Text := 'On'; END_IF END_IF IF (b Delete) THEN b Delete := FALSE; // [Variant 1] Delete all objects conveniently via object manager: fb Dyn Object. Reset(); // [Variant 2] Delete all objects manually: (* fb Dyn Object. Delete Object(Dyn AV01); fb Dyn Object. Delete Object(Dyn BV01); fb Dyn Object. Delete Object(Dyn View); *) END_IF // Sample PLC code: // > Take care of valid object pointers! IF (fb Dyn Object. Created Objects > 0) THEN n Counter := (n Counter+1); // Simulate changing value: Dyn AV01^.b En Pgm := TRUE; Dyn AV01^.f Val Pgm := (TO_REAL(n Counter MOD 1000)/100); // [Variant 2] Call created objects manually IF (NOT fb Dyn Object.b Cycle Objects) THEN Dyn View^(); Dyn AV01^(); Dyn BV01^(); END_IF END_IF END_IF 8.5 Complete initialization of the dynamic objects The initialization of the dynamically created objects is usually done automatically a few cycles after the last object was created. If, however, the initialization is to be completed by PLC program (because, for example, reading out a configuration file could take longer), the Dynamic Object Manager can be called in such a way that the end of the initialization takes place from the PLC program. For this purpose, the second parameter b Auto Finish Init must be set to the value FALSE, e.g. fb Dyn Mngr : FB_BACnet_Dyn Object Manager := (b Cycle Objects := TRUE, b Auto Finish Init := FALSE); To complete the initialization, the method Finish Init must then be called, e.g. fb Dyn Mngr. Finish Init(); 8.6 Creating and deleting own BACnet function blocks (FB) If own BACnet FBs are to be instantiated in addition to the FBs available in the Tc3_BACnet Rev14 library, these must be deleted in a method FB_exit when the PLC program is terminated so that the dynamically allocated memory is released again. Dynamically created FB instances of function blocks from the Tc3_BACnet Rev14 library are automatically deleted and removed from the memory via the method FB_exit of the Dynamic Object Manager. The following example shows the dynamic creation of FB instances of own FBs (the implementations themselves are not shown in this example) as well as the deletion of these instances in the method FB_exit. 104 Version: 1.1.2 TF8020
## Page 105

Dynamic Object Manager Care must be taken to ensure that the correct type of FB is used for the enable. Variable MAIN PROGRAM MAIN VAR fb Dyn Obj : FB_DYN_OBJECTS; END_VAR Code MAIN fb Dyn Obj(); Variables FB_Dyn Obj FUNCTION_BLOCK FB_DYN_OBJECTS VAR Dyn Mgmt : FB_BACnet_Dyn Object Manager := (b Cycle Objects := TRUE, b Auto Finish Init := FALSE); b Create : BOOL := TRUE; b Delete : BOOL; Test Fb BVOwn : POINTER TO FB_BACnet_BV_Event; Test Fb AVOwn : POINTER TO FB_BACnet_AV_Event Setp; END_VAR Code FB_Dyn Obj Dyn Mgmt(); IF (Dyn Mgmt. Ready) THEN IF (b Create) THEN b Create := FALSE; Test Fb BVOwn := __NEW( FB_BACnet_BV_Event ); IF (Dyn Mgmt. Create Object Ex(Test Fb BVOwn, BACnet_Globals.n BACnet Inst Id_Auto, '\/Test BV own', '\/Test BV own', 0)) THEN // Initialize properties: Test Fb BVOwn^.s Inactive Text := 'AUS'; Test Fb BVOwn^.s Active Text := 'EIN'; END_IF Test Fb AVOwn := __NEW( FB_BACnet_AV_Event Setp ); IF (Dyn Mgmt. Create Object Ex(Test Fb AVOwn, BACnet_Globals.n BACnet Inst Id_Auto, '\/Test Event own', '\/Test Event own', 0)) THEN // Initialize properties: Test Fb AVOwn^.f High Limit := 470; Test Fb AVOwn^.f Low Limit := -100; END_IF Dyn Mgmt. Finish Init(); END_IF IF (b Delete) THEN b Delete := FALSE; FB_exit(FALSE); END_IF END_IF Variables of the FB_Dyn Obj. FB_exit method METHOD FB_exit : BOOL VAR_INPUT b In Copy Code : BOOL; // if TRUE, the exit method is called for exiting an instance that is copied afterwards (online change). END_VAR Code of the FB_Dyn Obj. FB_exit method Dyn Mgmt. Remove Object Ex(Test Fb AVOwn); __DELETE(Test Fb AVOwn); Dyn Mgmt. Remove Object Ex(Test Fb BVOwn); __DELETE(Test Fb BVOwn); TF8020 Version: 1.1.2 105
## Page 106

Samples 9 Samples 9.1 Variable Declaration The default values of the BACnet properties should be specified in the variable declaration and should only be written conditionally at runtime (so that write access by BACnet is still possible). In the following example, the Description property is modified at runtime. To use the BACnet Engineering Unit (unit of measurement) the library Tc3_BA2_Common must be included. Variables fb Av : FB_BACnet_AV := ( s Object Name := 'X51LU01x AMH_-SW31', s Description := 'Setpoint Variable Ventilator', e Unit := E_BA_Unit.e Pressure_Pascals, f Relinquish Default := 250 ); b Description Changed : BOOL; Code if b Description Changed then fb AV.s Description := 'TEST'; b Description Changed := FALSE; END_IF fb Av(); 9.2 BACnet properties This example shows the presetting of further BACnet properties, such as the status texts or Change-of- Value settings (COV). Also shown is how function blocks can be called using a for loop. For multistate objects, the number of stages is defined via the stage texts (Property State_Text). The default value is a limit of 12 states. This number can be changed in the Global Variables in the parameter list BACnet_Param. Variables // optional unit, range and COV properties fb Ai : FB_BACnet_AI := ( e Unit := E_BA_Unit.e Temperature_Degrees Celsius, f Cov Increment := 2.0, f Min Pres Value := 0.0, f Max Pres Value := 100.0 ); // optional state text information fb Bi : FB_BACnet_BI := ( s Inactive Text := 'DOWN', s Active Text := 'UP' ); // number of states determined by a State Text fb Mi : FB_BACnet_MI := ( a State Text := ['AUTO', 'Low', 'Medium', 'High', 'Turbo'] ); // array of BACnet FBs afb AV : ARRAY[0..499] of FB_BACnet_AV; n Count : INT; Code fb Ai(); fb Bi(); fb Mi(); FOR n Count := 0 to 499 do 106 Version: 1.1.2 TF8020
## Page 107

Samples afb AV[n Count](); END_FOR 9.3 Link with the 'Tc Link To' attribute This example shows how the 'Tc Link To' attribute can be used for linking with Ether CAT or K-bus terminals. The FB variants with the suffix IO (K-bus) and ECAT (Ether CAT Terminals) are available. The 'Tc Link To OSO' attribute in the EL3068 terminal example also shows how the underrange and overrange states can be mapped to the terminal channel state (n Raw State). In general, the state of the terminal channel is mapped via the variable n Raw State. The variable n Raw ECat State is used to additionally map the Ether CAT status of the communication with the terminal. The TIID path can be taken from the properties of the respective terminal channel in the development environment and copied from there. Variables // general structured view object View : FB_BACnet_View := (s Object Name:='Io Bus_0_Device_3_Ether CAT'); // Ether CAT terminals (* Term 2 (EL1809) *) {attribute 'Tc Link To' := '.b Raw Val :=TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 2 (EL1809)^Channel 1^Input; .n Raw ECat State:=TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 2 (EL1809)^Info Data^State'} Term_2_EL1809_Chn1 : FB_BACnet_BI_ECAT := (i Parent:=View, s Object Name:='Term_2_EL1809_Chn1', n Io Bus Nr:=0, s Device Type:='EL1809 16Ch. Dig. Input 24V, 3ms'); (* Term 3 (EL2809) *) {attribute 'Tc Link To' := '.b Raw Val :=TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 3 (EL2809)^Channel 1^Output; .n Raw ECat State:=TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 3 (EL2809)^Info Data^State'} Term_3_EL2809_Chn1 : FB_BACnet_BO_ECAT := (i Parent:=View, s Object Name:='Term_3_EL2809_Chn1', n Io Bus Nr:=0, s Device Type:='EL2809 16Ch. Dig. Output 24V, 0.5A'); (* Term 4 (EL3068) *) {attribute 'Tc Link To' := '.n Raw Val :=TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 4 (EL3068)^AI Standard Channel 1^Value; .n Raw ECat State:=TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 4 (EL3068)^Info Data^State'} {attribute 'Tc Link To OSO' := '.n Raw State:=<0,1,0>TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 4 (EL3068)^AI Standard Channel 1^Status^Underrange; .n Raw State:=<1,1,0>TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 4 (EL3068)^AI Standard Channel 1^Status^Overrange'} Term_4_EL3068_Chn1 : FB_BACnet_AI_ECAT := (i Parent:=View, s Object Name:='Term_4_EL3068_Chn1', n Io Bus Nr:=0, s Device Type:='EL3068 8Ch. Ana. Input 0-10V'); (* Term 5 (EL4132) *) {attribute 'Tc Link To' := '.n Raw Val :=TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 5 (EL4132)^Channel 1^Output; .n Raw ECat State:=TIID^Device 3 (Ether CAT)^Term 1 (EK1100)^Term 5 (EL4132)^Info Data^State'} Term_5_EL4132_Chn1 : FB_BACnet_AO_ECAT := (i Parent:=View, s Object Name:='Term_5_EL4132_Chn1', n Io Bus Nr:=0, s Device Type:='EL4132 2Ch. Ana. Output +/-10V'); // Bus Terminals (K-Bus) (* Term 2 (KL1104) *) {attribute 'Tc Link To' := '.b Raw Val :=TIID^Device 3 (Ether CAT)^Box 6 (BK1150)^Term 2 (KL1104)^Channel 1^Input'} Term_2_KL1104_Chn1 : FB_BACnet_BI_IO := (i Parent:=View, s Object Name:='Term_2_KL1104_Chn1', n Io Bus Nr:=0, s Device Type:='KL 1104, 4 Ch. Input (24V, 3.0ms)'); (* Term 3 (KL2408) *) {attribute 'Tc Link To' := '.b Raw Val :=TIID^Device 3 (Ether CAT)^Box 6 (BK1150)^Term 3 (KL2408)^Channel 1^Output'} Term_3_KL2408_Chn1 : FB_BACnet_BO_IO := (i Parent:=View, s Object Name:='Term_3_KL2408_Chn1', n Io Bus Nr:=0, s Device Type:='KL 2408, 8 Ch. Output (24V, 0.5 A, 3 A max)'); (* Term 4 (KL3208-0010-4) *) {attribute 'Tc Link To' := TF8020 Version: 1.1.2 107
## Page 108

Samples '.n Raw Val :=TIID^Device 3 (Ether CAT)^Box 6 (BK1150)^Term 4 (KL3208-0010-4)^Channel 1^Data In; .n Raw State:=TIID^Device 3 (Ether CAT)^Box 6 (BK1150)^Term 4 (KL3208-0010-4)^Channel 1^State'} Term_4_KL3208_0010_4_Chn1 : FB_BACnet_AI_IO := (i Parent:=View, s Object Name:='Term_4_KL3208_0010_4_Chn1', n Io Bus Nr:=0, s Device Type:='KL 3208-0010, 4 of 8 Ch. ana. Input PT1000, Ni1000 (RTD)'); (* Term 6 (KL4022) *) {attribute 'Tc Link To' := '.n Raw Val :=TIID^Device 3 (Ether CAT)^Box 6 (BK1150)^Term 6 (KL4022)^Channel 1^Data Out'} Term_6_KL4022_Chn1 : FB_BACnet_AO_IO := (i Parent:=View, s Object Name:='Term_6_KL4022_Chn1', n Io Bus Nr:=0, s Device Type:='KL 4022, 2 Ch. ana. Output (4...20m A)'); Code View(); Term_2_EL1809_Chn1(); Term_3_EL2809_Chn1(); Term_4_EL3068_Chn1(); Term_5_EL4132_Chn1(); Term_2_KL1104_Chn1(); Term_3_KL2408_Chn1(); Term_4_KL3208_0010_4_Chn1(); Term_6_KL4022_Chn1(); 9.4 Property selection and write protection This example shows how properties of BACnet objects can be write-protected. Furthermore, the example shows how unneeded properties can be removed from objects. By default, all properties (which may be writeable according to the BACnet standard) are executed as writeable. All properties possible in the respective object type are also included. Properties that are to be read-only are listed in the array a Write Protected. Properties that are not used and thus should be removed from the object are listed in the array a Disabled. Related properties (these are marked in the standard with a footnote of the same name) must be present in their entirety or removed in their entirety. In the example below, the properties Change Of State Count, Change Of State Time and Time Of State Count Reset are disabled. Variables fb Bi : FB_BACnet_BI := ( s Object Name := 'Example Binary Input Object', s Description := 'Objectname and Description properties are read-only', st Settings := ( a Disabled := [ E_BACnet Prop Identifier. Prop Change Of State Count, E_BACnet Prop Identifier. Prop Change Of State Time, E_BACnet Prop Identifier. Prop Time Of State Count Reset ], a Write Protected := [ E_BACnet Prop Identifier. Prop Object Name, E_BACnet Prop Identifier. Prop Description ] ) ); Code fb Bi(); 9.5 Priority controller This example shows the use of the function blocks ending with _5P (5 priorities). From the available 16 priorities of the BACnet standard, 5 priorities were selected, which are sufficient for building automation projects in most cases: 108 Version: 1.1.2 TF8020
## Page 109

Samples Life Safety (1): For example, emergency shutdown Critical Equipment Control (5): For example, frost protection Manual Local Operator (7): For example on-site operation at the control cabinet Manual Operator (8): For example operator at the BACnet management and operating level PLC (15): Priority of the PLC program The number in brackets indicates the default value of the priority. This can be changed globally in the BACnet_Param section of the Tc3_BACnet Rev14 library. The following boolean flags are available for controlling the priority: b En Sfty: Override of the Life Safety priority by the PLC program. The value is given by the variables f Val Sfty (analog), b Val Sfty (binary) and n Val Sfty (multistate). b En Crit: Override of the critical equipment priority. The value is given by the variables f Val Crit (analog), b Val Crit (binary) and n Val Crit (multistate). b En Man Loc: Override of the manual operator priority. The value is given by the variables f Val Man Loc (analog), b Val Man Loc (binary) and n Val Man Loc (multistate). b En Pgm: PLC priority override. The value is given by the variables f Val Pgm (analog), b Val Pgm (binary) and n Val Pgm (multistate). b En Manual Operator: Override of the operator priority. The value is given by the variables f Val Manual Operator (analog), b Val Manual Operator (binary) and n Val Manual Operator (multistate). This priority level is used in BACnet projects for access by the MBE (management operating equipment) and should therefore only be used if this access is not to be made on the part of BACnet or in the absence of an MBE. Variables // Analog objects supporting 5 priorities fb AO5P : FB_BACnet_AO_5P; fb AOIO5P : FB_BACnet_AO_IO5P; fb AORaw5P : FB_BACnet_AO_RAW5P; fb AV5P : FB_BACnet_AV_5P; // Binary objects supporting 5 priorities fb BO5P : FB_BACnet_BO_5P; fb BOIO5P : FB_BACnet_BO_IO5P; fb BORaw5P : FB_BACnet_BO_RAW5P; fb BV5P : FB_BACnet_BV_5P; // Multistate objects supporting 5 priorities fb MO5P : FB_BACnet_MO_5P; fb MOIO5P : FB_BACnet_MO_IO5P; fb MORaw5P : FB_BACnet_MO_RAW5P; fb MV5P : FB_BACnet_MV_5P; Code fb AO5P(); fb AOIO5P(); fb AORaw5P(); fb AV5P(); fb BO5P(); fb BOIO5P(); fb BORaw5P(); fb BV5P(); fb MO5P(); fb MOIO5P(); fb MORaw5P(); // example access to critical equipment control priority fb MV5P.b En Crit := TRUE; TF8020 Version: 1.1.2 109
## Page 110

Samples fb MV5P.n Val Crit := 3; // select state no. 3 fb MV5P(); 9.6 Reset priorities In some cases it may be necessary to reset priority levels described via BACnet from the PLC or visualization (i.e. write the value NULL to this priority level). This can be done on the server side with the call Write Property Null. It should be noted that for binary objects, priority level 6 is reserved for the minimum switch-on and switch-off times and therefore cannot be written. Variables fb BV : FB_BACnet_BV; n Count : INT; b Empty Prio Array : BOOL; n Ret : DINT; Code fb BV(); IF b Empty Prio Array THEN b Empty Prio Array := FALSE; FOR n Count := 1 TO 16 DO IF n Count = 6 THEN CONTINUE; END_IF n Ret := fb BV. Write Property Null( E_BACnet Prop Identifier. Prop Present Value, b Prio := TO_BYTE( n Count) ); END_FOR END_IF 9.7 Control loops and loop objects For the mapping of control loops the BACnet standard provides the Loop object. The control parameters, such as P, I, D, limits of the control range or the operating direction are passed on to the controller function block as properties of the loop object type. The type of the controller itself is not specified in the BACnet standard. The library Tc3_BA2_Common contains the implementation of the PID controller (FB_BA_PIDCtrl), which is mapped via the function blocks FB_BACnet_Loop and FB_BACnet_Loop Ref respectively. FB_BACnet_Loop implements a controller whose setpoint, output value and actual value are mapped via function block-internal variables. FB_BACnet_Loop Ref uses a reference to an Analog Value object as the setpoint, a reference to an Analog Output object as the output value, and a reference to an Analog Input object for the actual value. While the function block type FB_BACnet_Loop is sufficient for most applications, the function block type FB_BACnet_Loop Ref allows the operator of the management and operating level to access the controller values (setpoint, output value and actual value) via BACnet. However, this increases the number of BACnet objects per control loop to 4. The following examples show the realization of a PI controller. Variables // control loop using internal variables fb Loop Internal : FB_BACnet_Loop := ( b En := TRUE, s Description := 'Loop using internal control parameters', e Output Unit := E_BA_Unit.e Other_Percent, e Action := E_BA_Action.e Reverse, f Proportional Constant := 5.0, f Integral Constant := 180, f Setpoint := 20 ); f Ctrl Val : REAL := 18; 110 Version: 1.1.2 TF8020
## Page 111

Samples // control loop using external BACnet objects fb Loop Ref_Setpt : FB_BACnet_AV_Setp := ( f Value := 20 ); fb Loop Ref_Ctrl Var : FB_BACnet_AI := ( f Val := 18 ); fb Loop Ref_Y : FB_BACnet_AO := (); fb Loop Ref : FB_BACnet_Loop_Ref := ( b En := TRUE, s Description := 'Loop using reference objects', st Controlled Variable Reference := F_BACnet_Reference( fb Loop Ref_Ctrl Var, Prop Present Value), st Setpoint Reference := F_BACnet_Reference( fb Loop Ref_Setpt, Prop Present Value), st Manipulated Variable Reference := F_BACnet_Reference( fb Loop Ref_Y, Prop Present Value), e Output Unit := E_BA_Unit.e Other_Percent, e Action := E_BA_Action.e Reverse, f Proportional Constant := 5.0, f Integral Constant := 180 ); Code // internal control loop fb Loop Internal.f Ctrl Var := f Ctrl Val; fb Loop Internal(); // control loop using external object references fb Loop Ref_Setpt(); fb Loop Ref_Ctrl Var(); fb Loop Ref_Y(); fb Loop Ref(); 9.8 Set up alarm receiver BACnet allows alarm receivers (e.g. the MBE) to register in one or more Notification Class objects in the recipient list (Recipientlist). If the receivers are already defined at the time of PLC programming, they can also be specified by the PLC program. Either the Device instance number can be used as a reference to the receiver. In this case Twin CAT resolves the actual address with a Who-Is telegram (the response I-Am of the receiver contains the actual address). Alternatively, this address can be specified directly in the recipient list, but this option is rarely used in practice. The following example shows a Notification Class NC1 without receiver specifications (i.e. the receivers register themselves via BACnet). Notification Class 2 contains an example of a receiver referenced by the Device instance number as well as a receiver referenced by the IP address, UDP port and BACnet network number. The order of the alarm types in the arrays a Event Enable and a Event Message Texts Config as well as a Ack Required and a Priority corresponds to the order in the BACnet standard: TO_OFFNORMAL: Coming alarm / event TO_FAULT: Sensor error, encoder malfunction TO_NORMAL: Return to normal range Variables // simple Notification class object with empty recipient list fb BV1 : FB_BACnet_BV := ( n Notification Class := 1, a Event Enable := [TRUE,TRUE,TRUE], b Alarm Value := TRUE, TF8020 Version: 1.1.2 111
## Page 112

Samples a Event Message Texts Config := [ 'ALARM', 'FAULT', 'NORMAL' ] ); fb NC01_Standard : FB_BACnet_NC := ( n Object Instance := 1, n Notification Class := 1, s Description := 'NC01 Standard', a Ack Required := [ TRUE, TRUE, FALSE ], a Priority := [ 10, 11, 12 ] ); // Notification class object with pre-defined recipient (Notification Sink module) fb BV2 : FB_BACnet_BV := ( n Notification Class := 2, a Event Enable := [TRUE,TRUE,TRUE], b Alarm Value := TRUE ); fb NC02_Recipient : FB_BACnet_NC := ( n Object Instance := 2, n Notification Class := 2, s Description := 'NC02 Recipient Test', a Ack Required := [ TRUE, TRUE, TRUE ], a Priority := [ 224, 223, 222 ], a Recipient List := [ ( st Valid Days := (b Monday:=TRUE, b Tuesday:=TRUE, b Wednesday:=TRUE, b Thursday:=TRUE, b Friday:=TRUE), st From Time := F_BA_To STTime(T#0H), st To Time := F_BA_To STTime(T#23H59M59S), st Recipient := F_BACnet_Device Recipient(n Device Instance:=42), n Process Id := 10000, // Notification Sink module b Issue Confirmed := FALSE, st Event Transitions := (b To Off Normal:=TRUE, b To Fault:=TRUE, b To Normal:=TRUE ) ), ( st Valid Days := (b Sunday:=TRUE, b Saturday:=TRUE), st From Time := F_BA_To STTime(T#7H), st To Time := F_BA_To STTime(T#15H30M), st Recipient := F_BACnet_Ethernet Recipient( n IPAddress1:=192,168,10,200, n Port:=47808, n Network Nr:=444 ), n Process Id := 30100, b Issue Confirmed := TRUE, st Event Transitions := (b To Off Normal:=TRUE) ) ] ); Code fb BV1(); fb NC01_Standard(); fb BV2(); fb NC02_Recipient(); 9.9 Receiving alarms and events from other devices This example shows the use of an Eventlog object as a receiver for alarms and events of an external BACnet device. The Eventlog object of the alarm receiver is entered in the notification class of the alarm transmitter. The assignment is made via the process identifier. Device 1: Alarm transmitter Variables // Notification Class object in the alarm generating device fb NC01 : FB_BACnet_NC := ( n Object Instance := 1, n Notification Class := 1, s Description := 'NC01', a Ack Required := [ TRUE, TRUE, TRUE ], a Priority := [ 224, 223, 222 ], a Recipient List := 112 Version: 1.1.2 TF8020
## Page 113

Samples [ ( st Valid Days := ( b Monday:=TRUE, b Tuesday:=TRUE, b Wednesday:=TRUE, b Thursday:=TRUE, b Friday:=TRUE, b Saturday:=TRUE, b Sunday:=TRUE ), st From Time := F_BA_To STTime(T#0H), st To Time := F_BA_To STTime(T#23H59M59S), st Recipient := F_BACnet_Device Recipient(n Device Instance:=12345), n Process Id := 42, b Issue Confirmed := FALSE, st Event Transitions := (b To Off Normal:=TRUE, b To Fault:=TRUE, b To Normal:=TRUE) ) ] ); Device 2: Alarm receiver (Device 12345) Variables fb ELog Buf : FB_BACnet_ELog Buf := ( s Object Name := 'Event Log for external alarms', b Log Enable := TRUE, n Process Id := 42 ); 9.10 Prewarning limits With the help of the Event Enrollment object BACnet allows the monitoring of properties from BACnet objects. A typical application in building automation is prewarning limits, which draw attention to an alarm that may follow later. The following example shows how the object-internal alarm detection (Instrinsic Reporting) is combined with an additional pair of prewarning limits (Algorithmic Change Reporting) and how these states (prewarning and alarm) can be reported via two different Notification Class objects. Here, the BACnet object fb AV, whose Present Value is specified from the REAL variable f Real Value, serves as the trigger for the warnings and alarms. Variables f Real Value : REAL := 50; // Analog Value object using Intrinsic Reporting fb Av : FB_BACnet_AV := ( s Object Name := 'AV using Intr. Reporting', a Event Enable := [ TRUE, TRUE, TRUE ], e Notify Type := E_BACnet_Notify Type.e Alarm, b Low Limit Enable := TRUE, f Low Limit := 15.0, b High Limit Enable := TRUE, f High Limit := 87.0, f Deadband := 3, n Time Delay := 2, // waits 2 seconds before TO_OFFNORMAL n Time Delay Normal := 4, // wait 4 seconds before TO_NORMAL b Event Detection Enable := TRUE, n Notification Class := 10, // alarm class a Event Message Texts Config := [ 'Alarm', 'Fault', 'Warning' ], b En Pgm := TRUE, e Unit := E_BA_Unit.e Other_Percent ); // Additional warning limits using Algorithmic Change Reporting fb EE : FB_BACnet_EE := ( s Object Name := 'Event Enrollment', n Notification Class := 20, e Notify Type := E_BACnet_Notify Type.e Notify Event, a Event Enable := [ TRUE, TRUE, TRUE ], a Event Message Texts Config := [ 'Warning', 'Fault', 'Normal' ], st Event Parameter := ( TF8020 Version: 1.1.2 113
## Page 114

Samples e Event Type := E_BACnet_Event Type.e Out Of Range, st Event Args := ( st Out Of Range := ( n Time Delay := 0, f Low Limit := 25.0, f High Limit := 82.0, f Deadband := 0.0 ) ) ), st Object Property Reference := F_BACnet_Reference(fb Av,Prop Present Value) ); // Notification Classes 10=alarms, 20=warnings fb NC10 : FB_BACnet_NC := ( s Object Name := 'NC10', s Description := 'Alarms', n Object Instance := 10, n Notification Class := 10, a Ack Required := [ TRUE, TRUE, TRUE ], a Priority := [ 10, 11, 12 ] ); fb NC20 : FB_BACnet_NC := ( s Object Name := 'NC20', s Description := 'Warnings', n Object Instance := 20, n Notification Class := 20, a Ack Required := [ FALSE, TRUE, FALSE ], a Priority := [ 100, 110, 120 ] ); Code fb Av.f Val Pgm := f Real Value; fb Av(); fb EE(); fb NC10(); fb NC20(); 9.11 Calendar and schedule functions For the implementation of schedule functions the BACnet standard provides the schedule object. It allows the use of recurring weekly programs (Weekly_Schedule) as well as the definition of exceptions (Exception_Schedule). Exceptions can either be entered directly in the schedule object or these are determined on the basis of a Calendar object (which must be located in the same device). A single date, a date range or a combined type of day, week and month can be used to specify an exception. The weekly schedule is noted using the array a Week. Calendar-based exceptions are noted using the array a Calendar. Exceptions contained directly in the schedule are noted using the array a Exception. Help functions are available for specifying the dates, e.g. F_BA_Date Val. For dates, according to the BACnet standard, the year starts from 1900. The Month element can contain odd (13) and even (14) months in addition to the regular month information. The day of the month may include odd (33) and even (34) days of the month in addition to the regular day information, as well as the last day (32) of the month. When specifying specific dates, it is important that the day of the week matches the specified date. Functions are also available for defining the time/value pairs of the schedule, e.g. F_BACnet_Sched Weekly3x A. Here, 3x indicates the number (3 entries). The indicator A stands for analog values (REAL), the indicator B for binary values (BOOL) and M for multistate states (integer). If the schedule is to directly influence one or more properties from BACnet objects, these references can be specified in the a Object Property References element. If this specification is missing, an empty list is created in the property Listof Object Property References and the schedule does not access external objects/ properties. This can be used if the state of the schedule is to be monitored within the PLC, but no BACnet objects are to be directly influenced. 114 Version: 1.1.2 TF8020
## Page 115

Samples Variables // Calendar object examples fb CAL01 : FB_BACnet_Cal := ( s Object Name := 'Calendar 1', s Description := 'demonstrates a date-list for each choice', a Date List := [ ( e Type := E_BA_Date Val Choice.e Date, u Date := F_BA_Date Val(2021,E_BA_Month.e January,19) ), ( e Type := E_BA_Date Val Choice.e Date Range, u Date := F_BA_Date Range Val(n From Year:=2021,E_BA_Month.e January,19, n To Year:=2021,E_BA_Month.e January,21) ), ( e Type := E_BA_Date Val Choice.e Week NDay, u Date := F_BA_Week NDay Val(E_BA_Weekday.e Friday, E_BA_Week.e Week1, E_BA_Month.e February) ) ] ); fb CAL02 : FB_BACnet_Cal := ( s Object Name := 'Calendar 2' ); fb CAL03 : FB_BACnet_Cal := ( s Object Name := 'Calendar 3' ); // schedule object for analog scheduling fb Analog Output : FB_BACnet_AO; fb Sched A : FB_BACnet_Sched A := ( s Object Name := 'Schedule Analog', a Object Property References := [ (i Object := fb Analog Output, e Property Id := Prop Present Value) ], a Week := F_BACnet_Sched Weekly3x A(E_BA_Weekday.e Monday, E_BA_Weekday.e Friday, T#0H, 0.0, T#6H, 5.0, T#20H, 0.0), a Calendar := [( i Ref Calendar := fb CAL01, a Entry := F_BACnet_Sched Entry1x A(T#0H, 2.0) ), ( i Ref Calendar := fb CAL02, a Entry := F_BACnet_Sched Entry1x A(T#10H, 3.4) ), ( i Ref Calendar := fb CAL03, a Entry := F_BACnet_Sched Entry3x A(T#0H, 5, T#6H, 7, T#20H, 8) )], a Exception := [ ( e Type := E_BA_Date Val Choice.e Date, u Date := F_BA_Date Val(2020,E_BA_Month.e April,10), a Entry := F_BACnet_Sched Entry1x A(T#0H, 0.0) ), ( e Type := E_BA_Date Val Choice.e Date Range, u Date := F_BA_Date Range Val(n From Year:=2020,E_BA_Month.e April,10, n To Year:=2021,E_BA_Month.e May,11), a Entry := F_BACnet_Sched Entry3x A(T#0H, 0.0, T#6H, 5.0, T#20H, 0.0) ), ( e Type := E_BA_Date Val Choice.e Week NDay, u Date := F_BA_Week NDay Val(E_BA_Weekday.e Friday, E_BA_Week.e Week1, E_BA_Month.e February), a Entry := F_BACnet_Sched Entry3x A(T#0H, F_BA_Null A(), T#6H, 5.0, T#20H, F_BA_Null A()) ), ( e Type := E_BA_Date Val Choice.e Date, u Date := F_BA_Date Val(2019,E_BA_Month.e June,20), a Entry := [ ( e State := E_BA_Sched Entry State.e Value, st Time := F_BA_To STTime(T#10H), u Value := F_BA_RVal(1.0) TF8020 Version: 1.1.2 115
## Page 116

Samples ), ( e State := E_BA_Sched Entry State.e Null, st Time := F_BA_To STTime(T#11H) ) ] )]); // schedule object for binary scheduling b Scheduled Value : BOOL; fb Sched B : FB_BACnet_Sched B := ( s Object Name := 'Schedule Bool', a Week := F_BACnet_Sched Weekly3x B(E_BA_Weekday.e Monday, E_BA_Weekday.e Friday, T#0H, FALSE, T#6H, TRUE, T#20H, FALSE), a Calendar := [ ( i Ref Calendar := fb CAL01, a Entry := F_BACnet_Sched Entry1x B(T#0H, FALSE) ), ( i Ref Calendar := fb CAL02, a Entry := F_BACnet_Sched Entry1x B(T#10H, TRUE) ), ( i Ref Calendar := fb CAL03, a Entry := F_BACnet_Sched Entry3x B(T#0H, F_BA_Null B(), T#6H, TRUE, T#20H, FALSE) )]); // schedule object for multistate scheduling n Multistate Value : UDINT; b Sched M_Assign Cal Reference : BOOL; fb Sched M : FB_BACnet_Sched M := ( s Object Name := 'Schedule Multistate', a Week := F_BACnet_Sched Weekly3x M(E_BA_Weekday.e Monday, E_BA_Weekday.e Friday, T#0H, 1, T#6H, 2, T#20H, 1), n Schedule Default := 3 ); Code fb CAL01(); fb CAL02(); fb CAL03(); fb Analog Output(); fb Sched A(); fb Sched B(); b Scheduled Value := fb Sched B.b Pres Val; // example how to assign a calendar reference at runtime IF( b Sched M_Assign Cal Reference ) THEN b Sched M_Assign Cal Reference := FALSE; fb Sched M.a Calendar[1].i Ref Calendar := fb CAL01; fb Sched M.a Calendar[1].a Entry := F_BACnet_Sched Entry1x M(T#11H, 2); fb Sched M.b Write Exception := TRUE; END_IF fb Sched M(); n Multistate Value := fb Sched M.n Pres Val; 9.12 Logging objects BACnet allows the use of three different objects for log data storage: Trendlog: This object type represents the recorded log data of a single data source, e.g. the Present Value of an Analog Input object. Here, recording can be done by polling (i.e., at a fixed recording interval in 1/100s), by Change of Value (COV), or by using a Boolean trigger. Trendlog Multiple: This object type allows simultaneous recording of data from multiple sources. In principle, recording is only possible via polling or trigger, but not via COV. In practice, this object type is rarely used in BACnet projects. 116 Version: 1.1.2 TF8020
## Page 117

Samples Eventlog: This object type allows the storage of BACnet event messages (events and alarms). If a Notification Class object with the same instance number exists in the server for the instance number of an Eventlog object, the Notification Class object is automatically configured as the data source of the Eventlog object. Alarms reported via this notification class are therefore automatically stored in the log memory of the Eventlog object. The following example shows the use of these three object types. Variables f Analog Value : REAL; fb Ton : TON; fb Av : FB_BACnet_AV := ( s Object Name := 'Object to simulate changes and generate alarms', f Low Limit := 1.0, b Low Limit Enable := TRUE, f High Limit := 8.0, b High Limit Enable := TRUE, b En Pgm := TRUE, b Event Detection Enable := TRUE, n Notification Class := 42, a Event Enable := [TRUE,TRUE,TRUE], e Unit := E_BA_Unit.e Electrical_Volts, n Time Delay := 0, n Time Delay Normal := 0, f Deadband := 0.0 ); fb NC42 : FB_BACnet_NC := ( n Object Instance := 42, n Notification Class := 42, s Description := 'NC42', a Ack Required := [ TRUE, TRUE, TRUE ], a Priority := [ 1, 2, 3 ] ); fb ELog_NC42 : FB_BACnet_ELog Buf := ( s Object Name := 'Event Log for NC42', n Object Instance := 42, b Log Enable := TRUE ); fb TLog : FB_BACnet_TLog := ( s Object Name := 'Trend', n Notification Class := 42, a Event Enable := [ TRUE, TRUE, FALSE ], st Start Time := F_BA_To STDate Time(DT#2010-01-01-00:00), b Log Enable := TRUE, e Logging Type := E_BA_Logging Type.e Polled, n Log Interval := 3 * 100, // log every 3 seconds, value in 1/100 seconds! st Object Property Reference := F_BACnet_Reference(fb Av, Prop Present Value) ); fb TLog Cov : FB_BACnet_TLog := ( s Object Name := 'Trend Cov', b Log Enable := TRUE, st Object Property Reference := F_BACnet_Reference(fb Av, Prop Present Value), e Logging Type := E_BA_Logging Type.e COV, n COVResubscription Interval := 600, st Client COV := ( e Choice := E_BACnet_Client COVChoice.e Cov Real, f Increment := 5.0 ) ); fb TLog Buf : FB_BACnet_TLog Buf := ( s Object Name := 'Trend with PLC buffer', b Log Enable := TRUE, e Logging Type := E_BA_Logging Type.e Triggered, st Object Property Reference := F_BACnet_Reference(fb Av, Prop Present Value) ); fb TLog M : FB_BACnet_TLM := ( s Object Name := 'Trend Multiple', b Log Enable := TRUE, e Logging Type := E_BA_Logging Type.e Polled, n Log Interval := 50, // log every 0.5 seconds, value in 1/100 seconds! a Object Property References := [ (i Object := fb Av, e Property Id := Prop Present Value), TF8020 Version: 1.1.2 117
## Page 118

Samples (i Object := fb Av, e Property Id := Prop Status Flags), (i Object := fb Av, e Property Id := Prop Event State) ] ); Code // generate value changes every second fb Ton( IN:= NOT fb Ton. Q, PT:=T#1S ); IF fb Ton. Q THEN f Analog Value := f Analog Value + 1.0; IF f Analog Value > 10.0 THEN f Analog Value := 0; END_IF END_IF fb Av.f Val Pgm := f Analog Value; fb Av(); // Notification Class fb NC42(); // Event Log with buffer in PLC fb ELog_NC42(); // Trend Log every 3 seconds fb TLog(); // COV based Trend Log fb TLog Cov(); // Trigger based Trend Log with buffer in PLC fb Tlog Buf(); // Trendlog Multiple fb TLog M(); 9.13 Processing of the log memory in the PLC BACnet defines the CHOICE data type for various properties. This represents a selection of different possible property values. To be able to process these data types in the PLC, the PLC data type UNION is used together with an enumeration. The enumeration contains the information which element of the union must be accessed. Log memory of the Trendlog object The following example shows the processing of the log memory of a Trendlog object. An object of the type FB_BACnet_TLog Buf is used for this purpose. This provides a log memory whose contents can be read out by the PLC. The variable a Log Buffer is available as an array of the type T_BACnet_TLog Buffer. The individual elements of the log buffer are of type ST_BA_Trend Entry with the following elements: dt Time: Contains the date and time of the log entry in BACnet format (ST_BA_Date and ST_BA_Time). e Type: Contains the information about the type of the log entry: e Binary: The log entry contains a value of type Binary PV. In the element u Value the value of the variable b Val is to be processed. e Analog: The log entry contains a value of type REAL. In the element u Value the value of the variable f Val is to be processed. e Multistate: The log entry contains a value of type UDINT. In the element u Value the value of the variable udi Val is to be processed. e Event: The log entry contains an event. Four bits are available in the st Event structure: b Start: Recording has been started. b Stop: Recording has been stopped. 118 Version: 1.1.2 TF8020
## Page 119

Samples b Buffer Purged: The log memory has been cleared. b Interrupted: Recording was interrupted (e.g. due to a network interruption) In addition, the four status flags are available in the st State structure element: b In Alarm: The object is in an active alarm state. b Fault: The object is in a faulty state, e.g. encoder malfunction. b Overridden: The object has been overridden by an internal mechanism, e.g. by the PLC. b Out Of Service: The object was put out of operation. Values are simulated. Log memory of the Eventlog object The following example shows the processing of the log memory of an Eventlog object. An object of the type FB_BACnet_ELog Buf is used for this purpose. This provides a log memory whose contents can be read out by the PLC. The variable a Log Buffer is available as an array of the type T_BACnet_ELog Buffer. The individual elements of the log buffer are of type ST_BACnet_Event Log Entry with the following elements: dt Time: Contains the date and time of the log entry in BACnet format (ST_BA_Date and ST_BA_Time). e Type: Contains the information about the type of the log entry: e Status: The log entry contains the information of the Status Flags. Four bits are available in the st Status structure: b In Alarm: The object is in an active alarm state. b Fault: The object is in a faulty state, e.g. encoder malfunction. b Overridden: The object has been overridden by an internal mechanism, e.g. by the PLC. b Out Of Service: The object was put out of operation. Values are simulated. e Timesync: A time synchronization message has been received. The f Time Sync element contains the delta to the previous time. e Notification: The log entry contains an event message. In the structure st Notification the parameters of the event message are available, e.g. the process ID, the triggering device and object, the alarm priority, etc. 9.14 Primitive Value Objects Primitive Value objects can be used to represent simple data types, such as strings, integer values, or for date or time specifications. For dates, according to the BACnet standard, the year starts from 1900. The Month element can contain odd (13) and even (14) months in addition to the regular month information. The day of the month may include odd (33) and even (34) days of the month, as well as the last day (32) of the month, in addition to the regular day information. When specifying specific dates, it is important that the day of the week matches the specified date. For clock times, the range is 0-23 hours, 0-59 minutes, 0-59 seconds, and 0-99 hundredths of a second. The value 255 stands as a placeholder for any value (e.g. every year or every hour) for the objects of the type Pattern. For the enumeration types, the enumerated value Unspecified can be used alternatively. Variables fb Positive Integer : FB_BACnet_INT; fb Large Analog : FB_BACnet_LAV; fb Character String : FB_BACnet_String; fb Unsigned Integer : FB_BACnet_UINT; TF8020 Version: 1.1.2 119
## Page 120

Samples n Value : INT := 15; f Value : LREAL := 42.3; s Value : STRING := 'Twin CAT BACnet'; ui Value : UINT := 12345; fb Date : FB_BACnet_Date; fb Date Pattern : FB_BACnet_Date P; fb Date Time : FB_BACnet_Date Time; fb Datetime Pattern : FB_BACnet_Date Time P; fb Time : FB_BACnet_Time; fb Time Pattern : FB_BACnet_Time P; // specific date st Date : ST_BA_Date := ( n Year := 122, e Month := E_BA_MONTH.e December, n Day := E_BA_DAY.e Day02, e Day Of Week := E_BA_WEEKDAY.e Friday ); // every year christmas eve (regardsless of the day of week) st Date Pattern : ST_BA_Date := ( n Year := 255, e Month := E_BA_MONTH.e December, n Day := E_BA_DAY.e Day24, e Day Of Week := E_BA_WEEKDAY. Unspecified ); // specific date and specific time st Date Time : ST_BA_Date Time := ( st Date := ( n Year := 122, e Month := E_BA_MONTH.e December, n Day := E_BA_DAY.e Day02, e Day Of Week := E_BA_WEEKDAY.e Friday ), st Time := ( n Hour := 17, n Minute := 53, n Second := 42, n Hundredths := 19 ) ); // every year where the 1st of May is a Monday each hour / minute at 11 seconds st Date Time Pattern : ST_BA_Date Time:= ( st Date := ( n Year := 255, e Month := E_BA_MONTH.e May, n Day := E_BA_DAY.e Day01, e Day Of Week := E_BA_WEEKDAY.e Monday ), st Time := ( n Hour := 255, n Minute := 255, n Second := 11, n Hundredths := 0 ) ); // specific time st Time : ST_BA_Time := ( n Hour := 11, n Minute := 42, n Second := 38, n Hundredths := 45 ); // every hour at minute 42 st Time Pattern : ST_BA_Time := ( n Hour := 255, n Minute := 42, n Second := 0, n Hundredths := 0 ); Code fb Positive Integer.n Value := n Value; fb Positive Integer(); fb Large Analog.f Value := f Value; fb Large Analog(); fb Character String.s Value := s Value; fb Character String(); fb Unsigned Integer.n Value := ui Value; fb Unsigned Integer(); fb Date.st Value := st Date; fb Date(); fb Date Pattern.st Value := st Date Pattern; fb Date Pattern(); fb Date Time.st Value := st Date Time; fb Date Time(); fb Datetime Pattern.st Value := st Date Time Pattern; fb Datetime Pattern(); fb Time.st Value := st Time; fb Time(); fb Time Pattern.st Value := st Time Pattern; fb Time Pattern(); 9.15 Structured View objects Structured View objects allow the operator view to be mapped to the objects present in a BACnet device, often using a data point addressing description. 120 Version: 1.1.2 TF8020
## Page 121

Samples With the exception of the top level (root level), all elements are connected to the respective parent object with the help of the i Parent element. The \/ (backslash and slash) characters can be used to create a text composition with the respective parent object. For the properties Objectname, Description and Event Message Texts Config the separator is used, which is defined in the BACnet_Param of the library instance. To use the function STRING_TO_UTF8 the library Tc2_Utilities must be integrated. Variables // use \/ to concat to the string provided by parent node // countries (root level) fb Germany : FB_BACnet_View := ( e Node Type := E_BACnet_Node Type.e Organizational, s Object Name := 'Germany', s Description := 'BECKHOFF offices in Germany' ); fb Switzerland : FB_BACnet_View := ( e Node Type := E_BACnet_Node Type.e Organizational, s Object Name := 'Switzerland', s Description := 'BECKHOFF offices in Switzerland'); fb Spain : FB_BACnet_View := ( e Node Type := E_BACnet_Node Type.e Organizational, s Object Name := 'Spain', s Description := 'BECKHOFF offices in Spain'); // view structure Verl fb Verl : FB_BACnet_View := ( i Parent := fb Germany, e Node Type := E_BACnet_Node Type.e Organizational, s Object Name := '\/Verl', s Description := '\/Verl offices'); fb Eiserstr : FB_BACnet_View := ( i Parent := fb Verl, e Node Type := E_BACnet_Node Type.e Organizational, s Object Name := '\/Eiserstr', s Description := '\/Eiserstr offices'); fb First Floor : FB_BACnet_View := ( i Parent := fb Eiserstr, e Node Type := E_BACnet_Node Type.e Organizational, s Object Name := '\/Floor 2', s Description := '\/Hardware Development'); fb Cabinet : FB_BACnet_View := ( i Parent := fb First Floor, e Node Type := E_BACnet_Node Type.e Collection, s Object Name := '\/Controllers', s Description := '\/Cabinet 07'); fb Av01 : FB_BACnet_AV := ( s Object Name := '\/AV01', s Description := '\/Analog Value01', i Parent := fb Cabinet ); fb Controller : FB_BACnet_View := ( i Parent := fb Cabinet, e Node Type := E_BACnet_Node Type.e Device, s Object Name := '\/C6015', s Description := '\/Edge Device'); fb Av02 : FB_BACnet_AV := ( s Object Name := '\/AV02', s Description := '\/Analog Value02', i Parent := fb Controller ); // view structure Madrid fb Madrid : FB_BACnet_View := ( i Parent := fb Spain, e Node Type := E_BACnet_Node Type.e Organizational, s Object Name := '\/Madrid', TF8020 Version: 1.1.2 121
## Page 122

Samples s Description := '\/Madrid offices'); fb Av03 : FB_BACnet_AV := ( s Object Name := '\/AV03', s Description := '\/Test äöüÄÖÜß', i Parent := fb Madrid ); b Change Av03 : BOOL; s Test : STRING(255); Code // Germany fb Germany(); fb Verl(); fb Eiserstr(); fb First Floor(); fb Cabinet(); fb Av01(); fb Controller(); fb Av02(); // Switzerland fb Switzerland(); // Spain fb Spain(); fb Madrid(); IF b Change Av03 THEN b Change Av03 := FALSE; s Test := 'ßÄÖÜäöü This is a test'; // requires library Tc2_Utilities STRING_TO_UTF8( ADR( fb Av03.s Description ), ADR( s Test ), SIZEOF( fb Av03.s Description) ); END_IF fb Av03(); 9.16 Array initialization If the property values of BACnet FBs are to be initialized as an array with identical values, the syntax described below can be used. The Server and i Parent properties are assigned to all elements of the AI, AO and AV arrays. This example also shows the cyclic call using a for loop. Variables FUNCTION_BLOCK FB_BACnet Server VAR Adapter : FB_BACnet_Adapter; Server : FB_BACnet_Server := (Adapter := Adapter); View_AI : FB_BACnet_View := (Server := Server, s Object Name := 'AI_Objects', s Description := 'Collector AI Objects'); View_AO: FB_BACnet_View := (Server := Server, s Object Name := 'AO_Objects', s Description := 'Collector AO Objects'); View_AV : FB_BACnet_View := (Server := Server, s Object Name := 'AV_Objects', s Description := 'Collector AV Objects'); AI : ARRAY[1.. MAX_OBJECTS] OF FB_BACnet_AI := [MAX_OBJECTS((Server := Server, i Parent := View_AI))]; AO : ARRAY[1.. MAX_OBJECTS] OF FB_BACnet_AO := [MAX_OBJECTS((Server := Server, i Parent := View_AO))]; AV : ARRAY[1.. MAX_OBJECTS] OF FB_BACnet_AV := [MAX_OBJECTS((Server := Server, i Parent := View_AV))]; i For : INT; END_VAR VAR CONSTANT MAX_OBJECTS : INT := 50; END_VAR 122 Version: 1.1.2 TF8020
## Page 123

Samples Code Adapter(); Server(); View_AI(); View_AO(); View_AV(); FOR i For := 1 TO MAX_OBJECTS DO AI[i For](); AO[i For](); AV[i For](); END_FOR TF8020 Version: 1.1.2 123
## Page 124

Support and Service 10 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com 124 Version: 1.1.2 TF8020
## Page 126

More Information: www.beckhoff.com/tf8020 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
