---
title: "TF3680 Twin CAT 3"
product: "TF3680"
category: "Analytics"
tags: ["CAT", "TWIN"]
language: "EN"
document_type: "Manual"
version: "1.7.0"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF3680_TC3_FILTER_EN.pdf"
release_date: "2023-02-28"
---
Manual | EN TF3680 Twin CAT 3 | Filter 2023-02-28 | Version: 1.7.0
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation............................................................................................................. 5 1.2 Safety instructions............................................................................................................................. 6 1.3 Notes on information security............................................................................................................ 7 2 Overview.................................................................................................................................................... 8 3 Installation................................................................................................................................................. 9 3.1 System requirements........................................................................................................................ 9 3.2 Installation......................................................................................................................................... 9 3.3 Licensing......................................................................................................................................... 12 4 Technical introduction............................................................................................................................ 15 4.1 Digital filters..................................................................................................................................... 15 4.2 Filter types and parameterization.................................................................................................... 17 4.3 Twin CAT Analytics.......................................................................................................................... 26 5 PLC API.................................................................................................................................................... 27 5.1 Function blocks............................................................................................................................... 27 5.1.1 FB_FTR_IIRCoeff............................................................................................................ 30 5.1.2 FB_FTR_IIRSos............................................................................................................... 32 5.1.3 FB_FTR_IIRSpec............................................................................................................. 35 5.1.4 FB_FTR_Mov Avg............................................................................................................. 38 5.1.5 FB_FTR_PT1................................................................................................................... 41 5.1.6 FB_FTR_PT2................................................................................................................... 44 5.1.7 FB_FTR_PT3................................................................................................................... 47 5.1.8 FB_FTR_PTn................................................................................................................... 50 5.1.9 FB_FTR_Notch................................................................................................................ 53 5.1.10 FB_FTR_Lead Lag............................................................................................................ 55 5.1.11 FB_FTR_PT2oscillation................................................................................................... 58 5.1.12 FB_FTR_PTt.................................................................................................................... 61 5.1.13 FB_FTR_Median.............................................................................................................. 64 5.1.14 FB_FTR_Actual Value...................................................................................................... 67 5.1.15 FB_FTR_Gaussian.......................................................................................................... 71 5.2 Data types....................................................................................................................................... 74 5.2.1 Configuration structures................................................................................................... 74 5.2.2 E_FTR_Name.................................................................................................................. 84 5.2.3 E_FTR_Type.................................................................................................................... 85 6 Samples................................................................................................................................................... 86 6.1 Configuration of a filter with FB_FTR_IIRSpec............................................................................... 86 6.2 Declaring and calling filters with FB_FTR_<type>.......................................................................... 89 6.3 Reconfiguration with initial values................................................................................................... 90 6.4 Reconfiguration with and without reset........................................................................................... 93 7 Appendix.................................................................................................................................................. 95 7.1 Return codes................................................................................................................................... 95 7.2 Support and Service........................................................................................................................ 96 TF3680 Version: 1.7.0 3
## Page 4

Table of contents 4 Version: 1.7.0 TF3680
## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is only intended for the use of trained specialists in control and automation engineering who are familiar with applicable national standards. It is essential that the documentation and the following notes and explanations are followed when installing and commissioning the components. It is the duty of the technical personnel to use the documentation published at the respective time of each installation and commissioning. The responsible staff must ensure that the application or use of the products described satisfy all the requirements for safety, including all the relevant laws, regulations, guidelines and standards. Disclaimer The documentation has been prepared with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without prior announcement. No claims for the modification of products that have already been supplied may be made on the basis of the data, diagrams and descriptions in this documentation. Trademarks Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered trademarks of and licensed by Beckhoff Automation Gmb H. Other designations used in this publication may be trademarks whose use by third parties for their own purposes could violate the rights of the owners. Patent Pending The Ether CAT Technology is covered, including but not limited to the following patent applications and patents: EP1590927, EP1789857, EP1456722, EP2137893, DE102015105702 with corresponding applications or registrations in various other countries. Ether CAT® is a registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The reproduction, distribution and utilization of this document as well as the communication of its contents to others without express authorization are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event of the grant of a patent, utility model or design. TF3680 Version: 1.7.0 5
## Page 6

Foreword 1.2 Safety instructions Safety regulations Please note the following safety instructions and explanations! Product-specific safety instructions can be found on following pages or in the areas mounting, wiring, commissioning etc. Exclusion of liability All the components are supplied in particular hardware and software configurations appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. Personnel qualification This description is only intended for trained specialists in control, automation and drive engineering who are familiar with the applicable national standards. Description of symbols In this documentation the following symbols are used with an accompanying safety instruction or note. The safety instructions must be read carefully and followed without fail! DANGER Serious risk of injury! Failure to follow the safety instructions associated with this symbol directly endangers the life and health of persons. WARNING Risk of injury! Failure to follow the safety instructions associated with this symbol endangers the life and health of persons. CAUTION Personal injuries! Failure to follow the safety instructions associated with this symbol can lead to injuries to persons. NOTE Damage to the environment or devices Failure to follow the instructions associated with this symbol can lead to damage to the environment or equipment. Tip or pointer This symbol indicates information that contributes to better understanding. 6 Version: 1.7.0 TF3680
## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. TF3680 Version: 1.7.0 7
## Page 8

Overview 2 Overview The Twin CAT 3 function TF3680 TC3 Filter provides various function blocks for implementing digital filters in a PLC library. Digital filters are used to manipulate digitalized (time-discrete and value-quantized) signals and to emphasize or suppress certain components of a signal in the frequency range, for example. Applications: • Suppression of frequency bands, in which the wanted signal plays a subordinate role compared to the noise signal. One example is the conventional low-pass filter for suppressing high-frequency noise. • Targeted elimination of interfering frequency components. An example is a 50 Hz signal that is superimposed on the wanted signal, which influences the measuring signal through electromagnetic coupling of the mains voltage. Function blocks: Function block Filter FB_FTR_IIRCoeff [} 30] Enables the implementation of a custom filter through the specification of filter coefficients, so that, in principle, any filter characteristics can be used. FB_FTR_IIRSos [} 32] FB_FTR_IIRSpec [} 35] Enables the implementation of a filter of type "Butterworth", "Chebyshev" or "Bessel". FB_FTR_PT1 [} 41] Enables the implementation of different delay elements of different order. FB_FTR_PT2 [} 44] FB_FTR_PT3 [} 47] FB_FTR_PTn [} 50] FB_FTR_PT2oscillation [} 58] FB_FTR_Lead Lag [} 55] FB_PTt [} 61] FB_FTR_Mov Avg [} 38] Enables the implementation of a moving average filter for smoothing. FB_FTR_Median [} 64] Median filter for smoothing signals with outliers. FB_FTR_Notch [} 53] Enables the implementation of a band-stop filter to suppress a narrow frequency band. FB_FTR_Acutal Value Filter for the treatment of outliers. [} 67] FB_FTR_Gaussian [} 71] Smoothing filter with minimal group delay. 8 Version: 1.7.0 TF3680
## Page 9

Installation 3 Installation 3.1 System requirements Technical data Description Operating system Windows 7/10, Windows Embedded Standard 7, Windows CE 7 Target platform PC architecture (x86, x64 or ARM) Twin CAT version Twin CAT 3.1 build 4022.25 or higher Required Twin CAT setup level Twin CAT 3 XAE, XAR Required Twin CAT license TF3680 TC3 Filter or TF3600 TC3 Condition Monitoring 3.2 Installation The following section describes how to install the Twin CAT 3 Function for Windows-based operating systems. ü The Twin CAT 3 Function setup file was downloaded from the Beckhoff website. 1. Run the setup file as administrator. To do this, select the command Run as administrator in the context menu of the file. ð The installation dialog opens. 2. Accept the end user licensing agreement and click Next. TF3680 Version: 1.7.0 9
## Page 10

Installation 3. Enter your user data. 4. If you want to install the full version of the Twin CAT 3 Function, select Complete as installation type. If you want to install the Twin CAT 3 Function components separately, select Custom. 10 Version: 1.7.0 TF3680
## Page 11

Installation 5. Select Next, then Install to start the installation. ð A dialog box informs you that the Twin CAT system must be stopped to proceed with the installation. 6. Confirm the dialog with Yes. TF3680 Version: 1.7.0 11
## Page 12

Installation 7. Select Finish to exit the setup. ð The Twin CAT 3 Function has been successfully installed and can be licensed (see Licensing [} 12]). 3.3 Licensing The Twin CAT 3 function can be activated as a full version or as a 7-day test version. Both license types can be activated via the Twin CAT 3 development environment (XAE). Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 12 Version: 1.7.0 TF3680
## Page 13

Installation 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. TF3680 Version: 1.7.0 13
## Page 14

Installation 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. 14 Version: 1.7.0 TF3680
## Page 15

Technical introduction 4 Technical introduction 4.1 Digital filters Digital filters are used to manipulate digitalized (time-discrete and value-quantized) signals. The manipulation is evident in the frequency domain, where certain components of a signal are emphasized or suppressed. Properties Digital filters can differ, among other things, in the frequency domain that may pass through the filter. Filter type Description Area of application (examples) Low-pass Frequencies below a cut-off frequency can Anti-aliasing filter or filter for smoothing a pass through the filter. signal. High-pass Frequencies above a cut-off frequency can Elimination of an interfering DC component in pass through the filter. the signal. Band-pass Frequencies within a certain frequency Useful for amplitude-modulated signals (radio interval can pass through the filter. technology, optical measuring signals, ultrasound signals, ...), i.e. the wanted signal is spectrally distributed around a carrier frequency, so that low and high frequencies outside the wanted signal worsen the SNR (signal-to-noise ratio) and are suppressed. Band-stop Frequencies out of a certain frequency Suppression of an inductively coupled interval can pass through the filter. frequency, e.g. the mains frequency. The specific implementation of the filter determines the transition behavior from the passband to the stopband. See also: Filter types and parameterization [} 17] Digital signals An analog signal x(t) is converted by an analog-to-digital converter, e.g. in an EL3xxx or ELM3xxx, to a time- discrete and value-quantized signal x[n]. The time discretization takes place with the sampling period T (inverse of the sampling rate f). s Difference equation The general difference equation for an input signal x[n] (input to a discrete system, in this case a filter) and a corresponding output signal y[n] is: a und b are usually real-valued coefficients (filter coefficients). The current output value y[n] of a system is k k thus calculated as a linear combination of past filter inputs x[n-k] with k > 0, past filter outputs y[n-k] with k > 0 and the current filter input x[n] (k = 0). TF3680 Version: 1.7.0 15
## Page 16

Technical introduction The inclusion of past filter outputs in the calculation of a current output value represents a feedback and therefore requires verification to ensure system stability. Filters with feedback are called "IIR filters" (Infinite Impulse Response filters). Filters without feedback are called "FIR filters" (Finite Impulse Response filters). The advantage of IIR filters is that "good" manipulations of the signal x[n] can be achieved with low filter orders. By definition, FIR filters can never be unstable. Transfer function By z-transforming the difference equation and using the linearity and the time shift property, the following general representation of the filter transfer function is obtained: The denominator coefficients a belong to the coefficients in the feedback. In order for the filter to be stable in k conjunction with the transfer function G(z), care must be taken when calculating these coefficients that the poles of G(z) lie within the unit circle in the complex level. IIR filters with a high filter order can become instable due to quantification effects during the calculation of the coefficients. In order to overcome these challenges, IIR filters are often implemented in cascaded biquad filters, normally called second-order sections (SOS). The overall transfer function is expressed by a multiplication of several 2nd order filters. The transfer function G(z) is then described with: The frequency response of a system can be determined from the transfer function G(z) by transitioning to the frequency range (frequency f) with . The amplitude response then corresponds to the magnitude of the frequency response, and the phase response corresponds to the argument of the frequency response. Implementation in the PLC library The PLC library Tc3_Filter provides various function blocks for implementing digital filters. The function block FB_FTR_IIRCoeff [} 30] can be used to implement a free filter. The filter coefficients a k and b can be calculated individually and transferred to the function block using a configuration structure. k You are responsible for the stability of your filter. With the function block FB_FTR_IIRSos [} 32] you can implement a free filter structured in SOS. The filter coefficients a and b can be calculated individually and transferred to the function block using a configuration k k structure. You are responsible for the stability of your filter. The function block FB_FTR_IIRSpec [} 35] can be used to implement ready-made filters of type Butterworth, Chebyshev or Bessel through simple parameterization. The filter coefficients are thereby calculated internally as biquads. The function block FB_FTR_Mov Avg [} 38] and FB_FTR_Median [} 64] can be used to implement an average filter or median filter, which is used in many applications for smoothing signals. Use the function block FB_FTR_Gaussian [} 71] to create a smoothing filter with minimal group delay so that the shape of your signal is only minimally affected as it passes through the filter and only the interfering signal components are removed. You can use the function block FB_FTR_Notch [} 53] to implement a band-stop filter that is used to suppress a narrow frequency band. You can use the function block FB_FTR_Actual Value [} 67] to perform a plausibility check of a measured input value. 16 Version: 1.7.0 TF3680
## Page 17

Technical introduction In addition, further filters that are commonly used in system theory and control technology are made available to you: PTt [} 61], PT1 [} 41], PT2 [} 44], PT3 [} 47], PTn [} 50], PT2oscillation [} 58] and Lead Lag [} 55] elements. A PT1 element and a Butterworth 1st order low-pass filter can be converted equivalently to each other, but the featured parameters of the filters are different. Bilinear transformation The parameterization of the predefined filters takes place in the Laplace space. The implementation of the time-continuous system representation in the time-discrete z-space takes place internally with the help of the bilinear transformation. The effect of "frequency warping" is taken into account in the filter design. 4.2 Filter types and parameterization This description is limited to low-pass filters. However, the concepts can be applied to other filter types (high-pass, band-pass and stop-band filters). Twin CAT Filter Designer The graphics created in the following were created with the Twin CAT Filter Designer. The Filter Designer makes it possible to create filters graphically and then use them in the PLC with Twin CAT 3 Filter (or as a filter directly on the Ether CAT Terminal or Drive). The Butterworth filter, the Chebyshev filter and the Bessel filter are common implementations of a digital filter. Each filter has certain properties that are beneficial in different situations. Butterworth filter vs. Chebyshev filter: The difference between the two implementations essentially consists of the balance between the permissible ripple of the amplitude response in the passband and the slope of the amplitude response in the transition between the passband and the stopband. While the Butterworth filter has a maximally flat amplitude response in the passband, for the Chebyshev filter the permissible ripple of the amplitude response in the passband is specified as a parameter. The advantage of the Chebyshev filter is a steeper decrease of the amplitude response in the transition from the passband to the stopband. Bessel filter vs. Chebyshev and Butterworth filters: In the Bessel filter, the focus is on a constant group delay or a linear phase response in the passband of the filter. As a result, the shape of signals with spectral components in the passband is not changed when passing through the filter. Compared to the Butterworth or Chebyshev filter, the transition from the passband to the stopband is less sharp in the Bessel filter, i.e. amplitudes near the cut-off frequency are comparatively less attenuated. In the passband itself, the Bessel filter exhibits a monotonically decreasing amplitude response. The filter types are compared and described in more detail below. First, some basic terms are explained briefly. Transfer function in the amplitude/frequency diagram The filter is described mathematically by the transfer function (see Digital filters [} 15]). The transfer function can be displayed in the form of an amplitude and a phase response. TF3680 Version: 1.7.0 17
## Page 18

Technical introduction Fig. 1: Graphical representation of the amplitude response of a low-pass filter Passband The passband (blue zone) allows spectral components of a signal to pass through. Modification of the signal in this frequency range should be avoided. Stopband In the stopband (red zone), the filter attenuates the corresponding frequency components of the signal. Transition The transition (yellow zone) separates the passband and the stopband. It should normally be as small as possible. The design of the transition phase is a defining criterion for the selection of the filter type and its parameterization. Passband ripple The ripple in the passband describes the waviness of the amplitude response in the passband. Parameterization of the Butterworth filter Properties The amplitude response of the Butterworth filter is maximally flat in the passband, so that the wanted signal in this range is only minimally manipulated. In addition, the entire course of the amplitude response is monotonous, i.e. without passband ripple. This filter type is one of the most frequently used filter types. Parameter The transfer function of the Butterworth filter contains only two parameters to be defined: the cut-off frequency and the filter order. Filter order The filter order determines how steeply the amplitude response decreases in the transition. The higher the filter order, the steeper the amplitude response decreases and the smaller the transition. For the slope of the amplitude response for a Butterworth filter, -n * 20 d B/decade, with n = order, i.e. -20 d B/decade for filter order 1, -40 d B/decade for filter order 2, and so on. Cut-off frequency 18 Version: 1.7.0 TF3680
## Page 19

Technical introduction The cut-off frequency of the Butterworth filter is defined as the frequency at which the normalized amplitude response assumes the value 1/sqrt(2) ≈ -3 d B. This applies to all filter orders. Accordingly, when designing the filter, care must be taken to ensure that the spectral components of a signal are already attenuated by 3 d B at the cut-off frequency. This parameter causes a parallel shift of the amplitude response along the frequency axis (distortion due to the logarithmic frequency axis). Fig. 2: Graphical representation of the amplitude and phase response of a Butterworth filter with identical cut-off frequency (blue: filter order 2, yellow: filter order 4) TF3680 Version: 1.7.0 19
## Page 20

Technical introduction Fig. 3: Graphical representation of the amplitude and phase response of a Butterworth filter with identical filter order (blue: cut-off frequency 400 Hz, green: cut-off frequency 700 Hz) Parameterization of the Chebyshev filter Properties The amplitude response of the Chebyshev filter has a parameterizable passband ripple. However, the amplitude response decreases steeply in the transition even at low filter order. The following applies: the greater the permissible passband ripple, the shorter the transition. Parameter In addition to the filter order and the cut-off frequency as parameters to be defined, the transfer function of the Chebyshev filter contains a "passband ripple" parameter. Passband ripple The parameter specifies the permissible ripple of the amplitude response in the passband of the filter. By allowing a passband ripple, a short transition between passband and stopband, and thus a steep decrease of the amplitude response, can be achieved with a significantly lower filter order. Cut-off frequency The cut-off frequency of the Chebyshev filter is defined as the frequency at which the amplitude response passes downwards through the defined "passband ripple". The position of the transition on the frequency axis is thus associated not only with the cut-off frequency, but also with the settings for the filter order and passband ripple. 20 Version: 1.7.0 TF3680
## Page 21

Technical introduction The following diagram shows three different Chebyshev filters with different filter order and passband ripple, but the same cut-off frequency. Fig. 4: Graphical representation of the amplitude and phase response of a Chebyshev filter with identical cut- off frequency (blue: filter order 4, passband ripple 0.1 d B, red: filter order 2, passband ripple 0.1 d B, cyan: filter order 4, passband ripple 1 d B) Filter order The filter order determines how steeply the amplitude response decreases in the transition. The higher the filter order, the steeper the amplitude response decreases and the smaller the transition. For the slope of the amplitude response for a Butterworth filter, -n * 20 d B/decade, with n = order, i.e. -20 d B/decade for filter order 1, -40 d B/decade for filter order 2, and so on. The filter order does not influence the cut-off frequency according to the above definition, as can be seen in the following graph. The amplitude response curves intersect at the cut-off frequency of 250 Hz. TF3680 Version: 1.7.0 21
## Page 22

Technical introduction Fig. 5: Graphical representation of the amplitude and phase response of a Chebyshev filter with identical cut- off frequency (250 Hz) and identical passband ripple (2 d B): (blue: filter order 2, yellow: filter order 4) Comparison of Butterworth and Chebyshev filters The following diagram shows a direct comparison of the amplitude and phase response of a Butterworth filter and a Chebyshev filter. Both filters are parameterized so that their amplitude responses intersect at the cut- off frequency of the Butterworth filter at a normalized amplitude of 1/sqrt(2). Both filters are defined as fifth order filters. The passband ripple parameter of the Chebyshev filter is 0.5 d B. The weighing up referred to above between the permissible passband ripple of the amplitude response and the slope in the transition with the same filter order becomes apparent. With the same filter order, the amplitude response of the Chebyshev filter decreases more sharply in the transition than that of the Butterworth filter. On the other hand, its amplitude response is not smooth in the passband, so that the wanted signal is manipulated more strongly here than with the Butterworth filter. 22 Version: 1.7.0 TF3680
## Page 23

Technical introduction Fig. 6: Graphical representation of the amplitude and phase response of a Butterworth filter (blue) and a Chebyshev filter (cyan) Parameterization of the Bessel filter Properties The Bessel filter has a constant group delay in the passband. The amplitude response is monotonically slightly decreasing. Due to these properties, a signal that has only spectral components in the passband will not change in its signal shape when passing through the filter. Parameter Like the Butterworth filter, the Bessel filter is parameterized via the cut-off frequency and filter order. Cut-off frequency The cut-off frequency f defines the amount of group delay of the Bessel filter in the passband τ : c gd,pass Here f is the sampling frequency. s TF3680 Version: 1.7.0 23
## Page 24

Technical introduction Fig. 7: Graphical representation of the amplitude and phase response of a Bessel filter (blue: cut-off frequency 500 Hz, magenta: cut-off frequency 400 Hz, olive: cut-off frequency 250 Hz) Filter order The filter order influences the slope of the amplitude response in the stopband. It should be noted with the Bessel filter that an increase in the filter order is accompanied by an increase in the passband. Accordingly, it is advisable to select the order first and then use the cut-off frequency to define the passband. 24 Version: 1.7.0 TF3680
## Page 25

Technical introduction Fig. 8: Graphical representation of the amplitude and phase response of a Bessel filter (blue: filter order 2, magenta: filter order 4, olive: filter order 6) Comparison of Butterworth, Chebyshev and Bessel filters The main characteristics of the Bessel filter can be seen in the time domain or in the phase and group delay. As shown in the graph below, the impulse response and step response of the Bessel filter do not require much settling. In addition, phase delay and group delay are almost constant in the passband of the filter, which means that signals with spectral components in the passband are not changed in shape. TF3680 Version: 1.7.0 25
## Page 26

Technical introduction Fig. 9: Graphical representation of the impulse and step response as well as the phase and group delay of a Butterworth filter (blue), a Chebyshev filter (cyan) and a Bessel filter (red). 4.3 Twin CAT Analytics The library can also be used in the Twin CAT Analytics Engineering products to create continuous data analyses from different, decentralized machine controllers. In addition, Analytics Workbench can be used to automatically generate a PLC application, and the generated code can be downloaded to Analytics Runtime, where it runs 24/7 in parallel with applications in the field. Further information can be found in the Twin CAT Analytics documentation. 26 Version: 1.7.0 TF3680
## Page 27

PLC API 5 PLC API 5.1 Function blocks Basic structure of the function blocks All function blocks of the library Tc3_Filter are based on the same basic structure. This simplifies the engineering process when changing from one filter type to another. Syntax FUNCTION_BLOCK FB_FTR_<type> VAR_INPUT st Config : ST_FTR_<type>; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs To configure the filter, a configuration structure of type ST_FTR_<type> is transferred to the function blocks during instantiation. The configuration structure can be assigned in the declaration or via the Configure() method at runtime. See also: Data types [} 74] > Configuration structures [} 74] Sample of configuration in the declaration: (* define configure structure – exemplary for IIRSpec *) st Params : ST_FTR_IIRSpec := ( e Filter Name := E_FTR_Name.e Butterworth, e Filter Type = E_FTR_Type.e Low Pass, n Filter Order := n Filter Order, f Sampling Rate := f Sample Rate, f Cutoff := f Cutoff, n Oversamples := c Oversamples, n Channels := c Channels); (* create filter instance with configure structure *) fb Filter : FB_FTR_IIRSpec := (st Config := st Params); Outputs All function blocks have an error flag b Error and a flag b Configured of type BOOL as output parameters. These indicate whether an error has occurred and whether the corresponding function block instance has been successfully configured. The output ip Result Message of type I_Tc Message provides various properties for explaining the cause of an event and methods for processing the message (event list [} 95]). See also: I_Tc Event Base und I_Tc Message Methods All function blocks of the library Tc3_Filter have three methods. They return a positive value if they were executed without errors. Configure() This method can be used at runtime to initially configure the instance of a filter function block (if it was not already configured in the declaration) or to reconfigure it. TF3680 Version: 1.7.0 27
## Page 28

PLC API METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_<type>; END_VAR Call() The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; (*address of input array*) n Size In : UDINT; (*size of input array*) p Out : POINTER TO LREAL; (*address of output array*) n Size Out : UDINT; (*size of output array*) END_VAR Reset() The method resets the internal status of a filter. The influence of the past values on the current output value is eliminated. METHOD Reset : BOOL Properties The library Tc3_Filter references the Twin CAT 3 Event Logger and thus ensures that information (events) is provided via the standardized interface I_Tc Message. Each function block has the properties e Trace Level of type Tc Event Severity and e Trace Level Default of type BOOL. The trace level determines the severity of an event (verbose, info, warning, error, critical) and is set using the e Trace Level property. (* Sample of setting fb Filter to trace level info *) fb Filter.e Trace Level := Tc Event Severity. Info; The property e Trace Level Default can be used to reset the trace level to the default value (Tc Event Severity. Critical). The property can be read and written, i.e. the property e Trace Level Default can be used to query whether the default value is set. The properties can also be set in Online view. Dealing with oversampling and multiple channels All function blocks are oversampling- and multi-channel-capable. They can be used in different ways. The declaration of the filter function block instance fb Filter is always the same. Multi-channel with two-dimensional signal arrays The definition of a two-dimensional array has the advantage that it is universally valid, and the parameter c Channels can also be set to 1 in other projects. The channels in Twin CAT 3 Scope can also be selected individually, so that all channels can be viewed independently of each other. 28 Version: 1.7.0 TF3680
## Page 29

PLC API Display of the multidimensional array in the "Target Browser": Sample: VAR CONSTANT c Channels : UINT := 2; c Oversamples : UINT := 10; END_VAR VAR a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; END_VAR b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); Multi-channel with one-dimensional signal arrays Alternatively, the sampling values of the different channels can be stored in a one-dimensional array. However, in this case recording the individual channels with Twin CAT 3 Scope is more difficult. Sample: VAR CONSTANT c Channels : UINT := 2; c Oversamples : UINT := 10; END_VAR VAR a Input : ARRAY [1..c Channels*c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels*c Oversamples] OF LREAL; END_VAR b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); One-channel application with oversamples If only a single channel is considered, the input and output arrays can be declared as one-dimensional quantities. VAR CONSTANT c Channels : UINT := 1; c Oversamples : UINT := 10; END_VAR VAR a Input : ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Oversamples] OF LREAL; END_VAR b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); One-channel application without oversamples If only a single channel is considered and no oversampling is applied, the input and output variables can be declared as LREAL. VAR CONSTANT c Channels : UINT := 1; c Oversamples : UINT := 1; END_VAR VAR f Input : LREAL; f Output : LREAL; END_VAR b Succeed := fb Filter. Call(ADR(f Input), SIZEOF(f Input), ADR(f Output), SIZEOF(f Output)); TF3680 Version: 1.7.0 29
## Page 30

PLC API 5.1.1 FB_FTR_IIRCoeff The function block implements an IIR filter (Infinite Impulse Response filter). The general transfer function is: The coefficients a and b are freely definable in the configuration structure. The numerator degree and k k denominator degree may be different. The denominator can be set to a = 1 and a = 0 (for all k > 0), so that 0 k a FIR filter is configured. The filter specification is transferred with the structure ST_FTR_IIRCoeff. See also: Digital filters [} 15] Syntax Declaration: fb Filter : FB_FTR_IIRCoeff(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_IIRCoeff VAR_INPUT st Config : ST_FTR_IIRCoeff; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_IIRCoeff [} 76] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. 30 Version: 1.7.0 TF3680
## Page 31

PLC API Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.1.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_IIRCoeff; END_VAR Inputs Name Type Description st Config ST_FTR_IIRCoeff [} 76] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_IIRCoeff(); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.p Coefficient Array Adr_A := ADR(a New Array); (*change coefficients of denominator*) st Params.n Coefficient Array Size_A := SIZEOF(a New Array); b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.1.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. TF3680 Version: 1.7.0 31
## Page 32

PLC API Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.1.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.2 FB_FTR_IIRSos The function block implements an IIR filter (Infinite-Impulse-Response filter). The transfer function is: 32 Version: 1.7.0 TF3680
## Page 33

PLC API The coefficients of the transfer function are freely definable and can be transferred with the structure ST_FTR_IIRSos. See also: Digital filters [} 15] Syntax Declaration: fb Filter : FB_FTR_IIRSos(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_IIRSos VAR_INPUT st Config : ST_FTR_IIRSos; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_IIRSos [} 77] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event TF3680 Version: 1.7.0 33
## Page 34

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter See also: FB_FTR_IIRSpec [} 35] Filter types and parameterization [} 17] 5.1.2.1 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.2.2 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL 34 Version: 1.7.0 TF3680
## Page 35

PLC API Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.2.3 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_IIRSos; END_VAR Inputs Name Type Description st Config ST_FTR_IIRSos [} 77] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_IIRSos(); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.p Coefficient Array Adr_Sos := ADR(a New Array); (*change coefficients*) st Params.n Coefficient Array Size_Sos := SIZEOF(a New Array); b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.3 FB_FTR_IIRSpec The function block implements an IIR filter (Infinite Impulse Response filter). TF3680 Version: 1.7.0 35
## Page 36

PLC API The filter coefficients of the transfer function are calculated internally on the basis of the filter specification transferred in the form of biquads. The filter specification is transferred with the structure ST_FTR_IIRSpec. Filters of type Butterworth, Chebyshev or Bessel can be specified. Low-pass, high-pass, band-pass and band-stop filters can be defined in each case. See also: Digital filters [} 15], Filter types and parameterization [} 17] Syntax Declaration: fb Filter : FB_FTR_IIRSpec(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_IIRSpec VAR_INPUT st Config : ST_FTR_IIRSpec; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_IIRSpec [} 77] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event 36 Version: 1.7.0 TF3680
## Page 37

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter See also: Filter types and parameterization [} 17] FB_FTR_IIRSos [} 32] 5.1.3.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_IIRSpec; END_VAR Inputs Name Type Description st Config ST_FTR_IIRSpec [} 77] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_IIRSpec(); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Cutoff := 50; (*change cutoff freq.*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.3.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; TF3680 Version: 1.7.0 37
## Page 38

PLC API p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.3.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.4 FB_FTR_Mov Avg The function block implements a moving average filter. The filter calculates the mean value of M input values x[n-k] with k = 0 .. M - 1. 38 Version: 1.7.0 TF3680
## Page 39

PLC API The filter specification is transferred with the structure ST_FTR_Mov Avg. Syntax Declaration: fb Filter : FB_FTR_Mov Avg(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_Mov Avg VAR_INPUT st Config : ST_FTR_Mov Avg; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_Mov Avg [} 78] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter TF3680 Version: 1.7.0 39
## Page 40

PLC API 5.1.4.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_Mov Avg; END_VAR Inputs Name Type Description st Config ST_FTR_Mov Avg [} 78] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_Mov Avg (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.n Samples To Filter := 11; (*change filter order*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.4.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array 40 Version: 1.7.0 TF3680
## Page 41

PLC API Name Type Description n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.4.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.5 FB_FTR_PT1 The function block FB_FTR_PT1 implements a first-order delay element (PT1 element) with the complex transfer function (Laplace space): The filter specification is transferred with the structure ST_FTR_PT1. Syntax Declaration: fb Filter : FB_FTR_PT1(st Config := ...) TF3680 Version: 1.7.0 41
## Page 42

PLC API Definition: FUNCTION_BLOCK FB_FTR_PT1 VAR_INPUT st Config : ST_FTR_PT1; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_PT1 [} 78] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.5.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. 42 Version: 1.7.0 TF3680
## Page 43

PLC API Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_PT1; END_VAR Inputs Name Type Description st Config ST_FTR_PT1 [} 78] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_PT1 (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Kp := 2; (*change gain*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.5.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array TF3680 Version: 1.7.0 43
## Page 44

PLC API Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.5.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.6 FB_FTR_PT2 The function block FB_FTR_PT2 implements a second-order delay element (PT2 element) with the complex transfer function (Laplace space): The filter specification is transferred with the structure ST_FTR_PT2. Syntax Declaration: fb Filter : FB_FTR_PT2(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_PT2 VAR_INPUT st Config : ST_FTR_PT2; 44 Version: 1.7.0 TF3680
## Page 45

PLC API END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_PT2 [} 79] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.6.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_PT2; END_VAR TF3680 Version: 1.7.0 45
## Page 46

PLC API Inputs Name Type Description st Config ST_FTR_PT2 [} 79] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_PT2 (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Kp := 2; (*change gain*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.6.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; 46 Version: 1.7.0 TF3680
## Page 47

PLC API b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.6.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.7 FB_FTR_PT3 The function block FB_FTR_PT3 implements a third-order delay element (PT3 element) with the complex transfer function (Laplace space): The filter specification is transferred with the structure ST_FTR_PT3. Syntax Declaration: fb Filter : FB_FTR_PT3(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_PT3 VAR_INPUT st Config : ST_FTR_PT3; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_PT3 [} 80] Structure for configuring the filter behavior TF3680 Version: 1.7.0 47
## Page 48

PLC API Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.7.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_PT3; END_VAR Inputs Name Type Description st Config ST_FTR_PT3 [} 80] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. 48 Version: 1.7.0 TF3680
## Page 49

PLC API Sample (*Declaration without configuration*) fb Filter : FB_FTR_PT3 (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Kp := 2; (*change gain*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.7.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.7.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] TF3680 Version: 1.7.0 49
## Page 50

PLC API Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.8 FB_FTR_PTn The function block FB_FTR_PTn implements a nth-order delay element with the same time constants. The complex transfer function (Laplace space): The filter specification is transferred with the structure ST_FTR_PTn. Syntax Declaration: fb Filter : FB_FTR_PTn(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_PTn VAR_INPUT st Config : ST_FTR_PTn; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_PTn [} 80] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling 50 Version: 1.7.0 TF3680
## Page 51

PLC API Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.8.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_PTn; END_VAR Inputs Name Type Description st Config ST_FTR_PTn [} 80] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_PTn (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Kp := 2; (*change gain*) TF3680 Version: 1.7.0 51
## Page 52

PLC API b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.8.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.8.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 52 Version: 1.7.0 TF3680
## Page 53

PLC API 5.1.9 FB_FTR_Notch The function block FB_FTR_Notch implements a band-stop filter with narrow bandwidth. The complex transfer function (Laplace space): The filter specification is transferred with the structure ST_FTR_Notch. Syntax Declaration: fb Filter : FB_FTR_Notch(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_Notch VAR_INPUT st Config : ST_FTR_Notch; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_Notch [} 81] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. TF3680 Version: 1.7.0 53
## Page 54

PLC API Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.9.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_Notch; END_VAR Inputs Name Type Description st Config ST_FTR_Notch [} 81] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Example (*Declaration without configuration*) fb Filter : FB_FTR_Notch (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE; END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Q := 20; (*change quality factor*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.9.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. 54 Version: 1.7.0 TF3680
## Page 55

PLC API Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.9.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.10 FB_FTR_Lead Lag The function block FB_FTR_Lead Lag implements a first order phase correction element with the complex transfer function (Laplace space): TF3680 Version: 1.7.0 55
## Page 56

PLC API The filter specification is transferred with the structure ST_FTR_Lead Lag. Syntax Declaration: fb Filter : FB_FTR_Lead Lag(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_Lead Lag VAR_INPUT st Config : ST_FTR_Lead Lag; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_Lead Lag [} 81] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 56 Version: 1.7.0 TF3680
## Page 57

PLC API 5.1.10.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_Lead Lag; END_VAR Inputs Name Type Description st Config ST_FTR_Notch [} 81] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Example (*Declaration without configuration*) fb Filter : FB_FTR_Lead Lag (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE; END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f T1 := 0.0002; (*change time constant T1*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.10.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array TF3680 Version: 1.7.0 57
## Page 58

PLC API Name Type Description n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.10.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.11 FB_FTR_PT2oscillation The function block FB_FTR_PT2oscillation implements an oscillating second-order delay element with the complex transfer function (Laplace space): The filter specification is transferred with the structure ST_FTR_PT2oscillation. Syntax Declaration: fb Filter : FB_FTR_PT2oscillation(st Config := ...) Definition: 58 Version: 1.7.0 TF3680
## Page 59

PLC API FUNCTION_BLOCK FB_FTR_PT2oscillation VAR_INPUT st Config : ST_FTR_PT2oscillation; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_PT2oscillation Structure for configuring the filter behavior [} 82] Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.11.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. TF3680 Version: 1.7.0 59
## Page 60

PLC API Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_PT2oscillation; END_VAR Inputs Name Type Description st Config ST_FTR_PT2oscillation Structure for configuring the filter behavior [} 82] Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Example (*Declaration without configuration*) fb Filter : FB_FTR_PT2oscillation (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE; END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Theta := 0.7; (*change damping factor*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.11.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array 60 Version: 1.7.0 TF3680
## Page 61

PLC API Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.11.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.12 FB_FTR_PTt The function block FB_FTR_PTt implements a dead time element (PTt element) with the complex transfer function (Laplace space): The filter specification is transferred with the structure ST_FTR_PTt. Syntax Declaration: fb Filter : FB_FTR_PTt(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_PTt VAR_INPUT st Config : ST_FTR_PTt; END_VAR VAR_OUTPUT b Error : BOOL; TF3680 Version: 1.7.0 61
## Page 62

PLC API b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_PTt [} 82] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.12.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_PTt; END_VAR 62 Version: 1.7.0 TF3680
## Page 63

PLC API Inputs Name Type Description st Config ST_FTR_PTt [} 82] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_PTt (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Kp := 2; (*change gain*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.12.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); TF3680 Version: 1.7.0 63
## Page 64

PLC API 5.1.12.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.13 FB_FTR_Median The function block implements a median filter. The median is the mean value of a list of values ordered by size. This means that one half of the collected data values is smaller than the median value, the other half is larger. The filter specification is transferred with the structure ST_FTR_Median. Syntax Declaration: fb Filter : FB_FTR_Median(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_Median VAR_INPUT st Config : ST_FTR_Median; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_Median [} 83] Structure for configuring the filter behavior 64 Version: 1.7.0 TF3680
## Page 65

PLC API Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.13.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_Median; END_VAR Inputs Name Type Description st Config ST_FTR_Median [} 83] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. TF3680 Version: 1.7.0 65
## Page 66

PLC API Sample (*Declaration without configuration*) fb Filter : FB_FTR_Median (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.n Samples To Filter := 11; (*change filter order*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.13.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.13.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] 66 Version: 1.7.0 TF3680
## Page 67

PLC API Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.14 FB_FTR_Actual Value The function block allows a measured input value to be checked for plausibility and filtered. If the difference between two sampling values in sequence is larger than the specified window, f Delta Max, then the current input value is suppressed for a maximum of three cycles. During this time the output value is linearly extrapolated from the previous input values. If the specified window is exceeded for more than three cycles, the output will again follow the input value. Variable n is incremented if |x - x | > f Delta Max. k k-1 The filter specification is transferred with the structure ST_FTR_ Actual Value [} 83]. Syntax Declaration: fb Filter : FB_FTR_Actual Value(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_Actual Value VAR_INPUT st Config : ST_FTR_Actual Value; END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR TF3680 Version: 1.7.0 67
## Page 68

PLC API Inputs Name Type Description st Config ST_FTR_Actual Value Structure for configuring the filter behavior [} 83] Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling. Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Get Filter Active() Local Indicates which elements of the input signal have been changed. Get Filter Active Times Local Shows when the filter was last active. tamps() Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical. e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event. n Timestamp UINT Set Local 0 Timestamp of the oldest input value of the next Call(). t Sample Period LTIME Set Local 0 Time difference between two input values. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.14.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. 68 Version: 1.7.0 TF3680
## Page 69

PLC API Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_Median; END_VAR Inputs Name Type Description st Config ST_FTR_Median [} 83] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_Median (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.n Samples To Filter := 11; (*change filter order*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.14.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array TF3680 Version: 1.7.0 69
## Page 70

PLC API Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); 5.1.14.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.1.14.4 Get Filter Active The method calculates which elements of the input signal were changed, starting from the last Call(). Syntax METHOD Get Filter Active: BOOL VAR_INPUT p Filter Active : POINTER TO BOOL; n Size Get Filter Active : UDINT; END_VAR Inputs Name Type Description p Filter Active POINTER TO BOOL Address of the input array n Size Get Filter Active UDINT Size of the input array Return value Name Type Description Get Filter Active BOOL Returns TRUE if active state was calculated. Sample a Filter Active : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF BOOL; b Succeed := fb Filter. Get Filter Active(ADR(a Filter Active),SIZEOF(a Filter Active)); 70 Version: 1.7.0 TF3680
## Page 71

PLC API 5.1.14.5 Get Filter Active Timestamps The method calculates when the filter was last active, based on the last Call(). Syntax METHOD Get Filter Active Timestamps: BOOL VAR_INPUT p Filter Active Timestamps : POINTER TO BOOL; n Size Filter Active Timestamps : UDINT; END_VAR Inputs Name Type Description p Filter Active Timesta POINTER TO ULINT Address of the input array mps n Size Filter Active Tim UDINT Size of the input array estamps Return value Name Type Description Get Filter Active Times BOOL Returns TRUE if the timestamps have been calculated. tamps Sample a Filter Active Time Stamps : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF ULINT; b Succeed := fb Filter. Get Filter Active Timestamps (ADR(a Filter Active Time Stamps),SIZEOF(a Filter Active Time Stamps)); 5.1.15 FB_FTR_Gaussian The function block FB_FTR_Gaussian implements a Gaussian filter. The filter calculates the weighted average of M input values. The weights are calculated using a Gaussian function, where the standard deviation σ determines the cut-off frequency of the filter. The cut-off frequency f is defined by the standard deviation σ and the sampling rate f such that the c s normalized amplitude response takes the value 1/sqrt(2) ≈ -3d B at the cut-off frequency. The filter specification is transferred with the structure ST_FTR_Gaussian [} 84]. Syntax Declaration: fb Filter : FB_FTR_Gaussian(st Config := ...) Definition: FUNCTION_BLOCK FB_FTR_Gaussian VAR_INPUT st Config : ST_FTR_Gaussian; TF3680 Version: 1.7.0 71
## Page 72

PLC API END_VAR VAR_OUTPUT b Error : BOOL; b Configured : BOOL; ip Result Message : I_TCMessage; END_VAR Inputs Name Type Description st Config ST_FTR_Gaussian [} 84] Structure for configuring the filter behavior Outputs Name Type Description b Error BOOL TRUE, if an error occurs. b Configured BOOL TRUE if the configuration was successful. ip Result Message I_TCMessage Interface that provides properties and methods for message handling Methods Name Definition location Description Configure() Local Loads a new (or initial) configuration structure. Call() Local Calculates the output signal for a given input signal and filter configuration. Reset() Local Resets internal states. Properties Name Type Access Definition lo- Initial value Description cation b Trace Level Default BOOL Get, Set Local TRUE TRUE if e Trace Level = Critical e Trace Level Tc Event Severity Get, Set Local Critical Severity of an event Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.25 PC or CX (x64, x86) Tc3_Filter 5.1.15.1 Configure This method can be used at runtime to initially configure the instance of a filter (if it was not already configured in the declaration) or to reconfigure it. If a filter instance is not configured, the methods Call() and Reset() cannot be used. Syntax METHOD Configure : BOOL VAR_INPUT st Config : ST_FTR_PT1; END_VAR 72 Version: 1.7.0 TF3680
## Page 73

PLC API Inputs Name Type Description st Config ST_FTR_PT1 [} 78] Structure for configuring the filter behavior Return value Name Type Description Configure BOOL TRUE if the filter instance was configured successfully. Sample (*Declaration without configuration*) fb Filter : FB_FTR_PT1 (); (* initial configuration of fb Filter *) IF b Init THEN b Succeed := fb Filter. Configure(st Config := st Params); b Init := FALSE END_IF (* reconfigure fb Filter on b Reconfigure = TRUE *) IF b Reconfigure THEN st Params.f Kp := 2; (*change gain*) b Succeed := fb Filter. Configure(st Config := st Params); b Reconfigure := FALSE; END_IF 5.1.15.2 Call The method calculates a manipulated output signal from an input signal that is transferred in the form of a pointer. Syntax METHOD Call : BOOL VAR_INPUT p In : POINTER TO LREAL; n Size In : UDINT; p Out : POINTER TO LREAL; n Size Out : UDINT; END_VAR Inputs Name Type Description p In POINTER TO LREAL Address of the input array n Size In UDINT Size of the input array p Out POINTER TO LREAL Address of the output array n Size Out UDINT Size of the output array Return value Name Type Description Call BOOL Returns TRUE if a manipulated output signal has been calculated. Sample a Input : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; a Output : ARRAY [1..c Channels] OF ARRAY [1..c Oversamples] OF LREAL; b Succeed := fb Filter. Call(ADR(a Input), SIZEOF(a Input), ADR(a Output), SIZEOF(a Output)); TF3680 Version: 1.7.0 73
## Page 74

PLC API 5.1.15.3 Reset The method resets the internal status of the filter. The current output value y[n] consists of the current input value x[n] and past input and output values (x[n-k] and y[n-k], k > 0). Resetting the function block returns the filter to its original state, i.e. without any influence from the past. The filter is thus reset to the last configuration state. See also: Digital filters [} 15] Syntax METHOD Reset : BOOL Return value Name Type Description Reset BOOL Returns TRUE if the internal status of the filter was successfully reset. 5.2 Data types 5.2.1 Configuration structures General description An individual configuration structure ST_FTR_<type> exists for each function block FB_FTR_<type>. In the configuration structure all parameters are defined that are required for the calculation of the transfer function, the input and output variables (size and form of the arrays) as well as the internal states. Common parameters All configuration structures ST_FTR_<type> contain the following parameters: Parameter Type Description n Oversamples UDINT Number of oversamples > 0 n Channels UDINT Number of channels > 0 & < 101 p Initial Values POINTER TO LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) n Oversamples and n Channels The parameters n Oversamples and n Channels describe the size of the input and output arrays that are transferred when the Call() method is called. If, for example, 10 oversamples and 3 channels are used, the Call() method expects an array with 30 elements at the input and output (see Oversampling and channels [} 28]). The parameter n Channels describes the number of parallel signal channels to be processed with a call. The parameter n Oversamples describes the number of samples that occur for each individual channel and each call of the Call() method. Inital Values The optional parameters p Initial Values and n Initial Values Size are used to define the internal state of the filter after its configuration. In practice, the parameters are used to reduce the settling time of the configured filter by introducing prior knowledge. For this purpose, the historical values y[n-k] and x[n-k] with k > 0 in the difference equation must be set in a targeted manner. 74 Version: 1.7.0 TF3680
## Page 75

PLC API The following structure of the difference equation applies to the function blocks FB_FTR_IIRCoeff [} 30], FB_FTR_Mov Avg [} 38], FB_FTR_PT1 [} 41], FB_FTR_PT2 [} 44] and FB_FTR_PT3 [} 47]: For a more compact illustration, the following notations are used for the historical values: x and y , where i,k i,k channel i and time delay k > 0. Sample: Channel i = 2 and delay k = 3 corresponds to y = y [n-3]. 2,3 2 Application options: • Initial Values = nullptr All historical values y and x with k > 0 are set to zero for all channels i. This corresponds to the i,k i,k behavior if the entries of the structure are not used. • Initial Values = P All historical values x , where k > 0, are set for all channels i to the value P. All historical values y with i,k i,k k > 0 are set to V*P for all channels i, where V corresponds to the DC gain of the filter. Accordingly, the filter is in steady state for all channels with respect to a constant input signal x[n] = P. • Initial Values = [x ,x ,…,x ,y ,y ,…,y ] 1,1 1,2 1,M 1,1 1,2 1,N All historical values x with k > 0 and y with k > 0 are set individually, but to the same values for all i,k i,k channels i. • Initial Values = [x ,x ,…,x ,y ,y ,…,y , 1,1 1,2 1,M 1,1 1,k 1,N x ,x ,…,x ,y ,y ,…,y , 2,1 2,2 2,M 2,1 2,2 2,N ……. x ,x ,…,x ,y ,y ,…,y ] I,1 I,2 I,M I,1 I,2 I,N All historical values x and y are set individually for every channel i = 1.. I. i,k i,k For the function blocks FB_FTR_IIRSos [} 32] and FB_FTR_IIRSpec [} 35], the transfer function is calculated in second-order sections (SOS): The compact illustration is extended accordingly by m, which specifies the biquad: x(m) and y(m) . Sample: i,k i,k Channel i = 2 and delay k = 1 of the fourth biquad (m = 4) corresponds to y(4) = y(4) [n-1]. Each biquad can use only two historical values here; accordingly, k = 1.2. 2,1 2 Therefore, the structuring for the input and output values is different there. Application options: • Initial Values = nullptr Same behavior as described above. • Initial Values = P Same behavior as described above. • Initial Values = [x(1) ,x(1) ,x(2) ,x(2) ,…,x(M) ,x(M) , 1,1 1,2 1,1 1,2 1,1 1,2 y(1) ,y(1) ,y(2) ,y(2) ,…,y(M) ,y(M) ] 1,1 1,2 1,1 1,2 1,1 1,2 All historical values x(m) and y(m) are individually set, but the same for all channels i. i,k i,k • Initial Values = [x(1) ,x(1) ,x(2) ,x(2) ,…,x(M) ,x(M) , 1,1 1,2 1,1 1,2 1,1 1,2 y(1) ,y(1) ,y(2) ,y(2) ,…,y(M) ,y(M) , 1,1 1,2 1,1 1,2 1,1 1,2 x(1) ,x(1) ,x(2) ,x(2) ,…,x(M) ,x(M) , 2,1 2,2 2,1 2,2 2,1 2,2 y(1) ,y(1) ,y(2) ,y(2) ,…,y(M) ,y(M) , 2,1 2,2 2,1 2,2 2,1 2,2 ……. x(1) ,x(1) ,x(2) ,x(2) ,…,x(M) ,x(M) , I,1 I,2 I,1 I,2 I,1 I,2 y(1) ,y(1) ,y(2) ,y(2) ,…,y(M) ,y(M) ] I,1 I,2 I,1 I,2 I,1 I,2 All historical values x(m) and y(m) are set individually for every channel i = 1.. I. i,k i,k TF3680 Version: 1.7.0 75
## Page 76

PLC API The function block FB_FTR_PTn [} 50] is also described as a cascaded filter, but as a first-order cascaded filter. Accordingly, the same consideration as for the SOS blocks applies here, but with k = 1. For a PTn filter where n = M, the following then applies: • Initial Values = nullptr Same behavior as described above. • Initial Values = P Same behavior as described above. • Initial Values = [x(1) ,x(2) ,…,x(M) , 1,1 1,1 1,1 y(1) ,y(2) ,…,y(M) ] 1,1 1,1 1,1 All historical values x(m) and y(m) are individually set, but the same for all channels i. i,k i,k • Initial Values = [x(1) ,x(2) ,…,x(M) , 1,1 1,1 1,1 y(1) ,y(2) ,…,y(M) , 1,1 1,1 1,1 x(1) ,x(2) ,…,x(M) , 2,1 2,1 2,1 y(1) ,y(2) ,…,y(M) , 2,1 2,1 2,1 ……. x(1) ,x(2) ,…,x(M) , I,1 I,1 I,1 y(1) ,y(2) ,…,y(M) ] I,1 I,1 I,1 All historical values x(m) and y(m) are set individually for every channel i = 1.. I. i,k i,k 5.2.1.1 ST_FTR_IIRCoeff Configuration structure for the function block FB_FTR_IIRCoeff [} 30]. Syntax Definition: TYPE ST_FTR_IIRCoeff : STRUCT p Coefficient Array Adr_A : POINTER TO LREAL; n Coefficient Array Size_A : UDINT; p Coefficient Array Adr_B : POINTER TO LREAL; n Coefficient Array Size_B : UDINT; b Reset : BOOL := TRUE; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description p Coefficient Array Adr_A Pointer to LREAL Pointer to an array with filter coefficients a (denominator) k [a , a , a , …, a ] 0 1 2 N n Coefficient Array Size_A UDINT Size of the array [a , a , a , ..., a ] in BYTE 0 1 2 N p Coefficient Array Adr_B Pointer to LREAL Pointer to an array with filter coefficients b (numerator) k [b , b , b , …, b ] 0 1 2 M n Coefficient Array Size_B UDINT Size of the array [b , b , b , ..., b ] in BYTE 0 1 2 M b Reset BOOL If TRUE, a reset is performed when the filter is configured. If FALSE, the historical values x[n-k] and y[n-k] are not reset. n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 76 Version: 1.7.0 TF3680
## Page 77

PLC API 5.2.1.2 ST_FTR_IIRSos Configuration structure for the function block FB_FTR_IIRSos [} 32]. Syntax Definition: TYPE ST_FTR_IIRSos : STRUCT p Coefficient Array Adr_Sos : POINTER TO LREAL; n Coefficient Array Size_Sos : UDINT; b Reset : BOOL := TRUE; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description p Coefficient Array Adr_Sos Pointer to LREAL Pointer to an array with filter coefficients [b , b , b ,a , a , a , b , b , b ,a , a , a , …. 01 11 21 01 11 21 02 12 22 02 12 22 b , b , b ,a , a , a ] 0M 1M 2M 0M 1M 2M n Coefficient Array Size_Sos UDINT Size of the array with filter coefficients in BYTES b Reset BOOL If TRUE, a reset is performed when the filter is configured. If FALSE, the historical values x[n-k] and y[n-k] are not reset. n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) An example of a filter with 3 biquads might look like this: a Coeffs_Sos : ARRAY [1..3] OF ARRAY [1..6] OF LREAL := [ [1, 1, 1, 1, 1, 1], // [b01,b11,b21,a01,a11,a21] [ [1, 1, 1, 1, 1, 1], // [b02,b12,b22,a02,a12,a22] [ [1, 1, 1, 1, 1, 1]]; // [b03,b13,b23,a03,a13,a23 5.2.1.3 ST_FTR_IIRSpec Configuration structure for the function block FB_FTR_IIRSpec [} 35]. Syntax Definition: TYPE ST_FTR_IIRSpec : STRUCT e Filter Name : E_FTR_Name; e Filter Type : E_FTR_Type; n Filter Order : UDINT; f Cutoff : LREAL; f Bandwidth : LREAL; f Pass Band Ripple : LREAL; f Sampling Rate : LREAL; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE TF3680 Version: 1.7.0 77
## Page 78

PLC API Parameters Name Type Description e Filter Name E_FTR_Name [} 84] Describes the filter implementation (Butterworth, Chebyshev, Bessel) e Filter Type E_FTR_Type [} 85] Describes the filter type (high-pass, low-pass, …) n Filter Order UDINT Filter order (max. 20 for high-pass and low-pass, max. 10 for band-pass and band-stop) f Cutoff LREAL Cut-off frequency in Hz (greater than 0 and less than f Sampling Rate/2) f Bandwidth LREAL Bandwidth in Hz with respect to band-pass and band- stop. f Passband Ripple LREAL Passband ripple of the amplitude response in the passband of the filter in d B (greater than 0) f Sampling Rate LREAL Sampling rate f in Hz s n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) Notes on the influence of the parameters on the Butterworth, Chebyshev and Bessel type filters can be found here: Filter types and parameterization [} 17]. 5.2.1.4 ST_FTR_Mov Avg Configuration structure for the function block FB_FTR_Mov Avg [} 38]. Syntax Definition: TYPE ST_FTR_Mov Avg : STRUCT n Samples To Filter : UDINT: n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description n Samples To Filter UDINT Number of samples for calculating the moving average (often referred to as window size) n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 5.2.1.5 ST_FTR_PT1 Configuration structure for the function block FB_FTR_PT1 [} 41]. 78 Version: 1.7.0 TF3680
## Page 79

PLC API Syntax Definition: TYPE ST_FTR_PT1 : STRUCT f Kp : LREAL; f T1 : LREAL; f Sampling Rate : LREAL; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description f Kp LREAL Gain factor (greater than zero) f T1 LREAL Time constant T in seconds (greater than zero) 1 f Sampling Rate LREAL Sampling rate f in Hz (greater than zero) s n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 5.2.1.6 ST_FTR_PT2 Configuration structure for the function block FB_FTR_PT2 [} 44]. Syntax Definition: TYPE ST_FTR_PT2 : STRUCT f Kp : LREAL; f T1 : LREAL; f T2 : LREAL; f Sampling Rate : LREAL; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description f Kp LREAL Gain factor (greater than zero) f T1 LREAL Time constant T in seconds (greater than zero) 1 f T2 LREAL Time constant T in seconds (greater than zero) 2 f Sampling Rate LREAL Sampling rate f in Hz (greater than zero) s n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) TF3680 Version: 1.7.0 79
## Page 80

PLC API 5.2.1.7 ST_FTR_PT3 Configuration structure for the function block FB_FTR_PT3 [} 47]. Syntax Definition: TYPE ST_FTR_PT3 : STRUCT f Kp : LREAL; f T1 : LREAL; f T2 : LREAL; f T3 : LREAL; f Sampling Rate : LREAL; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description f Kp LREAL Gain factor (greater than zero) f T1 LREAL Time constant T in seconds (greater than zero) 1 f T2 LREAL Time constant T in seconds (greater than zero) 2 f T3 LREAL Time constant T in seconds (greater than zero) 3 f Sampling Rate LREAL Sampling rate f in Hz (greater than zero) s n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 5.2.1.8 ST_FTR_PTn Configuration structure for the function block FB_FTR_PTn [} 50]. Syntax Definition: TYPE ST_FTR_PTn : STRUCT f Kp : LREAL; f T1 : LREAL; n Order : UDINT; f Sampling Rate : LREAL; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description f Kp LREAL Gain factor (greater than zero) f T1 LREAL Time constant T in seconds (greater than zero) 1 n Order UDINT Order of the filter (1..10) f Sampling Rate LREAL Sampling rate f in Hz (greater than zero) s 80 Version: 1.7.0 TF3680
## Page 81

PLC API Name Type Description n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 5.2.1.9 ST_FTR_Notch Configuration structure for the function block FB_FTR_Notch [} 53]. Syntax Definition: TYPE ST_FTR_Notch : STRUCT f Notch Frequency : LREAL; f Q : LREAL; f Sampling Rate : LREAL; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description f Notch Frequency LREAL Notch frequency in Hz (greater than 0 and less than f Sampling Rate/2) f Q LREAL Q-factor = f Notch Frequency/bandwidth (greater than zero) f Sampling Rate LREAL Sampling rate f in Hz (greater than zero) s n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) Configuration example For example, you want to create a notch filter that strongly attenuates the frequency 100 Hz. In doing so, you allow a one-sided bandwidth of 10 Hz around these 100 Hz, i.e. you expect the -3 d B limit at 90 Hz and 110 Hz. Define for this: f Notch Frequency := 100; f Q := 10; (* B = f Notch Frequency/f Q = 10 Hz *) 5.2.1.10 ST_FTR_Lead Lag Configuration structure for the function block FB_FTR_PT2 [} 44]. Syntax Definition: TYPE ST_FTR_PT2 : STRUCT f T1 : LREAL; f T2 : LREAL; f Sampling Rate : LREAL; n Oversamples : UDINT; n Channels : UDINT; TF3680 Version: 1.7.0 81
## Page 82

PLC API p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description f T1 LREAL Time constant T in seconds (greater than zero) 1 f T2 LREAL Time constant T in seconds (greater than zero) 2 f Sampling Rate LREAL Sampling rate f in Hz (greater than zero) s n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 5.2.1.11 ST_FTR_PT2oscillation Configuration structure for the function block FB_FTR_PT2oscillation [} 58]. Syntax Definition: TYPE ST_FTR_PT2 : STRUCT f Kp : LREAL; f T1 : LREAL; f Theta : LREAL; f Sampling Rate : LREAL; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description f Kp LREAL Gain factor (greater than zero) f T1 LREAL Time constant T in seconds (greater than zero) 1 f Theta LREAL Damping factor (greater than zero) f Sampling Rate LREAL Sampling rate f in Hz (greater than zero) s n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 5.2.1.12 ST_FTR_PTt Configuration structure for the function block FB_FTR_PTt [} 61]. Syntax Definition: TYPE ST_FTR_PTt : STRUCT f Kp : LREAL; 82 Version: 1.7.0 TF3680
## Page 83

PLC API f Tt : LREAL; f Sampling Rate : LREAL; n Oversamples : UDINT; n Channels : UDINT; END_STRUCT END_TYPE Parameter Name Type Description f Kp LREAL Gain factor (greater than zero) f Tt LREAL Dead time T in seconds (greater than zero) t f Sampling Rate LREAL Sampling rate f in Hz (greater than zero) s n Oversamples UDINT Number of oversamples (greater than zero and multiple of 1/f Sampling Rate) n Channels UDINT Number of channels (greater than zero and less than 101) 5.2.1.13 ST_FTR_Median Configuration structure for the function block FB_FTR_Median [} 64]. Syntax Definition: TYPE ST_FTR_Median : STRUCT n Samples To Filter : UDINT; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description n Samples To Filter UDINT Number of samples for calculating the moving average (often referred to as window size) n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 5.2.1.14 ST_FTR_Actual Value Configuration structure for the function block FB_FTR_Actual Value [} 67]. Syntax Definition: TYPE ST_FTR_Actual Value : STRUCT f Delta Max : LREAL; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE TF3680 Version: 1.7.0 83
## Page 84

PLC API Parameter Name Type Description f Delta Max LREAL Maximum difference between two input values in sequence (greater than or equal to zero) n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 5.2.1.15 ST_FTR_Gaussian Configuration structure for the function block FB_FTR_Gaussian [} 71]. Syntax Definition: TYPE ST_FTR_Gaussian : STRUCT f Cutoff : LREAL; f Sampling Rate : LREAL; n Samples To Filter : UDINT; n Oversamples : UDINT; n Channels : UDINT; p Initial Values : POINTER TO LREAL; n Initial Values Size : UDINT; END_STRUCT END_TYPE Parameter Name Type Description f Cutoff LREAL Cut-off frequency in Hz (greater than 0 and less than f Sampling Rate/2) f Sampling Rate LREAL Sampling rate f in Hz (greater than zero) s n Samples To Filter UDINT Number of samples for calculating the sliding average value (often referred to as window size). At null, the number is calculated automatically (optional) n Oversamples UDINT Number of oversamples (greater than zero) n Channels UDINT Number of channels (greater than zero and less than 101) p Initial Values Pointer to LREAL Pointer to array with initial values (optional) n Initial Values Size UDINT Size of the array with initial values in BYTE (optional) 5.2.2 E_FTR_Name ENUM for filter names. Syntax Definition: TYPE ST_FTR_Name : ( e Butterworth := 1, e Chebyshev := 2, e Bessel := 3 ) UDINT END_TYPE 84 Version: 1.7.0 TF3680
## Page 85

PLC API 5.2.3 E_FTR_Type ENUM for filter types. Syntax Definition: TYPE ST_FTR_Type : ( e Low Pass := 1, e High Pass := 2, e Band Pass := 3, e Band Stop := 4 ) UDINT END_TYPE TF3680 Version: 1.7.0 85
## Page 86

Samples 6 Samples 6.1 Configuration of a filter with FB_FTR_IIRSpec This sample shows how to configure a filter of type Butterworth with the function block FB_FTR_IIRSpec. Download: https://infosys.beckhoff.com/content/1033/TF3680_TC3_Filter/Resources/5906979595/.zip (*.tnzip) Description: • The sample project consists of a Twin CAT PLC project and a measurement project. • In the measurement project, two input signals and two output signals are configured in two axes. • The two input signals are generated synthetically via a function generator called in the PLC. They are harmonic signals (sine) with a frequency of 250 Hz for the first channel and 300 Hz for the second channel. The signals are processed by a Butterworth type filter. The implemented filter has a cut-off frequency of 250 Hz. • The MAIN PLC program is called by a task with a cycle time of 1 ms. Implementation: • First, a structure st Params of type ST_FTR_IIRSpec is declared and initialized. The structure is used for parameterizing the function block FB_FTR_IIRSpec or for configuring the filter. st Params : ST_FTR_IIRSpec := ( … ) • An instance fb Filter of the function block FB_FTR_IIRSpec is then created. The structure st Params is transferred during instantiation. fb Filter : FB_FTR_IIRSpec := (st Config := st Params); • In the source code, the Call() method is called to execute the filter, and error checking variants are listed. IF NOT fb Filter.b Error THEN fb Filter. Call(ADR(a Signal Buffer), SIZEOF(a Signal Buffer), ADR(a Filtered Signal), SIZEOF(a Filtered Signal)); ELSE // if on error state, do something n Error Count := n Error Count + 1; // e.g. check if filter is configured // IF fb Filter.b Configured THEN // or use ip Result Message to check root cause // fb Filter.ip Result Message END_IF; • The Configure() and/or Reset() methods are also called to change the filter configuration during runtime (fb Filter. Configure) or to perform a reset (fb Filter. Reset). The call of the methods is controlled by the flags b Reconfigure and b Reset. They can be manually set to TRUE or FALSE in the Online Watch. Observation: Recording with Twin CAT 3 Scope shows that the amplitude of the output signals is attenuated and phase- shifted by the filter. The signal in the second channel (green) is attenuated more strongly than that in the first channel (blue, attenuation by -3 d B). 86 Version: 1.7.0 TF3680
## Page 87

Samples Fig. 10: Signal curves of the input signals (top) and the output signals (bottom) (blue: channel 1, green: channel 2) If the flag b Reconfigure is set, the cut-off frequency is shifted to 50 Hz, which makes the amplitude of both output signals even smaller. TF3680 Version: 1.7.0 87
## Page 88

Samples Fig. 11: Signal curves of the input signals (top) and the output signals (bottom), if the flag b Reconfigure is set (blue: channel 1, green: channel 2) If the flag b Reset is set, the internal state of the filter is deleted, i.e. past input and output values are no longer taken into account. The continuous signal curve is interrupted (at approx. 27 ms), and the filter settles again. 88 Version: 1.7.0 TF3680
## Page 89

Samples Fig. 12: Signal curves of the input signals (top) and the output signals (bottom) when the flag b Reset is set (blue: channel 1, green: channel 2) See also: • Filter types and parameterization [} 17] • FB_FTR_IIRSpec [} 35] 6.2 Declaring and calling filters with FB_FTR_<type> This sample shows how the individual filter function blocks of the PLC library Tc3_Filter are declared and called. Download: https://infosys.beckhoff.com/content/1033/TF3680_TC3_Filter/Resources/5906974603/.zip (*.tnzip) Description: • The sample project consists of a Twin CAT PLC project. • In the MAIN PLC program, a function generator generates a harmonic signal that is used as input signal for the various filters. • Each filter is described in a separate function block, which is instantiated in the MAIN PLC program. • The MAIN PLC program is called by a task with a cycle time of 1 ms. Implementation: • The declarations and calls of the filter function blocks provided in the Tc3_Filter library are shown as examples in the function blocks. • The variable n Example Selector can be used to change the filter during runtime. Basic principle: TF3680 Version: 1.7.0 89
## Page 90

Samples FUNCTION_BLOCK FB_PT1 VAR_INPUT a Buffer : ARRAY [1.. MAIN.c Channels] OF ARRAY [1.. MAIN.c Oversamples] OF LREAL; END_VAR VAR_OUTPUT a Output : ARRAY [1.. MAIN.c Channels] OF ARRAY [1.. MAIN.c Oversamples] OF LREAL; END_VAR VAR st Params: ST_FTR_PT1 := (f Sampling Rate := 10000, f Kp := 1, f T1 := 6.3661977236758134307553505349006E-4, n Oversamples := MAIN.c Oversamples, n Channels := MAIN.c Channels); // f T1 correlates to fc=250 Hz fb Filter : FB_FTR_PT1:=(st Config:=st Params); END_VAR See also: • FB_FTR_IIRCoeff [} 30] • FB_FTR_IIRSpec [} 35] • FB_FTR_Mov Avg [} 38] • FB_FTR_PT1 [} 41] • FB_FTR_PT2 [} 44] • FB_FTR_PT3 [} 47] • FB_FTR_PTn [} 50] • FB_FTR_Notch [} 53] • FB_FTR_Lead Lag [} 55] • FB_FTR_PT2oscillation [} 58] • FB_FTR_PTt [} 61] • FB_FTR_Median [} 64] • FB_FTR_Actual Value [} 67] • FB_FTR_Gaussian [} 71] 6.3 Reconfiguration with initial values This sample shows how a filter can be reconfigured or dynamically adapted during runtime. It also describes how previous knowledge of a signal can be used to shorten the settling time of a filter after reconfiguration. Download: https://infosys.beckhoff.com/content/1033/TF3680_TC3_Filter/Resources/5906977931/.zip (*.tnzip) Description: • The sample project consists of a Twin CAT PLC project and a measurement project. • Two output signals and a counter variable are configured in the measurement project. • The input signal is generated synthetically via a function generator that is called in the PLC. The signal is processed by two Butterworth low-pass filters that are configured in different ways. • Each filter is described in a separate function block, which is instantiated in the MAIN PLC program. • The MAIN PLC program is called by a task with a cycle time of 1 ms. Observation: The recording of the Twin CAT 3 Scope shows a signal curve that is very noisy and jumps between two levels. 90 Version: 1.7.0 TF3680
## Page 91

Samples Fig. 13: Signal curve of the input signal (red) and signal curves of the output signals (green FB_Continuous Filter, blue: FB_Dynamic Filtering) The first filter described in the function block FB_Continous Filter remains unchanged during runtime. The output signal of this filter is limited in its dynamics due to the low-pass effect. The second filter, which is described in the function block FB_Dynamic Filtering, responds dynamically to the variations of the input signal during runtime. TF3680 Version: 1.7.0 91
## Page 92

Samples Fig. 14: Signal curve of the input signal (red) and signal curves of the output signals (green FB_Continuous Filter, blue: FB_Dynamic Filtering) (zoom into an edge) The b Trigger input informs the fb Dynamic Low Pass instance of the FB_Dynamic Filtering function block that there is a jump in the signal. In practice, this can be indicated by the signal itself or by an action initiated by the PLC. If b Trigger is set to TRUE, the Configure() method is called, which sets the low-pass cut-off frequency to the maximum permitted value. This means that the low-pass effect is lost the next time the Call() method is called. However, the output signal can quickly follow the jump in the input signal. Finally, the filter effect is reactivated by calling the Configure() method and greatly reducing the cut-off frequency. In order to reduce the settling time of the filter considerably, previous knowledge about the two plateaus is used. To this end, the parameter p Initial Values of the configuration structure st Params (type ST_FTR_IIRSpec) is assigned the initial value 1 or 5. The values are defined in the MAIN program (f Pre Knowledge High, f Pre Knowledge Low) and reflect the user's knowledge that the signal to be evaluated will jump approximately between 1 and 5. The filter is thus already in the steady state around this value when the Call() method is called for the first time. st Params.f Cutoff := Main.f Cut Off; // reduce cutoff freq. IF b Rising Edge THEN // on rising edge apply preknowledge (Signal around 5) b Rising Edge := FALSE; st Params.p Initial Values := ADR(f Init Val High Level); st Params.n Initial Values Size := SIZEOF(f Init Val High Level); ELSE // on falling edge st Params.p Initial Values := ADR(f Init Val Base Level); st Params.n Initial Values Size := SIZEOF(f Init Val Base Level); END_IF; fb Filter. Configure(st Config := st Params); 92 Version: 1.7.0 TF3680
## Page 93

Samples The time it takes to settle to the new plateau can be reduced significantly by event-based switching of the filter characteristics. See also: • FB_FTR_IIRSpec [} 35] 6.4 Reconfiguration with and without reset This sample shows how a filter can be reconfigured during runtime and which options exist to suppress a reset. Download: https://infosys.beckhoff.com/content/1033/TF3680_TC3_Filter/Resources/5907283339/.zip (*.tnzip) Description: • The sample project consists of a Twin CAT PLC project and a measurement project • Two output signals and a counter variable are configured in the measurement project. • A signal generator generates a harmonic signal with a frequency of 700 Hz. The signal is processed by two filters with identical filter coefficients. • During runtime, the system alternates between two filter configurations (parameterization of the filter coefficients). For one filter instance (fb Filter Reset), in contrast to the other filter instance (fb Filter No Reset), the Reset() method is called when the filter is reconfigured to reset the internal status of the filter. • The MAIN PLC program is called by a task with a cycle time of 1 ms. Implementation: • The parameter b Reset of the configuration structure ST_FTR_IIRCoeff can be used to control whether a reset is executed when the Configure() method is executed (default value is TRUE). st Params : ST_FTR_IIRCoeff := ( … ) st Params.b Reset := FALSE; fb Filter No Reset. Configure(st Config := st Params); Observation: If you activate the project, you can observe the output signals of the two filter instances in the measurement project. The red signal shows the output signal of the function block instance fb Filter No Reset. The time curve of the signal shows no jump through the reconfiguration. The output signal of the function block instance fb Filter Reset, on the other hand, jumps when the reconfiguration is executed, since the filter returns to zero at the time of the reconfiguration (blue signal). Fig. 15: Signal curves of the output signals during reconfiguration without reset (red) and with reset (blue) TF3680 Version: 1.7.0 93
## Page 94

Samples Fig. 16: Signal curves of the output signals during reconfiguration without reset (red) and with reset (blue) See also: • FB_FTR_IIRCoeff [} 30] 94 Version: 1.7.0 TF3680
## Page 95

Appendix 7 Appendix 7.1 Return codes Return codes of the ip Result Message. Online Watch: Defined events: n Event Id (hex) s Event Text 16#1001 Error during initialization. No router memory available. Check size of router memory. 16#1002 Error during access to object archive. 16#1004 Error in Transition PREOP->SAFEOP. 16#1005 Error in Transition SAFEOP->OP 16#1006 Error in Transition SAFEOP->OP: No Task assigned. Module will not be executed cyclically. 16#1007 Error in Transition OP->SAFEOP 16#1008 Error in Transition SAFEOP->PREOP 16#2001 Error during configuration. A nullpointer has been allocated. 16#2002 Error during configuration. A nullpointer has been allocated. 16#2003 Error during configuration. f T1 must be greater than zero. 16#2004 Error during configuration. f Samplingrate must be greater than zero. 16#2005 Error during configuration. f Cutoff must be greater than zero and smaller than f Samplingrate/2. 16#2006 Error during configuration. f Bandwidth must be greater than zero and smaller than f Samplingrate/2 - f Cutoff. 16#2007 Error during configuration. f Pass Band Ripple must be greater than zero. 16#2008 Error during configuration. f Stop Band Ripple must be greater than zero. 16#2009 Error during configuration. n Channels must be greater than zero and smaller than 101. 16#200A Error during configuration. n Oversamples must be greater than zero. 16#200B Error during configuration. n Filter Order has to be between 1 and 10/20 (band pass and band stop/ low pass and high pass) 16#200C Error during configuration. n Coefficient Array Size_A and n Coefficient Array Size_B must be equal and greater than seven. 16#200D Error during configuration. p Coefficient Array Adr_A is an invalid pointer. 16#200E Error during configuration. A0 coefficient cant be zero due zero devision. 16#200F Error during configuration. p Coefficient Array Adr_B is an invalid pointer. 16#2010 Error during configuration. f Kp must be greater than zero. 16#2011 Error during configuration. n Samples To Filter must be greater than zero. 16#2012 Error during configuration. f T2 must be greater than zero. 16#2013 Error during configuration. f T3 must be greater than zero. 16#2014 Error during configuration.n Order must be greater than zero and smaller than eleven. TF3680 Version: 1.7.0 95
## Page 96

Appendix n Event Id (hex) s Event Text 16#2015 Error during configuration. n Initial Values Size must be 0, 8, (Order B+Order A)*8 or (Order B+Order A)*n Channels*8. 16#2016 Error during configuration. Invalid Filter Name. 16#2017 Error during configuration. Invalid Filter Type. 16#2018 Error during configuration. b Reset = false is only allowed if the following filter structure member don’t change: n Coefficient Array Size_A, n Coefficient Array Size_B, n Channels and n Oversamples. 16#2019 Error during configuration. n Coefficient Array Size_Sos must be a multiple of 48. 16#201A Error during configuration. p Coefficient Array Adr_Sos is an invalid pointer. 16#201B Error during configuration. Filter parameter lead to an unstable filter, please choose other filter parameter. 16#201C Error during configuration. b Reset = false is only allowed if the following filter structure member don’t change: n Coefficient Array Size_Sos, n Channels and n Oversamples. 16#201D Error during configuration. n Initial Values Size must be 0, 8, (number of biquads)*4*8 or (number of biquads)*4*n Channels*8. 16#201E Error during configuration. f Notchfrequency must be greater than zero and smaller than f Samplingrate/2. 16#201F Error during configuration. f Q must be greater than zero. 16#2020 Error during configuration. f Theta must be greater than zero. 16#2021 Error during configuration. f Tt must be greater than zero and a multiple of 1/ f Sampling Rate. 16#2022 Error during configuration. f Delta Max must be equal or greater than zero. 16#3001 Error during runtime. No router memory available. Check size of router memory. 16#3002 Error during runtime. Missing configuration. 16#3003 Error during runtime. Cyclic caller is assigned. Methods can not be called. 16#3004 Error during runtime. Size of f In Array doesnt match with n Oversamples*n Channels. 16#3005 Error during runtime. Size of f Out Array cant be smaller than f In Array Size. 16#3006 Error during runtime. A nullpointer has been allocated @ p In. 16#3007 Error during runtime. A nullpointer has been allocated @ p Out. 7.2 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. 96 Version: 1.7.0 TF3680
## Page 97

Appendix Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com TF3680 Version: 1.7.0 97
## Page 99

More Information: www.beckhoff.com/TF3680 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
