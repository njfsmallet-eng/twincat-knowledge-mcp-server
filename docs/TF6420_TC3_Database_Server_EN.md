---
title: "TF6420 Twin CAT 3"
product: "TF6420"
category: "Communication"
tags: ["CAT", "TWIN"]
language: "EN"
document_type: "Manual"
version: "1.13.8"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF6420_TC3_Database_Server_EN.pdf"
release_date: "2025-10-22"
---
Manual | EN TF6420 Twin CAT 3 | Database Server 2025-10-22 | Version: 1.13.8
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation............................................................................................................. 5 1.2 For your safety.................................................................................................................................. 5 1.3 Notes on information security............................................................................................................ 7 2 Overview.................................................................................................................................................... 8 3 Installation................................................................................................................................................. 9 3.1 System requirements........................................................................................................................ 9 3.2 Installation......................................................................................................................................... 9 3.3 Licensing......................................................................................................................................... 12 3.4 Installation Windows CE................................................................................................................. 14 3.5 Installing the Twin CAT/BSD............................................................................................................ 16 4 Technical introduction............................................................................................................................ 17 4.1 Basic concept.................................................................................................................................. 17 4.2 Areas of application and network topologies................................................................................... 18 4.3 Compatibility.................................................................................................................................... 20 5 Configuration........................................................................................................................................... 23 5.1 Configurator.................................................................................................................................... 23 5.1.1 Integration in Visual Studio.............................................................................................. 23 5.1.2 Standalone Configurator................................................................................................ 101 5.2 Databases..................................................................................................................................... 123 5.2.1 General Information....................................................................................................... 124 5.2.2 MS SQL database.......................................................................................................... 126 5.2.3 MS SQL Compact database.......................................................................................... 128 5.2.4 My SQL database........................................................................................................... 129 5.2.5 Oracle database............................................................................................................. 131 5.2.6 SQLite............................................................................................................................ 132 5.2.7 ASCII-File....................................................................................................................... 134 5.2.8 XML database................................................................................................................ 135 5.2.9 ODBC databases........................................................................................................... 141 5.2.10 MS Access database..................................................................................................... 148 5.2.11 MS Excel database........................................................................................................ 149 5.2.12 Mongo DB....................................................................................................................... 150 5.2.13 Postgre SQL.................................................................................................................... 152 5.2.14 Influx DB.......................................................................................................................... 153 5.2.15 Influx DB2........................................................................................................................ 154 6 PLC API.................................................................................................................................................. 157 6.1 Tc3_Database............................................................................................................................... 157 6.1.1 Function blocks.............................................................................................................. 157 6.1.2 Data types...................................................................................................................... 227 6.1.3 Global constants............................................................................................................ 247 6.1.4 Obsolete......................................................................................................................... 247 6.2 Tc2_Database............................................................................................................................... 292 6.2.1 Function blocks.............................................................................................................. 294 TF6420 Version: 1.13.8 3
## Page 4

Table of contents 6.2.2 Data types...................................................................................................................... 321 6.2.3 Global Constants............................................................................................................ 325 7 Examples............................................................................................................................................... 327 7.1 Tc3_Database............................................................................................................................... 327 7.1.1 Scenario examples......................................................................................................... 327 7.1.2 Best practices................................................................................................................. 347 7.2 Tc2_Database............................................................................................................................... 359 7.2.1 Creating an MS Access database.................................................................................. 360 7.2.2 Starting / stopping, cyclic logging................................................................................... 363 7.2.3 Logging of a PLC variable with FB_DBWrite................................................................. 364 7.2.4 Example with the FB_DBRecord Insert and FB_DBRecord Select function blocks......... 368 7.2.5 Stored procedures with FB_DBStored Procedures Record Array.................................... 370 7.2.6 Using XML as database................................................................................................. 373 7.2.7 XPath sample to illustrate the different SELECT types.................................................. 378 7.2.8 XPath sample with XML schema................................................................................... 381 8 Appendix................................................................................................................................................ 386 8.1 Error codes.................................................................................................................................... 386 8.1.1 Tc3_Database................................................................................................................ 386 8.1.2 Tc2_Database................................................................................................................ 395 8.2 FAQ - frequently asked questions and answers........................................................................... 406 9 Support and Service............................................................................................................................. 409 4 Version: 1.13.8 TF6420
## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. The documentation and the following notes and explanations must be complied with when installing and commissioning the components. The trained specialists must always use the current valid documentation. The trained specialists must ensure that the application and use of the products described is in line with all safety requirements, including all relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been compiled with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. Claims to modify products that have already been supplied may not be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, ATRO® , Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, MX-System®, Safety over Ether CAT®, TC/BSD®, Twin CAT®, Twin CAT/BSD®, Twin SAFE®, XFC®, XPlanar®, and XTS® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of the designations or trademarks contained in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Ether CAT® is a registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany. Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document, as well as the use and communication of its contents without express authorization, are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. Third-party trademarks Trademarks of third parties may be used in this documentation. You can find the trademark notices here: https://www.beckhoff.com/trademarks. 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. TF6420 Version: 1.13.8 5
## Page 6

Foreword Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 6 Version: 1.13.8 TF6420
## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. TF6420 Version: 1.13.8 7
## Page 8

Overview 2 Overview The Twin CAT Database Server enables data exchange between the Twin CAT system and various database systems. For small applications it can be used via a configurator, without intervention in the existing program code. For complex tasks the Database Server offers a large library of PLC function blocks for maximum flexibility. SQL commands such as Insert or Select can be used directly from the PLC, for example. To take load off the PLC, if required, procedures can be stored (Stored Procedures) and then called up from the databases. In this case the parameters transferred by the corresponding PLC function block are used by the database in conjunction with the Stored Procedure, and results can be returned to the controller. The Twin CAT Database Server supports a wide range or different database systems, MS SQL, MS SQL Compact, MS Access, My SQL, Postgre SQL, DB2, Oracle, Interbase, Firebird, ASCII (e.g. .txt or .csv) and XML files, now also including No SQL databases, based on support of Mongo DB. (See also: Declaration of the different database types) Components • Twin CAT Database Server [} 17]: The service is started and stopped together with Twin CAT. It forms the link between the Twin CAT system and the database. • Configurator [} 101]: The Twin CAT Database Server Configurator facilitates visual setting of the database parameters required for basic communication with the respective database. • PLC library [} 292]: The PLC library includes various function blocks. They enable establishment of a database connection, creation of a new table, writing of data into any table structure using Insert commands, and reading via Select commands. It is also possible to update or delete database entries and trigger stored procedures. No SQL databases have their own function blocks that are optimized for handling flexible JSON documents in the PLC, for example. The principle of operation is identical. Principle of operation Within the Twin CAT system the Database Server communicates via ADS. Externally it links to the respective configured database. Possible network topologies can be found in section "Areas of application and network technologies [} 18]". 8 Version: 1.13.8 TF6420
## Page 9

Installation 3 Installation 3.1 System requirements Technical data TF6420 Twin CAT 3 database server Target systems Windows 10, Win CE, Twin CAT/BSD x86, x64 and Arm® . NET Framework . Net 4.5.1 or higher Win CE: . NET 3.5 Min. Twin CAT version 3.1.4018 Min. Twin CAT level TC1200 | Twin CAT 3 PLC 3.2 Installation Setup installation (Twin CAT 3.1 Build 4024) The following section describes how to install the Twin CAT 3 function for Windows-based operating systems. ü The Twin CAT 3 function setup file was downloaded from the Beckhoff website. 1. Run the setup file as administrator. To do this, select the Run As Admin command in the context menu of the file. ð The installation dialog opens. 2. Accept the end user licensing agreement and click Next. TF6420 Version: 1.13.8 9
## Page 10

Installation 3. Enter your user data. 4. If you want to install the full version of the Twin CAT 3 function, select Complete as the installation type. If you want to install the Twin CAT 3 function components separately, select Custom. 10 Version: 1.13.8 TF6420
## Page 11

Installation 5. Click Next, then Install to start the installation. ð A dialog box informs you that the Twin CAT system must be stopped to proceed with the installation. 6. Confirm the dialog with Yes. TF6420 Version: 1.13.8 11
## Page 12

Installation 7. Click Finish to exit the setup. ð The Twin CAT 3 function has been installed successfully. 3.3 Licensing The Twin CAT 3 function can be activated as a full version or as a 7-day test version. Both license types can be activated via the Twin CAT 3 development environment (XAE). Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 12 Version: 1.13.8 TF6420
## Page 13

Installation 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. TF6420 Version: 1.13.8 13
## Page 14

Installation 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. 3.4 Installation Windows CE The following section describes how to install a Twin CAT 3 function (TFxxx) on a Beckhoff Embedded PC with Windows CE. 1. Download and install the setup file [} 14] 2. Transfer the CAB file to the Windows CE device [} 15] 3. Run the CAB file on the Windows CE device [} 15] If an older TFxxx version is already installed on the Windows CE device, it can be updated: • Software upgrade [} 15] Download and install the setup file The CAB installation file for Windows CE is part of the TFxxx setup. This is made available on the Beckhoff website www.beckhoff.com and automatically contains all versions for Windows XP, Windows 7 and Windows CE (x86 and ARM). Download the TFxxx setup file and install the Twin CAT 3 function as described in the Installation [} 9] section. 14 Version: 1.13.8 TF6420
## Page 15

Installation After the installation, the installation folder contains three directories (one directory per hardware platform): • CE-ARM: ARM-based embedded PCs running Windows CE, e.g. CX8090, CX9020 • CE-X86: X86-based embedded PCs running Windows CE, e.g. CX50xx, CX20x0 • Win32: embedded PCs running Windows XP, Windows 7 or Windows Embedded Standard The CE-ARM and CE-X86 directories contain the CAB files of the Twin CAT 3 function for Windows CE in relation to the respective hardware platform of the Windows CE device. Example: installation folder "TF6310" Transfer the CAB file to the Windows CE device Transfer the corresponding CAB file to the Windows CE device. There are various options for transferring the executable file: • via network shares • via the integrated FTP server • via Active Sync • via CF/SD cards Further information can be found in the Beckhoff Information System in the "Operating Systems" documentation (Embedded PC > Operating Systems > CE). Run the CAB file on the Windows CE device After transferring the CAB file to the Windows CE device, double-click the file there. Confirm the installation dialog with OK. Then restart the Windows CE device. After restarting the device, the files of the Twin CAT 3 function (TFxxxx) are automatically loaded in the background and are then available. The software is installed in the following directory on the Windows CE device: \Hard Disk\Twin CAT\Functions\TFxxxx Software upgrade If an older version of the Twin CAT 3 function is already installed on the Windows CE device, carry out the following steps on the Windows CE device to upgrade to a new version: 1. Open the CE Explorer by clicking Start > Run and entering "Explorer". 2. Navigate to \Hard Disk\Twin CAT\Functions\TFxxx\xxxx. 3. Rename the file Tc*.exe to Tc*.old. 4. Restart the Windows CE device. 5. Transfer the new CAB file to the Windows CE device. TF6420 Version: 1.13.8 15
## Page 16

Installation 6. Run the CAB file on the Windows CE device and install the new version. 7. Delete the file Tc*.old. 8. Restart the Windows CE device. ð The new version is active after the restart. 3.5 Installing the Twin CAT/BSD The Twin CAT 3 Database Server is available as a package for Twin CAT/BSD in the package repository. Under the package name "TF6420-Database-Server" it can be installed via the command doas pkg install TF6420-Database-Server Further information about the Package Server can be found in the Embedded PC section of the Twin CAT/ BSD manual. After a system restart or restart of Twin CAT, the Twin CAT 3 Database Server is also started and can be configured from a client system via ADS. Some databases, such as SQLite, can only be used if the corresponding package has been installed. 16 Version: 1.13.8 TF6420
## Page 17

Technical introduction 4 Technical introduction 4.1 Basic concept The Twin CAT Database Server is designed to enable a database connection to the controller for all Twin CAT users, and as conveniently as possible. Notwithstanding the required simplicity, the full flexibility is to be retained, which is why the Twin CAT Database Server offers four basic categories: • Configure mode: pure configuration solution Database connections for simple applications based on graphical configurations without code implementation. • PLC Expert mode: programming solution for conventional PLC programmers Database connection for simple or complex applications based on PLC function blocks, in which the database commands are largely generated automatically by the Database Server. • SQL Expert mode: programming solution for conventional PLC programmers and database experts Database connection for simple or complex applications based on PLC function blocks and C++ interfaces, in which the database commands are assembled automatically during program execution. For maximum flexibility. • No SQL Expert mode: programming solution for PLC programmers and No SQL database experts Database connection for simple to complex applications with PLC function blocks, in which No SQL commands can be created and sent within the program sequence. Naturally, all four categories can be combined within an application. The Twin CAT Database Server can be set up via a graphical configurator. The configuration is written to an XML file, which can then be downloaded to the target system. On non-Windows CE devices the configuration file is in folder C:\Twin CAT\3.1\Boot, on Windows CE devices in folder \Hard Disk\Twin CAT\ 3.1\Boot. Read and write access are available for the different database systems. Deselectable database extensions are available for this purpose. The supported databases are described in section "Databases [} 123]". The Twin CAT Database Server service is started together with the Twin CAT system on the respective control computer. It is the link between the PLC and the database. TF6420 Version: 1.13.8 17
## Page 18

Technical introduction Configure Mode In Configure mode, the bulk of the work is done in the configurator. The configuration has to be set up for the required database and for the Auto Log group. The target browser can be used for configuring the Auto Log group, for online access to a target system, and for selecting the variables to be communicated. If the Auto Start option is used, the communication with the configured database is established directly when Twin CAT system starts up. If the Manual option is selected, the communication has to be enabled via the function block FB_PLCDBAuto Log [} 161] or for Auto Log view. PLC Expert mode In PLC Expert mode only the database configuration is set in the configurator. Further functionalities are implemented in the PLC code of the application. With the function block FB_PLCDBCreate [} 172] it is possible to dispense with the configurator and even configure the database itself from the PLC. Function blocks for reading and writing are available, if required. The function block FB_PLCDBCmd [} 184] forms the transition between PLC Expert mode and SQL Expert mode. Here, table structures can easily be mapped as PLC structures, and an SQL command with placeholders for the current structure values can be transferred to the Twin CAT Database Server. The Twin CAT Database Server then inserts all values automatically and sends the command to the database. SQL Expert Mode In SQL Expert mode users can assemble the SQL commands for Insert, Select or Update, for example, in the PLC and send them to the database via the Twin CAT Database Server. This is a very flexible and powerful option. Stored Procedures [} 202] - in database - can also be called from the PLC. Logging of structures Note the corresponding byte alignment when logging structures. No Sql Expert Mode In No SQL Expert mode, the user can compile No SQL queries such as Insert or Find and many other database-specific queries and send them to the database via the Twin CAT Database Server. New and more flexible data schemas, such as hierarchical structures and arrays, are supported. 4.2 Areas of application and network topologies The Twin CAT Database Server can be used in any control application: reading recipe data in production machines, labelling products with production data, condition monitoring or machine control, logging of wind turbine operating states, or building services. The Database Server can be integrated in the existing network architecture. The network topology is mostly influenced by the database type, the local conditions and the area of application. The following illustration shows various network topologies in which the Twin CAT Database Server can be used. 18 Version: 1.13.8 TF6420
## Page 19

Technical introduction 1. Twin CAT and the Twin CAT Database Server reside on the same computer, together with the database. The Database Server can act as gateway for many controllers via ADS. The performance must be taken into account. 2. Twin CAT and the Twin CAT Database Server reside on the same computer, while the database is on an external device. Here, too, the Database Server can act as gateway for many controllers via ADS. The performance must be taken into account. 3. The Twin CAT Database Server resides locally on each control device that has a database installed. Not all databases are suitable for this kind of application. 4. This is the most common use case. The Twin CAT Database Server is installed on each control device, and the database resides on an external server in the network. 5. Combination of case 3 and case 4. A main database resides on a server in the network, and the controllers in the field each have a local database, which kicks in when a disconnection is encountered, for example, and stores the data locally in the first instance. The Database Server is installed on each control device. TF6420 Version: 1.13.8 19
## Page 20

Technical introduction Remote access by the Twin CAT Database Server to a database For remote access by the Twin CAT Database Server to a database, various aspects have to be taken into account on the database side: • Is remote access generally permitted? • How many simultaneous connections are permitted? (In case the Twin CAT Database Server needs to open several connections) • Does the user who wishes to log onto the database with the Database Server have sufficient rights? • Is the firewall of the remote system configured appropriately? More detailed information about the configuration of your database server can be found in the corresponding database documentation [} 123]. 4.3 Compatibility The Twin CAT Database Server is a tried and tested Twin CAT product that has been around for many years. The demands on the product are constantly increasing. New developments in the Twin CAT Database Server are intended to meet these increased requirements. The Twin CAT database connections have previously been available in versions 3.0.x, 3.1.x and 3.2.x. The current version is 3.3.x As before, the database server consists of the following components: configurator, ADS server and PLC library. Version 3.0.x includes the PLC library Tc2_Database.compiled library. The PLC library in versions 3.1.x and higher is called Tc3_Database.compiled-library. Overview of released Database Server versions Database 3.0.23 3.0.26 3.0.27 3.0.28 Server 3.0.x Database 3.1.29 3.1.30 3.1.31 Server 3.1.x Database 3.2.32 Server 3.2.x Database 3.3.33 Server 3.3.x Notes on the transition from 3.0.x to 3.1.x In addition to new and higher-performance functions, a key aspect was compatibility between versions 3.0.x and 3.1.x. For example, old PLC code, in which the Tc2_Database.compiled library is used, can also be used with the new 3.1.x version ADS server. The old Tc2_Database.compiled library continues to be installed in version 3.1.x during setup. The XML files created by the configurator for the server differ between versions 3.0.x and 3.1.x. It is possible to read old configuration files with the new configurator (standalone) and even to convert them to the new format, if required. Backup of the old XML configuration During an update from the Twin CAT Database Server 3.0.x to the new 3.1.x version, the old XML configuration is saved. It is renamed to "Current Config Data Base_OLD.xml" and remains in the Twin CAT boot directory. 20 Version: 1.13.8 TF6420
## Page 21

Technical introduction Notwithstanding the general compatibility referred to above, an old configurator and an old ADS server (version 3.0.x) cannot be used with the new Tc3_Database.compiled library. The diagram below provides a compatibility overview. Notes on the transition from 3.1.x to 3.2.x The file formats for the configurations are unchanged. The ADS server was merely extended with new functionalities. All other functions are still available. In version 3.2.x the old Tc2_Database.compiled-library is installed in parallel with the Tc3_Database.compiled-library during setup. The notes for the transition from 3.0.x to 3.1.x apply. In the Tc3_Database.compiled-library, all previous function blocks have been updated from version 3.2.x onwards. The update refers to the I_Tc Message Event Logger interface. To ensure that older applications continue to function, "Evt" is appended to the names of new function blocks. All old function blocks are still contained in the library, but are now in the Obsolete folder and are marked accordingly by the compiler. Example: In version 3.1.x: FB_SQLCommand TF6420 Version: 1.13.8 21
## Page 22

Technical introduction In version 3.2.x: FB_SQLCommand Evt We recommend using the function blocks with the ending "Evt" for new projects. It should be noted that the Event Logger itself is only available from Twin CAT 3.1 Build 4022.20, and therefore the function blocks can only be used from 4022.20. Notes on the transition from 3.2.x to 3.3.x With version 3.3.x, the modularization of the Twin CAT Database Server has been further advanced on the driver side. Full compatibility is ensured. However, some drivers are no longer automatically included in the setup and must be made available separately by the user. Example: My SQL under Windows CE. For details, please refer to the settings for the respective database in the Configuration section. 22 Version: 1.13.8 TF6420
## Page 23

Configuration 5 Configuration 5.1 Configurator The Twin CAT Database Server is set and controlled via the configurator. The tool also offers a range of development facilities for speeding up the development of the application in the PLC. The configurator is integrated in Visual Studio, in order to make development as user-friendly as possible. Twin CAT projects and Twin CAT Database Server projects can be placed in a common solution. Alternatively, customers can continue to use the standalone configurator, independent of Visual Studio. 5.1.1 Integration in Visual Studio The Twin CAT Database Server is integrated in Visual Studio 2013 and Visual Studio 2015. This integration is achieved with the aid of two extensions. The two required extensions are added in the Visual Studio extension window during the installation, which contain the functionalities of the project system, among other features. 5.1.1.1 General This chapter describes the various functions and components of the Visual Studio integration of the Twin CAT Database Server. 5.1.1.1.1 User interface components The Twin CAT Database Server is integrated in Visual Studio 2013 and Visual Studio 2015. The Twin CAT Connectivity extension for Visual Studio offers a new project system. This can be used for creating a file- based Twin CAT Database Server project, for example. Typical components such as the Properties window, the Solution Explorer and the error output are supported. In addition, various editors for editing the configuration files are provided. TF6420 Version: 1.13.8 23
## Page 24

Configuration Any number of Twin CAT Database Server projects can be integrated in a Twin CAT connectivity project. The project icon indicates the state of the set target system: • Red: The Twin CAT Database Server cannot be reached. • Blue: The Twin CAT Database Server has no valid license. (See Licensing [} 12]) • Green: The Twin CAT Database Server can be reached and is ready for use. • Violet: The Twin CAT Database Server is in Auto Log mode. Data are exchanged between PLC and database. 24 Version: 1.13.8 TF6420
## Page 25

Configuration The Twin CAT Database projects map a file-based project system. The individual configuration documents are managed in the Solution Explorer. Any modifications that are pending in the editors are identified with * in the documents. If changes are made without opening a document (through the Properties window), the changes are nevertheless registered. Further information on the project system can be found in section "Twin CAT Database Server project [} 26]". Toolbar and commands The toolbar has the following elements: Toolstrip button Description Activation of the configuration Read configuration of the target device Save configuration in an XML file Read configuration from an XML file Add new database configuration Add new Auto Log group Event display Database pool Auto Log Viewer Information Log View SQL Query Editor Properties window The settings for the different project documents can be configured via dedicated editors or via the Properties window. During this process the file content is modified, but not the metadata in the project file of the Twin CAT Connectivity project. The individual properties are described in more detail in the lower part of the Properties window. Note that some lists can only be edited in the editor. TF6420 Version: 1.13.8 25
## Page 26

Configuration Output and error list Visual Studio features an integrated console output. The Twin CAT Database Server uses this feature to issue notifications, warnings or error messages. To this end the category "Twin CAT Database Server" can be selected in the output. It is possible that this category does not yet exist, if there was no previous message from the Twin CAT Database Server. In addition, the Visual Studio error list is used for communicating the main information. Both windows can be opened in Visual Studio via View > Error list/Output. 5.1.1.1.2 Twin CAT Database Server Project Build Project The Twin CAT Connectivity extension for Visual Studio provides a new project template. When a new project is created, the Twin CAT Connectivity Project category appears as an option. To create a new Twin CAT Connectivity project, select Empty Twin CAT Connectivity Project, specify the project name and the storage location and click OK to add it to the solution. In this way, Twin CAT Connectivity projects or Twin CAT Database Server projects can conveniently be created in parallel with Twin CAT or other Visual Studio projects. 26 Version: 1.13.8 TF6420
## Page 27

Configuration A new project node appears in the solution. Below the Connectivity project node you can add subprojects for the supported connectivity functions. Use Add to add a new Twin CAT Database Server project to the Twin CAT Connectivity project. The Twin CAT Database Server project can be found in the list of existing Item Templates. A new Twin CAT Database Server project is created under the Twin CAT Connectivity node. TF6420 Version: 1.13.8 27
## Page 28

Configuration This is now used as the basis for the pending configuration of a Twin CAT Database Server. The document can be edited either via the Properties window or via an editor. A Connectivity project can be associated with any number of Twin CAT Database Server projects or other projects, and it may therefore contain several configurations. Editor for server settings The Server Settings editor can be used to edit the settings for the Twin CAT Database Server. These are general settings relating to the corresponding server. In the drop-down menu (1) you can select the target system via the Ams Net ID. To this end you have to create a route to the target system via Twin CAT. When a finished configuration is transferred, the settings are stored in the Twin CAT Database Server for this target system. The settings for logging faults or errors can be configured under Log settings. In the event of a fault or error, the Database Server generates a detailed entry in a log file. The log file can be read with the Information Log Viewer [} 49]. Under Log Settings you can specify a path to the file location and the maximum file size. You can also influence the accuracy of the log. For performance reasons we recommend that logging is deactivated again after the error analysis, once it is no longer required. 28 Version: 1.13.8 TF6420
## Page 29

Configuration For network access to file-based databases such as Access or SQL Compact, the Impersonate option must be set, so that the Twin CAT Database Server can connect to this network drive. This feature is currently not supported in Windows CE. Further configuration settings are available to control the read process from the database. These settings refer to the Twin CAT Database Server on the target system: Max String Length Maximum string length of the variables in the PLC Max Byte Array Length Maximum byte array length of the variables in the PLC DBNull Allowed Indicates whether ZERO values are accepted in the Twin CAT Database Server. DBConnection Timeout Indicates the time after which the Twin CAT Database Server assumes a connection error while attempts are made to establish a connection. DBCommand Timeout Indicates the time after which the Twin CAT Database Server assumes a connection fault when a command was sent. If large data quantities are involved, processing of a command may take quite some time, depending on the database and the infrastructure. Supported database types The installed database types can be selected in the server settings. All installed databases are selected by default. The Twin CAT 3 Database Server will load the corresponding database interfaces. In this way, unused databases on the target system can be deselected. Server settings in the Properties window The settings for the Twin CAT Database Server can be adjusted in the Editor window or in the Properties window of the Database Server. These properties also directly affect the configuration file. TF6420 Version: 1.13.8 29
## Page 30

Configuration Activating a project To activate a configured project on the Twin CAT Database Server, use the command Activate Configuration in the context menu of the Twin CAT Database Server project. 30 Version: 1.13.8 TF6420
## Page 31

Configuration 5.1.1.1.3 Configuring databases A new database configuration can be added via the command Add New Database in the context menu of a Database Server project or via the corresponding command in the toolbar. A new database configuration is added in the form of a file in the project folder and integrated in the project. As with all Visual Studio projects, the information on the new files is stored in the Connectivity project. TF6420 Version: 1.13.8 31
## Page 32

Configuration The new database configuration in the Twin CAT Database Server project can be edited via the Properties window or a special editor: The properties dynamically adapt to the selected database types, since the databases have different parameters. These settings relate to the file contents, not the file properties. Editor for database configurations 32 Version: 1.13.8 TF6420
## Page 33

Configuration The database ID, which is required for some function blocks in the PLC, is shown in the upper part of the editor (1). The database types of the target database can be selected from the drop-down menu (2). Another option is the ODBC interface for a database, although this is not yet supported. Note that not all functions of the Twin CAT Database Server can be guaranteed, depending on the database. As a further option you can select a so-called failover database (3), which is triggered when an error is encountered in Configure mode. In the event of a network disconnection, this feature can automatically ensure that data are stored elsewhere and not lost. For each database [} 123] additional adjustable parameters are available. Depending on the database a connection string (5) is created, which describes the connection to the database. The intention is to make the parameters you have set more transparent. The CREATE (4) button can be used to create a new database. This function is only displayed if the respective database supports it. Unknown databases can be configured via an ODBC interface. In the ODBC Type drop-down list select "Unknown Database" and add parameters via the commands in the context menu. They may contain passwords, which are stored in encrypted form. The required connection string can be assembled from these parameters. Note that only limited functions of the Twin CAT Database Server can be used. Only the explicit function blocks of the SQL Expert mode are supported. The additional parameters can only be applied via the editor, not via the Properties window. Copying a database configuration into the database pool A corresponding command is available in the context menu for copying a database configuration into the database pool [} 48]. It is also possible to use drag & drop to move database configurations between the project and the database pool. TF6420 Version: 1.13.8 33
## Page 34

Configuration Deactivating database configurations Individual database configurations can be disabled in the project. These are then marked in red and ignored when the project is activated. 34 Version: 1.13.8 TF6420
## Page 35

Configuration 5.1.1.1.4 Configuring Auto Log groups A new Auto Log group for the database configuration can be added via the command Add New Autolog Group in the context menu of a database configuration or via the toolbar. These Auto Log groups refer to the parent database. A new Auto Log group and the corresponding components are added as files to the project folder and integrated in the project. They include the ADS device, the symbol groups and the table settings. In order to save these files in the project, you should save the Twin CAT Connectivity project file. The files can then be edited in editors or in the Properties window. TF6420 Version: 1.13.8 35
## Page 36

Configuration Start Up Auto Log mode can be enabled manually (with a command in the PLC or from the configurator) or automatically during system startup. Direction The set ADS device is used as data target or data source. Write mode The data can appended in a database line-by-line, held in a ring buffer on a temporal or quantitative basis, or simply be updated at the corresponding position. Ring buffer parameter Depending on the setting this parameter represent the time or the cycles after which the ring buffer is updated. Log mode The variable is written either after a certain cycle time or when a change occurs. Cycle Time Cycle time after which the variable is written. Configuring the ADS device The ADS device is automatically created under an Auto Log group. In the most frequent use case the ADS device is the PLC runtime. The following parameters can be set in the editor: 36 Version: 1.13.8 TF6420
## Page 37

Configuration ADS Device Name of the ADS target device. AMS Net ID Address of the target device in the Twin CAT network. AMS Port Port of the target device in the Twin CAT network. Timeout Time after which it is assumed that the connection to the target device is lost. Connection Type by Symbol Name: Connection is established based on the symbol name. by Index Group: Connection is established based on the memory index. Configuring symbols The symbols you set here are written to or read from the database, depending on whether the ADS device is the data target or the data source. The Twin CAT Target browser [} 50] can be used for convenient access. Here you can search for the symbols on the target and communicate between the two tools via drag & drop. TF6420 Version: 1.13.8 37
## Page 38

Configuration Symbols can also be added manually to symbol groups or edited. The information that is required varies, depending on whether in the ADS device the connection type was selected via the symbol name or the index groups. The starting point is always the ADS device. 38 Version: 1.13.8 TF6420
## Page 39

Configuration Symbol Name The symbol is addressed based on the set ADS device Symbol database Name of the variable in the database table name Data Type PLC data type of the symbol Bit Size Bit size of the symbols (set automatically for the data types) Index Group Index group in the Twin CAT system Index Offset Index offset in the Twin CAT system Configuring a table The table in a database can be based on a standard table structure or on an individual structure. The corresponding table can be selected from a list of possible tables. If the table does not yet exist, you can create it via the SQL Query Editor. If you select the standard table structure, a blue tick indicates whether the selected table corresponds to this structure. The specific table type offers the option to distribute the individual symbols that were set in the symbol group to the table columns in the database as required. When a data set is written to the database in Auto Log mode, the current values of the symbol group at the sampling time are saved in the corresponding table column. TF6420 Version: 1.13.8 39
## Page 40

Configuration Disabling Auto Log groups Just like individual database configurations, individual Auto Log groups can also be disabled in the project. These are then ignored when the project is enabled on the target system. A deactivated Auto Log group is indicated by a red mark. It can be reactivated with the same command. 40 Version: 1.13.8 TF6420
## Page 41

Configuration 5.1.1.1.5 SQL Query Editor The SQL Query Editor is a Database Server tool that supports the development of your application. The tool can be used to test connections and SQL commands and to check the compatibility between PLC and databases. TF6420 Version: 1.13.8 41
## Page 42

Configuration After the Twin CAT Database Server of the target system is selected, the SQL Query Editor loads the current database configuration and the tables of the successfully connected databases. Depending on whether the database supports the SQL and the No SQL interface (from the Twin CAT Database Server), it is listed under the respective category. Below the selection of the target system there is a status bar with the available commands: Table level Insert working area Opens the Insert working area to write data sets to the selected table with SQL. Select working area Opens the Select working area to read data sets from the selected table with SQL. Delete/Drop working area Opens the Delete/Drop working area to delete data sets with SQL from the selected table or to delete entire tables. No SQL working area Opens the No SQL working area to execute No SQL-specific queries. Database level Stored Procedure working area Opens the Stored Procedure working area to execute stored procedures of the database. Tables working area Opens the Tables working area to create new tables in the selected database. Update tables Updates the available tables of the selected database. General Update databases Updates the entire database tree. The working areas are opened to the right of the tree under the corresponding tab. Also from the same table several tabs can be opened at one time. Insert working area The Insert working area enables data to be written to the selected table via the Twin CAT Database Server interface for SQL function blocks. In the lower area (2) there is a table with the individual data symbols in the data set to be written. The name, PLC data type, the byte length as well as the value can be determined here. The entered values are then used via the command to generate the SQL statement. This SQL statement is then made available in a text field (3). Depending on the syntax of the database, the content may vary. The upper status bar contains the commands for interacting with the Twin CAT Database Server (1). 42 Version: 1.13.8 TF6420
## Page 43

Configuration Command Description Read tables schema Reads out the table schema of the table of the working area. Generate SQL statement Generates the SQL statement from the present table depending on the database syntax. Execution Executes the statement in the text field (3) via the respective interface of the Twin CAT Database Server. Copy the statement Copies the statement in the text field (3) as Twin CAT compatible syntax. Export as structure Exports the structure of the table of input values to a Twin CAT 3 compatible DUT. Select working area The Select working area allows reading data into the selected table via the Twin CAT Database Server interface for SQL function blocks. In the lower area (2) there is a table with the individual data symbols in the data set to be read. The name, PLC data type, as well as the byte length can be determined here. This information is then needed to interpret the data. This SQL statement is then made available in a text field (3). Depending on the syntax of the database, the content may vary. The result field (4) displays the data after the statement has been executed. If several results are returned, they can be switched through the pages. The upper status bar contains the commands for interacting with the Twin CAT Database Server (1). Command Description Read tables schema Reads out the table schema of the table of the working area. Generate SQL statement Generates the SQL statement from the present table depending on the database syntax. Execution Executes the statement in the text field (3) via the respective interface of the Twin CAT Database Server. Copy the statement Copies the statement in the text field (3) as Twin CAT compatible syntax. Export as structure Exports the structure of the table of input values to a Twin CAT 3 compatible DUT. Delete/Drop working area The Delete/Drop working area provides the option to issue SQL statements to delete either data from a table or the entire table from the database. TF6420 Version: 1.13.8 43
## Page 44

Configuration For this purpose, you can choose between the two options in the status bar. The syntax corresponding to the database is then generated in the statement field. To execute this with the Twin CAT Database Server interface, the switch FB_SQLCommand Evt. Execute is available. No Sql working area The No Sql working area supports the special functions of No Sql databases or the Twin CAT Database Server No SQL interface. ID Name Function 1 Filter/Document Depending on which function is used, this input field acts as a document or as a filter in JSON format. If you want to execute a Find operation and also carry out a projection or sort operation, you can fill these fields with Options(Find) below. 2 Options (Find) Describes additional parameters for the Find function, such as the projection or sorting. 3 Control elements Control elements for interaction with the Twin CAT Database Server interface for No SQL. 4 Data display List of returned data. Navigation allows iteration through the available pages. 44 Version: 1.13.8 TF6420
## Page 45

Configuration Find: executes a search query with the filter entered in the text field (1). Optionally, a projection or sorting operation can also be executed via the Options(Find) fields. Data is returned and listed in the data display (4). The syntax of the filters is database-specific. Aggregate: executes an aggregation with the parameters entered in the text field (1). Data is returned and listed in the data display (4). The syntax of the filters is database-specific. Insert: executes an insert query of the (JSON) document or document array entered in the text field (1). These are then written to the collection. Delete: executes a delete query on the data found with the filter in the text field (1). Any data that is found is deleted from the collection. Validate: if this option is selected, the data queries are not automatically parsed according to their own schema, but an attempt is made to map these data to the structure of the symbol from the PLC, which was specified via these parameters. With the latter function, a Find query may lead to conflicts. In contrast to structures in the PLC process image, data sets in No SQL databases do not have to follow a fixed schema. It is possible that queried documents do not have data for a specific element in the PLC structure. Or the data set carries data that does not occur in the PLC structure. These data are assigned via the name or the attribute "Element Name" in the PLC. The differences in the data can be examined via the Schema Compare tab. In the above example it can be seen that in the case of the returned document in the PLC structure, the variable "Name" has a different data type length than that of the database. The corresponding colors show the weighting of the conflict: Red: too many or too few data available. Yellow: the byte length of the data set does not match, or underlying data sets are left over or missing. Green: no conflicts TF6420 Version: 1.13.8 45
## Page 46

Configuration These conflicts are also listed under the Issue Tracker tab. It can also be read into the PLC as a string array, if required. The Remaining Json tab returns any remaining data sets as JSON. This information can also be read into the PLC as a string. The control elements in the status bar can be used to iterate through the data, as known from the other displayed data. The number of data sets displayed simultaneously can be specified. Stored Procedure working area The Twin CAT Database Server supports "Stored Procedures", which provide numerous databases for processing more complex queries at the database level or to make a simplified interface available. If Stored Procedures are present in the database, they will be listed in the dropdown list of the status bar (4). Below is the table for the input parameters (1), and for the output schema (2). In addition, there is a view for the output results (3). If the Stored Procedure is executed successfully, the results are displayed here. The status bar has the following commands: Command Description Read stored procedure input Reads out the input parameter schema. The results are shown in Table schema 1. Read Stored Procedure output Reads out the output parameter schema. The results are shown in Table schema 2. Info: This requires the execution of the Stored Procedure. Depending on the programming, data can be changed here. Design Executes the Stored Procedure via the respective interface of the Twin CAT Database Server. Export as structure Exports the structure of the table to a Twin CAT 3 compatible DUT. Table working area The Table working area is used to create new tables. 46 Version: 1.13.8 TF6420
## Page 47

Configuration Here, the table structure (1) can be created and an SQL statement can be generated from it in the corresponding field (2). The status bar (3) with the following commands can be used for this purpose: Command Description Table name Specifies the table name of the new table. Generate SQL statement Generates the SQL statement from the present table depending on the database syntax. Execution Executes the Stored Procedure via the respective interface of the Twin CAT Database Server. Copy the statement Copies the statement in the text field (2) as Twin CAT compatible syntax. 5.1.1.1.6 Auto Log view The Auto Log Viewer of the Twin CAT Database Server is a tool for controlling and monitoring the Auto Log mode. You can log into a target system, similar to the Twin CAT PLC. In logged-in state the Auto Log mode can be started or stopped. Information on the current state of the logging is shown in the lower part of the window. When an Auto Log group is selected, further information is displayed via the logged symbols. TF6420 Version: 1.13.8 47
## Page 48

Configuration ID Name Function 1 Target system Choose Target System with installed Twin CAT Database Server 2 Start Manual start of the Auto Log mode 3 Login Logging into the active Auto Log process 4 Logout Logging out of the active Auto Log process 5 Stop Manual stop of the Auto Log mode 6 Auto Log groups List of configured Auto Log groups on the target system 7 Symbols List of configured symbols for the selected Auto Log group 5.1.1.1.7 Database configuration pool The database configuration pool is a global repository for database configurations on the development system. It is used by developers as storage location for project-independent database configurations or templates for repeatedly used configurations. This pool uses the same user-specific storage location for the Visual Studio integration and for the standalone configurator. The files are retained when the Twin CAT Database Server is uninstalled. 48 Version: 1.13.8 TF6420
## Page 49

Configuration 5.1.1.1.8 Information Log View Information Log View is a tool for reading log files from the Twin CAT Database Server. Recorded information is displayed with a timestamp, IDs and error messages in plain text. The log files can not only be viewed or emptied via direct file access, but also directly via the target. This is particularly advantageous with distributed Database Servers in a network, for quick and easy access to the log file. For this access a route to the target device must exist. TF6420 Version: 1.13.8 49
## Page 50

Configuration 5.1.1.1.9 Twin CAT Target Browser The Twin CAT Target Browser is the central data management interface in the Twin CAT 3 Engineering. It can provide data from various Twin CAT target systems live via ADS or access historic data in databases. Depending on what Twin CAT 3 functions are installed on an engineering system, the ADS standard extension of the Twin CAT Target Browser is extended by further extensions (see Extensions [} 51]). Call options The Target Browser can be called via the Scope menu in Visual Studio®. Due to its ever increasing use in the Twin CAT system, it can also be opened via the Twin CAT menu under the item Target Browser. In addition, it is possible that the various tools that use the Target Browser will provide additional calls. For example, some products do this via the context menu on their respective project nodes. Architecture Within Microsoft Visual Studio® the Twin CAT Target Browser is a tool window that is subdivided into two sections. Target systems are displayed on the left-hand side ("Specific Target Area"). You can switch between the various extensions via the tabs. The details of the respective target system or the selected object respectively are displayed on the right-hand side ("Common Symbol Area"). Many extensions support a "Value Preview" for variables. This means that if you select a variable and press and hold the space bar, a small chart appears. In this way you can determine whether data have arrived or exist in a database. A search bar above the right-hand section enables the filtering/reduction of the visible symbols. The entry must be confirmed with the [Enter] key. A breadcrumb navigation bar shows the current location. 50 Version: 1.13.8 TF6420
## Page 51

Configuration Extensions The following table shows an overview of the current extensions and the product from which they were installed. Further information on the extensions can be found in the associated document sections. Extension name Products ADS [} 51] Twin CAT XAE, Twin CAT Scope, Twin CAT Io T Data Agent, Twin CAT Data base Server, Twin CAT Analytics Service Tool OPC UA [} 53] Twin CAT Scope, Twin CAT Io T Data Agent Tc Analytics [} 55] Twin CAT Analytics Workbench and Service Tool, Twin CAT Scope Tc Analytics File [} 57] Twin CAT Analytics Workbench and Service Tool, Twin CAT Scope Tc DBSrv [} 58] Twin CAT Scope 5.1.1.1.9.1 Extension – ADS The Twin CAT Target Browser ADS extension is used most frequently within the Twin CAT system. Specific Target Area All target systems registered to the local Twin CAT 3 Engineering are displayed in a tree structure in the left- hand area of the Twin CAT Target Browser (ADS). In first place is the local system, followed by the target systems such as Industrial PCs or Embedded PCs in the order of registration. The prefixed screen symbol indicates the state of the system (green: run mode, blue: config mode, red: stop mode or unreachable). The available default ADS ports are listed below a target system. If you select a port, the available symbols/ variables are displayed in the Common Symbol Area on the right-hand side of the Twin CAT Target Browser. Toolbar The toolbar of the ADS extension makes the following functions available: TF6420 Version: 1.13.8 51
## Page 52

Configuration Ports If an ADS port is not displayed by default, further ports can be added to a selection via this command. Edit Routes If an ADS route to a target system is missing, further target systems can be added via this button. Refresh The display of the target system states can be manually updated with this button. Common Symbol Area The ADS symbols available at the selected port are displayed in the right-hand area of the Twin CAT Target Browser. The addresses and the attributes, for example, are also displayed in addition to the name, the data type, the size and the symbol name. Special attributes, such as those of the units, are interpreted and output in their own columns. 52 Version: 1.13.8 TF6420
## Page 53

Configuration 5.1.1.1.9.2 Extension - OPC UA The Twin CAT Target Browser OPC UA extension offers a standardized way into the Twin CAT 3 Engineering. Specific Target Area All OPC UA Servers that have been added using the Add command in the toolbar are displayed in a tree structure in the left-hand area of the Twin CAT Target Browser (Opc Ua). The screen symbol in front of the server designation at the first level of the tree structure indicates the connection status. Below the server the created end points are subdivided into "Anonym" (anonymous) and "Authenticated" (user mode). The encryption method is displayed in brackets for each end point. If you select an end point, the available OPC UA Nodes are displayed on the right-hand side of the Twin CAT Target Browser (see also: Displaying OPC UA Nodes [} 54]) Toolbar The toolbar of the OPC UA extension makes the following functions available: Add New connections to existing OPC UA Servers can be established with this command (see also: Adding OPC UA Servers [} 53]) Remove A registered server can be removed with this command. Refresh The display in the Target Browser tree can be manually updated with this button. Common Symbol Area The available OPC UA Nodes are displayed on the right-hand side of the Twin CAT Target Browser. These reflect the hierarchical structure of the PLC project. The node class and the identifier, for example, are also displayed in addition to the name, the data type, the size and the full object name. Adding OPC UA Servers 1. Click on Add in the OPC UA toolbar. TF6420 Version: 1.13.8 53
## Page 54

Configuration ð The dialog Opc Ua End Point Selection opens. 2. Enter the URL of the server. 3. Select the end point from the drop-down list. With OPC UA you can determine via the corresponding end points whether and which method of encryption is used. It is also possible to add several end points to a server. To do this, execute the Add command again. 4. Select whether the access is anonymous or authenticated. If the access is authenticated, enter a user name and password. Authenticated access may be required if a password-protected user management has been set up for the OPC UA server (e.g. different user accounts with different rights). 5. Confirm the dialog. ð The OPC UA Server is added to the tree structure in the Target Browser with the selected end points. Displaying OPC UA Nodes In order to display the available OPC UA Nodes, select the respective end point in the tree structure on the left-hand side. If you select an end point without certified access, the nodes will be displayed directly. If the selected end point is certified, you must first trust the server certificate in a corresponding dialog. 54 Version: 1.13.8 TF6420
## Page 55

Configuration You can trust the certificate in a single case (until the Visual Studio instance is closed) or add it to the list of trusted certificates via the check box Save Certificate to Trustlist. During the first attempt to connect to an OPC UA Server it is additionally necessary to trust the certificate of the client (Target Browser) on the server side. To do this, copy the respective certificate in the certificate directory of the OPC UA Server from the "rejected" folder to the "trusted" folder. 5.1.1.1.9.3 Extension – Tc Analytics With the help of the Tc Analytics Extension of the Twin CAT Target Browser, MQTT data streams from different brokers and topics can be displayed and made available for different measurement products. All you have to do is drag and drop the desired stream symbols into the corresponding engineering tools. Specific Target Area In the left area of the Twin CAT Target Browser (Tc Analytics) all brokers and their data streams are displayed in a tree structure. In addition, historical data streams are also displayed. The current status of the system or the data stream is indicated by the preceding symbols (green: available, red: unreachable, gray: unknown status). Toolbar The toolbar of the Tc Analytics extension provides the following functions: TF6420 Version: 1.13.8 55
## Page 56

Configuration Add broker This button can be used to add broker connections. connection Delete broker This button can be used to delete existing connections to a broker from the tree. connection Refresh The display of the target system states can be manually updated with this button. Edit This button can be used to subsequently change the connection parameters. connection Machine This button opens the machine administration page. The incoming data streams of the Administration various "machines" can be managed via this page. Page Common Symbol Area The symbols of the different data streams are displayed in the right-hand area of the Twin CAT Target Browser (Tc Analytics). In addition to the name, data type, size and symbol name, attributes are also displayed, for example. Special attributes, such as those of the units, are interpreted and output in their own columns. If a historized data stream is selected, the individual recordings and their time ranges are also displayed. 56 Version: 1.13.8 TF6420
## Page 57

Configuration 5.1.1.1.9.4 Extension – Tc Analytics File With the help of the Tc Analytics Extension of the Twin CAT Target Browser, MQTT data streams from different brokers and topics can be displayed and made available for different measurement products. All you have to do is drag and drop the desired stream symbols into the corresponding engineering tools. Specific Target Area In the left area of the Twin CAT Target Browser (Tc Analytics File) all folders are displayed in which a search for Analytics File folders is to take place. Any Analytics File folders that are found are then displayed in a tree structure. Toolbar The toolbar of the Tc Analytics File extension provides the following functions: New folder This button can be used to add folder paths in which a search for Analytics File folders is to take place. Delete folder This button can be used to delete the selected folder from the tree. Refresh This button can be used to manually update the displays. This button can be used to customize various properties of the Tc Analytics File extension. Properties TF6420 Version: 1.13.8 57
## Page 58

Configuration Common Symbol Area The symbols of the different Analytics Files are displayed on the right in the Twin CAT Target Browser (Tc Analytics File). In addition to the name, data type, size and symbol name, attributes are also displayed, for example. Special attributes, such as those of the units, are interpreted and output in their own columns. In addition, the individual recordings and their time ranges are displayed. 5.1.1.1.9.5 Extension – Tc DBSrv The Tc DBSrv extension of the Twin CAT Target Browser can be used to display data sets from databases in Twin CAT Scope via the Twin CAT Database Server. Only the desired columns of the tables have to be dragged into Twin CAT Scope. A corresponding SQL command is generated automatically, which can of course still be customized manually. Specific Target Area All target systems registered to the local Twin CAT 3 Engineering are displayed in a tree structure in the left- hand area of the Twin CAT Target Browser (Tc DBSrv). In first place is the local system, followed by the target systems such as Industrial PCs or Embedded PCs in the order of registration. The prefixed screen symbol indicates the state of the system (green: run mode, blue: config mode, red: stop mode or unreachable). The available Twin CAT Database Server instances are listed below a target system. Below you will find all configured databases with their accessible tables. If a table node is selected, the individual table columns are displayed in the "Common Symbol Area". Toolbar The toolbar of the Tc DBSrv extension provides the following functions: 58 Version: 1.13.8 TF6420
## Page 59

Configuration Edit Routes If an ADS route to a target system is missing, further target systems can be added via this button. If the filter is active, only those routes are displayed where a Twin CAT Database Server is Filter installed and accessible. Add database This button can be used to create database configurations. Databases from the database pool or new configurations can be created on the Twin CAT Database Server. The familiar configuration editors open. Delete This button can be used to delete the selected database configuration from the Twin CAT Database Server. database Refresh The display of the target system states can be manually updated with this button. Set timestamp This button or the corresponding context menu item in the table node can be used to specify a column as timestamp; the time range of the table is read out based on this column. column Common Symbol Area The tables are displayed with their columns in the right-hand area of the Twin CAT Target Browser (Tc DBSrv). In addition to the name and the data type, the size of the columns is also displayed. If a column is defined as a timestamp column, the time range of the data is displayed TF6420 Version: 1.13.8 59
## Page 60

Configuration 5.1.1.1.10 Support Information Report The Support Information Report is a tool for collecting product information for submission to Beckhoff technical support. Collecting product-related data such as Twin CAT version/build, product version, image version and device type reduces email traffic significantly and enables more efficient advice. Plug-in mechanism Various Beckhoff products interface with the Support Information Report via a plug-in mechanism. These products, such as the Twin CAT Database Server, have a Support Information Report entry in the corresponding product menu. Creating and submitting a Support Information Report ü A Support Information Report is open. 1. Use the Behaviour text field to describe the behavior that occurred in as much detail as possible. 2. In the Attachment area, you can add files (screenshots etc.) to the report via the Add Attachment button, if required. Files can optionally be selected via remote access. To do this, select a target from the Remote System dropdown list. Depending on the selected target, it may be possible to browse Windows CE devices. 3. Enter your contact details and select a Beckhoff subsidiary for your country. This information is obligatory for submitting the Support Information Report. 4. You will be offered the option to store your contact details for future Support Information Reports. To do this, tick the Store personal data check box. 5. The product-specific plug-ins can be found in the lower section of the Support Information Report. Tick the Include in report check box. The information required for the product is added automatically, if it is available. The screenshot shows the current configuration of a Twin CAT Database Server in the form of an XML file as an example. 6. Submitting the Support Information Report: • If the device has an email connection, you can submit the Support Information Report directly to the Beckhoff subsidiary for your country via the Send Report button. • If the device does not have an email connection, you can save the Support Information Report locally as a .zip file via the Save .zip button and then make it available via FTP, USB etc. 60 Version: 1.13.8 TF6420
## Page 61

Configuration 5.1.1.2 Configure mode This chapter is a compilation of all the information required for using the Configure mode of the Twin CAT Database Server. It deals with the following topics: • Creating a project • Creating and setting up a database configuration • Creating and setting up Auto Log groups • Activating a Database Server project • Monitoring and controlling automatic logging Configure Mode In Configure mode, the bulk of the work is done in the configurator. The configuration has to be set up for the required database and for the Auto Log group. The target browser can be used for configuring the Auto Log group, for online access to a target system, and for selecting the variables to be communicated. If the Auto Start option is used, the communication with the configured database is established directly when Twin CAT system starts up. If the Manual option is selected, the communication has to be enabled via the function block FB_PLCDBAuto Log [} 161] or for Auto Log view. Build Project The Twin CAT Connectivity extension for Visual Studio provides a new project template. When a new project is created, the Twin CAT Connectivity Project category appears as an option. TF6420 Version: 1.13.8 61
## Page 62

Configuration To create a new Twin CAT Connectivity project, select Empty Twin CAT Connectivity Project, specify the project name and the storage location and click OK to add it to the solution. In this way, Twin CAT Connectivity projects or Twin CAT Database Server projects can conveniently be created in parallel with Twin CAT or other Visual Studio projects. A new project node appears in the solution. Below the Connectivity project node you can add subprojects for the supported connectivity functions. Use Add to add a new Twin CAT Database Server project to the Twin CAT Connectivity project. The Twin CAT Database Server project can be found in the list of existing Item Templates. A new Twin CAT Database Server project is created under the Twin CAT Connectivity node. 62 Version: 1.13.8 TF6420
## Page 63

Configuration This is now used as the basis for the pending configuration of a Twin CAT Database Server. The document can be edited either via the Properties window or via an editor. A Connectivity project can be associated with any number of Twin CAT Database Server projects or other projects, and it may therefore contain several configurations. Editor for server settings The Server Settings editor can be used to edit the settings for the Twin CAT Database Server. These are general settings relating to the corresponding server. In the drop-down menu (1) you can select the target system via the Ams Net ID. To this end you have to create a route to the target system via Twin CAT. When a finished configuration is transferred, the settings are stored in the Twin CAT Database Server for this target system. The settings for logging faults or errors can be configured under Log settings. In the event of a fault or error, the Database Server generates a detailed entry in a log file. The log file can be read with the Information Log Viewer [} 49]. Under Log Settings you can specify a path to the file location and the maximum file size. You can also influence the accuracy of the log. For performance reasons we recommend that logging is deactivated again after the error analysis, once it is no longer required. TF6420 Version: 1.13.8 63
## Page 64

Configuration For network access to file-based databases such as Access or SQL Compact, the Impersonate option must be set, so that the Twin CAT Database Server can connect to this network drive. This feature is currently not supported in Windows CE. Further configuration settings are available to control the read process from the database. These settings refer to the Twin CAT Database Server on the target system: Max String Length Maximum string length of the variables in the PLC Max Byte Array Length Maximum byte array length of the variables in the PLC DBNull Allowed Indicates whether ZERO values are accepted in the Twin CAT Database Server. DBConnection Timeout Indicates the time after which the Twin CAT Database Server assumes a connection error while attempts are made to establish a connection. DBCommand Timeout Indicates the time after which the Twin CAT Database Server assumes a connection fault when a command was sent. If large data quantities are involved, processing of a command may take quite some time, depending on the database and the infrastructure. Supported database types The installed database types can be selected in the server settings. All installed databases are selected by default. The Twin CAT 3 Database Server will load the corresponding database interfaces. In this way, unused databases on the target system can be deselected. Adding a new database configuration The database configuration is required for furnishing the Database Server with all the information required for the database connection. A new database configuration can be added via the command Add New Database in the context menu of a Database Server project or via the corresponding command in the toolbar. 64 Version: 1.13.8 TF6420
## Page 65

Configuration A new database configuration is added in the form of a file in the project folder and integrated in the project. As with all Visual Studio projects, the information on the new files is stored in the Connectivity project. Editor for database configurations The database ID, which is required for some function blocks in the PLC, is shown in the upper part of the editor (1). The database types of the target database can be selected from the drop-down menu (2). Another option is the ODBC interface for a database, although this is not yet supported. Note that not all functions of the Twin CAT Database Server can be guaranteed, depending on the database. As a further option you can select a so-called failover database (3), which is triggered when an error is encountered in Configure mode. In the event of a network disconnection, this feature can automatically ensure that data are stored elsewhere and not lost. TF6420 Version: 1.13.8 65
## Page 66

Configuration For each database [} 123] additional adjustable parameters are available. Depending on the database a connection string (5) is created, which describes the connection to the database. The intention is to make the parameters you have set more transparent. The CREATE (4) button can be used to create a new database. This function is only displayed if the respective database supports it. Unknown databases can be configured via an ODBC interface. In the ODBC Type drop-down list select "Unknown Database" and add parameters via the commands in the context menu. They may contain passwords, which are stored in encrypted form. The required connection string can be assembled from these parameters. Note that only limited functions of the Twin CAT Database Server can be used. Only the explicit function blocks of the SQL Expert mode are supported. Failover database The Twin CAT 3 Database Server has a failover database function. This function offers an option to switch to another database in the event of a connection loss or other problems with the database that was set up, in order to avoid possible data loss. This function is only supported by the Configure mode. In the case of automatic writing, the corresponding alternative database is used in the event of an error. The table of the first database must match the second. Adding a new Auto Log group The Auto Log groups contain information on which variables of the PLC are to be synchronized with which variables from the databases. In addition, information about the synchronization times and the type of synchronization are stored here. A new Auto Log group for the database configuration can be added via the command Add New Autolog Group in the context menu of a database configuration or via the toolbar. These Auto Log groups refer to the parent database. 66 Version: 1.13.8 TF6420
## Page 67

Configuration A new Auto Log group and the corresponding components are added as files to the project folder and integrated in the project. They include the ADS device, the symbol groups and the table settings. In order to save these files in the project, you should save the Twin CAT Connectivity project file. The files can then be edited in editors or in the Properties window. TF6420 Version: 1.13.8 67
## Page 68

Configuration Start Up Auto Log mode can be enabled manually (with a command in the PLC or from the configurator) or automatically during system startup. Direction The set ADS device is used as data target or data source. Write mode The data can appended in a database line-by-line, held in a ring buffer on a temporal or quantitative basis, or simply be updated at the corresponding position. Ring buffer parameter Depending on the setting this parameter represent the time or the cycles after which the ring buffer is updated. Log mode The variable is written either after a certain cycle time or when a change occurs. Cycle Time Cycle time after which the variable is written. Configuring the ADS device The ADS device is automatically created under an Auto Log group. In the most frequent use case the ADS device is the PLC runtime. The following parameters can be set in the editor: 68 Version: 1.13.8 TF6420
## Page 69

Configuration ADS Device Name of the ADS target device. AMS Net ID Address of the target device in the Twin CAT network. AMS Port Port of the target device in the Twin CAT network. Timeout Time after which it is assumed that the connection to the target device is lost. Connection Type by Symbol Name: Connection is established based on the symbol name. by Index Group: Connection is established based on the memory index. Configuring symbols The symbols you set here are written to or read from the database, depending on whether the ADS device is the data target or the data source. The Twin CAT Target browser [} 50] can be used for convenient access. Here you can search for the symbols on the target and communicate between the two tools via drag & drop. Symbols can also be added manually to symbol groups or edited. The information that is required varies, depending on whether in the ADS device the connection type was selected via the symbol name or the index groups. The starting point is always the ADS device. TF6420 Version: 1.13.8 69
## Page 70

Configuration Symbol Name The symbol is addressed based on the set ADS device Symbol database Name of the variable in the database table name Data Type PLC data type of the symbol Bit Size Bit size of the symbols (set automatically for the data types) Index Group Index group in the Twin CAT system Index Offset Index offset in the Twin CAT system Configuring a table The table in a database can be based on a standard table structure or on an individual structure. The corresponding table can be selected from a list of possible tables. If the table does not yet exist, you can create it via the SQL Query Editor. If you select the standard table structure, a blue tick indicates whether the selected table corresponds to this structure. 70 Version: 1.13.8 TF6420
## Page 71

Configuration The specific table type offers the option to distribute the individual symbols that were set in the symbol group to the table columns in the database as required. When a data set is written to the database in Auto Log mode, the current values of the symbol group at the sampling time are saved in the corresponding table column. TF6420 Version: 1.13.8 71
## Page 72

Configuration Activating a project To activate a configured project on the Twin CAT Database Server, use the command Activate Configuration in the context menu of the Twin CAT Database Server project. 72 Version: 1.13.8 TF6420
## Page 73

Configuration Logging of the variable starts when the Twin CAT system starts, depending on which startup behavior was specified in the Auto Log group. The mode can be started manually via the following Auto Log Viewer or with the corresponding function block from the PLC. Auto Log Viewer The Auto Log Viewer of the Twin CAT Database Server is a tool for controlling and monitoring the Auto Log mode. You can log into a target system, similar to the Twin CAT PLC. In logged-in state the Auto Log mode can be started or stopped. Information on the current state of the logging is shown in the lower part of the window. When an Auto Log group is selected, further information is displayed via the logged symbols. TF6420 Version: 1.13.8 73
## Page 74

Configuration ID Name Function 1 Target system Choose Target System with installed Twin CAT Database Server 2 Start Manual start of the Auto Log mode 3 Login Logging into the active Auto Log process 4 Logout Logging out of the active Auto Log process 5 Stop Manual stop of the Auto Log mode 6 Auto Log groups List of configured Auto Log groups on the target system 7 Symbols List of configured symbols for the selected Auto Log group The Auto Log Viewer can be used to start and monitor the configured application. Depending on setting, after login and startup the incrementing cycle counter of the Auto Log group is visible according to the update times. Update errors are also shown here. For more detailed handling we recommend the Information Log View. More detailed error handling with the Information Log View Information Log View is a tool for reading log files from the Twin CAT Database Server. Recorded information is displayed with a timestamp, IDs and error messages in plain text. The log files can not only be viewed or emptied via direct file access, but also directly via the target. This is particularly advantageous with distributed Database Servers in a network, for quick and easy access to the log file. For this access a route to the target device must exist. 74 Version: 1.13.8 TF6420
## Page 75

Configuration 5.1.1.3 PLC Expert mode This chapter is a compilation of all the information required for using the PLC Expert mode of the Twin CAT Database Server. In contrast to the Configure mode, in this mode data are not written or read based on cycles or events, but at specific times within the program sequence. This requires knowledge of the SQL language. PLC Expert mode In PLC Expert mode only the database configuration is set in the configurator. Further functionalities are implemented in the PLC code of the application. With the function block FB_PLCDBCreate [} 172] it is possible to dispense with the configurator and even configure the database itself from the PLC. Function blocks for reading and writing are available, if required. The function block FB_PLCDBCmd [} 184] forms the transition between PLC Expert mode and SQL Expert mode. Here, table structures can easily be mapped as PLC structures, and an SQL command with placeholders for the current structure values can be transferred to the Twin CAT Database Server. The Twin CAT Database Server then inserts all values automatically and sends the command to the database. Build Project The Twin CAT Connectivity extension for Visual Studio provides a new project template. When a new project is created, the Twin CAT Connectivity Project category appears as an option. TF6420 Version: 1.13.8 75
## Page 76

Configuration To create a new Twin CAT Connectivity project, select Empty Twin CAT Connectivity Project, specify the project name and the storage location and click OK to add it to the solution. In this way, Twin CAT Connectivity projects or Twin CAT Database Server projects can conveniently be created in parallel with Twin CAT or other Visual Studio projects. A new project node appears in the solution. Below the Connectivity project node you can add subprojects for the supported connectivity functions. Use Add to add a new Twin CAT Database Server project to the Twin CAT Connectivity project. The Twin CAT Database Server project can be found in the list of existing Item Templates. A new Twin CAT Database Server project is created under the Twin CAT Connectivity node. 76 Version: 1.13.8 TF6420
## Page 77

Configuration This is now used as the basis for the pending configuration of a Twin CAT Database Server. The document can be edited either via the Properties window or via an editor. A Connectivity project can be associated with any number of Twin CAT Database Server projects or other projects, and it may therefore contain several configurations. Editor for server settings The Server Settings editor can be used to edit the settings for the Twin CAT Database Server. These are general settings relating to the corresponding server. In the drop-down menu (1) you can select the target system via the Ams Net ID. To this end you have to create a route to the target system via Twin CAT. When a finished configuration is transferred, the settings are stored in the Twin CAT Database Server for this target system. The settings for logging faults or errors can be configured under Log settings. In the event of a fault or error, the Database Server generates a detailed entry in a log file. The log file can be read with the Information Log Viewer [} 49]. Under Log Settings you can specify a path to the file location and the maximum file size. You can also influence the accuracy of the log. For performance reasons we recommend that logging is deactivated again after the error analysis, once it is no longer required. TF6420 Version: 1.13.8 77
## Page 78

Configuration For network access to file-based databases such as Access or SQL Compact, the Impersonate option must be set, so that the Twin CAT Database Server can connect to this network drive. This feature is currently not supported in Windows CE. Further configuration settings are available to control the read process from the database. These settings refer to the Twin CAT Database Server on the target system: Max String Length Maximum string length of the variables in the PLC Max Byte Array Length Maximum byte array length of the variables in the PLC DBNull Allowed Indicates whether ZERO values are accepted in the Twin CAT Database Server. DBConnection Timeout Indicates the time after which the Twin CAT Database Server assumes a connection error while attempts are made to establish a connection. DBCommand Timeout Indicates the time after which the Twin CAT Database Server assumes a connection fault when a command was sent. If large data quantities are involved, processing of a command may take quite some time, depending on the database and the infrastructure. Supported database types The installed database types can be selected in the server settings. All installed databases are selected by default. The Twin CAT 3 Database Server will load the corresponding database interfaces. In this way, unused databases on the target system can be deselected. Adding a database configuration A new database configuration can be added via the command Add New Database in the context menu of a Database Server project or via the corresponding command in the toolbar. 78 Version: 1.13.8 TF6420
## Page 79

Configuration A new database configuration is added in the form of a file in the project folder and integrated in the project. As with all Visual Studio projects, the information on the new files is stored in the Connectivity project. Editor for database configurations The database ID, which is required for some function blocks in the PLC, is shown in the upper part of the editor (1). The database types of the target database can be selected from the drop-down menu (2). Another option is the ODBC interface for a database, although this is not yet supported. Note that not all functions of the Twin CAT Database Server can be guaranteed, depending on the database. As a further option you can select a so-called failover database (3), which is triggered when an error is encountered in Configure mode. In the event of a network disconnection, this feature can automatically ensure that data are stored elsewhere and not lost. TF6420 Version: 1.13.8 79
## Page 80

Configuration For each database [} 123] additional adjustable parameters are available. Depending on the database a connection string (5) is created, which describes the connection to the database. The intention is to make the parameters you have set more transparent. The CREATE (4) button can be used to create a new database. This function is only displayed if the respective database supports it. Unknown databases can be configured via an ODBC interface. In the ODBC Type drop-down list select "Unknown Database" and add parameters via the commands in the context menu. They may contain passwords, which are stored in encrypted form. The required connection string can be assembled from these parameters. Note that only limited functions of the Twin CAT Database Server can be used. Only the explicit function blocks of the SQL Expert mode are supported. No additional Auto Log group configuration is required in this mode, since writing and reading between the database and the PLC is called manually by the PLC programmer. The configuration part is now complete. Activating a project To activate a configured project on the Twin CAT Database Server, use the command Activate Configuration in the context menu of the Twin CAT Database Server project. 80 Version: 1.13.8 TF6420
## Page 81

Configuration Once the project has been activated, the can be used for further development steps, such as creating databases or tables, generating structures for the PLC, which match the corresponding table structure of the database, or testing connections to the database with the implemented information. The PLC programmer can use the available PLC API [} 165] function blocks to communicate with the Twin CAT Database Server. 5.1.1.4 SQL Expert mode This chapter describes all the steps required for using the SQL Expert mode. This mode is tailored for users with individual requirements. The following topics will be discussed: 1. Creating a project 2. Creating and setting up a database configuration 3. Activating a Database Server project 4. Creating SQL commands with the SQL Query Editor SQL Expert Mode In SQL Expert mode users can assemble the SQL commands for Insert, Select or Update, for example, in the PLC and send them to the database via the Twin CAT Database Server. This is a very flexible and powerful option. Stored Procedures [} 202] - in database - can also be called from the PLC. Build Project The Twin CAT Connectivity extension for Visual Studio provides a new project template. When a new project is created, the Twin CAT Connectivity Project category appears as an option. TF6420 Version: 1.13.8 81
## Page 82

Configuration To create a new Twin CAT Connectivity project, select Empty Twin CAT Connectivity Project, specify the project name and the storage location and click OK to add it to the solution. In this way, Twin CAT Connectivity projects or Twin CAT Database Server projects can conveniently be created in parallel with Twin CAT or other Visual Studio projects. A new project node appears in the solution. Below the Connectivity project node you can add subprojects for the supported connectivity functions. Use Add to add a new Twin CAT Database Server project to the Twin CAT Connectivity project. The Twin CAT Database Server project can be found in the list of existing Item Templates. A new Twin CAT Database Server project is created under the Twin CAT Connectivity node. 82 Version: 1.13.8 TF6420
## Page 83

Configuration This is now used as the basis for the pending configuration of a Twin CAT Database Server. The document can be edited either via the Properties window or via an editor. A Connectivity project can be associated with any number of Twin CAT Database Server projects or other projects, and it may therefore contain several configurations. Editor for server settings The Server Settings editor can be used to edit the settings for the Twin CAT Database Server. These are general settings relating to the corresponding server. In the drop-down menu (1) you can select the target system via the Ams Net ID. To this end you have to create a route to the target system via Twin CAT. When a finished configuration is transferred, the settings are stored in the Twin CAT Database Server for this target system. The settings for logging faults or errors can be configured under Log settings. In the event of a fault or error, the Database Server generates a detailed entry in a log file. The log file can be read with the Information Log Viewer [} 49]. Under Log Settings you can specify a path to the file location and the maximum file size. You can also influence the accuracy of the log. For performance reasons we recommend that logging is deactivated again after the error analysis, once it is no longer required. TF6420 Version: 1.13.8 83
## Page 84

Configuration For network access to file-based databases such as Access or SQL Compact, the Impersonate option must be set, so that the Twin CAT Database Server can connect to this network drive. This feature is currently not supported in Windows CE. Further configuration settings are available to control the read process from the database. These settings refer to the Twin CAT Database Server on the target system: Max String Length Maximum string length of the variables in the PLC Max Byte Array Length Maximum byte array length of the variables in the PLC DBNull Allowed Indicates whether ZERO values are accepted in the Twin CAT Database Server. DBConnection Timeout Indicates the time after which the Twin CAT Database Server assumes a connection error while attempts are made to establish a connection. DBCommand Timeout Indicates the time after which the Twin CAT Database Server assumes a connection fault when a command was sent. If large data quantities are involved, processing of a command may take quite some time, depending on the database and the infrastructure. Supported database types The installed database types can be selected in the server settings. All installed databases are selected by default. The Twin CAT 3 Database Server will load the corresponding database interfaces. In this way, unused databases on the target system can be deselected. Adding a database configuration A new database configuration can be added via the command Add New Database in the context menu of a Database Server project or via the corresponding command in the toolbar. 84 Version: 1.13.8 TF6420
## Page 85

Configuration A new database configuration is added in the form of a file in the project folder and integrated in the project. As with all Visual Studio projects, the information on the new files is stored in the Connectivity project. Editor for database configurations The database ID, which is required for some function blocks in the PLC, is shown in the upper part of the editor (1). The database types of the target database can be selected from the drop-down menu (2). Another option is the ODBC interface for a database, although this is not yet supported. Note that not all functions of the Twin CAT Database Server can be guaranteed, depending on the database. As a further option you can select a so-called failover database (3), which is triggered when an error is encountered in Configure mode. In the event of a network disconnection, this feature can automatically ensure that data are stored elsewhere and not lost. TF6420 Version: 1.13.8 85
## Page 86

Configuration For each database [} 123] additional adjustable parameters are available. Depending on the database a connection string (5) is created, which describes the connection to the database. The intention is to make the parameters you have set more transparent. The CREATE (4) button can be used to create a new database. This function is only displayed if the respective database supports it. Unknown databases can be configured via an ODBC interface. In the ODBC Type drop-down list select "Unknown Database" and add parameters via the commands in the context menu. They may contain passwords, which are stored in encrypted form. The required connection string can be assembled from these parameters. Note that only limited functions of the Twin CAT Database Server can be used. Only the explicit function blocks of the SQL Expert mode are supported. Activating a project To activate a configured project on the Twin CAT Database Server, use the command Activate Configuration in the context menu of the Twin CAT Database Server project. 86 Version: 1.13.8 TF6420
## Page 87

Configuration SQL Query Editor The SQL Query Editor is a Database Server tool that supports the development of your application. The tool can be used to test connections and SQL commands and to check the compatibility between PLC and databases. TF6420 Version: 1.13.8 87
## Page 88

Configuration ID Name Function 1 Target system Choose Target System with installed Twin CAT Database Server 2 Database Selecting the configured database connection 3 Table Selecting the existing tables in the database 4 Copying for PLC Copying the SQL command to the PLC string. This can be copied into the PLC source code. Special characters are automatically captured and formatted. 5 Export TC3 Exporting the table schema into a PLC structure. This can be used in the program for SQL commands, for example. 6 Get Table Schema Reading the table structure 7 Create Cmd Creating an SQL command, based on the table structure 8 Execute Executing the SQL command First select the target system from the routes of your Twin CAT system (1). The Twin CAT Database Server must be installed on the target system. If a No SQL database is stored in the configuration, an additional No SQL tab is visible. You will find the documentation in a subitem below. All configured databases (2) are displayed, once you have activated the database configurations on the target system. You can also select one of the available tables (3) from the database. Based on this table, you can generate SQL commands from the SQL Query Editor and send them to the database. The SQL commands have different syntax, depending on database type. Three commands are available for generating the individual SQL commands: • Get Table Schema: Calls up the structure of the selected table. ◦ Information such as the column name, PLC data type and size of variables is displayed. The retrieved structure can also be prepared for your PLC application via the commands Copy for PLC (4) or Export TC3 (5). • Create Cmd: An SQL command is generated in the command text box, depending on the selected tab. The command syntax may differ, depending on the database type. The previously read table schema is used here. ◦ The created SQL command can optionally be modified. • Execute: The SQL command shown in the text box is executed and returns values, if applicable. The differences in the individual SQL commands are explained below. Comment: Since the syntax of SQL commands often collides with the syntax in the ST code of Twin CAT, the SQL Query Editor offers the command "Copy for PLC" (4). The command is used to copy the created and tested SQL commands with the correct formatting for special characters for the ST program code into the cache. Create Table command The CREATE TABLE tab can be used to create tables within the database. Further columns can be added to the table with (+), as required. Once you have specified the column name and type, you can specify additional properties, in order to generate automatic IDs, for example. The table name can be determined by executing the command. The table with the configured table structure is created. 88 Version: 1.13.8 TF6420
## Page 89

Configuration Insert command The Insert command gives the opportunity to write records into the table. The values under "Value" can be modified once the table structure has been retrieved. If the command is then generated, the values in the Insert command will automatically be in the right format. These values are written into the table when the command is executed. This value cannot be customized if automatic ID generation is used. TF6420 Version: 1.13.8 89
## Page 90

Configuration Select command Select commands can be created and sent via the SELECT tab. Select commands give the opportunity to read records from the databases. After executing the command, values are returned if they exist in the table. They are listed under "Value" in the table structure display. Use the arrows under the display to navigate through the individual records. 90 Version: 1.13.8 TF6420
## Page 91

Configuration Delete command The Delete command has two functions. 1. DELETE Records: Deletes the contents of a table. 2. DROP table: Deletes the whole table. This SQL command can also be customized, in order to delete only a particular section of the table, for example. TF6420 Version: 1.13.8 91
## Page 92

Configuration Stored Procedures The Twin CAT Database Server supports "Stored Procedures", which provide numerous databases for processing more complex queries at the database level or to make a simplified interface available. If Stored Procedures are available in the database and the table, you can list and select them (1). The input and output parameters can be picked up automatically (2) and transferred to the tables in the display (3)(4). The parameter type, name and data type are displayed there. In addition you can insert values here, in order to execute the Stored Procedures with the input values via "Execute". The result is displayed in the output values (4). If several records are returned, the arrow keys can be used to switch between them. This functionality serves as development aid for the call in the PLC. The results are returned there by calling the corresponding function block [} 202]. 92 Version: 1.13.8 TF6420
## Page 93

Configuration Information Log View for diagnostics The Information Log View is available for troubleshooting. Information Log View is a tool for reading log files from the Twin CAT Database Server. Recorded information is displayed with a timestamp, IDs and error messages in plain text. The log files can not only be viewed or emptied via direct file access, but also directly via the target. This is particularly advantageous with distributed Database Servers in a network, for quick and easy access to the log file. For this access a route to the target device must exist. TF6420 Version: 1.13.8 93
## Page 94

Configuration 5.1.1.5 No Sql Expert Mode No SQL No SQL databases (not only Sequel) differ from conventional relational data storage. Document-based databases: Records are stored as documents in the database. This offers the advantage of being able to archive data in a more flexible and hierarchical manner. 94 Version: 1.13.8 TF6420
## Page 95

Configuration If a record consists of more than one flat structure of basic data types, it can no longer be mapped directly via a relational database. No SQL databases offer this flexibility. Changes in the program code and the corresponding structures can also be easily adopted without having to create a new table. Document-based databases usually save the data as JSON-formatted records. The records can all be different. Build Project The Twin CAT Connectivity extension for Visual Studio provides a new project template. When a new project is created, the Twin CAT Connectivity Project category appears as an option. To create a new Twin CAT Connectivity project, select Empty Twin CAT Connectivity Project, specify the project name and the storage location and click OK to add it to the solution. In this way, Twin CAT Connectivity projects or Twin CAT Database Server projects can conveniently be created in parallel with Twin CAT or other Visual Studio projects. TF6420 Version: 1.13.8 95
## Page 96

Configuration A new project node appears in the solution. Below the Connectivity project node you can add subprojects for the supported connectivity functions. Use Add to add a new Twin CAT Database Server project to the Twin CAT Connectivity project. The Twin CAT Database Server project can be found in the list of existing Item Templates. A new Twin CAT Database Server project is created under the Twin CAT Connectivity node. 96 Version: 1.13.8 TF6420
## Page 97

Configuration This is now used as the basis for the pending configuration of a Twin CAT Database Server. The document can be edited either via the Properties window or via an editor. A Connectivity project can be associated with any number of Twin CAT Database Server projects or other projects, and it may therefore contain several configurations. Editor for server settings The Server Settings editor can be used to edit the settings for the Twin CAT Database Server. These are general settings relating to the corresponding server. In the drop-down menu (1) you can select the target system via the Ams Net ID. To this end you have to create a route to the target system via Twin CAT. When a finished configuration is transferred, the settings are stored in the Twin CAT Database Server for this target system. The settings for logging faults or errors can be configured under Log settings. In the event of a fault or error, the Database Server generates a detailed entry in a log file. The log file can be read with the Information Log Viewer [} 49]. Under Log Settings you can specify a path to the file location and the maximum file size. You can also influence the accuracy of the log. For performance reasons we recommend that logging is deactivated again after the error analysis, once it is no longer required. TF6420 Version: 1.13.8 97
## Page 98

Configuration For network access to file-based databases such as Access or SQL Compact, the Impersonate option must be set, so that the Twin CAT Database Server can connect to this network drive. This feature is currently not supported in Windows CE. Further configuration settings are available to control the read process from the database. These settings refer to the Twin CAT Database Server on the target system: Max String Length Maximum string length of the variables in the PLC Max Byte Array Length Maximum byte array length of the variables in the PLC DBNull Allowed Indicates whether ZERO values are accepted in the Twin CAT Database Server. DBConnection Timeout Indicates the time after which the Twin CAT Database Server assumes a connection error while attempts are made to establish a connection. DBCommand Timeout Indicates the time after which the Twin CAT Database Server assumes a connection fault when a command was sent. If large data quantities are involved, processing of a command may take quite some time, depending on the database and the infrastructure. Supported database types The installed database types can be selected in the server settings. All installed databases are selected by default. The Twin CAT 3 Database Server will load the corresponding database interfaces. In this way, unused databases on the target system can be deselected. Adding a database configuration A new database configuration can be added via the command Add New Database in the context menu of a Database Server project or via the corresponding command in the toolbar. 98 Version: 1.13.8 TF6420
## Page 99

Configuration A new database configuration is added in the form of a file in the project folder and integrated in the project. As with all Visual Studio projects, the information on the new files is stored in the Connectivity project. Editor for database configurations The database ID, which is required for some function blocks in the PLC, is shown in the upper part of the editor (1). The database types of the target database can be selected from the drop-down menu (2). Another option is the ODBC interface for a database, although this is not yet supported. Note that not all functions of the Twin CAT Database Server can be guaranteed, depending on the database. As a further option you can select a so-called failover database (3), which is triggered when an error is encountered in Configure mode. In the event of a network disconnection, this feature can automatically ensure that data are stored elsewhere and not lost. For each database [} 123] additional adjustable parameters are available. Depending on the database a connection string (5) is created, which describes the connection to the database. The intention is to make the parameters you have set more transparent. The CREATE (4) button can be used to create a new database. This function is only displayed if the respective database supports it. CHECK can be used to check the connection to the database. No SQL databases can also be selected from the target databases. If you activate the project with a No SQL database, a No SQL tab is enabled in the SQL query editor to facilitate the use of No SQL-specific functions. TF6420 Version: 1.13.8 99
## Page 100

Configuration Activating a project To activate a configured project on the Twin CAT Database Server, use the command Activate Configuration in the context menu of the Twin CAT Database Server project. Mongo DB in PLC Expert/Configure mode PLC Expert and Configure mode use the predefined database schema in their processes. Normally, the schema of the structures used will not change during operation. In order to nevertheless be able to use the function blocks, the Twin CAT 3 Database Server requires a description of the table schema. For Mongo DB a table is therefore simulated. In the SQL Query Editor, use the SQL tab and the CREATE TABLE subcategory to create a table, or in this case a collection. In addition, unlike for relational databases, an entry is created in a metadata collection. Information on the table schema for the Twin CAT 3 Database Server is stored here. In order to use advanced functionality, e.g. structures of any hierarchy or flexible records, we recommend using the No SQL function blocks. Information Log View for diagnostics The Information Log View is available for troubleshooting. Information Log View is a tool for reading log files from the Twin CAT Database Server. Recorded information is displayed with a timestamp, IDs and error messages in plain text. The log files can not only be viewed or emptied via direct file access, but also directly via the target. This is particularly advantageous with distributed Database Servers in a network, for quick and easy access to the log file. For this access a route to the target device must exist. 100 Version: 1.13.8 TF6420
## Page 101

Configuration 5.1.2 Standalone Configurator 5.1.2.1 General 5.1.2.1.1 Interface and basic functions The Twin CAT 3 Database Server is configured via an XML configuration file. The settings in the configuration file can easily be created and modified with the help of the XML configuration file editor. New configuration files can be created, and existing configuration files can be read and revised. TF6420 Version: 1.13.8 101
## Page 102

Configuration Toolbar and commands The toolbar has the following elements: 102 Version: 1.13.8 TF6420
## Page 103

Configuration Toolstrip button Description Activation of the configuration Read configuration of the target device Save configuration in an XML file Read configuration from an XML file Add new database configuration Add new Auto Log group Event display Database pool Auto Log Viewer Information Log View SQL Query Editor TF6420 Version: 1.13.8 103
## Page 104

Configuration 5.1.2.1.2 Project properties Editor for server settings The Server Settings editor can be used to edit the settings for the Twin CAT Database Server. These are general settings relating to the corresponding server. In the drop-down menu (1) you can select the target system via the Ams Net ID. To this end you have to create a route to the target system via Twin CAT. When a finished configuration is transferred, the settings are stored in the Twin CAT Database Server for this target system. The settings for logging faults or errors can be configured under Log settings. In the event of a fault or error, the Database Server generates a detailed entry in a log file. The log file can be read with the Information Log Viewer [} 49]. Under Log Settings you can specify a path to the file location and the maximum file size. You can also influence the accuracy of the log. For performance reasons we recommend that logging is deactivated again after the error analysis, once it is no longer required. For network access to file-based databases such as Access or SQL Compact, the Impersonate option must be set, so that the Twin CAT Database Server can connect to this network drive. This feature is currently not supported in Windows CE. Further configuration settings are available to control the read process from the database. These settings refer to the Twin CAT Database Server on the target system: Max String Length Maximum string length of the variables in the PLC Max Byte Array Length Maximum byte array length of the variables in the PLC DBNull Allowed Indicates whether ZERO values are accepted in the Twin CAT Database Server. DBConnection Timeout Indicates the time after which the Twin CAT Database Server assumes a connection error while attempts are made to establish a connection. DBCommand Timeout Indicates the time after which the Twin CAT Database Server assumes a connection fault when a command was sent. If large data quantities are involved, processing of a command may take quite some time, depending on the database and the infrastructure. 104 Version: 1.13.8 TF6420
## Page 105

Configuration Supported database types The installed database types can be selected in the server settings. All installed databases are selected by default. The Twin CAT 3 Database Server will load the corresponding database interfaces. In this way, unused databases on the target system can be deselected. TF6420 Version: 1.13.8 105
## Page 106

Configuration 5.1.2.1.3 Configuring databases Editor for database configurations The database ID, which is required for some function blocks in the PLC, is shown in the upper part of the editor (1). The database types of the target database can be selected from the drop-down menu (2). Another option is the ODBC interface for a database, although this is not yet supported. Note that not all functions of the Twin CAT Database Server can be guaranteed, depending on the database. As a further option you can select a so-called failover database (3), which is triggered when an error is encountered in Configure mode. In the event of a network disconnection, this feature can automatically ensure that data are stored elsewhere and not lost. For each database [} 123] additional adjustable parameters are available. Depending on the database a connection string (5) is created, which describes the connection to the database. The intention is to make the parameters you have set more transparent. The CREATE (4) button can be used to create a new database. This function is only displayed if the respective database supports it. 106 Version: 1.13.8 TF6420
## Page 107

Configuration Unknown databases can be configured via an ODBC interface. In the ODBC Type drop-down list select "Unknown Database" and add parameters via the commands in the context menu. They may contain passwords, which are stored in encrypted form. The required connection string can be assembled from these parameters. Note that only limited functions of the Twin CAT Database Server can be used. Only the explicit function blocks of the SQL Expert mode are supported. 5.1.2.1.4 Configuring Auto Log groups Configuring the ADS device The ADS device is automatically created under an Auto Log group. In the most frequent use case the ADS device is the PLC runtime. The following parameters can be set in the editor: TF6420 Version: 1.13.8 107
## Page 108

Configuration ADS Device Name of the ADS target device. AMS Net ID Address of the target device in the Twin CAT network. AMS Port Port of the target device in the Twin CAT network. Timeout Time after which it is assumed that the connection to the target device is lost. Connection Type by Symbol Name: Connection is established based on the symbol name. by Index Group: Connection is established based on the memory index. 108 Version: 1.13.8 TF6420
## Page 109

Configuration Start Up Auto Log mode can be enabled manually (with a command in the PLC or from the configurator) or automatically during system startup. Direction The set ADS device is used as data target or data source. Write mode The data can appended in a database line-by-line, held in a ring buffer on a temporal or quantitative basis, or simply be updated at the corresponding position. Ring buffer parameter Depending on the setting this parameter represent the time or the cycles after which the ring buffer is updated. Log mode The variable is written either after a certain cycle time or when a change occurs. Cycle Time Cycle time after which the variable is written. A new Auto Log group for the database configuration can be added via the command Add New Autolog Group in the context menu of a database configuration or via the toolbar. These Auto Log groups refer to the parent database. Configuring symbols The symbols you set here are written to or read from the database, depending on whether the ADS device is the data target or the data source. The Twin CAT Target browser [} 50] can be used for convenient access. Here you can search for the symbols on the target and communicate between the two tools via drag & drop. TF6420 Version: 1.13.8 109
## Page 110

Configuration Symbols can also be added manually to symbol groups or edited. The information that is required varies, depending on whether in the ADS device the connection type was selected via the symbol name or the index groups. The starting point is always the ADS device. 110 Version: 1.13.8 TF6420
## Page 111

Configuration Symbol Name The symbol is addressed based on the set ADS device Symbol database Name of the variable in the database table name Data Type PLC data type of the symbol Bit Size Bit size of the symbols (set automatically for the data types) Index Group Index group in the Twin CAT system Index Offset Index offset in the Twin CAT system Configuring a table The table in a database can be based on a standard table structure or on an individual structure. The corresponding table can be selected from a list of possible tables. If the table does not yet exist, you can create it via the SQL Query Editor. If you select the standard table structure, a blue tick indicates whether the selected table corresponds to this structure. The specific table type offers the option to distribute the individual symbols that were set in the symbol group to the table columns in the database as required. When a data set is written to the database in Auto Log mode, the current values of the symbol group at the sampling time are saved in the corresponding table column. TF6420 Version: 1.13.8 111
## Page 112

Configuration 5.1.2.1.4.1 Write direction mode The Twin CAT Database Server has four different write direction modes. These are explained below. DB_TO_ADS This write mode is used to cyclically read variable values from a database and write the read values into PLC variables. ADS_TO_DB_APPEND This write mode is used to cyclically write variable values from the PLC into a database. Each time a new record is created and appended at the end of the table/file. ADS_TO_DB_UPDATE This write mode is used to cyclically read variable values from the PLC and compare the read values with the database records. If differences are detected, the corresponding record is modified with the new value. ADS_TO_DB_RINGBUFFER This write mode can be used to specify the number of records or the age of records. This write mode is available during cyclic logging via the symbol groups and during logging with the function block FB_DBWrite. The Ring Buffer mode is available for all database types. This mode can also be used to influence logging in ASCII files. 112 Version: 1.13.8 TF6420
## Page 113

Configuration Ring Buffer-Arten The Ring Buffer can be used in two different ways: • "Ring Buffer_Time" • "Ring Buffer_Count" Ring Buffer Time In this mode a time can be specified for the maximum age of the record. If this age is exceeded, the corresponding record is deleted. Ring Buffer Count In this mode a maximum number of records can be specified. When the maximum number is reached, the oldest records are deleted in order to make room for the new ones. Declaring the Ring Buffer mode in the XML configuration file editor Ring Buffer_Time: The time is specified in milliseconds. Ring Buffer_Count: Declaring the Ring Buffer mode in FB_DBWrite: Ring Buffer_Time: TF6420 Version: 1.13.8 113
## Page 114

Configuration Ring Buffer_Count: 5.1.2.1.5 SQL Query Editor The SQL Query Editor is a Database Server tool that supports the development of your application. The tool can be used to test connections and SQL commands and to check the compatibility between PLC and databases. 114 Version: 1.13.8 TF6420
## Page 115

Configuration After the Twin CAT Database Server of the target system is selected, the SQL Query Editor loads the current database configuration and the tables of the successfully connected databases. Depending on whether the database supports the SQL and the No SQL interface (from the Twin CAT Database Server), it is listed under the respective category. Below the selection of the target system there is a status bar with the available commands: Table level Insert working area Opens the Insert working area to write data sets to the selected table with SQL. Select working area Opens the Select working area to read data sets from the selected table with SQL. Delete/Drop working area Opens the Delete/Drop working area to delete data sets with SQL from the selected table or to delete entire tables. No SQL working area Opens the No SQL working area to execute No SQL-specific queries. Database level Stored Procedure working area Opens the Stored Procedure working area to execute stored procedures of the database. Tables working area Opens the Tables working area to create new tables in the selected database. Update tables Updates the available tables of the selected database. General Update databases Updates the entire database tree. The working areas are opened to the right of the tree under the corresponding tab. Also from the same table several tabs can be opened at one time. Insert working area The Insert working area enables data to be written to the selected table via the Twin CAT Database Server interface for SQL function blocks. TF6420 Version: 1.13.8 115
## Page 116

Configuration In the lower area (2) there is a table with the individual data symbols in the data set to be written. The name, PLC data type, the byte length as well as the value can be determined here. The entered values are then used via the command to generate the SQL statement. This SQL statement is then made available in a text field (3). Depending on the syntax of the database, the content may vary. The upper status bar contains the commands for interacting with the Twin CAT Database Server (1). Command Description Read tables schema Reads out the table schema of the table of the working area. Generate SQL statement Generates the SQL statement from the present table depending on the database syntax. Execution Executes the statement in the text field (3) via the respective interface of the Twin CAT Database Server. Copy the statement Copies the statement in the text field (3) as Twin CAT compatible syntax. Export as structure Exports the structure of the table of input values to a Twin CAT 3 compatible DUT. Select working area The Select working area allows reading data into the selected table via the Twin CAT Database Server interface for SQL function blocks. 116 Version: 1.13.8 TF6420
## Page 117

Configuration In the lower area (2) there is a table with the individual data symbols in the data set to be read. The name, PLC data type, as well as the byte length can be determined here. This information is then needed to interpret the data. This SQL statement is then made available in a text field (3). Depending on the syntax of the database, the content may vary. The result field (4) displays the data after the statement has been executed. If several results are returned, they can be switched through the pages. The upper status bar contains the commands for interacting with the Twin CAT Database Server (1). Command Description Read tables schema Reads out the table schema of the table of the working area. Generate SQL statement Generates the SQL statement from the present table depending on the database syntax. Execution Executes the statement in the text field (3) via the respective interface of the Twin CAT Database Server. Copy the statement Copies the statement in the text field (3) as Twin CAT compatible syntax. Export as structure Exports the structure of the table of input values to a Twin CAT 3 compatible DUT. Delete/Drop working area The Delete/Drop working area provides the option to issue SQL statements to delete either data from a table or the entire table from the database. TF6420 Version: 1.13.8 117
## Page 118

Configuration For this purpose, you can choose between the two options in the status bar. The syntax corresponding to the database is then generated in the statement field. To execute this with the Twin CAT Database Server interface, the switch FB_SQLCommand Evt. Execute is available. No Sql working area The No Sql working area supports the special functions of No Sql databases or the Twin CAT Database Server No SQL interface. ID Name Function 1 Filter/Document Depending on which function is used, this input field acts as a document or as a filter in JSON format. If you want to execute a Find operation and also carry out a projection or sort operation, you can fill these fields with Options(Find) below. 2 Options (Find) Describes additional parameters for the Find function, such as the projection or sorting. 3 Control elements Control elements for interaction with the Twin CAT Database Server interface for No SQL. 4 Data display List of returned data. Navigation allows iteration through the available pages. 118 Version: 1.13.8 TF6420
## Page 119

Configuration Find: executes a search query with the filter entered in the text field (1). Optionally, a projection or sorting operation can also be executed via the Options(Find) fields. Data is returned and listed in the data display (4). The syntax of the filters is database-specific. Aggregate: executes an aggregation with the parameters entered in the text field (1). Data is returned and listed in the data display (4). The syntax of the filters is database-specific. Insert: executes an insert query of the (JSON) document or document array entered in the text field (1). These are then written to the collection. Delete: executes a delete query on the data found with the filter in the text field (1). Any data that is found is deleted from the collection. Validate: if this option is selected, the data queries are not automatically parsed according to their own schema, but an attempt is made to map these data to the structure of the symbol from the PLC, which was specified via these parameters. With the latter function, a Find query may lead to conflicts. In contrast to structures in the PLC process image, data sets in No SQL databases do not have to follow a fixed schema. It is possible that queried documents do not have data for a specific element in the PLC structure. Or the data set carries data that does not occur in the PLC structure. These data are assigned via the name or the attribute "Element Name" in the PLC. The differences in the data can be examined via the Schema Compare tab. In the above example it can be seen that in the case of the returned document in the PLC structure, the variable "Name" has a different data type length than that of the database. The corresponding colors show the weighting of the conflict: Red: too many or too few data available. Yellow: the byte length of the data set does not match, or underlying data sets are left over or missing. Green: no conflicts TF6420 Version: 1.13.8 119
## Page 120

Configuration These conflicts are also listed under the Issue Tracker tab. It can also be read into the PLC as a string array, if required. The Remaining Json tab returns any remaining data sets as JSON. This information can also be read into the PLC as a string. The control elements in the status bar can be used to iterate through the data, as known from the other displayed data. The number of data sets displayed simultaneously can be specified. Stored Procedure working area The Twin CAT Database Server supports "Stored Procedures", which provide numerous databases for processing more complex queries at the database level or to make a simplified interface available. If Stored Procedures are present in the database, they will be listed in the dropdown list of the status bar (4). Below is the table for the input parameters (1), and for the output schema (2). In addition, there is a view for the output results (3). If the Stored Procedure is executed successfully, the results are displayed here. The status bar has the following commands: Command Description Read stored procedure input Reads out the input parameter schema. The results are shown in Table schema 1. Read Stored Procedure output Reads out the output parameter schema. The results are shown in Table schema 2. Info: This requires the execution of the Stored Procedure. Depending on the programming, data can be changed here. Design Executes the Stored Procedure via the respective interface of the Twin CAT Database Server. Export as structure Exports the structure of the table to a Twin CAT 3 compatible DUT. Table working area The Table working area is used to create new tables. 120 Version: 1.13.8 TF6420
## Page 121

Configuration Here, the table structure (1) can be created and an SQL statement can be generated from it in the corresponding field (2). The status bar (3) with the following commands can be used for this purpose: Command Description Table name Specifies the table name of the new table. Generate SQL statement Generates the SQL statement from the present table depending on the database syntax. Execution Executes the Stored Procedure via the respective interface of the Twin CAT Database Server. Copy the statement Copies the statement in the text field (2) as Twin CAT compatible syntax. 5.1.2.1.6 Auto Log Live View The Auto Log Viewer of the Twin CAT Database Server is a tool for controlling and monitoring the Auto Log mode. You can log into a target system, similar to the Twin CAT PLC. In logged-in state the Auto Log mode can be started or stopped. Information on the current state of the logging is shown in the lower part of the window. When an Auto Log group is selected, further information is displayed via the logged symbols. TF6420 Version: 1.13.8 121
## Page 122

Configuration ID Name Function 1 Target system Choose Target System with installed Twin CAT Database Server 2 Start Manual start of the Auto Log mode 3 Login Logging into the active Auto Log process 4 Logout Logging out of the active Auto Log process 5 Stop Manual stop of the Auto Log mode 6 Auto Log groups List of configured Auto Log groups on the target system 7 Symbols List of configured symbols for the selected Auto Log group 5.1.2.1.7 Information Log View Information Log View is a tool for reading log files from the Twin CAT Database Server. Recorded information is displayed with a timestamp, IDs and error messages in plain text. The log files can not only be viewed or emptied via direct file access, but also directly via the target. This is particularly advantageous with distributed Database Servers in a network, for quick and easy access to the log file. For this access a route to the target device must exist. 122 Version: 1.13.8 TF6420
## Page 123

Configuration 5.2 Databases The Twin CAT Database Server is the link between the Twin CAT PLC and database systems. It supports a wide range of databases. In addition to conventional databases such as Microsoft SQL or Oracle, XML and ASCII files can also be used as databases. With ODBC databases it is even possible to enter database connection strings for communication with databases that are not listed as supported database types. The two tables below show an overview of which databases are supported on which operating system platforms and which databases are available for data export and import for the Twin CAT Scope. Platform support Overview of which database connections are supported by which platform. TF6420 Version: 1.13.8 123
## Page 124

Configuration Database Windows Windows CE Twin CAT/BSD Local Remote Local Remote Local Remote MS SQL X X - X - X MS SQL X - X - - - Compact My SQL X X - X* X X Oracle DB X X - - - - SQLite X - X** - X* - ASCII-File X - X - X - XML X - X - X - ODBC X* X* - - X* X* MS Access X* - - - - - MS Excel X* - - - - - Mongo DB X X - - X X Postgre SQL X X - - - X Influx DB 1.7 | X X - - X X 1.8 Influx DB 2 X X - - - X *additional server or client drivers for the database must be installed on the device **applies only to devices with Arm® architecture Twin CAT Scope support Overview of which databases are supported for data import and export in Twin CAT Scope. The Twin CAT Scope always works together with the Twin CAT Database Server. Database Scope Export Scope Import MS SQL X X MS SQL Compact - X My SQL - X Oracle DB - X SQLite - X ASCII-File X X XML - X ODBC - X MS Access - X MS Excel - X Mongo DB - - Postgre SQL - X Influx DB 1.7 | 1.8 - X Influx DB 2 - X The configuration of the individual databases and mapping of the data sets in the PLC is explained on the following sections. 5.2.1 General Information On the following pages you will find some general information about the supported databases. This information is generic, i.e. not limited to a specific database, and covers topics such as network access, data type support and operating system support. 124 Version: 1.13.8 TF6420
## Page 125

Configuration 5.2.1.1 WString support WSTRING is available for using the Unicode character set. This data type must be activated in the server settings so that it can be written to the database using the Twin CAT Database Server in PLC Expert mode. This data type requires two bytes per character. Please keep this in mind when creating the table structure. To be able to save it in the database in UTF16 format, the column must be created according to the character set. The SQL Query Editor can also be used for this purpose. TF6420 Version: 1.13.8 125
## Page 126

Configuration The following databases are supported with the Database Server: Database UTF8 UTF16 Character set definition Performance impairment My SQL x x column-specific x MSSQL x x column-specific Oracle x x column-specific Postgre SQL x x cross-database x Others x Performance impairment Some databases cause performance problems, because additional SQL commands have to be sent in order to read the character set. WString support is available from version 3.1.31.4. 5.2.1.2 BULK support The Twin CAT Database Server also supports so-called BULK commands for a selection of databases. BULK commands are SQL statements that insert collected data into multiple rows of a table. Using BULK insert commands usually results in better performance than processes that send a single insert statement to the database for each row to be added. Currently, BULK commands via the FB_PLCDBCmd Evt function block are supported by the Twin CAT Database Server for Microsoft SQL databases. Example command: 'SQLBULK<INSERT>#My Table‘ 5.2.2 MS SQL database This section contains information on the configuration and the data type mapping of Microsoft SQL databases. Compatible versions: Microsoft SQL database 20xx. 126 Version: 1.13.8 TF6420
## Page 127

Configuration Declaration in the Twin CAT Database Server Configurator Microsoft SQL database Database Type Select "Microsoft SQL Server" from the drop-down menu. Provider "SQLOLEDB"or the provider of the SQL Native Client, e.g. "SQLNCLI10" Server Enter the name of your SQL server here. Example: "TESTSERVER\SQLEXPRESS" Database Enter the name of the database. If the database does not yet exist, it can be created with the Create button. Corresponding permissions must exist. Authentication Option for logging into the database as a particular user. User name Enter the user name here. Password Enter the corresponding password. Windows CE support This database is also supported by the Windows CE version of the Twin CAT Database Server. The interfacing is not local, but can be established via a network connection. Data type mapping between DB and PLC E_Column Types MS SQL Twin CAT PLC Big Int bigint T_ULARGE_INTEGER (Tc Utilities.lib) Integer integer DINT Small Int smallint INT Tiny Int tinyint SINT Bit_ bit BYTE Money money LREAL Float float LREAL Real_ real REAL Date Time datetime DT NText ntext STRING NChar nchar STRING Image image ARRAY OF BYTE NVar Char nvarchar STRING Binary binary ARRAY OF BYTE Var Binary varbinary ARRAY OF BYTE Data type support This database supports the data type WSTRING. (See WString support [} 125]) NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. TF6420 Version: 1.13.8 127
## Page 128

Configuration 5.2.2.1 Notes on the Microsoft SQL Server Logs in the Windows Eventlog Error Event In the SQL Configuration Manager under SQL Server 2005 stop the SQL Server Reporting Services (SQLEXPRESS) and set the "Report Server Windows Service Start Mode to "manual". The Database Server doesn't need the (SQLEXPRESS) cannot be connected to Reporting Service. the report server database." Information event Open the Properties via the context menu in SQL Server Management Studio Express under Databases/Tc Data Logger "'Tc Data Logger' database is started" and under Options set the option Close automatically to FALSE. This option is not required because the Database Server opens and closes the database automatically. It is possible to suppress logging to the Windows Eventlog. Events are then no longer logged. No distinction can be made between the different types of event. Select the SQL Server (SQLEXPRESS) in the SQL configuration manager under SQL Server 2005 Services and open the Properties via the context menu. The Advanced tab contains a Startup parameters subitem. The individual parameters are separated by semicolons. Add the parameter "-n" and restart the service. From this point onwards no further events will be logged by the SQL Server. 5.2.3 MS SQL Compact database This section contains information on the configuration and the data type mapping of Microsoft SQL Compact databases. MS SQL Compact is an ideal database for embedded applications. It has a small footprint but nevertheless provides the required functionality for relational databases. Compatible versions: Microsoft SQL Compact database 3.5 Declaration in the Twin CAT Database Server Configurator Microsoft SQL Compact database Database Type Select "Microsoft Compact SQL" from the drop-down menu. Database URL Enter the name and path of the database. If the database does not yet exist, it can be created with the Create button. Corresponding permissions must exist. Authentication Option for logging into the database with a password. Password Enter the password. Windows CE support This database is also supported by the Windows CE version of the Twin CAT Database Server. The connection can be established locally. 128 Version: 1.13.8 TF6420
## Page 129

Configuration Data type mapping between DB and PLC E_Column Types MS SQL Compact Twin CAT PLC Big Int bigint T_ULARGE_INTEGER (Tc Utilities.lib) Integer integer DINT Small Int smallint INT Tiny Int tinyint SINT Bit_ bit BYTE Money money LREAL Float float LREAL Real_ real REAL Date Time datetime DT NText ntext STRING NChar nchar STRING Image image ARRAY OF BYTE NVar Char nvarchar STRING Binary binary ARRAY OF BYTE Var Binary varbinary ARRAY OF BYTE Data type support WSTRING is not supported by this database. (See WString support [} 125]) NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.4 My SQL database This section contains information on the configuration and data type mapping of My SQL databases. Declaration in the Twin CAT Database Server Configurator My SQL database Database type Select "My SQL" from the drop-down menu. Server Enter the name or IP address of your server here. Database Enter the name of the database. If the database does not yet exist, it can be created with the Create button. Corresponding permissions must exist. Port Enter the port for communicating with the My SQL database here. Default: 3306. User name Enter the user name here. Password Enter the corresponding password. TF6420 Version: 1.13.8 129
## Page 130

Configuration Windows CE support This database is also supported by the Windows CE version of the Twin CAT Database Server. The interfacing is not local, but can be established via a network connection. The installation of the necessary components is not automatic and must be performed manually. To install them, version 6.7.8.0 of the library "My Sql. Data. CF.dll" also needs to be copied into the Twin CAT Database Server folder of the CE device. (\Hard Disk\Twin CAT\Functions\TF6420- Database-Server\Server) This library for CE supports connections with a My SQL server up to and including version 8.0.28. Data type mapping between DB and PLC E_Column Types My SQL Twin CAT PLC Big Int BIGINT T_ULARGE_INTEGER (Tc Utilities.lib) Integer INT DINT Small Int SMALLINT INT Tiny Int TINYINT SINT Bit_ CHAR(1) STRING Money DECIMAL(18,4) LREAL Float DOUBLE LREAL Real_ FLOAT REAL Date Time DATETIME DT NText TEXT STRING NChar CHAR STRING Image BLOB ARRAY OF BYTE NVar Char VARCHAR STRING Binary BLOB ARRAY OF BYTE Var Binary BLOB ARRAY OF BYTE Drivers for "big Windows" systems The used My SQLConnector is under MIT licence and under Copyright: Copyright (c) 2016 Bradley Grainger Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions: The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. Data type support This database supports the data type WSTRING. (See WString support [} 125]) 130 Version: 1.13.8 TF6420
## Page 131

Configuration NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.5 Oracle database This section contains information on the configuration and the data type mapping of Oracle databases. For interfacing with an Oracle database the so-called ODP driver is used. Compatible versions: Oracle 9i, 10g, 11g and higher The Twin CAT Database Server requires the 32-bit version of the . NET ODP components. Declaration in the Twin CAT Database Server Configurator Oracle database Database Type Select "Oracle ODP" from the drop-down menu. Host Enter the IP or host name of the database. Service name Enter the name of the service or the database. Port Enter the communication port (optional). Default: 1521. Protocol Enter the protocol (optional). Default: TCPIP. Scheme Enter the database schema. User name Enter the user name here. Password Enter the corresponding password. Windows CE support Under Windows CE this database is not supported by the Twin CAT Database Server. Data type mapping between DB and PLC E_Column Types Oracle Twin CAT PLC Big Int DECIMAL(15,0) T_ULARGE_INTEGER (Tc Utilities.lib) Integer INTEGER DINT Small Int SMALLINT INT Tiny Int SMALLINT SINT Bit_ CHAR(1) BYTE Money DECIMAL(18,4) LREAL Float DOUBLE PRECISION LREAL Real_ FLOAT REAL Date Time DATE DT NText VARCHAR(254) STRING NChar CHAR(254) STRING Image BLOB ARRAY OF BYTE NVar Char NVARCHAR(254) STRING Binary BLOB ARRAY OF BYTE Var Binary BLOB ARRAY OF BYTE TF6420 Version: 1.13.8 131
## Page 132

Configuration Data type support This database supports the data type WSTRING. (See WString support [} 125]) NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.6 SQLite This section contains information on the configuration and the data type mapping of SQLite databases. SQLite is an ideal database for embedded applications. This file-based SQL database requires no installation, since it is already integrated in the Twin CAT Database Server. The relational database offers most of the features of SQL databases and supports the commands of the SQL92 standard. The database enables reliable and fast data storage. However, the database does not allow distinction of users. It is therefore well-suited for safe storage of variables on the local system. Declaration in the Twin CAT Database Server Configurator SQLite database Database Type Select "SQLite" from the drop-down menu. SQLite database file Enter the name and path of the database. You can also use the browser dialog. If the database does not yet exist, it can be created with the Create button. Corresponding permissions must exist. Authentication An option for logging into the database as a particular user. Password Enter the corresponding password. Windows CE support The database is also supported by the Windows CE version of the Twin CAT Database Server, but only on devices with an Arm® processor. The connection can be established locally. Twin CAT/BSD support This database is supported by the Twin CAT Database Server on Twin CAT/BSD. In addition, however, the installation of the package "sqlite3" from the package repository is required for use. Use of primary/foreign keys An additional parameter must be specified in the configuration in order to be able to use primary and foreign keys in SQLite databases. "Foreign Keys" -> "True" 132 Version: 1.13.8 TF6420
## Page 133

Configuration Data type mapping between DB and PLC SQLite has five internal basic data types. For more precise interpretation of the data, additional data types are supported, which are listed in the documentation of the database manufacturer. E_Column Types SQLite Twin CAT PLC Big Int BIGINT T_ULARGE_INTEGER (Tc Utilities.lib) Integer INT DINT Small Int SMALLINT INT Tiny Int TINYINT BYTE Bit_ BOOLEAN BOOL Money DOUBLE LREAL Float FLOAT LREAL Real_ REAL REAL Date Time DATETIME DT NText TEXT STRING NChar NCHAR STRING Image BLOB ARRAY OF BYTE NVar Char NVARCHAR STRING Binary BLOB ARRAY OF BYTE Var Binary BLOB ARRAY OF BYTE Special feature: string or binary data types are unlimited in Sqlite. However, the Twin CAT 3 Database Server requires fixed limits, which can be set in the general server settings. Incompatible data types It is possible that incompatible data type designations are created in the database by third-party software, which the Twin CAT3 Database Server cannot interpret. In this case it is helpful to use the SQL Query Builder. Data type support This database supports the data type WSTRING. (See WString support [} 125]) TF6420 Version: 1.13.8 133
## Page 134

Configuration NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.7 ASCII-File Information on configuring ASCII files as databases. The file is generated automatically by the Twin CAT Database Server. A Create Database procedure is not required. The created file can be imported and processed in other spreadsheet programs such as Microsoft Excel. Declaration in the Twin CAT Database Server Configurator ASCII file as database Database Type Select "ASCII" from the drop-down menu. ASCII File Enter the path for the ASCII file. The file is generated automatically by the Twin CAT Database Server. Value separator Here you can specify the separator for the values, i.e. for the columns. Default: ";" Old ASCII DB format For compatibility reasons you can optionally switch to the old ASCII format used by the Twin CAT Database Server 3.0.x versions. Use the default table structure. DBValue Type Only active if Old ASCII DB format is enabled. You can select BYTES or DOUBLE. With DOUBLE the values are in plain text, with BYTES they form a byte stream. Functions that are not supported Automatic ID generation is not supported by this database. If the standard table structure is used in Configure mode, the value of the ID is not set. Data type support WSTRING is not supported by this database. (See WString support [} 125]) Query Editor support This database is only partially supported by the Database Server SQL Query Editor. For example, it is not possible to execute a Select command with the ASCII-DB 3.0 format option selected. Windows CE support This database is also supported by the Windows CE version of the Twin CAT Database Server. The connection can be established locally. NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 134 Version: 1.13.8 TF6420
## Page 135

Configuration 5.2.8 XML database This section contains information on the configuration and the data type mapping of XML files as databases. The database structure, tables and columns are defined in an XSD file. The XML file, the XSD file and an XSL file containing style information are created with the Twin CAT Database Server configurator (Create command). Based on the XSL file the XML file can be opened in a web browser, where a graphical enhance view of the database or the table is presented. Further information on working with XML files as databases can be found in section "XML - information [} 136]". Declaration in the Twin CAT Database Server Configurator XML database Database Type Select "XML" from the drop-down menu. XML Database File Enter the name and path of the XML file. XML Schema File Enter the name and path of the XSD file. Database Enter the name of the database. If the database does not yet exist, it can be created with the Create button. Corresponding permissions must exist. In the case of XML databases, the XML, XSD and XSL files are created automatically. Windows CE support This database is also supported by the Windows CE version of the Twin CAT Database Server. The connection can be established locally. Data type mapping between DB and PLC E_Column Types XML Twin CAT PLC Big Int bigint T_ULARGE_INTEGER (Tc Utilities.lib) Integer integer DINT Small Int smallint INT Tiny Int tinyint BYTE Bit_ bit BOOL Money money LREAL Float float LREAL Real_ real LREAL Date Time datetime DT NText ntext STRING NChar nchar STRING Image image ARRAY OF BYTE NVar Char nvarchar STRING Binary binary ARRAY OF BYTE Var Binary varbinary ARRAY OF BYTE Data type support WSTRING is not supported by this database. (See WString support [} 125]) TF6420 Version: 1.13.8 135
## Page 136

Configuration NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.8.1 XML - information 1. Using an XML file as a database with the Twin CAT 3 Database Server 2. Apply XPath queries to an XML file with the Twin CAT 3 Database Server Further information about XML schemas can be found here: http://www.edition-w3.de/TR/2001/REC- xmlschema-0-20010502/ 1. XML as database XSD schema for standard table structure: <?xmlversion="1.0"?> <xsd:schemaxmlns:xsd="http://www.w3.org/2001/XMLSchema"> <xsd:simple Typename="bigint"> <xsd:restrictionbase="xsd:long" /> </xsd:simple Type> <xsd:simple Typename="datetime"> <xsd:restrictionbase="xsd:date Time" /> </xsd:simple Type> <xsd:simple Typename="ntext_80"> <xsd:restrictionbase="xsd:string"> <xsd:max Lengthvalue="80" /> </xsd:restriction> </xsd:simple Type> <xsd:simple Typename="float"> <xsd:restrictionbase="xsd:double" /> </xsd:simple Type> <xsd:complex Typename="my Table_Double_Type"> <xsd:sequence> <xsd:elementmin Occurs="0"max Occurs="unbounded"name="row"> <xsd:complex Type> <xsd:attributename="ID"type="bigint" /> <xsd:attributename="Timestamp"type="datetime" /> <xsd:attributename="Name"type="ntext_80" /> <xsd:attributename="Value" type="float" /> </xsd:complex Type> </xsd:element> </xsd:sequence> </xsd:complex Type> <xsd:elementname="Test DB_XML"> <xsd:complex Type> <xsd:sequencemin Occurs="1"max Occurs="1"> <xsd:elementname="my Table_Double"type="my Table_Double_Type" /> </xsd:sequence> </xsd:complex Type> </xsd:element> </xsd:schema> XML file for standard table structure (example): <?xmlversion="1.0"encoding="UTF-8"?> <Test DB_XMLxmlns:xs="http://www.w3.org/2001/XMLSchema- nstance"xs:no Namespace Schema Location="Test DB_XML.xsd"> <my Table_Double> <row ID="1"Timestamp="2012-03-08T12:45:08"Name="Test Value1"Value="222.222" /> <row ID="2"Timestamp="2012-03-08T12:45:14"Name="Test Value1"Value="222.222" /> <row ID="3"Timestamp="2012-03-08T12:45:18"Name="Test Value1"Value="222.222" /> <row ID="4"Timestamp="2012-03-08T12:45:22"Name="Test Value1"Value="222.222" /> <row ID="5"Timestamp="2012-03-08T12:45:23"Name="Test Value1"Value="222.222" /> </my Table_Double> </Test DB_XML> Data types for XML tables: 136 Version: 1.13.8 TF6420
## Page 137

Configuration <xsd:simple Typename="bigint"> <xsd:restrictionbase="xsd:long" /> </xsd:simple Type> <xsd:simple Typename="datetime"> <xsd:restrictionbase="xsd:date Time" /> </xsd:simple Type> <xsd:simple Typename="ntext_80"> //Länge kann individuell angegeben werden <xsd:restrictionbase="xsd:string"> <xsd:max Lengthvalue="80" /> </xsd:restriction> </xsd:simple Type> <xsd:simple Typename="float"> <xsd:restrictionbase="xsd:double" /> </xsd:simple Type> <xsd:simple Typename="binary_1"> //Länge kann individuell angegeben werden <xsd:restrictionbase="xsd:hex Binary"> <xsd:max Lengthvalue="1" /> </xsd:restriction> </xsd:simple Type> <xsd:simple Typename="bit"> <xsd:restrictionbase="xsd:boolean" /> </xsd:simple Type> <xsd:simple Typename="image_1"> //Länge kann individuell angegeben werden <xsd:restrictionbase="xsd:hex Binary"> <xsd:max Lengthvalue="1" /> </xsd:restriction> </xsd:simple Type> <xsd:simple Typename="integer"> <xsd:restrictionbase="xsd:int" /> </xsd:simple Type> <xsd:simple Typename="money"> <xsd:restrictionbase="xsd:double" /> </xsd:simple Type> <xsd:simple Typename="nchar_50"> //Länge kann individuell angegeben werden <xsd:restrictionbase="xsd:string"> <xsd:max Lengthvalue="50" /> </xsd:restriction> </xsd:simple Type> <xsd:simple Typename="nvarchar_50"> //Länge kann individuell angegeben werden <xsd:restrictionbase="xsd:string"> <xsd:max Lengthvalue="50" /> </xsd:restriction> </xsd:simple Type> <xsd:simple Typename="real"> <xsd:restrictionbase="xsd:double" /> </xsd:simple Type> <xsd:simple Typename="smallint"> <xsd:restrictionbase="xsd:short" /> </xsd:simple Type> <xsd:simple Typename="tinyint"> <xsd:restrictionbase="xsd:byte" /> </xsd:simple Type> <xsd:simple Typename="varbinary_1"> //Länge kann individuell angegeben werden <xsd:restrictionbase="xsd:hex Binary"> <xsd:max Lengthvalue="1" /> </xsd:restriction> </xsd:simple Type> TF6420 Version: 1.13.8 137
## Page 138

Configuration Data type mapping between DB and PLC E_Column Types XML Twin CAT PLC Big Int bigint T_ULARGE_INTEGER (Tc Utilities.lib) Integer integer DINT Small Int smallint INT Tiny Int tinyint BYTE Bit_ bit BOOL Money money LREAL Float float LREAL Real_ real LREAL Date Time datetime DT NText ntext STRING NChar nchar STRING Image image ARRAY OF BYTE NVar Char nvarchar STRING Binary binary ARRAY OF BYTE Var Binary varbinary ARRAY OF BYTE Creating/reading of records in/from the XML file Standard SQL commands can be used for generating records. The Twin CAT Database Server interprets SQL INSERT commands and converts them for the XML file in the form of XML nodes. The Twin CAT Database Server converts SQL SELECT commands for the XML file in the form of XPath queries. Samples for supported INSERT commands: • INSERT INTO my Table_Double (ID, Timestamp, Name, Value) VALUES(1, CURRENT_TIMESTAMP, 'Test Value1' , 1234.5678) • INSERT INTO my Table_Double (Timestamp, Name) VALUES(CURRENT_TIMESTAMP, 'Test Value1'); • INSERT INTO my Table_Double VALUES(1, CURRENT_TIMESTAMP, 'Test Value1', 1234.5678); • INSERT INTO my Table_Double VALUES(1, '2010-01-06 12:13:14', 'Test Value1', 1234.5678); Samples for supported SELECT commands: • SELECTID, Timestamp, Name, Value FROM my Table_Double; • SELECT* FROM my Table_Double; • SELECTTimestamp, Name FROM my Table_Double • SELECT* FROM my Table_Double WHERE Name = 'Test Value1'; • SELECT* FROM my Table_Double WHERE ID > 1; Supported function blocks: • FB_DBCreate • FB_DBCyclic Rd Wrt • FB_DBRead • FB_DBRecord Array Select • FB_DBRecord Delete • FB_DBRecord Insert • FB_DBRecord Insert_EX • FB_DBRecord Select • FB_DBRecord Select_EX • FB_DBTable Create 138 Version: 1.13.8 TF6420
## Page 139

Configuration • FB_DBWrite 2. XML standard XPath function XPath types The syntax of the prefixes of the XPaths in the Twin CAT Database Server is as follows: XPATH_[Type]<[Position]>#[Path] There are 4 different types of XPath: • SEL ◦ Reads data from the XML and returns them to the PLC • ADD ◦ Appends the transferred data to the XML at the selected position. • UPD ◦ Replaces the existing XML information at the selected position with the new data. • DEL ◦ Deletes the data in the XML at the selected position. There are 3 different data available for the positions: • ATTR ◦ Applies to all attribute values from the selected XML tag. • TAG ◦ Applies to the Inner Text value of the selected XML tag. • SUBTAG ◦ Applies to the Inner Text value of all subtags of the selected XML tag. ◦ If an XML Schema exists, the attributes are converted to the correct data types. If no XML Schema exists, the attributes are returned as T_Max String. Samples: XML file: <?xmlversion="1.0"encoding="utf-8" ?> <Test XML> <Nodeattr1="1"attr2="Node1"> <Sub Node1>Sub Node Wert1</Sub Node1> <Sub Node2>200</Sub Node2> <Sub Node3>Sub Node Wert3</Sub Node3> <Sub Node4>400.5</Sub Node4> <Sub Node5>Sub Node Wert5</Sub Node5> </Node> <Nodeattr1="2"attr2="Node2"> <Sub Node1>Sub Node Wert1</Sub Node1> <Sub Node2>200</Sub Node2> <Sub Node3>Sub Node Wert3</Sub Node3> <Sub Node4>400.5</Sub Node4> <Sub Node5>Sub Node Wert5</Sub Node5> </Node> </Test XML> XML Schema: <?xmlversion="1.0"encoding="utf-8"?> <xs:schemaattribute Form Default="unqualified"element Form Default="qualified"xmlns:xs="http:// www.w3.org/2001/XMLSchema"> <xs:elementname="Test XML"> <xs:complex Type> <xs:sequence> <xs:elementmax Occurs="unbounded"name="Node"> <xs:complex Type> <xs:sequence> <xs:elementname="Sub Node1"type="xs:string" /> <xs:elementname="Sub Node2"type="xs:short" /> <xs:elementname="Sub Node3"type="xs:string" /> <xs:elementname="Sub Node4"type="xs:double" /> TF6420 Version: 1.13.8 139
## Page 140

Configuration <xs:elementname="Sub Node5"type="xs:string" /> </xs:sequence> <xs:attributename="attr1" type="xs:integer"use="required" /> <xs:attributename="attr2" type="xs:string"use="required" /> </xs:complex Type> </xs:element> </xs:sequence> </xs:complex Type> </xs:element> </xs:schema> Sample for XPATH<ATTR> XPath => XPATH_SEL<ATTR>#Test XML/Node[@attr1=2] Returned structure if no schema exists: TYPEST_Record : STRUCT attr1 : T_Max String := '2'; attr2 : T_Max String := 'Node2'; END_STRUCT END_TYPE Returned structure if one schema exists: TYPEST_Record : STRUCT attr1 : DINT := 2; attr2 : T_Max String := 'Node2'; END_STRUCT END_TYPE Sample for XPATH<TAG> XPath => XPATH_SEL<TAG>#Test XML/Node[@attr1=2]/Sub Node2 Returned value if no schema exists: Sub Node2 : T_Max String := '200'; Returned value if one schema exists: Sub Node2 : INT := 200; Sample for XPATH<SUBTAG> XPath => XPATH_SEL<SUBTAG>#Test XML/Node[@attr1=2] Returned structure if no schema exists: TYPEST_Record : STRUCT Sub Node1 : T_Max String := 'Sub Node Wert1'; Sub Node2 : T_Max String := '200'; Sub Node3 : T_Max String := 'Sub Node Wert3'; Sub Node4 : T_Max String := '400.5'; Sub Node5 : T_Max String := 'Sub Node Wert5'; END_STRUCT END_TYPE Returned structure if one schema exists: TYPEST_Record : STRUCT Sub Node1 : T_Max String := 'Sub Node Wert1'; Sub Node2 : INT := 200; Sub Node3 : T_Max String := 'Sub Node Wert3'; Sub Node4 : LREAL := 400.5; Sub Node5 : T_Max String := 'Sub Node Wert5'; END_STRUCT END_TYPE Special feature of the use of the FB_PLCDBCmd: Unlike the usual implementation of the FB_PLCDBCmd, the set parameters (ST_Exp Parameter) do not specify the placeholders for the respective instruction, but the scheme of the transferred or returned data. Supported function blocks • FB_DBRecord Select 140 Version: 1.13.8 TF6420
## Page 141

Configuration • FB_DBRecord Select_EX • FB_DBRecord Array Select 5.2.9 ODBC databases Many databases offer ODBC interfaces. The Twin CAT Database Server also has this interface. In the Twin CAT Database Configurator it is therefore generally possible to select an ODBC database in the database configuration menu. So-called "Free Connection Strings [} 141]" can be used to form your own connection strings with Add additional parameter. Further known and regularly used ODBC databases are available as templates. These include: • My SQL [} 142] • Oracle [} 143] • Postgre SQL [} 144] • IBM DB2 [} 145] • Firebird [} 147] Windows CE support Under Windows CE this database is not supported by the Twin CAT Database Server. 5.2.9.1 Free connection string To use a database with ODBC interface that is not supported by the Twin CAT Database Server by default, you can select "Unknown Database" as ODBC type. Declaration in the Twin CAT Database Server Configurator ODBC Free Connection String database Database Type "Odbc_Database" ODBC Type Select "Unknown Database" from the drop-down menu. Simply find the connection string for the ODBC database and remodel it in the configuration window of the Twin CAT Database Server. TF6420 Version: 1.13.8 141
## Page 142

Configuration Two commands are available in the context menu for this purpose: • Add additional Parameter Adds a general parameter for the connection string. This can have any name, as required by the connection string. • Add additional Password Parameter Adds a special password parameter, the value of which is not readable (encrypted) in the configurator and in the configuration file. Operating principle with Free Connection String To ensure that the Twin CAT Database Server can work with a Free Connection String, the corresponding driver must be installed on the target system of the Twin CAT Database Server. Only "SQL Expert mode [} 17]" can be used! NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.9.2 My SQL This section contains information on the configuration and the data type mapping of My SQL databases with ODBC. 142 Version: 1.13.8 TF6420
## Page 143

Configuration Declaration in the Twin CAT Database Server Configurator ODBC My SQL database Database Type “Odbc_Database” ODBC Type Select "My SQL" from the drop-down menu. Driver Enter the actually installed driver. Server Enter the name or IP address of your server. Database Enter the name of the database. Port Enter the port for communicating with the My SQL database here. Default: 3306. Option Default: 2 “Return matched rows instead of affected rows” Uid Enter the user name. Pwd Enter the corresponding password. Data type mapping between DB and PLC E_Column Types My SQL Twin CAT PLC Big Int BIGINT T_ULARGE_INTEGER (Tc Utilities.lib) Integer INT DINT Small Int SMALLINT INT Tiny Int TINYINT SINT Bit_ CHAR(1) STRING Money DECIMAL(18,4) LREAL Float DOUBLE LREAL Real_ FLOAT REAL Date Time DATETIME DT NText TEXT STRING NChar CHAR STRING Image BLOB ARRAY OF BYTE NVar Char VARCHAR STRING Binary BLOB ARRAY OF BYTE Var Binary BLOB ARRAY OF BYTE Data type support This database supports the data type WSTRING. (See WString support [} 125]) Functioning All functions of the Twin CAT Database Server can be applied to the ODBC templates. This does not apply to the "Free Connection String [} 141]". NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.9.3 Oracle This section contains information on the configuration and the data type mapping of Oracle databases with ODBC. TF6420 Version: 1.13.8 143
## Page 144

Configuration Declaration in the Twin CAT Database Server Configurator ODBC Oracle database Database Type "Odbc_Database" ODBC Type Select "Oracle" from the drop-down menu. Driver Select here the actually installed driver. Server Enter the name or IP address of your server. Uid Enter the user name here. Pwd Enter the corresponding password. Data type mapping between DB and PLC E_Column Types Oracle Twin CAT PLC Big Int DECIMAL(15,0) T_ULARGE_INTEGER (Tc Utilities.lib) Integer INTEGER DINT Small Int SMALLINT INT Tiny Int SMALLINT SINT Bit_ CHAR(1) BYTE Money DECIMAL(18,4) LREAL Float DOUBLE PRECISION LREAL Real_ FLOAT REAL Date Time DATE DT NText VARCHAR(254) STRING NChar CHAR(254) STRING Image BLOB ARRAY OF BYTE NVar Char NVARCHAR(254) STRING Binary BLOB ARRAY OF BYTE Var Binary BLOB ARRAY OF BYTE Data type support This database supports the data type WSTRING. (See WString support [} 125]) Functioning All functions of the Twin CAT Database Server can be applied to the ODBC templates. This does not apply to the "Free Connection String [} 141]". NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.9.4 Postgre SQL This section contains information on the configuration and the data type mapping of Postgre SQL databases with ODBC. 144 Version: 1.13.8 TF6420
## Page 145

Configuration Declaration in the Twin CAT Database Server Configurator ODBC Postgre SQL database Database Type "Odbc_Database" ODBC Type Select "Postgre SQL" from the drop-down menu. Driver Select here the actually installed driver. Server Enter the name or IP address of your server. Database Enter the name of the database. Port Enter the port for communicating with the Postgre SQL database. Default: 5432. Uid Enter the user name here. Pwd Enter here the corresponding password. Data type mapping between DB and PLC E_Column Types Postgre SQL Twin CAT PLC Big Int BIGINT T_ULARGE_INTEGER (Tc Utilities.lib) Integer integer DINT Small Int smallint INT Tiny Int smallint INT Bit_ bit BYTE Money money LREAL Float Double precision LREAL Real_ real REAL Date Time timestamp DT NText text STRING NChar character STRING Image byte ARRAY OF BYTE NVar Char Character varying STRING Binary byte ARRAY OF BYTE Var Binary byte ARRAY OF BYTE Data type support This database supports the data type WSTRING. The character set must be set up when the database is created. Functioning All functions of the Twin CAT Database Server can be applied to the ODBC templates. This does not apply to the "Free Connection String [} 141]". NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.9.5 IBM DB2 This section contains information on the configuration and the data type mapping of IBM DB2 databases with ODBC. TF6420 Version: 1.13.8 145
## Page 146

Configuration Declaration in the Twin CAT Database Server Configurator ODBC IBM DB2 database Database Type "Odbc_Database" ODBC Type Select "IBM DB2" from the drop-down menu. Driver Enter here the actually installed driver. Host name Enter the name or IP address of your server. Database Enter the name of the database. Port Enter the port for communicating with the IBM DB2 database. Default: 50000. Protocol Default: TCPIP Uid Enter the user name here. Pwd Enter here the corresponding password. LONGDATACOMPAT Default: 1 Data type mapping between DB and PLC E_Column Types IBM DB2 Twin CAT PLC Big Int BIGINT T_ULARGE_INTEGER (Tc Utilities.lib) Integer INT DINT Small Int SMALLINT INT Tiny Int SMALLINT INT Bit_ VARCHAR(1) STRING(1) Money DECIMAL(18,4) LREAL Float DOUBLE PRECISION LREAL Real_ FLOAT LREAL Date Time TIMESTAMP DT NText LONG VARCHAR STRING NChar CHAR(254) STRING Image BLOB ARRAY OF BYTE NVar Char NVARCHAR(254) STRING Binary BLOB ARRAY OF BYTE Var Binary BLOB ARRAY OF BYTE Data type support WSTRING is not supported by this database. (See WString support [} 125]) Functioning All functions of the Twin CAT Database Server can be applied to the ODBC templates. This does not apply to the "Free Connection String [} 141]". NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 146 Version: 1.13.8 TF6420
## Page 147

Configuration 5.2.9.6 Firebird This section contains information on the configuration and the data type mapping of Firebird databases with ODBC. Declaration in the Twin CAT Database Server Configurator ODBC Firebird database Database Type "Odbc_Database" ODBC Type Select "Firebird" from the drop-down menu. Driver Select here the actually installed driver. Database Enter the name of the database. Client Uid Enter the user name here. Pwd Enter the corresponding password. Data type mapping between DB and PLC E_Column Types Firebird Twin CAT PLC Big Int BIGINT T_ULARGE_INTEGER (Tc Utilities.lib) Integer INTEGER DINT Small Int SMALLINT INT Tiny Int TINYINT INT Bit_ CHAR(1) STRING Money DECIMAL(18,4) LREAL Float FLOAT REAL Real_ DOUBLE PRECISION LREAL Date Time TIMESTAMP DT NText VARCHAR(254) STRING NChar CHAR(254) STRING Image BLOB ARRAY OF BYTE NVar Char VARCHAR(254) STRING Binary BLOB ARRAY OF BYTE Var Binary BLOB ARRAY OF BYTE Data type support WSTRING is not supported by this database. (See WString support [} 125]) Functioning All functions of the Twin CAT Database Server can be applied to the ODBC templates. This does not apply to the "Free Connection String [} 141]". NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. TF6420 Version: 1.13.8 147
## Page 148

Configuration 5.2.10 MS Access database The values of the variables are saved in a Microsoft Access database. Access 2000 and Access 2003 (*.mdb) database files are compatible, as are Access 2007 (*.accdb) files. All you have to do is specify different providers in the declaration in the XML configuration file. Declaration in the Twin CAT Database Server Configurator Microsoft Access database DBValue Type Select "Double" to limit logging to alphanumeric and Boolean data types. Select "Bytes" to also log structures and strings. DBType Select "MS Access". PLC: e DBType_Access. DBServer Not required. DBProvider Access 2000 - Access 2003: The provider is "Microsoft. Jet. OLEDB.4.0". Access 2007: The provider is "Microsoft. ACE. OLEDB.12.0". DBUrl DBUrl contains the path to the MDB file. e.g. C:\Twin CAT\Tc Database Srv\Samples\Test DB.mdb DBTable DBTable contains the name of the table. Windows CE support Under Windows CE this database is not supported by the Twin CAT Database Server. Twin CAT/BSD support This database is not supported by the Twin CAT Database Server on the Twin CAT/BSD platform. Data type mapping between DB and PLC E_DBColumn Types MS Access PLC Control e DBColumn_Big Int Integer4 DINT e DBColumn_Integer Integer2 INT e DBColumn_Small Int Integer2 SINT e DBColumn_Tiny Int Integer1 SINT e DBColumn_Bit YESNO BYTE e DBColumn_Money Currency LREAL e DBColumn_Float Double LREAL e DBColumn_Real Single REAL e DBColumn_Date Time DATETIME DT e DBColumn_NText Text STRING e DBColumn_NChar Var Char STRING e DBColumn_Image OLEOBJECT ARRAY OF BYTE e DBColumn_NVar Char Var Char STRING e DBColumn_Binary OLEOBJECT ARRAY OF BYTE e DBColumn_Var Binary OLEOBJECT ARRAY OF BYTE Data type support WSTRING is not supported by this database. (See WString support [} 125]) 148 Version: 1.13.8 TF6420
## Page 149

Configuration NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.11 MS Excel database The variable values are stored in a Microsoft Excel database. Declaration in the Twin CAT Database Server Configurator Microsoft Excel database DBValue Type Select "Double" to limit logging to alphanumeric and Boolean data types. Select "Bytes" to also log structures and strings. DBType Select "MS Excel". PLC: e DBType_MSExcel. DBServer Not required. DBProvider "Microsoft. Jet. OLEDB.4.0" or "Microsoft. ACE. OLEDB.12.0" DBUrl DBUrl contains the path to the Excel file. e.g. C:\Twin CAT\Tc Database Srv\Samples\Test DB.xls DBTable DBTable contains the name of the table. Windows CE support Under Windows CE this database is not supported by the Twin CAT Database Server. Twin CAT/BSD support This database is not supported by the Twin CAT Database Server on the Twin CAT/BSD platform. Data type mapping between DB and PLC E_DBColumn Types MS Excel PLC Control e DBColumn_Big Int Number LREAL e DBColumn_Integer Number LREAL e DBColumn_Small Int Number LREAL e DBColumn_Tiny Int Number LREAL e DBColumn_Bit BOOLEAN BOOL e DBColumn_Money Currency LREAL e DBColumn_Float Number LREAL e DBColumn_Real Number LREAL e DBColumn_Date Time Date DT e DBColumn_NText Text STRING(255) e DBColumn_NChar Text STRING(255) e DBColumn_NVar Char Text STRING(255) Functions that are not supported Automatic ID generation is not supported by this database. If the standard table structure is used in Configure mode, the value of the ID is not set. TF6420 Version: 1.13.8 149
## Page 150

Configuration Non-supported data types Binary, Var Binary and Image are not supported with Excel databases. Data type support WSTRING is not supported by this database. (See WString support [} 125]) NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.12 Mongo DB This section contains information on the configuration and the data type mapping of Mongo DB databases. Declaration in the Twin CAT Database Server Configurator Mongo DB Database Type Select "Mongo DB" from the drop-down menu. Server Enter the name of your Mongo DB server. Database Enter the name of the database. If the database does not yet exist, it is created the first time it is accessed. Authentication None: No authentication User name/password: Login with user name and password x509 certificate: User name: ID of the certificate user Certificate Authority: path to signing certificate (*.crt) Client Certificate: path to client certificate (*.pfx) Client Private Key: password for the client certificate GSSAPI/Kerberos: Login with user name and password LDAP(PLAIN): Login with user name and password (Since the user name and password are transmitted in plain text, this option is not recommended) Windows CE support Under Windows CE this database is not supported by the Twin CAT Database Server. 150 Version: 1.13.8 TF6420
## Page 151

Configuration Data type mapping between DB and PLC Mongo DB Twin CAT PLC long LINT int DINT bool BYTE double LREAL timestamp DT string STRING bin Data ARRAY OF BYTE object Id T_Object Id_Mongo DB array ARRAY object STRUCT Data type support WSTRING is not supported by this database. (See WString support [} 125]) Mongo DB in PLC Expert/Configure mode PLC Expert and Configure mode use the predefined database schema in their processes. Normally, the schema of the structures used will not change during operation. In order to nevertheless be able to use the function blocks, the Twin CAT 3 Database Server requires a description of the table schema. For Mongo DB a table is therefore simulated. In the SQL Query Editor, use the SQL tab and the CREATE TABLE subcategory to create a table, or in this case a collection. In addition, unlike for relational databases, an entry is created in a metadata collection. Information on the table schema for the Twin CAT 3 Database Server is stored here. In order to use advanced functionality, e.g. structures of any hierarchy or flexible records, we recommend using the No SQL function blocks. Use of certificates Among other things, Mongo DB supports authentication by means of certificates. To this end, select the 'x509 certificate' method under Authentication. The following fields appear: User name User name of the corresponding certificate Certificate Authority Path to the SSL certificate of the certificate authority. This may be a self-signed certificate. Client Certificate Client certificate signed by the SSL certificate. Client Certificate Password of the client certificate. Password Configuring the database connection to Mongo DB using certificates: TF6420 Version: 1.13.8 151
## Page 152

Configuration NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.13 Postgre SQL This section provides information about configuration and application of the Postgre Sql database. Postgre SQL is an object-relational open source database with a client-server infrastructure. The Twin CAT 3 database server uses the Npgsql API for connection. Declaration in the Twin CAT Database Server Configurator Postgre Sql database Database type Select "Postgre Sql" from the drop-down menu. Server Name or IP of the database server Database Name of the database on the server Port Port of the database Authentication Database authentication method User name Enter the user name. Password Enter the corresponding password. Client Certificate Path to used client certificate (.pfx) Client Certificate Password Password of the referenced client certificate Windows CE support Under Windows CE this database is not supported by the Twin CAT Database Server. 152 Version: 1.13.8 TF6420
## Page 153

Configuration Data type mapping between DB and PLC E_Column Types Postgre SQL Twin CAT PLC Big Int Bigint T_ULARGE_INTEGER (Tc Utilities.lib) Integer Integer DINT Small Int Smallint INT Tiny Int SINT Bit_ Bit BYTE Money Money LREAL Float Double precision LREAL Real_ Real REAL Date Time Timestamp without time zone DT NText Text STRING NChar Character STRING Image ARRAY OF BYTE NVar Char Character varying STRING Binary Bytea ARRAY OF BYTE Var Binary ARRAY OF BYTE NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. Data type support WSTRING is not supported by this database. (See WString support [} 125]) 5.2.14 Influx DB This section contains information about the configuration and the data type mapping of Influx DB. Supported version: 1.7.x, 1.8.x Declaration in the Twin CAT Database Server Configurator Influx DB Database type Select "Influx DB" from the drop-down menu. Server Enter the address of the desired database server here. Database Enter the name of the database. If the database does not yet exist, you can create it with "Create". Authentication None: No authentication User name/password: Login with user name and password Windows CE support Under Windows CE this database is not supported by the Twin CAT Database Server. TF6420 Version: 1.13.8 153
## Page 154

Configuration Data type mapping between DB and PLC E_Column Types Influx DB Twin CAT PLC Big Int Integer LINT Integer Integer DINT Small Int Integer INT Tiny Int Integer BYTE Bit_ Boolean BOOL Money Float LREAL Float Float LREAL Real_ Float LREAL Date Time DT NText String STRING NChar String STRING Image ARRAY OF BYTE NVar Char String STRING Binary ARRAY OF BYTE Var Binary ARRAY OF BYTE Tag STRING "time" LINT Time As a time series database, Influx DB has some special features. Each measurement (table) of a series contains the time column, tag columns and field columns. The time column is stored in the database as UNIX epoch time. The function blocks of the database server use the Twin CAT time (number of 100 ns steps since January 1, 1601). They are converted to UNIX epoch time. The FB_SQLDBCommand is excluded from this conversion. Here you can transfer your own free timestamps without conversion. The precision is set to "ns" accuracy. Times are unique in Influx DB as ID together with the tag columns. If the tags and the time are identical, a data set is overwritten. Standard table structure The standard table structure for Influx DB looks like this in the PLC: Column Name Influx DB Twin CAT PLC time Integer LINT Name Tag T_Max String Value Float LREAL Data type support WSTRING is not supported by this database. (See WString support [} 125]) NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 5.2.15 Influx DB2 This section contains information about the configuration and the data type mapping of Influx DB2. 154 Version: 1.13.8 TF6420
## Page 155

Configuration Supported version: 2.x Declaration in the Twin CAT Database Server Configurator Influx DB Database Type Select "Influx DB2" from the drop-down menu. Server Enter the address of the desired database server here. Database Enter the name of the database. If the database does not yet exist, you can create it with "Create". Authentication None: no authentication User name/password: Login with username and password Token Access token for accessing the database. This can be created with the necessary rights in the database software. Windows CE support Under Windows CE this database is not supported by the Twin CAT Database Server. Data type mapping between DB and PLC E_Column Types Influx DB2 Twin CAT PLC Big Int Integer LINT Integer Integer DINT Small Int Integer INT Tiny Int Integer BYTE Bit_ Boolean BOOL Money Float LREAL Float Float LREAL Real_ Float LREAL Date Time Date Time DT NText String STRING NChar String STRING Image - ARRAY OF BYTE NVar Char String STRING Binary - ARRAY OF BYTE Var Binary - ARRAY OF BYTE Tag Tag STRING Big Int "_time" LINT Time As a time series database, Influx DB2 has some special features. Each measurement (table) of a series contains the time column, tag columns and field columns. The time column is stored in the database as UNIX epoch time. The function blocks of the database server use the Twin CAT time (number of 100 ns steps since January 1, 1601). They are converted to UNIX epoch time. The FB_SQLDBCommand is excluded from this conversion. Here you can transfer your own free timestamps without conversion. The precision is set to "ns" accuracy. Times are unique in Influx DB as ID together with the tag columns. If the tags and the time are identical, a data set is overwritten. Data type support WSTRING is not supported by this database. (See WString support [} 125]) TF6420 Version: 1.13.8 155
## Page 156

Configuration NOTICE Data security In flash memory devices the number of write access operations is limited. The flash memory devices can fail, with a risk of data loss. • Make regular backups of your system. Use the IPC diagnostics in order to determine the status of the flash memory devices. 156 Version: 1.13.8 TF6420
## Page 157

PLC API 6 PLC API 6.1 Tc3_Database 6.1.1 Function blocks The function blocks of the Tc3_Database.compiled library are split into three sections, based on the basic concept [} 17]: • Configure Mode: Contains function blocks for controlling reading and writing of Auto Log groups defined in the configurator. • PLC Expert Mode: Contains function blocks for conventional PLC programmers. • SQL Expert mode: IT and PLC experts with advanced database knowledge can use these function blocks to assemble SQL commands in the PLC. • No Sql Expert Mode: These function blocks can be used by IT and PLC experts with extended database knowledge to create commands via No SQL databases and send them to the database. Using the Tc3_Eventlogger The Twin CAT 3 Database Server supports the Tc3_Eventlogger API. Further information can be found under Support for the Tc3_Event Logger [} 220] 6.1.1.1 Configure mode 6.1.1.1.1 FB_Config Tc DBSrv Evt Function block for creating, reading and deleting configuration entries for the Twin CAT Database Server. Syntax Definition: FUNCTION_BLOCK FB_Config Tc DBSrv Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. TF6420 Version: 1.13.8 157
## Page 158

PLC API Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Create [} 158] Local Creates new entries in the XML configuration file for the Twin CAT Database Server Read [} 159] Local Reads the current configuration of the Twin CAT Database Server Delete [} 160] Local Deletes the database and Auto Log groups from the configuration of the Twin CAT Database Server Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.1.1.1 Create This method creates new entries in the XML configuration file for the Twin CAT Database Server. Optionally the Twin CAT Database Server can use a new entry on a temporary basis. In this case no data is written to the XML file. Syntax METHOD Create : BOOL VAR_INPUT p Tc DBSrv Config: POINTER TO BYTE; cb Tc DBSrv Config: UDINT; b Temporary: BOOL := TRUE; p Config ID: POINTER TO UDINT; END_VAR 158 Version: 1.13.8 TF6420
## Page 159

PLC API Inputs Name Type Description p Tc DBSrv Config POINTER TO BYTE Pointer of the configuration structure to be created. cb Tc DBSrv Config UDINT Length of the configuration structure b Temporary BOOL Indicates whether the configuration is to be stored in the XML file. p Config ID POINTER TO UDINT Return pointer of the configuration ID (h DBID or h Auto Log Grp ID) Creating Auto Log groups is currently not supported. Return value Name Type Description Create BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv Evt(s Net Id := '', t Timeout:=T#5S); my Config Handle : UDINT; // Any other Config Type can be used here st Config DB : T_DBConfig_Ms Compact SQL; tc Message : I_Tc Message; END_VAR st Config DB.b Authentification := FALSE; st Config DB.s Server := 'C:\Recipes.sdf'; IF fb Config Tc DBSrv. Create( p Tc DBSrv Config:= ADR(st Config DB), cb Tc DBSrv Config:= SIZEOF(st Config DB), b Temporary:= TRUE, p Config ID:= ADR(my Config Handle)) THEN IF fb Config Tc DBSrv.b Error THEN tc Message := fb Config Tc DBSrv.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.1.1.2 Read This method can be used to read the current configurations of the Twin CAT Database Server. Any temporary configurations that may be included are marked accordingly. Syntax METHOD Read : BOOL VAR_INPUT p DBConfig: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Config DB; cb DBConfig: UDINT; p Auto Log Grp Config: POINTER TO ARRAY[1.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; cb Auto Log Grp Config: UDINT; p DBCount: POINTER TO UDINT; p Auto Log Grp Count: POINTER TO UDINT; END_VAR TF6420 Version: 1.13.8 159
## Page 160

PLC API Inputs Name Type Description p DBConfig POINTER TO ARRAY [1.. MA Pointer address of the array into which the database configurations are to be written. X_CONFIGURATIONS [} 247]] OF ST_Config DB [} 229] cb DBConfig UDINT Length of the database configuration array p Auto Log Grp Config POINTER TO ARRAY[1.. MAX Pointer address of the array into which the Auto Log Grp configurations are to be written. _CONFIGURATIONS [} 247]] OF ST_Config Auto Log Grp [} 228] cb Auto Log Grp Config UDINT Length of the Auto Log Grp configuration array p DBCount POINTER TO UDINT Pointer address for storing the number of database configurations. p Auto Log Grp Count POINTER TO UDINT Pointer address for storing the number of Auto Log Grp configurations. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv Evt(s Net Id := '', t Timeout:=T#5S); a DBConfig : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config DB; a Auto Grp Config : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; n Db Count : UDINT; n Auto Grp Count : UDINT; tc Message : I_Tc Message; END_VAR IF fb Config Tc DBSrv. Read( p DBConfig := ADR(a DBConfig), cb DBConfig := SIZEOF(a DBConfig), p Autolog Grp Config := ADR(a Auto Grp Config), cb Auto Log Grp Config := SIZEOF(a Auto Grp Config), p DBCount := ADR(n Db Count), p Auto Log Grp Count := ADR(n Auto Grp Count)) THEN IF fb Config Tc DBSrv.b Error THEN tc Message := fb Config Tc DBSrv.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.1.1.3 Delete This method can be used to delete databases and Auto Log groups from the configuration of the Twin CAT Database Server. Syntax METHOD Delete : BOOL VAR_INPUT e Tc DBSrv Config Type: E_Tc DBSrv Config Type; h Config ID: UDINT; END_VAR 160 Version: 1.13.8 TF6420
## Page 161

PLC API Inputs Name Type Description e Tc DBSrv Config Type E_Tc DBSrv Config Type Type of the configuration to be deleted (database / Auto Log group) h Config ID UDINT ID of the configuration to be deleted (h DBID or h Auto Log Grp ID) Return value Name Type Description Delete BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv Evt(s Net Id := '', t Timeout:=T#5S); my Config Handle : UDINT; tc Message : I_Tc Message; END_VAR IF fb Config Tc DBSrv. Delete( e Tc DBSrv Config Type := E_Tc DBSrv Config Type. Database, h Config ID := my Config Handle) THEN IF fb Config Tc DBSrv.b Error THEN tc Message := fb Config Tc DBSrv.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.1.2 FB_PLCDBAuto Log Evt Function block with four methods for starting and stopping of defined Auto Log groups and for reading of the corresponding group status. Syntax Definition: FUNCTION_BLOCK FB_PLCDBAuto Log Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; b Busy_Status: BOOL; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. TF6420 Version: 1.13.8 161
## Page 162

PLC API Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active, except for the Status method. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message Result interface with detailed information on the return value. b Busy_Status BOOL The Status method can be executed independently of the other three methods of the function block and therefore has its own Busy flag. Is TRUE as soon as the Status method is active. Methods Name Definition loca- Description tion Run Once Local Executes the Auto Log group once [} 162] Start [} 163] Local Starts Auto Log mode with the corresponding configured Auto Log groups Status [} 163] Local Queries the status of the Auto Log groups. Stop [} 164] Local Stops Auto Log mode Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.1.2.1 Run Once This method can be used to execute an Auto Log group once, for example based on an event in the controller. Syntax METHOD Run Once : BOOL VAR_INPUT h Auto Log Grp ID: UDINT; b All: BOOL; END_VAR Inputs Name Type Description h Auto Log Grp ID UDINT ID of the Auto Log group to be executed once. b All BOOL If TRUE, all Auto Log groups are executed once. Return value Name Type Description Run Once BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. 162 Version: 1.13.8 TF6420
## Page 163

PLC API Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log Evt (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Run Once(h Autolog Grp ID := 1, b All := FALSE) THEN ; // ... END_IF 6.1.1.1.2.2 Start This method starts the Auto Log mode with the corresponding configured Auto Log groups. Syntax METHOD Start : BOOL Return value Name Type Description Start BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log Evt (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Start() THEN ; // ... END_IF 6.1.1.1.2.3 Status This method can be used to query the status of the Auto Log groups. A separate busy flag is provided in the body of the function block for this method, since it can be called independently of the other methods of the function block: b Busy_Status. Syntax METHOD Status : BOOL VAR_INPUT t Check Cycle: TIME; p Error: POINTER TO BOOL; p Auto Log Grp Status: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Auto Log Grp Status; cb Auto Log Grp Status: UDINT; END_VAR Inputs Name Type Description t Check Cycle TIME Interval time at which the status array is updated. p Error POINTER TO BOOL TRUE, if an error has occurred in Auto Log mode. p Auto Log Status POINTER TO ARRAY Address of the status array that contains all [1.. MAX_CONFIGURATIONS [} 247]] OF groups. ST_Auto Log Grp Status [} 244] cb Auto Log Status UDINT Length of the status array TF6420 Version: 1.13.8 163
## Page 164

PLC API Return value Name Type Description Status BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log Evt(s Net ID:='', t Timeout := T#5S); b Error : BOOL; a Autolog Grp Status : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Auto Log Grp Status; END_VAR IF fb PLCDBAuto Log. Status(t Check Cycle := T#30S, ADR(b Error), ADR(a Autolog Grp Status), SIZEOF(a Autolog G rp Status)) THEN ; // ... END_IF 6.1.1.1.2.4 Stop This method stops the Auto Log mode. Syntax METHOD Stop : BOOL Return value Name Type Description Stop BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log Evt (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Stop() THEN ; // ... END_IF 164 Version: 1.13.8 TF6420
## Page 165

PLC API 6.1.1.2 PLC Expert mode 6.1.1.2.1 FB_Config Tc DBSrv Evt Function block for creating, reading and deleting configuration entries for the Twin CAT Database Server. Syntax Definition: FUNCTION_BLOCK FB_Config Tc DBSrv Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR TF6420 Version: 1.13.8 165
## Page 166

PLC API Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Create [} 166] Local Creates new entries in the XML configuration file for the Twin CAT Database Server Read [} 167] Local Reads the current configuration of the Twin CAT Database Server Delete [} 168] Local Deletes the database and Auto Log groups from the configuration of the Twin CAT Database Server Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.2.1.1 Create This method creates new entries in the XML configuration file for the Twin CAT Database Server. Optionally the Twin CAT Database Server can use a new entry on a temporary basis. In this case no data is written to the XML file. Syntax METHOD Create : BOOL VAR_INPUT p Tc DBSrv Config: POINTER TO BYTE; cb Tc DBSrv Config: UDINT; b Temporary: BOOL := TRUE; p Config ID: POINTER TO UDINT; END_VAR 166 Version: 1.13.8 TF6420
## Page 167

PLC API Inputs Name Type Description p Tc DBSrv Config POINTER TO BYTE Pointer of the configuration structure to be created. cb Tc DBSrv Config UDINT Length of the configuration structure b Temporary BOOL Indicates whether the configuration is to be stored in the XML file. p Config ID POINTER TO UDINT Return pointer of the configuration ID (h DBID or h Auto Log Grp ID) Creating Auto Log groups is currently not supported. Return value Name Type Description Create BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv Evt(s Net Id := '', t Timeout:=T#5S); my Config Handle : UDINT; // Any other Config Type can be used here st Config DB : T_DBConfig_Ms Compact SQL; tc Message : I_Tc Message; END_VAR st Config DB.b Authentification := FALSE; st Config DB.s Server := 'C:\Recipes.sdf'; IF fb Config Tc DBSrv. Create( p Tc DBSrv Config:= ADR(st Config DB), cb Tc DBSrv Config:= SIZEOF(st Config DB), b Temporary:= TRUE, p Config ID:= ADR(my Config Handle)) THEN IF fb Config Tc DBSrv.b Error THEN tc Message := fb Config Tc DBSrv.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.2.1.2 Read This method can be used to read the current configurations of the Twin CAT Database Server. Any temporary configurations that may be included are marked accordingly. Syntax METHOD Read : BOOL VAR_INPUT p DBConfig: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Config DB; cb DBConfig: UDINT; p Auto Log Grp Config: POINTER TO ARRAY[1.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; cb Auto Log Grp Config: UDINT; p DBCount: POINTER TO UDINT; p Auto Log Grp Count: POINTER TO UDINT; END_VAR TF6420 Version: 1.13.8 167
## Page 168

PLC API Inputs Name Type Description p DBConfig POINTER TO ARRAY [1.. MA Pointer address of the array into which the database configurations are to be written. X_CONFIGURATIONS [} 247]] OF ST_Config DB [} 229] cb DBConfig UDINT Length of the database configuration array p Auto Log Grp Config POINTER TO ARRAY[1.. MAX Pointer address of the array into which the Auto Log Grp configurations are to be written. _CONFIGURATIONS [} 247]] OF ST_Config Auto Log Grp [} 228] cb Auto Log Grp Config UDINT Length of the Auto Log Grp configuration array p DBCount POINTER TO UDINT Pointer address for storing the number of database configurations. p Auto Log Grp Count POINTER TO UDINT Pointer address for storing the number of Auto Log Grp configurations. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv Evt(s Net Id := '', t Timeout:=T#5S); a DBConfig : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config DB; a Auto Grp Config : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; n Db Count : UDINT; n Auto Grp Count : UDINT; tc Message : I_Tc Message; END_VAR IF fb Config Tc DBSrv. Read( p DBConfig := ADR(a DBConfig), cb DBConfig := SIZEOF(a DBConfig), p Autolog Grp Config := ADR(a Auto Grp Config), cb Auto Log Grp Config := SIZEOF(a Auto Grp Config), p DBCount := ADR(n Db Count), p Auto Log Grp Count := ADR(n Auto Grp Count)) THEN IF fb Config Tc DBSrv.b Error THEN tc Message := fb Config Tc DBSrv.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.2.1.3 Delete This method can be used to delete databases and Auto Log groups from the configuration of the Twin CAT Database Server. Syntax METHOD Delete : BOOL VAR_INPUT e Tc DBSrv Config Type: E_Tc DBSrv Config Type; h Config ID: UDINT; END_VAR 168 Version: 1.13.8 TF6420
## Page 169

PLC API Inputs Name Type Description e Tc DBSrv Config Type E_Tc DBSrv Config Type Type of the configuration to be deleted (database / Auto Log group) h Config ID UDINT ID of the configuration to be deleted (h DBID or h Auto Log Grp ID) Return value Name Type Description Delete BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv Evt(s Net Id := '', t Timeout:=T#5S); my Config Handle : UDINT; tc Message : I_Tc Message; END_VAR IF fb Config Tc DBSrv. Delete( e Tc DBSrv Config Type := E_Tc DBSrv Config Type. Database, h Config ID := my Config Handle) THEN IF fb Config Tc DBSrv.b Error THEN tc Message := fb Config Tc DBSrv.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.2.2 FB_PLCDBAuto Log Evt Function block with four methods for starting and stopping of defined Auto Log groups and for reading of the corresponding group status. Syntax Definition: FUNCTION_BLOCK FB_PLCDBAuto Log Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; b Busy_Status: BOOL; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. TF6420 Version: 1.13.8 169
## Page 170

PLC API Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active, except for the Status method. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message Result interface with detailed information on the return value. b Busy_Status BOOL The Status method can be executed independently of the other three methods of the function block and therefore has its own Busy flag. Is TRUE as soon as the Status method is active. Methods Name Definition loca- Description tion Run Once Local Executes the Auto Log group once [} 170] Start [} 171] Local Starts Auto Log mode with the corresponding configured Auto Log groups Status [} 171] Local Queries the status of the Auto Log groups. Stop [} 172] Local Stops Auto Log mode Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.2.2.1 Run Once This method can be used to execute an Auto Log group once, for example based on an event in the controller. Syntax METHOD Run Once : BOOL VAR_INPUT h Auto Log Grp ID: UDINT; b All: BOOL; END_VAR Inputs Name Type Description h Auto Log Grp ID UDINT ID of the Auto Log group to be executed once. b All BOOL If TRUE, all Auto Log groups are executed once. Return value Name Type Description Run Once BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. 170 Version: 1.13.8 TF6420
## Page 171

PLC API Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log Evt (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Run Once(h Autolog Grp ID := 1, b All := FALSE) THEN ; // ... END_IF 6.1.1.2.2.2 Start This method starts the Auto Log mode with the corresponding configured Auto Log groups. Syntax METHOD Start : BOOL Return value Name Type Description Start BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log Evt (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Start() THEN ; // ... END_IF 6.1.1.2.2.3 Status This method can be used to query the status of the Auto Log groups. A separate busy flag is provided in the body of the function block for this method, since it can be called independently of the other methods of the function block: b Busy_Status. Syntax METHOD Status : BOOL VAR_INPUT t Check Cycle: TIME; p Error: POINTER TO BOOL; p Auto Log Grp Status: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Auto Log Grp Status; cb Auto Log Grp Status: UDINT; END_VAR Inputs Name Type Description t Check Cycle TIME Interval time at which the status array is updated. p Error POINTER TO BOOL TRUE, if an error has occurred in Auto Log mode. p Auto Log Status POINTER TO ARRAY Address of the status array that contains all [1.. MAX_CONFIGURATIONS [} 247]] OF groups. ST_Auto Log Grp Status [} 244] cb Auto Log Status UDINT Length of the status array TF6420 Version: 1.13.8 171
## Page 172

PLC API Return value Name Type Description Status BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log Evt(s Net ID:='', t Timeout := T#5S); b Error : BOOL; a Autolog Grp Status : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Auto Log Grp Status; END_VAR IF fb PLCDBAuto Log. Status(t Check Cycle := T#30S, ADR(b Error), ADR(a Autolog Grp Status), SIZEOF(a Autolog G rp Status)) THEN ; // ... END_IF 6.1.1.2.2.4 Stop This method stops the Auto Log mode. Syntax METHOD Stop : BOOL Return value Name Type Description Stop BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log Evt (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Stop() THEN ; // ... END_IF 6.1.1.2.3 FB_PLCDBCreate Evt Function block with two methods. One method can be used to create databases from the PLC on a database server specified in the PLC. The other method can be used to generate a new table in a specified database. Syntax Definition: FUNCTION_BLOCK FB_PLCDBCreate Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR 172 Version: 1.13.8 TF6420
## Page 173

PLC API Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Database Local Creates a new database [} 173] Table [} 174] Local Creates a new table with a structure that is defined via an array with x elements or x columns in the PLC. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.2.3.1 Database This method creates a new database. Optionally you can specify whether the created database should also be used for the configuration of the Twin CAT Database Server. Syntax METHOD Database : BOOL VAR_INPUT p Database Config: POINTER TO BYTE; cb Database Config: UDINT; b Create XMLConfig: BOOL; p DBID: POINTER TO UDINT; END_VAR TF6420 Version: 1.13.8 173
## Page 174

PLC API Inputs Name Type Description p Database Config POINTER TO BYTE Address of the database configuration structure [} 230] cb Database Config UDINT Length of the database configuration structure b Create XMLConfig BOOL Indicates whether the newly created database should be entered as new configuration entry in the XML file. p DBID UDINT Returns the h DBID if/when a new configuration entry was created. Return value Name Type Description Database BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBCreate : FB_PLCDBCreate Evt(s Net ID := '', t Timeout := T#5S); st Config DB : T_DBConfig_Ms Compact SQL; h DBID : UDINT; tc Message : I_Tc Message; END_VAR st Config DB.b Authentification := FALSE; st Config DB.s Server := 'C:\Test.sdf'; IF fb PLCDBCreate. Database( p Database Config:= ADR(st Config DB), cb Database Config := SIZEOF(st Config DB), b Create XMLConfig := TRUE, p DBID := ADR(h DBID)) THEN IF fb PLCDBCreate.b Error THEN tc Message := fb PLCDBCreate.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.2.3.2 Table This method creates a new table with a structure that is defined through an array with x elements or x columns in the PLC. Syntax METHOD Table : BOOL VAR_INPUT h DBID : UDINT; s Table Name : T_Max String; p Table Cfg : POINTER TO ARRAY[0.. MAX_DBCOLUMNS] OF ST_Column Info; cb Table Cfg : UDINT; END_VAR 174 Version: 1.13.8 TF6420
## Page 175

PLC API Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name Max String Name of the table to be created. p Table Cfg POINTER TO Indicates the pointer address of the table structure ARRAY[0.. MAX_DBCOLUMNS array. The individual columns are written in this array. [} 247]] OF ST_Column Info [} 244] cb Table Cfg UDINT Indicates the length of the array in which the columns are configured. Return value Name Type Description Table BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBCreate : FB_PLCDBCreate Evt(s Net ID := '', t Timeout := T#5S); Column Info : ARRAY [0..14] OF ST_Column Info; tc Message : I_Tc Message; END_VAR Column Info[0].s Name := 'col Big Int'; Column Info[0].e Type := E_Column Type. Big Int; Column Info[0 ].n Length := 8; Column Info[0].s Property := 'IDENTITY(1,1)'; Column Info[1].s Name := 'col Integer'; Column Info[1].e Type := E_Column Type. Integer; Column Info[1 ].n Length := 4; Column Info[2].s Name := 'col Small Int'; Column Info[2].e Type := E_Column Type. Small Int; Column Info[2 ].n Length := 2; Column Info[3].s Name := 'col Tiny Int'; Column Info[3].e Type := E_Column Type. Tiny Int; Column Info[3 ].n Length := 1; Column Info[4].s Name := 'col Bit'; Column Info[4].e Type := E_Column Type. BIT_; Column Info[4 ].n Length := 1; Column Info[5].s Name := 'col Money'; Column Info[5].e Type := E_Column Type. Money; Column Info[5 ].n Length := 8; Column Info[6].s Name := 'col Float'; Column Info[6].e Type := E_Column Type. Float; Column Info[6 ].n Length := 8; Column Info[7].s Name := 'col Real'; Column Info[7].e Type := E_Column Type. REAL_; Column Info[7 ].n Length := 4; Column Info[8].s Name := 'col Date Time'; Column Info[8].e Type := E_Column Type. Date Time; Column Info[8 ].n Length := 4; Column Info[9].s Name := 'col NText'; Column Info[9].e Type := E_Column Type. NText; Column Info[9 ].n Length := 256; Column Info[10].s Name := 'col NChar'; Column Info[10].e Type := E_Column Type. NChar; Column Info[1 0].n Length := 10; Column Info[11].s Name := 'col Image'; Column Info[11].e Type := E_Column Type. Image; Column Info[1 1].n Length := 256; Column Info[12].s Name := 'col NVar Char'; Column Info[12].e Type := E_Column Type. NVar Char; Column Info[1 2].n Length := 50; Column Info[13].s Name := 'col Binary'; Column Info[13].e Type := E_Column Type. Binary; Column Info[1 3].n Length := 30; Column Info[14].s Name := 'col Var Binary'; Column Info[14].e Type := E_Column Type. Var Binary; Column Info[1 4].n Length := 20; IF fb PLCDBCreate. Table( h DBID:= 1, s Table Name:= 'my New Table', p Table Cfg:= ADR(Column Info), cb Table Cfg:= SIZEOF(Column Info)) THEN IF fb PLCDBCreate.b Error THEN Tc Message:= fb PLCDBCreate.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF TF6420 Version: 1.13.8 175
## Page 176

PLC API 6.1.1.2.4 FB_PLCDBRead Evt Function block for reading records from a database. Syntax Definition: FUNCTION_BLOCK FB_PLCDBRead Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Description n Records UDINT Outputs the maximum number of records that could be collected depending on s DBSymbol Name. e Trace Level Tc Event Severity Specifies the weighting of the events. Only events with a weighting higher than this value are sent to the Twin CAT system. [} 226] Methods Name Definition location Description Read [} 177] Local Reads a specified number of records from a database table with the standard table structure specified by Beckhoff. Read Struct [} 178] Local Reads a specified number of records from a database table with any table structure. 176 Version: 1.13.8 TF6420
## Page 177

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.2.4.1 Read This method reads a specified number of records from a database table with the standard table structure specified by Beckhoff. The standard table structure is used in Auto Log mode and in the FB_DBWrite Evt function block, for example. Syntax METHOD Read : BOOL VAR_INPUT h DBID: UDINT; s Table Name: T_Max String; s DBSymbol Name: T_Max String; e Order By: E_Order Column := E_Order Column.e Column ID; e Order Type: E_Order Type := E_Order Type.e Order_ASC; n Start Index: UDINT; n Record Count: UDINT; p Data: POINTER TO ST_Standard Record; cb Data: UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. s DBSymbol Name T_Max String Symbol name to be read from the standard table structure. e Order By E_Order Column.e Column ID Sorting column (ID, timestamp, name or value) e Order Type E_Order Type.e Order_ASC Sorting direction (ASC or DESC) n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Data POINTER TO ST_Standard Record Address of the structure array into which the records are to be written. cb Data UDINT Indicates the size of the structure array in bytes. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBRead : FB_PLCDBRead Evt (s Net ID := '', t Timeout := T#5S); Read Struct : ST_Standard Record; tc Message : I_Tc Message; END_VAR IF fb PLCDBRead. Read( h DBID:= 1, s Table Name:= 'My Table_With LReal', s DBSymbol Name:= 'My Value', e Order By:= E_Order Column. ID, e Order Type:= E_Order Type. DESC, n Start Index:= 0, n Record Count:= 1, p Data:= ADR(Read Struct), cb Data:= SIZEOF(Read Struct)) TF6420 Version: 1.13.8 177
## Page 178

PLC API THEN IF fb PLCDBRead.b Error THEN tc Message := fb PLCDBRead.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF Result in the PLC: 6.1.1.2.4.2 Read Struct This method reads a specified number of records from a database table with any table structure. Syntax METHOD Read Struct : BOOL VAR_INPUT h DBID: UDINT; s Table Name: T_Max String; p Column Names: POINTER TO ARRAY [0.. MAX_DBCOLUMNS] OF STRING(50); cb Column Names: UDINT; s Order By Column: STRING(50); e Order Type: E_Order Type := E_Order Type.e Order_ASC; n Start Index: UDINT; n Record Count: UDINT; p Data: POINTER TO BYTE; cb Data: UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. p Column Names POINTER TO ARRAY [0.. MAX_D Address of the array containing the column name BCOLUMNS] OF STRING(50) to be read. cb Column Names UDINT Length of the column name array s Order By Column STRING(50) Name the sorting column e Order Type E_Order Type Sorting direction (ASC or DESC) n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Data POINTER TO BYTE Address of the structure array into which the records are to be written. cb Data UDINT Indicates the size of the structure array in bytes. Return value Name Type Description Read Struct BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. 178 Version: 1.13.8 TF6420
## Page 179

PLC API Sample VAR fb PLCDBRead : FB_PLCDBRead Evt (s Net ID := '', t Timeout := T#5S); my Custom Struct : ST_Record; tc Message : I_Tc Message; END_VAR TYPE ST_Record : STRUCT n ID : LINT; dt Timestamp: DATE_AND_TIME; s Name : STRING; n Sensor1 : LREAL; n Sensor2 : LREAL; END_STRUCT END_TYPE // set columnnames Column Names[0] := 'ID'; Column Names[1] := 'Timestamp'; Column Names[2] := 'Name'; Column Names[3] := 'Sensor1'; Column Names[4] := 'Sensor2'; IF fb PLCDBRead. Read Struct( h DBID:= 1, s Table Name:= 'My Table_Struct', p Column Names:= ADR(Column Names), cb Column Names:= SIZEOF(Column Names), s Order By Column:= Column Names[0], e Order Type:= E_Order Type. DESC, n Start Index:= 0, n Record Count:= 1, p Data:= ADR(my Custom Struct), cb Data:= SIZEOF(my Custom Struct)) THEN IF fb PLCDBRead.b Error THEN tc Message:= fb PLCDBRead.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF Result in the PLC: 6.1.1.2.5 FB_PLCDBWrite Evt Function block for writing of records into a database. Syntax Definition: FUNCTION_BLOCK FB_PLCDBWrite Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; TF6420 Version: 1.13.8 179
## Page 180

PLC API t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Write [} 180] Local Creates a record in the standard table structure specified by Beckhoff. Write By Symbol Local Reads the value of a specified ADS symbol and saves it in the standard table structure specified by Beckhoff. [} 182] Write Struct [} 183] Local Creates a record with any table structure. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.2.5.1 Write This method creates a record in the standard table structure specified by Beckhoff. Syntax METHOD Write : BOOL VAR_INPUT h DBID: UDINT; s Table Name: T_Max String; 180 Version: 1.13.8 TF6420
## Page 181

PLC API p Value: POINTER TO BYTE; cb Value: UDINT; s DBSymbol Name: T_Max String; e DBWrite Mode: E_Write Mode := E_Write Mode.e ADS_TO_DB_Append; n Ring Buff Parameter: UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. p Value POINTER TO BYTE Address of the variable to be logged in the standard table structure. cb Value UDINT Length of the variable to be logged. s DBSymbol Name T_Max String Name that is logged in the table. e DBWrite Mode E_Write Mode Indicates the write mode. (append, update, ring buffer) n Ring Buff Parameter UDINT Additional parameter(s) for the "ring buffer" write mode. Return value Name Type Description Write BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample This sample shows how to use the FB_PLCDBWrite Evt. Write method: VAR fb PLCDBWrite : FB_PLCDBWrite Evt(s Net ID := '', t Timeout := T#5S); my Value : LREAL := 43.23; tc Message : I_Tc Message; END_VAR IF fb PLCDBWrite. Write( h DBID:= 1, s Table Name:= 'my Table_With LReal', p Value:= ADR(my Value), cb Value:= SIZEOF(my Value), s DBSymbol Name:= 'My Value', e DBWrite Mode:= E_Write Mode.e ADS_TO_DB_Ring Buff_Count, n Ring Buff Parameter:= 3) THEN IF fb PLCDBWrite.b Error THEN tc Message := fb PLCDBWrite.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF Result in the database: ID Timestamp Name Value 27 Has been dropped 28 '2018-01-30 14:04:19' 'My Value' 41.23 29 '2018-01-30 14:04:29' 'My Value' 42.23 30 '2018-01-30 14:04:39' 'My Value' 43.23 With the ring buffer option, only three entries of this name are in the database at any one time. Older entries are deleted. TF6420 Version: 1.13.8 181
## Page 182

PLC API 6.1.1.2.5.2 Write By Symbol This method reads the value of a specified ADS symbol and saves it in the standard table structure specified by Beckhoff. ADS symbols from other ADS devices can also be read. Syntax METHOD Write By Symbol : BOOL VAR_INPUT h DBID: UDINT; s Table Name: T_Max String; st ADSDevice: ST_ADSDevice; st Symbol: ST_Symbol; e DBWrite Mode: E_Write Mode := E_Write Mode.e ADS_TO_DB_Append; n Ring Buff Parameter: UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. st ADSDevice ST_ADSDevice ADS device from which a symbol is to be logged in the standard table structure. st Symbol ST_Symbol Symbol name of the variable to be written e DBWrite Mode E_Write Mode Indicates the write mode. (append, update, ring buffer) n Ring Buff Parameter UDINT Additional parameter(s) for the "ring buffer" write mode Return value Name Type Description Write By Symbol BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample This sample shows how to use the FB_PLCDBWrite Evt. Write By Symbol method: VAR fb PLCDBWrite : FB_PLCDBWrite Evt(s Net ID := '', t Timeout := T#5S); my Value : LREAL := 43.23; my Ads Device : ST_ADSDevice; my Symbol : ST_Symbol; tc Message : I_Tc Message; END_VAR // Set ADSDevice Information my Ads Device.s Dev Net ID := '127.0.0.1.1.1'; my Ads Device.n Dev Port := 851; my Ads Device.e ADSRd Wrt Mode := E_ADSRd Wrt Mode.by Symbol Name; my Ads Device.t Timeout := T#5S; // Set Symbol Information my Symbol.e Data Type := E_PLCData Type.e Type_LREAL; my Symbol.s DBSymbol Name := 'My Symbol'; my Symbol.s Symbol Name := 'MAIN.my Value'; my Symbol.n Bit Size := 8; // Call Functionblock IF fb PLCDBWrite. Write By Symbol( h DBID:= 1, s Table Name:= 'my Table_With LReal', st ADSDevice:= my Ads Device, st Symbol:= my Symbol, e DBWrite Mode:= E_Write Mode.e ADS_TO_DB_Append, n Ring Buff Parameter:= 1) THEN IF fb PLCDBWrite.b Error THEN tc Message := fb PLCDBWrite.ip Tc Result; 182 Version: 1.13.8 TF6420
## Page 183

PLC API n State := 255; ELSE n State := 0; END_IF END_IF Result in the database: ID Timestamp Name Value 28 '2018-01-30 14:04:19' 'My Value' 41.23 29 '2018-01-30 14:04:29' 'My Value' 42.23 30 '2018-01-30 14:04:39' 'My Value' 43.23 31 '2018-01-30 14:06:12’ ‘My Symbol’ 86.2 6.1.1.2.5.3 Write Struct This method creates a record with a freely selectable table structure. Syntax METHOD Write Struct : BOOL VAR_INPUT h DBID: UDINT; s Table Name: T_Max String; p Record: POINTER TO BYTE; cb Record: UDINT; p Column Names: POINTER TO ARRAY [0.. MAX_DBCOLUMNS] OF STRING(50); cb Column Names: UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. p Record POINTER TO BYTE Address of a structure that is to be logged in a freely selectable table structure. cb Record UDINT Length of the structure to be written p Column Names POINTER TO ARRAY [ Address of the array containing the column name to be filled. 0.. MAX_DBCOLUMNS ] OF STRING(50) cb Column Names UDINT Length of the column name array Return value Name Type Description Write Struct BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample This sample shows how to use the method FB_PLCDBWrite Evt. Write Struct: VAR fb PLCDBWrite : FB_PLCDBWrite Evt(s Net ID := '', t Timeout := T#5S); my Record : ST_Record; Column Names : ARRAY[0..4] OF STRING(50); systime : GETSYSTEMTIME; current Time : T_FILETIME; tc Message : I_Tc Message; END_VAR TF6420 Version: 1.13.8 183
## Page 184

PLC API TYPE ST_Record : STRUCT n ID : LINT; dt Timestamp: DATE_AND_TIME; s Name : STRING; n Sensor1 : LREAL; n Sensor2 : LREAL; END_STRUCT END_TYPE // set Values systime(time Lo Dw => current Time.dw Low Date Time, time Hi DW => current Time.dw High Date Time ); my Record.dt Timestamp := FILETIME_TO_DT(current Time); my Record.s Name := 'My Struct Val'; my Record.n Sensor1 := 12.34; my Record.n Sensor2 := 102.5; // set columnnames Column Names[0] := 'ID'; Column Names[1] := 'Timestamp'; Column Names[2] := 'Name'; Column Names[3] := 'Sensor1'; Column Names[4] := 'Sensor2'; // Call Functionblock IF fb PLCDBWrite. Write Struct( h DBID:= 1, s Table Name:= 'my Table_Struct', p Record:= ADR(my Record), cb Record:= SIZEOF(my Record), p Column Names:= ADR(Column Names) , cb Column Names:= SIZEOF(Column Names)) THEN IF fb PLCDBWrite.b Error THEN tc Message := fb PLCDBWrite.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF Result in the database: ID Timestamp Name Sensor1 Sensor2 5 '2018-01-30 ‘My Struct Val’ 12.34 102.5 15:23:26' 6.1.1.2.6 FB_PLCDBCmd Evt Function block with two methods. Users can define and transfer their own SQL commands. Placeholders in the SQL command can correlate with structures in the PLC, which reflect the table structure. The database server enters the current data of the structure into the SQL command. Syntax Definition: FUNCTION_BLOCK FB_PLCDBCmd Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR 184 Version: 1.13.8 TF6420
## Page 185

PLC API Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Execute [} 185] Local Sends any SQL commands to the database. Returned records cannot be read. Execute Data Return Local Sends any SQL commands to the database. [} 187] A specified number of records can be read. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.2.6.1 Execute This method can be used to send SQL commands to the database. The database connection is opened with each call and then closed again. It is possible to define placeholders in the command, which are replaced by the Twin CAT Database Server with the corresponding values before the execution. Returned records cannot be read. Syntax METHOD Execute : BOOL VAR_INPUT h DBID: UDINT; p Expression: POINTER TO BYTE; cb Expression: UDINT; p Data: POINTER TO BYTE; cb Data: UDINT; p Parameter: POINTER TO ARRAY[0.. MAX_DBCOLUMNS] OF ST_Exp Parameter; cb Parameter: UDINT; END_VAR TF6420 Version: 1.13.8 185
## Page 186

PLC API Sample VAR fb PLCDBCmd : FB_PLCDBCmd Evt(s Net ID := '', t Timeout := T#5S); s Cmd : STRING (1000); my Struct : ST_Data All; a Para : ARRAY[0..14] OF ST_Exp Parameter; tc Message : I_Tc Message; END_VAR TYPE ST_Data All : STRUCT col Big Int: LINT; col Integer: DINT; col Small Int: INT; col Tiny Int: BYTE; col Bit: BOOL; col Money: LREAL; col Float: LREAL; col Real: REAL; col Date Time: DT; col NText: STRING(255); col NChar: STRING(10); col Image: ARRAY[0..255] OF BYTE; col NVar Char: STRING(50); col Binary: ARRAY[0..29] OF BYTE; col Var Binary: ARRAY[0..19] OF BYTE; END_STRUCT END_TYPE // set Parameter configuration a Para[0].s Para Name := 'col Big Int'; a Para[0].e Para Type := E_Exp Parameter Type. Int64; a Para[0].n Para Size := 8; a Para[1].s Para Name := 'col Integer'; a Para[1].e Para Type := E_Exp Parameter Type. Int32; a Para[1].n Para Size := 4; a Para[2].s Para Name := 'col Small Int'; a Para[2].e Para Type := E_Exp Parameter Type. Int16; a Para[2].n Para Size := 2; a Para[3].s Para Name := 'col Tiny Int'; a Para[3].e Para Type := E_Exp Parameter Type. Byte_; a Para[3].n Para Size := 1; a Para[4].s Para Name := 'col Bit'; a Para[4].e Para Type := E_Exp Parameter Type. Boolean; a Para[4].n Para Size := 1; a Para[5].s Para Name := 'col Money'; a Para[5].e Para Type := E_Exp Parameter Type. Double64; a Para[5].n Para Size := 8; a Para[6].s Para Name := 'col Float'; a Para[6].e Para Type := E_Exp Parameter Type. Double64; a Para[6].n Para Size := 8; a Para[7].s Para Name := 'col Real'; a Para[7].e Para Type := E_Exp Parameter Type. Float32; a Para[7].n Para Size := 4; a Para[8].s Para Name := 'col Date Time'; a Para[8].e Para Type := E_Exp Parameter Type. Date Time; a Para[8].n Para Size := 4; a Para[9].s Para Name := 'col NText'; a Para[9].e Para Type := E_Exp Parameter Type. STRING_; a Para[9].n Para Size := 256; a Para[10].s Para Name:= 'col NChar'; a Para[10].e Para Type := E_Exp Parameter Type. STRING_; a Para[10].n Para Size := 10; a Para[11].s Para Name:= 'col Image'; a Para[11].e Para Type := E_Exp Parameter Type. Byte Array; a Para[11].n Para Size := 256; a Para[12].s Para Name:= 'col NVar Char'; a Para[12].e Para Type := E_Exp Parameter Type. STRING_; a Para[12].n Para Size := 50; a Para[13].s Para Name:= 'col Binary'; a Para[13].e Para Type := E_Exp Parameter Type. Byte Array; a Para[13].n Para Size := 30; a Para[14].s Para Name:= 'col Var Binary'; a Para[14].e Para Type := E_Exp Parameter Type. Byte Array; a Para[14].n Para Size := 20; // set command s Cmd := 'INSERT INTO My Table Name (col Integer, col Small Int, col Tiny Int, col Bit, col Money, col Float, col Real, col Date Time, col NText, col NChar, col Image, col NVar Char, col Binary, col Var Binary) VALUES ({col Integer}, {col Small Int}, {col Tiny Int}, {col Bit}, {col Money}, {col Float}, {col Real}, {col Date Time}, {col NText}, {col NChar}, {col Image}, {col NVar Char}, {col Binary}, {col Var Binary})'; // call functionblock IF fb PLCDBCmd. Execute( h DBID:= 1, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= ADR(my Struct), cb Data:= SIZEOF(my Struct), p Parameter:= ADR(a Para), cb Parameter:= SIZEOF(a Para)) THEN IF fb PLCDBCmd.b Error THEN tc Message := fb PLCDBCmd.ip Tc Result; n State := 255; 186 Version: 1.13.8 TF6420
## Page 187

PLC API ELSE n State := 0; END_IF END_IF 6.1.1.2.6.2 Execute Data Return This method can be used to send SQL commands to the database. The database connection is opened with each call and then closed again. It is possible to define placeholders in the command, which are replaced by the Twin CAT Database Server with the corresponding values before the execution. A specified number of records can be read. Syntax METHOD Execute Data Return : BOOL VAR_INPUT h DBID: UDINT; p Expression: POINTER TO BYTE; cb Expression: UDINT; p Data: POINTER TO BYTE; cb Data: UDINT; p Parameter: POINTER TO ARRAY[0.. MAX_DBCOLUMNS] OF ST_Exp Parameter; cb Parameter: UDINT; n Start Index: UDINT; n Record Count: UDINT; p Return Data: POINTER TO BYTE; cb Return Data: UDINT; p Records: POINTER TO UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. p Expression POINTER TO BYTE Address of the string variable with the SQL command cb Expression UDINT Length of the string variable with the SQL command p Data POINTER TO BYTE Address of the structure with the parameter values cb Data UDINT Length of the structure with the parameter values p Parameter POINTER TO ARRAY[0.. MAX_ Address of the structure array with the parameter DBCOLUMNS] OF ST_Exp Par information ameter cb Parameter UDINT Length of the structure array with the parameter information n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Return Data POINTER TO BYTE Address of the structure array into which the records are to be written. cb Return Data UDINT Indicates the size of the structure array in bytes. p Records POINTER TO BYTE Number of read records. Return value Name Type Description Execute Data Return BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. TF6420 Version: 1.13.8 187
## Page 188

PLC API Parameterizing the command The column names for the individual parameters are specified in curly brackets in the SQL command. Sample: ‚SELECT * FROM My House_Temperatures WHERE Room = {Selected Room}’. Accordingly, Selected Room has to be specified as parameter name in the structure ST_Exp Parameter. Some databases do not support the parameterization of SQL clauses. (TOP/LIMIT/ROWNUM/...) Parameterizable table names are not usually supported. Sample VAR fb PLCDBCmd : FB_PLCDBCmd Evt(s Net ID := '', t Timeout := T#5S); s Cmd : STRING (1000); st Para : ST_Exp Parameter; Record Amt : ULINT := 3; Return Data Struct : ARRAY [0..9] OF ST_Data All; n Records : UDINT; tc Message : I_Tc Message; END_VAR // set Parameter configuration st Para.e Para Type := E_Exp Parameter Type. Int64; st Para.n Para Size := 8; st Para.s Para Name := 'Record Amt'; // set command with placeholder s Cmd := 'SELECT TOP ({Record Amt}) * FROM My Table Name'; // call functionblock IF fb PLCDBCmd. Execute Data Return( h DBID:= 1, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= ADR(Record Amt), cb Data:= SIZEOF(Record Amt), p Parameter:= ADR(st Para), cb Parameter:= SIZEOF(st Para), n Start Index:= 0, n Record Count:= 10, p Return Data:= ADR(Return Data Struct), cb Return Data:= SIZEOF(Return Data Struct), p Records:= ADR(n Records)) THEN IF fb PLCDBCmd.b Error THEN tc Message := fb PLCDBCmd.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 188 Version: 1.13.8 TF6420
## Page 189

PLC API 6.1.1.3 SQL Expert mode 6.1.1.3.1 FB_Config Tc DBSrv Evt Function block for creating, reading and deleting configuration entries for the Twin CAT Database Server. Syntax Definition: FUNCTION_BLOCK FB_Config Tc DBSrv Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR TF6420 Version: 1.13.8 189
## Page 190

PLC API Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Create [} 190] Local Creates new entries in the XML configuration file for the Twin CAT Database Server Read [} 191] Local Reads the current configuration of the Twin CAT Database Server Delete [} 192] Local Deletes the database and Auto Log groups from the configuration of the Twin CAT Database Server Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.3.1.1 Create This method creates new entries in the XML configuration file for the Twin CAT Database Server. Optionally the Twin CAT Database Server can use a new entry on a temporary basis. In this case no data is written to the XML file. Syntax METHOD Create : BOOL VAR_INPUT p Tc DBSrv Config: POINTER TO BYTE; cb Tc DBSrv Config: UDINT; b Temporary: BOOL := TRUE; p Config ID: POINTER TO UDINT; END_VAR 190 Version: 1.13.8 TF6420
## Page 191

PLC API Inputs Name Type Description p Tc DBSrv Config POINTER TO BYTE Pointer of the configuration structure to be created. cb Tc DBSrv Config UDINT Length of the configuration structure b Temporary BOOL Indicates whether the configuration is to be stored in the XML file. p Config ID POINTER TO UDINT Return pointer of the configuration ID (h DBID or h Auto Log Grp ID) Creating Auto Log groups is currently not supported. Return value Name Type Description Create BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv Evt(s Net Id := '', t Timeout:=T#5S); my Config Handle : UDINT; // Any other Config Type can be used here st Config DB : T_DBConfig_Ms Compact SQL; tc Message : I_Tc Message; END_VAR st Config DB.b Authentification := FALSE; st Config DB.s Server := 'C:\Recipes.sdf'; IF fb Config Tc DBSrv. Create( p Tc DBSrv Config:= ADR(st Config DB), cb Tc DBSrv Config:= SIZEOF(st Config DB), b Temporary:= TRUE, p Config ID:= ADR(my Config Handle)) THEN IF fb Config Tc DBSrv.b Error THEN tc Message := fb Config Tc DBSrv.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.3.1.2 Read This method can be used to read the current configurations of the Twin CAT Database Server. Any temporary configurations that may be included are marked accordingly. Syntax METHOD Read : BOOL VAR_INPUT p DBConfig: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Config DB; cb DBConfig: UDINT; p Auto Log Grp Config: POINTER TO ARRAY[1.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; cb Auto Log Grp Config: UDINT; p DBCount: POINTER TO UDINT; p Auto Log Grp Count: POINTER TO UDINT; END_VAR TF6420 Version: 1.13.8 191
## Page 192

PLC API Inputs Name Type Description p DBConfig POINTER TO ARRAY [1.. MA Pointer address of the array into which the database configurations are to be written. X_CONFIGURATIONS [} 247]] OF ST_Config DB [} 229] cb DBConfig UDINT Length of the database configuration array p Auto Log Grp Config POINTER TO ARRAY[1.. MAX Pointer address of the array into which the Auto Log Grp configurations are to be written. _CONFIGURATIONS [} 247]] OF ST_Config Auto Log Grp [} 228] cb Auto Log Grp Config UDINT Length of the Auto Log Grp configuration array p DBCount POINTER TO UDINT Pointer address for storing the number of database configurations. p Auto Log Grp Count POINTER TO UDINT Pointer address for storing the number of Auto Log Grp configurations. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv Evt(s Net Id := '', t Timeout:=T#5S); a DBConfig : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config DB; a Auto Grp Config : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; n Db Count : UDINT; n Auto Grp Count : UDINT; tc Message : I_Tc Message; END_VAR IF fb Config Tc DBSrv. Read( p DBConfig := ADR(a DBConfig), cb DBConfig := SIZEOF(a DBConfig), p Autolog Grp Config := ADR(a Auto Grp Config), cb Auto Log Grp Config := SIZEOF(a Auto Grp Config), p DBCount := ADR(n Db Count), p Auto Log Grp Count := ADR(n Auto Grp Count)) THEN IF fb Config Tc DBSrv.b Error THEN tc Message := fb Config Tc DBSrv.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.3.1.3 Delete This method can be used to delete databases and Auto Log groups from the configuration of the Twin CAT Database Server. Syntax METHOD Delete : BOOL VAR_INPUT e Tc DBSrv Config Type: E_Tc DBSrv Config Type; h Config ID: UDINT; END_VAR 192 Version: 1.13.8 TF6420
## Page 193

PLC API Inputs Name Type Description e Tc DBSrv Config Type E_Tc DBSrv Config Type Type of the configuration to be deleted (database / Auto Log group) h Config ID UDINT ID of the configuration to be deleted (h DBID or h Auto Log Grp ID) Return value Name Type Description Delete BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv Evt(s Net Id := '', t Timeout:=T#5S); my Config Handle : UDINT; tc Message : I_Tc Message; END_VAR IF fb Config Tc DBSrv. Delete( e Tc DBSrv Config Type := E_Tc DBSrv Config Type. Database, h Config ID := my Config Handle) THEN IF fb Config Tc DBSrv.b Error THEN tc Message := fb Config Tc DBSrv.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.1.3.2 FB_SQLDatabase Evt Function block for opening, closing and managing a database connection. Syntax Definition: FUNCTION BLOCK FB_SQLDatabase Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. TF6420 Version: 1.13.8 193
## Page 194

PLC API Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Connect [} 194] Local Opens a connection to a declared database. Create Cmd [} 195] Local Initializes an instance of the function block FB_SQLCommand Evt [} 197] with the already open database connection of the function block FB_SQLDatabase Evt. Create SP [} 196] Local Initializes an instance of the function block FB_SQLStored Procedure Evt [} 202] with the already open database connection of the function block FB_SQLDatabase Evt. Disconnect [} 196] Local Closes the connection to the database that was opened by this function block instance. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.3.2.1 Connect This method opens a connection to a declared database. Syntax METHOD Connect : BOOL VAR_INPUT h DBID: UDINT := 1; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. 194 Version: 1.13.8 TF6420
## Page 195

PLC API Return value Name Type Description Connect BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Sql Database : FB_SQLDatabase Evt(s Net ID := '', t Timeout := T#5S); END_VAR // open connection IF fb Sql Database. Connect(1) THEN IF fb Sql Database.b Error THEN n State := 255; ELSE n State := n State+1; END_IF END_IF 6.1.1.3.2.2 Create Cmd This method is used to initialize an instance of the function block FB_SQLCommand with the already open database connection of the function block FB_SQLDatabase. The function block FB_SQLCommand only uses the database connection it was assigned via the Create Cmd method. Several instances of the function block FB_SQLCommand can be initialized with the same database connection. The initialization of the function block FB_SQLCommand is completed in the same cycle. This means that neither the Busy flag of the function block nor the method return value of the Create Cmd method have to be checked. Syntax METHOD Create Cmd : BOOL VAR_INPUT p SQLCommand: POINTER TO FB_SQLCommand Evt; END_VAR Inputs Name Type Description p SQLCommand POINTER TO FB_SQLCommand Returns a new instance of the function block FB_SQLCommand Evt. Return value Name Type Description Create Cmd BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Sql Database : FB_SQLDatabase Evt(s Net ID := '', t Timeout := T#5S); END_VAR // create a command reference IF fb Sql Database. Create Cmd(ADR(fb Sql Command)) THEN IF fb Sql Database.b Error THEN n State := 255; ELSE n State := n State+1; END_IF END_IF FB_SQLCommand Evt [} 197] can then be used for the execution. TF6420 Version: 1.13.8 195
## Page 196

PLC API 6.1.1.3.2.3 Create SP This method is used to initialize an instance of the function block FB_SQLStored Procedure Evt with the already open database connection of the function block FB_SQLDatabase Evt. The function block FB_SQLStored Procedure Evt only uses the database connection it was assigned via the Create Cmd method. Several instances of the function block FB_SQLStored Procedure Evt can be initialized with the same database connection. The initialization of the function block FB_SQLStored Procedure Evt may take several cycles. The Busy flag of the function block or the method return value of the Create Cmd method have to be checked before the function block can be used. Syntax METHOD Create SP : BOOL VAR_INPUT s Procedure Name: T_Max String; p Parameter Info: POINTER TO ARRAY [0.. MAX_SPPARAMETER] OF ST_SQLSPParameter; cb Parameter Info: UDINT; p SQLProcedure: POINTER TO FB_SQLStored Procedure Evt; END_VAR Inputs Name Type Description s Procedure Name T_Max String Indicates the name of the procedure to be executed. p Parameter Info POINTER TO ARRAY [0.. MAX_SPPAR Pointer address for the parameter info list. AMETER] OF ST_SQLSPParameter cb Parameter Info UDINT Indicates the length of the parameter info list. p SQLProcedure POINTER TO FB_SQLStored Procedure Returns a new instance of the function block Evt FB_SQLStored Procedure Evt. Return value Name Type Description Create SP BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Sql Database : FB_SQLDatabase Evt(s Net ID := '', t Timeout := T#5S); Para Info : ST_SQLSPParameter; END_VAR Para Info.s Parameter Name := '@Customer_ID'; Para Info.e Parameter Type := E_SPParameter Type. Input; Para Info.e Parameter Data Type := E_Column Type. Big Int; Para Info.n Parameter Size := 8; IF fb SQLDatabase. Create SP('dbo. SP_Get Customer Positions', ADR(Para Info), SIZEOF(Para Info), ADR(fb SQLS tored Procedure)) THEN IF fb SQLDatabase.b Error THEN n State:=255; ELSE n State:= n State+1; END_IF END_IF Subsequently, the FB_SQLStored Procedure Evt [} 202] can be used to execute the stored procedure. 6.1.1.3.2.4 Disconnect This method closes the connection to the database that was opened by this function block instance. 196 Version: 1.13.8 TF6420
## Page 197

PLC API Syntax METHOD Disconnect : BOOL Return value Name Type Description Disconnect BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Sql Database : FB_SQLDatabase Evt(s Net ID := '', t Timeout := T#5S); END_VAR // disconnect from database IF fb Sql Database. Disconnect() THEN IF fb Sql Database.b Error THEN n State := 255; ELSE n State := n State+1; END_IF END_IF 6.1.1.3.3 FB_SQLCommand Evt Function block for executing SQL commands. Before it can be used it has to be initialized with the function block FB_SQLDatabase Evt. Syntax Definition: FUNCTION BLOCK FB_SQLCommand Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. TF6420 Version: 1.13.8 197
## Page 198

PLC API Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Execute [} 198] Local Sends the specified SQL command to the database via the database connection already opened by the function block FB_SQLDatabase Evt [} 193]. Execute Data Return Local Sends the specified SQL command to the database via the database connection already opened by the function block [} 199] FB_SQLDatabase Evt [} 193]. An instance of the function block FB_SQLResult Evt [} 200] can be transferred for reading the returned records. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.3.3.1 Execute This method sends the specified SQL command to the database via the database connection already opened by the function block FB_SQLDatabase. Syntax METHOD Execute : BOOL VAR_INPUT p SQLCmd: POINTER TO BYTE; cb SQLCmd: UDINT; END_VAR Inputs Name Type Description p SQLCmd POINTER TO BYTE Indicates the pointer address of a string variable with the SQL command to be executed. cb SQLCmd UDINT Indicates the length of a SQL command to be executed. 198 Version: 1.13.8 TF6420
## Page 199

PLC API Return value Name Type Description Execute POINTER TO BYTE Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample Uses the command created by FB_SQLDatabase Evt. Create Cmd() [} 193]. VAR fb Sql Command : FB_SQLCommand Evt(s Net ID := '', t Timeout := T#5S); tc Message : I_Tc Message; END_VAR // you can generate this with the SQL Query Editor s Cmd := 'INSERT INTO my Table_Double ( Timestamp, Name, Value) VALUES ( $'2018-01-31 14:59:27$', $'Te mperature$', 21.3)'; // call sql command IF fb SQLCommand. Execute(ADR(s Cmd), SIZEOF(s Cmd)) THEN IF fb SQLCommand.b Error THEN tc Message := fb SQLCommand.ip Tc Result; n State := 255; ELSE n State := n State+1; END_IF END_IF 6.1.1.3.3.2 Execute Data Return This method sends the specified SQL command to the database via the database connection already opened by the function block FB_SQLDatabase. An instance of the function block FB_SQLResult can be transferred for reading the returned records. Syntax METHOD Execute Data Return : BOOL VAR_INPUT p SQLCmd: POINTER TO BYTE; cb SQLCmd: UDINT; p SQLDBResult: POINTER TO FB_SQLResult; END_VAR Inputs Name Type Description p SQLCmd POINTER TO BYTE Indicates the pointer address of a string variable with the SQL command to be executed. cb SQLCmd UDINT Indicates the length of a SQL command to be executed. p SQLDBResult POINTER TO FB_SQLResult Returns a new instance of the function block FB_SQLResult. [} 200] Return value Name Type Description Execute Data Return POINTER TO BYTE Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample Uses the command created by FB_SQLDatabase Evt. Create Cmd() [} 193]. TF6420 Version: 1.13.8 199
## Page 200

PLC API VAR fb Sql Command : FB_SQLCommand Evt(s Net ID := '', t Timeout := T#5S); tc Message : I_Tc Message; END_VAR // you can generate this with the SQL Query Editor s Cmd := 'SELECT ID, Timestamp, Name, Value FROM my Table_Double'; // call sql command IF fb SQLCommand. Execute Data Return(ADR(s Cmd), SIZEOF(s Cmd), ADR(fb Sql Result)) THEN IF fb SQLCommand.b Error THEN n State := 255; ELSE tc Message := fb SQLCommand.ip Tc Result; n State := n State+1; END_IF END_IF FB_SQLResult Evt [} 200] can then be used to read the data. 6.1.1.3.4 FB_SQLResult Evt The function block is used for reading the cached records. Syntax Definition: FUNCTION BLOCK FB_SQLResult Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. 200 Version: 1.13.8 TF6420
## Page 201

PLC API Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Read [} 201] Local Reads a specified number of records from the result data cached in the Twin CAT Database Server. Release [} 202] Local Releases data buffered by the Twin CAT Database Server. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.3.4.1 Read This method reads a specified number of records from the result data cached in the Twin CAT Database Server. Syntax METHOD Read : BOOL VAR_INPUT n Start Index: UDINT := 0; n Record Count: UDINT := 1; p Data: POINTER TO BYTE; cb Data: UDINT; b With Verifying: BOOL := FALSE; b Data Release: BOOL := TRUE; END_VAR Inputs Name Type Description n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Data POINTER TO BYTE Address of the structure array into which the records are to be written. cb Data UDINT Indicates the size of the structure array in bytes. b With Verifying BOOL Return data are compared with the p Data structure array and adjusted if necessary. b Data Release BOOL Releases the cached data. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. TF6420 Version: 1.13.8 201
## Page 202

PLC API Sample VAR fb Sql Result : FB_SQLResult Evt(s Net ID:='', t Timeout := T#5S); a Read Struct : ARRAY[1..5] OF ST_Standard Record; END_VAR // get values from internal tc db srv storage IF fb Sql Result. Read(2, 3, ADR(a Read Struct), SIZEOF(a Read Struct), FALSE, TRUE) THEN IF fb Sql Result.b Error THEN n State := 255; ELSE n State := n State+1; END_IF END_IF Result in the PLC: 6.1.1.3.4.2 Release This method can be used to release data cached by the Twin CAT Database Server. Syntax METHOD Release : BOOL Return value Name Type Description Release BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. 6.1.1.3.5 FB_SQLStored Procedure Evt Function block for executing stored procedures of the database. Before it can be used it has to be initialized with the function block FB_SQLDatabase Evt. Syntax Definition: FUNCTION BLOCK FB_SQLStored Procedure Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; 202 Version: 1.13.8 TF6420
## Page 203

PLC API END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Methods Name Definition loca- Description tion Execute [} 203] Local Sends the call of the specified stored procedure to the database via the database connection already opened by the function block FB_SQLDatabase Evt [} 193]. Execute Data Return Local Sends the call of the specified stored procedure to the database via the database connection already opened by the [} 204] function block FB_SQLDatabase Evt [} 193]. An instance of the function block FB_SQLResult Evt [} 200] can be transferred for reading the returned records. Release [} 205] Local Releases the parameter information of the stored procedure that was transferred during initialization. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.3.5.1 Execute This method sends the call of the specified stored procedure to the database via the database connection already opened by the function block FB_SQLDatabase Evt. TF6420 Version: 1.13.8 203
## Page 204

PLC API Syntax METHOD Execute : BOOL VAR_INPUT p Parameter Strc: POINTER TO BYTE; cb Parameter Strc: UDINT; END_VAR Inputs Name Type Description p Parameter Strc POINTER TO BYTE Pointer address to the parameter structure that is transferred to the procedure. cb Parameter Strc UDINT Length of the parameter structure. Return value Name Type Description Execute BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample Uses the stored procedure previously created with FB_SQLDatabase Evt. Create SP() [} 193]. VAR fb SQLStored Procedure : FB_SQLStored Procedure Evt(s Net ID:='', t Timeout := T#5S); Customer_ID : LINT; tc Message : I_Tc Message; END_VAR IF fb SQLStored Procedure. Execute(p Parameter Strc := ADR(Customer_ID) , cb Parameter Strc:= SIZEOF(Custom er_ID)) THEN IF fb SQLStored Procedure.b Error THEN tc Message := fb SQLStored Procedure.ip Tc Result; n State := 255; ELSE n State := n State+1; END_IF END_IF 6.1.1.3.5.2 Execute Data Return This method sends the call of the specified stored procedure to the database via the database connection already opened by the function block FB_SQLDatabase. An instance of the FB_SQLResult function block can be transferred for reading the returned records. Syntax METHOD Execute Data Return : BOOL VAR_INPUT p Parameter Strc: POINTER TO BYTE; cb Parameter Strc: UDINT; p SQLDBResult: POINTER TO FB_SQLDBResult Evt; END_VAR Inputs Name Type Description p Parameter Strc POINTER TO BYTE Pointer address to the parameter structure that is transferred to the procedure. cb Parameter Strc UDINT Length of the parameter structure p SQLDBResult POINTER TO FB_SQL Returns a new instance of the function block DBResult Evt FB_SQLDBResult Evt. 204 Version: 1.13.8 TF6420
## Page 205

PLC API Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample Uses the stored procedure previously created with FB_SQLDatabase Evt. Create SP() [} 193]. VAR fb SQLStored Procedure : FB_SQLStored Procedure Evt(s Net ID:='', t Timeout := T#5S); Customer_ID : LINT; tc Message : I_Tc Message; END_VAR IF fb SQLStored Procedure. Execute Data Return(p Parameter Strc := ADR(Customer_ID), cb Parameter Strc:= SIZE OF(Customer_ID), p SQLDBResult := ADR(fb Sql Result)) THEN IF fb SQLStored Procedure.b Error THEN tc Message := fb SQLStored Procedure.ip Tc Result; n State := 255; ELSE n State := n State+1; END_IF END_IF FB_SQLResult Evt [} 200] can then be used to read the data. 6.1.1.3.5.3 Release This method releases the parameter information of the stored procedure, which was transferred during initialization. Syntax METHOD Release : BOOL Return value Name Type Description Release BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. TF6420 Version: 1.13.8 205
## Page 206

PLC API 6.1.1.4 No SQL Expert Mode 6.1.1.4.1 Query Builder In order to support as many No SQL databases as possible, there are query function blocks that offer different parameterizations for queries. These function blocks are then passed as an interface to the methods of the FB_No SQLQuery. 6.1.1.4.1.1 FB_No SQLQuery Builder_Document DB Function block for defining a query for the database. The query is sent with FB_No SQLQuery Evt [} 209]. It is not necessary to call the Build method. Syntax Definition: 206 Version: 1.13.8 TF6420
## Page 207

PLC API FUNCTION BLOCK FB_No SQLQuery Builder_Document DB VAR_INPUT e Query Type : E_Document Db Query Type; s Collection Name : T_MAXSTRING; p Query Options: POINTER TO BYTE; cb Query Options : UDINT; END_VAR VAR_OUTPUT END_VAR Inputs Name Type Description e Query Type E_Document Db Type of query sent to the database. Query Type [} 234] s Collection Na T_ Name of the collection that is the target of the query. me MAXSTRING p Query Option POINTER TO Specifies the address for the query options [} 235]. s BYTE cb Query Optio UDINT Length of the query options. nsr Methods Name Definition loca- Description tion Build [} 207] Local [optional] This method generates a query for the function block FB_No SQLQuery Evt [} 209] from the set parameters. Sample: VAR fb No SQLQuery Builder_Document DB: FB_No SQLQuery Builder_Document DB; s Filter : T_MAXSTRING; st Options : T_Query Option Document DB_Find; END_VAR // Set your settings before you run the query st Options.p Filter:= ADR(s Filter); st Options.cb Filter:= SIZEOF(s Filter); fb No SQLQuery Builder_Document DB.e Query Type:=E_Document Db Query Type. Find; fb No SQLQuery Builder_Document DB.s Collection Name:= 'My Collection Name'; fb No SQLQuery Builder_Document DB.p Query Options:= ADR(st Options); fb No SQLQuery Builder_Document DB.cb Query Options:= SIZEOF(st Options); Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.4.1.1.1 Build This method is called automatically in case of a FB_No SQLQuery [} 209]Evt (either with Execute or Execute Data Return) before the query is sent. It creates a Twin CAT 3 Database Server-specific query from the specified parameters of the Query Builder. TF6420 Version: 1.13.8 207
## Page 208

PLC API 6.1.1.4.1.2 FB_No SQLQuery Builder_Time Series DB Function block for defining a query for a Time Series database. The query is sent with FB_No SQLQuery Evt [} 209]. It is not necessary to call the Build method. Data structures [} 358] can be described with attributes to affect individual settings. Inputs Name Type Description p Query Option POINTER TO Specifies the address for the query options [} 237]. s BYTE cb Query Optio UDINT Length of the query options. ns Syntax Definition: FUNCTION BLOCK FB_No SQLQuery Builder_Time Series DB VAR_INPUT p Query Options : POINTER TO BYTE; cb Query Options : UDINT; END_VAR VAR_OUTPUT END_VAR Methods Name Definition loca- Description tion Build [} 207] Local [optional] This method generates a query for the function block FB_No SQLQuery Evt [} 209] from the set parameters. Example: VAR fb No SQLQuery Builder_Time Series DB : FB_No SQLQuery Builder_Time Series DB; Query Option_TSDB_Insert : T_Query Option Time Series DB_Insert; fb No Sql Query Evt : FB_No SQLQuery Evt(s Net ID := '', t Timeout := T#15S); My Struct Array: ARRAY[1..1000] OF My Struct; END_VAR CASE n State OF 1: // init fb No SQLQuery Builder_Time Series DB.p Query Options := ADR(Query Option_TSDB_Insert); fb No SQLQuery Builder_Time Series DB.cb Query Options := SIZEOF(Query Option_TSDB_Insert); Query Option_TSDB_Insert.s Table Name := 'Measurement Name'; Query Option_TSDB_Insert.s Data Type := 'My Struct'; Query Option_TSDB_Insert.p Symbol := ADR(My Struct Array); Query Option_TSDB_Insert.cb Symbol := SIZEOF(My Struct Array); Query Option_TSDB_Insert.n Data Count := 1000; // Array Length Query Option_TSDB_Insert.n Start Timestamp := F_Get System Time(); // get current twincat time Query Option_TSDB_Insert.n Cycle Time := 1000; // equivalent to 1 ms 2: // write values IF fb No Sql Query Evt. Execute(dbid, fb No SQLQuery Builder_Time Series DB) THEN IF fb No Sql Query Evt.b Error THEN // do some error handling here ELSE // success END_IF END_IF END_CASE 208 Version: 1.13.8 TF6420
## Page 209

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.4.1.2.1 Build This method is called automatically in case of a FB_No SQLQuery [} 209]Evt (either with Execute or Execute Data Return) before the query is sent. It creates a Twin CAT 3 Database Server-specific query from the specified parameters of the Query Builder. 6.1.1.4.2 FB_No SQLQuery Evt Function block for executing No SQL database queries. A Query Builder function block that describes the query is used as the input parameter for the methods. Syntax Definition: FUNCTION BLOCK FB_No SQLQuery Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. TF6420 Version: 1.13.8 209
## Page 210

PLC API Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Methods Name Definition loca- Description tion Execute [} 210] Local Sends the query created by the Query Builder function block to the database. Execute Data Return Local Sends the query created by the Query Builder function block to the database. [} 211] An instance of the FB_No Sql Result Evt [} 212] function block can be transferred for reading the returned records. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.4.2.1 Execute This method sends a query to the No SQL database, which was previously set with the I_No SQLQuery Builder [} 206] function block. Syntax METHOD Execute : BOOL VAR_INPUT h DBID: UDINT; i No SQLQuery Builder: I_No SQLQuery Builder; END_VAR Inputs Name Type Description h DBID UDINT ID of the set database configuration i No SSQLQuery I_No SQLQuery Builde Pre-parameterized Query Builder function block. This varies Builder r depending on the database. Return value Name Type Description Execute BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Uses the Query Builder to execute the corresponding query. VAR fb No SQLQuery : FB_No SQLQuery Evt(s Net ID := '', t Timeout := T#5S); fb No SQLQuery Builder_Document DB: FB_No SQLQuery Builder_Document DB; Insert Query Options: T_Query Option Document DB_Insert; my DBID : UDINT := 1; 210 Version: 1.13.8 TF6420
## Page 211

PLC API s Document : STRING(1000); Tc Message : I_Tc Message; END_VAR // set Query Inputs fb No SQLQuery Builder_Document DB.e Query Type := E_Document Db Query Type. Insert One; fb No SQLQuery Builder_Document DB.p Query Options := ADR(Insert Query Options); fb No SQLQuery Builder_Document DB.cb Query Options := SIZEOF(Insert Query Options); // set insert parameter: s Document := '{Name : "My Value", Value : 123.456}'; Insert Query Options.p Documents:= ADR(s Document); Insert Query Options.cb Documents:= SIZEOF(s Document); // call nosql command IF fb No SQLQuery. Execute(my DBID, fb No SQLQuery Builder_Document DB) THEN IF fb No SQLQuery .b Error THEN Tc Message := fb No SQLQuery.ip Tc Result n State := 255; ELSE n State := n State+1; END_IF END_IF First, the FB_No SQLQuery Evt function block is parameterized via the FB_No SQLQuery Builder_Document DB [} 206] function block. Depending on the query type there are various options, such as T_Query Option Document DB_Insert [} 236], for setting the document to be inserted. 6.1.1.4.2.2 Execute Data Return This method executes a query to a No SQL database that was previously set using the I_No SQLQuery Builder function block. The transferred instance of type FB_No SQLResult Evt is filled with return values. Syntax METHOD Execute Data Return : BOOL VAR_INPUT h DBID : UDINT; i No SSQLQuery Builder: I_No SQLQuery Builder; p No SQLResult: POINTER TO FB_No SQLResult Evt; END_VAR Inputs Name Type Description h DBID UDINT ID of the set database configuration i No SQLQuery Buil I_No SQLQuery Builder Preconfigured Query Builder function block that defines der the query to be sent. p No SQLResult POINTER TO Specifies the address for the FB_No SQLResult Evt FB_No SSQLResult Evt function block, which can be used to read the results. Return value Name Type Description Execute Data Return BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. n Data Count UDINT [optional] Number of records returned Uses the Query Builder to execute the corresponding query. VAR fb No Sql Query : FB_No SQLQuery Evt(s Net ID := '', t Timeout := T#5S); fb No SQLQuery Builder_Document DB: FB_No SQLQuery Builder_Document DB Find Query Options : T_Query Option Document DB_Find; fb No Sql Result : FB_No SQLResult Evt(s Net ID := '', t Timeout := T#5S); my DBID : UDINT := 1; TF6420 Version: 1.13.8 211
## Page 212

PLC API s Filter : STRING(255); s Sort: STRING(255); s Projection: STRING(255); Tc Message : I_Tc Message; END_VAR // set Query Inputs: fb No SQLQuery Builder_Document DB.e Query Type := E_Document Db Query Type. Find; fb No SQLQuery Builder_Document DB.p Query Options := ADR(Find Query Options); fb No SQLQuery Builder_Document DB.cb Query Options := SIZEOF(Find Query Options); //set Find Parameter ([optional] sort, projection): s Filter := '{}'; // read all data from database Find Query Options.p Filter:= ADR(s Filter); Find Query Options.cb Filter:= SIZEOF(s Filter); // call nosql query: IF fb No Sql Query. Execute Data Return(my DBID, fb No Sql Query, ADR(fb No Sql Result)) THEN IF fb No Sql Query.b Error THEN Tc Message := fb No Sql Query.ip Tc Result; n State := 255; ELSE n State := n State+1; END_IF END_IF First, the FB_No SQLQuery Evt function block is parameterized via the FB_No SQLQuery Builder_Document DB [} 206] function block. Depending on the query type there are various options, such as T_Query Option Document DB_Find [} 235], for defining the filter, sorting or projection. 6.1.1.4.3 FB_No SQLResult Evt Function block for reading buffered records. The records must first be retrieved from the database using the function block FB_No SQLQuery Evt [} 209] when the Execute Data Return [} 211] method is called. The function block FB_No SQLResult Evt is specified for initialization. They can then be read out either as a PLC structure or as a string. Syntax Definition: FUNCTION BLOCK FB_SQLResult Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Message; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. 212 Version: 1.13.8 TF6420
## Page 213

PLC API Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Description e Trace Level Tc Event Severity Specifies the weighting of the events. Only events with a weighting higher than this value are sent to the Twin CAT system. [} 226] n Data Count UDINT Indicates the number of returned records available from the call of the function block FB_No SQLQuery Evt. Execute Data Return() [} 211]. Methods Name Definition loca- Description tion Read As String [} 213] Local Reads a specified number of records from the result data cached in the Twin CAT Database Server as JSON string. Read As Struct [} 214] Local Reads a specified number of records from the result data cached in the Twin CAT Database Server into the specified structure. Release [} 215] Local Releases data buffered by the Twin CAT Database Server. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.4.3.1 Read As String This method reads a specified number of records from the result data cached in the Twin CAT Database Server. An array of strings is specified into which this data is to be copied as JSON. Syntax METHOD Read As String : BOOL VAR_INPUT n Start Index: UDINT := 0; n Record Count: UDINT := 1; p Data: POINTER TO BYTE; cb Data: UDINT; n Max Document Size : UDINT; b Data Release: BOOL := TRUE; END_VAR TF6420 Version: 1.13.8 213
## Page 214

PLC API Inputs Name Type Description n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Data POINTER TO BYTE Indicates the address of the string array into which the records are to be written. cb Data UDINT Indicates the size of the string array in bytes. n Max Document Si UDINT Indicates the maximum size of a single JSON document from ze p Data. b Data Release BOOL Releases the cached data. Return value Name Type Description Read As String BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample: VAR fb No Sql Result : FB_No SQLResult Evt(s Net ID := '', t Timeout := T#5S); a Read_Json : ARRAY[0..2] OF STRING(1000); Tc Message : I_Tc Message; END_VAR IF fb No Sql Result. Read As String( n Start Index:= 0, n Record Count:= 3, p Data:= ADR(a Read_Json), cb Data:= SIZEOF(a Read_Json), Max Document Size:= SIZEOF(a Read_Json[0]), b Data Release:= TRUE) THEN IF fb No Sql Result.b Error THEN Tc Message := fb No Sql Result.ip Tc Result; nstate := 255; ELSE nstate := nstate+1; END_IF END_IF 6.1.1.4.3.2 Read As Struct This method reads a specified number of records from the buffered result data. A structure or an array of a structure is specified in which the data is to be written. The data type schema of this structure should correspond as closely as possible to that of the read data. The variable names are compared with those of the record. A validation makes it possible to detect deviations and respond to them. If there is a requirement to use different names in the database and in the PLC, the names can be described in the structure with the attribute 'Element Name' with the assigned name from the database. Syntax METHOD Read As Struct: BOOL VAR_INPUT n Start Index: UDINT := 0; n Record Count: UDINT := 1; p Data: POINTER TO BYTE; cb Data: UDINT; b Validate: BOOL := FALSE; p No SQLValidation : POINTER TO FB_No SQLValidation Evt; b Data Release: BOOL := TRUE; END_VAR 214 Version: 1.13.8 TF6420
## Page 215

PLC API Inputs Name Type Description n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Data POINTER TO BYTE Address of the structure array into which the records are to be written. cb Data UDINT Indicates the size of the structure array in bytes. b Validate BOOL Return data are compared with the p Data structure array and adjusted if necessary. p No SQLValidatio POINTER TO Address of the function block FB_No SQLValidation Evt that n FB_No SQLValidation E provides further information for validating the call. vt b Data Release BOOL Releases the cached data. Return value Name Type Description Read As Struct BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample: VAR fb No SQLResult: FB_No SQLResult Evt(s Net ID := '', t Timeout := T#5S); a Read : ARRAY[0..2] OF ST_My Data Struct; fb No SQLValidation : FB_No SQLValidation Evt(s Net ID := '', t Timeout := #5S); END_VAR IF fb No SQLResult. Read As Struct( n Start Index:= 0, n Record Count:= 3, p Data:= ADR(a Read), cb Data:= SIZEOF(a Read), b Validate:= TRUE, p No SQLValidation:= ADR(fb No SQLValidation), b Data Release:= TRUE) THEN IF fb No SQLResult.b Error THEN Tc Message := fb No SQLResult.ip Tc Result; nstate := 255; ELSE nstate := nstate+1; END_IF END_IF 6.1.1.4.3.3 Release This method can be used to release data cached by the Twin CAT Database Server. Syntax METHOD Release : BOOL Return value Name Type Description Release BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. TF6420 Version: 1.13.8 215
## Page 216

PLC API 6.1.1.4.4 FB_No SQLValidation Evt Function block for reading the validation events and results that occurred when reading the data with FB_No SQLResult Evt [} 212]. This function block is initialized via the Create Validation method of the No SQLResult. It refers to the last call of the Read As Struct [} 214] method. Syntax Definition: FUNCTION BLOCK FB_No SQLValidation Evt VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Tc3_Event Logger. I_Tc Message [} 225] Message interface from the Twin CAT 3 Event Logger, which provides details on the return value. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. 216 Version: 1.13.8 TF6420
## Page 217

PLC API Methods Name Definition loca- Description tion Get Issues [} 217] Local Reads a list of validation events as a string array. Get Remaining Data Local Reads the data as a string which could not be assigned to any element in the structure in the PLC. [} 218] Release [} 218] Local Releases the buffered data in the Twin CAT Database Server. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.4.4.1 Get Issues Reads the validation events that occurred into an array of type T_MAXSTRING. These contain information about remaining or unassigned records or which elements of the PLC structure were not filled. Syntax METHOD Get Issues : BOOL VAR_INPUT p Data : POINTER TO BYTE; cb Data: UDINT; b Data Release : BOOL; END_VAR Inputs Name Type Description p Data POINTER TO BYTE Address of the array of type T_MAXSTRING in which the records are to be written. cb Data UDINT Indicates the size of the string array in bytes. b Data Release BOOL Releases the cached data. Return value Name Type Description Read As String BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample: VAR fb No Sql Validation : FB_No SQLValidation(s Net ID := '', t Timeout := t#15S); a Issues : ARRAY[0..1000] OF T_MAXSTRING; END_VAR IF fb No Sql Validation. Get Issues( p Data:= ADR(a Issues), cb Data:= SIZEOF(a Issues), b Data Release:= TRUE) THEN IF fb No Sql Validation.b Error THEN Tc Message := fb No Sql Validation.ip Tc Result; nstate := 255; ELSE nstate := nstate+1; END_IF END_IF TF6420 Version: 1.13.8 217
## Page 218

PLC API 6.1.1.4.4.2 Get Remaining Data This method can be used to read the remaining data in JSON format after the validation. This includes records which could not be assigned to the PLC structure, for example. Syntax METHOD Get Remaining Data : BOOL VAR_INPUT p Data : POINTER TO BYTE; cb Data : UDINT; cb Document : UDINT; b Data Release : BOOL; END_VAR Inputs Name Type Description p Data POINTER TO BYTE Indicates the address of the string array into which the records are to be written. cb Data UDINT Indicates the size of the string array in bytes. cb Document UDINT Indicates the string length of the string in the array. b Data Release BOOL Releases the cached data. Return value Name Type Description Get Remaining Dat BOOL Displays the status of the method. Returns TRUE as soon as the a method execution is finished, even in the event of an error. Sample: VAR CONSTANT c Document Size : UDINT := 1000; END_VAR VAR fb No Sql Validation : FB_No SQLValidation(s Net ID := '', t Timeout := t#15S); a Remaining Data : ARRAY[0..1000] OF STRING(c Document Size); END_VAR IF fb No Sql Validation. Get Remaining Data( p Data:= ADR(a Remaining Data), cb Data:= SIZEOF(a Remaining Data), cb Document:= c Document Size, b Data Release:= TRUE) THEN IF fb No Sql Validation.b Error THEN Tc Message := fb No Sql Validation.ip Tc Result; nstate := 255; ELSE nstate := nstate+1; END_IF END_IF 6.1.1.4.4.3 Release Releases the validation results in the memory. Syntax METHOD Release : BOOL 218 Version: 1.13.8 TF6420
## Page 219

PLC API Return value Name Type Description Release BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. 6.1.1.4.5 Helper These function blocks offer useful functions for dealing with data types, for example. 6.1.1.4.5.1 FB_No SQLObject Id_Mongo DB The function block for parsing the Object Id from the Mongo DB. In the PLC it is described by the data type T_Object Id_Mongo DB [} 234]. Syntax FUNCTION_BLOCK FB_No SQLObject Id_Mongo DB VAR_INPUT Object Id : T_Object Id_Mongo DB; END_VAR Inputs Name Type Description Object Id T_Object Id_Mongo 12-byte data type for describing the Object Id. DB Properties Name Type Description e Trace Level Tc Event Severity Specifies the weighting of the events. Only events with a weighting higher than this value are sent to the Twin CAT system. n Id UDINT Non-unique, sequential number n Machine Id UDINT Identification of the machine n Process Id UINT Identification of the writing process t Timestamp DATE_AND_TIME Time stamp of the record Methods Name Definition loca- Return value Description tion To String Local STRING(36) Returns the ID as a string with type designation. Example: ‚Object Id(„5be15c11afa6ec72b107dafaf“)‘ Value Of Local STRING(24) Returns only the ID as a string. Example: ‚5be15c11afa6ec72b107dafaf‘ TF6420 Version: 1.13.8 219
## Page 220

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.1.5 Support of the Tc3_Eventlogger The Twin CAT 3 Database Server supports the Twin CAT 3 Event Logger (Twin CAT 3 Version 4022.20). This makes it possible to read out details of function block events via an interface. Further information on the Event Logger can be found in the Twin CAT 3 basic libraries. All function blocks of the Twin CAT 3 Database Server support the interface of the Tc3 Event Logger. The interface Tc3_Eventlogger. I_Tc Message [} 225] is used as the return value of the function blocks. In addition to the return value, the e Trace Level property is available to determine the event weighting. Properties Name Type Access Description e Trace Le Tc Event Sev Get, Set Specifies the weighting of the events. vel Only events with a weighting higher than erity this value are sent to the Twin CAT [} 226] system. Sample: As an example, the following weighting is specified for the function block FB_PLCDBWrite: fb PLCDBWrite Evt.e Trace Level := Tc Event Severity. Warning; All events that represent at least a warning are now sent here. Events of the "Information" weighting are ignored in this case. The Tc3_Database function blocks themselves have the output ip Tc Result of data type Tc3_Eventlogger. I_Tc Message. All functions of this interface that are offered can be used. In this sample, the function block is called first. 1: // Call Functionblock IF fb PLCDBWrite Evt. Write Struct( h DBID:= 1, s Table Name:= 'my Table_Struct', p Record:= ADR(my Record), cb Record:= SIZEOF(my Record), p Column Names:= ADR(Column Names) , cb Column Names:= SIZEOF(Column Names)) THEN IF fb PLCDBWrite Evt.b Error THEN my Tc Message := fb PLCDBWrite Evt.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF If an error occurs, we now want to request the event text in the runtime environment. The Request Event Text method can be used for this purpose. Use n Lang Id =1031 to read the error code in German. This is one of the many functions of the Tc3_Eventlogger. I_Tc Message [} 225] interface. 255://Request Event Text IF my Tc Message. Request Event Text(1031, ADR(My Event String), SIZEOF(My Event String))THEN n State := 0; END_IF 220 Version: 1.13.8 TF6420
## Page 221

PLC API 6.1.1.5.1 I_Tc Event Base Methods and properties of an event are defined in this basic interface. Methods Name Description Equals To [} 221] Compares the event with another instance. Equals To Event Class [} 222] Compares the event class of the event with another event class. Equals To Event Entry Ex Compares the event definition of the event with another event definition. [} 223] Get Json Attribute [} 223] Returns the Json attribute. Request Event Class Name Requests the name of the event class. [} 224] Request Event Text [} 225] Returns the text for the event. Properties Name Type Access Description e Severity Tc Event Severity Get Returns the severity. [} 226] Event Class GUID Get Returns the GUID of the event class. ip Source Info I_Tc Source Info Get Returns a pointer to the source definition. n Event Id UDINT Get Returns the ID of the event. st Event Entry Tc Event Entry Get Returns the event definition. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.20 PC or CX (x64, x86, Arm®) Tc3_Event Logger 6.1.1.5.1.1 Equals To This method carries out a comparison with another event specified at the input. Syntax METHOD Equals To : BOOL VAR_INPUT ip Other : I_Tc Event Base; END_VAR Inputs Name Type Description ip Other I_Tc Event Base Event to be compared TF6420 Version: 1.13.8 221
## Page 222

PLC API Return value Name Type Description Equals To BOOL Returns TRUE if the events match. 6.1.1.5.1.2 Equals To Event Class This method carries out a comparison with another event class specified at the input. Syntax METHOD Equals To Event Class : BOOL VAR_INPUT Other Event Class : GUID; END_VAR Inputs Name Type Description Other Event Class GUID Event class to be compared. Return value Name Type Description Equals To Event Class BOOL Returns TRUE if the event classes match. 6.1.1.5.1.3 Equals To Event Entry This method carries out a comparison with another event specified at the input. Syntax METHOD Equals To Event Entry : BOOL VAR_INPUT Other Event Class : GUID; n Other Event ID : UDINT; e Other Severity : Tc Event Severity; END_VAR Inputs Name Type Description Other Event Class GUID Event class of the event to be compared. n Other Event ID UDINT Event ID of the event to be compared. e Other Severity Tc Event Severity Event severity of the event to be compared. 222 Version: 1.13.8 TF6420
## Page 223

PLC API Return value Name Type Description Equals To Event Entry BOOL Returns TRUE if the events match. 6.1.1.5.1.4 Equals To Event Entry Ex This method carries out a comparison with another event specified at the input. Syntax METHOD Equals To Event Entry Ex : BOOL VAR_INPUT st Other : Tc Event Entry; END_VAR Inputs Name Type Description st Other Tc Event Entry Event to be compared. Return value Name Type Description Equals To Event Entry Ex BOOL Returns TRUE if the events match. 6.1.1.5.1.5 Get Json Attribute This method returns the Json attribute. Syntax METHOD Get Json Attribute : HRESULT VAR_INPUT s Json Attribute : REFERENCE TO STRING; n Json Attribute : UDINT; END_VAR Inputs Name Type Description s Json Attribute REFERENCE TO STRING Reference to a variable of the type String n Json Attribute UDINT Length of the String variable TF6420 Version: 1.13.8 223
## Page 224

PLC API Return value Name Type Description Get Json Attribute HRESULT Returns S_OK if the method call was successful. Returns ERROR_BAD_LENGTH if the length of the variable is too small. Otherwise HRESULT is returned as error code. 6.1.1.5.1.6 Request Event Class Name This method returns the name of the event class. Syntax METHOD Request Event Class Name : BOOL VAR_INPUT n Lang Id : DINT; s Result : REFERENCE TO STRING; n Result Size : UDINT; END_VAR VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; END_VAR Inputs Name Type Description n Lang Id DINT Specifies the language ID English (en-US) = 1033 German (de-DE) = 1031 … s Result REFERENCE TO STRING Reference to a variable of the type String n Result Size UDINT Size of the String variable in bytes Return value Name Type Description Request Event Class Name BOOL Returns TRUE as soon as the request has been terminated. Returns FALSE if the asynchronous request is still active. The method must be called until the return value is TRUE. Outputs Name Type Description b Error BOOL Returns FALSE if the method call was successful. Returns TRUE if an error has occurred. hr Error Code HRESULT Returns S_OK if the method call was successful. An error code is output in case of an error. 224 Version: 1.13.8 TF6420
## Page 225

PLC API 6.1.1.5.1.7 Request Event Text This method returns the event text. Syntax METHOD Request Event Text : BOOL VAR_INPUT n Lang Id : DINT; s Result : REFERENCE TO STRING; n Result Size : UDINT; END_VAR VAR_OUTPUT b Error : BOOL; hr Error Code : HRESULT; END_VAR Inputs Name Type Description n Lang Id DINT Specifies the language ID English (en-US) = 1033 German (de-DE) = 1031 … s Result REFERENCE TO STRING Reference to a variable of the type String n Result Size UDINT Size of the String variable in bytes Return value Name Type Description Request Event Text BOOL Returns TRUE as soon as the request has been terminated. Returns FALSE if the asynchronous request is still active. The method must be called until the return value is TRUE. Outputs Name Type Description b Error BOOL Returns FALSE if the method call was successful. Returns TRUE if an error has occurred. hr Error Code HRESULT Returns S_OK if the method call was successful. An error code is output in case of an error. 6.1.1.5.2 I_Tc Message This interface provides methods and properties for the message handling. Inheritance hierarchy I_Tc Event Base [} 221] I_Tc Message TF6420 Version: 1.13.8 225
## Page 226

PLC API Methods Name Description Send [} 226] Sends a message Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1.4022.20 PC or CX (x64, x86, Arm®) Tc3_Event Logger 6.1.1.5.2.1 Send This method sends the message. Syntax METHOD Send : HRESULT VAR_INPUT n Time Stamp: ULINT; END_VAR Inputs Name Type Description n Time Stamp ULINT 0: Current time stamp is used > 0: External time stamp in 100 nanoseconds since January 1st, 1601 (UTC). Return value Name Type Description Send FB_ HRESULT Returns S_OK if the method call was successful, otherwise HRESULT as error code 6.1.1.5.3 Data types 6.1.1.5.3.1 Tc Event Severity Defines the severity of the event. Syntax Definition: {attribute 'qualified_only'} TYPE Tc Event Severity : ( Verbose := 0, Info := 1, Warning := 2, Error := 3, Critical := 4); END_TYPE 226 Version: 1.13.8 TF6420
## Page 227

PLC API 6.1.2 Data types 6.1.2.1 Config 6.1.2.1.1 E_Database Type Syntax Definition: {attribute 'qualified_only'} TYPE E_Database Type : ( MS_Compact_SQL := 0, MS_Access := 1, MS_SQL := 2, ASCII := 3, ODBC_My SQL := 4, ODBC_Postgre SQL := 5, ODBC_Oracle := 6, ODBC_DB2 := 7, ODBC_Inter Base := 8, ODBC_Firebird := 9, XML := 10, OCI_Oracle := 11, NET_My SQL := 12, Azure SQL := 13, MS_Excel := 14, AS400ISeries := 15, Ole DB_Database := 16, Odbc_Database := 17, SQLite:=18, ODP_Oracle := 19 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.2 E_DBAuthentication Syntax Definition: {attribute 'qualified_only'} TYPE E_DBAuthentication: ( None:= 0, User Name Password := 1, x509Cert := 2, GSSAPI := 3, LDAP := 4 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database TF6420 Version: 1.13.8 227
## Page 228

PLC API 6.1.2.1.3 E_Odbc Sub Type Syntax Definition: {attribute 'qualified_only'} TYPE E_Odbc Sub Type: ( Unknown:= 0, My SQL := 1, Oracle := 2, Postgre := 3, DB2 := 4, Firebird := 5 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.4 E_Tc DBSrv Config Type Syntax Definition: {attribute 'qualified_only'} TYPE E_Tc DBSrv Config Type : ( Database := 0, Auto Log Group := 1, DBSrv Settings := 2, Symbol := 3, ADSDevice := 4, Table := 5, Symbol List := 6 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.5 ST_Config Auto Log Grp This structure is used for the Read method of the function block FB_Config Tc DBSrv Evt [} 157]. All configured Auto Log groups are read into the PLC in an array of this structure. Syntax Definition: TYPE ST_Config Auto Log Grp : STRUCT s Name: T_Max String; h Auto Log Grp ID: UDINT; h DBID: UDINT; s Table Name: T_Max String; st ADSDev: ST_ADSDevice; e Write Mode: E_Write Mode; n Cycle Time: TIME; n Symbol Count: UDINT; END_STRUCT END_TYPE 228 Version: 1.13.8 TF6420
## Page 229

PLC API Parameter Name Type Description s Name T_Max String Group name h Auto Log Grp ID UDINT ID of the declared Auto Log group h DBID UDINT ID of the assigned database s Table Name T_Max String Table name st ADSDev ST_ADSDevice [} 243] ADS device information e Write Mode E_Write Mode [} 243] Write mode n Cycle Time TIME Cycle time n Symbol Count UDINT Number of symbols Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.6 ST_Config DB This structure is used for the Read method of the function block FB_Config Tc DBSrv Evt [} 157]. All configured database connections are read into the PLC in an array of this structure. Syntax Definition: TYPE ST_Config DB : STRUCT s Name: T_Max String; h DBID: DINT; e DBType: E_Database Type; s Server: STRING(80); s Database: STRING(80); b Temp: BOOL; END_STRUCT END_TYPE Name Type Parameter s Name T_Max String Connection name h DBID DINT ID of the declared database e DBType E_Database Type Database type [} 227] s Server STRING (80) Server name s Database STRING (80) Database name b Temp BOOL TRUE if the connection was only stored temporarily. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.7 ST_Conn String Parameter Syntax Definition: TYPE ST_Conn String Parameter STRUCT s Name: T_Max String; TF6420 Version: 1.13.8 229
## Page 230

PLC API s Value: T_Max String; END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.8 Config Type Different database configuration structures are provided for the supported database types. 6.1.2.1.8.1 T_DBConfig_ASCII Describes the database configuration structure for the ASCII file. Syntax Definition: TYPE T_DBConfig_ASCII STRUCT s Server: T_Max String; END_STRUCT END_TYPE Parameter Name Type Description s Server T_Max String Path to the ASCII file Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.8.2 T_DBConfig_MSAccess Describes the database configuration structure for a Microsoft Access database. Syntax Definition: TYPE T_DBConfig_MSAccess STRUCT s Server: T_Max String; s Provider: T_Max String; END_STRUCT END_TYPE Parameter Name Type Description s Server T_Max String Path to the Access databases s Provider T_Max String Access 2000 – Access 2003: "Microsoft. Jet. OLEDB.4.0" Access 2007: "Microsoft. ACE. OLEDB.12.0" 230 Version: 1.13.8 TF6420
## Page 231

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.8.3 T_DBConfig_Ms Compact SQL Describes the database configuration structure for a Microsoft Compact SQL database. Syntax Definition: TYPE T_DBConfig_Ms Compact SQL STRUCT s Server: T_Max String; s Password: T_Max String; b Authentification: BOOL; END_STRUCT END_TYPE Parameter Name Type Description s Server T_Max String Path to the Microsoft Compact SQL file (*.sdf) s Password T_Max String Password for the database b Authentification BOOL TRUE if the database is password-protected. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.8.4 T_DBConfig_Ms Excel Describes the database configuration structure for a Microsoft Excel file. Syntax Definition: TYPE T_DBConfig_Ms Excel STRUCT s Server: T_Max String; s Provider: T_Max String; END_STRUCT END_TYPE Parameter Name Type Description s Server T_Max String Path to the Microsoft Excel file s Provider T_Max String "Microsoft. Jet. OLEDB.4.0" or "Microsoft. ACE. OLEDB.12.0" Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.8.5 T_DBConfig_Ms SQL Describes the database configuration structure for a Microsoft SQL database. TF6420 Version: 1.13.8 231
## Page 232

PLC API Syntax Definition: TYPE T_DBConfig_Ms SQL STRUCT s Server: T_Max String; s Provider: T_Max String; s Database: T_Max String; s User ID: T_Max String; s Password: T_Max String; b Authentification: BOOL; END_STRUCT END_TYPE Parameter Name Type Description s Server T_Max String Enter the name of your SQL server here. Example: "TESTSERVER\SQLEXPRESS" s Provider T_Max String "SQLOLEDB" or the provider of the SQL native client, e.g. "SQLNCLI10" Database T_Max String Enter the desired database name here. s User ID T_Max String Enter the user name here. s Password T_Max String Enter the user password here. b Authentification BOOL Set this variable to TRUE to activate authentication based on user ID and password. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.8.6 T_DBConfig_Odbc Describes the database configuration structure for a database with ODBC interface. Syntax Definition: TYPE T_DBConfig_NET_My SQL STRUCT e Odbc Sub Type: E_Odbc Sub Type; n Parameter Count: UINT; arr Parameter: ARRAY [0.. MAX_CONFIGPARAMETER] OF ST_Conn String Parameter; END_STRUCT END_TYPE Parameter Name Type Description e Odbc Sub Type E_Odbc Sub Type [} 228] Describes an ODBC database [} 228] that is supported with full functionality. n Parameter Count UINT Number of parameters for the connection strings arr Parameter ARRAY [0.. MAX_CONFIGPARAMETER] OF Array of parameters for the connection ST_Conn String Parameter [} 229]; string of type ST_Conn String Parameter [} 229]. 232 Version: 1.13.8 TF6420
## Page 233

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.8.7 T_DBConfig_SQLite Describes the database configuration structure for an SQLite database. Syntax Definition: TYPE T_DBConfig_SQLite STRUCT s Server: T_Max String; s Password: T_Max String; b Authentification: BOOL; END_STRUCT END_TYPE Parameter Name Type Description s Server T_Max String Path to the SQLite file s Password T_Max String Password for the database b Authentification BOOL TRUE if the database is password-protected. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.1.8.8 T_DBConfig_XML Describes the database configuration structure for an XML file in the customized database format. Syntax Definition: TYPE T_DBConfig_XML STRUCT s Server: T_Max String; s Schema: T_Max String; s Database: T_Max String; END_STRUCT END_TYPE Parameter Name Type Description s Server T_Max String Name and path of the XML file s Schema T_Max String Name and path of the XSD file s Database T_Max String Describes the name of the database. The XML, XSD and XSL files are created automatically for this database type. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database TF6420 Version: 1.13.8 233
## Page 234

PLC API 6.1.2.2 No SQL 6.1.2.2.1 E_No SQLDatabase Type Syntax {attribute 'qualified_only'} TYPE E_No SQLDatabase Type : ( Unknown Type := 0, Document DB := 1, Binary := 2, Time Series DB := 3 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.2.2 E_Document DBQuery Type Syntax {attribute 'qualified_only'} TYPE E_Document Db Query Type : ( Insert One := 1, Insert Many := 2, Update One := 3, Update Many := 4 , Find := 5, Aggregation := 6, Delete := 7, Delete Many := 8, Create Collection := 9, Drop Collection := 10 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.2.3 T_Object Id_Mongo DB A data type that maps the database-specific "Object Id" data type. It consists of 12 bytes with different meanings: Table 1: Object Id at byte level 1 2 3 4 5 6 7 8 9 10 11 12 Timestamp Machine Id Process Id Id The function block FB_No SQLObjec Id_Mongo DB [} 219] is available for parsing out the individual elements. Syntax TYPE T_Object Id_Mongo DB : ARRAY[0..11] OF BYTE; END_TYPE 234 Version: 1.13.8 TF6420
## Page 235

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.2.4 Query Options 6.1.2.2.4.1 Document DB 6.1.2.2.4.1.1 T_Query Option Document DB_Find Syntax Definition: TYPE T_Query Option Document DB_Find STRUCT p Filter: POINTER TO BYTE; cb Filter: UDINT; p Sort: POINTER TO BYTE; cb Sort: UDINT; p Projection: POINTER TO BYTE; cb Projection: UDINT; END_STRUCT END_TYPE Parameter Name Type Description p Filter POINTER TO Specifies the address of the search filter based on which the BYTE collection is to be searched. cb Filter UDINT Length of the search filter. p Sort POINTER TO Specifies the sort address based on which the collection is to be BYTE sorted. cb Sort UDINT Length of sorting p Projection POINTER TO Specifies the address of the display and how the collection data is BYTE to be displayed. cb Projection UDINT Length of the display. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.2.2.4.1.2 T_Query Option Document DB_Aggregate Syntax Definition: TYPE T_Query Option Document DB_Aggregate STRUCT p Pipe Stages: POINTER TO BYTE; cb Pipe Stages: UDINT; END_STRUCT END_TYPE TF6420 Version: 1.13.8 235
## Page 236

PLC API Parameter Name Type Description p Pipe Stages POINTER TO Specifies the address of the stage document. Several stages can BYTE be defined in this. cb Pipe Stages UDINT Length of the stage document. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.2.2.4.1.3 T_Query Option Document DB_Insert Syntax Definition: TYPE T_Query Option Document DB_Insert STRUCT p Documents: POINTER TO BYTE; cb Documents: UDINT; END_STRUCT END_TYPE Parameter Name Type Description p Documents POINTER TO Specifies the address of one or more documents to add to a BYTE collection. cb Documents UDINT Length of the document. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.2.2.4.1.4 T_Query Option Document DB_Update Syntax Definition: TYPE T_Query Option Document DB_Update STRUCT p Filter: POINTER TO BYTE; cb Filter: UDINT; p Documents: POINTER TO BYTE; cb Documents: UDINT; END_STRUCT END_TYPE Parameter Name Type Description p Filter POINTER TO Specifies the address of the search filter based on which the BYTE collection is to be searched. cb Filter UDINT Length of the search filter. p Documents POINTER TO Specifies the address of the documents whose values are to be BYTE transferred to the collection. cb Documents UDINT Length of the documents 236 Version: 1.13.8 TF6420
## Page 237

PLC API Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.2.2.4.1.5 T_Query Option Document DB_Delete Syntax Definition: TYPE T_Query Option Document DB_Delete STRUCT p Filter: POINTER TO BYTE; cb Filter: UDINT; END_STRUCT END_TYPE Parameter Name Type Description p Filter POINTER TO Specifies the address of the search filter based on which the BYTE collection is to be searched. cb Filter UDINT Length of the search filter. Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.2.2.4.2 Time Series DB 6.1.2.2.4.2.1 T_Query Option Time Series DB_Insert This structure is used to write data to a time series database. An array of a structure can be specified as a symbol. Each individual array element is mapped as a row with a unique timestamp in the database. The timestamps of the individual series are generated by specifying a start timestamp and the time cycle between the data sets. Syntax Definition: TYPE T_Query Option Time Series DB_Insert STRUCT p Symbol : PVOID; cb Symbol : UDINT; s Data Type : STRING; n Data Count : UDINT := 1; s Table Name : T_Max String; n Cycle Time : UDINT := 100000; n Start Timestamp : ULINT := 0; END_STRUCT END_TYPE TF6420 Version: 1.13.8 237
## Page 238

PLC API Parameter Name Type Description p Symbol POINTER TO Pointer to the symbol that is to be written to the database BYTE cb Symbol UDINT Length of the specified symbol pointer s Data Type STRING (Simple) type designation of the specified symbol n Data Count UDINT Number of data sets in the transferred array symbol s Table Name T_Max String Name of the table or table equivalent n Cycle Time UDINT Time interval of the cyclic data sets n Start Timestamp ULINT Time stamp of the first data set in Twin CAT time: Number of 100 ns intervals since January 1, 1601. Further: Reading the current Twin CAT time Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.2.2.4.2.2 T_Query Option Time Series DB_Query This structure is used to read data from a time series database. The query is passed as a string and can then be passed to the FB_No SQLQuery Builder_Time Series DB [} 208]. Syntax Definition: TYPE T_Query Option Document DB_Find STRUCT p Query: POINTER TO BYTE; cb Query: UDINT; END_STRUCT END_TYPE Parameter Name Type Description p Query POINTER TO Specifies the pointer to the query (string) BYTE cb Query UDINT Specifies the length of the query pointer Requirements Development environment Target platform PLC libraries to include Twin CAT v3.1 Build 4022.20 PC or CX (x86) Tc3_Database 6.1.2.2.5 E_Time Series Db Query Type Syntax {attribute 'qualified_only'} TYPE E_ Time Series Db Query Type: ( Insert := 1, Query := 2 ); END_TYPE 238 Version: 1.13.8 TF6420
## Page 239

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.3 SQL 6.1.2.3.1 E_Column Type Syntax Definition: {attribute 'qualified_only'} TYPE E_Column Type : ( Big Int := 0, Integer := 1, Small Int := 2, Tiny Int := 3, BIT_ := 4, Money := 5, Float := 6, REAL_ := 7, Date Time := 8, NText := 9, NChar := 10, Image := 11, NVar Char := 12, Binary := 13, Var Binary := 14 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.3.2 E_SPParameter Type Syntax Definition: {attribute 'qualified_only'} TYPE E_SPParameter Type : ( Input := 0, Output := 1, Input Output := 2, Return Value := 3, Oracle Cursor := 4 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.3.3 E_Verify Result Syntax Definition: TF6420 Version: 1.13.8 239
## Page 240

PLC API {attribute 'qualified_only'} TYPE E_Verify Result: ( check_None:= 0, check_OK := 1, check_Error:= 2, check_Type Warning:= 3, check_Type Error := 4, check_Data Length Warning := 5, check_Data Length Error := 6 ); END_TYPE Values Name Description check_None PLC structure is not verified. check_OK No differences between PLC structure and database table structure check_Type Warning Different data types with regard to the sign between PLC and database data types, e.g. UINT <> INT check_Type Error Different data types with regard to the sign between PLC structure and database table structure check_Data Length Warning Different length between PLC structure and database table structure. The record can nevertheless be mapped, although data may be lost. check_Data Length Error Different length between PLC structure and database table structure. The record cannot be mapped. 6.1.2.3.4 ST_SQLSPParameter This structure is required for the function block FB_SQLStored Procedure Evt [} 202] to describe the different parameters of the procedure to be executed. Syntax Definition: TYPE ST_SQLSPParameter : STRUCT e Parameter Type: E_SPParameter Type; e Parameter Data Type: E_Column Type; n Parameter Size: UDINT; s Parameter Name: STRING(50); END_STRUCT END_TYPE Name Type Description e Parameter Type E_SPParameter Type [} 239] Parameter type (INPUT, OUTPUT ..) e Parameter Data Type E_Column Type [} 239] Parameter type n Parameter Size UDINT Parameter length s Parameter Name STRING (50) Parameter name Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 240 Version: 1.13.8 TF6420
## Page 241

PLC API 6.1.2.4 PLC 6.1.2.4.1 E_ADSRd Wrt Mode Syntax Definition: {attribute 'qualified_only'} TYPE E_ADSRd Wrt Mode : ( by Symbol Name := 1, IGroup_IOffset := 2 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.2 E_Error Type Syntax Definition: {attribute 'qualified_only'} TYPE E_Error Type : ( no Error := 0, Internal Error, Data Base Error, ADSError ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.3 E_Exp Parameter Type Syntax Definition: {attribute 'qualified_only'} TYPE E_Exp Parameter Type : ( NULL := 0, Boolean := 1, Byte_ := 2, Int16 := 3, Int32 := 4, Int64 := 5, UInt16 := 6, UInt32 := 7, UInt64 := 8, Date Time := 9, Float32 := 10, Double64 := 11, STRING_ := 12, Byte Array := 13, Struct_ := 14, XMLTAGName := 15 ); END_TYPE TF6420 Version: 1.13.8 241
## Page 242

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.4 E_Order Column Syntax Definition: {attribute 'qualified_only'} TYPE E_Order Column : ( ID := 0, Timestamp := 1, Name := 2, Value := 3 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.5 E_Order Type Syntax Definition: {attribute 'qualified_only'} TYPE E_Order Type : ( ASC := 0, DESC := 1 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.6 E_PLCData Type Syntax Definition: {attribute 'qualified_only'} TYPE E_PLCData Type : ( e Type_BOOL := 0, e Type_BYTE := 1, e Type_SINT := 2, e Type_INT := 3, e Type_DINT := 4, e Type_UINT := 5, e Type_UDINT := 6, e Type_WORD := 7, e Type_DWORD := 8, e Type_LREAL := 9, e Type_REAL := 10, e Type_LINT := 11, e Type_ULINT := 12, 242 Version: 1.13.8 TF6420
## Page 243

PLC API e Type_Big Type := 13 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.7 E_Write Mode Syntax Definition: {attribute 'qualified_only'} TYPE E_Write Mode : ( e ADS_TO_DB_Update := 0, e ADS_TO_DB_Append := 1, e ADS_TO_DB_Ring Buff_Time := 2, e ADS_TO_DB_Ring Buff_Count := 3 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.8 ST_ADSDevice Describes the ADS device, which has to be specified for methods of the function block FB_PLCDBWrite Evt [} 179]. Syntax Definition: TYPE ST_ADSDevice : STRUCT s Dev Net ID: T_Ams Net Id; n Dev Port: T_Ams Port; e ADSRd Wrt Mode: E_ADSRd Wrt Mode; t Timeout: TIME; END_STRUCT END_TYPE Parameter Name Type Description s Dev Net ID T_Ams Net Id Net ID of the ADS device n Dev Port T_Ams Port AMS Port e ADSRd Wrt Mod E_ADSRd Wrt Mode Connection mode IGroup_IOffset / by Symbol e [} 241] t Timeout TIME ADS connection timeout Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database TF6420 Version: 1.13.8 243
## Page 244

PLC API 6.1.2.4.9 ST_Auto Log Grp Status Provides information about the respective Auto Log group. Syntax Definition: TYPE ST_Auto Log Grp Status : STRUCT h Auto Log Grp ID: UDINT; n Cycle Count: UDINT; hr Error Code: HRESULT; e Error Type: E_Error Type; b Error: BOOL; END_STRUCT END_TYPE Parameter Parameter Name Type Description h Auto Log Grp ID UDINT ID of the declared Auto Log group n Cycle Count UDINT Number of executed cycles hr Error Code HRESULT HRESULT error code e Error Type E_Error Type Error type [} 241] b Error BOOL TRUE if an error has occurred. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.10 ST_Column Info Syntax Definition: TYPE ST_Column Info : STRUCT s Name: STRING(50); s Property: STRING; n Length: UDINT; e Type: E_Column Type; END_STRUCT END_TYPE Parameter Name Type Description s Name STRING (50) Name of the column s Property STRING String for additional column properties n Length UDINT Maximum length (for strings and byte streams) e Type E_Column Type Column type [} 239] 244 Version: 1.13.8 TF6420
## Page 245

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.11 ST_Exp Parameter This structure is required for the function block FB_PLCCmd [} 184], for making the description of the different parameters (placeholders) available in the SQL command. Syntax Definition: TYPE ST_Exp Parameter: STRUCT s Para Name : T_Max String; n Para Size : UDINT; e Para Type : E_Exp Parameter Type; END_STRUCT END_TYPE Parameter Name Type Description s Para Name T_Max String Name of the parameter (placeholder) n Para Size UDINT Length of the parameter value e Para Type E_Exp Parameter Ty Data type of the parameter pe [} 241] Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.12 ST_Standard Record This structure can be used in the PLC if you want to work with the standard table structure of the Twin CAT Database Server. This structure cannot be used with Microsoft Access databases, since this database type does not support the 64-bit integer data type. In this case the structure ST_Standard Record_MSAccess [} 246] should be used. Syntax Definition: TYPE ST_Standard Record : STRUCT n ID: LINT; dt Timestamp: DT; s Name: STRING(80); r Value: LREAL; END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database TF6420 Version: 1.13.8 245
## Page 246

PLC API 6.1.2.4.13 ST_Standard Record_MSAccess This structure can be used in the PLC if you want to work with the standard table structure of the Twin CAT Database Server. This structure is specifically intended for Microsoft Access databases, since this database type does not support the 64-bit integer data type. Syntax Definition: TYPE ST_Standard Record_MSAccess: STRUCT n ID: DINT; dt Timestamp: DT; s Name: STRING(80); r Value: LREAL; END_STRUCT END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.2.4.14 ST_Symbol Describes the ADS symbol, which has to be specified for methods of the function block FB_PLCDBWrite Evt [} 179]. Syntax Definition: TYPE ST_Symbol : STRUCT s Symbol Name: T_Max String; s DBSymbol Name: T_Max String; n IGroup: UDINT; n IOffset: UDINT; n Bit Size: UDINT; e Data Type: E_PLCData Type; END_STRUCT END_TYPE Parameter Name Type Description s Symbol Name T_Max String Symbol name s DBSymbol Name T_Max String Name to be written to the database. n IGroup UDINT Index Group (only for ADSRd Wrt Mode "e ADSMode_IGroup_IOffset") n IOffset UDINT Index Offset (only for ADSRd Wrt Mode "e ADSMode_IGroup_IOffset") n Bit Size UDINT Length in bits (only for ADSRd Wrt Mode "e ADSMode_IGroup_IOffset") e Data Type E_PLCData Type Data type (only for ADSRd Wrt Mode "e ADSMode_IGroup_IOffset") [} 242] Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 246 Version: 1.13.8 TF6420
## Page 247

PLC API 6.1.3 Global constants 6.1.3.1 Constants VAR_GLOBAL CONSTANT GVL AMSPORT_DBSRV : UINT := 21372; MAX_DBCONNECTIONS : UDINT := 255; MAX_DBCOLUMNS : UDINT := 255; MAX_SPPARAMETER : UDINT := 255; MAX_CONFIGURATIONS : UDINT := 255; MAX_RECORDS : UDINT := 255; Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4 Obsolete 6.1.4.1 Configure mode 6.1.4.1.1 FB_Config Tc DBSrv Function block for creating, reading and deleting configuration entries for the Twin CAT Database Server. Syntax Definition: FUNCTION_BLOCK FB_Config Tc DBSrv VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Event Result interface with detailed information on the return value. TF6420 Version: 1.13.8 247
## Page 248

PLC API Methods Name Definition loca- Description tion Create [} 158] Local Creates new entries in the XML configuration file for the Twin CAT Database Server Read [} 159] Local Reads the current configuration of the Twin CAT Database Server Delete [} 160] Local Deletes the database and Auto Log groups from the configuration of the Twin CAT Database Server Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.1.1.1 Create This method creates new entries in the XML configuration file for the Twin CAT Database Server. Optionally the Twin CAT Database Server can use a new entry on a temporary basis. In this case no data is written to the XML file. Syntax METHOD Create : BOOL VAR_INPUT p Tc DBSrv Config: POINTER TO BYTE; cb Tc DBSrv Config: UDINT; b Temporary: BOOL := TRUE; p Config ID: POINTER TO UDINT; END_VAR Inputs Name Type Description p Tc DBSrv Config POINTER TO BYTE Pointer of the configuration structure to be created. cb Tc DBSrv Config UDINT Length of the configuration structure b Temporary BOOL Indicates whether the configuration is to be stored in the XML file. p Config ID POINTER TO UDINT Return pointer of the configuration ID (h DBID or h Auto Log Grp ID) Creating Auto Log groups is currently not supported. Return value Name Type Description Create BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv(s Net Id := '', t Timeout:=T#5S); my Config Handle : INT; // Any other Config Type can be used here st Config DB : T_DBConfig_Ms Compact SQL; END_VAR 248 Version: 1.13.8 TF6420
## Page 249

PLC API st Config DB.b Authentification := FALSE; st Config DB.s Server := 'C:\Recipes.sdf'; IF fb Config Tc DBSrv. Create( p Tc DBSrv Config:= ADR(st Config DB), cb Tc DBSrv Config:= SIZEOF(st Config DB), b Temporary:= TRUE, p Config ID:= ADR(my Config Handle)) THEN IF fb SQLStored Procedure.b Error THEN n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.1.1.2 Read This method can be used to read the current configurations of the Twin CAT Database Server. Any temporary configurations that may be included are marked accordingly. Syntax METHOD Read : BOOL VAR_INPUT p DBConfig: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Config DB; cb DBConfig: UDINT; p Auto Log Grp Config: POINTER TO ARRAY[1.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; cb Auto Log Grp Config: UDINT; p DBCount: POINTER TO UDINT; p Auto Log Grp Count: POINTER TO UDINT; END_VAR Inputs Name Type Description p DBConfig POINTER TO ARRAY [1.. MA Pointer address of the array into which the database X_CONFIGURATIONS] OF S configurations are to be written. T_Config DB [} 229] cb DBConfig UDINT Length of the database configuration array p Auto Log Grp Config POINTER TO ARRAY[1.. MAX Pointer address of the array into which the _CONFIGURATIONS] OF Auto Log Grp configurations are to be written. ST_Config Auto Log Grp [} 228] cb Auto Log Grp Config UDINT Length of the Auto Log Grp configuration array p DBCount POINTER TO UDINT Pointer address for storing the number of database configurations. p Auto Log Grp Count POINTER TO UDINT Pointer address for storing the number of Auto Log Grp configurations. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv(s Net Id := '', t Timeout:=T#5S); a DBConfig : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config DB; a Auto Grp Config : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; n Db Count : UDINT; n Auto Grp Count : UDINT; END_VAR TF6420 Version: 1.13.8 249
## Page 250

PLC API IF fb Config Tc DBSrv. Read( p DBConfig := ADR(a DBConfig), cb DBConfig := SIZEOF(a DBConfig), p Autolog Grp Config := ADR(a Auto Grp Config), cb Auto Log Grp Config := SIZEOF(a Auto Grp Config), p DBCount := ADR(n Db Count), p Auto Log Grp Count := ADR(n Auto Grp Count)) THEN IF fb Config Tc DBSrv.b Error THEN n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.1.1.3 Delete This method can be used to delete databases and Auto Log groups from the configuration of the Twin CAT Database Server. Syntax METHOD Delete : BOOL VAR_INPUT e Tc DBSrv Config Type: E_Tc DBSrv Config Type; h Config ID: UDINT; END_VAR Inputs Name Type Description e Tc DBSrv Config Type E_Tc DBSrv Config Type Type of the configuration to be deleted (database / Auto Log group) h Config ID UDINT ID of the configuration to be deleted (h DBID or h Auto Log Grp ID) Return value Name Type Description Delete BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv(s Net Id := '', t Timeout:=T#5S); my Config Handle : INT; END_VAR IF fb Config Tc DBSrv. Delete( e Tc DBSrv Config Type := E_Tc DBSrv Config Type. Database, h Config ID := my Config Handle) THEN IF fb Config Tc DBSrv.b Error THEN n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.1.2 FB_PLCDBAuto Log 250 Version: 1.13.8 TF6420
## Page 251

PLC API Function block with four methods for starting and stopping of defined Auto Log groups and for reading of the corresponding group status. Syntax Definition: FUNCTION_BLOCK FB_PLCDBAuto Log VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; b Busy_Status: BOOL; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active, except for the Status method. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Event Result interface with detailed information on the return value. b Busy_Status BOOL The Status method can be executed independently of the other three methods of the function block and therefore has its own Busy flag. Is TRUE as soon as the Status method is active. Methods Name Definition loca- Description tion Run Once Local Executes the Auto Log group once [} 162] Start [} 163] Local Starts Auto Log mode with the corresponding configured Auto Log groups Status [} 163] Local Queries the status of the Auto Log groups. Stop [} 164] Local Stops Auto Log mode Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.1.2.1 Run Once This method can be used to execute an Auto Log group once, for example based on an event in the controller. TF6420 Version: 1.13.8 251
## Page 252

PLC API Syntax METHOD Run Once : BOOL VAR_INPUT h Auto Log Grp ID: UDINT; b All: BOOL; END_VAR Inputs Name Type Description h Auto Log Grp ID UDINT ID of the Auto Log group to be executed once. b All BOOL If TRUE, all Auto Log groups are executed once. Return value Name Type Description Run Once BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Run Once(h Autolog Grp ID := 1, b All := FALSE) THEN ; // ... END_IF 6.1.4.1.2.2 Start This method starts the Auto Log mode with the corresponding configured Auto Log groups. Syntax METHOD Start : BOOL Return value Name Type Description Start BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Start() THEN ; // ... END_IF 6.1.4.1.2.3 Status This method can be used to query the status of the Auto Log groups. A separate busy flag is provided in the body of the function block for this method, since it can be called independently of the other methods of the function block: b Busy_Status. Syntax METHOD Status : BOOL VAR_INPUT t Check Cycle: TIME; p Error: POINTER TO BOOL; 252 Version: 1.13.8 TF6420
## Page 253

PLC API p Auto Log Grp Status: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Auto Log Grp Status; cb Auto Log Grp Status: UDINT; END_VAR Inputs Name Type Description t Check Cycle TIME Interval time at which the status array is updated. p Error POINTER TO BOOL TRUE, if an error has occurred in Auto Log mode. p Auto Log Status POINTER TO ARRAY Address of the status array that contains all [1.. MAX_CONFIGURATIONS] OF groups. ST_Auto Log Grp Status cb Auto Log Status UDINT Length of the status array Return value Name Type Description Status BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log(s Net ID:='', t Timeout := T#5S); b Error : BOOL; a Autolog Grp Status : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Auto Log Grp Status; END_VAR IF fb PLCDBAuto Log. Status(t Check Cycle := T#30S, ADR(b Error), ADR(a Autolog Grp Status), SIZEOF(a Autolog G rp Status)) THEN ; // ... END_IF 6.1.4.1.2.4 Stop This method stops the Auto Log mode. Syntax METHOD Stop : BOOL Return value Name Type Description Stop BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Stop() THEN ; // ... END_IF TF6420 Version: 1.13.8 253
## Page 254

PLC API 6.1.4.2 PLC Expert mode 6.1.4.2.1 FB_Config Tc DBSrv Function block for creating, reading and deleting configuration entries for the Twin CAT Database Server. Syntax Definition: FUNCTION_BLOCK FB_Config Tc DBSrv VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Event Result interface with detailed information on the return value. Methods Name Definition loca- Description tion Create [} 255] Local Creates new entries in the XML configuration file for the Twin CAT Database Server Read [} 255] Local Reads the current configuration of the Twin CAT Database Server Delete [} 256] Local Deletes the database and Auto Log groups from the configuration of the Twin CAT Database Server Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 254 Version: 1.13.8 TF6420
## Page 255

PLC API 6.1.4.2.1.1 Create This method creates new entries in the XML configuration file for the Twin CAT Database Server. Optionally the Twin CAT Database Server can use a new entry on a temporary basis. In this case no data is written to the XML file. Syntax METHOD Create : BOOL VAR_INPUT p Tc DBSrv Config: POINTER TO BYTE; cb Tc DBSrv Config: UDINT; b Temporary: BOOL := TRUE; p Config ID: POINTER TO UDINT; END_VAR Inputs Name Type Description p Tc DBSrv Config POINTER TO BYTE Pointer of the configuration structure to be created. cb Tc DBSrv Config UDINT Length of the configuration structure b Temporary BOOL Indicates whether the configuration is to be stored in the XML file. p Config ID POINTER TO UDINT Return pointer of the configuration ID (h DBID or h Auto Log Grp ID) Creating Auto Log groups is currently not supported. Return value Name Type Description Create BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv(s Net Id := '', t Timeout:=T#5S); my Config Handle : INT; // Any other Config Type can be used here st Config DB : T_DBConfig_Ms Compact SQL; END_VAR st Config DB.b Authentification := FALSE; st Config DB.s Server := 'C:\Recipes.sdf'; IF fb Config Tc DBSrv. Create( p Tc DBSrv Config:= ADR(st Config DB), cb Tc DBSrv Config:= SIZEOF(st Config DB), b Temporary:= TRUE, p Config ID:= ADR(my Config Handle)) THEN IF fb SQLStored Procedure.b Error THEN n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.2.1.2 Read This method can be used to read the current configurations of the Twin CAT Database Server. Any temporary configurations that may be included are marked accordingly. TF6420 Version: 1.13.8 255
## Page 256

PLC API Syntax METHOD Read : BOOL VAR_INPUT p DBConfig: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Config DB; cb DBConfig: UDINT; p Auto Log Grp Config: POINTER TO ARRAY[1.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; cb Auto Log Grp Config: UDINT; p DBCount: POINTER TO UDINT; p Auto Log Grp Count: POINTER TO UDINT; END_VAR Inputs Name Type Description p DBConfig POINTER TO ARRAY [1.. MA Pointer address of the array into which the database X_CONFIGURATIONS] OF S configurations are to be written. T_Config DB [} 229] cb DBConfig UDINT Length of the database configuration array p Auto Log Grp Config POINTER TO ARRAY[1.. MAX Pointer address of the array into which the _CONFIGURATIONS] OF Auto Log Grp configurations are to be written. ST_Config Auto Log Grp [} 228] cb Auto Log Grp Config UDINT Length of the Auto Log Grp configuration array p DBCount POINTER TO UDINT Pointer address for storing the number of database configurations. p Auto Log Grp Count POINTER TO UDINT Pointer address for storing the number of Auto Log Grp configurations. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv(s Net Id := '', t Timeout:=T#5S); a DBConfig : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config DB; a Auto Grp Config : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; n Db Count : UDINT; n Auto Grp Count : UDINT; END_VAR IF fb Config Tc DBSrv. Read( p DBConfig := ADR(a DBConfig), cb DBConfig := SIZEOF(a DBConfig), p Autolog Grp Config := ADR(a Auto Grp Config), cb Auto Log Grp Config := SIZEOF(a Auto Grp Config), p DBCount := ADR(n Db Count), p Auto Log Grp Count := ADR(n Auto Grp Count)) THEN IF fb Config Tc DBSrv.b Error THEN n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.2.1.3 Delete This method can be used to delete databases and Auto Log groups from the configuration of the Twin CAT Database Server. 256 Version: 1.13.8 TF6420
## Page 257

PLC API Syntax METHOD Delete : BOOL VAR_INPUT e Tc DBSrv Config Type: E_Tc DBSrv Config Type; h Config ID: UDINT; END_VAR Inputs Name Type Description e Tc DBSrv Config Type E_Tc DBSrv Config Type Type of the configuration to be deleted (database / Auto Log group) h Config ID UDINT ID of the configuration to be deleted (h DBID or h Auto Log Grp ID) Return value Name Type Description Delete BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv(s Net Id := '', t Timeout:=T#5S); my Config Handle : INT; END_VAR IF fb Config Tc DBSrv. Delete( e Tc DBSrv Config Type := E_Tc DBSrv Config Type. Database, h Config ID := my Config Handle) THEN IF fb Config Tc DBSrv.b Error THEN n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.2.2 FB_PLCDBAuto Log Function block with four methods for starting and stopping of defined Auto Log groups and for reading of the corresponding group status. Syntax Definition: FUNCTION_BLOCK FB_PLCDBAuto Log VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; b Busy_Status: BOOL; END_VAR TF6420 Version: 1.13.8 257
## Page 258

PLC API Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active, except for the Status method. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Event Result interface with detailed information on the return value. b Busy_Status BOOL The Status method can be executed independently of the other three methods of the function block and therefore has its own Busy flag. Is TRUE as soon as the Status method is active. Methods Name Definition loca- Description tion Run Once Local Executes the Auto Log group once [} 162] Start [} 163] Local Starts Auto Log mode with the corresponding configured Auto Log groups Status [} 163] Local Queries the status of the Auto Log groups. Stop [} 164] Local Stops Auto Log mode Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.2.2.1 Run Once This method can be used to execute an Auto Log group once, for example based on an event in the controller. Syntax METHOD Run Once : BOOL VAR_INPUT h Auto Log Grp ID: UDINT; b All: BOOL; END_VAR Inputs Name Type Description h Auto Log Grp ID UDINT ID of the Auto Log group to be executed once. b All BOOL If TRUE, all Auto Log groups are executed once. 258 Version: 1.13.8 TF6420
## Page 259

PLC API Return value Name Type Description Run Once BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Run Once(h Autolog Grp ID := 1, b All := FALSE) THEN ; // ... END_IF 6.1.4.2.2.2 Start This method starts the Auto Log mode with the corresponding configured Auto Log groups. Syntax METHOD Start : BOOL Return value Name Type Description Start BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Start() THEN ; // ... END_IF 6.1.4.2.2.3 Status This method can be used to query the status of the Auto Log groups. A separate busy flag is provided in the body of the function block for this method, since it can be called independently of the other methods of the function block: b Busy_Status. Syntax METHOD Status : BOOL VAR_INPUT t Check Cycle: TIME; p Error: POINTER TO BOOL; p Auto Log Grp Status: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Auto Log Grp Status; cb Auto Log Grp Status: UDINT; END_VAR TF6420 Version: 1.13.8 259
## Page 260

PLC API Inputs Name Type Description t Check Cycle TIME Interval time at which the status array is updated. p Error POINTER TO BOOL TRUE, if an error has occurred in Auto Log mode. p Auto Log Status POINTER TO ARRAY Address of the status array that contains all [1.. MAX_CONFIGURATIONS] OF groups. ST_Auto Log Grp Status cb Auto Log Status UDINT Length of the status array Return value Name Type Description Status BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log(s Net ID:='', t Timeout := T#5S); b Error : BOOL; a Autolog Grp Status : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Auto Log Grp Status; END_VAR IF fb PLCDBAuto Log. Status(t Check Cycle := T#30S, ADR(b Error), ADR(a Autolog Grp Status), SIZEOF(a Autolog G rp Status)) THEN ; // ... END_IF 6.1.4.2.2.4 Stop This method stops the Auto Log mode. Syntax METHOD Stop : BOOL Return value Name Type Description Stop BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBAuto Log : FB_PLCDBAuto Log (s Net ID:='', t Timeout := T#5S); END_VAR IF fb PLCDBAuto Log. Stop() THEN ; // ... END_IF 6.1.4.2.3 FB_PLCDBCreate 260 Version: 1.13.8 TF6420
## Page 261

PLC API Function block with two methods. One method can be used to create databases from the PLC on a database server specified in the PLC. The other method can be used to generate a new table in a specified database. Syntax Definition: FUNCTION_BLOCK FB_PLCDBCreate VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Eve Tc3_Event Logger. I_Tc Result Event Result interface with detailed information on the return nt value. Methods Name Definition loca- Description tion Database Local Creates a new database [} 261] Table [} 262] Local Creates a new table with a structure that is defined via an array with x elements or x columns in the PLC. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.2.3.1 Database This method creates a new database. Optionally you can specify whether the created database should also be used for the configuration of the Twin CAT Database Server. Syntax METHOD Database : BOOL VAR_INPUT p Database Config: POINTER TO BYTE; cb Database Config: UDINT; b Create XMLConfig: BOOL; p DBID: POINTER TO UDINT; END_VAR TF6420 Version: 1.13.8 261
## Page 262

PLC API Inputs Name Type Description p Database Config POINTER TO BYTE Address of the database configuration structure [} 230] cb Database Config UDINT Length of the database configuration structure b Create XMLConfig BOOL Indicates whether the newly created database should be entered as new configuration entry in the XML file. p DBID UDINT Returns the h DBID if/when a new configuration entry was created. Return value Name Type Description Database BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBCreate : FB_PLCDBCreate Evt(s Net ID := '', t Timeout := T#5S); st Config DB : T_DBConfig_Ms Compact SQL; h DBID : UDINT; tc Message : I_Tc Message; END_VAR st Config DB.b Authentification := FALSE; st Config DB.s Server := 'C:\Test.sdf'; IF fb PLCDBCreate. Database( p Database Config:= ADR(st Config DB), cb Database Config := SIZEOF(st Config DB), b Create XMLConfig := TRUE, p DBID := ADR(h DBID)) THEN IF fb PLCDBCreate.b Error THEN tc Message := fb PLCDBCreate.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.2.3.2 Table This method creates a new table with a structure that is defined through an array with x elements or x columns in the PLC. Syntax METHOD Table : BOOL VAR_INPUT h DBID : UDINT; s Table Name : T_Max String; p Table Cfg : POINTER TO ARRAY[0.. MAX_DBCOLUMNS] OF ST_Column Info; cb Table Cfg : UDINT; END_VAR 262 Version: 1.13.8 TF6420
## Page 263

PLC API Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name Max String Name of the table to be created. p Table Cfg POINTER TO Indicates the pointer address of the table structure ARRAY[0.. MAX_DBCOLUMNS] array. The individual columns are written in this array. OF ST_Column Info [} 244] cb Table Cfg UDINT Indicates the length of the array in which the columns are configured. Return value Name Type Description Table BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBCreate : FB_PLCDBCreate Evt(s Net ID := '', t Timeout := T#5S); Column Info : ARRAY [0..14] OF ST_Column Info; tc Message : I_Tc Message; END_VAR Column Info[0].s Name := 'col Big Int'; Column Info[0].e Type := E_Column Type. Big Int; Column Info[0 ].n Length := 8; Column Info[0].s Property := 'IDENTITY(1,1)'; Column Info[1].s Name := 'col Integer'; Column Info[1].e Type := E_Column Type. Integer; Column Info[1 ].n Length := 4; Column Info[2].s Name := 'col Small Int'; Column Info[2].e Type := E_Column Type. Small Int; Column Info[2 ].n Length := 2; Column Info[3].s Name := 'col Tiny Int'; Column Info[3].e Type := E_Column Type. Tiny Int; Column Info[3 ].n Length := 1; Column Info[4].s Name := 'col Bit'; Column Info[4].e Type := E_Column Type. BIT_; Column Info[4 ].n Length := 1; Column Info[5].s Name := 'col Money'; Column Info[5].e Type := E_Column Type. Money; Column Info[5 ].n Length := 8; Column Info[6].s Name := 'col Float'; Column Info[6].e Type := E_Column Type. Float; Column Info[6 ].n Length := 8; Column Info[7].s Name := 'col Real'; Column Info[7].e Type := E_Column Type. REAL_; Column Info[7 ].n Length := 4; Column Info[8].s Name := 'col Date Time'; Column Info[8].e Type := E_Column Type. Date Time; Column Info[8 ].n Length := 4; Column Info[9].s Name := 'col NText'; Column Info[9].e Type := E_Column Type. NText; Column Info[9 ].n Length := 256; Column Info[10].s Name := 'col NChar'; Column Info[10].e Type := E_Column Type. NChar; Column Info[1 0].n Length := 10; Column Info[11].s Name := 'col Image'; Column Info[11].e Type := E_Column Type. Image; Column Info[1 1].n Length := 256; Column Info[12].s Name := 'col NVar Char'; Column Info[12].e Type := E_Column Type. NVar Char; Column Info[1 2].n Length := 50; Column Info[13].s Name := 'col Binary'; Column Info[13].e Type := E_Column Type. Binary; Column Info[1 3].n Length := 30; Column Info[14].s Name := 'col Var Binary'; Column Info[14].e Type := E_Column Type. Var Binary; Column Info[1 4].n Length := 20; IF fb PLCDBCreate. Table( h DBID:= 1, s Table Name:= 'my New Table', p Table Cfg:= ADR(Column Info), cb Table Cfg:= SIZEOF(Column Info)) THEN IF fb PLCDBCreate.b Error THEN Tc Message:= fb PLCDBCreate.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF TF6420 Version: 1.13.8 263
## Page 264

PLC API 6.1.4.2.4 FB_PLCDBRead Function block for reading records from a database. Syntax FUNCTION_BLOCK FB_PLCDBRead VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Event Result interface with detailed information on the return value. Methods Name Definition location Description Read [} 264] Local Reads a specified number of records from a database table with the standard table structure specified by Beckhoff. Read Struct [} 266] Local Reads a specified number of records from a database table with any table structure. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.2.4.1 Read This method reads a specified number of records from a database table with the standard table structure specified by Beckhoff. (The standard table structure is used in Auto Log mode and in the FB_DBWrite function block, for example). Syntax METHOD Read : BOOL VAR_INPUT h DBID: UDINT; 264 Version: 1.13.8 TF6420
## Page 265

PLC API s Table Name: T_Max String; s DBSymbol Name: T_Max String; e Order By: E_Order Column := E_Order Column.e Column ID; e Order Type: E_Order Type := E_Order Type.e Order_ASC; n Start Index: UDINT; n Record Count: UDINT; p Data: POINTER TO ST_Standard Record; cb Data: UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. s DBSymbol Name T_Max String Symbol name to be read from the standard table structure. e Order By E_Order Column.e Column ID Sorting column (ID, timestamp, name or value) e Order Type E_Order Type.e Order_ASC Sorting direction (ASC or DESC) n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Data POINTER TO ST_Standard Record Address of the structure array into which the records are to be written. cb Data UDINT Indicates the size of the structure array in bytes. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBRead : FB_PLCDBRead Evt (s Net ID := '', t Timeout := T#5S); Read Struct : ST_Standard Record; tc Message : I_Tc Message; END_VAR IF fb PLCDBRead. Read( h DBID:= 1, s Table Name:= 'My Table_With LReal', s DBSymbol Name:= 'My Value', e Order By:= E_Order Column. ID, e Order Type:= E_Order Type. DESC, n Start Index:= 0, n Record Count:= 1, p Data:= ADR(Read Struct), cb Data:= SIZEOF(Read Struct)) THEN IF fb PLCDBRead.b Error THEN tc Message := fb PLCDBRead.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF Result in the PLC: TF6420 Version: 1.13.8 265
## Page 266

PLC API 6.1.4.2.4.2 Read Struct This method reads a specified number of records from a database table with any table structure. Syntax METHOD Read Struct : BOOL VAR_INPUT h DBID: UDINT; s Table Name: T_Max String; p Column Names: POINTER TO ARRAY [0.. MAX_DBCOLUMNS] OF STRING(50); cb Column Names: UDINT; s Order By Column: STRING(50); e Order Type: E_Order Type := E_Order Type.e Order_ASC; n Start Index: UDINT; n Record Count: UDINT; p Data: POINTER TO BYTE; cb Data: UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. p Column Names POINTER TO ARRAY [0.. MAX_D Address of the array containing the column name BCOLUMNS] OF STRING(50) to be read. cb Column Names UDINT Length of the column name array s Order By Column STRING(50) Name the sorting column e Order Type E_Order Type Sorting direction (ASC or DESC) n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Data POINTER TO BYTE Address of the structure array into which the records are to be written. cb Data UDINT Indicates the size of the structure array in bytes. Return value Name Type Description Read Struct BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb PLCDBRead : FB_PLCDBRead Evt (s Net ID := '', t Timeout := T#5S); my Custom Struct : ST_Record; tc Message : I_Tc Message; END_VAR TYPE ST_Record : STRUCT n ID : LINT; dt Timestamp: DATE_AND_TIME; 266 Version: 1.13.8 TF6420
## Page 267

PLC API s Name : STRING; n Sensor1 : LREAL; n Sensor2 : LREAL; END_STRUCT END_TYPE // set columnnames Column Names[0] := 'ID'; Column Names[1] := 'Timestamp'; Column Names[2] := 'Name'; Column Names[3] := 'Sensor1'; Column Names[4] := 'Sensor2'; IF fb PLCDBRead. Read Struct( h DBID:= 1, s Table Name:= 'My Table_Struct', p Column Names:= ADR(Column Names), cb Column Names:= SIZEOF(Column Names), s Order By Column:= Column Names[0], e Order Type:= E_Order Type. DESC, n Start Index:= 0, n Record Count:= 1, p Data:= ADR(my Custom Struct), cb Data:= SIZEOF(my Custom Struct)) THEN IF fb PLCDBRead.b Error THEN tc Message:= fb PLCDBRead.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF Result in the PLC: 6.1.4.2.5 FB_PLCDBWrite Function block for writing of records into a database. Syntax Definition: FUNCTION_BLOCK FB_PLCDBWrite VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR TF6420 Version: 1.13.8 267
## Page 268

PLC API Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Event Result interface with detailed information on the return value. Methods Name Definition loca- Description tion Write [} 268] Local Creates a record in the standard table structure specified by Beckhoff. Write By Symbol Local Reads the value of a specified ADS symbol and saves it in the standard table structure specified by Beckhoff. [} 269] Write Struct [} 271] Local Creates a record with any table structure Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.2.5.1 Write This method creates a record in the standard table structure specified by Beckhoff. Syntax METHOD Write : BOOL VAR_INPUT h DBID: UDINT; s Table Name: T_Max String; p Value: POINTER TO BYTE; cb Value: UDINT; s DBSymbol Name: T_Max String; e DBWrite Mode: E_Write Mode := E_Write Mode.e ADS_TO_DB_Append; n Ring Buff Parameter: UDINT; END_VAR 268 Version: 1.13.8 TF6420
## Page 269

PLC API Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. p Value POINTER TO BYTE Address of the variable to be logged in the standard table structure. cb Value UDINT Length of the variable to be logged. s DBSymbol Name T_Max String Name that is logged in the table. e DBWrite Mode E_Write Mode Indicates the write mode. (append, update, ring buffer) n Ring Buff Parameter UDINT Additional parameter(s) for the "ring buffer" write mode. Return value Name Type Description Write BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample This sample shows how to use the FB_PLCDBWrite Evt. Write method: VAR fb PLCDBWrite : FB_PLCDBWrite Evt(s Net ID := '', t Timeout := T#5S); my Value : LREAL := 43.23; tc Message : I_Tc Message; END_VAR IF fb PLCDBWrite. Write( h DBID:= 1, s Table Name:= 'my Table_With LReal', p Value:= ADR(my Value), cb Value:= SIZEOF(my Value), s DBSymbol Name:= 'My Value', e DBWrite Mode:= E_Write Mode.e ADS_TO_DB_Ring Buff_Count, n Ring Buff Parameter:= 3) THEN IF fb PLCDBWrite.b Error THEN tc Message := fb PLCDBWrite.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF Result in the database: ID Timestamp Name Value 27 Has been dropped 28 '2018-01-30 14:04:19' 'My Value' 41.23 29 '2018-01-30 14:04:29' 'My Value' 42.23 30 '2018-01-30 14:04:39' 'My Value' 43.23 With the ring buffer option, only three entries of this name are in the database at any one time. Older entries are deleted. 6.1.4.2.5.2 Write By Symbol This method reads the value of a specified ADS symbol and saves it in the standard table structure specified by Beckhoff. ADS symbols from other ADS devices can also be read. TF6420 Version: 1.13.8 269
## Page 270

PLC API Syntax METHOD Write By Symbol : BOOL VAR_INPUT h DBID: UDINT; s Table Name: T_Max String; st ADSDevice: ST_ADSDevice; st Symbol: ST_Symbol; e DBWrite Mode: E_Write Mode := E_Write Mode.e ADS_TO_DB_Append; n Ring Buff Parameter: UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. st ADSDevice ST_ADSDevice ADS device from which a symbol is to be logged in the standard table structure. st Symbol ST_Symbol Symbol name of the variable to be written e DBWrite Mode E_Write Mode Indicates the write mode. (append, update, ring buffer) n Ring Buff Parameter UDINT Additional parameter(s) for the "ring buffer" write mode Return value Name Type Description Write By Symbol BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample This sample shows how to use the FB_PLCDBWrite Evt. Write By Symbol method: VAR fb PLCDBWrite : FB_PLCDBWrite Evt(s Net ID := '', t Timeout := T#5S); my Value : LREAL := 43.23; my Ads Device : ST_ADSDevice; my Symbol : ST_Symbol; tc Message : I_Tc Message; END_VAR // Set ADSDevice Information my Ads Device.s Dev Net ID := '127.0.0.1.1.1'; my Ads Device.n Dev Port := 851; my Ads Device.e ADSRd Wrt Mode := E_ADSRd Wrt Mode.by Symbol Name; my Ads Device.t Timeout := T#5S; // Set Symbol Information my Symbol.e Data Type := E_PLCData Type.e Type_LREAL; my Symbol.s DBSymbol Name := 'My Symbol'; my Symbol.s Symbol Name := 'MAIN.my Value'; my Symbol.n Bit Size := 8; // Call Functionblock IF fb PLCDBWrite. Write By Symbol( h DBID:= 1, s Table Name:= 'my Table_With LReal', st ADSDevice:= my Ads Device, st Symbol:= my Symbol, e DBWrite Mode:= E_Write Mode.e ADS_TO_DB_Append, n Ring Buff Parameter:= 1) THEN IF fb PLCDBWrite.b Error THEN tc Message := fb PLCDBWrite.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF Result in the database: 270 Version: 1.13.8 TF6420
## Page 271

PLC API ID Timestamp Name Value 28 '2018-01-30 14:04:19' 'My Value' 41.23 29 '2018-01-30 14:04:29' 'My Value' 42.23 30 '2018-01-30 14:04:39' 'My Value' 43.23 31 '2018-01-30 14:06:12’ ‘My Symbol’ 86.2 6.1.4.2.5.3 Write Struct This method creates a record with a freely selectable table structure. Syntax METHOD Write Struct : BOOL VAR_INPUT h DBID: UDINT; s Table Name: T_Max String; p Record: POINTER TO BYTE; cb Record: UDINT; p Column Names: POINTER TO ARRAY [0.. MAX_DBCOLUMNS] OF STRING(50); cb Column Names: UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. s Table Name T_Max String Name of the table that is to be read. p Record POINTER TO BYTE Address of a structure that is to be logged in a freely selectable table structure. cb Record UDINT Length of the structure to be written p Column Names POINTER TO ARRAY [ Address of the array containing the column name to be filled. 0.. MAX_DBCOLUMNS ] OF STRING(50) cb Column Names UDINT Length of the column name array Return value Name Type Description Write Struct BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample This sample shows how to use the method FB_PLCDBWrite Evt. Write Struct: VAR fb PLCDBWrite : FB_PLCDBWrite Evt(s Net ID := '', t Timeout := T#5S); my Record : ST_Record; Column Names : ARRAY[0..4] OF STRING(50); systime : GETSYSTEMTIME; current Time : T_FILETIME; tc Message : I_Tc Message; END_VAR TYPE ST_Record : STRUCT n ID : LINT; dt Timestamp: DATE_AND_TIME; s Name : STRING; n Sensor1 : LREAL; n Sensor2 : LREAL; END_STRUCT END_TYPE TF6420 Version: 1.13.8 271
## Page 272

PLC API // set Values systime(time Lo Dw => current Time.dw Low Date Time, time Hi DW => current Time.dw High Date Time ); my Record.dt Timestamp := FILETIME_TO_DT(current Time); my Record.s Name := 'My Struct Val'; my Record.n Sensor1 := 12.34; my Record.n Sensor2 := 102.5; // set columnnames Column Names[0] := 'ID'; Column Names[1] := 'Timestamp'; Column Names[2] := 'Name'; Column Names[3] := 'Sensor1'; Column Names[4] := 'Sensor2'; // Call Functionblock IF fb PLCDBWrite. Write Struct( h DBID:= 1, s Table Name:= 'my Table_Struct', p Record:= ADR(my Record), cb Record:= SIZEOF(my Record), p Column Names:= ADR(Column Names) , cb Column Names:= SIZEOF(Column Names)) THEN IF fb PLCDBWrite.b Error THEN tc Message := fb PLCDBWrite.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF Result in the database: ID Timestamp Name Sensor1 Sensor2 5 '2018-01-30 ‘My Struct Val’ 12.34 102.5 15:23:26' 6.1.4.2.6 FB_PLCDBCmd Function block with two methods. Users can define and transfer their own SQL commands. Placeholders in the SQL command can correlate with structures in the PLC, which reflect the table structure. The Database Server ultimately enters the current data of the structure into the SQL command. Syntax Definition: FUNCTION_BLOCK FB_PLCDBCmd VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. 272 Version: 1.13.8 TF6420
## Page 273

PLC API Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Event Result interface with detailed information on the return value. Methods Name Definition loca- Description tion Execute [} 273] Local Sends any SQL commands to the database. Returned records cannot be read. Execute Data Return Local Sends any SQL commands to the database. [} 274] A specified number of records can be read. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.2.6.1 Execute This method can be used to send SQL commands to the database. The database connection is opened with each call and then closed again. It is possible to define placeholders in the command, which are then replaced by the Twin CAT Database Server with the corresponding values before the execution. Returned records cannot be read. Syntax METHOD Execute : BOOL VAR_INPUT h DBID: UDINT; p Expression: POINTER TO BYTE; cb Expression: UDINT; p Data: POINTER TO BYTE; cb Data: UDINT; p Parameter: POINTER TO ARRAY[0.. MAX_DBCOLUMNS] OF ST_Exp Parameter; cb Parameter: UDINT; END_VAR Sample VAR fb PLCDBCmd : FB_PLCDBCmd Evt(s Net ID := '', t Timeout := T#5S); s Cmd : STRING (1000); my Struct : ST_Data All; a Para : ARRAY[0..14] OF ST_Exp Parameter; tc Message : I_Tc Message; END_VAR TYPE ST_Data All : STRUCT col Big Int: LINT; col Integer: DINT; col Small Int: INT; col Tiny Int: BYTE; col Bit: BOOL; col Money: LREAL; col Float: LREAL; col Real: REAL; col Date Time: DT; col NText: STRING(255); col NChar: STRING(10); col Image: ARRAY[0..255] OF BYTE; TF6420 Version: 1.13.8 273
## Page 274

PLC API col NVar Char: STRING(50); col Binary: ARRAY[0..29] OF BYTE; col Var Binary: ARRAY[0..19] OF BYTE; END_STRUCT END_TYPE // set Parameter configuration a Para[0].s Para Name := 'col Big Int'; a Para[0].e Para Type := E_Exp Parameter Type. Int64; a Para[0].n Para Size := 8; a Para[1].s Para Name := 'col Integer'; a Para[1].e Para Type := E_Exp Parameter Type. Int32; a Para[1].n Para Size := 4; a Para[2].s Para Name := 'col Small Int'; a Para[2].e Para Type := E_Exp Parameter Type. Int16; a Para[2].n Para Size := 2; a Para[3].s Para Name := 'col Tiny Int'; a Para[3].e Para Type := E_Exp Parameter Type. Byte_; a Para[3].n Para Size := 1; a Para[4].s Para Name := 'col Bit'; a Para[4].e Para Type := E_Exp Parameter Type. Boolean; a Para[4].n Para Size := 1; a Para[5].s Para Name := 'col Money'; a Para[5].e Para Type := E_Exp Parameter Type. Double64; a Para[5].n Para Size := 8; a Para[6].s Para Name := 'col Float'; a Para[6].e Para Type := E_Exp Parameter Type. Double64; a Para[6].n Para Size := 8; a Para[7].s Para Name := 'col Real'; a Para[7].e Para Type := E_Exp Parameter Type. Float32; a Para[7].n Para Size := 4; a Para[8].s Para Name := 'col Date Time'; a Para[8].e Para Type := E_Exp Parameter Type. Date Time; a Para[8].n Para Size := 4; a Para[9].s Para Name := 'col NText'; a Para[9].e Para Type := E_Exp Parameter Type. STRING_; a Para[9].n Para Size := 256; a Para[10].s Para Name:= 'col NChar'; a Para[10].e Para Type := E_Exp Parameter Type. STRING_; a Para[10].n Para Size := 10; a Para[11].s Para Name:= 'col Image'; a Para[11].e Para Type := E_Exp Parameter Type. Byte Array; a Para[11].n Para Size := 256; a Para[12].s Para Name:= 'col NVar Char'; a Para[12].e Para Type := E_Exp Parameter Type. STRING_; a Para[12].n Para Size := 50; a Para[13].s Para Name:= 'col Binary'; a Para[13].e Para Type := E_Exp Parameter Type. Byte Array; a Para[13].n Para Size := 30; a Para[14].s Para Name:= 'col Var Binary'; a Para[14].e Para Type := E_Exp Parameter Type. Byte Array; a Para[14].n Para Size := 20; // set command s Cmd := 'INSERT INTO My Table Name (col Integer, col Small Int, col Tiny Int, col Bit, col Money, col Float, col Real, col Date Time, col NText, col NChar, col Image, col NVar Char, col Binary, col Var Binary) VALUES ({col Integer}, {col Small Int}, {col Tiny Int}, {col Bit}, {col Money}, {col Float}, {col Real}, {col Date Time}, {col NText}, {col NChar}, {col Image}, {col NVar Char}, {col Binary}, {col Var Binary})'; // call functionblock IF fb PLCDBCmd. Execute( h DBID:= 1, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= ADR(my Struct), cb Data:= SIZEOF(my Struct), p Parameter:= ADR(a Para), cb Parameter:= SIZEOF(a Para)) THEN IF fb PLCDBCmd.b Error THEN tc Message := fb PLCDBCmd.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.2.6.2 Execute Data Return This method can be used to send SQL commands to the database. The database connection is opened with each call and then closed again. It is possible to define placeholders in the command, which are then replaced by the Twin CAT Database Server with the corresponding values before the execution. A specified number of records can be read. Syntax METHOD Execute Data Return : BOOL VAR_INPUT h DBID: UDINT; p Expression: POINTER TO BYTE; cb Expression: UDINT; p Data: POINTER TO BYTE; cb Data: UDINT; 274 Version: 1.13.8 TF6420
## Page 275

PLC API p Parameter: POINTER TO ARRAY[0.. MAX_DBCOLUMNS] OF ST_Exp Parameter; cb Parameter: UDINT; n Start Index: UDINT; n Record Count: UDINT; p Return Data: POINTER TO BYTE; cb Return Data: UDINT; p Records: POINTER TO UDINT; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. p Expression POINTER TO BYTE Address of the string variable with the SQL command. cb Expression UDINT Length of the string variable with the SQL command. p Data POINTER TO BYTE Address of the structure with the parameter values cb Data UDINT Length of the structure with the parameter values p Parameter POINTER TO ARRAY[0.. MAX_ Address of the structure array with the parameter DBCOLUMNS] OF ST_Exp Par information. ameter cb Parameter UDINT Length of the structure array with the parameter information. n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Return Data POINTER TO BYTE Address of the structure array into which the records are to be written. cb Return Data UDINT Indicates the size of the structure array in bytes. p Records POINTER TO BYTE Number of read records. Return value Name Type Description Execute Data Return BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Parameterizing the command The column names for the individual parameters are specified in curly brackets in the SQL command. Sample: ‚SELECT * FROM My House_Temperatures WHERE Room = {Selected Room}’. Accordingly, Selected Room has to be specified as parameter name in the structure ST_Exp Parameter. Some databases do not support the parameterization of SQL clauses. (TOP/LIMIT/ROWNUM/...) Parameterizable table names are not usually supported. Sample VAR fb PLCDBCmd : FB_PLCDBCmd Evt(s Net ID := '', t Timeout := T#5S); s Cmd : STRING (1000); st Para : ST_Exp Parameter; Record Amt : ULINT := 3; Return Data Struct : ARRAY [0..9] OF ST_Data All; n Records : UDINT; tc Message : I_Tc Message; END_VAR // set Parameter configuration st Para.e Para Type := E_Exp Parameter Type. Int64; st Para.n Para Size := 8; st Para.s Para Name := 'Record Amt'; // set command with placeholder TF6420 Version: 1.13.8 275
## Page 276

PLC API s Cmd := 'SELECT TOP ({Record Amt}) * FROM My Table Name'; // call functionblock IF fb PLCDBCmd. Execute Data Return( h DBID:= 1, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= ADR(Record Amt), cb Data:= SIZEOF(Record Amt), p Parameter:= ADR(st Para), cb Parameter:= SIZEOF(st Para), n Start Index:= 0, n Record Count:= 10, p Return Data:= ADR(Return Data Struct), cb Return Data:= SIZEOF(Return Data Struct), p Records:= ADR(n Records)) THEN IF fb PLCDBCmd.b Error THEN tc Message := fb PLCDBCmd.ip Tc Result; n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.3 SQL Expert mode 6.1.4.3.1 FB_Config Tc DBSrv Function block for creating, reading and deleting configuration entries for the Twin CAT Database Server. 276 Version: 1.13.8 TF6420
## Page 277

PLC API Syntax Definition: FUNCTION_BLOCK FB_Config Tc DBSrv VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Event Result interface with detailed information on the return value. Methods Name Definition loca- Description tion Create [} 158] Local Creates new entries in the XML configuration file for the Twin CAT Database Server Read [} 159] Local Reads the current configuration of the Twin CAT Database Server Delete [} 160] Local Deletes the database and Auto Log groups from the configuration of the Twin CAT Database Server Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.3.1.1 Create This method creates new entries in the XML configuration file for the Twin CAT Database Server. Optionally the Twin CAT Database Server can use a new entry on a temporary basis. In this case no data is written to the XML file. Syntax METHOD Create : BOOL VAR_INPUT p Tc DBSrv Config: POINTER TO BYTE; cb Tc DBSrv Config: UDINT; b Temporary: BOOL := TRUE; p Config ID: POINTER TO UDINT; END_VAR TF6420 Version: 1.13.8 277
## Page 278

PLC API Inputs Name Type Description p Tc DBSrv Config POINTER TO BYTE Pointer of the configuration structure to be created. cb Tc DBSrv Config UDINT Length of the configuration structure b Temporary BOOL Indicates whether the configuration is to be stored in the XML file. p Config ID POINTER TO UDINT Return pointer of the configuration ID (h DBID or h Auto Log Grp ID) Creating Auto Log groups is currently not supported. Return value Name Type Description Create BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv(s Net Id := '', t Timeout:=T#5S); my Config Handle : INT; // Any other Config Type can be used here st Config DB : T_DBConfig_Ms Compact SQL; END_VAR st Config DB.b Authentification := FALSE; st Config DB.s Server := 'C:\Recipes.sdf'; IF fb Config Tc DBSrv. Create( p Tc DBSrv Config:= ADR(st Config DB), cb Tc DBSrv Config:= SIZEOF(st Config DB), b Temporary:= TRUE, p Config ID:= ADR(my Config Handle)) THEN IF fb SQLStored Procedure.b Error THEN n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.3.1.2 Read This method can be used to read the current configurations of the Twin CAT Database Server. Any temporary configurations that may be included are marked accordingly. Syntax METHOD Read : BOOL VAR_INPUT p DBConfig: POINTER TO ARRAY [1.. MAX_CONFIGURATIONS] OF ST_Config DB; cb DBConfig: UDINT; p Auto Log Grp Config: POINTER TO ARRAY[1.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; cb Auto Log Grp Config: UDINT; p DBCount: POINTER TO UDINT; p Auto Log Grp Count: POINTER TO UDINT; END_VAR 278 Version: 1.13.8 TF6420
## Page 279

PLC API Inputs Name Type Description p DBConfig POINTER TO ARRAY [1.. MA Pointer address of the array into which the database X_CONFIGURATIONS] OF S configurations are to be written. T_Config DB [} 229] cb DBConfig UDINT Length of the database configuration array p Auto Log Grp Config POINTER TO ARRAY[1.. MAX Pointer address of the array into which the _CONFIGURATIONS] OF Auto Log Grp configurations are to be written. ST_Config Auto Log Grp [} 228] cb Auto Log Grp Config UDINT Length of the Auto Log Grp configuration array p DBCount POINTER TO UDINT Pointer address for storing the number of database configurations. p Auto Log Grp Count POINTER TO UDINT Pointer address for storing the number of Auto Log Grp configurations. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv(s Net Id := '', t Timeout:=T#5S); a DBConfig : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config DB; a Auto Grp Config : ARRAY[0.. MAX_CONFIGURATIONS] OF ST_Config Auto Log Grp; n Db Count : UDINT; n Auto Grp Count : UDINT; END_VAR IF fb Config Tc DBSrv. Read( p DBConfig := ADR(a DBConfig), cb DBConfig := SIZEOF(a DBConfig), p Autolog Grp Config := ADR(a Auto Grp Config), cb Auto Log Grp Config := SIZEOF(a Auto Grp Config), p DBCount := ADR(n Db Count), p Auto Log Grp Count := ADR(n Auto Grp Count)) THEN IF fb Config Tc DBSrv.b Error THEN n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.3.1.3 Delete This method can be used to delete databases and Auto Log groups from the configuration of the Twin CAT Database Server. Syntax METHOD Delete : BOOL VAR_INPUT e Tc DBSrv Config Type: E_Tc DBSrv Config Type; h Config ID: UDINT; END_VAR TF6420 Version: 1.13.8 279
## Page 280

PLC API Inputs Name Type Description e Tc DBSrv Config Type E_Tc DBSrv Config Type Type of the configuration to be deleted (database / Auto Log group) h Config ID UDINT ID of the configuration to be deleted (h DBID or h Auto Log Grp ID) Return value Name Type Description Delete BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Config Tc DBSrv : FB_Config Tc DBSrv(s Net Id := '', t Timeout:=T#5S); my Config Handle : INT; END_VAR IF fb Config Tc DBSrv. Delete( e Tc DBSrv Config Type := E_Tc DBSrv Config Type. Database, h Config ID := my Config Handle) THEN IF fb Config Tc DBSrv.b Error THEN n State := 255; ELSE n State := 0; END_IF END_IF 6.1.4.3.2 FB_SQLDatabase Function block for opening, closing and managing a database connection. Syntax Definition: FUNCTION BLOCK FB_SQLDatabase VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. 280 Version: 1.13.8 TF6420
## Page 281

PLC API Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Result interface with detailed information on the return Event value. Methods Name Definition loca- Description tion Connect [} 281] Local Opens a connection to a declared database. Create Cmd [} 282] Local Initializes an instance of the function block FB_SQLCommand with the already open database connection of the function block FB_SQLDatabase. Create SP [} 282] Local Initializes an instance of the function block FB_SQLStored Procedure with the already open database connection of the function block FB_SQLDatabase. Disconnect [} 283] Local Closes the connection to the database that was opened by this function block instance. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.3.2.1 Connect This method opens a connection to a declared database. Syntax METHOD Connect : BOOL VAR_INPUT h DBID: UDINT := 1; END_VAR Inputs Name Type Description h DBID UDINT Indicates the ID of the database to be used. Return value Name Type Description Connect BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Sql Database : FB_SQLDatabase Evt(s Net ID := '', t Timeout := T#5S); END_VAR // open connection IF fb Sql Database. Connect(1) THEN IF fb Sql Database.b Error THEN n State := 255; ELSE TF6420 Version: 1.13.8 281
## Page 282

PLC API n State := n State+1; END_IF END_IF 6.1.4.3.2.2 Create Cmd This method is used to initialize an instance of the function block FB_SQLCommand with the already open database connection of the function block FB_SQLDatabase. The function block FB_SQLCommand only uses the database connection it was assigned via the Create Cmd method. Several instances of the function block FB_SQLCommand can be initialized with the same database connection. The initialization of the function block FB_SQLCommand is completed in the same cycle. This means that neither the Busy flag of the function block nor the method return value of the Create Cmd method have to be checked. Syntax METHOD Create Cmd : BOOL VAR_INPUT p SQLCommand: POINTER TO FB_SQLCommand; END_VAR Inputs Name Type Description p SQLCommand POINTER TO FB_SQLCommand Returns a new instance of the function block FB_SQLCommand. Return value Name Type Description Create Cmd BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Sql Database : FB_SQLDatabase Evt(s Net ID := '', t Timeout := T#5S); END_VAR // create a command reference IF fb Sql Database. Create Cmd(ADR(fb Sql Command)) THEN IF fb Sql Database.b Error THEN n State := 255; ELSE n State := n State+1; END_IF END_IF FB_SQLCommand Evt [} 197] can then be used for the execution. 6.1.4.3.2.3 Create SP This method is used to initialize an instance of the function block FB_SQLStored Procedure with the already open database connection of the function block FB_SQLDatabase. The function block FB_SQLStored Procedure only uses the database connection it was assigned via the Create Cmd method. Several instances of the function block FB_SQLStored Procedure can be initialized with the same database connection. The initialization of the function block FB_SQLStored Procedure may take several cycles. The Busy flag of the function block or the method return value of the Create Cmd method have to be checked before the function block can be used. 282 Version: 1.13.8 TF6420
## Page 283

PLC API Syntax METHOD Create SP : BOOL VAR_INPUT s Procedure Name: T_Max String; p Parameter Info: POINTER TO ARRAY [0.. MAX_SPPARAMETER] OF ST_SQLSPParameter; cb Parameter Info: UDINT; p SQLProcedure: POINTER TO FB_SQLStored Procedure; END_VAR Inputs Name Type Description s Procedure Name T_Max String Indicates the name of the procedure to be executed. p Parameter Info POINTER TO ARRAY [0.. MAX_SPPAR Pointer address for the parameter info list. AMETER] OF ST_SQLSPParameter cb Parameter Info UDINT Indicates the length of the parameter info list. p SQLProcedure POINTER TO FB_SQLStored Procedure Returns a new instance of the function block FB_SQLStored Procedure. Return value Name Type Description Create SP BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Sql Database : FB_SQLDatabase Evt(s Net ID := '', t Timeout := T#5S); Para Info : ST_SQLSPParameter; END_VAR Para Info.s Parameter Name := '@Customer_ID'; Para Info.e Parameter Type := E_SPParameter Type. Input; Para Info.e Parameter Data Type := E_Column Type. Big Int; Para Info.n Parameter Size := 8; IF fb SQLDatabase. Create SP('dbo. SP_Get Customer Positions', ADR(Para Info), SIZEOF(Para Info), ADR(fb SQLS tored Procedure)) THEN IF fb SQLDatabase.b Error THEN n State:=255; ELSE n State:= n State+1; END_IF END_IF Subsequently, the FB_SQLStored Procedure Evt [} 202] can be used to execute the stored procedure. 6.1.4.3.2.4 Disconnect This method closes the connection to the database that was opened by this function block instance. Syntax METHOD Disconnect : BOOL Return value Name Type Description Disconnect BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. TF6420 Version: 1.13.8 283
## Page 284

PLC API Sample VAR fb Sql Database : FB_SQLDatabase Evt(s Net ID := '', t Timeout := T#5S); END_VAR // disconnect from database IF fb Sql Database. Disconnect() THEN IF fb Sql Database.b Error THEN n State := 255; ELSE n State := n State+1; END_IF END_IF 6.1.4.3.3 FB_SQLCommand Function block for executing SQL commands. Before it can be used it has to be initialized with the function block FB_SQLDatabase. Syntax Definition: FUNCTION BLOCK FB_SQLCommand VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Result Result interface with detailed information on the return Event value. 284 Version: 1.13.8 TF6420
## Page 285

PLC API Methods Name Definition loca- Description tion Execute [} 285] Local Sends the specified SQL command to the database via the database connection already opened by the function block FB_SQLDatabase. Execute Data Return Local Sends the specified SQL command to the database via the database connection already opened by the function block [} 286] FB_SQLDatabase. An instance of the function block FB_SQLResult can be transferred for reading the returned records. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.3.3.1 Execute This method sends the specified SQL command to the database via the database connection already opened by the function block FB_SQLDatabase. Syntax METHOD Execute : BOOL VAR_INPUT p SQLCmd: POINTER TO BYTE; cb SQLCmd: UDINT; END_VAR Inputs Name Type Description p SQLCmd POINTER TO BYTE Indicates the pointer address of a string variable with the SQL command to be executed. cb SQLCmd UDINT Indicates the length of a SQL command to be executed. Return value Name Type Description Execute POINTER TO BYTE Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample Uses the command created by FB_SQLDatabase Evt. Create Cmd() [} 193]. VAR fb Sql Command : FB_SQLCommand Evt(s Net ID := '', t Timeout := T#5S); tc Message : I_Tc Message; END_VAR // you can generate this with the SQL Query Editor s Cmd := 'INSERT INTO my Table_Double ( Timestamp, Name, Value) VALUES ( $'2018-01-31 14:59:27$', $'Te mperature$', 21.3)'; // call sql command IF fb SQLCommand. Execute(ADR(s Cmd), SIZEOF(s Cmd)) THEN IF fb SQLCommand.b Error THEN tc Message := fb SQLCommand.ip Tc Result; n State := 255; ELSE TF6420 Version: 1.13.8 285
## Page 286

PLC API n State := n State+1; END_IF END_IF 6.1.4.3.3.2 Execute Data Return This method sends the specified SQL command to the database via the database connection already opened by the function block FB_SQLDatabase. An instance of the function block FB_SQLResult can be transferred for reading the returned records. Syntax METHOD Execute Data Return : BOOL VAR_INPUT p SQLCmd: POINTER TO BYTE; cb SQLCmd: UDINT; p SQLDBResult: POINTER TO FB_SQLResult; END_VAR Inputs Name Type Description p SQLCmd POINTER TO BYTE Indicates the pointer address of a string variable with the SQL command to be executed. cb SQLCmd UDINT Indicates the length of a SQL command to be executed. p SQLDBResult POINTER TO FB_SQLResult Returns a new instance of the function block FB_SQLResult. [} 286] Return value Name Type Description Execute Data Return POINTER TO BYTE Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample Uses the command created by FB_SQLDatabase Evt. Create Cmd() [} 193]. VAR fb Sql Command : FB_SQLCommand Evt(s Net ID := '', t Timeout := T#5S); tc Message : I_Tc Message; END_VAR // you can generate this with the SQL Query Editor s Cmd := 'SELECT ID, Timestamp, Name, Value FROM my Table_Double'; // call sql command IF fb SQLCommand. Execute Data Return(ADR(s Cmd), SIZEOF(s Cmd), ADR(fb Sql Result)) THEN IF fb SQLCommand.b Error THEN n State := 255; ELSE tc Message := fb SQLCommand.ip Tc Result; n State := n State+1; END_IF END_IF FB_SQLResult Evt [} 200] can then be used to read the data. 6.1.4.3.4 FB_SQLResult 286 Version: 1.13.8 TF6420
## Page 287

PLC API The function block is used for reading the cached records. Syntax Definition: FUNCTION BLOCK FB_SQLResult VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc Res Result interface with detailed information on the return value. ult Event Methods Name Definition loca- Description tion Read [} 287] Local Reads a specified number of records from the result data cached in the Twin CAT Database Server. Release [} 288] Local Releases data buffered by the Twin CAT Database Server. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.3.4.1 Read This method reads a specified number of records from the result data cached in the Twin CAT Database Server. Syntax METHOD Read : BOOL VAR_INPUT n Start Index: UDINT := 0; n Record Count: UDINT := 1; p Data: POINTER TO BYTE; cb Data: UDINT; b With Verifying: BOOL := FALSE; b Data Release: BOOL := TRUE; END_VAR TF6420 Version: 1.13.8 287
## Page 288

PLC API Inputs Name Type Description n Start Index UDINT Indicates the index of the first record to be read. n Record Count UDINT Indicates the number of records to be read. p Data POINTER TO BYTE Address of the structure array into which the records are to be written. cb Data UDINT Indicates the size of the structure array in bytes. b With Verifying BOOL Return data are compared with the p Data structure array and adjusted if necessary. b Data Release BOOL Releases the cached data. Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample VAR fb Sql Result : FB_SQLResult Evt(s Net ID:='', t Timeout := T#5S); a Read Struct : ARRAY[1..5] OF ST_Standard Record; END_VAR // get values from internal tc db srv storage IF fb Sql Result. Read(2, 3, ADR(a Read Struct), SIZEOF(a Read Struct), FALSE, TRUE) THEN IF fb Sql Result.b Error THEN n State := 255; ELSE n State := n State+1; END_IF END_IF Result in the PLC: 6.1.4.3.4.2 Release This method can be used to release data cached by the Twin CAT Database Server. Syntax METHOD Release : BOOL 288 Version: 1.13.8 TF6420
## Page 289

PLC API Return value Name Type Description Release BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. 6.1.4.3.5 FB_SQLStored Procedure Function block for executing stored procedures of the database. Before it can be used it has to be initialized with the function block "FB_SQLDatabase". Syntax Definition: FUNCTION BLOCK FB_SQLStored Procedure VAR_INPUT s Net ID: T_Ams Net ID := ''; t Timeout: TIME := T#5S; END_VAR VAR_OUTPUT b Busy: BOOL; b Error: BOOL; ip Tc Result Event: Tc3_Event Logger. I_Tc Result Event; END_VAR Inputs Name Type Description s Net ID T_Ams Net ID AMS network ID of the target device at which the ADS command is directed. t Timeout TIME Indicates the time before the function is cancelled. Outputs Name Type Description b Busy BOOL TRUE as soon as a method of the function block is active. b Error BOOL TRUE when an error occurs. ip Tc Result Event Tc3_Event Logger. I_Tc R Result interface with detailed information on the return value. esult Event TF6420 Version: 1.13.8 289
## Page 290

PLC API Methods Name Definition loca- Description tion Execute [} 290] Local Sends the call of the specified stored procedure to the database via the database connection already opened by the function block FB_SQLDatabase. Execute Data Return Local Sends the call of the specified stored procedure to the database via the database connection already opened by the [} 291] function block FB_SQLDatabase. An instance of the FB_SQLResult function block can be transferred for reading the returned records. Release [} 291] Local Releases the parameter information of the stored procedure that was transferred during initialization. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.1 Build 4020.10 PC or CX (x86) Tc3_Database 6.1.4.3.5.1 Execute This method sends the call of the specified stored procedure to the database via the database connection already opened by the function block FB_SQLDatabase. Syntax METHOD Execute : BOOL VAR_INPUT p Parameter Strc: POINTER TO BYTE; cb Parameter Strc: UDINT; END_VAR Inputs Name Type Description p Parameter Strc POINTER TO BYTE Pointer address to the parameter structure that is transferred to the procedure. cb Parameter Strc UDINT Length of the parameter structure Return value Name Type Description Execute BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample Uses the stored procedure previously created with FB_SQLDatabase Evt. Create SP() [} 193]. VAR fb SQLStored Procedure : FB_SQLStored Procedure Evt(s Net ID:='', t Timeout := T#5S); Customer_ID : LINT; tc Message : I_Tc Message; END_VAR IF fb SQLStored Procedure. Execute(p Parameter Strc := ADR(Customer_ID) , cb Parameter Strc:= SIZEOF(Custom er_ID)) THEN IF fb SQLStored Procedure.b Error THEN tc Message := fb SQLStored Procedure.ip Tc Result; n State := 255; ELSE 290 Version: 1.13.8 TF6420
## Page 291

PLC API n State := n State+1; END_IF END_IF 6.1.4.3.5.2 Execute Data Return This method sends the call of the specified stored procedure to the database via the database connection already opened by the function block FB_SQLDatabase. An instance of the FB_SQLResult function block can be transferred for reading the returned records. Syntax METHOD Execute Data Return : BOOL VAR_INPUT p Parameter Strc: POINTER TO BYTE; cb Parameter Strc: UDINT; p SQLDBResult: POINTER TO FB_SQLDBResult; END_VAR Inputs Name Type Description p Parameter Strc POINTER TO BYTE Pointer address to the parameter structure that is transferred to the procedure. cb Parameter Strc UDINT Length of the parameter structure p SQLDBResult POINTER TO FB_SQL Returns a new instance of the function block FB_SQLDBResult. DBResult Return value Name Type Description Read BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. Sample Uses the stored procedure previously created with FB_SQLDatabase Evt. Create SP() [} 193]. VAR fb SQLStored Procedure : FB_SQLStored Procedure Evt(s Net ID:='', t Timeout := T#5S); Customer_ID : LINT; tc Message : I_Tc Message; END_VAR IF fb SQLStored Procedure. Execute Data Return(p Parameter Strc := ADR(Customer_ID), cb Parameter Strc:= SIZE OF(Customer_ID), p SQLDBResult := ADR(fb Sql Result)) THEN IF fb SQLStored Procedure.b Error THEN tc Message := fb SQLStored Procedure.ip Tc Result; n State := 255; ELSE n State := n State+1; END_IF END_IF FB_SQLResult Evt [} 200] can then be used to read the data. 6.1.4.3.5.3 Release This method releases the parameter information of the stored procedure, which was transferred during initialization. Syntax METHOD Release : BOOL TF6420 Version: 1.13.8 291
## Page 292

PLC API Return value Name Type Description Release BOOL Displays the status of the method. Returns TRUE as soon as the method execution is finished, even in the event of an error. 6.2 Tc2_Database Overview The Tc2_Database library contains function blocks for controlling and configuring the Twin CAT 3 database server. 292 Version: 1.13.8 TF6420
## Page 293

PLC API Function blocks Name Description FB_Get State Tc Database [} 294] Retrieves status information. FB_DBConnection Add [} 296] Adds database connections to the XML configuration file. FB_DBAuthentification Add [} 315] Adds authentication information for the respective database connection to the XML configuration file. FB_DBOdbc Connection Add [} 297] Adds an ODBC database connection to the XML configuration file. FB_Ads Device Connection Add [} 299] Adds an ADS device to the XML configuration file. FB_DBReload Config [} 295] Reloads the XML configuration file FB_Get DBXMLConfig [} 300] Reads all database configurations from the XML configuration file. FB_Get Ads Dev XMLConfig [} 300] Reads all ADS device configurations from the XML configuration file. FB_DBConnection Open [} 301] Opens a connection to a database. FB_DBConnection Close [} 302] Closes a connection to a database. FB_DBCreate [} 303] Creates a new database FB_DBTable Create [} 304] Creates a table with any desired table structure FB_DBRead [} 306] Reads one value out of the database FB_DBWrite [} 307] Writes one variable value, with timestamp, into a database FB_DBCyclic Rd Wrt [} 305] Starts or stops the logging/writing of variables FB_DBRecord Select [} 317] Reads a data record out of a table FB_DBRecord Select_EX [} 319] Reads a data record out of a table (command length less than 10,000 characters) FB_DBRecord Array Select [} 310] Reads several records from a table. FB_DBRecord Insert [} 316] Creates a new data record. FB_DBRecord Insert_EX [} 309] Creates a new data record. (command length less than 10,000 characters) FB_DBRecord Delete [} 308] Deletes a record from a table. FB_DBStored Procedures [} 313] Executes a stored procedure. FB_DBStored Procedures Record Return [} 320] Executes a stored procedure and returns a record. FB_DBStored Procedures Record Array [} 314] Executes a stored procedure and returns several records. TF6420 Version: 1.13.8 293
## Page 294

PLC API Data Types Name ST_DBColumn Cfg [} 321] ST_DBXMLCfg [} 321] ST_ADSDev XMLCfg [} 322] ST_DBSQLError [} 322] ST_DBParameter [} 322] E_Db Column Types [} 323] E_DBTypes [} 324] E_DBValue Type [} 324] E_DBWrite Modes [} 324] E_DBParameter Types [} 324] Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1 Function blocks 6.2.1.1 FB_Get State Tc Database The FB_Get State Tc Database function block can be used to query the current status of the database server. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. b Execute: The command is executed with the rising edge. t Timeout: Indicates the timeout time. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; n Ads State : UINT; n Dev State : UINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. 294 Version: 1.13.8 TF6420
## Page 295

PLC API b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. n Ads State: Contains the state identification code of the ADS target device. The codes returned here are specified for all ADS servers: • ADSSTATE_INVALID =0 ; • ADSSTATE_IDLE =1 ; • ADSSTATE_RESET =2 ; • ADSSTATE_INIT =3 ; • ADSSTATE_START =4 ; • ADSSTATE_RUN =5 ; • ADSSTATE_STOP =6 ; • ADSSTATE_SAVECFG =7 ; • ADSSTATE_LOADCFG =8 ; • ADSSTATE_POWERFAILURE =9 ; • ADSSTATE_POWERGOOD =10 ; • ADSSTATE_ERROR =11; n Dev State: Contains the specific state identification code of the ADS target device. The codes returned here are supplementary information specific to the ADS device. • 1 = Twin CAT Database Server started • 2 = cyclic reading or writing started Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.2 FB_DBReload Config The XML configuration file can be reloaded using the FB_DBReload Config function block. If changes have been made to the XML configuration file, the changes must be made known to the Database Server using FB_DBReload Config. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. b Execute: The command is executed with a rising edge. t Timeout: States the length of the timeout that may not be exceeded by execution of the ADS command. TF6420 Version: 1.13.8 295
## Page 296

PLC API VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.3 FB_DBConnection Add The FB_DBConnection Add function block permits additional database connections to be added to the XML configuration file. VAR_INPUT VAR_INPUT s Net ID :T_Ams Net Id; e DBType :E_DBTypes; e DBValue Type :E_DBValue Type; s DBServer :T_Max String; s DBProvider :T_Max String; s DBUrl :T_Max String; s DBSystem DB :T_Max String; s DBUser Id :T_Max String; s DBPassword :T_Max String; s DBTable :T_Max String; b Execute :BOOL; t Timeout :TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. e DBType: Indicates the type of the database, e.g. 'Mobile server'. e DBValue Type: Indicates the form in which the values are or will be stored. s DBServer: Provides the name of the server: Optional. s DBProvider: Gives the provider of the database: Optional. s DBUrl: Gives the path to the database. 296 Version: 1.13.8 TF6420
## Page 297

PLC API s System DB: Only for Access databases. Indicates the path to the MDW file. s User Id: Indicates the login user name. s Password: Indicates the password. s DBTable: Gives the name of the table into which the values are to be written. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; b Err ID : UDINT; h DBID : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. h DBID: Returns the ID of the database. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.4 FB_DBOdbc Connection Add The FB_DBOdbc Connection Add function block can be used to add further ODBC database connections to the XML configuration file. VAR_INPUT VAR_INPUT s Net ID :T_Ams Net Id; e DBType :E_DBTypes; e DBValue Type :E_DBValue Type; s DBDriver :T_Max String; s DBServer :T_Max String; TF6420 Version: 1.13.8 297
## Page 298

PLC API s DBDatabase :T_Max String; n DBPort :UDINT; s DBProtocol :T_Max String; s DBUser Id :T_Max String; s DBPassword :T_Max String; s DBScheme :T_Max String; s DBSequence :T_Max String; s DBClient Dll :T_Max String; s DBTable :T_Max String; b Execute :BOOL; t Timeout :TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. e DBType: Indicates the type of the database, e.g. 'Mobile server'. e DBValue Type: Indicates the form in which the values are or will be stored. s DBDriver: Indicates the name of the ODBC driver to be used. s DBServer: Indicates the name of the server. s DBDatabase: Indicates the name of the database. n DBPort: Indicates the port for the ODBC connection. s DBProtocol: Indicates the protocol to be used (TCPIP). s DBUser Id: Indicates the user name. s DBPassword: Indicates the password to be used. s DBScheme: Indicates the database schema to be used. s DBSequence: Indicates the sequence name for Oracle databases. s DBClient Dll: Contains the path to fbclient.dll. (Only for Firebird/Interbase databases) s DBTable: Gives the name of the table into which the values are to be written. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; b Err ID : UDINT; h DBID : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. h DBID: Returns the ID of the database. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 298 Version: 1.13.8 TF6420
## Page 299

PLC API 6.2.1.5 FB_Ads Device Connection Add Ads Devices can be declared in the XML configuration file using the FB_Ads Device Connection Add function block. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID; s ADSDev Net ID : T_Ams Net ID; n ADSDev Port : UINT; t ADSDev Timeout : TIME; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. s ADSDev Net ID: String containing the AMS network ID of the ADS device. n ADSDev Port: Indicates the port of the ADS device. t Ads Dev Timeout: Indicates the timeout time of the ADS device. b Execute: The command is executed with a rising edge. t Timeout: Indicates the duration of the timeout. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; h Ads Id : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. h Ads Id: Returns the ID of the ADS device. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database TF6420 Version: 1.13.8 299
## Page 300

PLC API 6.2.1.6 FB_Get DBXMLConfig The FB_Get DBXMLConfig function block can be used to read all databases that are declared in the XML configuration file. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; cb DBCfg : UDINT; p DBCfg : POINTER TO ARRAY [0.. MAX_XML_DECLARATIONS] OF ST_DBXMLCfg; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. cb DBCfg: Indicates the length of the array, into which the configurations are to be written. p DBCfg: Indicates the pointer address of the array, into which the configurations are to be written. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.7 FB_Get Ads Dev XMLConfig The FB_Get Ads Dev XMLConfig function block can be used to read all ADS devices that are declared in the XML configuration file. 300 Version: 1.13.8 TF6420
## Page 301

PLC API VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; cb Ads Dev Cfg : UDINT; p Ads Dev Cfg : POINTER TO ARRAY [0.. MAX_XML_DECLARATIONS] OF ST_ADSDev XMLCfg; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. cb Ads Dev Cfg: Indicates the length of the array, into which the configurations are to be written. p Ads Dev Cfg: Indicates the pointer address of the array, into which the configurations are to be written. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.8 FB_DBConnection Open The FB_DBConnection Open function block can be used to open connections to databases. This can accelerate the read/write access with the function blocks FB_DBWrite, FB_DBRead, FB_DBRecord Insert and FB_FBRecord Select. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; h DBID : DINT; b Execute: BOOL; t Timeout: TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. TF6420 Version: 1.13.8 301
## Page 302

PLC API VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState : Returns the SQL error code [} 322] of the corresponding database type Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.9 FB_DBConnection Close The FB_DBConnection Close function block can be used to close connections to databases. If a connection with a database was opened previously, it must be closed again. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; h DBID : DINT; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error: BOOL; n Err ID: UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. 302 Version: 1.13.8 TF6420
## Page 303

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.10 FB_DBCreate The FB_DBCreate function block allows databases to be created. The following databases can be created with this function block: MS SQL databases, MS SQL Compact databases, MS Access databases and XML databases ASCII files can (but do not have to) be created with the FB_DBCreate function block. If they do not exist, they are created automatically during the first write access. They only have to be declared in the XML configuration file. It is not possible to create DB2, Oracle, My SQL, Postgre SQL, Inter Base and Firebird databases. In addition, it is not possible to overwrite existing databases. In this case the FB_DBCreate function block would return an error. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID; s Path Name : T_Max String; s DBName : T_Max String; e DBType : E_DBTypes; s System DB : T_Max String; s User ID : T_Max String; s Password : T_Max String; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. s Path Name: Gives the path to the database. s DBName: Gives the name of the database that is to be created. e DBType: Gives the type of the database that is to be created. s System DB: Only for Access databases. Contains the path to the MDW file. s User ID: User name for the corresponding registration s Password: Corresponding password b Execute: The command is executed with a rising edge. t Timeout: Indicates the duration of the timeout. TF6420 Version: 1.13.8 303
## Page 304

PLC API VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. Twin CAT Database Server If the newly created databases are to be used by the Twin CAT Database Server, the connection data have to be written to the XML configuration file with the aid of the FB_DBConnection ADD function block. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.11 FB_DBTable Create The FB_DBTable Create function block can be used to create tables of any structure in databases. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID; h DBID : UDINT; s Table Name : T_Max String; cb Table Cfg : UDINT; p Table Cfg : POINTER TO ARRAY[0.. MAX_DB_TABLE_COLUMNS] OF ST_DBColumn Cfg; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: ID of the database to be used. s Table Name: Provides the name of the table. cb Table Cfg: Returns the length of the array in which the columns are configured. p Table Cfg: Provides the pointer address of the table structure array. The individual columns are written in this array. b Execute: The command is executed with a rising edge. t Timeout: Indicates the duration of the timeout. 304 Version: 1.13.8 TF6420
## Page 305

PLC API VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.12 FB_DBCyclic Rd Wrt The FB_DBCyclic Rd Wrt function block can be used to start or stop the cyclic logging \ writing of variables. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; b Execute: BOOL; t Timeout: TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. b Execute: The read/write cycle is started with a rising edge and stopped with a falling edge. t Timeout: States the length of the timeout that may not be exceeded by execution of the ADS command. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type TF6420 Version: 1.13.8 305
## Page 306

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.13 FB_DBRead The FB_DBRead function block allows values to be read from a database. The function block searches for the specified s DBVar Name in the "Name" column of the database table and then outputs the corresponding value from the "Value" column. If the searched s DBVar Name exists several times in the database table, the first record found is output. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; h DBID : DINT; s DBVar Name: STRING(80); cb Read Len : UDINT; p Dest Addr : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. s DBVar Name: Gives the name of the variable that is to be read. cb Read Len: Indicates the length of the buffer that is to be read. p Dest Addr: Contains the address of the buffer which is to receive the data that has been read. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type 306 Version: 1.13.8 TF6420
## Page 307

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.14 FB_DBWrite The FB_DBWrite function block can be used to write the values of individual variables to databases. The table structure must have the columns "Timestamp", "Name" and "Value" (see "SQL Compact Database" [} 128]). To use the function block, the database to which the variable is to be written and the ADS device from which the variable is to be read must be declared in the XML configuration file. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID; h DBID : UDINT; h Ads ID : UDINT; s Var Name : T_Max String; n IGroup : UDINT; n IOffset : UDINT; n Var Size : UDINT; s Var Type : T_Max String; s DBVar Name : T_Max String; e DBWrite Mode : E_DBWrite Modes; t Ring Buffer Time : TIME; n Ring Buffer Count: UDINT; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: ID of the database to be used. h Ads ID: ID of the ADS device to be used. s Var Name: Provides the name of the variable. n IGroup: Index group of the variable (optional, only on the BC9000). n IOffset: Index offset of the variable (optional, only on the BC9000). n Var Size: Size of the variable in bytes (optional, only on the BC9000). s Var Type: Data type of the variable (optional, only on the BC9000). Possible variable data types: "BOOL" / "LREAL" / "REAL" / "INT16" / "DINT" / "USINT" / "BYTE" / "UDINT" / "DWORD" / "UINT16" / "WORD" / "SINT" s DBVar Name: Variable name to be used in the database. TF6420 Version: 1.13.8 307
## Page 308

PLC API e DBWrite Mode: Indicates whether the values are to be appended in new records or whether the existing records are to be updated. t Ring Buffer Time: Indicates the maximum age of records in a table (only for Ringbuffer_Write Mode). n Ring Buffer Count: Indicates the maximum number of records in a table (only for Ringbuffer_Write Mode). b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type Log values of ADS devices (except BC9000) Log values of BC9000 FB_DBWrite1( FB_DBWrite1( s Net ID:= , h DBID:= 1, h Ads ID:= 1, s Net ID:= , s Var Name:= 'MAIN. Test Var', n IGroup:= 16448, h DBID:= 1, n IOffset:= 0, n Var Size:= 16, s Var Type:= 'REAL', h Ads ID:= 1, s DBVar Name:= 'DBTest Var', e DBWrite Mode:= s Var Name:= 'MAIN. Test Var', e DBWrite Mode_Append, b Execute:= TRUE, s DBVar Name:= 'DBTest Var', t Timeout:= T#15s, b Busy=> busy, b Error=> err, e DBWrite Mode:= e DBWrite Mode_Append, n Err ID=> errid, s SQLState=> sqlstate); b Execute:= TRUE, t Timeout:= T#15s, b Busy=> busy, b Error=> err, n Err ID=> errid, s SQLState=> sqlstate ); Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.15 FB_DBRecord Delete 308 Version: 1.13.8 TF6420
## Page 309

PLC API The FB_DBRecord Delete function block can be used to delete individual records from a database. This function block allows SQL DELETE commands with up to 10,000 characters to be executed. To use the function block, the database from which records are to be deleted must be declared in the XML configuration file. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; h DBID : UDINT; cb Cmd Size: UDINT; p Cmd Addr : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. cb Cmd Size: Indicates the length of the INSERT command. p Cmd Addr: Pointer to the executing INSERT command. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.16 FB_DBRecord Insert_EX The FB_DBRecord Insert_EX function block can be used to write individual records with any structure into a database. This function block allows SQL INSERT commands with up to 10,000 characters to be executed. To use the function block, the database to which the data is to be written must be declared in the XML configuration file. TF6420 Version: 1.13.8 309
## Page 310

PLC API VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; h DBID : UDINT; cb Cmd Size: UDINT; p Cmd Addr : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. cb Cmd Size: Indicates the length of the INSERT command. p Cmd Addr: Pointer to the executing INSERT command b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.17 FB_DBRecord Array Select The FB_DBRecord Array Select function block can be used to read several records with any structure from the database. This function block allows SQL SELECT commands with up to 10,000 characters to be executed. This function block is not compatible with ASCII files. 310 Version: 1.13.8 TF6420
## Page 311

PLC API VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID; h DBID : UDINT; cb Cmd Size : UDINT; p Cmd Addr : UDINT; n Start Index : UDINT; n Record Count : UDINT; cb Record Array Size: UDINT; p Dest Addr : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. cb Cmd Size: Indicates the length of a SELECT command to be executed. p Cmd Size: Indicates the pointer address of a string variable with the SQL command to be executed. n Start Index: Indicates the index of the first record to be read. n Record Count: Indicates the number of records to be read. cb Record Array Size: Indicates the size of the structure array in bytes. p Dest Addr: Indicates the address of the structure array into which the records are to be written. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; n Records : UDINT; END_VAR ST_DBSQLError [} 322] b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code of the corresponding database type n Records: Returns the number of data records. Sample in ST Since the table, from which the records are to be read, has the structure below, a PLC structure with a similar structure must be created. Table: Column name Data Type ID BIGINT Timestamp DATETIME Name NVARCHAR(80) Value FLOAT TF6420 Version: 1.13.8 311
## Page 312

PLC API Structure: TYPE ST_Record: STRUCT ID : T_ULARGE_INTEGER; Timestamp: DT; Name : STRING(80); VALUE : LREAL; END_STRUCT END_TYPE The Tc Utilities.lib library must be integrated in order to use the T_ULARGE_INTEGER data type. For Arm® processors the data types have to be arranged differently due to the byte alignment, and a "dummy byte" has to be added. TYPE ST_Record : STRUCT ID : T_ULARGE_INTEGER; Timestamp: DT; Value : LREAL; Name : STRING(80); Dummy : BYTE; END_STRUCT END_TYPE PROGRAM MAIN VAR FB_DBRecord Array Select1 : FB_DBRecord Array Select; cmd : T_Maxstring := 'SELECT * FROM my Table'; (* Unter ARM*) (*cmd : T_Maxstring := 'SELECT ID,Timestamp,Value,Name FROM my Table'*) (*----------*) record Array : ARRAY [1..5] OF ST_Record; busy : BOOL; err : BOOL; errid : UDINT; sqlstate : ST_DBSQLError; rec Anz : UDINT; END_VAR PLC program FB_DBRecord Array Select1( s Net ID:= , h DBID:= 1, cb Cmd Size:= SIZEOF(cmd), p Cmd Addr:= ADR(cmd), n Start Index:= 0, n Record Count:= 5, cb Record Array Size:= SIZEOF(record Array), p Dest Addr:= ADR(record Array), b Execute:= TRUE, t Timeout:= T#15s, b Busy=> busy, b Error=> err, n Err ID=> errid, s SQLState=> sqlstate, n Records=> rec Anz); Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 312 Version: 1.13.8 TF6420
## Page 313

PLC API 6.2.1.18 FB_DBStored Procedures The FB_DBStored Procedures function block can be used to call stored procedures. Parameters can be transferred that are used in the stored procedures. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID :=''; h DBID : UDINT :=1; s Procedure Name : T_Max String :=''; cb Parameter List: UDINT; p Parameter List : POINTER TO ARRAY[0.. MAX_STORED_PROCEDURES_PARAMETERS] OF ST_DBParameter; b Execute : BOOL; t Timeout : TIME := T#15s; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. s Procedure Name: Indicates the name of the procedure to be executed cb Parameter List: Indicates the length of the parameter list. p Parameter List: Contains the address of the parameter list b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database TF6420 Version: 1.13.8 313
## Page 314

PLC API 6.2.1.19 FB_DBStored Procedures Record Array The FB_DBStored Procedures Record Array function block can be used to call stored procedures that return records. In contrast to the FB_DBStored Procedures Record Return function block, this function block can be used to return several records with a single call. Parameters can be transferred that are used in the stored procedures. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID :=''; h DBID : UDINT :=1; s Procedure Name : T_Max String :=''; cb Parameter List : UDINT; p Parameter List : POINTER TO ARRAY[0.. MAX_STORED_PROCEDURES_PARAMETERS] OF ST_DBParameter; n Start Index : UDINT; n Record Count : UDINT cb Record Array Size: UDINT; p Des Addr : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME := T#15s; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. s Procedure Name: Indicates the name of the procedure to be executed. cb Parameter List: Indicates the length of the parameter list. p Parameter List: Contains the address of the parameter list n Start Index: Indicates the index of the first record to be read. n Record Count: Indicates the number of records to be read. cb Record Array Size: Indicates the size of the structure array in bytes. p Dest Addr: Indicates the address of the structure array into which the records are to be written. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; n Records : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as "b Busy" remains TRUE. 314 Version: 1.13.8 TF6420
## Page 315

PLC API b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type n Records: Returns the number of data records. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.20 Obsolete 6.2.1.20.1 FB_DBAuthentification Add The FB_DBAuthentification Add function block can be used to add authentication information to already declared databases or to overwrite existing authentication information. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID; h DBID : DINT; s DBSystem DB: T_Max String; s DBUser Id : T_Max String; s DBPassword: T_Max String; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Is the ID of the database to be used. s System DB: Only for Access databases. Indicates the path to the MDW file. s User Id: Indicates the login user name. s Password: Indicates the password. b Execute: The command is executed with a rising edge. t Timeout: Indicates the duration of the timeout. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error: BOOL; n Err ID: UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as "b Busy" remains TRUE. TF6420 Version: 1.13.8 315
## Page 316

PLC API b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code if the b Error output is set. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.20.2 FB_DBRecord Insert The FB_DBRecord Insert function block can be used to write individual records with any structure into a database. To use the function block it is necessary to declare the database to which the records are to be written in the XML configuration file. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net Id; h DBID : UDINT; s Insert Cmd: T_Max String; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. s Insert Cmd: Indicates which INSERT command is to be executed. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 316 Version: 1.13.8 TF6420
## Page 317

PLC API 6.2.1.20.3 FB_DBRecord Select The FB_DBRecord Select function block can be used to read individual records with any structure from a database. This function block is not compatible with ASCII files. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID; h DBID : UDINT; s Select Cmd : T_Max String; n Record Index: UDINT; cb Record Size: UDINT; p Dest Addr : DWORD; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. s Select Cmd: Indicates which SELECT command is to be executed. n Record Index: Gives the index of the data record that is to be read. cb Record Size: Provides the size of a data record in bytes. p Dest Addr: Indicates the address of the structure to which the record is to be written. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; n Records : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type n Records: Returns the number of data records. TF6420 Version: 1.13.8 317
## Page 318

PLC API Sample in ST: Since the table, from which a record is to be read, has the structure below, a PLC structure with a similar structure must be created. Table: Column name Data Type ID BIGINT Timestamp DATETIME Name NTEXT Value FLOAT Structure: TYPE ST_Record : STRUCT ID : T_ULARGE_INTEGER; Timestamp: DT; Name : STRING; VALUE : LREAL; END_STRUCT END_TYPE The Tc Utilities.lib library must be integrated in order to use the T_ULARGE_INTEGER data type. For Arm® processors the data types have to be arranged differently due to the byte alignment, and a "dummy BYTE" has to be added. TYPE ST_Record : STRUCT ID : T_ULARGE_INTEGER; Timestamp: DT; Value : LREAL; Name : STRING; Dummy : BYTE; END_STRUCT END_TYPE PROGRAM MAIN VAR FB_DBRecord Select1: FB_DBRecord Select; cmd : T_Maxstring := 'SELECT * FROM my Table'; (* Unter ARM*) (*cmd : T_Maxstring := 'SELECT ID,Timestamp,Value,Name FROM my Table'*) (*----------*) record : ST_Record; busy : BOOL; err : BOOL; errid : UDINT; rec Anz : DINT; END_VAR PLC program FB_DBRecord Select1( s Net ID := , h DBID := 2, s Select Cmd := cmd, n Record Index:= 0, cb Record Size:= SIZEOF(record), p Dest Addr := ADR(record), b Execute := TRUE, t Timeout := T#15s, b Busy => busy, b Error => err, n Err ID => errid, n Records => rec Anz); Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 318 Version: 1.13.8 TF6420
## Page 319

PLC API 6.2.1.20.4 FB_DBRecord Select_EX The FB_DBRecord Select_EX function block can be used to read individual records with any structure from the database. This function block allows SQL SELECT commands with up to 10000 characters to be executed. This function block is not compatible with ASCII files. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID; Hdbid : UDINT; cb Cmd Size : UDINT; p Cmd Addr : UDINT; n Record Index: UDINT; cb Record Size: UDINT; p Dest Addr : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. cb Cmd Size: Indicates the length of a SELECT command to be executed. p Cmd Size: Indicates the pointer address of a string variable with the SQL command to be executed. n Record Index: Gives the index of the data record that is to be read. cb Record Size: Provides the size of a data record in bytes. p Dest Addr: Indicates the address of the structure to which the record is to be written. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; n Records : UDINT; END_VAR b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type TF6420 Version: 1.13.8 319
## Page 320

PLC API n Records: Returns the number of data records. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.1.20.5 FB_DBStored Procedures Record Return The FB_DBStored Procedures Record Return function block can be used to call stored procedures that return a record. Parameters can be transferred that are used in the stored procedures. VAR_INPUT VAR_INPUT s Net ID : T_Ams Net ID :=''; h DBID : UDINT :=1; s Procedure Name : T_Max String :=''; cb Parameter List: UDINT; p Parameter List : POINTER TO ARRAY[0.. MAX_STORED_PROCEDURES_PARAMETERS] OF ST_DBParameter; n Record Index : UDINT; cb Record Size : UDINT; p Record Addr : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME := T#15s; END_VAR s Net ID: String containing the AMS network ID of the target device, at which the ADS command is directed. h DBID: Indicates the ID of the database to be used. s Procedure Name: Indicates the name of the procedure to be executed. cb Parameter List: Indicates the length of the parameter list. p Parameter List: Contains the address of the parameter list n Record Index: Gives the index of the data record that is to be read. cb Record Size: Provides the size of a data record in bytes. p Record Addr: Indicates the address of the structure to which the record is to be written. b Execute: The command is executed with a rising edge. t Timeout: Indicates the time before the function is cancelled. VAR_OUTPUT VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s SQLState: ST_DBSQLError; n Records : UDINT; END_VAR 320 Version: 1.13.8 TF6420
## Page 321

PLC API b Busy: The command is in the process of being transmitted by ADS. No new command will be accepted as long as b Busy remains TRUE. b Error: Becomes TRUE, as soon as an error occurs. n Err ID: Returns the ADS error code or Tc Database Srv_Error_Codes [} 399] if the b Error output is set. s SQLState: Returns the SQL error code [} 322] of the corresponding database type n Records: Returns the number of data records. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2 Data types 6.2.2.1 ST_DBColumn Cfg VAR_INPUT TYPE ST_DBColumn Cfg : STRUCT s Column Name : STRING(59); s Column Property: STRING(59); e Column Type : E_Db Column Types; END_STRUCT END_TYPE s Column Name: Contains the name of the column to be created. s Column Property: Contains certain column properties. e Column Type: Gives the type of column. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2.2 ST_DBXMLCfg VAR_INPUT TYPE ST_DBXMLCfg : STRUCT s DBName : STRING; s DBTable: STRING; n DBID : DINT; e DBType : E_DBTypes; END_STRUCT END_TYPE s DBName: Contains the name of the database. s DBTable: Contains the name of the table. n DBID: Returns the ID of the database. e DBType: Gives the type of database. TF6420 Version: 1.13.8 321
## Page 322

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2.3 ST_ADSDev XMLCfg VAR_INPUT TYPE ST_ADSDev XMLCfg : STRUCT s Ads Dev Net ID : T_Ams Net ID; t Ads Dev Timeout: TIME; n Ads Dev ID : DINT; n Ads Dev Port : UINT; END_STRUCT END_TYPE s Ads Dev Net ID: String containing the AMS network ID of the ADS device. t Ads Dev Timeout: Indicates the timeout time of the ADS device. n Ads Dev ID: Returns the ID of the ADS device. n Ads Dev Port: Indicates the port of the ADS device. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2.4 ST_DBSQLError VAR_INPUT TYPE ST_DBSQLError : STRUCT s SQLState : STRING(5); n SQLError Code: DINT; END_STRUCT END_TYPE s SQLState: Contains the 5-character error code, which is based on the SQL ANSI standard. n SQLError Code: Returns a database-specific error code. If no error has occurred, the structure contains the following values: s SQLState := '00000'; n SQLError Code := 0; Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2.5 ST_DBParameter VAR_INPUT TYPE ST_DBParameter : STRUCT s Parameter Name : STRING(59); cb Parameter Value : UDINT; p Parameter Value : UDINT; e Parameter Data Type: E_DBColumn Types; 322 Version: 1.13.8 TF6420
## Page 323

PLC API e Parameter Type : E_DBParameter Types; END_STRUCT END_TYPE s Parameter Name: Indicates the name of the parameter. cb Parameter Value: Contains the size of the variable to be used in bytes. p Parameter Value: Contains the address of the variable to be used. e Parameter Data Type: Indicates the data type of the parameter (E_DBColumn Types [} 323]). e Parameter Type: Indicates the parameter type (E_DBParameter Types [} 324]). Declaration sample Variable Declaration PROGRAM MAIN VAR para List: ARRAY [0..2] OF ST_DBParameter; p1: DINT := 3; p2: LREAL; p3: STRING; END_VAR PLC program para List[0].s Parameter Name := 'p1'; para List[0].e Parameter Data Type:= e DBColumn_Integer; para List[0].e Parameter Type := e DBParameter_Input; para List[0].cb Parameter Value := SIZEOF(p1); para List[0].p Parameter Value := ADR(p1); para List[1].s Parameter Name := 'p2'; para List[1].e Parameter Data Type:= e DBColumn_Float; para List[1].e Parameter Type := e DBParameter_Output; para List[1].cb Parameter Value := SIZEOF(p2); para List[1].p Parameter Value := ADR(p1); para List[2].s Parameter Name := 'p3'; para List[2].e Parameter Data Type:= e DBColumn_NText; para List[2].e Parameter Type := e DBParameter_Output; para List[2].cb Parameter Value := SIZEOF(p3); para List[2].p Parameter Value := ADR(p3); Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2.6 E_Db Column Types TYPE E_Db Column Types : ( e DBColumn_Big Int :=0, e DBColumn_Integer :=1, e DBColumn_Small Int :=2, e DBColumn_Tiny Int :=3, e DBColumn_Bit :=4, e DBColumn_Money :=5, e DBColumn_Float :=6, e DBColumn_Real :=7, e DBColumn_Date Time :=8, e DBColumn_NText :=9, e DBColumn_NChar :=10, e DBColumn_Image :=11, e DBColumn_NVar Char :=12, e DBColumn_Binary :=13, e DBColumn_Var Binary :=14 ); END_TYPE TF6420 Version: 1.13.8 323
## Page 324

PLC API Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2.7 E_DBTypes TYPE E_DBTypes : ( e DBType_Mobile_Server := 0, e DBType_Access := 1, e DBType_Sequal_Server := 2, e DBType_ASCII := 3, e DBType_ODBC_My SQL := 4, e DBType_ODBC_Postgre SQL:= 5, e DBType_ODBC_Oracle := 6, e DBType_ODBC_DB2 := 7, e DBType_ODBC_Inter Base := 8, e DBType_ODBC_Firebird := 9, e DBType_XML := 10, e DBType_OCI_Oracle := 11 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2.8 E_DBValue Type TYPE E_DBValue Type : ( e DBValue_Double:= 0, e DBValue_Bytes := 1 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2.9 E_DBWrite Modes TYPE E_DBWrite Modes : ( e DBWrite Mode_Update := 0, e DBWrite Mode_Append := 1, e DBWrite Mode_Ring Buffer_Time := 2, e DBWrite Mode_Ring Buffer_Count:= 3 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.2.10 E_DBParameter Types TYPE E_DBParameter Types : ( e DBParameter_Input := 0, e DBParameter_Output := 1, e DBParameter_Input Output := 2, e DBParameter_Return Value := 3, 324 Version: 1.13.8 TF6420
## Page 325

PLC API e DBParameter_Oracle Cursor:= 4 ); END_TYPE Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.3 Global Constants 6.2.3.1 Constants VAR_GLOBAL_CONSTANT AMSPORT_DATABASESRV : UINT := 21372; DBADS_IGR_RELOADXML : UDINT :=16#100; DBADS_IGR_GETSTATE : UDINT :=16#200; DBADS_IGR_DBCONNOPEN : UDINT :=16#300; DBADS_IGR_DBCONNCLOSE : UDINT :=16#301; DBADS_IGR_ADSDEVCONNOPEN : UDINT :=16#302; DBADS_IGR_ADSDEVCONNCLOSE : UDINT :=16#303; DBADS_IGR_DBSTOREDPROCEDURES : UDINT :=16#400; DBADS_IGR_DBSTOREDPROCEDURES_RETURNRECORD : UDINT :=16#401; DBADS_IGR_DBSTOREDPROCEDURES_RETURNRECORDARRAY: UDINT :=16#402; DBADS_IGR_START : UDINT :=16#10000; DBADS_IGR_STOP : UDINT :=16#20000; DBADS_IGR_DBCONNADD : UDINT :=16#30000; DBADS_IGR_ADSDEVCONNADD : UDINT :=16#30001; DBADS_IGR_ODBC_DBCONNADD : UDINT :=16#30010; DBADS_IGR_GETDBXMLCONFIG : UDINT :=16#30101; DBADS_IGR_GETADSDEVXMLCONFIG : UDINT :=16#30102; DBADS_IGR_DBWRITE : UDINT :=16#40000; DBADS_IGR_DBREAD : UDINT :=16#50000; DBADS_IGR_DBTABLECREATE : UDINT :=16#60000; DBADS_IGR_DBCREATE : UDINT :=16#70000; DBADS_IGR_DBRECORDSELECT : UDINT :=16#80001; DBADS_IGR_DBRECORDINSERT : UDINT :=16#80002; DBADS_IGR_DBRECORDDELETE : UDINT :=16#80003; DBADS_IGR_DBAUTHENTIFICATIONADD : UDINT :=16#90000; MAX_DB_TABLE_COLUMNS : UDINT := 255; MAX_XML_DECLARATIONS : UDINT := 255; MAX_STORED_PROCEDURES_PARAMETERS : UDINT := 255; END_VAR Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 6.2.3.2 Library version All libraries have a certain version. The version is indicated in the PLC library repository, for example. A global constant contains the information about the library version: Global_Version TF6420 Version: 1.13.8 325
## Page 326

PLC API VAR_GLOBAL CONSTANT st Lib Version_TC3_Database_Server : ST_Lib Version; END_VAR Use the function F_Cmp Lib Version (defined in the Tc2_System library) to check whether you are using the correct version. All other options for comparing library versions, which you may know from Twin CAT 2, are outdated! 326 Version: 1.13.8 TF6420
## Page 327

Examples 7 Examples 7.1 Tc3_Database The following pages introduce samples and tips for using the Twin CAT Database Server with the library for Twin CAT 3. 7.1.1 Scenario examples Each sample is assigned to a scenario, which can be adapted to specific use cases. Information on which databases the samples are compatible with is also provided. 7.1.1.1 Home automation This scenario example illustrates the configuration mode for building automation. Symbols are written to an My SQL database in three different Auto Log groups without additional programming, i.e. purely based on the configuration. Room temperatures are logged in the database at 5-minute intervals. Energy data are saved at 1-minute intervals. Events such as "lamp on", "lamp off" are stored. Category Configure mode Database used My SQL Compatible databases Can be used for all supported database types PLC function blocks used None PLC libraries used Tc3_Database, Tc2_BABasic Download https://infosys.beckhoff.com/content/1033/ TF6420_Tc3_Database_Server/Resources/ 3495185419.zip ü Twin CAT database server project has been created. TF6420 Version: 1.13.8 327
## Page 328

Examples 1. First, the database connection is added and configured. 2. Since logging is to take place in three different tables, three Auto Log groups are appended to the database connection. First the temperature Auto Log group is configured. The Cycle Time is set to 300000 ms to match the 5-minute database logging interval. 328 Version: 1.13.8 TF6420
## Page 329

Examples 3. Then the ADS device from which the ADS symbols are to be read is set up. 4. The symbols are created with the Target Browser. TF6420 Version: 1.13.8 329
## Page 330

Examples 5. Now you can select the table into which the temperature values are to be written. The Auto Log groups support two Table Modes [} 39]. The standard table structure is used for the temperature values. A tick indicates that the selected table has the correct structure. 6. Then the Auto Log group for the events is configured. The Log Mode for the group is set to "on Change" and the cycle time is set to 1000 ms. This means that the symbols are checked at 1-second intervals but a table entry is only created if a value changes. 330 Version: 1.13.8 TF6420
## Page 331

Examples 7. Then the ADS device and the symbols are selected, as described in steps 3 and 4. 8. The events are also stored in a standard table structure. TF6420 Version: 1.13.8 331
## Page 332

Examples 9. Finally the energy data are saved at 1-minute intervals. 10. For the energy data the ADS device and the symbols are also selected. 332 Version: 1.13.8 TF6420
## Page 333

Examples 11. The energy data should be stored in a custom table structure, with the various symbols assigned to the columns. 12. Logging can now be started and monitored with the Auto Log Viewer [} 47]. 7.1.1.2 Message logger This scenario example illustrates the PLC Expert Mode for a Message Logger in the PLC. In the sample program the function blocks of the Twin CAT Database Server are used to create a function block, which provides various methods for generating and reading messages. The database in which the messages are stored is created from the PLC. A sample application of the created function block is implemented in the MAIN program. A new database file is created every 7 days. Three different messages can be sent. In addition it is possible to call up the last message or all messages from a particular interval. TF6420 Version: 1.13.8 333
## Page 334

Examples Category PLC Expert Mode Database used MS Compact [} 128] Compatible databases Can be used with minor amendments for all supported database types PLC function blocks used FB_PLCDBCreate Evt [} 172], FB_PLCDBCmd Evt [} 184], FB_PLCDBWrite Evt [} 179], FB_PLCDBRead Evt [} 176] PLC libraries used Tc3_Database, Tc3_Eventlogger Download https://infosys.beckhoff.com/content/1033/ TF6420_Tc3_Database_Server/Resources/ 3495187979.zip FB_Error Logger Create Error Log DB (method) The Create Error Log DB method creates an MS Compact database file and the table in which the messages are stored. METHOD Create Error Log DB : BOOL VAR_INPUT s DBName : T_Max String; END_VAR CASE n State_Create DB OF 0: st DBConfig.s Server := CONCAT(CONCAT(s DBPath, s DBName), '.sdf'); st DBConfig.b Authentification := FALSE; n State_Create DB := 1; 1: IF fb PLCDBCreate. Database(p Database Config:= ADR(st DBConfig), cb Database Config:= SIZEOF(st DBConfig), b Create XMLConfig:= FALSE, p DBID:= 0) THEN ip Result Evt := fb PLCDBCreate.ip Tc Result; IF fb PLCDBCreate.b Error THEN n State_Create DB := 100; 334 Version: 1.13.8 TF6420
## Page 335

Examples ELSE n State_Create DB := 2; END_IF END_IF 2: IF fb Config Tc DBSrv. Create(p Tc DBSrv Config:= ADR(st DBConfig), cb Tc DBSrv Config:= SIZEOF(st DBConfig), b Temporary:= TRUE, p Config ID:= ADR(n DBID) ) THEN ip Result Evt := fb Config Tc DBSrv.ip Tc Result; IF fb Config Tc DBSrv.b Error THEN n State_Create DB := 100; ELSE n State_Create DB := 3; END_IF END_IF 3: arr Table Columns[0].s Name := 'ID'; arr Table Columns[0].e Type := E_Column Type. Big Int; arr Table Columns[0].n Length := 8; arr Table Columns[0].s Property := 'IDENTITY(1,1)'; arr Table Columns[1].s Name := 'Timestamp'; arr Table Columns[1].e Type := E_Column Type. Date Time; arr Table Columns[1].n Length := 4; arr Table Columns[2].s Name := 'Severity'; arr Table Columns[2].e Type := E_Column Type. NVar Char; arr Table Columns[2].n Length := 10; arr Table Columns[3].s Name := 'Error Code'; arr Table Columns[3].e Type := E_Column Type. Integer; arr Table Columns[3].n Length := 4; arr Table Columns[4].s Name := 'Message'; arr Table Columns[4].e Type := E_Column Type. NVar Char; arr Table Columns[4].n Length := 255; IF fb PLCDBCreate. Table(h DBID:= n DBID, s Table Name:= s Table Name, p Table Cfg:= ADR(arr Table Columns), cb Table Cfg:= SIZEOF(arr Table Columns)) THEN ip Result Evt := fb PLCDBCreate.ip Tc Result Event; n State_Create DB := 100; END_IF 100: IF _Set Result Info(1033) THEN IF NOT b Error THEN _b Has Created := TRUE; END_IF n State_Create DB := 0; END_IF END_CASE Create Error Log DB := n State_Create DB = 0; Add Error Entry (method) The Add Error Entry method can be used to write different messages into the database. METHOD Add Error Entry : BOOL VAR_INPUT t Timestamp : DT; e Severity : E_Severity; n Err Code : UDINT; s Message : T_Max String; END_VAR CASE n State_Add Entry OF 0: ip Result Evt := fb PLCDBWrite.ip Tc Result; st Error.t Timestamp := t Timestamp; CASE e Severity OF Tc Event Severity. Info: st Error.s Severity := 'Info'; Tc Event Severity. Warning: st Error.s Severity := 'Warning'; Tc Event Severity. Verbose: st Error.s Severity := 'Verbose'; Tc Event Severity. Critical: TF6420 Version: 1.13.8 335
## Page 336

Examples st Error.s Severity := 'Critical'; Tc Event Severity. Error: st Error.s Severity := 'Error'; END_CASE st Error.n Err Code := n Err Code; st Error.s Msg := s Message; arr Columns[0] := 'Timestamp'; arr Columns[1] := 'Error Code'; arr Columns[2] := 'Severity'; arr Columns[3] := 'Message'; n State_Add Entry := 1; 1: IF fb PLCDBWrite. Write Struct( h DBID:= n DBID, s Table Name:= s Table Name, p Record:= ADR(st Error), cb Record:= SIZEOF(st Error), p Column Names:= ADR(arr Columns), cb Column Names:= SIZEOF(arr Columns)) THEN n State_Add Entry := 100; END_IF 100: IF _Set Result Info(1033) THEN n State_Add Entry := 0; END_IF END_CASE Add Error Entry := n State_Add Entry = 0; Read Last Error (method) The method Read Last Error can be used to read the latest (last) entry from the database. METHOD Read Last Error : BOOL VAR_OUTPUT t Timestamp : DT; s Severity : STRING(10); n Err Code : UDINT; s Message : T_Max String; END_VAR CASE n State_Read Last Entry OF 0: ip Result Evt := fb PLCDBRead.ip Tc Result; arr Columns[0] := 'Timestamp'; arr Columns[1] := 'Error Code'; arr Columns[2] := 'Severity'; arr Columns[3] := 'Message'; n State_Read Last Entry := 1; 1: IF fb PLCDBRead. Read Struct( h DBID:= n DBID, s Table Name:= s Table Name, p Column Names:= ADR(arr Columns), cb Column Names:= SIZEOF(arr Columns), s Order By Column:= 'ID', e Order Type:= E_Order Type. DESC, n Start Index:= 0, n Record Count:= 1, p Data:= ADR(st Read Data), cb Data:= SIZEOF(st Read Data)) THEN n State_Read Last Entry := 100; END_IF 100: IF _Set Result Info(1033) THEN IF NOT fb PLCDBRead.b Error THEN t Timestamp := st Read Data.t Timestamp; s Severity := st Read Data.s Severity; n Err Code := st Read Data.n Err Code; s Message := st Read Data.s Msg; END_IF n State_Read Last Entry := 0; END_IF 336 Version: 1.13.8 TF6420
## Page 337

Examples END_CASE Read Last Error := n State_Read Last Entry = 0; Get Error Timerange (method) The method Get Error Timerange can be used to read all messages from a particular interval. METHOD Get Error Timerange : BOOL VAR_INPUT t Start Timestamp : DT; t End Timestamp : DT; n Start Index : UDINT; END_VAR VAR_OUTPUT n Error Count: UDINT; arr Errors : ARRAY [0..10] OF ST_Error Entry; END_VAR CASE n State_Error Timerange OF 0: ip Result Evt := fb PLCDBRead.ip Tc Result; st Search Data.dt Start Timestamp := t Start Timestamp; st Search Data.dt End Timestamp := t End Timestamp; s Cmd := 'SELECT Timestamp, Error Code, Severity, Message FROM tbl_Errors WHERE Timestamp >= {start} AND Timestamp <= {end}'; arr Parameter[0].s Para Name := 'start'; arr Parameter[0].e Para Type := E_Exp Parameter Type. Date Time; arr Parameter[0].n Para Size := 4; arr Parameter[1].s Para Name := 'end'; arr Parameter[1].e Para Type := E_Exp Parameter Type. Date Time; arr Parameter[1].n Para Size := 4; n State_Error Timerange := 1; 1: IF fb PLCDBCmd. Execute Data Return( h DBID:= n DBID, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= ADR(st Search Data), cb Data:= SIZEOF(st Search Data), p Parameter:= ADR(arr Parameter), cb Parameter:= SIZEOF(arr Parameter), n Start Index:= n Start Index, n Record Count:= 10, p Return Data:= ADR(arr Errs), cb Return Data:= SIZEOF(arr Errs), p Records:= ADR(n Err Count)) THEN n State_Error Timerange := 100; END_IF 100: IF _Set Result Info(1033) THEN n Error Count := n Err Count; arr Errors := arr Errs; n State_Error Timerange := 0; END_IF END_CASE Get Error Timerange := n State_Error Timerange = 0; _Set Result Info (private method) The I_Message message interface is evaluated by the Twin CAT Event Logger in the private _Set Result Info method. METHOD _Set Result Info : BOOL VAR_INPUT n Lang Id : INT := 1033; END_VAR _Set Result Info := FALSE; CASE n State_Set Res Info OF TF6420 Version: 1.13.8 337
## Page 338

Examples 0: IF ip Result Evt. Request Event Text(n Lang Id, Event Text, SIZEOF(Event Text)) THEN n State_Set Res Info := 1; END_IF 1: IF ip Result Evt. Request Event Class Name(n Lang Id, Event Class Name, SIZEOF(Event Class Name)) THEN Event Source Path := ip Result Evt.ip Source Info.s Name; Event Id := ip Result Evt.n Event Id; b Error := (ip Result Evt.e Severity = Tc Event Severity. Error) OR (ip Result Evt.e Severity = Tc Event Severity. Critical); n State_Set Res Info:=0; _Set Result Info := TRUE; END_IF END_CASE 7.1.1.3 Production register This scenario example illustrates the use of the SQL Expert Mode for handling stored procedures. A connection to the database established from the PLC. A stored procedure is used to read product positions from several tables. A visualization is used for the operation. Category SQL Expert mode Database used MS SQL [} 126] Compatible databases MS SQL, My SQL, Oracle PLC function blocks used FB_SQLDatabase Evt [} 193], FB_SQLStored Procedure Evt [} 202], FB_SQLResult Evt [} 200] PLC libraries used Tc3_Database, Tc3_Eventlogger Download https://infosys.beckhoff.com/content/1033/ TF6420_Tc3_Database_Server/Resources/ 3495190539.zip In the MAIN program a so-called state machine is implemented for processing, through which the different SQL function blocks are controlled. Since the methods of the function blocks no longer have an Execute flag, the user must ensure that the method is not called again in the next cycle, in order to avoid repetition of the procedure. This can easily be ensured through the state machine. PROGRAM MAIN VAR b CONNECT: BOOL; 338 Version: 1.13.8 TF6420
## Page 339

Examples b EXECUTE: BOOL; b READ : BOOL; b DISCONNECT: BOOL; R_TRIG1: R_TRIG; R_TRIG2: R_TRIG; R_TRIG3: R_TRIG; R_TRIG4: R_TRIG; n State: INT; n State_Connect: INT; n State_Disconnect: INT; b Conn: BOOL; b SP: BOOL; b Result: BOOL; b Data: BOOL; n DBID: UDINT := 1; fb SQLDatabase: FB_SQLDatabase Evt(s Net ID:='', t Timeout:=T#10S); fb SQLStored Procedure: FB_SQLStored Procedure Evt( s Net ID:='', t Timeout:=T#10S); fb SQLResult: FB_SQLResult Evt(s Net ID:='', t Timeout:=T#10S); arr Parameter: ARRAY [0..0] OF ST_SQLSPParameter; n Customer ID: DINT := 12345; n Record Start Index: UDINT; st Record Arr: ARRAY [1..20] OF ST_Record; n Recs: UDINT; ip Result Evt : Tc3_Eventlogger. I_Tc Message; b Error : BOOL; n Event ID: UDINT; s Event Class : STRING(255); s Event Msg : STRING(255); END_VAR R_TRIG1(CLK:=b CONNECT); IF R_TRIG1. Q AND n State = 0 THEN n State := 1; END_IF R_TRIG2(CLK:=b EXECUTE); IF R_TRIG2. Q AND n State = 0 THEN n State := 2; END_IF R_TRIG3(CLK:=b READ); IF R_TRIG3. Q AND n State = 0 THEN n State := 3; END_IF R_TRIG4(CLK:=b DISCONNECT); IF R_TRIG4. Q THEN n State := 4; END_IF CASE n State OF 0:(*Idle*) ; 1: // Connect to database and create stored procedure instance CASE n State_Connect OF 0: IF fb SQLDatabase. Connect(h DBID:= n DBID) THEN ip Result Evt := fb SQLDatabase.ip Tc Result; b Conn := NOT fb SQLDatabase.b Error; IF b Conn THEN n State_Connect := 1; ELSE n State:=200; END_IF END_IF 1: arr Parameter[0].s Parameter Name := '@Customer_ID'; arr Parameter[0].e Parameter Data Type := Tc3_Database. E_Column Type. Integer; arr Parameter[0].e Parameter Type := E_SPParameter Type. Input; TF6420 Version: 1.13.8 339
## Page 340

Examples arr Parameter[0].n Parameter Size := SIZEOF(n Customer ID); IF fb SQLDatabase. Create SP('SP_Get Address By Customer ID', ADR(arr Parameter), SIZEOF(arr Parameter), ADR(fb SQLStored Procedure)) THEN ip Result Evt:= fb SQLDatabase.ip Tc Result; b SP := NOT fb SQLDatabase.b Error; n State_Connect:=0; n State := 200; END_IF END_CASE 2: // Execute stored procedure IF fb SQLStored Procedure. Execute Data Return( p Parameter Strc:= ADR(n Customer ID), cb Parameter Strc:= SIZEOF(n Customer ID), p SQLDBResult:= ADR(fb SQLResult)) THEN ip Result Evt:= fb SQLStored Procedure.ip Tc Result; MEMSET(ADR(st Record Arr),0,SIZEOF(st Record Arr)); b Result := NOT fb SQLStored Procedure.b Error; n State := 200; END_IF 3: // Read customer positions IF fb SQLResult. Read(n Record Start Index, 20, ADR(st Record Arr), SIZEOF(st Record Arr), TRUE, FALSE) THEN ip Result Evt:= fb SQLResult.ip Tc Result; b Data := NOT fb SQLStored Procedure.b Error; n Recs := fb SQLResult.n Data Count; n State := 200; END_IF 4:// Disconnect all CASE n State_Disconnect OF 0: IF b Data THEN IF fb SQLResult. Release() THEN n State_Disconnect := 1; END_IF ELSE n State_Disconnect := 1; END_IF 1: IF b SP THEN IF fb SQLStored Procedure. Release() THEN n State_Disconnect := 2; END_IF ELSE n State_Disconnect := 2; END_IF 2: IF b Conn THEN IF fb SQLDatabase. Disconnect() THEN n State_Disconnect := 3; END_IF ELSE n State_Disconnect := 3; END_IF 3: b Data := FALSE; b SP := FALSE; b Conn := FALSE; b Result := FALSE; s Event Class := ""; s Event Msg := ""; n Event ID := 0; b Error := FALSE; n State_Disconnect := 0; n State := 0; END_CASE 200: IF ip Result Evt. Request Event Text(1033, s Event Msg, SIZEOF(s Event Msg)) THEN n State := 201; END_IF 201: IF ip Result Evt. Request Event Class Name(1033, s Event Class, SIZEOF(s Event Class)) THEN n Event ID := ip Result Evt.n Event Id; b Error := (ip Result Evt.e Severity = Tc Event Severity. Error) OR (ip Result Evt.e Severity = Tc Event Severity. Critical); 340 Version: 1.13.8 TF6420
## Page 341

Examples n State:=0; END_IF END_CASE The individual process steps can be reproduced in the individual PLC states. Boolean flags are available to facilitate handling. 1. b Connect: Connection with the database is established 2. b Execute: The stored procedure is executed, and results are loaded into the cache 3. b Read: The results are transferred to the PLC 4. b Disconnect: The connection is closed If these steps are executed consecutively, the array st Record Arr is filled with values from the database: 7.1.1.4 Production recipe This scenario example illustrates how the Twin CAT Database Server handles XML files with any structure. The production recipe for building the product is read from an XML file. The corresponding test parameters are read from a different file. In addition, the test results are written into an existing XML file. TF6420 Version: 1.13.8 341
## Page 342

Examples Category SQL Expert mode Database used XML [} 136] (as free XML documents) Compatible databases XML PLC function blocks used FB_PLCDBCmd Evt [} 184] PLC libraries used Tc3_Database, Tc3_Eventlogger Download https://infosys.beckhoff.com/content/1033/ TF6420_Tc3_Database_Server/Resources/ 3495193099.zip Recipe XML: 342 Version: 1.13.8 TF6420
## Page 343

Examples Test XML: FB_Production Config Data Get Config (method) This method reads the production recipe for a product from an XML file. XPath queries can be used to find the required recipe. METHOD Get Config : BOOL VAR_INPUT n Type Num : DINT; END_VAR VAR_OUTPUT st Config : ST_Config; END_VAR Get Config:= FALSE; arr Para[0].s Para Name := 'r Length'; arr Para[0].e Para Type := Tc3_Database. E_Exp Parameter Type. Float32; arr Para[0].n Para Size := 4; arr Para[1].s Para Name := 'r Width'; arr Para[1].e Para Type := Tc3_Database. E_Exp Parameter Type. Float32; TF6420 Version: 1.13.8 343
## Page 344

Examples arr Para[1].n Para Size := 4; arr Para[2].s Para Name := 'r Height'; arr Para[2].e Para Type := Tc3_Database. E_Exp Parameter Type. Float32; arr Para[2].n Para Size := 4; arr Para[3].s Para Name := 'i Quantity'; arr Para[3].e Para Type := Tc3_Database. E_Exp Parameter Type. Int32; arr Para[3].n Para Size := 4; arr Para[4].s Para Name := 'i Counter'; arr Para[4].e Para Type := Tc3_Database. E_Exp Parameter Type. Int32; arr Para[4].n Para Size := 4; s Cmd := CONCAT(CONCAT('XPATH_SEL<SUBTAG>#Production Config/Config[@Type Num = ', DINT_TO_STRING(n Type Num)), ']'); CASE n State_Get Config OF 0: IF fb PLCDBCmd. Execute Data Return( h DBID:= 1, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= 0, cb Data:= 0, p Parameter:= ADR(arr Para), cb Parameter:= SIZEOF(arr Para[0])*5, n Start Index:= 0, n Record Count:= 1, p Return Data:= ADR(_st Config), cb Return Data:= SIZEOF(_st Config), p Records:= 0) THEN ip Result Evt := fb PLCDBCmd.ip Tc Result; n State_Get Config := 100; END_IF 100: IF _Set Result Info(1033) THEN Get Config := TRUE; st Config := _st Config; n State_Get Config := 0; END_IF END_CASE Get Test Parameter (method) This method reads the product-specific test parameters. METHOD Get Test Parameter : BOOL VAR_INPUT n Type Num : DINT; END_VAR VAR_OUTPUT s Test Num : STRING(8); st Test Para: ST_Test Parameter; END_VAR Get Test Parameter := FALSE; CASE n State_Get Test Para OF 0: arr Para[0].s Para Name := 'Test'; arr Para[0].e Para Type := Tc3_Database. E_Exp Parameter Type. STRING_; arr Para[0].n Para Size := 8; s Cmd := CONCAT(CONCAT('XPATH_SEL<ATTR>#Production Config/Config [@Type Num = ', DINT_TO_STRING(n Type Num)), ']'); IF fb PLCDBCmd. Execute Data Return( h DBID:= 1, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= 0, cb Data:= 0, p Parameter:= ADR(arr Para), cb Parameter:= SIZEOF(arr Para[0]), n Start Index:= 0, n Record Count:= 1, 344 Version: 1.13.8 TF6420
## Page 345

Examples p Return Data:= ADR(_s Test Num), cb Return Data:= SIZEOF(_s Test Num), p Records:= 0) THEN b Error := fb PLCDBCmd.b Error; s Err Class := fb PLCDBCmd.ip Tc Result Event. Event Class Display Name; n Err ID := fb PLCDBCmd.ip Tc Result Event. Event Id; s Err Text := fb PLCDBCmd.ip Tc Result Event. Text; IF fb PLCDBCmd .b Error THEN ip Result Evt := fb PLCDBCmd.ip Tc Result; n State_Get Test Para:= 100; ELSE n State_Get Test Para:= 1; END_IF END_IF 1: arr Para[0].s Para Name := 'Max Temp'; arr Para[0].e Para Type := Tc3_Database. E_Exp Parameter Type. Float32; arr Para[0].n Para Size := 4; arr Para[1].s Para Name := 'Min Temp'; arr Para[1].e Para Type := Tc3_Database. E_Exp Parameter Type. Float32; arr Para[1].n Para Size := 4; arr Para[2].s Para Name := 'Max PSI'; arr Para[2].e Para Type := Tc3_Database. E_Exp Parameter Type. Int32; arr Para[2].n Para Size := 4; s Cmd := CONCAT(CONCAT('XPATH_SEL<SUBTAG>#Production Config/ Test Parameter/Test[@Num = $'', _s Test Num), '$']'); IF fb PLCDBCmd. Execute Data Return( h DBID:= 2, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= 0, cb Data:= 0, p Parameter:= ADR(arr Para), cb Parameter:= SIZEOF(arr Para[0])*3, n Start Index:= 0, n Record Count:= 1, p Return Data:= ADR(_st Test), cb Return Data:= SIZEOF(_st Test), p Records:= 0) THEN ip Result Evt := fb PLCDBCmd.ip Tc Result; n State_Get Test Para:= 100; 100: IF _Set Result Info(1033) THEN n State_Get Test Para := 0; st Test Para := _st Test; s Test Num := _s Test Num; Get Test Parameter := TRUE; END_IF END_CASE Add Test Entry (method) This method adds the test result to the test XML file. METHOD Add Test Entry : BOOL VAR_INPUT s Test Num : STRING(8); n Type Num : DINT; s Timestamp : STRING; s Tester : STRING; s Result : STRING; END_VAR Add Test Entry := FALSE; arr Para[0].s Para Name := 'Test Num'; arr Para[0].e Para Type := Tc3_Database. E_Exp Parameter Type. STRING_; arr Para[0].n Para Size := 8; arr Para[1].s Para Name := 'Type Num'; arr Para[1].e Para Type := Tc3_Database. E_Exp Parameter Type. Int32; TF6420 Version: 1.13.8 345
## Page 346

Examples arr Para[1].n Para Size := 4; arr Para[2].s Para Name := 'Timestamp'; arr Para[2].e Para Type := Tc3_Database. E_Exp Parameter Type. STRING_; arr Para[2].n Para Size := 81; arr Para[3].s Para Name := 'Tester'; arr Para[3].e Para Type := Tc3_Database. E_Exp Parameter Type. STRING_; arr Para[3].n Para Size := 81; arr Para[4].s Para Name := 'Result'; arr Para[4].e Para Type := Tc3_Database. E_Exp Parameter Type. STRING_; arr Para[4].n Para Size := 81; arr Para[5].s Para Name := 'Test'; arr Para[5].e Para Type := Tc3_Database. E_Exp Parameter Type. XMLTAGName; arr Para[5].n Para Size := 0; s Cmd := 'XPATH_ADD<ATTR>#Production Config/Tests'; st Test.s Test Num := s Test Num; st Test.n Type Num := n Type Num; st Test.s Timestamp := s Timestamp; st Test.s Tester := s Tester; st Test.s Result := s Result; CASE n State_Add Entry OF 0: IF fb PLCDBCmd. Execute( h DBID:= 2, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= ADR(st Test), cb Data:= SIZEOF(st Test), p Parameter:= ADR(arr Para), cb Parameter:= SIZEOF(arr Para)) THEN ip Result Evt := fb PLCDBCmd.ip Tc Result; n State_Add Entry:= 100; END_IF 100: IF _Set Result Info(1033) THEN n State_Add Entry:= 0; Add Test Entry:= TRUE; END_IF END_CASE _Set Result Info (private method) The I_Message message interface is evaluated by the Twin CAT Event Logger in the private _Set Result Info method. METHOD _Set Result Info : BOOL VAR_INPUT n Lang Id : INT := 1033; END_VAR _Set Result Info := FALSE; CASE n State_Set Res Info OF 0: IF ip Result Evt. Request Event Text(n Lang Id, Event Text, SIZEOF(Event Text)) THEN n State_Set Res Info := 1; END_IF 1: IF ip Result Evt. Request Event Class Name(n Lang Id, Event Class Name, SIZEOF(Event Class Name)) THEN Event Id := ip Result Evt.n Event Id; b Error := (ip Result Evt.e Severity = Tc Event Severity. Error) OR (ip Result Evt.e Severity = Tc Event Severity. Critical); n State_Set Res Info:=0; _Set Result Info := TRUE; END_IF END_CASE 346 Version: 1.13.8 TF6420
## Page 347

Examples 7.1.2 Best practices The tips for using the Twin CAT Database Server illustrate the benefits of the individual function blocks and applications in terms of performance, flexibility and complexity. 7.1.2.1 Writing CSV files The Twin CAT 3 Database Server supports the CSV file format. There are different approaches, each with advantages and disadvantages, to write content to the file or read from it. Two of these approaches are explained in more detail here. Select the ASCII database. The .csv file format can be specified under the file path. The ASCII-DB 3.0 format flag indicates the format of the ASCII/CSV file. If the format is checked, the SAX procedure is used. With this setting, write access to the file, especially with the FB_PLCDBCmd Evt function block, is also very efficient for large files. If the format is unchecked, the DOM procedure is used, which is particularly suitable for reading a file. The data is stored in a structured form in the RAM. Therefore this method is recommended for smaller files (less than 1 MB). However, this method offers some advantages due to the structured storage. The CSV file can be used as an SQL database using a stored table structure. Use the SQL Query Editor to do this. This file can be created directly via the 'Create' button. Load your configuration onto your Twin CAT Database Server target system. Table 2: ASCII format compatibility Function block Table structure ASCII 3.0 format Standard ASCII FB_PLCDBWrite Evt. Write standard FB_PLCDBWrite Evt. Write Str variable uct* FB_PLCDBRead Evt. Read standard FB_:PLCDBRead Evt. Read St variable ruct* FB_PLCDBCmd Evt. Execute* variable FB_SQLCommand Evt variable Items marked with * are used in the following sample High-performance writing to the CSV file TF6420 Version: 1.13.8 347
## Page 348

Examples The most efficient way to write to a CSV file is based on the FB_PLCDBCmd Evt function block. To this end, the link to the CSV file must be set in ASCII-DB 3.0 format. The DBValue Type is irrelevant here. A table structure does not have to be defined in advance. Sample: Given the following structure: TYPE ST_CSVData Struct : STRUCT ID: LINT; Timestamp: DT; Name: STRING(80); Velocity: LREAL; Temperature: LREAL; END_STRUCT END_TYPE The function block is initialized as follows: VAR Input Data: ST_CSVData Struct; fb PLCDBCmd: FB_PLCDBCmd Evt (s Net ID:= '', t Timeout := T#30S); s Cmd : T_Max String := '{ID};{Timestamp};{Name};{Velocity};{Temperature}'; para : ARRAY [0..4] OF ST_Exp Parameter :=[ (e Para Type:= E_Exp Parameter Type. Int64, n Para Size := 8, s Para Name := 'ID'), (e Para Type:= E_Exp Parameter Type. Date Time, n Para Size := 4, s Para Name := 'Timestamp'), (e Para Type:= E_Exp Parameter Type. STRING_, n Para Size := 81, s Para Name := 'Name'), (e Para Type:= E_Exp Parameter Type. Double64, n Para Size := 8, s Para Name := 'Velocity'), (e Para Type:= E_Exp Parameter Type. Double64, n Para Size := 8, s Para Name := 'Temperature')]; END_VAR The individual parameters are specified in curly brackets within the command. Information about the type, byte length and name is assigned via the initialization. The name is used to recognize the parameter in the command and to replace it with the value from the PLC when it is written to the file. The call in the PLC source code of the function block consists of a call: IF fb PLCDBCmd. Execute( h DBID:= 3, p Expression:= ADR(s Cmd), cb Expression:= SIZEOF(s Cmd), p Data:= ADR(Input Data), cb Data:= SIZEOF(Input Data) , p Parameter:= ADR(para), cb Parameter:=SIZEOF(para)) THEN ;//Place for errorhandling or reactions; END_IF // Result: 16160;19-10-2018 12:27:38;Water Turbine;35.2238040741592;62.6461585412374 The h DBID depends on its configuration and can be taken from the database link. p Data (or cb Data) can be the address for the individual structure or for an array of its structure. This can lead to further performance improvements. Structured writing and reading of a CSV file Not all function blocks are possible with the ASCII format 3.0. Some functions of the Twin CAT Database Server require a preconfigured table structure. However, this cannot be stored in ASCII format 3.0. In this sample, a fixed structure is used to write and read the data with the PLCDBWrite Evt and PLCDBRead Evt function blocks in any structure. The following structure is used as an example: 348 Version: 1.13.8 TF6420
## Page 349

Examples Export for the PLC under the 'Select' tab is also possible: TYPE ST_CSVData Struct : STRUCT ID: LINT; Timestamp: DT; Name: STRING(80); Velocity: LREAL; Temperature: LREAL; END_STRUCT END_TYPE The Write/Read Struct methods of the respective PLC function blocks are used for any table structures: VAR fb PLCDBWrite: FB_PLCDBWrite Evt(s Net ID:= '', t Timeout := T#30S); fb PLCDBRead : FB_PLCDBRead Evt(s Net ID:= '', t Timeout := T#30S); Column Names : ARRAY [0..4] OF STRING(50) := ['ID','Timestamp','Name','Velocity','Temperature']; Data: ST_CSVData Struct; Read Data: ARRAY[0..4] OF ST_CSVData Struct; END_VAR IF fb PLCDBWrite. Write Struct( h DBID:= h DBID, s Table Name:= 'CSV_Sample', p Record:= ADR(Data), cb Record:= SIZEOF(Data), p Column Names:= ADR(Column Names), cb Column Names:= SIZEOF(Column Names) ) THEN ;//Place for errorhandling or reactions END_IF IF fb PLCDBRead. Read Struct( h DBID:= h DBID, s Table Name:= 'CSV_Sample', p Column Names:= ADR(Column Names), cb Column Names:= SIZEOF(Column Names) , s Order By Column:= 'ID', e Order Type := E_Order Type. ASC, n Start Index:= 0, n Record Count:= 5, p Data:= ADR(Read Data), cb Data:=SIZEOF(Read Data)) THEN ;//Place for errorhandling or reactions END_IF The Write Struct(...) method writes the Data structure to the database. The structures of the PLC and the CSV file are compared based on the Column Names. The Read Struct(...) method reads a certain number (n Record Count) of records from the CSV file. These may be sorted based on a selected column. The size of the Read Data target array should be sufficient to receive all the retrieved data. Appendix TF6420 Version: 1.13.8 349
## Page 350

Examples Sample configurations for both samples, as well as the complete code of a simple sample program, can be downloaded here: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 5778536715.zip. To illustrate the process, the program generates values and repeatedly sends them to the CSV. The settings used above were stored in a separate function block, which communicates in different ways with the two CSV formats. 7.1.2.2 Fast logging with data buffer In order to log data in a database at millisecond intervals, the data must first be consolidated before it is transferred to the database via the Twin CAT Database Server. These data buffers can vary in size according to requirements. In the sample, 100 data samples are combined in a buffer before they are transferred with the Twin CAT Database Server. To avoid gaps during the write process, several buffers must be created in which the data samples are combined. In the sample, a total of 20 buffers are created using a 2-dimensional array. Data sample Definition: TYPE ST_Data : STRUCT Timestamp : LINT; f AM : LREAL; f Peak : LREAL; f Pulse : LREAL; f Sawtooth : LREAL; f Sine : LREAL; f Square : LREAL; f Stairs : LREAL; f Triangular : LREAL; END_STRUCT END_TYPE Each cycle fills one element of the data buffer. In the sample this happens at 10 ms intervals. Thus a buffer contains data of a period of 1 s. If a buffer is filled with 100 elements, a further array indicates that the 100 elements can now be transferred with the function block FB_PLCDBCmd Evt. To this end, the entire buffer can be transferred to the function block. Each individual element is then transferred from the Twin CAT Database Server to the database. This sample can also be implemented with other function blocks. Note that not all function blocks support arrays. Extract from the function block FB_Record_tbl_Signals ( "State Machine" => State: Recording) … 2://Recording b Recording := TRUE; //Fill buffer st Data[n Write Buffer Index, n Write Index]. Timestamp := n Timestamp; st Data[n Write Buffer Index, n Write Index].f AM := f AM; st Data[n Write Buffer Index, n Write Index].f Peak := f Peak; st Data[n Write Buffer Index, n Write Index].f Pulse := f Pulse; st Data[n Write Buffer Index, n Write Index].f Sawtooth := f Sawtooth; st Data[n Write Buffer Index, n Write Index].f Sine := f Sine; st Data[n Write Buffer Index, n Write Index].f Square := f Square; st Data[n Write Buffer Index, n Write Index].f Stairs := f Stairs; st Data[n Write Buffer Index, n Write Index].f Triangular := f Triangular; //Set buffer index n Write Index := n Write Index + 1; IF n Write Index = 100 THEN n Write Index := 0; a Write SQL[n Write Buffer Index]:= TRUE; n Write Buffer Index := n Write Buffer Index + 1; IF n Write Buffer Index = 20 THEN n Write Buffer Index := 0; END_IF IF a Write SQL[n Write Buffer Index] THEN n State := 255; 350 Version: 1.13.8 TF6420
## Page 351

Examples RETURN; END_IF END_IF //Write buffer element (100 samples) to database IF a Write SQL[n SQLIndex] THEN IF fb PLCDBCmd. Execute(n DBID, ADR(s Cmd), SIZEOF(s Cmd), ADR(st Data[n SQLIndex,0]), SIZEOF(st Data[n SQLIndex,0]) * 100, ADR(a Para), SIZEOF(a Para)) THEN IF fb PLCDBCmd.b Error THEN n State := 255; ELSE n Records := n Records + 100; a Write SQL[n SQLIndex] := FALSE; n SQLIndex := n SQLIndex + 1; IF n SQLIndex = 20 THEN n SQLIndex := 0; END_IF IF NOT b Record THEN b Recording := FALSE; n State := 0; END_IF END_IF END_IF END_IF …. Appendix: In this best practice example, a function generator block is used to generate various signals that can be logged in a database. The syntax of the INSERT command is generally valid, but has been specifically tested with an MS SQL database. The ZIP file attached below contains the complete program code in Tnzip format. Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 6263666699.zip 7.1.2.3 No SQL This document describes the handling of No SQL databases. Database used: Mongo DB Database type used: Document DB Data writing Database types of type Document DB can store JSON documents with any structure. Therefore it is possible to map any structure of the PLC in Document DBs. This document can be created automatically using the FB_JSONData Type or assembled using the string blocks. Make sure that the document variable is large enough. If you want to write several documents at the same time, you can transfer them in a JSON array. The Query Options [} 235]are defined in preparation. The collection concerned and the query type are specified for this purpose. Each query type has its own structure. The structure T_Query Option Document DB_Insert [} 236] is used for writing documents. VAR fb No SQLQuery Builder_Document DB: FB_No SQLQuery Builder_Document DB; Insert Query Options: T_Query Option Document DB_Insert; s Document : STRING(2000); END_VAR Insert Query Options.p Documents:= ADR(s Document); Insert Query Options.cb Documents:= SIZEOF(s Document); fb No SQLQuery Builder_Document DB.e Query Type := E_Document Db Query Type. Insert One; fb No SQLQuery Builder_Document DB.s Collection Name := 'my Collection'; fb No SQLQuery Builder_Document DB.p Query Options := ADR(Insert Query Options); fb No SQLQuery Builder_Document DB.cb Query Options := SIZEOF(Insert Query Options); TF6420 Version: 1.13.8 351
## Page 352

Examples The function block FB_No SQLQuery Evt [} 209] is used for writing the document into the database. The Execute() [} 210] method writes the transferred documents to the database. This execution is asynchronous to the PLC and can take several cycles. The Boolean return value indicates when the function block has completed its process: VAR fb No SQLQuery: FB_No SQLQuery Evt(s Net ID := '', t Timeout := TIME#15S0MS); fb Json Data Type: FB_Json Read Write Datatype; END_VAR CASE e State OF … e My Db State. Write: // set the document yourself as json format (Example) s Document := '{"my Bool" : true, "Name" : "Some Name Value", "Value": 2.3, "Value2":3, "Child":{"Name":"Single Child", "Value":1, "my Bool":true, "arr":[12.0,13.0,14.0,15.0], "my Bool2" : true}, "Children":[ {"Name":"Child1" ,"Value": 1, "my Bool" : true, "arr":[12.1,13.1,14.1,15.1], "my Bool2" : true}, {"Name":"Child2", "Value":2, "my Bool" : true, "arr":[12.2,13.2,14.2,15.2], "my Bool2" : true}, {"Name":"Child3", "Value":1, "my Bool" : true, "arr":[12.3,13.3,14.3,15.3], "my Bool2" : true}] }'; IF fb No SQLQuery. Execute(1, my Query Builder) THEN IF fb No SQLQuery.b Error THEN Info Result := fb No SQLQuery.ip Tc Result; e State:= e My Db State. Error; ELSE e State:= e My Db State. Idle; END_IF END_IF … END_CASE The databases recognize the data type with which the individual variables are stored. However, as with Mongo DB, the data type can be specified explicitly. If a timestamp is to be saved explicitly as a data type, it must be defined in the JSON document: s Document := '{…"my Timestamp": ISODate("2019-02-01T14:46:06.0000000"), …}'; The string can not only be formatted via the string formatting function blocks of the Twin CAT 3 libraries, but also via auxiliary function blocks for JSON documents, such as FB_Json Read Write Datatype from Tc3_Json Xml. // set the document by Json Data Type s Type Name := fb Json Data Type. Get Datatype Name By Address(SIZEOF(any Value[1]), ADR(any Value[1])); s Document := fb Json Data Type. Get Json String From Symbol(s Type Name, SIZEOF(any Value [1]), ADR(any Value [1])); Reading data The data schema in the document-based database can be different for each document. In contrast, the PLC follows a fixed process image. The data may not correspond to the process image. There are two different ways of reading data in the database: the find query and the aggregation method. Both return results from the database, although aggregation offers extended options for transforming the data into an appropriate form or for performing operations, such as calculating average values directly. 352 Version: 1.13.8 TF6420
## Page 353

Examples The Query Options [} 235] are defined in preparation. The collection concerned and the query type are specified for this purpose. Each query type has its own structure. The structure T_Query Option Document DB_Aggregation [} 235] is used for aggregating documents. VAR fb No SQLQuery Builder_Document DB: FB_No SQLQuery Builder_Document DB; Aggregation Query Options: T_Query Option Document DB_Aggregate; s Pipe Stages: STRING(1000); END_VAR Aggregation Query Options.p Pipe Stages := ADR(s Pipe Stages); Aggregation Query Options.cb Pipe Stages := SIZEOF(s Pipe Stages); fb No SQLQuery Builder_Document DB.e Query Type := E_Document Db Query Type. Aggregation; fb No SQLQuery Builder_Document DB.s Collection Name := 'my Collection'; fb No SQLQuery Builder_Document DB.p Query Options := ADR(Aggregation Query Options); fb No SQLQuery Builder_Document DB.cb Query Options := SIZEOF(Aggregation Query Options); The FB_No SQLQuery Evt [} 209] is used for sending the aggregation query. The Execute Data Return() [} 211] method can be used to transfer the parameters and to place the returned data in the transferred memory reference. This execution is asynchronous to the PLC and takes several cycles. The Boolean return value indicates when the function block has completed its process: VAR fb No SQLQuery: FB_No SQLQuery Evt(s Net ID := '', t Timeout := TIME#15S0MS); fb No SQLResult: FB_No SQLResult Evt(s Net ID := '', t Timeout := TIME#15S0MS); END_VAR CASE e State OF … e My Db State. Aggregation: s Pipe Stages :='{$$match :{}}'; IF fb No SQLQuery. Execute Data Return(1, my Query Builder, p No Sql Result:= ADR(fb No SQLResult), n Document Length=> n Document Length)) THEN IF fb No SQLQuery.b Error THEN Info Result := fb No SQLQuery.ip Tc Result; e State:= e My Db State. Error; ELSE e State:= e My Db State. Idle; END_IF END_IF … END_CASE The syntax of s Pipe Stages depends on the database type. It will return all records. Further options (with fictitious records) include: Operator Description {$$match : {Place : “North East”}} All records which have "North East" as value of the element "Place". {$$project : { my Value : { $array Elem At : Returns all Rotor Sensor data from array element ["$Wind Plant Data. Rotor Sensor", 2]} } } location 2 as "my Value". {$$project : {Rotor Avg : {$avg: Returns the average value of the data array "$Wind Plant Data. Rotor Sensor"} } } "Rotor Sensor" as "Rotor Avg". The complete documentation of the operators is available from the respective database provider. A reference to the returned data can now be found in the function block FB_No SQLResult Evt [} 212]. These can now be read as JSON documents in a string or as a structure. The data is now read directly into an array with a suitable structure. You can use the SQL Query Editor of the Database Server to directly generate a structure that matches the record. Instead of an array, it is also possible to store an address for a single structure when retrieving only one record. VAR fb No SQLResult: FB_No SQLResult Evt(s Net ID := '', t Timeout := TIME#15S0MS); a Rd Struct : ARRAY [0..9] OF ST_My Custom Struct; fb No Sql Validation : FB_No SQLValidation Evt(s Net ID := '', t Timeout := TIME#15S0MS); END_VAR CASE e State OF … e My Db State. Read Struct: IF fbno SQLDBResult. Read As Struct(0, 4, ADR(a Rd Struct), SIZEOF(a Rd Struct), b Validate := TRUE, ADR(fb No Sql Validation), b Data Release:= TRUE) THEN IF fbno SQLDBResult.b Error THEN Info Result := fbno SQLDBResult.ip Tc Result; TF6420 Version: 1.13.8 353
## Page 354

Examples e State:= e My Db State. Error; ELSE e State:= e My Db State. Idle; END_IF END_IF … END_CASE The Twin CAT Database Server takes into account the names of the elements in the record and the names of the variables when assigning record or structure. If these are to differ, the attribute "Element Name" can be used in the PLC: TYPE ST_Wind Farm Data : STRUCT {attribute 'Element Name' := '_id'} ID: T_Object Id_Mongo DB; {attribute 'Element Name' := 'Timestamp'} Last Time: DT; {attribute 'Element Name' := 'Wind Plant Data'} Data: ST_Wind Farm Data_Wind Plant Data; END_STRUCT END_TYPE In this sample, "Element Name" specifies the name of the data in the database document. The start index and the number of records can be used to determine which records are to be returned with this call. In order to avoid possible duplications, please note that these options can already be carried out with operators at the "Pipepline Stages". Data validation If there were conflicts between the record and the structure in the PLC at FB_No SQLResult [} 212], they can be read out with FB_No SQLValidation Evt [} 216]. Examples of conflicts are missing or surplus records, or data type problems. The method Get Issues() [} 217] can be used to read all conflicts as an array of strings. Surplus data that were not found in the PLC structure can be read as an array of strings in JSON format via Get Remaining Data() [} 218]. If necessary, these can then be read out separately into the correct structure or interpreted via the Twin CAT JSON library. VAR fb No Sql Validation : FB_No SQLValidation Evt(s Net ID := '', t Timeout := TIME#15S0MS); a Issues : ARRAY[0..99] OF STRING(512); a Remaining : ARRAY [0..9] OF STRING(1000); END_VAR CASE e State OF … e My Db State. Validation Issues: IF fb Validation. Get Issues(ADR(a Issues), SIZEOF(a Issues), FALSE) THEN IF fb Validation.b Error THEN Info Result := fb Validation.ip Tc Result; e State:= e My Db State. Error; ELSE e State:= e My Db State. Idle; END_IF e My Db State. Validation Remaining: IF fb Validation. Get Remaining Data(ADR(a Remaining), SIZEOF(a Remaining), SIZEOF(a Remaining[1]), b Data Release:= FALSE)THEN IF fb Validation.b Error THEN Info Result := fb Validation.ip Tc Result; e State:= e My Db State. Error; ELSE e State:= e My Db State. Idle; END_IF … END_CASE Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 13743807627.zip 354 Version: 1.13.8 TF6420
## Page 355

Examples 7.1.2.4 Postgre Sql routines In addition to the functions (Postgre SQL routine), from Postgre SQL 11 the database also supports stored procedures to enable server-side programming. These two routine types have different properties and functions: Table 3: Comparison of stored procedures and functions Stored Procedures Functions OUT parameters + - Return value - + Can be used in queries - + Supports transactions + - These properties require different interfaces with the Twin CAT Database Server. As with other supported databases, Stored Procedures are executed using the FB_SQLStored Procedure Evt [} 202] function block. Functions can be integrated in SQL commands, which are called via FB_PLCDBCmd Evt [} 184] or FB_SQLCommand Evt [} 197]. Postgre SQL uses "Ref Cursor" for returning data sets of the routines. The Twin CAT Database Server automatically evaluates these "Ref Cursor" and returns the data set referenced in them. It is not possible to resolve multiple "Ref Cursor". Calling a Stored Procedure Procedures can be called via the FB_SQLStored Procedure Evt. Example (SQL) SQL script for creating a procedure: CREATE OR REPLACE PROCEDURE "public"."SP_get Last Data"( INOUT result_data refcursor) LANGUAGE 'plpgsql' AS $BODY$ BEGIN open result_data for SELECT * FROM "my Table_Double" LIMIT 10; END $BODY$; If the procedure defines one (or more) "Ref Cursor" as output parameter(s), this (or the first) is automatically interpreted and the resulting data sets are stored in the buffer for the FB_SQLResult Evt [} 200]. The data type "Ref Cursor" is treated like a string by the Twin CAT Database Server. Example (Twin CAT 3 in ST) VAR fb Sql Database : FB_SQLDatabase Evt(s Net ID := '', t Timeout := T#5S); Para Info : ST_SQLSPParameter; END_VAR Para Info.s Parameter Name := '@result_data'; Para Info.e Parameter Type := E_SPParameter Type. Input Output; Para Info.e Parameter Data Type := E_Column Type. Ref Cursor; // 19 Para Info.n Parameter Size := 81; IF fb SQLDatabase. Create SP('"public"."SP_get Last Data"', ADR(Para Info), SIZEOF(Para Info), ADR(fb SQLSto red Procedure)) THEN IF fb SQLDatabase.b Error THEN n State:=255; ELSE n State:= n State+1; END_IF END_IF The FB_SQLStored Procedure Evt [} 202] uses the Stored Procedure previously linked with FB_SQLDatabase Evt. Create SP() [} 193] TF6420 Version: 1.13.8 355
## Page 356

Examples VAR fb SQLStored Procedure : FB_SQLStored Procedure Evt(s Net ID:='', t Timeout := T#5S); s Ref Cursor : STRING; tc Message : I_Tc Message; END_VAR IF fb SQLStored Procedure. Execute Data Return(p Parameter Strc := ADR(s Ref Cursor), cb Parameter Strc:= SIZEOF(s Ref Cursor), p SQLDBResult := ADR(fb Sql Result)) THEN IF fb SQLStored Procedure.b Error THEN tc Message := fb SQLStored Procedure.ip Tc Result; n State := 255; ELSE n State := n State+1; END_IF END_IF FB_SQLResult Evt [} 200] can then be used to read the data. Calling a function Functions can be called within SQL commands. Example (SQL) SQL script for creating a function: CREATE OR REPLACE FUNCTION "public"."F_get Last Data"() RETURNS refcursor LANGUAGE 'plpgsql' AS $BODY$ DECLARE result_data refcursor; BEGIN open result_data for SELECT * FROM "my Table_Double" ORDER BY "ID" DESC LIMIT 10; return result_data; END;$BODY$; The following SQL command is used to call the function: SELECT "public"."F_get Last Data"(); The call itself returns a "Ref Cursor". This is automatically interpreted by the Twin CAT Database Server. Example (Twin CAT 3 in ST) The FB_SQLCommand Evt [} 197] uses the command created by FB_SQLDatabase Evt. Create Cmd() [} 193]. VAR fb Sql Command : FB_SQLCommand Evt(s Net ID := '', t Timeout := T#5S); tc Message : I_Tc Message; END_VAR s Cmd := 'SELECT "public"."get Last Data"();'; // call sql command IF fb SQLCommand. Execute Data Return(ADR(s Cmd), SIZEOF(s Cmd), ADR(fb Sql Result)) THEN IF fb SQLCommand.b Error THEN tc Message := fb SQLCommand.ip Tc Result; n State := 255; // error state ELSE n State := n State+1; END_IF END_IF FB_SQLResult Evt [} 200] can then be used to read the data sets. It is advisable to use this program code in a State Machine. Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 13743810955.zip 356 Version: 1.13.8 TF6420
## Page 357

Examples 7.1.2.5 Cyclical data and time series databases This document describes the handling of time series and how cyclic data is stored in time series databases. Database used: Influx DB Database type used: Time Series DB Introduction Writing of data at regular or cyclic intervals is a common application in control technology. The data should be recorded with high time precision. Since database communication is not real-time capable, it is useful to store data that is measured regularly in a buffer. An array of the data structure can be used for this purpose. The collected data is then sent to the Twin CAT Database Server, where it can be processed without time constraints and subsequently stored in the database. Time Each data set that is stored in the database is assigned a timestamp. Together with the tag columns these form a unique ID. If two data sets have the same ID (same timestamp and tag values), the newer data set overwrites the old one. Example: time locationname (tag) temperature (field) windspeed (field) 1 1581675200630326200 Verl 11.5 6.3 2 1581675200630327200 Verl 10.3 5.2 3 1581675200630328200 Verl 9.8 2.8 4 1581675200630328200 Hamburg 14.2 14.9 4 1581675200630328200 Hamburg 15.6 8.9 … … … … … Data set no. 4 is overwritten by a new data set, since the ID is identical. The timestamp in the database is saved by default as UNIX epoch time. With the exception of the user- created insert commands, the timestamps are received and converted as Twin CAT time (number of 100 ns steps since January 1, 1601) in the function blocks of the Twin CAT 3 Database Server. The times are not converted for insert commands. Database configuration Influx DB should be selected in the database configuration. Insert the connection parameters for the required database. If no database is available yet, you can create the database by clicking the "Create" button. Pay attention to your firewall settings or port approvals. A table does not have to be created, since it is automatically created during the first Influx DB access. Influx DB does not have a fixed table schema. Columns can also be extended or added later. Writing cyclic data This example shows how symbols can be written from the PLC into a time series database with minimal effort. Declaration: State: E_Db Log State; b Writing: BOOL; // Set this bool fla to write the data once into the Influx DB dbid: UDINT := 1; // Handle to the configured database Query Option_TSDB_Insert : T_Query Option Time Series DB_Insert; // defines detailed Queryparameter fb No SQLQuery Builder_Time Series DB : FB_No SQLQuery Builder_Time Series DB; // defines database type specific api fb No Sql Query Evt : FB_No SQLQuery Evt(s Net ID := '', t Timeout := T#15S); // functionblock to execute TF6420 Version: 1.13.8 357
## Page 358

Examples queries // databuffer for 1 second with 10 ms time delta wind Turbine Data: ARRAY[1..100] OF Wind Turbine Data; // error handling helper values Tc Result: Tc3_Database. I_Tc Message; b Error: BOOL; s Error Message: STRING(255); i: INT; rand : DRAND; nrand: LREAL; Declaring the data source structure: In this structure the attributes "Tag Name" and "Field Name" are used to declare the data fields as tags or fields. By default they are declared as fields. These attributes can also be used if you want the column name in the table to differ from the symbol name in the PLC. To capture unset data during data analysis, default values outside the value range can be used to detect such data during the analysis. TYPE Wind Turbine Data : STRUCT {attribute 'Tag Name' := 'ID'} Wind Turbine ID : STRING(255); {attribute 'Field Name' := 'Power'} Power : LREAL := -1; // [0) [k W] {attribute 'Field Name' := 'Wind Speed'} Wind Speed : LREAL := -1; // [0) [m/s] {attribute 'Field Name' := 'Wind Direction'} Wind Direction : LREAL := -1; // [0,360][°] END_STRUCT END_TYPE (Wind Turbine Data.tc DUT) Declaration of the ENUM for the State-Machine: TYPE E_Db Log State : ( idle := 0, init, writing, error ); END_TYPE Generating sample data: FOR i := 1 TO 100 BY 1 DO rand(); nrand := rand. Num; wind Turbine Data[i]. Wind Direction := 240.328 + nrand; wind Turbine Data[i]. Wind Speed := 7.3292 + nrand; wind Turbine Data[i]. Power := 1133.1975 + nrand; wind Turbine Data[i]. Wind Turbine ID := 'Wind Turbine Verl 13'; END_FOR CASE State OF E_Db Log State.idle: IF b Writing THEN b Writing := FALSE; State := E_Db Log State.init; END_IF Preparing the call: 358 Version: 1.13.8 TF6420
## Page 359

Examples In this case, the array 'wind Turbine Data' is written into the 'Wind Measurement' table of the database. Therefore the data is read directly from the process image. The data type is specified to read the addresses in the memory. The time of the data sets is automatically generated by specifying the start time and the time interval. The data must be stored correctly in the array. For example, one data set in the array can be used per PLC cycle. It is useful to create a PLC task for this process. In this example the cycle time is 10 ms. E_Db Log State.init: fb No SQLQuery Builder_Time Series DB.p Query Options := ADR(Query Option_TSDB_Insert); fb No SQLQuery Builder_Time Series DB.cb Query Options := SIZEOF(Query Option_TSDB_Insert); Query Option_TSDB_Insert.s Table Name := 'Wind Measurement'; Query Option_TSDB_Insert.s Data Type := 'Wind Turbine Data'; Query Option_TSDB_Insert.p Symbol := ADR(wind Turbine Data); Query Option_TSDB_Insert.cb Symbol := SIZEOF(wind Turbine Data); Query Option_TSDB_Insert.n Data Count := 100; Query Option_TSDB_Insert.n Start Timestamp := F_Get System Time(); Query Option_TSDB_Insert.n Cycle Time := 10000; // (in 100 ns) State := E_Db Log State.writing; Writing the data: This call writes the data to the configured database with the corresponding database ID. This can take several cycles, since it is an asynchronous process. If necessary, several storage arrays must be used to ensure that the data is recorded seamlessly without gaps. E_Db Log State.writing: IF fb No Sql Query Evt. Execute(dbid, fb No SQLQuery Builder_Time Series DB) THEN IF fb No Sql Query Evt.b Error THEN Tc Result := fb No Sql Query Evt.ip Tc Result; State := E_Db Log State.error; ELSE State := E_Db Log State.idle; END_IF END_IF Error handling: Use the Tc3 Eventlogger for error handling E_Db Log State.error: IF Tc Result. Request Event Text(1033, s Error Message, SIZEOF(s Error Message)) THEN Tc Result. Send(F_Get System Time()); State := E_Db Log State.idle; b Error := TRUE; END_IF END_CASE Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 13743809291.zip 7.2 Tc2_Database All sample applications for the Twin CAT Database Server were consolidated in a solution. The solution can be downloaded here from a central location: https://infosys.beckhoff.com/content/1033/ TF6420_Tc3_Database_Server/Resources/3494041099.zip In addition to the tszip file for the Twin CAT 3 solution, the zip file contains all the required file-based databases. If the folder "Samples" from the zip file is located in the default installation folder: C: \Twin CAT\Functions\TF6420-Database-Server\Win32, the paths in the Database Server configuration do not have to be edited further. The samples with non-file-based databases, such as MS SQL, have to be individual adapted with the configurator. The individual samples are documented in detail on separate pages: TF6420 Version: 1.13.8 359
## Page 360

Examples SP project name Description Create_DB_Sample [} 360] Creating a database connection and a table from the PLC Cyclic_Rd Wrt_Sample [} 363] Cyclic logging/writing to/from a database Write_DB_Sample [} 364] Writing of variables into a database with a simple PLC function block without SQL command SQL_Insert Select_Sample [} 368] Sample with function block FB_DBRecord Insert/ FB_DBRecord Array Select Stored Procedures_Sample [} 370] Stored procedures with FB_DBStored Procedures Record Array XML_DB_Sample [} 373] Using XML files as database XML_XPath_Sample [} 378] XML XPath sample without schema XML_XPath_Schema_Sample [} 381] XML XPath sample with XML Schema, comparable with Twin CAT XML Server "Read" 7.2.1 Creating an MS Access database This example illustrates the creation of a database from the PLC. In addition, a table is added, and the database that has been generated is declared in the XML configuration file. Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 3494041099.zip 360 Version: 1.13.8 TF6420
## Page 361

Examples Database type used MS Access Compatible database types MS SQL, MS Compact SQL, MS Access, XML Function blocks used FB_DBCreate, FB_DBConnection Add, FB_DBTable Create Libraries to be integrated Tc2_Database, Tc2_System, Tc2_Standard Download file list Tc DBSrv_Info Sys Samples.tszip A table with the name "my Table", which has the following structure, is added to the generated database: Column name Data type Property ID Bigint IDENTITY(1,1) Timestamp datetime Name Ntext Value Float This table structure is generated with the following array: tablestrc: ARRAY [0..3] OF ST_DBColumn Cfg := [(s Column Name:='ID',s Column Property:='IDENTITY(1,1)',e Column Type:=EDBCOLUMN_BIGINT), (s Column Name:='Timestamp',e Column Type:=EDBCOLUMN_DATETIME), (s Column Name:='Name',e Column Type:=EDBCOLUMN_NTEXT), (s Column Name:='Value',e Column Type:=EDBCOLUMN_FLOAT)]; Variable Declaration PROGRAM MAIN VAR R_TRIG1 : R_TRIG; b START : BOOL; FB_File Delete1 : FB_File Delete; FB_DBCreate1 : FB_DBCreate; FB_DBConnection Add1: FB_DBConnection Add; FB_DBTable Create1 : FB_DBTable Create; b Busy_Delete : BOOL; b Busy_Create DB : BOOL; b Busy_Conn Add : BOOL; b Busy_Create Table : BOOL; b Err : BOOL; n Errid : UDINT; n DBid : UDINT; arr Tablestrc : ARRAY [0..3] OF ST_DBColumn Cfg := [(s Column Name:='ID',s Column Property:='IDENTITY(1,1)',e Column Type:=EDBCOLUMN_BIGINT), (s Column Name:='Timestamp',e Column Type:=EDBCOLUMN_DATETIME), (s Column Name:='Name',e Column Type:=EDBCOLUMN_NTEXT), (s Column Name:='Value',e Column Type:=EDBCOLUMN_FLOAT)]; n State:BYTE := 0; END_VAR PLC program CASE n State OF 0: (*To start this sample you have to set a rising edge to the variable b START*) R_TRIG1(CLK:=b START); IF R_TRIG1. Q THEN n State := 1; FB_File Delete1(b Execute:=FALSE); FB_DBCreate1(b Execute:=FALSE); FB_DBConnection Add1(b Execute:=FALSE); FB_DBTable Create1(b Execute:=FALSE); b START := FALSE; END_IF 1: (*It isn't possible to overwrite an existing database file. If the database file exist the FB_File Delete block will delete the file*) FB_File Delete1( TF6420 Version: 1.13.8 361
## Page 362

Examples s Net Id := , s Path Name:= 'C:\Twin CAT\Tc Database Srv\Samples\Test DB1000SPS.mdb', e Path := PATH_GENERIC, b Execute := TRUE, t Timeout := T#5s, b Busy => b Busy_Delete, b Error => , n Err Id => ); IF NOT b Busy_Delete THEN n State := 2; END_IF 2: (*The FB_DBCreate block will create the database file "C:\Twin CAT\Tc Database Srv\Samples\Test DB1000SPS.mdb"*) FB_DBCreate1( s Net ID := , s Path Name:= 'C:\Twin CAT\Tc Database Srv\Samples', s DBName := 'Test DB1000SPS', e DBType := e DBType_Access, b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy_Create DB, b Error => b Err, n Err ID => n Errid); IF NOT b Busy_Create DB AND NOT b Err THEN n State := 3; END_IF 3: (*The FB_DBConnection Add adds the connection information to the XML configuration file*) FB_DBConnection Add1( s Net ID := , e DBType := e DBType_Access, e DBValue Type:= e DBValue_Double, s DBServer := , s DBProvider := 'Microsoft. Jet. OLEDB.4.0', s DBUrl := 'C:\Twin CAT\Tc Database Srv\Samples\Test DB1000SPS.mdb', s DBTable := 'my Table', b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy_Conn Add, b Error => b Err, n Err ID => n Errid, h DBID => n DBid); IF NOT b Busy_Conn Add AND NOT b Err THEN n State := 4; END_IF 4: (*The FB_DBTable Create create the table "my Table"*) FB_DBTable Create1( s Net ID := , h DBID := n DBid, s Table Name := 'my Table', cb Table Cfg := SIZEOF(arr Tablestrc), p Table Cfg := ADR(arr Tablestrc), b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy_Create Table, b Error => b Err, n Err ID => n Errid); IF NOT b Busy_Create Table AND NOT b Err THEN n State := 0; END_IF END_CASE In order to use this sample, you only need to transfer the Net ID of the ADS device (on which the Twin CAT Database Server is installed) to the s Net ID input. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 362 Version: 1.13.8 TF6420
## Page 363

Examples 7.2.2 Starting / stopping, cyclic logging This sample illustrates the starting and stopping of cyclic logging from the PLC. Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 3494041099.zip Database type used MS Compact SQL Compatible database types ASCII, MS SQL, MS Compact SQL, MS Access, My SQL, Postgre SQL, DB2, Oracle, Inter Base/ Firebird, XML Function blocks used FB_DBCyclic Rd Wrt Libraries to be integrated Tc2_Database, Tc2_System, Tc2_Standard Download file list Tc DBSrv_Info Sys Samples.tszip, Current Config Data Base.xml, Test DB_Cyclic.sdf In this sample the cyclic log function is started or stopped by toggling the b Start Stop variable. The cyclic log process begins in response to a positive edge at the b Execute input. A negative edge will end the process again. Variable declaration (PRG data types) PROGRAM Data Types VAR DBSrv_DT_INT : INT; DBSrv_DT_UINT : UINT; DBSrv_DT_DINT : DINT; DBSrv_DT_UDINT : UDINT; DBSrv_DT_REAL : REAL; DBSrv_DT_LREAL : LREAL; DBSrv_DT_BYTE : BYTE := 16#A1; DBSrv_DT_BOOL : BOOL; DBSrv_DT_MYSTRUCT: ST_My Struct; DBSrv_DT_ARRAY : ARRAY [0..19] OF UDINT; TF6420 Version: 1.13.8 363
## Page 364

Examples DBSrv_DT_WORD : WORD; DBSrv_DT_DWORD : DWORD; END_VAR ST_My Struct structure TYPE ST_My Struct : STRUCT i Value1 : INT; i Value2 : UINT; i Value3 : BOOL; i Value4 : REAL; END_STRUCT END_TYPE Variable Declaration PROGRAM MAIN VAR fb DBCyclic Rd Wrt1: FB_DBCyclic Rd Wrt; b Cyclic : BOOL :=TRUE; b Busy_Cyclic : BOOL; b Err : BOOL; n Err ID : UDINT; s SQLState : ST_DBSQLError; END_VAR PLC program Data Types; fb DBCyclic Rd Wrt( s Net ID := , b Execute := b Cyclic, t Timeout := t#15s, b Busy => b Busy_Cyclic, b Error => b Err, n Err ID => n Err ID, s SQLState => s SQLState); In order to use this sample, you only need to transfer the Net ID of the ADS device (on which the Twin CAT Database Server is installed) to the s Net ID input. When you run the program and set the b Cyclic variable to TRUE, all the variables that are declared in the symbol group of the XML configuration file are logged. Twin CAT Database Server All Microsoft SQL Compact databases, which are declared in the XML configuration file, must exist. They are not generated automatically. The declared ASCII files, on the other hand, are generated automatically if they do not exist. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 7.2.3 Logging of a PLC variable with FB_DBWrite This sample illustrates logging of a PLC variables from the PLC in a database and the operating principle of the individual write modes. Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 3494041099.zip 364 Version: 1.13.8 TF6420
## Page 365

Examples Database type used MS SQL Compatible database types ASCII, MS SQL, MS Compact SQL, MS Access, My SQL, Postgre SQL, DB2, Oracle, Inter Base/ Firebird, XML Function blocks used FB_DBWrite Libraries to be integrated Tc2_Database, Tc2_System, Tc2_Standard Download file list Tc DBSrv_Info Sys Samples.tszip, Current Config Data Base.xml, SQLQuery.sql In order to be able to use this sample, you have to adapt the server name and the authentication in the XML configuration file (Current Config Data Base.xml). Ensure that no "Test DB" database is present before executing the SQLQuery.sql script. Sample configuration: The variable "e Write Mode" can be used to set the write mode for logging. The write operation can then be started with a positive edge at the variable "b START". Table assignment: • ADS_TO_DB_APPEND => e Write Append -> "tbl_Append" • ADS_TO_DB_UPDATE => e Write Update -> "tbl_Update" • ADS_TO_DB_RINGBUFFER => e Write Ring Buffer -> "tbl_Ring Buffer" TF6420 Version: 1.13.8 365
## Page 366

Examples Table structure used Column name Data type Null permitted Feature ID Bigint no IDENTITY(1,1) Timestamp datetime no Name Ntext no Value Float no Variable Declaration PROGRAM MAIN VAR (*Test symbol which will be logged into the different database tables*) lr Test Value Var : LREAL := 123.456; e State : E_Sample State := e Idle; R_TRIG1 : R_TRIG; (*With a rising edge at b Start the FB_DBWrite block will be start once*) b START : BOOL; (*With e Write Mode you can select which FB_DBWrite block will be used*) e Write Mode : E_Sample State := e Write Append; FB_DBWrite_Append : FB_DBWrite; FB_DBWrite_Update : FB_DBWrite; FB_DBWrite_Ring Buffer: FB_DBWrite; (*Status outputs from the three FB_DBWrite blocks*) b Busy : BOOL; b Err : BOOL; b Errid : UDINT; st Sqlstate : ST_DBSQLError; END_VAR Enum E_Sample State TYPE E_Sample State :( e Idle := 0, e Write Append := 1, e Write Update := 2, e Write Ring Buffer:= 3 ); END_TYPE PLC program CASE e State OF e Idle : R_TRIG1(CLK:=b START); IF R_TRIG1. Q THEN lr Test Value Var := lr Test Value Var + 1; e State := e Write Mode; b START := FALSE; END_IF (*Add a new record to the table tbl_Append*) e Write Append : FB_DBWrite_Append( s Net ID := , h DBID := 1, h Ads ID := 1, s Var Name := 'MAIN.lr Test Value Var', n IGroup := , n IOffset := , n Var Size := , s Var Type := , s DBVar Name := 'lr Test Value Var', e DBWrite Mode := e DBWrite Mode_Append, t Ring Buffer Time := , n Ring Buffer Count:= , b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy, b Error => b Err, n Err ID => b Errid, s SQLState => st Sqlstate); 366 Version: 1.13.8 TF6420
## Page 367

Examples IF NOT b Busy THEN FB_DBWrite_Append(b Execute := FALSE); e State := e Idle; END_IF (*Add a new record to the table tbl_Update if it not exist else the existing record will be updated*) e Write Update : FB_DBWrite_Update( s Net ID := , h DBID := 2, h Ads ID := 1, s Var Name := 'MAIN.lr Test Value Var', n IGroup := , n IOffset := , n Var Size := , s Var Type := , s DBVar Name := 'lr Test Value Var', e DBWrite Mode := e DBWrite Mode_Update, t Ring Buffer Time := , n Ring Buffer Count := , b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy, b Error => b Err, n Err ID => b Errid, s SQLState => st Sqlstate); IF NOT b Busy THEN FB_DBWrite_Update(b Execute := FALSE); e State := e Idle; END_IF (*Add a new record to the table tbl_Ring Buffer. If the maximum count is reached the records will be deleted in a FIFO process*) e Write Ring Buffer : FB_DBWrite_Ring Buffer( s Net ID := , h DBID := 3, h Ads ID := 1, s Var Name := 'MAIN.lr Test Value Var', n IGroup := , n IOffset := , n Var Size := , s Var Type := , s DBVar Name := 'lr Test Value Var', e DBWrite Mode := e DBWrite Mode_Ring Buffer_Count, t Ring Buffer Time := , n Ring Buffer Count := 10, b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy, b Error => b Err, n Err ID => b Errid, s SQLState => st Sqlstate); IF NOT b Busy THEN FB_DBWrite_Ring Buffer(b Execute := FALSE); e State := e Idle; END_IF END_CASE Twin CAT Database Server All Microsoft SQL Compact databases, which are declared in the XML configuration file, must exist. They are not generated automatically. The declared ASCII files, on the other hand, are generated automatically if they do not exist. Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database TF6420 Version: 1.13.8 367
## Page 368

Examples 7.2.4 Example with the FB_DBRecord Insert and FB_DBRecord Select function blocks This example illustrates logging of several values in a database from the PLC with the function block FB_DBRecord Insert. In this example, several PLC variables are logged in a single record. In addition, the function block FB_DBRecord Select can be used to read a record from this database. Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 3494041099.zip Database type used MS Access Compatible database types MS SQL, MS Compact SQL, MS Access, My SQL, Postgre SQL, DB2, Oracle, Inter Base/Firebird, XML Function blocks used FB_DBRecord Insert, FB_DBRecord Select Libraries to be integrated "Tc2_Database", "Tc2_System", "Tc2_Standard", "Tc2_Utilities" Download file list Tc DBSrv_Info Sys Samples.tszip, Current Config Data Base.xml, Test DB_Access.mdb The following table structure is used for writing: Column name Data type Timestamp datetime PLC_Test Value1 float PLC_Test Value2 float PLC_Test Value3 float PLC_Test Value4 String Variable Declaration (* Declaration *)PROGRAM MAIN VAR e State : E_SQLStatement; NT_Get Time1 : NT_Get Time; b Timestart : BOOL; 368 Version: 1.13.8 TF6420
## Page 369

Examples t Time : TIMESTRUCT; FB_Format String Date Time: FB_Format String; s Date Time String : T_Max String; Test Value1 : REAL := 123.456; Test Value2 : REAL := 234.567; Test Value3 : REAL := 345.678; Test Value4 : STRING(255) := 'No error occurred'; FB_Format String1 : FB_Format String; s Insert String : T_Max String; b Error : BOOL; n Errid : UDINT; FB_DBRecord Insert1: FB_DBRecord Insert; b Startstop Insert : BOOL; b Busy Insert : BOOL; b Err Insert : BOOL; n Errid Insert : UDINT; st SQLState Insert : ST_DBSQLError; st Record : ST_Record; FB_DBRecord Select1: FB_DBRecord Select; n Rec Index : UDINT := 0; b Startstop Select : BOOL; b Busy Select : BOOL; b Error Select : BOOL; n Err IDSelect : UDINT; st SQLState Select : ST_DBSQLError; n Record Count : UDINT; END_VAR Enum E_SQLStatement TYPEE_SQLStatement:( e SQL_INSERT := 0, e SQL_SELECT := 1 ); END_TYPE Struct ST_Record TYPEST_Record : STRUCT Timestamp : DT; PLC_Value1: REAL; PLC_Value2: REAL; PLC_Value3: REAL; PLC_Value4: STRING; END_STRUCT END_TYPE PLC program CASEe State OF e SQL_INSERT: (*Create the timestamp*) NT_Get Time1( START:= b Timestart, TIMESTR=> t Time); IF NOT NT_Get Time1. BUSY THEN b Timestart:= NOT b Timestart; END_IF FB_Format String Date Time( s Format := '%D.%D.%D %D:%D:%D', arg1 := F_WORD(t Time.w Year), arg2 := F_WORD(t Time.w Month), arg3 := F_WORD(t Time.w Day), arg4 := F_WORD(t Time.w Hour), arg5 := F_WORD(t Time.w Minute), arg6 := F_WORD(t Time.w Second), s Out => s Date Time String); (*Create the SQL-INSERT command*) FB_Format String1( s Format := 'INSERT INTO tbl_Test VALUES($'%S$',%F,%F,%F,$'%S$')', arg1 := F_STRING(s Date Time String), arg2 := F_REAL(Test Value1), TF6420 Version: 1.13.8 369
## Page 370

Examples arg3 := F_REAL(Test Value2), arg4 := F_REAL(Test Value3), arg5 := F_STRING(Test Value4), s Out => s Insert String, b Error => b Error, n Err Id => n Errid); (*Write the record to the database*) FB_DBRecord Insert1( s Net ID := , h DBID := 1, s Insert Cmd:= s Insert String, b Execute := b Startstop Insert, t Timeout := T#15s, b Busy => b Busy Insert, b Error => b Err Insert, n Err ID => n Errid Insert, s SQLState => st SQLState Insert); e SQL_SELECT: (*Read one record from the database*) FB_DBRecord Select1( s Net ID := , h DBID := 1, s Select Cmd:= 'SELECT * FROM tbl_Test', n Record Index:= n Rec Index, cb Record Size:= SIZEOF(st Record), p Dest Addr := ADR(st Record), b Execute := b Startstop Select, t Timeout := T#15s, b Busy => b Busy Select, b Error => b Error Select, n Err ID => n Err IDSelect, s SQLState => st SQLState Select, n Records => n Record Count); END_CASE To use this sample, you have to declare the Access database "Sample7.mdb" in the XML configuration file. A record with the four PLC values and the timestamp is created in the database by generating a positive edge at the variable "b Startstop Insert". Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 7.2.5 Stored procedures with FB_DBStored Procedures Record Array The function block FB_DBStored Procedures Record Array can be used to declare parameters as INPUT, OUTPUT or INOUT and transfer them to the stored procedures. In this way complex SQL commands can be preprogrammed in the database server and then triggered by the Twin CAT Database Server. In contrast to the function block FB_DBStored Procedures Record Return, this function block can be used to return several records with a single call. 370 Version: 1.13.8 TF6420
## Page 371

Examples Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 3494041099.zip Database type used MS SQL (MS SQL Server 2008) Compatible database types MS SQL, My SQL, Oracle Function blocks used FB_DBStored Procedures Record Array Libraries to be integrated Tc2_Database, Tc2_System, Tc2_Base, Tc2_Utilities Download file list Tc DBSrv_Info Sys Samples.tszip, Current Config Data Base.xml The following sample illustrates the call in a simple stored procedure with an input parameter and return record. The procedure was created on a Microsoft SQL Server 2008. Code der Stored Procedure SP_Get Address By Customer ID CREATE PROCEDURE [SP_Get Address By Customer ID] @Customer_ID bigint AS BEGIN SELECT tbl_Customer. ID, tbl_Customer. Name, tbl_Customer. Customer, tbl_Products. Ser Num, tbl_Products. Product, tbl_Products. Info, tbl_Pos. Timestamp FROM tbl_Pos JOIN tbl_Customer ON tbl_Pos. Customer Num = tbl_Customer. ID JOIN tbl_Products ON tbl_Pos. Product Num = tbl_Products. Ser Num WHERE tbl_Pos. Customer Num = @Customer_ID; END Variable declaration in the PLC PROGRAM MAIN VAR R_TRIG1 : R_TRIG; b READ : BOOL := FALSE; n State : BYTE; TF6420 Version: 1.13.8 371
## Page 372

Examples arr Para List : ARRAY [0..0] OF ST_DBParameter; n Customer ID : DINT := 12345; FB_DBStored Procedures Record Array1: FB_DBStored Procedures Record Array; n Customer ID: DINT:= 12345; n Record Start Index: UDINT; st Record Arr : ARRAY [1..25] OF ST_Record; n Recs : UDINT; b Busy : BOOL; b Err : BOOL; n Errid : UDINT; st Sqlstate : ST_DBSQLError; END_VAR Record structure in the PLC (ST_Record) TYPE ST_Record : STRUCT n ID : T_ULARGE_INTEGER; s Customer : STRING(50); s Name : STRING(50); n Product Num : DINT; s Product Name: STRING(50); s Product Info: T_Max String; t Timestamp : DT; END_STRUCT END_TYPE PLC program R_TRIG1(CLK:=b READ); IF R_TRIG1. Q AND NOT b Busy THEN n State := 1; END_IF CASE n State OF 0: ; 1:(*Init of the parameters*) arr Para List[0].s Parameter Name := '@Customer_ID'; arr Para List[0].e Parameter Data Type:= e DBColumn_Integer; arr Para List[0].e Parameter Type := e DBParameter_Input; arr Para List[0].cb Parameter Value := SIZEOF(n Customer ID); arr Para List[0].p Parameter Value := ADR(n Customer ID); n State := 2; 2:(*Start the stored procedure "SP_Get Customer Position"*) FB_DBStored Procedures Record Array1( s Net ID:= , h DBID:= 1, s Procedure Name := 'SP_Get Customer Positions', cb Parameter List := SIZEOF(arr Para List), p Parameter List := ADR(arr Para List), n Start Index := n Record Start Index, n Record Count := 25, cb Record Array Size:= SIZEOF(st Record Arr), p Dest Addr := ADR(st Record Arr), b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy, b Error => b Err, n Err ID => n Errid, s SQLState => st Sqlstate, n Records => n Recs); IF NOT b Busy THEN FB_DBStored Procedures Record Return1(b Execute:= FALSE); n State := 0; END_IF END_CASE 372 Version: 1.13.8 TF6420
## Page 373

Examples Visualization Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 7.2.6 Using XML as database The Twin CAT Database Server provides the ability to use an XML file as a database. Apart from the "Stored Procedure" functions, the XML database type supports all known function blocks for reading and writing in a database. Even SQL commands that can be issued with the function blocks FB_DBRecord Insert or FB_DBRecord Select are interpreted by the Twin CAT Database Server and applied to the XML file. This sample demonstrates how an XML database is created, filled with the function block FB_DBWrite and subsequently read with an SQL SELECT command and the function block FB_DBRecord Select. Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 3494041099.zip TF6420 Version: 1.13.8 373
## Page 374

Examples Database type used XML Compatible database types MS SQL, MS Compact SQL, MS Access, XML Function blocks used FB_DBCreate, FB_DBConnection Add, FB_DBTable Create, FB_DBWrite, FB_DBRecord Select Libraries to be integrated "Tc2_Database", "Tc2_System", "Tc2_Standard", "Tc2_Utilities" Download file list Tc DBSrv_Info Sys Samples.tszip MAIN program PROGRAM MAIN VAR n State :BYTE := 0; R_TRIG1 : R_TRIG; b START : BOOL; n Counter : INT; FB_File Delete1 : FB_File Delete; FB_DBCreate1 : FB_DBCreate; FB_DBConnection Add1: FB_DBConnection Add; FB_DBTable Create1 : FB_DBTable Create; 374 Version: 1.13.8 TF6420
## Page 375

Examples FB_DBWrite1 : FB_DBWrite; FB_DBRecord Select1 : FB_DBRecord Select; b Busy_Delete : BOOL; b Busy_Create DB : BOOL; b Busy_Conn Add : BOOL; b Busy_Create Table : BOOL; b Busy_Write DB : BOOL; b Busy_Select Record : BOOL; b Err : BOOL; n Errid : UDINT; st SQLState : ST_DBSQLError; n Recs : UDINT; n DBid : UDINT; arr Tablestrc : ARRAY [0..3] OF ST_DBColumn Cfg := [(s Column Name:='ID',s Column Property:='IDENTITY(1,1)',e Column Type:=EDBCOLUMN_BIGINT), (s Column Name:='Timestamp',e Column Type:=EDBCOLUMN_DATETIME), (s Column Name:='Name',s Column Property:='80',e Column Type:=EDBCOLUMN_NTEXT), (s Column Name:='Value',e Column Type:=EDBCOLUMN_FLOAT)]; r Test Value : LREAL := 1234.56789; st Record : ST_Record; END_VAR CASE n State OF 0: (*To start this sample you have to set a rising edge to the variable b START*) R_TRIG1(CLK:=b START); IF R_TRIG1. Q THEN n State := 1; FB_File Delete1(b Execute:=FALSE); FB_DBCreate1(b Execute:=FALSE); FB_DBConnection Add1(b Execute:=FALSE); FB_DBTable Create1(b Execute:=FALSE); FB_DBWrite1(b Execute:=FALSE); FB_DBRecord Select1(b Execute:=FALSE); b START := FALSE; n Counter:= 0; END_IF 1: (*It isn't possible to overwrite an existing database file. If the database file exist the FB_File Delete block will delete the file*) FB_File Delete1( s Net Id := , s Path Name:= 'C:\Twin CAT\Tc Database Srv\Samples\XMLTest DB.xml', e Path := PATH_GENERIC, b Execute := TRUE, t Timeout := T#5s, b Busy => b Busy_Delete, b Error => , n Err Id => ); IF NOT b Busy_Delete THEN n State := 10; END_IF 10: (*It isn't possible to overwrite an existing database file. If the database file exist the FB_File Delete block will delete the file*) FB_File Delete1( s Net Id := , s Path Name:= 'C:\Twin CAT\Tc Database Srv\Samples\XMLTest DB.xsd', e Path := PATH_GENERIC, b Execute := TRUE, t Timeout := T#5s, b Busy => b Busy_Delete, b Error => , n Err Id => ); IF NOT b Busy_Delete THEN FB_File Delete1(b Execute:=FALSE); n State := 2; END_IF 2: (*The FB_DBCreate block will create the database file "C:\Twin CAT\Tc Database Srv\Samples\XMLTest DB.xml" and C:\Twin CAT\Tc Database Srv\Samples\XMLTest DB.xsd "*) FB_DBCreate1( TF6420 Version: 1.13.8 375
## Page 376

Examples s Net ID := , s Path Name:= 'C:\Twin CAT\Tc Database Srv\Samples', s DBName := 'XMLTest DB', e DBType := e DBType_XML, b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy_Create DB, b Error => b Err, n Err ID => n Errid); IF NOT b Busy_Create DB AND NOT b Err THEN n State := 3; END_IF 3: (*The FB_DBConnection Add adds the connection information to the XML configuration file*) (*ATTENTION: Each database type has his own connection information*) FB_DBConnection Add1( s Net ID := , e DBType := e DBType_XML, e DBValue Type:= e DBValue_Double, s DBServer := 'XMLTest DB', s DBProvider := , s DBUrl := 'C:\Twin CAT\Tc Database Srv\Samples\XMLTest DB.xml', s DBTable := 'my Table', b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy_Conn Add, b Error => b Err, n Err ID => n Errid, h DBID => n DBid); IF NOT b Busy_Conn Add AND NOT b Err THEN n State := 4; END_IF 4: (*The FB_DBTable Create create the table "my Table"*) FB_DBTable Create1( s Net ID := , h DBID := n DBid, s Table Name := 'my Table', cb Table Cfg := SIZEOF(arr Tablestrc), p Table Cfg := ADR(arr Tablestrc), b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy_Create Table, b Error => b Err, n Err ID => n Errid); IF NOTb Busy_Create Table AND NOT b Err THEN n State := 5; END_IF 5: (*The FB_DBWrite write five times the value of the plc variable "r Test Value" to the database table "my Table"*) FB_DBWrite1( s Net ID := , h DBID := n DBid, h Ads ID := 1, s Var Name := 'MAIN.r Test Value', n IGroup := , n IOffset := , n Var Size := , s Var Type := , s DBVar Name := 'r Test Value', e DBWrite Mode := e DBWrite Mode_Append, t Ring Buffer Time := , n Ring Buffer Count:= , b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy_Write DB, b Error => b Err, n Err ID => n Errid, s SQLState => st SQLState); IF NOT b Busy_Write DB AND NOT b Err THEN FB_DBWrite1(b Execute := FALSE); n Counter := n Counter + 1; IFn Counter = 5 THEN n State := 6; 376 Version: 1.13.8 TF6420
## Page 377

Examples END_IF END_IF 6: (*The FB_DBRecord Select select one record of the database table "my Table""*) FB_DBRecord Select1( s Net ID := , h DBID := n DBid, s Select Cmd := 'SELECT * FROM my Table WHERE Name = $'r Test Value$'', n Record Index := 0, cb Record Size := SIZEOF(st Record), p Dest Addr := ADR(st Record), b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy_Select Record, b Error => b Err, n Err ID => n Errid, s SQLState => st SQLState, n Records => n Recs); IF NOT b Busy_Select Record AND NOT b Err THEN n State := 0; END_IF END_CASE The process is started with a positive edge at the toggle variable b START. The following files are created: XMLTest DB.xml (XML database file) <?xmlversion="1.0"encoding="UTF-8"?> <XMLTest DBxmlns:xs="http://www.w3.org/2001/XMLSchema- instance"xs:no Namespace Schema Location="XMLTest DB.xsd"> <my Table> <row ID="1"Timestamp="2012-05-10T13:48:47"Name="r Test Value"Value="1234.56789" /> <row ID="2"Timestamp="2012-05-10T13:48:47"Name="r Test Value"Value="1234.56789" /> <row ID="3"Timestamp="2012-05-10T13:48:47"Name="r Test Value"Value="1234.56789" /> <row ID="4"Timestamp="2012-05-10T13:48:47"Name="r Test Value"Value="1234.56789" /> <row ID="5"Timestamp="2012-05-10T13:48:47"Name="r Test Value"Value="1234.56789" /> </my Table> </XMLTest DB> XMLTest DB.xsd (XML Schema) <?xmlversion="1.0"?> <xsd:schemaxmlns:xsd="http://www.w3.org/2001/XMLSchema"> <xsd:simple Typename="bigint"> <xsd:restrictionbase="xsd:long" /> </xsd:simple Type> <xsd:simple Typename="datetime"> <xsd:restrictionbase="xsd:date Time" /> </xsd:simple Type> <xsd:simple Typename="ntext_80"> <xsd:restrictionbase="xsd:string"> <xsd:max Lengthvalue="80" /> </xsd:restriction> </xsd:simple Type> <xsd:simple Typename="float"> <xsd:restrictionbase="xsd:double" /> </xsd:simple Type> <xsd:complex Typename="my Table_Type"> <xsd:sequence> <xsd:elementmin Occurs="0"max Occurs="unbounded"name="row"> <xsd:complex Type> <xsd:attributename="ID"type="bigint" /> <xsd:attributename="Timestamp"type="datetime" /> <xsd:attributename="Name"type="ntext_80" /> <xsd:attributename="Value" type="float" /> </xsd:complex Type> </xsd:element> </xsd:sequence> </xsd:complex Type> <xsd:elementname="XMLTest DB"> <xsd:complex Type> <xsd:sequencemin Occurs="1"max Occurs="1"> <xsd:elementname="my Table"type="my Table_Type" /> </xsd:sequence> TF6420 Version: 1.13.8 377
## Page 378

Examples </xsd:complex Type> </xsd:element> </xsd:schema> Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 7.2.7 XPath sample to illustrate the different SELECT types The function block FB_DBRecord Array Select/FB_DBRecord Select can be used to issue XPath commands and read XML tags from any XML file. This sample illustrates reading of different entries from XML files via the Twin CAT Database Server. Individual tags, subtags and reading of attributes is supported, and these are displayed. Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 3494041099.zip Database type used XML Compatible database types XML Function blocks used FB_DBRecord Array Select Libraries to be integrated Tc2_Database, Tc2_System, Tc2_Standard, Tc2_Utilities Download file list Tc DBSrv_Info Sys Samples.tszip Sample XML file (XMLFactory XY.xml) <?xmlversion="1.0" encoding="utf-8" ?> <Factory_XY> <Name>Sample Factory XY</Name> <Factory_Info> <Street>Samplestreet 25</Street> <City>33415 Verl</City> <Country>Germany</Country> <Office_Count>1</Office_Count> <Employe_Count>6</Employe_Count> <Manager>Max Mustermann</Manager> </Factory_Info> 378 Version: 1.13.8 TF6420
## Page 379

Examples <Employees> <Employeeid="10001" name="Julia Kingston" department="Development" position="Worker" hired="2001-08-01" /> <Employeeid="10002" name="Jens Marx" department="Import" position="Worker" hired="2003-08-01" /> <Employeeid="10003" name="Justus Kaiser" department="Export" position="Worker" hired="2003-08-01" /> <Employeeid="10004" name="Marc Klein" department="Production" position="Worker" hired="2005-08-01" / > <Employeeid="10005" name="Matt Bloomberg" department="Production" position="Worker" hired="2005-08-01" /> <Employeeid="10006" name="Frida Hundt" department="Production" position="Worker" hired="2010-08-01" /> </Employees> </Factory_XY> ST_Factory Info structure TYPEST_Factory Info : STRUCT s Street : T_Max String; s City : T_Max String; s Country : T_Max String; s Office_Count : T_Max String; s Employe_Count: T_Max String; s Manager : T_Max String; END_STRUCT END_TYPE ST_Employee structure TYPEST_Employee : STRUCT s ID : T_Max String; s Name : T_Max String; s Department : T_Max String; s Position : T_Max String; s Hired : T_Max String; END_STRUCT END_TYPE MAIN program PROGRAM MAIN VAR b START : BOOL; R_TRIG1 : R_TRIG; n State : INT; s XPath : T_Max String; fb DBRecord Array Select : FB_DBRecord Array Select; b Busy_Read Factory Name : BOOL; b Error_Read Factory Name: BOOL; n Err ID_Read Factory Name: UDINT; b Busy_Read Factory Info : BOOL; b Error_Read Factory Info: BOOL; n Err ID_Read Factory Info: UDINT; b Busy_Read Employee : BOOL; b Error_Read Employee : BOOL; n Err ID_Read Employee : UDINT; st SQLState : ST_DBSQLError; s Factory Name : T_Max String; st Factory Info : ST_Factory Info; a Employees : ARRAY [1..10] OF ST_Employee; END_VAR R_TRIG1(CLK:=b START); IF R_TRIG1. Q THEN b START:=FALSE; fb DBRecord Array Select(b Execute:=FALSE); n State:=1; END_IF TF6420 Version: 1.13.8 379
## Page 380

Examples CASE n State OF 0://IDLE ; 1://Read Factory Name s XPath:= 'XPATH#Factory_XY/Name'; fb DBRecord Array Select( s Net ID := , h DBID := 7, p Cmd Addr := ADR(s XPath), cb Cmd Size := SIZEOF(s XPath), n Start Index := 0, n Record Count := 1, p Dest Addr := ADR(s Factory Name), cb Record Array Size:= SIZEOF(s Factory Name), b Execute := TRUE, t Timeout := T#15S, b Busy => b Busy_Read Factory Name, b Error => b Error_Read Factory Name, n Err ID => n Err ID_Read Factory Name, s SQLState => st SQLState, n Records => ); IF NOT b Busy_Read Factory Name THEN fb DBRecord Array Select(b Execute:=FALSE); IF NOT b Error_Read Factory Name THEN n State :=2; ELSE n State :=255; END_IFEND_IF 2://Read Factory Info s XPath := 'XPATH#Factory_XY/Factory_Info'; fb DBRecord Array Select( s Net ID := , h DBID := 7, p Cmd Addr := ADR(s XPath), cb Cmd Size := SIZEOF(s XPath), n Start Index := 0, n Record Count := 1, p Dest Addr := ADR(st Factory Info), cb Record Array Size := SIZEOF(st Factory Info), b Execute := TRUE, t Timeout := T#15S, b Busy => b Busy_Read Factory Info, b Error => b Error_Read Factory Info, n Err ID => n Err ID_Read Factory Info, s SQLState => st SQLState, n Records => ); IF NOT b Busy_Read Factory Info THEN fb DBRecord Array Select(b Execute:=FALSE); IF NOT b Error_Read Factory Info THEN n State :=3; ELSE n State :=255; END_IF END_IF 3://Read Employees s XPath := 'XPATH#Factory_XY/Employees/Employee'; fb DBRecord Array Select( s Net ID := , h DBID := 7, p Cmd Addr := ADR(s XPath), cb Cmd Size := SIZEOF(s XPath), n Start Index := 0, n Record Count := 10, p Dest Addr := ADR(a Employees), cb Record Array Size := SIZEOF(a Employees), b Execute := TRUE, t Timeout := T#15S, b Busy => b Busy_Read Employee, b Error => b Error_Read Employee, n Err ID => n Err ID_Read Employee, s SQLState => st SQLState, n Records => ); IF NOT b Busy_Read Employee THEN fb DBRecord Array Select(b Execute:=FALSE); IF NOT b Error_Read Employee THEN n State :=0; ELSE 380 Version: 1.13.8 TF6420
## Page 381

Examples n State :=255; END_IFEND_IF 255://Error State ; END_CASE A positive edge at the variable "b Start" triggers issuing of the XPath commands and reading of the individual elements from the XML file. The results will then be in the variables "s Factory Name", "st Factory Info" and "a Employees". Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database 7.2.8 XPath sample with XML schema The function blocks FB_DBRecord Select or FB_DBRecord Array Select can be used to issue XPath commands and to read XML tags, XML subtags or XML attributes from any XML file. If a suitable XML schema exists for the XML file to be read, the content of the tags or attributes is converted to the corresponding data types, as defined in the schema. Further information about XML schemas can be found here: http://www.edition-w3.de/TR/2001/REC- xmlschema-0-20010502/ In this sample, FB_DBRecord Array Select is used to read two different subtags from an XML file with corresponding XML schema. Download: https://infosys.beckhoff.com/content/1033/TF6420_Tc3_Database_Server/Resources/ 3494041099.zip TF6420 Version: 1.13.8 381
## Page 382

Examples Database type used XML Compatible database types XML Function blocks used FB_DBRecord Select Libraries to be integrated Tc2_Database, Tc2_System, Tc2_Standard, Tc2_Utilities Download file list Tc DBSrv_Info Sys Samples.tszip, Current Config Database.xml, PLC_Structs.xml, PLC_Structs.xsd Sample XML file (PLC_Structs.xml) <?xml version = "1.0" encoding="utf-8" ?> <Beckhoff_PLC> <PLC_Structs> <PLC_Struct Name="ST_Test Struct"> <Struct Instance="1"> <n INT64>123456789</n INT64> <n UINT16>1234</n UINT16> <r REAL64>1234.5678</r REAL64> <s STRING>This is instance one of ST_Test Struct</s STRING> <b BOOL>true</b BOOL> <n INT32>-100</n INT32> </Struct> <Struct Instance="2"> <n INT64>234567890</n INT64> <n UINT16>2345</n UINT16> <r REAL64>234.56789</r REAL64> <s STRING>This is instance two of ST_Test Struct</s STRING> <b BOOL>false</b BOOL> <n INT32>-50</n INT32> </Struct> <Struct Instance="3"> <n INT64>345678901</n INT64> <n UINT16>3456</n UINT16> <r REAL64>3456.78901</r REAL64> <s STRING>This is instance three of ST_Test Struct</s STRING> <b BOOL>true</b BOOL> <n INT32>-150</n INT32> </Struct> </PLC_Struct> <PLC_Struct Name="ST_Test Struct2"> <Struct2 Instance="1"> <s STRING>This is instance one of ST_Test Struct2</s STRING> <b BOOL>false</b BOOL> <n INT32>-88</n INT32> </Struct2> <Struct2 Instance="2"> <s STRING>This is instance two of ST_Test Struct2</s STRING> <b BOOL>true</b BOOL> <n INT32>-9</n INT32> </Struct2> </PLC_Struct> </PLC_Structs> </Beckhoff_PLC> Corresponding XML schema (PLC_Structs.xsd) <?xml version="1.0" encoding="utf-8"?> <xs:schema attribute Form Default="unqualified" element Form Default="qualified" xmlns:xs="http:// www.w3.org/2001/XMLSchema"> <xs:element name="Beckhoff_PLC"> <xs:complex Type > <xs:sequence > <xs:element name = "PLC_Structs"> <xs:complex Type> <xs:sequence> <xs:element max Occurs = "unbounded" name="PLC_Struct"> <xs:complex Type> <xs:sequence> <xs:element min Occurs = "0" max Occurs="unbounded" name="Struct"> <xs:complex Type> <xs:sequence> <xs:element name = "n INT64" type="xs:long" /> <xs:element name = "n UINT16" type="xs:unsigned Short" /> <xs:element name = "r REAL64" type="xs:double" /> 382 Version: 1.13.8 TF6420
## Page 383

Examples <xs:element name = "s STRING" type="xs:string" /> <xs:element name = "b BOOL" type="xs:boolean" /> <xs:element name = "n INT32" type="xs:int" /> </xs:sequence> <xs:attribute name = "Instance" type="xs:unsigned Byte" use="required" /> </xs:complex Type> </xs:element> <xs:element min Occurs = "0" max Occurs="unbounded" name="Struct2"> <xs:complex Type> <xs:sequence> <xs:element name = "s STRING" type="xs:string" /> <xs:element name = "b BOOL" type="xs:boolean" /> <xs:element name = "n INT32" type="xs:int" /> </xs:sequence> <xs:attribute name = "Instance" type="xs:unsigned Byte" use="required" /> </xs:complex Type> </xs:element> </xs:sequence> <xs:attribute name = "Name" type="xs:string" use="required" /> </xs:complex Type> </xs:element> </xs:sequence> </xs:complex Type> </xs:element> </xs:sequence> </xs:complex Type> </xs:element> </xs:schema> Structure1 ST_Test Struct TYPE ST_Test Struct : STRUCT n INT64 : T_LARGE_INTEGER; n UINT16: UINT; r REAL64: LREAL; s STRING: T_Max String; b BOOL : BOOL; n INT32 : DINT; END_STRUCT END_TYPE Structure2 ST_Test Struct2 TYPE ST_Test Struct2 : STRUCT s STRING: T_Max String; b BOOL : BOOL; n INT32 : DINT; END_STRUCT END_TYPE MAIN program PROGRAM MAIN VAR n State : BYTE; R_TRIG1 : R_TRIG; b Start Stop : BOOL; s Cmd : T_Max String; FB_DBRecord Array Select1: FB_DBRecord Array Select; arr Test Struct : ARRAY [0..3] OF ST_Test Struct; arr Test Struct2 : ARRAY [0..3] OF ST_Test Struct2; b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; st SQLState : ST_DBSQLError; n Recs1 : UDINT; n Recs2 : UDINT; END_VAR TF6420 Version: 1.13.8 383
## Page 384

Examples R_TRIG1(CLK:=b Start Stop); IF R_TRIG1. Q THEN FB_DBRecord Array Select1(b Execute:=FALSE); n State := 1; END_IF CASE n State OF 0:(*Idle*) ; 1: s Cmd:='XPATH<SUBTAG>#/Beckhoff_PLC/PLC_Structs/PLC_Struct[@Name=$'ST_Test Struct$']/Struct'; FB_DBRecord Array Select1( s Net ID := , h DBID := 1, cb Cmd Size := SIZEOF(s Cmd), p Cmd Addr := ADR(s Cmd), n Start Index := 0, n Record Count := 4, cb Record Array Size := SIZEOF(arr Test Struct), p Dest Addr := ADR(arr Test Struct), b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy, b Error => b Error, n Err ID => n Err ID, s SQLState => st SQLState, n Records => n Recs1); IF NOT b Busy THEN FB_DBRecord Array Select1(b Execute:=FALSE); IF NOT b Error THEN n State := 2; ELSE n State := 255; END_IFEND_IF 2: s Cmd:='XPATH<SUBTAG>#Beckhoff_PLC/PLC_Structs/PLC_Struct[@Name=$'ST_Test Struct2$']/Struct2'; FB_DBRecord Array Select1( s Net ID := , h DBID := 1, cb Cmd Size := SIZEOF(s Cmd), p Cmd Addr := ADR(s Cmd), n Start Index := 0, n Record Count := 4, cb Record Array Size := SIZEOF(arr Test Struct2), p Dest Addr := ADR(arr Test Struct2), b Execute := TRUE, t Timeout := T#15s, b Busy => b Busy, b Error => b Error, n Err ID => n Err ID, s SQLState => st SQLState, n Records => n Recs2); IF NOT b Busy THEN FB_DBRecord Array Select1(b Execute:=FALSE); IF NOT b Error THEN n State := 0; ELSE n State := 255; END_IFEND_IF 255: (* Error Step*) ; END_CASE Reading is started with a positive edge at the toggle variable "b Start Stop". 384 Version: 1.13.8 TF6420
## Page 385

Examples Requirements Development environment Target platform PLC libraries to be linked Twin CAT v3.0.0 PC or CX (x86) Tc2_Database TF6420 Version: 1.13.8 385
## Page 386

Appendix 8 Appendix 8.1 Error codes 8.1.1 Tc3_Database 8.1.1.1 PLC return values The error output of all PLC function blocks of the Tc3_Database.compiled library takes place via the I_Tc Result Event interfaces from the Tc3_Eventlogger.compiled library. This new interface structure enables a more detailed description of events, as well as classification. Interface I_Tc Message [} 225] n Event Id: UDINT; Event Class: GUID; e Severity: Tc Event Severity [} 226]; ip Source Info: I_Tc Source Info; n Event ID: Specific event code Event Class: GUID Event Class Name: The corresponding event class name can be read using the Request Event Class Name method e Severity: Event classification: from "Info" to "Critical error" ip Source Info: Path to the event location. Text: Description of the event in plain text can be read with the Request Event Text method The following event classes can occur: • TC3 ADS Error ADS errors that may occur during the communication with the Twin CAT Database Server. • TC3 Database Server Internal Error Internal errors that may occur if the Twin CAT Database Server is configured incorrectly. • TC3 Database Server Database Error Database errors that may occur during communication with the corresponding databases. The different database-specific error codes are mapped in a database error list. The database-specific codes are written into the Error Log, as required. • TC3 Database Server ADS Device Error ADS error that may occur during internal communication with configured ADS devices. • TC3 Database Server No SQL Error Database error of a No SQL database that occurred during communication with the corresponding databases. 386 Version: 1.13.8 TF6420
## Page 387

Appendix 8.1.1.2 ADS return codes Global error codes Hex Dec HRESULT Name Description 0x0 0 0x98110000 ERR_NOERROR No error. 0x1 1 0x98110001 ERR_INTERNAL Internal error. 0x2 2 0x98110002 ERR_NORTIME No real time. 0x3 3 0x98110003 ERR_ALLOCLOCKEDMEM Allocation locked – memory error. 0x4 4 0x98110004 ERR_INSERTMAILBOX Mailbox full – the ADS message could not be sent. Reducing the number of ADS messages per cycle will help. 0x5 5 0x98110005 ERR_WRONGRECEIVEHMSG Wrong HMSG. 0x6 6 0x98110006 ERR_TARGETPORTNOTFOUND Target port not found – ADS server is not started, not reachable or not installed. 0x7 7 0x98110007 ERR_TARGETMACHINENOTFOUND Target computer not found – AMS route was not found. 0x8 8 0x98110008 ERR_UNKNOWNCMDID Unknown command ID. 0x9 9 0x98110009 ERR_BADTASKID Invalid task ID. 0x A 10 0x9811000A ERR_NOIO No IO. 0x B 11 0x9811000B ERR_UNKNOWNAMSCMD Unknown AMS command. 0x C 12 0x9811000C ERR_WIN32ERROR Win32 error. 0x D 13 0x9811000D ERR_PORTNOTCONNECTED Port not connected. 0x E 14 0x9811000E ERR_INVALIDAMSLENGTH Invalid AMS length. 0x F 15 0x9811000F ERR_INVALIDAMSNETID Invalid AMS Net ID. 0x10 16 0x98110010 ERR_LOWINSTLEVEL Installation level is too low –Twin CAT 2 license error. 0x11 17 0x98110011 ERR_NODEBUGINTAVAILABLE No debugging available. 0x12 18 0x98110012 ERR_PORTDISABLED Port disabled – Twin CAT system service not started. 0x13 19 0x98110013 ERR_PORTALREADYCONNECTED Port already connected. 0x14 20 0x98110014 ERR_AMSSYNC_W32ERROR AMS Sync Win32 error. 0x15 21 0x98110015 ERR_AMSSYNC_TIMEOUT AMS Sync Timeout. 0x16 22 0x98110016 ERR_AMSSYNC_AMSERROR AMS Sync error. 0x17 23 0x98110017 ERR_AMSSYNC_NOINDEXINMAP No index map for AMS Sync available. 0x18 24 0x98110018 ERR_INVALIDAMSPORT Invalid AMS port. 0x19 25 0x98110019 ERR_NOMEMORY No memory. 0x1A 26 0x9811001A ERR_TCPSEND TCP send error. 0x1B 27 0x9811001B ERR_HOSTUNREACHABLE Host unreachable. 0x1C 28 0x9811001C ERR_INVALIDAMSFRAGMENT Invalid AMS fragment. 0x1D 29 0x9811001D ERR_TLSSEND TLS send error – secure ADS connection failed. 0x1E 30 0x9811001E ERR_ACCESSDENIED Access denied – secure ADS access denied. RTime error codes TF6420 Version: 1.13.8 387
## Page 388

Appendix Hex Dec HRESULT Name Description 0x1000 4096 0x98111000 RTERR_INTERNAL Internal error in the real-time system. 0x1001 4097 0x98111001 RTERR_BADTIMERPERIODS Timer value is not valid. 0x1002 4098 0x98111002 RTERR_INVALIDTASKPTR Task pointer has the invalid value 0 (zero). 0x1003 4099 0x98111003 RTERR_INVALIDSTACKPTR Stack pointer has the invalid value 0 (zero). 0x1004 4100 0x98111004 RTERR_PRIOEXISTS The request task priority is already assigned. 0x1005 4101 0x98111005 RTERR_NOMORETCB No free TCB (Task Control Block) available. The maximum number of TCBs is 64. 0x1006 4102 0x98111006 RTERR_NOMORESEMAS No free semaphores available. The maximum number of semaphores is 64. 0x1007 4103 0x98111007 RTERR_NOMOREQUEUES No free space available in the queue. The maximum number of positions in the queue is 64. 0x100D 4109 0x9811100D RTERR_EXTIRQALREADYDEF An external synchronization interrupt is already applied. 0x100E 4110 0x9811100E RTERR_EXTIRQNOTDEF No external sync interrupt applied. 0x100F 4111 0x9811100F RTERR_EXTIRQINSTALLFAILED Application of the external synchronization interrupt has failed. 0x1010 4112 0x98111010 RTERR_IRQLNOTLESSOREQUAL Call of a service function in the wrong context 0x1017 4119 0x98111017 RTERR_VMXNOTSUPPORTED Intel® VT-x extension is not supported. 0x1018 4120 0x98111018 RTERR_VMXDISABLED Intel® VT-x extension is not enabled in the BIOS. 0x1019 4121 0x98111019 RTERR_VMXCONTROLSMISSING Missing function in Intel® VT-x extension. 0x101A 4122 0x9811101A RTERR_VMXENABLEFAILS Activation of Intel® VT-x fails. Router error codes Hex Dec HRESULT Name Description 0x500 1280 0x98110500 ROUTERERR_NOLOCKEDMEMORY Locked memory cannot be allocated. 0x501 1281 0x98110501 ROUTERERR_RESIZEMEMORY The router memory size could not be changed. 0x502 1282 0x98110502 ROUTERERR_MAILBOXFULL The mailbox has reached the maximum number of possible messages. 0x503 1283 0x98110503 ROUTERERR_DEBUGBOXFULL The Debug mailbox has reached the maximum number of possible messages. 0x504 1284 0x98110504 ROUTERERR_UNKNOWNPORTTYPE The port type is unknown. 0x505 1285 0x98110505 ROUTERERR_NOTINITIALIZED The router is not initialized. 0x506 1286 0x98110506 ROUTERERR_PORTALREADYINUSE The port number is already assigned. 0x507 1287 0x98110507 ROUTERERR_NOTREGISTERED The port is not registered. 0x508 1288 0x98110508 ROUTERERR_NOMOREQUEUES The maximum number of ports has been reached. 0x509 1289 0x98110509 ROUTERERR_INVALIDPORT The port is invalid. 0x50A 1290 0x9811050A ROUTERERR_NOTACTIVATED The router is not active. 0x50B 1291 0x9811050B ROUTERERR_FRAGMENTBOXFULL The mailbox has reached the maximum number for fragmented messages. 0x50C 1292 0x9811050C ROUTERERR_FRAGMENTTIMEOUT A fragment timeout has occurred. 0x50D 1293 0x9811050D ROUTERERR_TOBEREMOVED The port is removed. General ADS error codes 388 Version: 1.13.8 TF6420
## Page 389

Appendix Hex Dec HRESULT Name Description 0x700 1792 0x98110700 ADSERR_DEVICE_ERROR General device error. 0x701 1793 0x98110701 ADSERR_DEVICE_SRVNOTSUPP Service is not supported by the server. 0x702 1794 0x98110702 ADSERR_DEVICE_INVALIDGRP Invalid index group. 0x703 1795 0x98110703 ADSERR_DEVICE_INVALIDOFFSET Invalid index offset. 0x704 1796 0x98110704 ADSERR_DEVICE_INVALIDACCESS Reading or writing not permitted. Several causes are possible. For example, an incorrect password was entered when creating routes. 0x705 1797 0x98110705 ADSERR_DEVICE_INVALIDSIZE Parameter size not correct. 0x706 1798 0x98110706 ADSERR_DEVICE_INVALIDDATA Invalid data values. 0x707 1799 0x98110707 ADSERR_DEVICE_NOTREADY Device is not ready to operate. 0x708 1800 0x98110708 ADSERR_DEVICE_BUSY Device is busy. 0x709 1801 0x98110709 ADSERR_DEVICE_INVALIDCONTEXT Invalid operating system context. This can result from use of ADS blocks in different tasks. It may be possible to resolve this through multitasking synchronization in the PLC. 0x70A 1802 0x9811070A ADSERR_DEVICE_NOMEMORY Insufficient memory. 0x70B 1803 0x9811070B ADSERR_DEVICE_INVALIDPARM Invalid parameter values. 0x70C 1804 0x9811070C ADSERR_DEVICE_NOTFOUND Not found (files, ...). 0x70D 1805 0x9811070D ADSERR_DEVICE_SYNTAX Syntax error in file or command. 0x70E 1806 0x9811070E ADSERR_DEVICE_INCOMPATIBLE Objects do not match. 0x70F 1807 0x9811070F ADSERR_DEVICE_EXISTS Object already exists. 0x710 1808 0x98110710 ADSERR_DEVICE_SYMBOLNOTFOUND Symbol not found. 0x711 1809 0x98110711 ADSERR_DEVICE_SYMBOLVERSIONINVALID Invalid symbol version. This can occur due to an online change. Create a new handle. 0x712 1810 0x98110712 ADSERR_DEVICE_INVALIDSTATE Device (server) is in invalid state. 0x713 1811 0x98110713 ADSERR_DEVICE_TRANSMODENOTSUPP Ads Trans Mode not supported. 0x714 1812 0x98110714 ADSERR_DEVICE_NOTIFYHNDINVALID Notification handle is invalid. 0x715 1813 0x98110715 ADSERR_DEVICE_CLIENTUNKNOWN Notification client not registered. 0x716 1814 0x98110716 ADSERR_DEVICE_NOMOREHDLS No further handle available. 0x717 1815 0x98110717 ADSERR_DEVICE_INVALIDWATCHSIZE Notification size too large. 0x718 1816 0x98110718 ADSERR_DEVICE_NOTINIT Device not initialized. 0x719 1817 0x98110719 ADSERR_DEVICE_TIMEOUT Device has a timeout. 0x71A 1818 0x9811071A ADSERR_DEVICE_NOINTERFACE Interface query failed. 0x71B 1819 0x9811071B ADSERR_DEVICE_INVALIDINTERFACE Wrong interface requested. 0x71C 1820 0x9811071C ADSERR_DEVICE_INVALIDCLSID Class ID is invalid. 0x71D 1821 0x9811071D ADSERR_DEVICE_INVALIDOBJID Object ID is invalid. 0x71E 1822 0x9811071E ADSERR_DEVICE_PENDING Request pending. 0x71F 1823 0x9811071F ADSERR_DEVICE_ABORTED Request is aborted. 0x720 1824 0x98110720 ADSERR_DEVICE_WARNING Signal warning. 0x721 1825 0x98110721 ADSERR_DEVICE_INVALIDARRAYIDX Invalid array index. 0x722 1826 0x98110722 ADSERR_DEVICE_SYMBOLNOTACTIVE Symbol not active. 0x723 1827 0x98110723 ADSERR_DEVICE_ACCESSDENIED Access denied. Several causes are possible. For example, a unidirectional ADS route is used in the opposite direction. 0x724 1828 0x98110724 ADSERR_DEVICE_LICENSENOTFOUND Missing license. 0x725 1829 0x98110725 ADSERR_DEVICE_LICENSEEXPIRED License expired. 0x726 1830 0x98110726 ADSERR_DEVICE_LICENSEEXCEEDED License exceeded. 0x727 1831 0x98110727 ADSERR_DEVICE_LICENSEINVALID Invalid license. 0x728 1832 0x98110728 ADSERR_DEVICE_LICENSESYSTEMID License problem: System ID is invalid. 0x729 1833 0x98110729 ADSERR_DEVICE_LICENSENOTIMELIMIT License not limited in time. 0x72A 1834 0x9811072A ADSERR_DEVICE_LICENSEFUTUREISSUE Licensing problem: time in the future. 0x72B 1835 0x9811072B ADSERR_DEVICE_LICENSETIMETOLONG License period too long. 0x72C 1836 0x9811072C ADSERR_DEVICE_EXCEPTION Exception at system startup. 0x72D 1837 0x9811072D ADSERR_DEVICE_LICENSEDUPLICATED License file read twice. 0x72E 1838 0x9811072E ADSERR_DEVICE_SIGNATUREINVALID Invalid signature. 0x72F 1839 0x9811072F ADSERR_DEVICE_CERTIFICATEINVALID Invalid certificate. 0x730 1840 0x98110730 ADSERR_DEVICE_LICENSEOEMNOTFOUND Public key not known from OEM. 0x731 1841 0x98110731 ADSERR_DEVICE_LICENSERESTRICTED License not valid for this system ID. TF6420 Version: 1.13.8 389
## Page 390

Appendix Hex Dec HRESULT Name Description 0x732 1842 0x98110732 ADSERR_DEVICE_LICENSEDEMODENIED Demo license prohibited. 0x733 1843 0x98110733 ADSERR_DEVICE_INVALIDFNCID Invalid function ID. 0x734 1844 0x98110734 ADSERR_DEVICE_OUTOFRANGE Outside the valid range. 0x735 1845 0x98110735 ADSERR_DEVICE_INVALIDALIGNMENT Invalid alignment. 0x736 1846 0x98110736 ADSERR_DEVICE_LICENSEPLATFORM Invalid platform level. 0x737 1847 0x98110737 ADSERR_DEVICE_FORWARD_PL Context – forward to passive level. 0x738 1848 0x98110738 ADSERR_DEVICE_FORWARD_DL Context – forward to dispatch level. 0x739 1849 0x98110739 ADSERR_DEVICE_FORWARD_RT Context – forward to real-time. 0x740 1856 0x98110740 ADSERR_CLIENT_ERROR Client error. 0x741 1857 0x98110741 ADSERR_CLIENT_INVALIDPARM Service contains an invalid parameter. 0x742 1858 0x98110742 ADSERR_CLIENT_LISTEMPTY Polling list is empty. 0x743 1859 0x98110743 ADSERR_CLIENT_VARUSED Var connection already in use. 0x744 1860 0x98110744 ADSERR_CLIENT_DUPLINVOKEID The called ID is already in use. 0x745 1861 0x98110745 ADSERR_CLIENT_SYNCTIMEOUT Timeout has occurred – the remote terminal is not responding in the specified ADS timeout. The route setting of the remote terminal may be configured incorrectly. 0x746 1862 0x98110746 ADSERR_CLIENT_W32ERROR Error in Win32 subsystem. 0x747 1863 0x98110747 ADSERR_CLIENT_TIMEOUTINVALID Invalid client timeout value. 0x748 1864 0x98110748 ADSERR_CLIENT_PORTNOTOPEN Port not open. 0x749 1865 0x98110749 ADSERR_CLIENT_NOAMSADDR No AMS address. 0x750 1872 0x98110750 ADSERR_CLIENT_SYNCINTERNAL Internal error in Ads sync. 0x751 1873 0x98110751 ADSERR_CLIENT_ADDHASH Hash table overflow. 0x752 1874 0x98110752 ADSERR_CLIENT_REMOVEHASH Key not found in the table. 0x753 1875 0x98110753 ADSERR_CLIENT_NOMORESYM No symbols in the cache. 0x754 1876 0x98110754 ADSERR_CLIENT_SYNCRESINVALID Invalid response received. 0x755 1877 0x98110755 ADSERR_CLIENT_SYNCPORTLOCKED Sync Port is locked. 0x756 1878 0x98110756 ADSERR_CLIENT_REQUESTCANCELLED The request was canceled. 8.1.1.3 Database return codes 390 Version: 1.13.8 TF6420
## Page 391

Appendix Error Code Error Name Error Description 1 DB_SQLState_01000 General warning 2 DB_SQLState_01001 Cursor operation conflict 3 DB_SQLState_01002 Disconnect error 4 DB_SQLState_01003 NULL value eliminated in set function 5 DB_SQLState_01004 String data, right-truncated 6 DB_SQLState_01006 Privilege not revoked 7 DB_SQLState_01007 Privilege not granted 8 DB_SQLState_01S00 Invalid connection string attribute 9 DB_SQLState_01S01 Error in row 10 DB_SQLState_01S02 Option value changed 11 DB_SQLState_01S06 Attempt to fetch before the result set returned the first row set 12 DB_SQLState_01S07 Fractional truncation 13 DB_SQLState_01S08 Error saving File DSN 14 DB_SQLState_01S09 Invalid keyword 15 DB_SQLState_07000 Dynamic SQL error 16 DB_SQLState_07001 Wrong number of parameters 17 DB_SQLState_07002 COUNT field incorrect 18 DB_SQLState_07005 Prepared statement not a cursor-specification 19 DB_SQLState_07006 Restricted data type attribute violation 20 DB_SQLState_07009 Invalid descriptor index 21 DB_SQLState_07S01 Invalid use of default parameter 22 DB_SQLState_08000 Connection exception 23 DB_SQLState_08001 Client unable to establish connection 24 DB_SQLState_08002 Connection name in use 25 DB_SQLState_08003 Connection not open 26 DB_SQLState_08004 Server rejected the connection 27 DB_SQLState_08007 Connection failure during transaction 28 DB_SQLState_08S01 Communication link failure 29 DB_SQLState_21000 Cardinality violation 30 DB_SQLState_21S01 Insert value list does not match column list 31 DB_SQLState_21S02 Degree of derived table does not match column list 32 DB_SQLState_22000 Data exception 33 DB_SQLState_22001 String data, right-truncated 34 DB_SQLState_22002 Indicator variable required but not supplied 35 DB_SQLState_22003 Numeric value out of range 36 DB_SQLState_22007 Invalid datetime format 37 DB_SQLState_22008 Date/time field overflow 38 DB_SQLState_22012 Division by zero 39 DB_SQLState_22015 Interval field overflow 40 DB_SQLState_22018 Invalid character value for cast specification 41 DB_SQLState_22019 Invalid escape character 42 DB_SQLState_22025 Invalid escape sequence 43 DB_SQLState_22026 String data, length mismatch TF6420 Version: 1.13.8 391
## Page 392

Appendix 44 DB_SQLState_23000 Integrity constraint violation 45 DB_SQLState_24000 Invalid cursor state 46 DB_SQLState_25000 Invalid transaction state 47 DB_SQLState_25S01 Transaction state 48 DB_SQLState_25S02 Transaction is still active 49 DB_SQLState_25S03 Transaction is rolled back 50 DB_SQLState_28000 Invalid authorization specification 51 DB_SQLState_34000 Invalid cursor name 52 DB_SQLState_3C000 Duplicate cursor name 53 DB_SQLState_3D000 Invalid catalog name 54 DB_SQLState_3F000 Invalid schema name 55 DB_SQLState_40000 Transaction rollback 56 DB_SQLState_40001 Serialization failure 57 DB_SQLState_40002 Integrity constraint violation 58 DB_SQLState_40003 Statement completion unknown 59 DB_SQLState_42000 Syntax error or access violation 60 DB_SQLState_42S01 Base table or view already exists 61 DB_SQLState_42S02 Base table or view not found 62 DB_SQLState_42S11 Index already exists 63 DB_SQLState_42S12 Index not found 64 DB_SQLState_42S21 Column already exists 65 DB_SQLState_42S22 Column not found 66 DB_SQLState_44000 WITH CHECK OPTION violation 67 DB_SQLState_HY000 General error 68 DB_SQLState_HY001 Memory allocation error 69 DB_SQLState_HY003 Invalid application buffer type 70 DB_SQLState_HY004 Invalid SQL data type 71 DB_SQLState_HY007 Associated statement is not prepared 72 DB_SQLState_HY008 Operation cancelled 73 DB_SQLState_HY009 Invalid use of null pointer 74 DB_SQLState_HY010 Function sequence error 75 DB_SQLState_HY011 Attribute cannot be set now 76 DB_SQLState_HY012 Invalid transaction operation code 77 DB_SQLState_HY013 Memory management error 78 DB_SQLState_HY014 Limit on the number of handles exceeded 79 DB_SQLState_HY015 No cursor name available 80 DB_SQLState_HY016 Cannot modify an implementation row descriptor 81 DB_SQLState_HY017 Invalid use of an automatically allocated descriptor handle 392 Version: 1.13.8 TF6420
## Page 393

Appendix 82 DB_SQLState_HY018 Server declined cancel request 83 DB_SQLState_HY019 Non-character and non-binary data sent in pieces 84 DB_SQLState_HY020 Attempt to concatenate a null value 85 DB_SQLState_HY021 Inconsistent descriptor information 86 DB_SQLState_HY024 Invalid attribute value 87 DB_SQLState_HY090 Invalid string or buffer length 88 DB_SQLState_HY091 Invalid descriptor field identifier 89 DB_SQLState_HY092 Invalid attribute/option identifier 90 DB_SQLState_HY095 Function type out of range 91 DB_SQLState_HY096 Invalid information type 92 DB_SQLState_HY097 Column type out of range 93 DB_SQLState_HY098 Scope type out of range 94 DB_SQLState_HY099 Nullable type out of range 95 DB_SQLState_HY100 Uniqueness option type out of range 96 DB_SQLState_HY101 Accuracy option type out of range 97 DB_SQLState_HY103 Invalid retrieval code 98 DB_SQLState_HY104 Invalid precision or scale value 99 DB_SQLState_HY105 Invalid parameter type 100 DB_SQLState_HY106 Fetch type out of range 101 DB_SQLState_HY107 Row value out of range 102 DB_SQLState_HY109 Invalid cursor position 103 DB_SQLState_HY110 Invalid driver completion 104 DB_SQLState_HY111 Invalid bookmark value 105 DB_SQLState_HYC00 Optional feature not implemented 106 DB_SQLState_HYT00 Timeout expired 107 DB_SQLState_HYT01 Connection timeout expired 108 DB_SQLState_IM001 Driver does not support this function 109 DB_SQLState_IM002 Data source name not found and no default driver specified 110 DB_SQLState_IM003 Specified driver could not be loaded 111 DB_SQLState_IM004 Driver's SQLAlloc Handle on SQL_HANDLE_ENV failed 112 DB_SQLState_IM005 Driver's SQLAlloc Handle on SQL_HANDLE_DBC failed 113 DB_SQLState_IM006 Driver's SQLSet Connect Attr failed 114 DB_SQLState_IM007 No data source or driver specified dialog prohibited 115 DB_SQLState_IM008 Dialog failed 116 DB_SQLState_IM009 Unable to load translation DLL 117 DB_SQLState_IM010 Data source name too long 118 DB_SQLState_IM011 Driver name too long 119 DB_SQLState_IM012 DRIVER keyword syntax error 120 DB_SQLState_IM013 Trace file error 121 DB_SQLState_IM014 Invalid name of File DSN 122 DB_SQLState_IM015 Corrupt file data source 200 DB_Function Not Impleme Function not implemented nted 255 DB_SQLState_Unspecifie Unspecified Error d TF6420 Version: 1.13.8 393
## Page 394

Appendix 8.1.1.4 No SQL database return codes Error Code Error Name Error Description 0 No Sql_0 No Error 1 No Sql_Specific_1 Internal Mongo DB exception. Please check the information log for more details. 2 No Sql_Specific_2 Database side error. Please check the information log for more details. 8 No Sql_Specific_8 Timeout error occurred on command execution 9 No Sql_Specific_9 Format error occurred on command execution. Please check the command or document syntax. 11 No Sql_Specific_11 Run Command execution failed. Please check the event log for more information 12 No Sql_Specific_12 There is no metadata including the tableschema for this table 13 No Sql_Specific_13 Syntax error in command / filter 14 No Sql_Specific_14 Connection error occured 15 No Sql_Specific_15 Authentication failed 16 No Sql_Specific_16 Error occured during write operation 20 No Sql_Specific_20 Functionality is not supported by the Twin CAT Database Server 48 No Sql_Specific_48 Namespace / Collection Name already exists 51 No Sql_Specific_51 The queried data is empty 141 No Sql_Specific_141 Internal Twin CAT 3 Database Server Error 8.1.1.5 Twin CAT database server codes 394 Version: 1.13.8 TF6420
## Page 395

Appendix Error Code Error Name Error Description 0 Internal Error Code_0 No Error 1 Internal Error Code_1 NULL Values not allowed 2 Internal Error Code_2 FB_DBRead selected value is NULL 3 Internal Error Code_3 DBID is unknown 4 Internal Error Code_4 ADSDev ID is unknown 5 Internal Error Code_5 No open database connection found for DBID: xy 6 Internal Error Code_6 No open ADS Device connection found for ADSDev ID: xy 7 Internal Error Code_7 Init of Auto Log Groups failed 8 Internal Error Code_8 Auto Log could NOT be started. Twin CAT Database Server has no valid device state 9 Internal Error Code_9 Record select value return => Wrong Parametersize from ADS-Device 10 Internal Error Code_10 Invalid Parameter 11 Internal Error Code_11 Couldn’t find PLCDBWrite Value in list 12 Internal Error Code_12 No valid symbol TYPE 13 Internal Error Code_13 Invalid parameter size 14 Internal Error Code_14 Execution timeout 15 Internal Error Code_15 Database connection already open 16 Internal Error Code_16 Database connection not initialized 1000 Internal Error Code_1000 Unknown internal Error 8.1.2 Tc2_Database 8.1.2.1 ADS Return Codes Grouping of error codes: Global error codes: 0x0000 [} 395]... (0x9811_0000 ...) Router error codes: 0x500 [} 396]... (0x9811_0500 ...) General ADS errors: 0x700 [} 396]... (0x9811_0700 ...) RTime error codes: 0x1000 [} 398]... (0x9811_1000 ...) Global error codes TF6420 Version: 1.13.8 395
## Page 396

Appendix Hex Dec HRESULT Name Description 0x0 0 0x98110000 ERR_NOERROR No error. 0x1 1 0x98110001 ERR_INTERNAL Internal error. 0x2 2 0x98110002 ERR_NORTIME No real time. 0x3 3 0x98110003 ERR_ALLOCLOCKEDMEM Allocation locked – memory error. 0x4 4 0x98110004 ERR_INSERTMAILBOX Mailbox full – the ADS message could not be sent. Reducing the number of ADS messages per cycle will help. 0x5 5 0x98110005 ERR_WRONGRECEIVEHMSG Wrong HMSG. 0x6 6 0x98110006 ERR_TARGETPORTNOTFOUND Target port not found – ADS server is not started, not reachable or not installed. 0x7 7 0x98110007 ERR_TARGETMACHINENOTFOUND Target computer not found – AMS route was not found. 0x8 8 0x98110008 ERR_UNKNOWNCMDID Unknown command ID. 0x9 9 0x98110009 ERR_BADTASKID Invalid task ID. 0x A 10 0x9811000A ERR_NOIO No IO. 0x B 11 0x9811000B ERR_UNKNOWNAMSCMD Unknown AMS command. 0x C 12 0x9811000C ERR_WIN32ERROR Win32 error. 0x D 13 0x9811000D ERR_PORTNOTCONNECTED Port not connected. 0x E 14 0x9811000E ERR_INVALIDAMSLENGTH Invalid AMS length. 0x F 15 0x9811000F ERR_INVALIDAMSNETID Invalid AMS Net ID. 0x10 16 0x98110010 ERR_LOWINSTLEVEL Installation level is too low –Twin CAT 2 license error. 0x11 17 0x98110011 ERR_NODEBUGINTAVAILABLE No debugging available. 0x12 18 0x98110012 ERR_PORTDISABLED Port disabled – Twin CAT system service not started. 0x13 19 0x98110013 ERR_PORTALREADYCONNECTED Port already connected. 0x14 20 0x98110014 ERR_AMSSYNC_W32ERROR AMS Sync Win32 error. 0x15 21 0x98110015 ERR_AMSSYNC_TIMEOUT AMS Sync Timeout. 0x16 22 0x98110016 ERR_AMSSYNC_AMSERROR AMS Sync error. 0x17 23 0x98110017 ERR_AMSSYNC_NOINDEXINMAP No index map for AMS Sync available. 0x18 24 0x98110018 ERR_INVALIDAMSPORT Invalid AMS port. 0x19 25 0x98110019 ERR_NOMEMORY No memory. 0x1A 26 0x9811001A ERR_TCPSEND TCP send error. 0x1B 27 0x9811001B ERR_HOSTUNREACHABLE Host unreachable. 0x1C 28 0x9811001C ERR_INVALIDAMSFRAGMENT Invalid AMS fragment. 0x1D 29 0x9811001D ERR_TLSSEND TLS send error – secure ADS connection failed. 0x1E 30 0x9811001E ERR_ACCESSDENIED Access denied – secure ADS access denied. Router error codes Hex Dec HRESULT Name Description 0x500 1280 0x98110500 ROUTERERR_NOLOCKEDMEMORY Locked memory cannot be allocated. 0x501 1281 0x98110501 ROUTERERR_RESIZEMEMORY The router memory size could not be changed. 0x502 1282 0x98110502 ROUTERERR_MAILBOXFULL The mailbox has reached the maximum number of possible messages. 0x503 1283 0x98110503 ROUTERERR_DEBUGBOXFULL The Debug mailbox has reached the maximum number of possible messages. 0x504 1284 0x98110504 ROUTERERR_UNKNOWNPORTTYPE The port type is unknown. 0x505 1285 0x98110505 ROUTERERR_NOTINITIALIZED The router is not initialized. 0x506 1286 0x98110506 ROUTERERR_PORTALREADYINUSE The port number is already assigned. 0x507 1287 0x98110507 ROUTERERR_NOTREGISTERED The port is not registered. 0x508 1288 0x98110508 ROUTERERR_NOMOREQUEUES The maximum number of ports has been reached. 0x509 1289 0x98110509 ROUTERERR_INVALIDPORT The port is invalid. 0x50A 1290 0x9811050A ROUTERERR_NOTACTIVATED The router is not active. 0x50B 1291 0x9811050B ROUTERERR_FRAGMENTBOXFULL The mailbox has reached the maximum number for fragmented messages. 0x50C 1292 0x9811050C ROUTERERR_FRAGMENTTIMEOUT A fragment timeout has occurred. 0x50D 1293 0x9811050D ROUTERERR_TOBEREMOVED The port is removed. General ADS error codes 396 Version: 1.13.8 TF6420
## Page 397

Appendix Hex Dec HRESULT Name Description 0x700 1792 0x98110700 ADSERR_DEVICE_ERROR General device error. 0x701 1793 0x98110701 ADSERR_DEVICE_SRVNOTSUPP Service is not supported by the server. 0x702 1794 0x98110702 ADSERR_DEVICE_INVALIDGRP Invalid index group. 0x703 1795 0x98110703 ADSERR_DEVICE_INVALIDOFFSET Invalid index offset. 0x704 1796 0x98110704 ADSERR_DEVICE_INVALIDACCESS Reading or writing not permitted. Several causes are possible. For example, an incorrect password was entered when creating routes. 0x705 1797 0x98110705 ADSERR_DEVICE_INVALIDSIZE Parameter size not correct. 0x706 1798 0x98110706 ADSERR_DEVICE_INVALIDDATA Invalid data values. 0x707 1799 0x98110707 ADSERR_DEVICE_NOTREADY Device is not ready to operate. 0x708 1800 0x98110708 ADSERR_DEVICE_BUSY Device is busy. 0x709 1801 0x98110709 ADSERR_DEVICE_INVALIDCONTEXT Invalid operating system context. This can result from use of ADS blocks in different tasks. It may be possible to resolve this through multitasking synchronization in the PLC. 0x70A 1802 0x9811070A ADSERR_DEVICE_NOMEMORY Insufficient memory. 0x70B 1803 0x9811070B ADSERR_DEVICE_INVALIDPARM Invalid parameter values. 0x70C 1804 0x9811070C ADSERR_DEVICE_NOTFOUND Not found (files, ...). 0x70D 1805 0x9811070D ADSERR_DEVICE_SYNTAX Syntax error in file or command. 0x70E 1806 0x9811070E ADSERR_DEVICE_INCOMPATIBLE Objects do not match. 0x70F 1807 0x9811070F ADSERR_DEVICE_EXISTS Object already exists. 0x710 1808 0x98110710 ADSERR_DEVICE_SYMBOLNOTFOUND Symbol not found. 0x711 1809 0x98110711 ADSERR_DEVICE_SYMBOLVERSIONINVALID Invalid symbol version. This can occur due to an online change. Create a new handle. 0x712 1810 0x98110712 ADSERR_DEVICE_INVALIDSTATE Device (server) is in invalid state. 0x713 1811 0x98110713 ADSERR_DEVICE_TRANSMODENOTSUPP Ads Trans Mode not supported. 0x714 1812 0x98110714 ADSERR_DEVICE_NOTIFYHNDINVALID Notification handle is invalid. 0x715 1813 0x98110715 ADSERR_DEVICE_CLIENTUNKNOWN Notification client not registered. 0x716 1814 0x98110716 ADSERR_DEVICE_NOMOREHDLS No further handle available. 0x717 1815 0x98110717 ADSERR_DEVICE_INVALIDWATCHSIZE Notification size too large. 0x718 1816 0x98110718 ADSERR_DEVICE_NOTINIT Device not initialized. 0x719 1817 0x98110719 ADSERR_DEVICE_TIMEOUT Device has a timeout. 0x71A 1818 0x9811071A ADSERR_DEVICE_NOINTERFACE Interface query failed. 0x71B 1819 0x9811071B ADSERR_DEVICE_INVALIDINTERFACE Wrong interface requested. 0x71C 1820 0x9811071C ADSERR_DEVICE_INVALIDCLSID Class ID is invalid. 0x71D 1821 0x9811071D ADSERR_DEVICE_INVALIDOBJID Object ID is invalid. 0x71E 1822 0x9811071E ADSERR_DEVICE_PENDING Request pending. 0x71F 1823 0x9811071F ADSERR_DEVICE_ABORTED Request is aborted. 0x720 1824 0x98110720 ADSERR_DEVICE_WARNING Signal warning. 0x721 1825 0x98110721 ADSERR_DEVICE_INVALIDARRAYIDX Invalid array index. 0x722 1826 0x98110722 ADSERR_DEVICE_SYMBOLNOTACTIVE Symbol not active. 0x723 1827 0x98110723 ADSERR_DEVICE_ACCESSDENIED Access denied. Several causes are possible. For example, a unidirectional ADS route is used in the opposite direction. 0x724 1828 0x98110724 ADSERR_DEVICE_LICENSENOTFOUND Missing license. 0x725 1829 0x98110725 ADSERR_DEVICE_LICENSEEXPIRED License expired. 0x726 1830 0x98110726 ADSERR_DEVICE_LICENSEEXCEEDED License exceeded. 0x727 1831 0x98110727 ADSERR_DEVICE_LICENSEINVALID Invalid license. 0x728 1832 0x98110728 ADSERR_DEVICE_LICENSESYSTEMID License problem: System ID is invalid. 0x729 1833 0x98110729 ADSERR_DEVICE_LICENSENOTIMELIMIT License not limited in time. 0x72A 1834 0x9811072A ADSERR_DEVICE_LICENSEFUTUREISSUE Licensing problem: time in the future. 0x72B 1835 0x9811072B ADSERR_DEVICE_LICENSETIMETOLONG License period too long. 0x72C 1836 0x9811072C ADSERR_DEVICE_EXCEPTION Exception at system startup. 0x72D 1837 0x9811072D ADSERR_DEVICE_LICENSEDUPLICATED License file read twice. 0x72E 1838 0x9811072E ADSERR_DEVICE_SIGNATUREINVALID Invalid signature. 0x72F 1839 0x9811072F ADSERR_DEVICE_CERTIFICATEINVALID Invalid certificate. 0x730 1840 0x98110730 ADSERR_DEVICE_LICENSEOEMNOTFOUND Public key not known from OEM. 0x731 1841 0x98110731 ADSERR_DEVICE_LICENSERESTRICTED License not valid for this system ID. TF6420 Version: 1.13.8 397
## Page 398

Appendix Hex Dec HRESULT Name Description 0x732 1842 0x98110732 ADSERR_DEVICE_LICENSEDEMODENIED Demo license prohibited. 0x733 1843 0x98110733 ADSERR_DEVICE_INVALIDFNCID Invalid function ID. 0x734 1844 0x98110734 ADSERR_DEVICE_OUTOFRANGE Outside the valid range. 0x735 1845 0x98110735 ADSERR_DEVICE_INVALIDALIGNMENT Invalid alignment. 0x736 1846 0x98110736 ADSERR_DEVICE_LICENSEPLATFORM Invalid platform level. 0x737 1847 0x98110737 ADSERR_DEVICE_FORWARD_PL Context – forward to passive level. 0x738 1848 0x98110738 ADSERR_DEVICE_FORWARD_DL Context – forward to dispatch level. 0x739 1849 0x98110739 ADSERR_DEVICE_FORWARD_RT Context – forward to real-time. 0x740 1856 0x98110740 ADSERR_CLIENT_ERROR Client error. 0x741 1857 0x98110741 ADSERR_CLIENT_INVALIDPARM Service contains an invalid parameter. 0x742 1858 0x98110742 ADSERR_CLIENT_LISTEMPTY Polling list is empty. 0x743 1859 0x98110743 ADSERR_CLIENT_VARUSED Var connection already in use. 0x744 1860 0x98110744 ADSERR_CLIENT_DUPLINVOKEID The called ID is already in use. 0x745 1861 0x98110745 ADSERR_CLIENT_SYNCTIMEOUT Timeout has occurred – the remote terminal is not responding in the specified ADS timeout. The route setting of the remote terminal may be configured incorrectly. 0x746 1862 0x98110746 ADSERR_CLIENT_W32ERROR Error in Win32 subsystem. 0x747 1863 0x98110747 ADSERR_CLIENT_TIMEOUTINVALID Invalid client timeout value. 0x748 1864 0x98110748 ADSERR_CLIENT_PORTNOTOPEN Port not open. 0x749 1865 0x98110749 ADSERR_CLIENT_NOAMSADDR No AMS address. 0x750 1872 0x98110750 ADSERR_CLIENT_SYNCINTERNAL Internal error in Ads sync. 0x751 1873 0x98110751 ADSERR_CLIENT_ADDHASH Hash table overflow. 0x752 1874 0x98110752 ADSERR_CLIENT_REMOVEHASH Key not found in the table. 0x753 1875 0x98110753 ADSERR_CLIENT_NOMORESYM No symbols in the cache. 0x754 1876 0x98110754 ADSERR_CLIENT_SYNCRESINVALID Invalid response received. 0x755 1877 0x98110755 ADSERR_CLIENT_SYNCPORTLOCKED Sync Port is locked. 0x756 1878 0x98110756 ADSERR_CLIENT_REQUESTCANCELLED The request was canceled. RTime error codes Hex Dec HRESULT Name Description 0x1000 4096 0x98111000 RTERR_INTERNAL Internal error in the real-time system. 0x1001 4097 0x98111001 RTERR_BADTIMERPERIODS Timer value is not valid. 0x1002 4098 0x98111002 RTERR_INVALIDTASKPTR Task pointer has the invalid value 0 (zero). 0x1003 4099 0x98111003 RTERR_INVALIDSTACKPTR Stack pointer has the invalid value 0 (zero). 0x1004 4100 0x98111004 RTERR_PRIOEXISTS The request task priority is already assigned. 0x1005 4101 0x98111005 RTERR_NOMORETCB No free TCB (Task Control Block) available. The maximum number of TCBs is 64. 0x1006 4102 0x98111006 RTERR_NOMORESEMAS No free semaphores available. The maximum number of semaphores is 64. 0x1007 4103 0x98111007 RTERR_NOMOREQUEUES No free space available in the queue. The maximum number of positions in the queue is 64. 0x100D 4109 0x9811100D RTERR_EXTIRQALREADYDEF An external synchronization interrupt is already applied. 0x100E 4110 0x9811100E RTERR_EXTIRQNOTDEF No external sync interrupt applied. 0x100F 4111 0x9811100F RTERR_EXTIRQINSTALLFAILED Application of the external synchronization interrupt has failed. 0x1010 4112 0x98111010 RTERR_IRQLNOTLESSOREQUAL Call of a service function in the wrong context 0x1017 4119 0x98111017 RTERR_VMXNOTSUPPORTED Intel® VT-x extension is not supported. 0x1018 4120 0x98111018 RTERR_VMXDISABLED Intel® VT-x extension is not enabled in the BIOS. 0x1019 4121 0x98111019 RTERR_VMXCONTROLSMISSING Missing function in Intel® VT-x extension. 0x101A 4122 0x9811101A RTERR_VMXENABLEFAILS Activation of Intel® VT-x fails. Specific positive HRESULT Return Codes: 398 Version: 1.13.8 TF6420
## Page 399

Appendix HRESULT Name Description 0x0000_0000 S_OK No error. 0x0000_0001 S_FALSE No error. Example: successful processing, but with a negative or incomplete result. 0x0000_0203 S_PENDING No error. Example: successful processing, but no result is available yet. 0x0000_0256 S_WATCHDOG_TIMEOUT No error. Example: successful processing, but a timeout occurred. TCP Winsock error codes Hex Dec Name Description 0x274C 10060 WSAETIMEDOUT A connection timeout has occurred - error while establishing the connection, because the remote terminal did not respond properly after a certain period of time, or the established connection could not be maintained because the connected host did not respond. 0x274D 10061 WSAECONNREFUSED Connection refused - no connection could be established because the target computer has explicitly rejected it. This error usually results from an attempt to connect to a service that is inactive on the external host, that is, a service for which no server application is running. 0x2751 10065 WSAEHOSTUNREACH No route to host - a socket operation referred to an unavailable host. More Winsock error codes: Win32 error codes 8.1.2.2 Twin CAT Database Server error codes overview Code (hex) Code (Dec) Description 0x0001 + ADS error code 65537 - 131071 ADS error code from declared ADS device 0x00020001 131073 Microsoft SQL Compact database (error code) 0x00040001 262145 Microsoft SQL database (error code) 0x00080001 524289 Microsoft Access database (error code) 0x00100001 1048577 My SQL database (error code) 0x00200001 2097153 Oracle database (error code) 0x00400001 4194305 DB2 database (error code) 0x00800001 8388609 Postgre SQL database (error code) 0x01000001 16777217 Interbase/Firebird database (error code) 0x02000001 33554433 Twin CAT Database Server error code [} 406] 0x04000001 67108865 XML database (error code) 0x08000001 134217729 ASCII database (error code) If one of the error codes mentioned above is issued at the "n Err ID" output of a function block, an error has occurred during execution of an SQL statement. The SQL error code is then issued at the "s SQLState" output of the function block. The "s SQLState" output has the data type ST_DBSQLError [} 322]. For each database type individual error codes are output. A list of SQLStates can be found under: http://msdn.microsoft.com/en-us/library/ms714687(VS.85).aspx (SQLStates) TF6420 Version: 1.13.8 399
## Page 400

Appendix Database type Error code reference Microsoft SQL Compact database http://technet.microsoft.com/en-us/library/ ms171788.aspx / Ole DB_Errorcodes.htm [} 401] Microsoft SQL database Ole DB_Errorcodes.htm [} 401] Microsoft Access database Ole DB_Errorcodes.htm [} 401] My SQL database https://dev.mysql.com/doc/mysql-errors/8.0/en/ client-error-reference.html Oracle database https://docs.oracle.com/cd/E11882_01/server.112/ e17766/toc.htm DB2 database https://www.ibm.com/docs/en/db2-for-zos/12? topic=diagnostics-sqlstates-odbc-error-reporting Postgre SQL database http://www.postgresql.org/docs/current/static/ errcodes-appendix.html Interbase/Firebird database http://www.firebirdsql.org/file/documentation/ reference_manuals/reference_material/Firebird-2.1- Error Codes.pdf XML database Tc DBServer_XML_Errorcodes.htm [} 406] ASCII database Tc DBServer_ASCII_Errorcodes.htm [} 406] 400 Version: 1.13.8 TF6420
## Page 401

Appendix 8.1.2.3 Ole DB error codes TF6420 Version: 1.13.8 401
## Page 402

Appendix Value Description 0x80040E00 The accessor is invalid. 0x80040E01 It was not possible to insert a row into the row set, because the maximum number of active rows for the provider would have been exceeded. 0x80040E02 The accessor is write-protected. The procedure has failed. 0x80040E03 Values violate the database schema. 0x80040E04 The row handle is invalid. 0x80040E05 The object was open. 0x80040E06 Invalid chapter 0x80040E07 A literal value in the command could not be converted to the correct type for a reason other than data overflow. 0x80040E08 Invalid binding information 0x80040E09 Permission denied 0x80040E0A The specified column contains no bookmarks or chapters. 0x80040E0B Some cost limitations were rejected. 0x80040E0C No command was specified for the command object. 0x80040E0D No query plan was found within the specified cost limitation. 0x80040E0E Invalid bookmark 0x80040E0F Invalid lock mode 0x80040E10 No value was specified for at least one of the required parameters. 0x80040E11 Invalid column ID 0x80040E12 Invalid quota 0x80040E13 Invalid value 0x80040E14 The command contained at least one error. 0x80040E15 The currently executed command cannot be aborted. 0x80040E16 The provider offers no support for the specified dialect. 0x80040E17 A data source with the specified name already exists. 0x80040E18 The row set was created via a live datastream and cannot be restarted. 0x80040E19 In the current range no key matches the described characteristics. 0x80040E1B The provider is unable to determine the identity for the newly added rows. 0x80040E1A The ownership of this structure was transferred to the provider. 0x80040E1C Non-zero weighting values are not supported as target information. The target was therefore rejected. The current target was not changed. 0x80040E1D The requested conversion is not supported. 0x80040E1E Rows Offset leads to position after the end of the row set, irrespective of the specified c Rows value. c Rows Obtained is 0. 0x80040E20 The provider has called an IRowset Notify method in the consumer and has not yet received a return from the method. 0x80040E21 Error 0x80040E22 A non-zero controlling IUnknown object was specified, and the currently created object does not support aggregation. 0x80040E23 The current row was deleted. 0x80040E24 The row set does not support backward calls. 0x80040E25 All HROW objects have to be released before new HROW objects can be received. 0x80040E26 A specified memory flag was not supported. 0x80040E27 The comparison operator was invalid. 0x80040E28 The specified status flag was neither DBCOLUMNSTATUS_OK nor DBCOLUMNSTATUS_ISNULL. 0x80040E29 The row set cannot be processed backwards. 0x80040E2A Invalid range handle. 402 Version: 1.13.8 TF6420
## Page 403

Appendix Value Description 0x80040E2B The specified row set was not adjacent to the rows of the specified monitoring range, and there was no overlap. 0x80040E2C A transition from ALL* to MOVE* or EXTEND* was specified. 0x80040E2D The specified range is not a valid subrange of the range identified by the specified monitoring range handle. 0x80040E2E The provider does not support commands with several statements. 0x80040E2F A specified value violated the integrity restrictions for a column or table. 0x80040E30 The specified type name was not recognized. 0x80040E31 Execution was aborted, since no further resources were available. No results were returned. 0x80040E32 A command object with a command hierarchy containing at least one row set could not be cloned. 0x80040E33 The current structure cannot be shown as text. 0x80040E34 The specified index already exists. 0x80040E35 The specified index does not exist. 0x80040E36 The specified index was used. 0x80040E37 The specified table does not exist. 0x80040E38 The row set has uses fully parallelism, and the value of a column was changed since the last read operation. 0x80040E39 Errors were found during copying. 0x80040E3A A precision statement was invalid. 0x80040E3B A specified decimal value was invalid. 0x80040E3C Invalid table ID. 0x80040E3D A specified type was invalid. 0x80040E3E A column ID occurred several times in the specification. 0x80040E3F The specified table already exists. 0x80040E40 The specified table was used. 0x80040E41 The specified range schema ID was not supported. 0x80040E42 The specified record number is invalid. 0x80040E43 No matching row could be found, despite the fact that the bookmark formatting was valid. 0x80040E44 The value of a property was invalid. 0x80040E45 The row set was not subdivided into chapters. 0x80040E46 Invalid accessor 0x80040E47 Invalid memory flags 0x80040E48 Accessors for transfer as reference are not supported by this provider. 0x80040E49 NULL accessors are not supported by this provider. 0x80040E4A The command was not prepared. 0x80040E4B The specified accessor was not a parameter accessor. 0x80040E4C The specified accessor was write-protected. 0x80040E4D Error during authentication. 0x80040E4E The change was aborted during the notification; no columns were modified. 0x80040E4F The row set consisted of a chapter, but the chapter was not enabled. 0x80040E50 Invalid source handle 0x80040E51 The provider is unable to derive parameter information, and Set Parameter Info was not called. 0x80040E52 The data source object is already initialized. 0x80040E53 The provider does not support this method. 0x80040E54 The number of rows with pending modifications exceeds the specified limit. 0x80040E55 The specified column did not exist. TF6420 Version: 1.13.8 403
## Page 404

Appendix Value Description 0x80040E56 Changes are pending in a row with a reference counter of zero. 0x80040E57 A literal value in the command let to a range violation for the type of the assigned column. 0x80040E58 The transferred HRESULT value was invalid. 0x80040E59 The transferred Lookup ID value was invalid. 0x80040E5A The transferred Dynamic Error ID value was invalid. 0x80040E5B No visible data for a newly added row that has not yet been updated can be retrieved. 0x80040E5C Invalid conversion flag 0x80040E5D The specified parameter name was not recognized. 0x80040E5E Several memory objects cannot be open simultaneously. 0x80040E5F The requested filter could not be opened. 0x80040E60 The requested sequence could not be opened. 0x80040E65 The transferred column ID value was invalid. 0x80040E67 The transferred command has no DBID value. 0x80040E68 The transferred DBID value already exists. 0x80040E69 The maximum number of session objects supported by this provider has already been reached. The consumer must release at least one current session object, before a new session object can be retrieved. 0x80040E72 The index ID is invalid. 0x80040E73 The specified initialization character sequence does not match the specification. 0x80040E74 The OLE DB master enumerator has not returned any providers that match the requested SOURCES_TYPE value. 0x80040E75 The initialization character sequence indicates a provider that does not match the currently active provider. 0x80040E76 The specified DBID value is invalid. 0x80040E6A Invalid value for trust recipient. 0x80040E6B The trust recipient is not intended for the current data source. 0x80040E6C The trust recipient offers no support for memberships/list. 0x80040E6D The object is invalid, or the provider is unknown. 0x80040E6E The object has no owner. 0x80040E6F The transferred access entry list is invalid. 0x80040E70 The trust recipient transferred as owner is invalid, or the provider is unknown. 0x80040E71 The permission transferred in the access entry list is invalid. 0x80040E77 The Constraint Type value was invalid or was not supported by the provider. 0x80040E78 The Constraint Type value was not DBCONSTRAINTTYPE_FOREIGNKEY, and c Foreign Key Columns was not zero. 0x80040E79 The Deferability value was invalid or was not supported by the provider. 0x80040E80 The Match Type value was invalid or was not supported by the provider. 0x80040E8A The Update Rule or Delete Rule value was invalid or was not supported by the provider. 0x80040E8B Invalid restriction ID. 0x80040E8C The dw Flags value was invalid. 0x80040E8D The rguid Column Type value pointed to a GUID that does not match the object type of this column, or this column was not specified. 0x80040E91 No source row exists. 0x80040E92 The OLE DB object represented by this URL is locked by at least one other process. 0x80040E93 The client requested an object type that is only for lists. 0x80040E94 The calling process requested write access for a write-protected object. 0x80040E95 The provider was unable to establish a connection with the server for this object. 0x80040E96 The provider was unable to establish a connection with the server for this object. 404 Version: 1.13.8 TF6420
## Page 405

Appendix Value Description 0x80040E97 Timeout during binding to the object 0x80040E98 The provider was unable to create an object with this URL, since an object named by this URL already exists. 0x80040E8E The requested URL was outside the valid range. 0x80040E90 The column or restriction could not be deleted, since a dependent view or restriction refers to it. 0x80040E99 The restriction already exists. 0x80040E9A The object cannot be created with this URL, since the server has insufficient physical memory. 0x00040EC0 During retrieval of the requested number of rows the total number of active rows supported by this row set was exceeded. 0x00040EC1 At least one column type is not compatible; conversion errors may occur during copying. 0x00040EC2 Information on the parameter type were disabled by the calling process. 0x00040EC3 The bookmark for a deleted or irrelevant row was skipped. 0x00040EC5 No further row sets are available. 0x00040EC6 Start or end of the row set or chapter reached. 0x00040EC7 The command was executed again by the provider. 0x00040EC8 The data buffer for the variable is full. 0x00040EC9 No further results are available. 0x00040ECA The server is unable to cancel or downgrade a lockout until a transaction is complete. 0x00040ECB The specified weighting value was not supported or exceeded the supported limit. The value was set to 0 or to the limit. 0x00040ECC For this reason the consumer rejects further notification calls. 0x00040ECD The input dialect was ignored, and the text was returned in another dialect. 0x00040ECE The consumer rejects further notification calls for this phase. 0x00040ECF For this reason the consumer rejects further notification calls. 0x00040ED0 The operation is processed asynchronously. 0x00040ED1 To reach the start of the row set, the provider has to execute the query again. Either the order of the columns has changed, or columns were added to the row set, or columns were removed from the row set. 0x00040ED2 The method had several errors. The errors were returned in the error array. 0x00040ED3 Invalid row handle 0x00040ED4 A specified HROW object referred to a permanently deleted row. 0x00040ED5 The provider was unable to trace all modifications. The client has to retrieve the data assigned the monitoring range again via another method. 0x00040ED6 The execution was terminated because no more resources were available. The results received up to this time were returned, but the execution cannot continue. 0x00040ED8 A lockout was upgraded relative to the specified value. 0x00040ED9 At least one property was changed according to the options permitted by the provider. 0x00040EDA Error 0x00040EDB A specified parameter was invalid. 0x00040EDC Due to the update of this row several rows in the data source had to be updated. 0x00040ED7 The binding failed, since the provider was not able to meet all binding flags or properties. 0x00040EDD The row contains no row-specific columns. TF6420 Version: 1.13.8 405
## Page 406

Appendix 8.1.2.4 ASCII error codes Value Description 1 Function not available 2 Syntax error 3 File could not be opened. 8.1.2.5 XML error codes Value Description 1 Function not available 2 XML file could not be loaded 3 XML schema could not be loaded 4 Syntax error 5 Table could not be created 6 The INSERT VALUE list does not match the columns list 7 PLC structure is not large enough 8 XML file could not be created 9 XML database not found. 10 XML table not found 8.1.2.6 Internal error codes Error code Description 0x02000001 NULL values are not allowed 0x02000002 FB_DBRead selected value is NULL 0x02000003 DBID is unknown 0x02000004 ADSDev ID is unknown 0x02000005 No open database connection found for DBID xy 0x02000006 No open ADS device connection found for ADSDev ID xy 8.2 FAQ - frequently asked questions and answers Frequently asked questions are answered in this section in order to make it easier for you to work with Twin CAT Database Server. If you have any further questions, please contact our support. 1. What performance can be achieved with the Twin CAT Database Server? [} 407] 2. Are so-called stored procedures supported? [} 407] 3. Which database types does the Twin CAT Database Server support? [} 407] 4. Can old database server configurations still be used in later versions? [} 407] 5. How can individual variables be written into an existing database structure or read from it? [} 407] 6. Can several records be written into a database simultaneously? [} 407] 7. How can the Twin CAT Database Server be operated in a network? [} 407] 8. Which functions of the Twin CAT Database Server are supported by the database type "XML"? [} 407] 406 Version: 1.13.8 TF6420
## Page 407

Appendix 9. Which Visual Studio versions are currently supported by the Database Server Configurator? [} 407] 10. My Twin CAT Database Configurator does not appear to be scaled correctly. What can I do? [} 407] What performance can be achieved with the Twin CAT Database Server? This question cannot be answered in general terms. The performance that can be achieved depends on the hardware used, the actions to be execute (e.g. ring buffer logging) and the number of variables. Another key factor is the database type that is used. Are so-called Stored Procedures supported? Yes, the Twin CAT Database Server supports Stored Procedures. The function block FB_SQLStored Procedure [} 202] is provided for this purpose in the PLC library. The SQL Query Editor can be used to test stored procedures, and corresponding PLC code for the function block FB_SQLStored Procedure can be generated. Not all databases support this function. Which database types does the Twin CAT Database Server support? Information on the supported databases can be found in section "Databases [} 123]". Can old database server configurations still be used in current versions? Yes, that is possible. In the event of major version jumps or a complete redesign (old: 3.0.x, new: 3.1.x), compatibility will be ensured. Details can be found in the section "Compatibility [} 20]". How can individual variables be written to or read from an existing database structure? Individual variables can be written to or read from an existing database structure using the FB_SQLCommand [} 197] function block. Can several records be written to a database at the same time? This depends on the database used. With a Microsoft SQL database this would be possible in conjunction with the FB_SQLCommand [} 197] function block, since several SQL Insert commands (separated by semicolon) can be transferred to the PLC function block. How can the Twin CAT Database Server be operated in a network? The Twin CAT Database Server can be used in a network in several ways. Further information on support network topologies can be found in section "Areas of application and network topologies [} 18]". Which functions of the Twin CAT Database Server are supported by the database type "XML"? The "XML" database type supports the full functionality of the Twin CAT Database Server, except for "stored procedures". The XML file can be used to communicate with any other database via SQL commands, and PLC values can be logged in the XML file with the cyclic write mode. In addition, it is possible to execute XPath commands and read the corresponding XML tags. Further information can be found in section "XML database [} 135]". Which Visual Studio versions are currently supported by the database server configurator? Currently the Visual Studio® versions 2013, 2015 and 2017 are supported with our configurator integration [} 23]. My Twin CAT Database Configurator does not appear to be scaled correctly. What can I do? Different screen scaling settings in Windows can lead to incorrect scaling of the configurator. It may help to overwrite the DPI scaling behavior in the program properties of the configurator. Compatibility > Change high DPI setting > Override scaling at high DPI value > "System (Advanced)" TF6420 Version: 1.13.8 407
## Page 408

Appendix Restart the configurator after the change. 408 Version: 1.13.8 TF6420
## Page 409

Support and Service 9 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com TF6420 Version: 1.13.8 409
## Page 410

Trademark statements Beckhoff®, ATRO®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, MX-System®, Safety over Ether CAT®, TC/BSD®, Twin CAT®, Twin CAT/BSD®, Twin SAFE®, XFC®, XPlanar® and XTS® are registered and licensed trademarks of Beckhoff Automation Gmb H. Third-party trademark statements Arm, Arm9 and Cortex are trademarks or registered trademarks of Arm Limited (or its subsidiaries or affiliates) in the US and/or elsewhere. Intel, the Intel logo, Intel Core, Xeon, Intel Atom, Celeron and Pentium are trademarks of Intel Corporation or its subsidiaries. Microsoft, Microsoft Azure, Microsoft Edge, Power Shell, Visual Studio, Windows and Xbox are trademarks of the Microsoft group of companies. UNIX is a registered trademark in the United States and other countries, licensed exclusively through X/Open Company Limited.
## Page 411

More Information: www.beckhoff.com/tf6420 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
