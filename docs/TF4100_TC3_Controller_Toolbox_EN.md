---
title: "TF4100 Twin CAT 3"
product: "TF4100"
category: "Motion_Control"
tags: ["CAT", "TWIN"]
language: "EN"
document_type: "Manual"
version: "2.2.4"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF4100_TC3_Controller_Toolbox_EN.pdf"
release_date: "2025-02-03"
---
Manual | EN TF4100 Twin CAT 3 | Controller Toolbox 2025-02-03 | Version: 2.2.4
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation............................................................................................................. 5 1.2 For your safety.................................................................................................................................. 6 1.3 Notes on information security............................................................................................................ 7 2 Overview.................................................................................................................................................... 8 3 Installation............................................................................................................................................... 12 3.1 System requirements...................................................................................................................... 12 3.2 Installation....................................................................................................................................... 12 3.3 Licensing......................................................................................................................................... 15 4 PLC API.................................................................................................................................................... 18 4.1 General operating principle............................................................................................................. 18 4.2 Reference........................................................................................................................................ 20 4.2.1 Function blocks................................................................................................................ 20 4.2.2 Global Constants............................................................................................................ 173 4.2.3 Data Structures.............................................................................................................. 173 5 Example project.................................................................................................................................... 177 5.1 Example Installation...................................................................................................................... 177 5.2 Example Structure......................................................................................................................... 178 6 Appendix................................................................................................................................................ 180 6.1 Setting rules for the P, PI and PID controllers............................................................................... 180 TF4100 Version: 2.2.4 3
## Page 4

Table of contents 4 Version: 2.2.4 TF4100
## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. The documentation and the following notes and explanations must be complied with when installing and commissioning the components. The trained specialists must always use the current valid documentation. The trained specialists must ensure that the application and use of the products described is in line with all safety requirements, including all relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been compiled with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. Claims to modify products that have already been supplied may not be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS®, and XPlanar® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of the designations or trademarks contained in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Ether CAT® is a registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document, as well as the use and communication of its contents without express authorization, are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. Third-party trademarks Trademarks of third parties may be used in this documentation. You can find the trademark notices here: https://www.beckhoff.com/trademarks. TF4100 Version: 2.2.4 5
## Page 6

Foreword 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 6 Version: 2.2.4 TF4100
## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. TF4100 Version: 2.2.4 7
## Page 8

Overview 2 Overview This library contains function blocks that represent various control engineering transfer elements in a functional diagram. Complex controllers that can be used for a large number of applications are included, as well as basic function blocks with which unique controller structures can be implemented for special applications. 8 Version: 2.2.4 TF4100
## Page 9

Overview Function blocks TF4100 Version: 2.2.4 9
## Page 10

Overview Name Description FB_CTRL_2POINT [} 41] 2-position controller FB_CTRL_2POINT_PWM_ADAPTIVE [} 43] Adaptive 2-position controller with PWM output FB_CTRL_3PHASE_SETPOINT_GENERATOR [} 153] 3 phase setpoint generator FB_CTRL_3POINT [} 45] 3-position controller FB_CTRL_3POINT_EXT [} 47] Extended 3-position controller FB_CTRL_ACTUAL_VALUE_FILTER [} 85] Actual value filter FB_CTRL_ARITHMETIC_MEAN [} 87] Arithmetic mean value filter FB_CTRL_CHECK_IF_IN_BAND [} 123] Area monitoring FB_CTRL_D [} 33] D element FB_CTRL_DEADBAND [} 132] Dead band FB_CTRL_DIGITAL_FILTER [} 89] Digital filter FB_CTRL_FLOW_TEMP_SETPOINT_GEN [} 162] Specification of the flow temperature depending on the outdoor temperature FB_CTRL_GET_SYSTEM_TIME [} 20] Output of the Windows system time FB_CTRL_GET_TASK_CYCLETIME [} 22] Determination of the task cycle time FB_CTRL_HYSTERESIS [} 26] Hysteresis element FB_CTRL_I [} 29] I element FB_CTRL_I_WITH_DRIFTCOMPENSATION [} 31] I element with drift compensation FB_CTRL_LEAD_LAG [} 94] Lead/lag element FB_CTRL_LIMITER [} 133] Control value limiter FB_CTRL_LIN_INTERPOLATION [} 118] Linear interpolation element FB_CTRL_LOG_DATA [} 124] Data logger in *.csv ASCII format FB_CTRL_LOG_MAT_FILE [} 127] Data logger in Matlab 5 format FB_CTRL_LOOP_SCHEDULER [} 23] Distribution of computing power in situations with several control loops FB_CTRL_MOVING_AVERAGE [} 93] Moving average filter FB_CTRL_MULTIPLE_PWM_OUT [} 135] PWM element with multiple outputs FB_CTRL_NORMALIZE [} 120] Characteristic curve linearization FB_CTRL_NOISE_GENERATOR [} 97] Noise generator FB_CTRL_NOTCH_FILTER [} 98] Notch filter FB_CTRL_n POINT [} 50] n-position controller FB_CTRL_P [} 28] P element FB_CTRL_PARAMETER_SWITCH [} 52] Parameter switching algorithm for a split range controller FB_CTRL_PI [} 55] PI controller FB_CTRL_PI_PID [} 57] Cascaded PI-PID controller FB_CTRL_PID [} 60] PID controller FB_CTRL_PID_EXT [} 72] Extended PID controller FB_CTRL_PID_EXT_SPLITRANGE [} 65] Extended PID regulator with parameter set switchover FB_CTRL_PID_SPLITRANGE [} 77] PID regulator with parameter set switchover FB_CTRL_PT1 [} 100] PT element 1 FB_CTRL_PT2 [} 102] PT element 2 FB_CTRL_PT2oscillation [} 104] Oscillating PT element 2 FB_CTRL_PT3 [} 106] PT element 3 10 Version: 2.2.4 TF4100
## Page 11

Overview Name Description FB_CTRL_PTn [} 108] PT element n FB_CTRL_PTt [} 110] PT element t FB_CTRL_PWM_OUT [} 140] PWM element FB_CTRL_PWM_OUT_EXT [} 141] Extended PWM element FB_CTRL_RAMP_GENERATOR [} 164] Ramp generator FB_CTRL_RAMP_GENERATOR_EXT [} 166] Extended ramp generator FB_CTRL_SCALE [} 144] Range adjustment FB_CTRL_SERVO_MOTOR_OUT [} 145] Actuator control FB_CTRL_SERVO_MOTOR_SIMULATION [} 112] Actuator simulation FB_CTRL_SETPOINT_GENERATOR [} 168] Setpoint generator FB_CTRL_SIGNAL_GENERATOR [} 171] Signal generator FB_CTRL_SPLITRANGE [} 148] Signal decomposition into a positive and negative part. FB_CTRL_STEPPING_MOTOR_OUT [} 150] Stepper motor control FB_CTRL_TRANSFERFUNCTION_1 [} 35] Transfer function according to the first standard form FB_CTRL_TRANSFERFUNCTION_2 [} 38] Transfer function according to the second standard form FB_CTRL_Tu Tg [} 114] Tu Tg element FB_CTRL_ZERO_ZONE_DAMPING [} 116] Zero damping Requirements Development environment Target platform PLC libraries to include Twin CAT 3.1.4016 PC or CX Tc2_Controller Toolbox TF4100 Version: 2.2.4 11
## Page 12

Installation 3 Installation 3.1 System requirements Description of minimum requirements needed for engineering and/or runtime systems. Development environment A pure development environment describes a computer on which PLC programs are developed but not executed. The following components must be installed on a development computer: • Twin CAT 3 XAE (Engineering) build 4012 or higher • Twin CAT 3 function TF4100 controller toolbox version 3.4.0.0 or higher • Please note: A 7-day trial license can be used for the development environment, see Licensing [} 15]. Runtime environment A runtime environment describes a computer on which PLC programs are executed. The following components must be installed on a runtime computer: • Twin CAT3 XAR build 4012 or higher • Licenses for TC1200 PLC and TF4100 controller toolbox • Please note: A 7-day trial license key can be used for testing purposes, see Licensing [} 15]. Developer environment and runtime on one computer If runtime and development environments are to run on the same computer (e.g. to test a PLC program before it is loaded on the target computer), the following requirements must be met: • Twin CAT3 XAE (engineering installation) build 4012 or higher • Twin CAT 3 function TF4100 controller toolbox version 3.4.0.0 or higher • Please note: A 7-day trial license key can be used for testing purposes, see Licensing [} 15]. 3.2 Installation The following section describes how to install the Twin CAT 3 Function for Windows-based operating systems. ü The Twin CAT 3 Function setup file was downloaded from the Beckhoff website. 1. Run the setup file as administrator. To do this, select the command Run as administrator in the context menu of the file. ð The installation dialog opens. 12 Version: 2.2.4 TF4100
## Page 13

Installation 2. Accept the end user licensing agreement and click Next. 3. Enter your user data. TF4100 Version: 2.2.4 13
## Page 14

Installation 4. If you want to install the full version of the Twin CAT 3 Function, select Complete as installation type. If you want to install the Twin CAT 3 Function components separately, select Custom. 5. Select Next, then Install to start the installation. ð A dialog box informs you that the Twin CAT system must be stopped to proceed with the installation. 14 Version: 2.2.4 TF4100
## Page 15

Installation 6. Confirm the dialog with Yes. 7. Select Finish to exit the setup. ð The Twin CAT 3 Function has been successfully installed. 3.3 Licensing The Twin CAT 3 function can be activated as a full version or as a 7-day test version. Both license types can be activated via the Twin CAT 3 development environment (XAE). Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. TF4100 Version: 2.2.4 15
## Page 16

Installation 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. 16 Version: 2.2.4 TF4100
## Page 17

Installation 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. TF4100 Version: 2.2.4 17
## Page 18

PLC API 4 PLC API 4.1 General operating principle The following sections provide a generation description of the function blocks in the Twin CAT controller toolbox. Discretization The continuous transfer functions of the transfer elements assembled in this library are transformed to discrete values using the trapezoidal rule (Tustin formula). The Tustin formula: 1 T z +1 = s 2 z -1 Function block inputs e Mode The operation mode of the majority of function blocks can be selected with this input. This makes it possible to select one of the following operation modes: e CTRL_MODE_PASSIVE The output or outputs of the function block are set to zero, but the internal states are retained. e CTRL_MODE_ACTIVE The function block is executed in accordance with its description, and appropriate output values are calculated (normal operation). e CTRL_MODE_RESET In this operation mode all internal states are reset and the error bit is cleared. e CTRL_MODE_MANUAL The value of the input value f Man Sync Value is provided at the output (manual operation). st Params The necessary parameters are passed to the function block with this structure. The variables t Task Cycle Time and t Ctrl Cycle Time are contained in all the parameter structures. These parameters function in the following way: The parameter t Task Cycle Time specifies the cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the cycle time of the calling task. If it is only called in every second cycle, the time must be doubled accordingly. The parameter t Ctrl Cycle Time indicates the control loop's sampling time. This time must be greater than or equal to the parameter t Task Cycle Time. If the sampling time is set equal to t Task Cycle Time then the function block is executed with every call. If the selected value is larger by a factor of 5, the function block is only processed in every fifth call. This makes it possible to implement slow control loops even in a fast task. The parameters t Task Cycle Time and t Ctrl Cycle Time are of type TIME and therefore do not permit inputs of less than 1ms. In order to use the controller in a fast PLC task with a cycle time of less than 1ms, a global base time can be specified as reference for the specified cycle times. The use of the base time is explained in the following examples. It is assumed that the function block is called in every task cycle. 18 Version: 2.2.4 TF4100
## Page 19

PLC API Task: Configuration Parameter: Parameter: Action t Task Cycle Time t Ctrl Cycle Time T#10ms T#10ms T#10ms The control loop is processed using a 10 ms sampling time. T#10ms T#10ms T#50ms The control loop is processed using a 50 ms sampling time. T#100ms T#100ms T#100ms The control loop is processed using a 100 ms sampling time. T#100ms T#100ms T#50ms ERROR, execution is not possible! T#100ms T#50ms T#50ms ERROR, although the function block has been executed, incorrect output values have been calculated! The outputs of the function blocks e State This output indicates the current internal state of the function block. e CTRL_STATE_IDLE The function block has successfully been reset, and is now waiting for selection of the operation mode. e CTRL_STATE_PASSIVE The function block is in the passive state in which no calculations are carried out. e CTRL_STATE_ACTIVE The function block is in the active state, which is the normal operating state. e CTRL_STATE_RESET A reset request is being processed, but the reset has not yet been completed. e CTRL_STATE_MANUAL The function block is in the manual state, and the output value can be manually specified at the appropriate input. e CTRL_STATE_... If there are any other internal states, they are described together with the corresponding function blocks. e CTRL_STATE_ERROR An error has occurred; the function block is not executed when in this state. See e Error Id for further information. b Error An error in the function block is indicated by a TRUE at this boolean output. e Error Id The error number [} 173] is provided at this output if the b Error output is TRUE. Using the global base time In order to be able to use the function blocks of a PLC task with a cycle time of less than 1ms, it is possible to interpret the specified cycle times as ticks of a base time. In this special parameterization, the time unit of 1ms is interpreted as 1 tick. This approach is equivalent to setting a PLC cycle time of less than 1ms in the Twin CAT System Manager. The switchover and declaration of the base time is done with the global structure st Ctrl_GLOBAL_Cycle Time Interpretation for all function blocks of the toolbox. VAR_GLOBAL st Ctrl_GLOBAL_Cycle Time Interpretation : ST_CTRL_CYCLE_TIME_INTERPRETATION; END_VAR TYPE ST_CTRL_CYCLE_TIME_INTERPRETATION : STRUCT b Interpret Cycle Time As Ticks : BOOL; (* e.g. 2ms -> 2ticks *) f Base Time : FLOAT; (* Base time in seconds, e.g. 200µs -> 200E-6s *) END_STRUCT END_TYPE TF4100 Version: 2.2.4 19
## Page 20

PLC API In order to interpret the specified cycle times as ticks, the variable b Interpret Cycle Time As Ticks in the global structure st Ctrl_GLOBAL_Cycle Time Interpretation is set to TRUE. Within this structure, the base time unit has to be set in variable f Base Time. By setting the flag b Interpret Cycle Time As Ticks, the interpretation of the parameters with the names • t Task Cycle Time • t Ctrl Cycle Time is changed. The interpretation and effect of all other parameters of type TIME remains unaffected. Sample The base time unit of the Twin CAT system is 200µs. The PLC task, and therefore the function blocks of the Toolbox, are called cyclically every 400µs. Setting the global structure: st Ctrl_GLOBAL_Cycle Time Interpretation.b Interpret Cycle Time As Ticks := TRUE; st Ctrl_GLOBAL_Cycle Time Interpretation.f Base Time := 200E-6; Parameterization of a function block from the Toolbox: st Params.t Task Cycle Time := T#2ms; (* 2*200µs=400µs *) st Params.t Ctrl Cycle Time := T#4ms; (* 4*200µs=800µs *) st Params. ... The Task Cycle Time specified on the function blocks is "2•200E-6s = 400µs" and thus corresponds to the set PLC cycle time. The Ctrl Cycle Time is set to "800µs = 4•200E-6s" so that the control loop operates with a sampling time of 800µs, i.e. it is processed in every second PLC cycle. 4.2 Reference 4.2.1 Function blocks 4.2.1.1 Auxiliary 4.2.1.1.1 FB_CTRL_GET_SYSTEM_TIME The function block reads the current Windows system time and makes it available in the System Time Struct. Description This function block makes the current system time available in its output structure. The resolution is specified through the t Ctrl Cycle Time parameter; the maximum resolution is 10 ms, and it is necessary to observe the condition "t Ctrl Cycle Time > 2 • t Task Cycle Time". Otherwise the resolution is reduced to "2 • t Ctrl Cycle Time". Outputs VAR_OUTPUT st System Time : TIMESTRUCT; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR TYPE TIMESTRUCT 20 Version: 2.2.4 TF4100
## Page 21

PLC API STRUCT w Year : WORD; w Month : WORD; w Day Of Week : WORD; w Day : WORD; w Hour : WORD; w Minute : WORD; w Second : WORD; w Milliseconds : WORD; END_STRUCT END_TYPE Name Type Description st System Time TIME Structure in which the system time is output. STRUCT e Error Id E_CTRL_ Supplies the error number [} 173] when the output b Error is set. ERROR CODES b Error BOOL Becomes TRUE as soon as an error situation occurs. w Year WORD The year: 1970 ~ 2106; w Month WORD The month: 1 ~ 12 (January = 1, February = 2 etc.); w Day Of Week WORD The day of the week: 0 ~ 6 (Sunday = 0, Monday = 1 etc.); w Day WORD The day of the month: 1 ~ 31; w Hour WORD Hour: 0 ~ 23; w Minute WORD Minute: 0 ~ 59; w Second WORD Second: 0 ~ 59; WMilliseconds WORD Millisecond: 0 ~ 999; Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_GET_SYSTEM_TIME; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the function block GET_SYSTEM_TI ME st Params consists of the following elements: TYPE ST_CTRL_GET_SYSTEM_TIME: STRUCT t Task Cycle Time : TIME; t Ctrl Cycle Time : TIME; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every task cycle this corresponds to the task cycle time of the calling task. TF4100 Version: 2.2.4 21
## Page 22

PLC API 4.2.1.1.2 FB_CTRL_GET_TASK_CYCLETIME This function block allows the task cycle time of a program to be determined with a resolution of 1 ms. Correct use of the function block The Task Cycle Time can only be correctly determined if the program does not contain any active breakpoints. The task cycle time is only determined once. No further measurements are taken if either of the b Cycle Time Valid or b Error outputs is TRUE. Do not use this function block if you use cycle times that are less than 1 ms or not multiples of 1 ms Inputs VAR_INPUT e Mode : E_CTRL_MODE; END_VAR Name Type Description e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT t Task Cycle Time : TIME; b Cycle Time Valid : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description t Task Cycle Time TIME This output indicates the current task cycle time, with a resolution of 1 ms. b Cycle Time Valid BOOL The time contained in the t Task Cycle Time output is valid when this output is TRUE. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Sample: PROGRAM PRG_GET_TASK_CYCLETIME_TEST VAR t Task Cycle Time : TIME; b Cycle Time Valid : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; fb CTRL_GET_TASK_CYCLETIME : FB_CTRL_GET_TASK_CYCLETIME; b Init : BOOL := TRUE; f Setpoint Value : FLOAT := 45.0; f Actual Value : FLOAT; fb CTRL_PI : FB_CTRL_PI; st CTRL_PI_Params : ST_CTRL_PI_PARAMS; 22 Version: 2.2.4 TF4100
## Page 23

PLC API fb CTRL_PT1 : FB_CTRL_PT1; st CTRL_PT1_Params : ST_CTRL_PT1_PARAMS; END_VAR fb CTRL_GET_TASK_CYCLETIME( e Mode := e CTRL_MODE_ACTIVE, t Task Cycle Time => t Task Cycle Time, b Cycle Time Valid => b Cycle Time Valid, e State => e CTRL_MODE_ACTIVE, e Error Id => e Error Id, b Error => b Error ); IF fb CTRL_GET_TASK_CYCLETIME.b Cycle Time Valid THEN IF b Init THEN st CTRL_PT1_Params.t Task Cycle Time := fb CTRL_GET_TASK_CYCLETIME.t Task Cycle Time; st CTRL_PT1_Params.t Ctrl Cycle Time := T#100ms; st CTRL_PT1_Params.f Kp := 1.0; st CTRL_PT1_Params.t T1 := T#10s; st CTRL_PI_Params.t Task Cycle Time := fb CTRL_GET_TASK_CYCLETIME.t Task Cycle Time; st CTRL_PI_Params.t Ctrl Cycle Time := T#100ms; st CTRL_PI_Params.f Kp := 0.5; st CTRL_PI_Params.t Tn := T#5s; st CTRL_PI_Params.f Out Max Limit := 100.0; st CTRL_PI_Params.f Out Min Limit := 0.0; b Init := FALSE; END_IF fb CTRL_PI( f Actual Value := fb CTRL_PT1.f Out, f Setpoint Value := f Setpoint Value, e Mode := e CTRL_MODE_ACTIVE, st Params := st CTRL_PI_Params ); fb CTRL_PT1( f In := fb CTRL_PI.f Out, e Mode := e CTRL_MODE_ACTIVE, st Params := st CTRL_PT1_Params, f Out => f Actual Value ); END_IF 4.2.1.1.3 FB_CTRL_LOOP_SCHEDULER This function block allows the system load to be distributed over a number of control loops that are parameterized using the same t Ctrl Cycle Time and for which the condition "t Ctrl Cycle Time > t Task Cycle Time" is true. The output vector calculated by this function block is used to start the individual control loops at different times, so that the system loading is distributed. TF4100 Version: 2.2.4 23
## Page 24

PLC API Behavior of the output vector 5 control loops are managed in this diagram. In this case, "t Ctrl Cycle Time = 6 · t Task Cycle Time". The programmer must create the following array in the PLC if this function block is to be used: arr Output Vector : ARRAY[1..n Number Of Control Loops] OF BOOL; The function block sets the bits in this vector to TRUE or FALSE. The control loops that are managed with the loop scheduler are to be switched into the e CTRL_MODE_ACTIVE state when the corresponding bit in the output vector is TRUE. See sample code below. Inputs VAR_INPUT n Man Value : DWORD; e Mode : E_CTRL_MODE; END_VAR Name Type Description n Man Value DWORD This input allows the first 32 bits in the output vector to be set in e CTRL_MODE_MANUAL. A 1 sets the first bit, a 2 the second bit, a 3 the first and second bits, ... e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. 24 Version: 2.2.4 TF4100
## Page 25

PLC API Outputs VAR_OUTPUT e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_LOOP_SCHEDULER_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure for the loop scheduler. LOOP_ SCHEDULER_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_LOOP_SCHEDULER_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; n Number Of Control Loops : UINT; p Output Vector_ADR : POINTER TO BOOL := 0; n Output Vector_SIZEOF : UINT := 0; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME The cycle time with which the control loops managed by the loop scheduler are processed. This must be greater than or equal to the Task Cycle Time. t Task Cycle TIME The cycle time with which the loop scheduler and the function blocks Time associated with the control loops are called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. n Number Of Contr UINT The number of control loops being managed. ol Loops p Output Vector_A POINTER TO Address of the output vector DR BOOL n Output Vector_S UINT Size of the output vector in bytes IZEOF Sample: PROGRAM PRG_Loop Scheduler VAR arr Output Vector : ARRAY[1..5] OF BOOL; e Mode : E_CTRL_MODE; st Params : ST_CTRL_LOOP_SCHEDULER_PARAMS; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; fb CTRL_Loop Scheduler : FB_CTRL_LOOP_SCHEDULER; b Init : BOOL := TRUE; e Mode_Ctrl Loop_1 : E_CTRL_MODE; e Mode_Ctrl Loop_2 : E_CTRL_MODE; TF4100 Version: 2.2.4 25
## Page 26

PLC API e Mode_Ctrl Loop_3 : E_CTRL_MODE; e Mode_Ctrl Loop_4 : E_CTRL_MODE; e Mode_Ctrl Loop_5 : E_CTRL_MODE; END_VAR IF b Init THEN st Params.t Ctrl Cycle Time := T#10ms; st Params.t Task Cycle Time := T#2ms; st Params.n Number Of Control Loops := 5; b Init := FALSE; END_IF st Params.n Output Vector_SIZEOF := SIZEOF(arr Output Vector); st Params.p Output Vector_ADR := ADR(arr Output Vector); fb CTRL_Loop Scheduler( e Mode := e Mode, st Params := st Params, e Error Id => e Error Id, b Error => b Error); IF arr Output Vector[1] THEN e Mode_Ctrl Loop_1 := e CTRL_MODE_ACTIVE; END_IF IF arr Output Vector[2] THEN e Mode_Ctrl Loop_2 := e CTRL_MODE_ACTIVE; END_IF IF arr Output Vector[3] THEN e Mode_Ctrl Loop_3 := e CTRL_MODE_ACTIVE; END_IF IF arr Output Vector[4] THEN e Mode_Ctrl Loop_4 := e CTRL_MODE_ACTIVE; END_IF IF arr Output Vector[5] THEN e Mode_Ctrl Loop_5 := e CTRL_MODE_ACTIVE; END_IF 4.2.1.2 Base 4.2.1.2.1 FB_CTRL_HYSTERESIS The function block provides a hysteresis transfer element in a functional diagram. 26 Version: 2.2.4 TF4100
## Page 27

PLC API Transfer function Inputs VAR_INPUT f In : FLOAT; b Man Sync Value : BOOL; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Input of the hysteresis element b Man Sync BOOL Input through which the hysteresis element can be set to one of the Value two junctions. b Sync BOOL A rising edge at this input sets the hysteresis element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT b Out : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description b Out BOOL Output of the hysteresis element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE as soon as an error situation occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_HYSTERESIS_PARAMS; END_VAR TF4100 Version: 2.2.4 27
## Page 28

PLC API Name Type Description st Params ST_CTRL_ Parameter structure of the hysteresis element HYSTERESIS_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_HYSTERESIS_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Hysteresis Range : FLOAT; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Hysteresis FLOAT Hysteresis range, see diagram above. Range 4.2.1.2.2 FB_CTRL_P The function block provides an P-transfer element in the functional diagram. Transfer function: G(s)= K p Inputs VAR_INPUT f In :FLOAT; e Mode :E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Input of the P element e Mode E_CTRL_MODE Input that specifies the operation mode of the function block. Outputs VAR_OUTPUT f Out :FLOAT; e State :E_CTRL_STATE; e Error Id :E_CTRL_ERRORCODES; b Error :BOOL; END_VAR 28 Version: 2.2.4 TF4100
## Page 29

PLC API Name Type Description f Out FLOAT Output of the P element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params :ST_CTRL_P_PARAMS; END_VAR Name Type Description st Params ST_CTRL_P_ Parameter structure of the P element PARAMS st Params consists of the following elements: TYPE ST_CTRL_P_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0.0; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Proportional gain of the P-element 4.2.1.2.3 FB_CTRL_I The function block provides an I-transfer element in the functional diagram. Transfer function 1 G(s) = T s I TF4100 Version: 2.2.4 29
## Page 30

PLC API Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f In FLOAT Input of the I element f Man Sync Value FLOAT Input to which the I-element can be synchronized, or whose value is the present at the output in Manual Mode. b Sync BOOL A rising edge at this input sets the integrator to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode of the function block. b Hold BOOL A TRUE at this input holds the integrator fixed at the current value, independently of the input f In. Outputs VAR_OUTPUT f Out : FLOAT; b ARWactive : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the I element b ARWactive BOOL A TRUE at this output indicates that the integrator is being restricted. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_I_PARAMS; END_VAR Name Type Description st Params ST_CTRL_I_ Parameter structure of the I element PARAMS st Params consists of the following elements: TYPE ST_CTRL_I_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; t Ti : TIME := T#0ms; f Out Max Limit : FLOAT := 1E38; f Out Min Limit : FLOAT := -1E38; END_STRUCT END_TYPE 30 Version: 2.2.4 TF4100
## Page 31

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t Ti TIME Integration time of the I-element f Out Max Limit FLOAT Upper limit at which integration is halted (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. f Out Min Limit FLOAT Lower limit at which integration is halted (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. 4.2.1.2.4 FB_CTRL_I_WITH_DRIFTCOMPENSATION The function block represents an I transfer element with drift compensation. Functional diagram Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR TF4100 Version: 2.2.4 31
## Page 32

PLC API Name Type Description f In FLOAT Input of the I element f Man Sync Value FLOAT Input to which the I-element can be synchronized, or whose value is the present at the output in Manual Mode. b Sync BOOL A rising edge at this input sets the integrator to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode of the function block. b Hold BOOL A TRUE at this input holds the integrator fixed at the current value, independently of the input f In. Outputs VAR_OUTPUT f Out : FLOAT; b ARWactive : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the I element b ARWactive BOOL A TRUE at this output indicates that the integrator is being restricted. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_I_WITH_DRIFTCOMPENSATION_PARAMS; END_VAR Name Type Description st Params ST_CTRL_I_ Parameter structure of the I element WITH_DRIFTCO MPENSATION_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_I_WITH_DRIFTCOMPENSATION_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; t Ti : TIME := T#0ms; f Out Max Limit : FLOAT := 1E38; f Out Min Limit : FLOAT := -1E38; f Damping Coefficient : FLOAT := 0.0; t Averaging Time : TIME := T#0ms; p Work Array_ADR : POINTER TO FLOAT := 0; n Work Array_SIZEOF : UINT := 0; END_STRUCT END_TYPE 32 Version: 2.2.4 TF4100
## Page 33

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t Ti TIME Integration time of the I-element f Out Max Limit FLOAT Upper limit at which integration is halted (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. f Out Min Limit FLOAT Lower limit at which integration is halted (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. f Damping Coeffici FLOAT Factor k in the functional diagram d ent t Averaging Time TIME Time across which the sliding mean value filter calculates the mean value. p Work Array_AD POINTER TO Address of an Array of FLOAT with size t Averaging Time / R FLOAT t Ctrl Cycle Time (see description of the function block FB_CTRL_MOVING_AVERAGE) n Work Array_SIZ UINT Size of an Array of FLOAT with size t Averaging Time / EOF t Ctrl Cycle Time (see description of the function block FB_CTRL_MOVING_AVERAGE) 4.2.1.2.5 FB_CTRL_D The function block provides a DT transfer element (a real D-element) in a functional diagram. 1 Transfer function (continuous) T s G(s)= v 1+T s d Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR TF4100 Version: 2.2.4 33
## Page 34

PLC API Name Type Description f In FLOAT Input of the D element f Man Sync Value FLOAT Input to which the D-element can be synchronized, or whose value is present at the output in Manual Mode. b Sync BOOL A rising edge at this input sets the D-element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the D element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_D_PARAMS; END_VAR Name Type Description st Params ST_CTRL_D_ Parameter structure of the D-element PARAMS st Params consists of the following elements: TYPE ST_CTRL_D_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; t Tv : TIME := T#0ms; t Td : TIME := T#0ms; f Out Max Limit : FLOAT := 1E38; f Out Min Limit : FLOAT := -1E38; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t Tv TIME Differentiation time constant t Td TIME Damping time constant f Out Max Limit FLOAT Upper limit to which the output of the D-element is restricted. f Out Min Limit FLOAT Lower limit to which the output of the D-element is restricted. 34 Version: 2.2.4 TF4100
## Page 35

PLC API 4.2.1.2.6 FB_CTRL_TRANSFERFUNCTION_1 This function block calculates a discrete transfer function with the first standard form shown below. The transfer function here can be of any order, n. The coefficients for the following transfer functions are stored in the parameter arrays: b zn +b z(n-1) +...+bz+b G(z)= n (n-1) 1 0 zn +a z(n-1) +...+a z+a (n-1) 1 0 Description of the transfer behavior The above transfer function is calculated with the first standard form after some transformations in each scanning step. The programmer must create the following arrays in the PLC if this function block is to be used: a Num Array : ARRAY[0..n Num Order] OF FLOAT; a Den Array : ARRAY[0..n Den Order] OF FLOAT; a Struct Tf Data : ARRAY[0..n Tf Order] OF ST_CTRL_TRANSFERFUNCTION_1_DATA; The coefficients "b " to "b " are stored in the array a Num Array. This must be organized as follows: 0 n a Num Array[0] := b0; a Num Array[1] := b1; ... a Num Array[n-1] := bn-1; a Num Array[n] := bn; The coefficients "a " to "a " are stored in the array ar_Denominator Array. This must be organized as 0 n follows: a Den Array[0] := a0; a Den Array[1] := a1; ... a Den Array[n-1] := an-1; a Den Array[n] := an; TF4100 Version: 2.2.4 35
## Page 36

PLC API The internal data required by the function block is stored in the ar_st Transferfunction1Data array. This data must never be modified from within the PLC program. This procedure is also illustrated in the sample program listed below. Inputs VAR_INPUT f In : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Input to the transfer function e Mode E_CTRL_MODE Input that specifies the operation mode of the function block. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; b Error : BOOL; e Error Id : E_CTRL_ERRORCODES; END_VAR Name Type Description f Out FLOAT Output from the transfer function e State E_CTRL_STATE State of the function block b Error BOOL Supplies the error number [} 173] when the output b Error is set. e Error Id E_CTRL_ERROR Becomes TRUE, as soon as an error occurs. CODES Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_TRANSFERFUNCTION_1_PARAMS; END_VAR Name Type Description st Params ST_CTRL_TRAN Parameter structure of the function block SFERFUNCTION _1_PARAMS st Params consists of the following elements: TYPE ST_CTRL_TRANSFERFUNCTION_1_PARAMS: STRUCT t Task Cycle Time : TIME; t Ctrl Cycle Time : TIME := T#0ms; n Order Of The Transferfunction : USINT; p Numerator Array_ADR : POINTER TO FLOAT := 0; n Numerator Array_SIZEOF : UINT; p Denominator Array_ADR : POINTER TO FLOAT := 0; n Denomiantor Array_SIZEOF : UINT; p Transferfunction1Data_ADR : POINTER TO ST_CTRL_TRANSFERFUNCTION_1_DATA; n Transferfunction1Data_SIZEOF : UINT; END_STRUCT END_TYPE 36 Version: 2.2.4 TF4100
## Page 37

PLC API Name Type Description t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. n Order Of The Tra USINT Order of the transfer function [0...] nsferfunction p Numerator Array POINTER TO Address of the array containing the numerator coefficients _ADR FLOAT n Numerator Array UINT Size of the array containing the numerator coefficients, in bytes _SIZEOF p Denominator Arr POINTER TO Address of the array containing the denominator coefficients ay_ADR FLOAT n Denomiantor Arr UINT Size of the array containing the denominator coefficients, in bytes ay_SIZEOF p Transferfunction POINTER TO Address of the data array 1Data_ADR ST_CTRL_ TRANSFER FUNCTION_1_ DATA n Transferfunction UINT Size of the data array in bytes 1Data_SIZEOF Example: PROGRAM PRG_TRANSFERFUNCTION_1_TEST VAR CONSTANT n Tf Order : USINT := 2; END_VAR VAR a Num Array : ARRAY[0..n Num Order] OF FLOAT; a Den Array : ARRAY[0..n Den Order] OF FLOAT; a St Tf Data : ARRAY[0..n Tf Order] OF ST_CTRL_TRANSFERFUNCTION_1_DATA; e Mode : E_CTRL_MODE; st Params : ST_CTRL_TRANSFERFUNCTION_1_PARAMS; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; fb Tansferfunction : FB_CTRL_TRANSFERFUNCTION_1; b Init : BOOL := TRUE; f In : FLOAT := 0; f Out : FLOAT; b_0, b_1, b_2 : FLOAT; a_0,a_1,a_2 : FLOAT; END_VAR IF b Init THEN a Num Array[0] := 1.24906304658218E-007; a Num Array[1] := 2.49812609316437E-007; a Num Array[2] := 1.24906304658218E-007; a Den Array[0] := 0.998501124344101; a Den Array[1] := -1.99850062471888; a Den Array[2] := 1.0; st Params.t Task Cycle Time := T#2ms; st Params.t Ctrl Cycle Time := T#2ms; st Params.n Order Of The Transferfunction := n Tf Order; e Mode := e CTRL_MODE_ACTIVE; b Init := FALSE; END_IF st Params.p Numerator Array_ADR := ADR(a Num Array); st Params.n Numerator Array_SIZEOF := SIZEOF(a Num Array); st Params.p Denominator Array_ADR := ADR(a Den Array); st Params.n Denominator Array_SIZEOF := SIZEOF(a Den Array); st Params.p Transferfunction1Data_ADR := ADR(a Struct Tf Data); st Params.n Transferfunction1Data_SIZEOF := SIZEOF(a Struct Tf Data); fb Tansferfunction (f In := f In, e Mode := e Mode, st Params := st Params, TF4100 Version: 2.2.4 37
## Page 38

PLC API f Out => f Out, e Error Id => e Error Id, b Error => b Error); 4.2.1.2.7 FB_CTRL_TRANSFERFUNCTION_2 This function block calculates a discrete transfer function with the second standard form shown below. The transfer function here can be of any order, n. The coefficients for the following transfer functions are stored in the parameter arrays: b zn +b z(n-1) +...+bz+b G(z)= n (n-1) 1 0 zn +a z(n-1) +...+a z+a (n-1) 1 0 Description of the transfer behavior The internal calculation is performed in each sampling step according to the second standard form, for which the following block diagram applies: The transfer function can be brought into the form shown in the block diagram by means of some transformations: b % z-1+...+b % z-(n-1) +b % z-n G(z)=b % + (n-1) 1 0 1+a z-1+...+a z-(n-1) +a z-n (n-1) 1 0 The coefficients of the counter polynomial are calculated according to the following rule: % b i =b i -b n a i "0£i<n % b =b n n The programmer must create the following arrays in the PLC if this function block is to be used: 38 Version: 2.2.4 TF4100
## Page 39

PLC API a Num Array : ARRAY[0..n Tf Order] OF FLOAT; a Den Array : ARRAY[0..n Tf Order] OF FLOAT; a St Tf Data : ARRAY[0..n Tf Order] OF ST_CTRL_TRANSFERFUNCTION_2_DATA; The coefficients "b " to "b " are stored in the array a Num Array. This must be organized as follows: 0 n a Num Array[0]:= b0; a Num Array[1]:= b1; ... a Num Array[n-1] := bn-1; a Num Array[n] := bn; The coefficients "a " to "a " are stored in the array a Den Array. This must be organized as follows: 0 n a Den Array[0]:= a0; a Den Array[1]:= a1; ... a Den Array[n-1] := an-1; a Den Array[n] := an; The internal data required by the function block is stored in the array a St Tf Data. This data must never be modified from within the PLC program. This procedure is also illustrated in the sample program listed below. Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Input to the transfer function f Man Value FLOAT Input whose value is present at the output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode of the function block. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; b Error : BOOL; e Error Id : E_CTRL_ERRORCODES; END_VAR Name Type Description f Out FLOAT Output from the transfer function e State E_CTRL_STATE State of the function block b Error BOOL Supplies the error number [} 173] when the output b Error is set. e Error Id E_CTRL_ERROR Becomes TRUE, as soon as an error occurs. CODES Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_TRANSFERFUNCTION_2_PARAMS; END_VAR Name Type Description st Params ST_CTRL_TRAN Parameter structure of the function block SFERFUNCTION _2_PARAMS st Params consists of the following elements: TYPE ST_CTRL_TRANSFERFUNCTION_2_PARAMS: STRUCT TF4100 Version: 2.2.4 39
## Page 40

PLC API t Task Cycle Time : TIME; t Ctrl Cycle Time : TIME := T#0ms; n Order Of The Transferfunction : USINT; p Numerator Array_ADR : POINTER TO FLOAT := 0; n Numerator Array_SIZEOF : UINT; p Denominator Array_ADR : POINTER TO FLOAT := 0; n Denomiantor Array_SIZEOF : UINT; p Transferfunction2Data_ADR : POINTER TO ST_CTRL_TRANSFERFUNCTION_2_DATA; n Transferfunction2Data_SIZEOF : UINT; END_STRUCT END_TYPE Name Type Description t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. n Order Of The Tra USINT Order of the transfer function [0...] nsferfunction p Numerator Array POINTER TO Address of the array containing the numerator coefficients _ADR FLOAT n Numerator Array UINT Size of the array containing the numerator coefficients, in bytes _SIZEOF p Denominator Arr POINTER TO Address of the array containing the denominator coefficients ay_ADR FLOAT n Denomiantor Arr UINT Size of the array containing the denominator coefficients, in bytes ay_SIZEOF p Transferfunction POINTER TO Address of the data array 2Data_ADR ST_CTRL_ TRANSFERFUNC TION_2_DATA n Transferfunction UINT Size of the data array in bytes 2Data_SIZEOF Sample: PROGRAM PRG_TRANSFERFUNCTION_2_TEST VAR CONSTANT n Tf Order : USINT := 2; END_VAR VAR a Num Array : ARRAY[0..n Tf Order] OF FLOAT; a Den Array : ARRAY[0..n Tf Order] OF FLOAT; a St Tf Data : ARRAY[0..n Tf Order] OF ST_CTRL_TRANSFERFUNCTION_2_DATA; e Mode : E_CTRL_MODE; st Params : ST_CTRL_TRANSFERFUNCTION_2_PARAMS; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; fb Tansferfunction : FB_CTRL_TRANSFERFUNCTION_2; b Init : BOOL := TRUE; f In : FLOAT := 0; f Out : FLOAT; b_0, b_1, b_2 : FLOAT; a_0,a_1,a_2 : FLOAT; END_VAR IF b Init THEN a Num Array[0] := 1.24906304658218E-007; a Num Array[1] := 2.49812609316437E-007; a Num Array[2] := 1.24906304658218E-007; a Den Array[0] := 0.998501124344101; a Den Array[1] := -1.99850062471888; a Den Array[2] := 1.0; st Params.t Task Cycle Time := T#2ms; st Params.t Ctrl Cycle Time := T#2ms; st Params.n Order Of The Transferfunction := n Tf Order; e Mode := e CTRL_MODE_ACTIVE; 40 Version: 2.2.4 TF4100
## Page 41

PLC API b Init := FALSE; END_IF st Params.p Numerator Array_ADR := ADR(a Num Array); st Params.n Numerator Array_SIZEOF := SIZEOF(a Num Array); st Params.p Denominator Array_ADR := ADR(a Den Array ); st Params.n Denominator Array_SIZEOF := SIZEOF(a Den Array ); st Params.p Transferfunction2Data_ADR := ADR(a St Tf Data ); st Params.n Transferfunction2Data_SIZEOF := SIZEOF(a St Tf Data); fb Tansferfunction (f In := f In, e Mode := e Mode, st Params := st Params, f Out => f Out, e Error Id => e Error Id, b Error => b Error); 4.2.1.3 Controller 4.2.1.3.1 FB_CTRL_2POINT The function block provides a 2-point transfer element in the functional diagram. Behavior of the output Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; b Man Sync Value : BOOL; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR TF4100 Version: 2.2.4 41
## Page 42

PLC API Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable b Man Sync Value BOOL Input through which the 2-point element can be set to one of the two junctions. b Sync BOOL A rising edge at this input sets the 2-point element to the value "b Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT b Out : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description b Out BOOL Output of the 2-point element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Input/ outputs VAR_IN_OUT st Params : ST_CTRL_2POINT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the 2-point element 2POINT_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_2POINT_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Hysteresis Range : FLOAT; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle TIME Cycle time with which the function block is called. If the function block Time is called in every cycle this corresponds to the task cycle time of the calling task. f Hysteresis FLOAT Hysteresis range, see diagram above. Range 42 Version: 2.2.4 TF4100
## Page 43

PLC API 4.2.1.3.2 FB_CTRL_2POINT_PWM_ADAPTIVE The function block provides an adaptive two-position controller. It is particularly suitable for single-area controllers in which high inlet temperatures are present and which make use of a thermal actuator. Behavior of the output Description of the function Internally, the controller uses a PWM function block that is used to control the thermal actuator. The mark-to- space ratio of the PWM function block is adaptively adjusted to the behavior of the controlled system. The PWM output is switched on when the control deviation "f E = setpoint – actual value" is greater than "0" and switched off when the control deviation is less than "0". The mark-to-space ratio is not changed as long as the control deviation remains within the range "[-f Ok Range ... f Ok Range]". If "f E > f Ok Range", the mark-to- space ratio is increased by "f Step Size". After such an increase, time t Wait Time must elapse before the mark-to-space ratio can be changed again. If f E falls below "-f Ok Range", the mark-to-space ratio is reduced by "f Step Size". The mark-to-space ratio is only modified over the range "[f Min Limit ... f Max Limit]". The period of the PWM signal is specified by the parameter t PWMPeriod. Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; TF4100 Version: 2.2.4 43
## Page 44

PLC API f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable f Man Sync FLOAT Input to which the controller's mark-to-space ratio can be set, or with Value which the output can be set in Manual Mode. The output is set in Manual Mode if "f Man Sync Value > 0.0". b Sync BOOL A rising edge at this input will set the mark-to-space ratio of the internal PWM function block to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT b Out : BOOL; f PWMDuty Cycle : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description b Out BOOL Controller output f PWMDuty Cycle FLOAT Current mark-to-space ratio of the internal PWM function block e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_2POINT_PWM_ADAPTIVE_PARAMS; END_VAR Name Type Description st Params ST_CTRL_2POIN Parameter structure of the 2-point element T_PWM_ ADAPTIVE_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_2POINT_PWM_ADAPTIVE_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; t PWMPeriod : TIME; f Ok Range : FLOAT; f Force Range : FLOAT; f Step Size : FLOAT; f Min Limit : FLOAT; f Max Limit : FLOAT; t Wait Time : TIME; END_STRUCT END_TYPE 44 Version: 2.2.4 TF4100
## Page 45

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t PWMPeriod TIME Period of the PWM signal f Ok Range FLOAT The range of "f E" over which the mark-to-space ratio will not be modified. f Force Range FLOAT If "f E" exceeds this range, the output is permanently set to TRUE. f Step Size FLOAT Value by which the mark-to-space ratio is varied each time it is adapted. [0% ... 100%] f Min Limit FLOAT Maximum mark-to-space ratio in percent [0% ... 100%] f Max Limit FLOAT Minimum mark-to-space ratio in percent [0% ... 100%] t Wait Time TIME Waiting time between individual modifications of the mark-to-space ratio 4.2.1.3.3 FB_CTRL_3POINT The function block provides a 3-point transfer element in the functional diagram. Behavior of the output TF4100 Version: 2.2.4 45
## Page 46

PLC API Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; n Man Sync Value : INT; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable n Man Sync Value INT Input with which the 3-point link can be set to one of the three junctions. n Man Sync Value >= 1 → b Pos Out = TRUE, b Neg Out = FALSE n Man Sync Value <= -1 → b Pos Out = FALSE, b Neg Out = TRUE otherwise → b Pos Out = FALSE, b Neg Out = FALSE b Sync BOOL A rising edge at this input sets the 3-point element to the value "b Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT b Pos Out : BOOL; b Neg Out : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description b Pos Out BOOL This output from the 3-point element is TRUE if the upper junction of the characteristic curve is active. b Neg Out BOOL This output from the 3-point element is TRUE if the lower junction of the characteristic curve is active. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_3POINT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_3POIN Parameter structure of the 3-point element T_PARAMS st Params consists of the following elements: TYPE ST_CTRL_3POINT_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Pos Out On : FLOAT; f Pos Out Off : FLOAT; f Neg Out On : FLOAT; 46 Version: 2.2.4 TF4100
## Page 47

PLC API f Neg Out Off : FLOAT; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle TIME Cycle time with which the function block is called. If the function block Time is called in every cycle this corresponds to the task cycle time of the calling task. f Pos Out On FLOAT Control deviation that will result in b Pos Out = FALSE being switched to b Pos Out = TRUE (b Neg Out = FALSE). f Pos Out Off FLOAT Control deviation that will result in b Pos Out = TRUE being switched to b Pos Out = FALSE (b Neg Out = FALSE). f Neg Out On FLOAT Control deviation that will result in b Neg Out = FALSE being switched to b Neg Out = TRUE (b Pos Out = FALSE). f Neg Out Off FLOAT Control deviation that will result in b Neg Out = TRUE being switched to b Neg Out = FALSE (b Pos Out = FALSE). 4.2.1.3.4 FB_CTRL_3POINT_EXT The function block provides an extended 3-point element in the functional diagram. Behavior of the output f In := f Setpoint Value - f Actual Value; TF4100 Version: 2.2.4 47
## Page 48

PLC API Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable f Man Sync Value FLOAT Input through which the extended 3-point element can be set to one of the output branches. | f Man Sync Value | < 1 → f Out = 0.0 | f Man Sync Value | >= 1 → f Out = f E * f Gain + f Offset b Sync BOOL A rising edge at this input sets the 3-point element to the value "„f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. 48 Version: 2.2.4 TF4100
## Page 49

PLC API Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the extended 3-point element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_3POINT_EXT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the extended 3-point element 3POINT_EXT_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_3POINT_EXT_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Out Off : FLOAT; f Out On : FLOAT; f Gain : FLOAT; f Offset : FLOAT; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle TIME Cycle time with which the function block is called. If the function block Time is called in every cycle this corresponds to the task cycle time of the calling task. f Out Off FLOAT If the control deviation falls below this value, the output is switched off (set to zero). f Out On FLOAT If the control deviation exceeds this value, the output is switched on. f Gain FLOAT Gain factor f Offset FLOAT Offset TF4100 Version: 2.2.4 49
## Page 50

PLC API 4.2.1.3.5 FB_CTRL_n POINT The function block provides an n-point transfer element in the functional diagram. Behavior of the output Data array for the example: The value of the array with the index (1,1), i.e. the left value in the first row can be chosen freely, since it is not evaluated. Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; 50 Version: 2.2.4 TF4100
## Page 51

PLC API f Man Value : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable f Man Value BOOL Input whose value is output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : n POINT_CTRL_TABLE_ELEMENT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out n POINT_CTRL_ Output of the n-point element TABLE_ELEMEN T e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_n POINT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_n POIN Parameter structure of the n-point element T_PARAMS st Params consists of the following elements: TYPE ST_CTRL_n POINT_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; p Data Table_ADR : POINTER TO n POINT_CTRL_TABLE_ELEMENT := 0; n Data Table_SIZEOF : UINT := 0; n Data Table_Number Of Rows : UINT := 0; f Hysteresis Range : FLOAT; END_STRUCT END_TYPE TF4100 Version: 2.2.4 51
## Page 52

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle TIME Cycle time with which the function block is called. If the function block Time is called in every cycle this corresponds to the task cycle time of the calling task. p Data Table_ POINTER TO Address of the data table ADR n POINT_CTRL_ TABLE_ ELEMENT n Data Table_ UINT Size of the data table in bytes SIZEOF n Data Table_ UINT Number of rows in the data table Number Of Rows f Hysteresis FLOAT Hysteresis range, see diagram above. The hysteresis range functions Range as described for FB_CTRL_2POINT [} 41]. 4.2.1.3.6 FB_CTRL_PARAMETER_SWITCH This function block can be used to switch the parameter set used by FB_CTRL_PID_SPLITRANGE. Behavior of the output 52 Version: 2.2.4 TF4100
## Page 53

PLC API Description of the function block This function block is used to switch over the parameter set used by FB_CTRL_PID_SPLITRANGE. This function block is particularly intended to switch the parameter sets of controllers that can use two actuators to heat and to cool, and to set the limits for the controller. The time t Min Wait Time is specified as an input parameter. At least this time must elapse when switch-over is requested to allow for the parameter range to be changed, and for the controller limits set in such a way that it is possible to switch from heating operation to cooling operation. The intention of this is to prevent the operation mode being changed immediately simply because the controller overshoots slightly. For heating operation, the parameter range "e CTRL_PARAMETER_RECORD_HEATING = heating" is selected, while for cooling operation the parameter range is "e CTRL_PARAMETER_RECORD_COOLING = cooling". The controller's parameter sets must be specified in accordance with this arrangement. The request for a changeover itself is provided by a 2-point element (see diagram). The controller's output value, in other words the control value, should be used as the input value for the illustrated characteristic hysteresis curve. A request for changeover created by the hysteresis element must be present for at least the specified waiting time, so that the parameter range can be changed. The b Disable Range1 and b Disable Range2 Inputs makes it possible to prevent switching into one of the two ranges. It is therefore possible, for instance, to deactivate heating operation in summer and to deactivate cooling in winter. It would also be possible to make the change in the operation mode depend on the current control deviation. In summer, for instance, it might have to be 2°C too hot before switching into cooling operation. This can also be achieved by connecting the Inputs appropriately. Maximum and minimum limits are output in addition to providing the output of the parameter range, and these can be copied into the PID controller's parameter set. If the FB_CTRL_PARAMETER_SWITCH is in the Heating operation mode, the limits are set as follows: f Out Min Limit = -1.0 st Params.f Threshold; f Out Max Limit = st Params.f Out Max Limit; In the Cooling mode, the limits are set as follows: f Out Min Limit = st Params.f Out Max Limit; f Out Max Limit = st Params.f Threshold; Inputs VAR_INPUT f Manipulated Variable : FLOAT; n Man Sync Value : e CTRL_PARAMETER_RECORD_HEATING; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Manipulated FLOAT Input value of the FB_Parameter_Switch. This should be equal to Variable the output value of the controller. n Man Sync e CTRL_PARAME The input with which the function block can be set to one of the Value TER_RECORD_ parameter ranges. HEATING b Sync BOOL A rising edge at this input sets the function block to the value "n Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT e Parameter Record : E_CTRL_PARAMETER_RECORD; f Out Max Limit : FLOAT; f Out Min Limit : FLOAT; e State : E_CTRL_STATE; TF4100 Version: 2.2.4 53
## Page 54

PLC API e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description e Parameter Reco E_CTRL_ The output of the function block, identifying the parameter range. rd PARAMETER_ RECORD f Out Max Limit FLOAT The maximum output value of which the controller is limited. (This should be copied into the controller's parameter structure.) f Out Min Limit FLOAT The minimum output value of which the controller is limited. (This should be copied into the controller's parameter structure.) e State E_CTRL_ State of the function block STATE e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ Outputs VAR_IN_OUT st Params : ST_CTRL_PARAMETER_SWITCH_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PARA Parameter structure of the function block METER_SWITCH _PARAMS st Params consists of the following elements: TYPE ST_CTRL_2POINT_PARAMS : STRUCT t Task Cycle Time : TIME; t Ctrl Cycle Time : TIME; f Threshold : FLOAT; f Out Max Limit : FLOAT; f Out Min Limit : FLOAT; t Min Wait Time : TIME; END_STRUCT END_TYPE Name Type Description t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. f Threshold FLOAT Switching threshold, see illustration above. f Out Max Limit FLOAT The maximum limit; it is passed on to the controller. f Out Min Limit FLOAT The minimum limit; it is passed on to the controller. t Min Wait Time TIME Waiting time, see description above. 54 Version: 2.2.4 TF4100
## Page 55

PLC API 4.2.1.3.7 FB_CTRL_PI The function block provides a PI transfer element in the functional diagram. Behavior of the output æ 1 ö G(s)= K ç1+ ÷ p T s è ø n Step response ARW TF4100 Version: 2.2.4 55
## Page 56

PLC API Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable f Man Sync Value FLOAT Input with which the PI element can be set. b Sync BOOL A rising edge at this input sets the PI-element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the control deviation. Outputs VAR_OUTPUT f Out : FLOAT; b ARWactive : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the PI element b ARWactive BOOL A TRUE at this output indicates that the PI-element is being restricted. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ Supplies the error number [} 173] when the output b Error is set. ERRORCODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PI_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PI_ Parameter structure of the PI element PARAMS st Params consists of the following elements: TYPE ST_CTRL_PI_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; t Tn : TIME := T#0ms; f Kp : FLOAT := 0; f Out Max Limit : FLOAT := 1E38; f Out Min Limit : FLOAT := -1E38; b ARWOn IPart Only : BOOL := FALSE; END_STRUCT END_TYPE 56 Version: 2.2.4 TF4100
## Page 57

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t Tn TIME Integral action time f Kp FLOAT Controller amplification / transfer coefficient f Out Max Limit FLOAT Upper limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. f Out Min Limit FLOAT Lower limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. b ARWOn IPart On BOOL If this parameter is FALSE (the standard setting), the integration of ly the I-component is halted if the complete controller output reaches the upper or lower limit. If it is TRUE, the integration is halted if the I- component (the output of the integrator) reaches some limit. (Cf. functional diagram.) 4.2.1.3.8 FB_CTRL_PI_PID The function block provides a cascaded PI-PID controller in the functional diagram. Internally, this function block uses the FB_CTRL_PI, FB_CTRL_LIMITER and FB_CTRL_PID transfer elements. Transfer function of the PI element æ 1 ö G(s)= K ç1+ ÷ p T s è ø n Transfer function of the PID-element æ 1 T s ö G(s)= K ç1+ + v ÷ p T s 1+T s è ø n d TF4100 Version: 2.2.4 57
## Page 58

PLC API Functional diagram for the cascaded transfer element Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value Outer Loop : FLOAT; f Actual Value Inner Loop : FLOAT; f Pre Control : FLOAT; f Man Sync Value Inner Loop : FLOAT; b Sync Inner Loop : BOOL; e Mode Inner Loop : E_CTRL_MODE; b Hold Inner Loop : BOOL; f Man Sync Value Outer Loop : FLOAT; b Sync Outer Loop : BOOL; e Mode Outer Loop : E_CTRL_MODE; b Hold Outer Loop : BOOL; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value Oute FLOAT The actual value of the controlled variable that is fed back to the PI r Loop controller of the outer control loop. f Actual Value Inne FLOAT The actual value of the controlled variable that is fed back to the PID r Loop controller of the inner control loop. f Pre Control FLOAT Pre-control that is connected behind the PI controller. f Man Sync Value In FLOAT Input, to whose value it is possible to set the internal state of the PID- ner Loop element (the inner control loop). b Sync Inner Loop BOOL A rising edge at this input sets the PID-element (the inner control loop) to the value "f Man Sync Value Inner Loop". e Mode Inner Loop E_CTRL_MODE Input that specifies the operation mode [} 173] of the PID-element (the inner control loop). b Hold Inner Loop BOOL A TRUE at this input holds the internal state of the PID-element (the inner control loop) constant at the current value. f Man Sync Value O FLOAT Input, to whose value it is possible to set the internal state of the PI uter Loop element (the outer control loop). b Sync Outer Loop BOOL A rising edge at this input sets the PI element (the outer control loop) to the value "f Man Sync Value Outer Loop". e Mode Outer Loop E_CTRL_MODE Input that specifies the operation mode [} 173] of the PI element (the outer control loop). b Hold Outer Loop BOOL A TRUE at this input holds the internal state of the PI element (the outer control loop) constant at the current value. 58 Version: 2.2.4 TF4100
## Page 59

PLC API Outputs VAR_OUTPUT f Out : FLOAT; e State Inner Loop : E_CTRL_STATE; b ARWactive Inner Loop : BOOL; e Error Id Inner Loop : E_CTRL_ERRORCODES; b Error Inner Loop : BOOL; e State Outer Loop : E_CTRL_STATE; b ARWactive Outer Loop : BOOL; e Error Id Outer Loop : E_CTRL_ERRORCODES; b Error Outer Loop : BOOL; END_VAR Name Type Description f Out FLOAT Output of the PI-PID-element e State Inner Loop E_CTRL_STATE State of the internal PID-element (inner control loop) b ARWactive BOOL A TRUE at this output indicates that the output of the PID-element Inner Loop (the inner control loop) is being restricted. e Error Id Inner Loo E_CTRL_ERROR Returns the error number [} 173] of the PID-element (the inner control p CODES loop) when the b Error output is set. b Error Inner Loop BOOL Is set to TRUE as soon as an error occurs in the PID-element (the inner control loop). e State Outer Loop E_CTRL_STATE State of the internal PI element (outer control loop) b ARWactive Oute BOOL A TRUE at this output indicates that the PI element's (the outer r Loop control loop) output is being restricted. e Error Id Outer Loo E_CTRL_ERROR Returns the error number [} 173] of the PI element (the outer control p CODES loop) when the b Error output is set. b Error Outer Loop BOOL Is set to TRUE as soon as an error occurs in the PI element (the outer control loop). Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PI_PID_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PI_PID Parameter structure of the PI-PID-element _PARAMS st Params consists of the following elements: TYPE ST_CTRL_PI_PID_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp_Outer Loop : FLOAT := 0; t Tn_Outer Loop : TIME := T#0s; f Max Limit_Outer Loop : FLOAT := 1E38; f Min Limit_Outer Loop : FLOAT := -1E38; f Kp_Inner Loop : FLOAT := 0; t Tn_Inner Loop : TIME := T#0ms; t Tv_Inner Loop : TIME := T#0ms; t Td_Inner Loop : TIME := T#0ms; f Max Limit_Inner Loop : FLOAT := 1E38; f Min Limit_Inner Loop : FLOAT := -1E38; END_STRUCT END_TYPE TF4100 Version: 2.2.4 59
## Page 60

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp_Outer Loop FLOAT Controller amplification / controller coefficient of the PI element (outer control loop) t Tn_Outer Loop TIME Integral action time of the internal PI element (outer control loop). The I-component is deactivated if this is parameterized as T#0s. f Max Limit_Outer FLOAT Upper limit at which integration in the PID-element is halted and to Loop which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWactive Outer Loop output. f Min Limit_Outer L FLOAT Lower limit at which integration in the PID-element is halted and to oop which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWactive Outer Loop output. f Kp_Inner Loop FLOAT Controller amplification / controller coefficient of the PID element (inner control loop) t Tn_Inner Loop TIME Integral action time of the PID-element (inner control loop). The I- component is deactivated if this is parameterized as T#0s. t Tv_Inner Loop TIME Derivative action time of the PID-element (inner control loop). The D- component is deactivated if this is parameterized as T#0s. t Td_Inner Loop TIME Damping time of the PID-element (inner control loop) f Max Limit_Inner L FLOAT Upper limit at which integration in the PID-element is halted and to oop which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWactive Inner Loop output. f Min Limit_Inner L FLOAT Lower limit at which integration in the PID-element is halted and to oop which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWactive Inner Loop output. 4.2.1.3.9 FB_CTRL_PID The function block provides a PID transfer element in the functional diagram. Transfer function The following transfer function can be specified if the boolean Inputs b PIn The Feedback Path and b DIn The Feedback Path are FALSE. Otherwise the transfer function only describes part of the transfer behavior of the function block. æ 1 T s ö G (s)= K ç1+ + v ÷ PID p T s 1+T s è ø n d 60 Version: 2.2.4 TF4100
## Page 61

PLC API Functional diagram The standard functional diagram of a PID controller in additive form has been expanded by the two active boolean Inputs b PIn The Feedback Path and b DIn The Feedback Path (which act as "switches"), so that a modified functional diagram can be activated. Control background: due to the differential component of the control algorithm, large control values are generated at setpoint step-changes, which cause a strain on the control elements and may cause the control system to oscillate. A control algorithm whose differential component is only applied to the control value (b DIn The Feedback Path := TRUE) avoids this problem. The b PIn The Feedback Path and b DIn The Feedback Path Inputs permit the closed control loop to implement the following transfer functions: b PIn The Feedback Path b DIn The Feedback Path G(s) false false G (s)×G (s) G(s)= PID S 1+G (s)×G (s) PID S true false G (s)×G (s) G(s)= DI S 1+G (s)×G (s) PID S false true G (s)×G (s) G(s)= PI S 1+G (s)×G (s) PID S true true G (s)×G (s) G(s)= I S 1+G (s)×G (s) PID S with: æ 1 T s ö G (s)= K ç + v ÷ DI p T s 1+T s è ø n d TF4100 Version: 2.2.4 61
## Page 62

PLC API æ 1 ö G (s)= K ç1+ ÷ PI p T s è ø n æ 1 ö G (s)= K ç ÷ I p T s è ø n The standard setting for the two b PIn The Feedback Path and b DIn The Feedback Path Inputs is FALSE. The PID controller then corresponds to a standard PID controller in additive form. Step response 62 Version: 2.2.4 TF4100
## Page 63

PLC API ARW Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable f Man Sync Value FLOAT Input, to whose value it is possible to set the internal state of the PID- element. b Sync BOOL A rising edge at this input sets the PID-element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the control deviation. Outputs VAR_OUTPUT f Out : FLOAT; b ARWactive : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR TF4100 Version: 2.2.4 63
## Page 64

PLC API Name Type Description f Out FLOAT Output of the PID element b ARWactive BOOL A TRUE at this output indicates that the PID-element is being restricted. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PID_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PID_P Parameter structure of the PID element ARAMS st Params consists of the following elements: TYPE ST_CTRL_PID_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0; t Tn : TIME := T#0ms; t Tv : TIME := T#0ms; t Td : TIME := T#0ms; f Out Max Limit : FLOAT := 1E38; f Out Min Limit : FLOAT := -1E38; b PIn The Feedback Path : BOOL; b DIn The Feedback Path : BOOL; b ARWOn IPart Only : BOOL; END_STRUCT END_TYPE 64 Version: 2.2.4 TF4100
## Page 65

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Controller amplification / controller coefficient t Tn TIME Integral action time; if this is parameterized to T#0s, the I component is deactivated. t Tv TIME Derivative action time; if this is parameterized to T#0s, the D component is deactivated. t Td TIME Damping time f Out Max Limit FLOAT Upper limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. f Out Min Limit FLOAT Lower limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. b PIn The Feedbac BOOL Input value of the internal P-element can be selected with this input k Path (see functional diagram). Standard setting: FALSE b DIn The Feedbac BOOL Input value of the internal D-element can be selected with this input k Path (see functional diagram). Standard setting: FALSE b ARWOn IPart On BOOL If this parameter is FALSE (the standard setting), the integration of ly the I-component is halted if the complete controller output reaches the upper or lower limit. If it is TRUE, the integration is halted if the I- component (the output of the integrator) reaches some limit. (Cf. functional diagram.) 4.2.1.3.10 FB_CTRL_PID_EXT_SPLITRANGE The function block provides an extended PID transfer element in the functional diagram. With this controller it is possible to switch between two different parameter sets while the regulation is active. The functionalities of the inner and outer windows and of the input and output dead bands are available in addition. Description This function block is an extension of FB_CTRL_PID_EXT, which means that the controller can be used to control systems with two controlled devices for which the transfer behavior are different. A system with one actuator for heating and another actuator for cooling would be a typical application. To optimize the regulation of such an arrangement, it is possible to switch between two PID parameter sets. The parameter set changeover is carried out in such a way that a continuous control value is maintained even during the changeover. TF4100 Version: 2.2.4 65
## Page 66

PLC API The switching algorithm calculates a linear, time-dependent transition between the two parameter sets. The n Parameter Change Cycle Ticks parameter can be used to specify the number of task cycles over which the continuous change between the two parameter sets takes place. Transfer function The following transfer function can be specified if the boolean Inputs b PIn The Feedback Path and b DIn The Feedback Path are FALSE. Otherwise the transfer function only describes part of the transfer behavior of the function block. æ 1 T s ö G (s)= K ç1+ + v ÷ PID p T s 1+T s è ø n d Functional diagram The standard functional diagram of a PID controller in additive form has been expanded by the two active boolean Inputs b PIn The Feedback Path and b DIn The Feedback Path (which act as "switches"), so that a modified functional diagram can be activated. Control background: due to the differential component of the control algorithm, large control values are generated at setpoint step-changes, which cause a strain on the control elements and may cause the control system to oscillate. A control algorithm with a differential component that is only applied to the controlled variable (b DIn The Feedback Path := TRUE) can avoid this problem. The b PIn The Feedback Path and b DIn The Feedback Path Inputs permit the closed control loop to implement the following transfer functions: 66 Version: 2.2.4 TF4100
## Page 67

PLC API b PIn The Feedback Path b DIn The Feedback Path G(s) false false G (s)g G (s) G(s)= PID S 1+G (s)g G (s) PID S true false G (s)g G (s) G(s)= DI S 1+G (s)g G (s) PID S false true G (s)g G (s) G(s)= PI S 1+G (s)g G (s) PID S true true G g G (s) G(s)= I S 1+G (s)g G (s) PID S with: æ 1 T s ö G (s)= K ç + v ÷ DI p T s 1+T s è ø n d æ 1 ö G (s)= K ç1+ ÷ PI p T s è ø n æ 1 ö G (s)= K ç ÷ I p T s è ø n The standard setting for the two b PIn The Feedback Path and b DIn The Feedback Path Inputs is FALSE. The PID controller then acts as a standard PID controller in additive form. TF4100 Version: 2.2.4 67
## Page 68

PLC API Additional functions Switching off the I-component in the Outer Window Integration of the control deviation is halted if the control deviation is greater than the f Outer Window parameter. In this way it is possible to prevent an extremely large I-component from developing if the control deviation is large, since this could lead to a marked overshoot. If it is not wanted, the function can be disabled by setting f Outer Window:= 0. Linear reduction of the I-component in the Inner Window With this function it is possible to drive the I-component linearly down to zero in the range specified by the f Inner Window parameter. If it is not wanted, the function can be disabled by setting f Inner Window := 0. Output dead band If the parameter f Dead Band Output > 0 is set, the output is set to zero when it is within the range of [ - f Dead Band Output ... f Dead Band Output ]. Input dead band If the parameter f Dead Band Input > 0 is set then the output is held constant for as long as the control deviation remains within the range of [ -f Dead Band Input ... f Dead Band Input ]. Step response 68 Version: 2.2.4 TF4100
## Page 69

PLC API ARW Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; e Parameter Record : E_CTRL_PARAMETER_RECORD; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable e Parameter Reco E_CTRL_PARAM Index of the active parameter set rd ETER_RECORD f Man Sync Value FLOAT Input with which the PI element can be set. b Sync BOOL A rising edge at this input sets the PI-element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the control deviation. Outputs VAR_OUTPUT f Out Pos : FLOAT; f Out Neg : FLOAT; f Out : FLOAT; b ARWActive : BOOL := FALSE; b Parameter Change Active : BOOL; b Error : BOOL; e Error Id : E_CTRL_ERRORCODES; END_VAR TF4100 Version: 2.2.4 69
## Page 70

PLC API Name Type Description f Out Pos FLOAT Output of the PID-element when the control value is positive. A zero is output otherwise. f Out Neg FLOAT Output of the PID-element when the control value is negative. A zero is output otherwise. f Out FLOAT Output of the PID element b ARWActive BOOL A TRUE at this output indicates that the PID-element is being restricted. b Parameter BOOL A TRUE at this output indicates that the change from one parameter Change Active set to the other is in progress. b Error BOOL Becomes TRUE, as soon as an error occurs. e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES f Ctrl Derivation A TRUE at this output indicates that the PID-element is being restricted. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PID_EXT_SPLITRANGE_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the PID element PID_EXT_SPLIT RANGE_PARAMS st Params consists of the following elements: TYPE ST_CTRL_PID_EXT_SPLITRANGE_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp_heating : FLOAT := 0; t Tn_heating : TIME := T#0ms; t Tv_heating : TIME := T#0ms; t Td_heating : TIME := T#0ms; f Kp_cooling : FLOAT := 0; t Tn_cooling : TIME := T#0ms; t Tv_cooling : TIME := T#0ms; t Td_cooling : TIME := T#0ms; n Parameter Change Cycle Ticks : INT; f Dead Band Input : REAL := 0.0; f Dead Band Output : REAL := 0.0; f Inner Window : REAL := 0.0; f Outer Window : REAL := 0.0; f Out Max Limit : FLOAT := 1E38; f Out Min Limit : FLOAT := -1E38; b PIn The Feedback Path : BOOL; b DIn The Feedback Path : BOOL; b ARWOn IPart Only : BOOL; END_STRUCT END_TYPE 70 Version: 2.2.4 TF4100
## Page 71

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. Range e CTRL_PARAMETER_RECORD_HEATING: f Kp_heating FLOAT Controller amplification / controller coefficient t Tn_heating TIME Integral action time: The I-component is deactivated if this is parameterized as T#0s. t Tv_heating TIME Derivative action time: The D-component is deactivated if this is parameterized as T#0s. t Td_heating TIME Damping time Range e CTRL_PARAMETER_RECORD_COOLING: f Kp_cooling FLOAT Controller amplification / controller coefficient t Tn_cooling TIME Integral action time: The I-component is deactivated if this is parameterized as T#0s. t Tv_cooling TIME Derivative action time: The D-component is deactivated if this is parameterized as T#0s. t Td_cooling TIME Damping time n Parameter INT The number of task cycles over which the change from one parameter Change Cycle set to the other takes place. Ticks f Dead Band Input REAL See description above: Input dead band f Dead Band Outpu REAL See description above: Output dead band t f Inner Window REAL See description above: Linear reduction of the I-component in the Inner Window f Outer Window REAL See description above: Switching off the I-component in the Outer Window f Out Max Limit FLOAT Upper limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. f Out Min Limit FLOAT Lower limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. b PIn The Feed BOOL Input value of the P-element can be selected with this input (see back Path functional diagram). b DIn The Feed BOOL Input value of the D-element can be selected with this input (see back Path functional diagram). b ARWOn IPart BOOL If this parameter is FALSE (the standard setting), the integration of Only the I-component is halted if the complete controller output reaches the upper or lower limit. If it is TRUE, the integration is halted if the I-component (the output of the integrator) reaches some limit. (Cf. functional diagram.) TF4100 Version: 2.2.4 71
## Page 72

PLC API 4.2.1.3.11 FB_CTRL_PID_EXT Transfer function The following transfer function can be specified if the boolean Inputs b PIn The Feedback Path and b DIn The Feedback Path are FALSE. Otherwise the transfer function only describes part of the transfer behavior of the function block. æ 1 T s ö G (s)= K ç1+ + v ÷ PID p T s 1+T s è ø n d Functional diagram The standard functional diagram of a PID controller in additive form has been expanded by the two active boolean Inputs b PIn The Feedback Path and b DIn The Feedback Path (which act as "switches"), so that a modified functional diagram can be activated. Control background: due to the differential component of the control algorithm, large control values are generated at setpoint step-changes, which cause a strain on the control elements and may cause the control system to oscillate. A control algorithm with a differential component that is only applied to the controlled variable (b DIn The Feedback Path := TRUE) can avoid this problem. 72 Version: 2.2.4 TF4100
## Page 73

PLC API The b PIn The Feedback Path and b DIn The Feedback Path Inputs permit the closed control loop to implement the following transfer functions: b PIn The Feedback Path b DIn The Feedback Path G(s) false false G (s)g G (s) G(s)= PID S 1+G (s)g G (s) PID S true false G (s)g G (s) G(s)= DI S 1+G (s)g G (s) PID S false true G (s)g G (s) G(s)= PI S 1+G (s)g G (s) PID S true true G (s)g G (s) G(s)= I S 1+G (s)g G (s) PID S with: æ 1 T s ö G (s)= K ç + v ÷ DI p T s 1+T s è ø n d æ 1 ö G (s)= K ç1+ ÷ PI p T s è ø n æ 1 ö G (s)= K ç ÷ I p T s è ø n The standard setting for the two b PIn The Feedback Path and b DIn The Feedback Path Inputs is FALSE. The PID controller then acts as a standard PID controller in additive form. TF4100 Version: 2.2.4 73
## Page 74

PLC API Switching off the I-component in the Outer Window Integration of the control deviation is halted if the control deviation is greater than the f Outer Window parameter. In this way it is possible to prevent an extremely large I-component from developing if the control deviation is large, since this could lead to a marked overshoot. If it is not wanted, the function can be disabled by setting f Outer Window := 0. Linear reduction of the I-component in the Inner Window With this function it is possible to drive the I-component linearly down to zero in the range specified by the f Inner Window parameter. If it is not wanted, the function can be disabled by setting f Inner Window := 0. Output dead band If the parameter f Dead Band Output > 0 is set, the output is set to zero when it is within the range of [ - f Dead Band Output ... f Dead Band Output ]. Input dead band If the parameter f Dead Band Input > 0 is set then the output is held constant for as long as the control deviation remains within the range of [ -f Dead Band Input ... f Dead Band Input ]. Step response 74 Version: 2.2.4 TF4100
## Page 75

PLC API ARW Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable f Man Sync Value FLOAT Input with which the PID-element can be set. b Sync BOOL A rising edge at this input sets the PID-element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the control deviation. Outputs VAR_OUTPUT f Out : FLOAT; b Max Limit Reached : BOOL := FALSE; b Min Limit Reached : BOOL := FALSE; b ARWActive : BOOL := FALSE; f Ctrl Derivation : FLOAT; e State : E_CTRL_STATE; b Error : BOOL; e Error Id : E_CTRL_ERRORCODES; END_VAR TF4100 Version: 2.2.4 75
## Page 76

PLC API Name Type Description f Out FLOAT Output of the PID element b Max Limit BOOL The output is TRUE when the function block is at its upper limit. Reached b Min Limit BOOL The output is TRUE when the function block is at its lower limit. Reached b ARWActive BOOL A TRUE at this output indicates that the PID-element is being restricted. f Ctrl Derivation FLOAT The current value of the control deviation e State E_CTRL_STATE State of the function block b Error BOOL Supplies the error number [} 173] when the output b Error is set. e Error Id E_CTRL_ Becomes TRUE, as soon as an error occurs. ERRORCODES Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PID_EXT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PID_ Parameter structure of the PID element EXT_PARAMS st Params consists of the following elements: TYPE ST_CTRL_PID_EXT_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0; t Tn : TIME := T#0ms; t Tv : TIME := T#0ms; t Td : TIME := T#0ms; f Dead Band Input : REAL := 0.0; f Dead Band Output : REAL := 0.0; f Inner Window : REAL := 0.0; f Outer Window : REAL := 0.0; f Out Max Limit : FLOAT := 1E38; f Out Min Limit : FLOAT := -1E38; b PIn The Feedback Path : BOOL; b DIn The Feedback Path : BOOL; b ARWOn IPart Only : BOOL; END_STRUCT END_TYPE 76 Version: 2.2.4 TF4100
## Page 77

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Controller amplification / controller coefficient t Tn TIME Integral action time; if this is parameterized to T#0s, the I component is deactivated. t Tv TIME Derivative action time; if this is parameterized to T#0s, the D component is deactivated. t Td TIME Damping time f Dead Band Input REAL See description above. f Dead Band REAL See description above. Output f Inner Window REAL See description above. f Outer Window REAL See description above. f Out Max Limit FLOAT Upper limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. f Out Min Limit FLOAT Lower limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. b PIn The Feed BOOL Input value of the P-element can be selected with this input (see back Path functional diagram). b DIn The Feed BOOL Input value of the D-element can be selected with this input (see back Path functional diagram). b ARWOn IPart BOOL If this parameter is FALSE (the standard setting), the integration of Only the I-component is halted if the complete controller output reaches the upper or lower limit. If it is TRUE, the integration is halted if the I-component (the output of the integrator) reaches some limit. (Cf. functional diagram.) 4.2.1.3.12 FB_CTRL_PID_SPLITRANGE The function block provides an extended PID transfer element in the functional diagram. This controller enables switching between two parameter sets when control is active. Description This function block is an extension of FB_CTRL_PID, which means that the controller can be used to control systems with two controlled devices for which the transfer behavior are different. A system with one actuator for heating and another actuator for cooling would be a typical application. To optimize the regulation of such TF4100 Version: 2.2.4 77
## Page 78

PLC API an arrangement, it is possible to switch between two PID parameter sets. Parameter set switchover is implemented in such a way that the control value remains continuous even as the parameter sets are changed. The switching algorithm calculates a linear, time-dependent transition between the two parameter sets. The n Parameter Change Cycle Ticks parameter can be used to specify the number of task cycles over which the continuous change between the two parameter sets takes place. Transfer function The following transfer function can be specified if the boolean Inputs b PIn The Feedback Path and b DIn The Feedback Path are FALSE. Otherwise the transfer function only describes part of the transfer behavior of the function block. æ 1 T s ö G (s)= K ç1+ + v ÷ PID p T s 1+T s è ø n d Functional diagram The standard functional diagram of a PID controller in additive form has been expanded by the two active boolean Inputs b PIn The Feedback Path and b DIn The Feedback Path (which act as "switches"), so that a modified functional diagram can be activated. Control background: due to the differential component of the control algorithm, large control values are generated at setpoint step-changes, which cause a strain on the control elements and may cause the control system to oscillate. A control algorithm with a differential component that is only applied to the controlled variable (b DIn The Feedback Path := TRUE) can avoid this problem. The b PIn The Feedback Path and b DIn The Feedback Path Inputs permit the closed control loop to implement the following transfer functions: 78 Version: 2.2.4 TF4100
## Page 79

PLC API b PIn The Feedback Path b DIn The Feedback Path G(s) false false G (s)×G (s) G(s)= PID S 1+G (s)×G (s) PID S true false G (s)×G (s) G(s)= DI S 1+G (s)×G (s) PID S false true G (s)×G (s) G(s)= PI S 1+G (s)×G (s) PID S true true G (s)×G (s) G(s)= I S 1+G (s)×G (s) PID S with: æ 1 T s ö G (s)= K ç + v ÷ DI p T s 1+T s è ø n d æ 1 ö G (s)= K ç1+ ÷ PI p T s è ø n æ 1 ö G (s)= K ç ÷ I p T s è ø n The standard setting for the two b PIn The Feedback Path and b DIn The Feedback Path Inputs is FALSE. The PID controller then corresponds to a standard PID controller in additive form. TF4100 Version: 2.2.4 79
## Page 80

PLC API Step response ARW Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; e Parameter Record : E_CTRL_PARAMETER_RECORD; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR 80 Version: 2.2.4 TF4100
## Page 81

PLC API Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable e Parameter E_CTRL_ Index of the active parameter set Record PARAMETER_ RECORD f Man Sync Value FLOAT Input with which the PI element can be set. b Sync BOOL A rising edge at this input sets the PI-element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the control deviation. Outputs VAR_OUTPUT f Out Pos : FLOAT; f Out Neg : FLOAT; f Out : FLOAT; b ARWActive : BOOL := FALSE; b Parameter Change Active : BOOL; e State : E_CTRL_STATE; b Error : BOOL; e Error Id : E_CTRL_ERRORCODES; END_VAR Name Type Description f Out Pos FLOAT Output of the PID-element when the control value is positive. A zero is output otherwise. f Out Neg FLOAT Output of the PID-element when the control value is negative. A zero is output otherwise. f Out FLOAT Output of the PID element b ARWActive BOOL A TRUE at this output indicates that the PID-element is being restricted. b Parameter BOOL A TRUE at this output indicates that the change from one parameter Change Active set to the other is in progress. e State E_CTRL_STATE State of the function block b Error BOOL Becomes TRUE, as soon as an error occurs. e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PID_SPLITRANGE_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PID_ Parameter structure of the PID element SPLITRANGE_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_PID_SPLITRANGE_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp_heating : FLOAT := 0; t Tn_heating : TIME := T#0ms; TF4100 Version: 2.2.4 81
## Page 82

PLC API t Tv_heating : TIME := T#0ms; t Td_heating : TIME := T#0ms; f Kp_cooling : FLOAT := 0; t Tn_cooling : TIME := T#0ms; t Tv_cooling : TIME := T#0ms; t Td_cooling : TIME := T#0ms; n Parameter Change Cycle Ticks : INT; f Out Max Limit : FLOAT := 1E38; f Out Min Limit : FLOAT := -1E38; b PIn The Feedback Path : BOOL; b DIn The Feedback Path : BOOL; b ARWOn IPart Only : BOOL; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. Range e CTRL_PARAMETER_RECORD_HEATING: f Kp_heating FLOAT Controller amplification / controller coefficient t Tn_heating TIME Integral action time: The I-component is deactivated if this is parameterized as T#0s. t Tv_heating TIME Derivative action time: The D-component is deactivated if this is parameterized as T#0s. t Td_heating TIME Damping time Range e CTRL_PARAMETER_RECORD_COOLING: f Kp_cooling FLOAT Controller amplification / controller coefficient t Tn_cooling TIME Integral action time: The I-component is deactivated if this is parameterized as T#0s. t Tv_cooling TIME Derivative action time: The D-component is deactivated if this is parameterized as T#0s. t Td_cooling TIME Damping time n Parameter INT The number of task cycles over which the change from one parameter Change Cycle set to the other takes place. Ticks f Out Max Limit FLOAT Upper limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. f Out Min Limit FLOAT Lower limit at which integration is halted and to which the output is limited (ARW measure). Reaching this limit is indicated by a TRUE at the b ARWActive output. b PIn The Feed BOOL Input value of the P-element can be selected with this input (see back Path functional diagram). b DIn The Feed BOOL Input value of the D-element can be selected with this input (see back Path functional diagram). b ARWOn IPart On BOOL If this parameter is FALSE (the standard setting), the integration of ly the I-component is halted if the complete controller output reaches the upper or lower limit. If it is TRUE, the integration is halted if the I- component (the output of the integrator) reaches some limit. (Cf. functional diagram.) 82 Version: 2.2.4 TF4100
## Page 83

PLC API 4.2.1.3.13 FB_CTRL_STEP_PID The function block controls a digitally manipulated variable for the integration of actuators. It is based on a standard PID controller with an additional binary output signal in conjunction with the analog output and works without a precise position feedback signal. The position feedback signal required to calculate the controller output is estimated using the limiting values and the time required to reach these limits. The function block then generates pulses that are required to drive the actuator as a servomotor. Inputs VAR_INPUT f Setpoint Value : LREAL; f Actual Value : LREAL; b Limit Switch Pos : BOOL; b Limit Switch Neg : BOOL; b Auto Reset : BOOL; n Sensor Type : E_CTRL_STEP_SENSORTYPES; f Disturbance Value : REAL; b Manual Digital Pos : BOOL; b Manual Digital Neg : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Setpoint Value LREAL Setpoint of the controlled variable f Actual Value LREAL Actual value of the control value b Limit Switch Pos BOOL Limit switch, becomes TRUE when the upper stop is reached. b Limit Switch Neg BOOL Limit switch, becomes TRUE when the lower stop is reached. b Auto Reset BOOL If the variable is TRUE, it resets the controller to initial conditions. n Sensor Type E_CTRL_STEP_ Enables the selection of the correct thermocouple type. SENSORTYPES f Disturbance REAL Actual value of the disturbance variable Value b Manual Digital BOOL If the variable is TRUE, the motor is manually set to the positive Pos direction b Manual Digital BOOL If TRUE, the motor is manually set to the negative direction Neg e Mode E_CTRL_MODE Input specifying the operation mode of the controller Outputs VAR_OUTPUT b Ctrl Digital Pos : BOOL; b Ctrl Digital Neg : BOOL; f Ctrl Analog : LREAL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; TF4100 Version: 2.2.4 83
## Page 84

PLC API b Busy : BOOL; b Min Limit Neg : BOOL; b Min Limit Pos : BOOL; b ARWActive : BOOL; END_VAR Name Type Description b Ctrl Digital Pos BOOL Output required to run the motor in a positive direction. b Ctrl Digital Neg BOOL Output required to run the motor in a negative direction. f Ctrl Analog LREAL Analog output of the controller e State E_CTRL_STATE Actual state of the controller e Error Id E_CTRL_ERROR Returns the error number if b Error is TRUE. CODES b Error BOOL TRUE if an error occurs in the function block. b Busy BOOL TRUE when the function block is active. b Min Limit Neg BOOL TRUE at this output indicates that the controller has reached its minimum limit value. b Min Limit Pos BOOL TRUE at this output indicates that the controller has reached its maximum limit value. b ARWActive BOOL TRUE at this output indicates that the controller is currently restricted. Inputs/ outputs VAR_IN_OUT st Ctrl Params : ST_CTRL_STEP_PID_PARAMS; END_VAR Name Type Description st Ctrl Params ST_CTRL_STEP_ Parameter structure of the controller. PID_PARAMS st Ctrl Params consists of the following elements: TYPE ST_CTRL_STEP_PID_PARAMS: STRUCT t Ctrl Cycle Time : TIME; t Task Cycle Time : TIME; f Kp : REAL; f Tn : REAL; f Tv : REAL; f Td : REAL; f TM : REAL; f Dead Band Width : REAL; t Minimum Pulse Time : TIME; t Filter Time : TIME; f Wmax : REAL; f Wmin : REAL; f YMax : REAL; f YMin : REAL; END_STRUCT END_TYPE 84 Version: 2.2.4 TF4100
## Page 85

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value for internal calculation to determine whether the state and output values have been updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle, this corresponds to the task cycle time of the calling task. f Kp REAL Controller gain or proportional gain f Tn REAL Integral action time: The I component is disabled if this parameter is zero. f Tv REAL Derivative action time; the D component is disabled if this parameter is zero. f Td REAL Damping time f TM REAL Digital valve actuation time in seconds f Dead Band Width REAL Permissible width of the controller deviation t Minimum Pulse TIME Minimum pulse time for pulse generator Time t Filter Time TIME Filter time for actual value filter f Wmax REAL Maximum setpoint in °C f Wmin REAL Minimum setpoint in °C f YMax REAL Maximum value of the controller output f YMin REAL Minimum value of controller output 4.2.1.4 Filter / Controlled System Simulation 4.2.1.4.1 FB_CTRL_ACTUAL_VALUE_FILTER The function block allows a measured input value to be checked for plausibility and filtered. Behavior of the output TF4100 Version: 2.2.4 85
## Page 86

PLC API This function block allows a plausibility check to be carried out on a measured input value. If the difference between two sampling values in sequence (measurements) is larger than the specified window, f Delta Max, then the current input value is suppressed for a maximum of three cycles. During this time the output value is extrapolated from the previous input values. If the specified window is exceeded for more than three cycles, the output will again follow the input value. The behavior of the output is illustrated in the diagram above. Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Input value of the filter f Man Value FLOAT Input value that is output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the function block e State E_CTRL_ State of the function block STATE e Error Id E_CTRL_ Supplies the error number [} 173] when the output b Error is set. ERROR CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_ACTUAL_VALUE_FILTER_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ACTU Parameter structure of the actual value filter element AL_VALUE_FILTE R_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_ACTUAL_VALUE_FILTER_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Delta Max : FLOAT; END_STRUCT END_TYPE 86 Version: 2.2.4 TF4100
## Page 87

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Delta Max FLOAT Maximum difference between two input values in sequence. See description above. 4.2.1.4.2 FB_CTRL_ARITHMETIC_MEAN 1 c= åc n n n Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f In FLOAT Input value for the mean value filter f Man Sync FLOAT Input value to which the mean value filter can be set, or that is issued Value at the output in manual mode. b Sync BOOL A rising edge at this input sets the mean value filter to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the input value. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR TF4100 Version: 2.2.4 87
## Page 88

PLC API Name Type Description f Out FLOAT Output of the mean value filter e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_ARITHMETIC_MEAN_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the mean value filter ARITHMETIC_ MEAN_PARAMS st Params consists of the following elements: TYPE ST_CTRL_ARITHMETIC_MEAN_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. 4.2.1.4.3 FB_CTRL_MEDIAN_FILTER The function block specifies the median. The median is the mean value of a list of values ordered by size. This means that one half of the collected data values is smaller than the median value, the other half is larger. The programmer must create an array "ARRAY [1..2(n+2)] OF LREAL", in which the function block can store the internal required data. Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; e Mode : E_CTRL_MODE; b Sync : FLOAT; b Hold : BOOL; END_VAR 88 Version: 2.2.4 TF4100
## Page 89

PLC API Name Type Description f In FLOAT Input value of the median filter f Man Sync Value FLOAT Input value to which the median filter can be set or which is output in manual mode. e Mode E_CTRL_MODE With a rising edge at this input the median filter is set to the value "f Man Sync Value". b Sync FLOAT Input that specifies the operation mode of the function block. b Hold BOOL TRUE at this input holds the internal state and thus also the output. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the median filter e State E_CTRL_STATE Status of the function block e Error Id E_CTRL_ERROR Supplies the error number when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; n Samples To Filter : UINT; p Work Array_ADR : POINTER TO FLOAT := 0; n Work Array_SIZEOF : UINT := 0; END_VAR Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. n Samples To UINT Number of values "n" used to form the median value. Filter p Work Array_ POINTER TO The address of the array where the input values are temporarily ADR FLOAT stored. n Work Array_ UINT Size of the Work Arrays SIZEOF 4.2.1.4.4 FB_CTRL_DIGITAL_FILTER TF4100 Version: 2.2.4 89
## Page 90

PLC API This function block calculates a discrete transfer function with the structure described below. This structure allows either an FIR filter (Finite Impulse Response) or an IIR filter (Infinite Impulse Response) to be implemented. The transfer function here can be of any order, n. The coefficients for the following transfer structure are stored in the parameter arrays: Y(z) b +b z-1+b z-2 +...+b z-(n-1) G(z)= = 1 2 3 n X(z) 1+a z-1+a z-2 +...+a z-(n-1) 2 3 n The programmer must create the following arrays in the PLC if this function block is to be used: a Coefficients Array_a : ARRAY[1..n Filter Order+1] OF FLOAT; a Coefficients Array_b : ARRAY[1..n Filter Order+1] OF FLOAT; a St Digital Filter Data : ARRAY[1..n Filter Order] OF ST_CTRL_DIGITAL_FILTER_DATA; The coefficients "b " to "b " are stored in the array a Coefficients Array_b. This must be organized as 1 n follows: a Coefficients Array_b[1] := b1; a Coefficients Array_b[2] := b2; … a Coefficients Array_b[n-1] := bn-1; a Coefficients Array_b[n] := bn; The coefficients "a1" to "an" are stored in the array a Coefficients Array_a. This must be organized as follows: a Coefficients Array_a[1] := xxx; (* not being evaluated *) a Coefficients Array_a[2] := a2; ... a Coefficients Array_a[n-1] := an-1; a Coefficients Array_a[n] := an; The internal data required by the function block is stored in the array a St Digital Filter Data. This data must never be modified from within the PLC program. This procedure is also illustrated in the sample program listed below. Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; END_VAR 90 Version: 2.2.4 TF4100
## Page 91

PLC API Name Type Description f In FLOAT Input of the digital filter f Man Value FLOAT Input whose value is present at the output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode of the function block. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; b Error : BOOL; e Error Id : E_CTRL_ERRORCODES; END_VAR Name Type Description f Out FLOAT Output of the digital filter e State E_CTRL_STATE State of the function block b Error BOOL Becomes TRUE, as soon as an error occurs. e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_DIGITAL_FILTER_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the function block DIGITAL_FILTER _PARAMS st Params consists of the following elements: TYPE ST_CTRL_DIGITAL_FILTER_PARAMS : STRUCT t Task Cycle Time : TIME; t Ctrl Cycle Time : TIME := T#0ms; n Filter Order : USINT; p Coefficients Array_a_ADR : POINTER TO FLOAT := 0; n Coefficients Array_a_SIZEOF : UINT; p Coefficients Array_b_ADR : POINTER TO FLOAT := 0; n Coefficients Array_b_SIZEOF : UINT; p Digital Filter Data_ADR : POINTER TO ST_CTRL_DIGITAL_FILTER_DATA; n Digital Filter Data_SIZEOF : UINT; END_STRUCT END_TYPE TF4100 Version: 2.2.4 91
## Page 92

PLC API Name Type Description t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. n Filter Order USINT Order of the digital filter [0... ] p Coefficients Arra POINTER TO Address of the array containing the a coefficients y_a_ADR FLOAT n Coefficients Arra UINT Size of the array containing the a coefficients, in bytes y_a_SIZEOF p Coefficients Arra POINTER TO Address of the array containing the b coefficients y_b_ADR FLOAT n Coefficients Arra UINT Size of the array containing the b coefficients, in bytes y_b_SIZEOF p Digital Filter Data POINTER TO Address of the data array _ADR ST_CTRL_ DIGITAL_ FILTER_DATA n Digital Filter Data UINT Size of the data array in bytes _SIZEOF TYPE ST_CTRL_DIGITAL_FILTER_DATA STRUCT Internal structure. This must not be written to. END_STRUCT END_TYPE Sample: PROGRAM PRG_DIGITAL_FILTER_TEST VAR fb Digital Filter : FB_CTRL_DIGITAL_FILTER; a Coefficients Array_a : ARRAY[1..3] OF FLOAT; a Coefficients Array_b : ARRAY[1..3] OF FLOAT; a St Digital Filter Data : ARRAY[1..2] OF ST_CTRL_DIGITAL_FILTER_DATA; e Mode : E_CTRL_MODE; st Params : ST_CTRL_DIGITAL_FILTER_PARAMS; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; f In : FLOAT := 0; f Out : FLOAT; b Init : BOOL := TRUE; END_VAR IF b Init THEN a Coefficients Array_a[1] := 0.0; (* not used *) a Coefficients Array_a[2] := 0.2; a Coefficients Array_a[3] := 0.1; a Coefficients Array_b[1] := 0.6; a Coefficients Array_b[2] := 0.4; a Coefficients Array_b[3] := 0.2; st Params.t Task Cycle Time := T#2ms; st Params.t Ctrl Cycle Time := T#2ms; st Params.n Filter Order := 2; e Mode := e CTRL_MODE_ACTIVE; b Init := FALSE; END_IF st Params.p Coefficients Array_a_ADR := ADR(a Coefficients Array_a); st Params.n Coefficients Array_a_SIZEOF := SIZEOF(a Coefficients Array_a); st Params.p Coefficients Array_b_ADR := ADR(a Coefficients Array_b); st Params.n Coefficients Array_b_SIZEOF := SIZEOF(a Coefficients Array_b); st Params.p Digital Filter Data_ADR := ADR(ast Digital Filter Data); st Params.n Digital Filter Data_SIZEOF := SIZEOF(a St Digital Filter Data); 92 Version: 2.2.4 TF4100
## Page 93

PLC API fb Digital Filter ( f In := f In, e Mode := e Mode, st Params := st Params, f Out => f Out, e Error Id => e Error Id, b Error => b Error); 4.2.1.4.5 FB_CTRL_MOVING_AVERAGE The function block provides a moving average filter in the functional diagram. The arithmetic mean value of the last "n" values is calculated. 1 c n = å c k n i i=k-n The programmer must create an array "ARRAY [1...n] of FLOAT" in the PLC, in which the function block can store the internally required data. Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f In FLOAT Input value for the moving average filter f Man Sync Value FLOAT Input value to which the moving average filter can be set, or that is issued at the output in manual mode. b Sync BOOL A rising edge at this input sets the moving average filter to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the input value. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR TF4100 Version: 2.2.4 93
## Page 94

PLC API Name Type Description f Out FLOAT Output of the moving average filter e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_MOVING_AVERAGE_PARAMS; END_VAR Name Type Description st Params ST_CTRL_MOVIN Parameter structure of the moving average filter G_AVERAGE_PA RAMS st Params consists of the following elements: TYPE ST_CTRL_MOVING_AVERAGE_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; n Samples To Filter : UINT; p Work Array_ADR : POINTER TO FLOAT := 0; n Work Array_SIZEOF : UINT := 0; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. n Samples To UINT The number of values, "n", whose arithmetic mean value is Filter calculated. p Work Array_ POINTER TO The address of the array where the input values are temporarily ADR FLOAT stored. n Work Array_ UINT Size of the Work Arrays SIZEOF 4.2.1.4.6 FB_CTRL_LEAD_LAG The function block represents a digital lead/lag filter. 94 Version: 2.2.4 TF4100
## Page 95

PLC API Transfer function 1+Ts G(s)= 1 1+T s 2 Step response with T2 > T1 Step response with T1 > T2 The step response at time T=0 is T1 / T2. TF4100 Version: 2.2.4 95
## Page 96

PLC API Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; b Sync : FLOAT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Input value of the notch filter f Man Sync Value FLOAT Input value that is output at the output in manual mode. b Sync FLOAT reserve f Man Value FLOAT Input that specifies the operation mode [} 173] of the function block. e Mode E_CTRL_MODE A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the input value. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Lead/lag filter output e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES (p>) b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_LEAD_LAG_FILTER_PARAMS; END_VAR Name Type Description st Params ST_CTRL_LEAD_ Parameter structure of the lead/lag filter LAG_FILTER_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_LEAD_LAG_FILTER_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; t T1 : TIME := T#0ms; (* T1 *) t T2 : TIME := T#0ms; (* T2 *) END_STRUCT END_TYPE 96 Version: 2.2.4 TF4100
## Page 97

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t T1 TIME T1, see G(s). t T2 TIME T2, see G(s). 4.2.1.4.7 FB_CTRL_NOISE_GENERATOR This function block generates a noise signal on the basis of the pseudo-random number in the range [- f Amplitude ... f Amplitude]. Output signal Output signal with an amplitude of 5.0. Inputs VAR_INPUT f Man Sync Value : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Man Sync Value FLOAT Input value that is output at the output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the noise generator e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_NOISE_GENERATOR_PARAMS; END_VAR TF4100 Version: 2.2.4 97
## Page 98

PLC API Name Type Description st Params ST_CTRL_NOISE_ Parameter structure of the noise generator GENERATOR_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_NOISE_GENERATOR_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Amplitude : FLOAT := 0; END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Amplitude FLOAT Amplitude of the output signal: A noise signal extending over the range [-f Amplitude/2.0 ... f Amplitude/2.0] is created at the function block's output. 4.2.1.4.8 FB_CTRL_NOTCH_FILTER The function block represents a digital notch filter. Transfer instruction s2 +w2 G(s)= 0 s2 +ew s+w2 0 0 98 Version: 2.2.4 TF4100
## Page 99

PLC API Bode diagram with: f =100Hz 0 e=0.25 Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Input value of the notch filter f Man Value FLOAT Input value that is output at the output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR TF4100 Version: 2.2.4 99
## Page 100

PLC API Name Type Description f Out FLOAT Notch filter output e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_NOTCH_FILTER_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the notch filter NOTCH_FILTER_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_NOTCH_FILTER_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Notch Freq : FLOAT := 0; f Bandwidth : FLOAT := 0; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Notch Freq FLOAT notch frequency in Hz f Bandwidth FLOAT bandwidth relative to the notch frequency: bandwidth in Hz = f Notch Freq * f Bandwidth 4.2.1.4.9 FB_CTRL_PT1 The function block provides a PT1 transfer element in the functional diagram. Transfer function 1 G(s)= K p1+Ts 1 100 Version: 2.2.4 TF4100
## Page 101

PLC API Step response Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f In FLOAT Input value of the PT1 element f Man Sync Value FLOAT Input value to which the PT1 element can be set, or that is issued at the output in manual mode. b Sync BOOL A rising edge at this input sets the PT1-element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the input value. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the PT1 element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. TF4100 Version: 2.2.4 101
## Page 102

PLC API Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PT1_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PT1_ Parameter structure of the PT1 element PARAMS st Params consists of the following elements: TYPE ST_CTRL_PT1_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0; t T1 : TIME := T#0ms; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Controller amplification / transfer coefficient t T1 TIME time constant 4.2.1.4.10 FB_CTRL_PT2 The function block provides a non-oscillating PT2 transfer element in the functional diagram. Transfer function 1 1 G(s)= K p1+Ts1+T s 1 2 102 Version: 2.2.4 TF4100
## Page 103

PLC API Step response Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f In FLOAT Input value of the PT2 element f Man Value FLOAT Input value that is output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the input value. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the PT2 element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PT2_PARAMS; END_VAR TF4100 Version: 2.2.4 103
## Page 104

PLC API Name Type Description st Params ST_CTRL_PT2_ Parameter structure of the PT2 element PARAMS st Params consists of the following elements: TYPE ST_CTRL_PT2_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0; t T1 : TIME := T#0ms; t T2 : TIME := T#0ms; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Controller amplification / transfer coefficient t T1 TIME Time constant T1 t T2 TIME Time constant T2 4.2.1.4.11 FB_CTRL_PT2oscillation The function block provides an oscillating PT2 transfer element in the functional diagram. Transfer function 1 G(s)= K p1+2JT s+T2s2 0 0 104 Version: 2.2.4 TF4100
## Page 105

PLC API Step response Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f In FLOAT Input value of the oscillating PT2 element f Man Value FLOAT Input value that is output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the input value. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the PT2 element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PT2oscillation_PARAMS; END_VAR TF4100 Version: 2.2.4 105
## Page 106

PLC API Name Type Description st Params ST_CTRL_PT2 Parameter structure of the oscillating PT2 element oscillation_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_PT2oscillation_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0; f Theta : FLOAT := 0; t T0 : TIME := T#0ms; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Proportional gain f Theta FLOAT Damping ratio t T0 TIME Characteristic time 4.2.1.4.12 FB_CTRL_PT3 The function block provides a non-oscillating PT3 transfer element in the functional diagram. Transfer function 1 1 1 G(s)= K p1+Ts1+T s1+T s 1 2 3 106 Version: 2.2.4 TF4100
## Page 107

PLC API Step response Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f In FLOAT Input value of the PT3 element f Man Value FLOAT Input value that is output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the input value. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the PT3 element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PT3_PARAMS; END_VAR TF4100 Version: 2.2.4 107
## Page 108

PLC API Name Type Description st Params ST_CTRL_PT3_ Parameter structure of the PT3 element PARAMS st Params consists of the following elements: TYPE ST_CTRL_PT3_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0; t T1 : TIME := T#0ms; t T2 : TIME := T#0ms; t T3 : TIME := T#0ms; END_STRUCT END_TYPE> Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Controller amplification / transfer coefficient t T1 TIME Time constant T1 t T2 TIME Time constant T2p t T3 TIME Time constant T3 4.2.1.4.13 FB_CTRL_PTn This function block provides a non-oscillating PTn transfer element with "n<= 10" and equal time constants in the functional diagram. Transfer function 1 G(s)= K p (1+Ts)n 1 108 Version: 2.2.4 TF4100
## Page 109

PLC API Step response with n=10 Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f In FLOAT Input value of the PTn element f Man Value FLOAT Input value that is output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold BOOL A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the input value. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the PTn element e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PTn_PARAMS; END_VAR TF4100 Version: 2.2.4 109
## Page 110

PLC API Name Type Description st Params ST_CTRL_PTn_ Parameter structure of the PTn element PARAMS st Params consists of the following elements: TYPE ST_CTRL_PTn_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0; t T1 : TIME := T#0ms; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Controller amplification / transfer coefficient t T1 TIME Time constant T1 4.2.1.4.14 FB_CTRL_PTt The function block provides an PTt transfer element in the functional diagram. Transfer function G(s)= K ge-T t s p This function block contains internally an array of 500 elements with which the input values can be delayed. When using the t Ctrl Cycle Time this results in a maximum delay of "500 * t Ctrl Cycle Time". If this maximum delay is insufficient, the sampling time is extended internally to make it possible to reach the requested dead time. It should, however, be remembered that this process involves increasing the time between the discretization steps. If a new sampling time has been calculated, this is indicated by a TRUE on the b Sample Rate Changed output. Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR 110 Version: 2.2.4 TF4100
## Page 111

PLC API Name Type Description f In FLOAT Input value of the PTt element f Man Sync Value FLOAT Input value to which the PTt element can be set, or that is issued at the output in manual mode. b Sync BOOL A rising edge at this input sets the PTt element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : FLOAT; b Sample Rate Changed : BOOL; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the PTt element b Sample Rate BOOL Output that indicates whether the function block has internally Changed reduced the sampling rate because of the array being used to delay the input signal not otherwise providing sufficient room. e Error Id E_CTRL_ Supplies the error number [} 173] when the output b Error is set. ERRORCODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PTt_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PTt_ Parameter structure of the PTt element PARAMS st Params consists of the following elements: TYPE ST_CTRL_PTt_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0; t Tt : TIME := T#0ms; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Controller amplification / transfer coefficient t Tt TIME Dead time TF4100 Version: 2.2.4 111
## Page 112

PLC API 4.2.1.4.15 FB_CTRL_SERVO_MOTOR_SIMULATION The behavior of an actuator can be simulated with this function block. Behavior of the output Inputs VAR_INPUT b Move Pos : BOOL; b Move Neg : BOOL; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description b Move Pos BOOL Input that moves the simulated actuator in the positive direction. b Move Neg BOOL Input that moves the simulated actuator in the negative direction. f Man Sync Value FLOAT Input with which the simulated motor position can be set, or the value to which movement takes place in manual mode. b Sync BOOL A rising edge at this input sets the simulated motor position to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. 112 Version: 2.2.4 TF4100
## Page 113

PLC API Outputs VAR_OUTPUT f Motor Positon : FLOAT; f Motor State : FLOAT; b Upper Limit Switch : BOOL; b Lower Limit Switch : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Motor Positon FLOAT Simulated motor position in the range [ f Moving Range Min ... f Moving Range Max ] f Motor State FLOAT Simulated motor position in the range [ 0 … 100.0 ] b Upper Limit BOOL Simulated limit switch at the actuator's positive stop Switch b Lower Limit BOOL Simulated limit switch at the actuator's negative stop. Switch e State E_CTRL_ State of the function block STATE e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_SERVO_MOTOR_SIMULATION_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the function block SERVO_MOTOR_ SIMULATION_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_SERVO_MOTOR_SIMULATION_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Moving Range Min : FLOAT := 0; f Moving Range Max : FLOAT := 0; t Moving Time : TIME := T#0ms; t Dead Time : TIME := T#0ms; END_STRUCT END_TYPE TF4100 Version: 2.2.4 113
## Page 114

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Moving Range FLOAT Minimum position of the simulated actuator Min f Moving Range FLOAT Maximum position of the simulated actuator Max t Moving Time TIME The time required to move the simulated actuator from one stop to the other. t Dead Time TIME Dead time of the simulated actuator 4.2.1.4.16 FB_CTRL_Tu Tg The function block provides a Tu Tg transfer element (a dead time delay element) in the functional diagram. Transfer function 1 G(s)= K ×e-T u s p1+T s g 114 Version: 2.2.4 TF4100
## Page 115

PLC API Inputs VAR_INPUT f In : FLOAT; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; b Hold : BOOL; END_VAR Name Type Description f In FLOAT Input value of the Tu Tg element f Man Sync Value FLOAT Input value to which the Tu Tg element can be set, or that is issued at the output in manual mode. b Sync BOOL A rising edge at this input sets the Tu Tg element to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. b Hold FLOAT A TRUE at this input will hold the internal state (and therefore also the output) constant at its current value, independently of the input value. Outputs VAR_OUTPUT f Out : FLOAT; b Sample Rate Changed : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the Tu Tg element b Sample Rate BOOL Output that indicates whether the function block has internally Changed reduced the sampling rate because of the array being used to delay the input signal not otherwise providing sufficient room. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ Supplies the error number [} 173] when the output b Error is set. ERRORCODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_Tu Tg_PARAMS; END_VAR Name Type Description st Params ST_CTRL_Tu Tg_ Parameter structure of the Tu Tg element PARAMS st Params consists of the following elements: TYPE ST_CTRL_Tu Tg_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Kp : FLOAT := 0; t Tu : TIME := T#0ms; t Tg : TIME := T#0ms; END_STRUCT END_TYPE TF4100 Version: 2.2.4 115
## Page 116

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Kp FLOAT Controller amplification / transfer coefficient t Tu TIME Dead time t Tg TIME time constant 4.2.1.4.17 FB_CTRL_ZERO_ZONE_DAMPING This function block enables zero point damping to be realized in order to minimize control interventions in the range | actual value - setpoint | < ε. Transfer behavior in the time range 116 Version: 2.2.4 TF4100
## Page 117

PLC API Inputs VAR_INPUT f Setpoint Value : FLOAT; f Actual Value : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Setpoint Value FLOAT Setpoint of the controlled variable f Actual Value FLOAT Actual value of the controlled variable e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Setpoint Value Out : FLOAT; f Actual Value Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Setpoint Value FLOAT Filtered setpoint to controller Out f Actual Value Out FLOAT Actual value to controller e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_ZERO_ZONE_DAMPING_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ZERO_ Parameter structure of the transfer element ZONE_ DAMPING_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_PI_PST_CTRL_ZERO_ZONE_DAMPING_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Damping Coefficient : FLOAT := 0.0; END_STRUCT END_TYPE TF4100 Version: 2.2.4 117
## Page 118

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Damping Co FLOAT The parameter corresponds to k in the transfer function. damping efficient 4.2.1.5 Interpolation 4.2.1.5.1 FB_CTRL_LIN_INTERPOLATION This function block performs linear interpolation to obtain values on the basis of a sampling points table. Behavior of the output f In f Out arr Table[1,1] := 10; arr Table[1,2] := 7; arr Table[2,1] := 15; arr Table[2,2] := 10; arr Table[3,1] := 21; arr Table[3,2] := 9; arr Table[4,1] := 22; arr Table[4,2] := 2; arr Table[5,1] := 30; arr Table[5,2] := 3; arr Table[6,1] := 40; arr Table[6,2] := 6; 118 Version: 2.2.4 TF4100
## Page 119

PLC API Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; b Extrapolate : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Input value for the interpolation function block f Man Value FLOAT Input value that is output in manual mode. b Extrapolate BOOL If this input is FALSE, then the value of the last interpolation point is output if the limits of the table are exceeded. If, however, it is TRUE, then extrapolation is performed on the basis of the last two interpolation points. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : FLOAT; b In Is Greater Than Max Element : BOOL; b In Is Less Than Min Element : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Table value from linear interpolation b In Is Greater BOOL A TRUE at this output indicates that the input value is greater than the Than Max largest interpolation point. Element b In Is Less Than BOOL A TRUE at this output indicates that the input value is smaller than the Min smallest interpolation point. Element e State E_CTRL_ State of the function block STATE e Error Id E_CTRL_ Supplies the error number [} 173] when the output b Error is set. ERRORCODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_LIN_INTERPOLATION_PARAMS; END_VAR Name Type Description st Params ST_CTRL_LIN_IN Parameter structure of the interpolation element TERPOLATION_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_2POINT_PARAMS : STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; p Data Table_ADR : POINTER TO FLOAT := 0; n Data Table_SIZEOF : UINT := 0; n Data Table_Number Of Rows : UINT := 0; END_STRUCT END_TYPE TF4100 Version: 2.2.4 119
## Page 120

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. p Data Table_ POINTER TO Address of the n x 2 array on which linear interpolation is to be carried ADR FLOAT out. n Data Table_ UINT Size of the n x 2 array SIZEOF n Data Table_ UINT Number of rows in the array Number Of Rows 4.2.1.5.2 FB_CTRL_NORMALIZE This function block can be used to linearize a non-linear transfer element, with the aid of an inverse characteristic curve. The characteristic curve of the transfer element that is to be linearized is stored in the table associated with this function block. The function block uses this to calculate the inverse characteristic curve with which the linearization can be carried out. Sample The following valve characteristic curve is stored in the table with 4 interpolation points. 120 Version: 2.2.4 TF4100
## Page 121

PLC API Control value Valve position arr Table[1,1] := -6; arr Table[1,2] := -100; arr Table[2,1] := -1; arr Table[2,2] := -70; arr Table[3,1] := 1; arr Table[3,2] := 70; arr Table[4,1] := 6; arr Table[4,2] := 100; The inverse characteristic curve is calculated from this characteristic curve: In the ideal case, applying these two characteristic curves in series will result in a linear transfer behavior. TF4100 Version: 2.2.4 121
## Page 122

PLC API Inputs VAR_INPUT f In : FLOAT; f Man Value : FLOAT; b Extrapolate : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Input value f Man Value FLOAT Input value that is output in manual mode. b Extrapolate BOOL If this input is FALSE, then the value of the last interpolation point is output if the limits of the table are exceeded. If, however, it is TRUE, then extrapolation is performed on the basis of the last two interpolation points. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : FLOAT; b In Is Greater Than Max Element : BOOL; b In Is Less Than Min Element : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Table value from linear interpolation b In Is Greater Than BOOL A TRUE at this output indicates that the input value is greater than the Max Element largest interpolation point. b In Is Less Than Mi BOOL A TRUE at this output indicates that the input value is smaller than the n Element smallest interpolation point. e State E_CTRL_ State of the function block STATE e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_NORMALIZE_PARAMS; END_VAR Name Type Description st Params ST_CTRL_NORM Parameter structure of the function block ALIZE_PARAMS st Params consists of the following elements: TYPE ST_CTRL_NORMALIZE_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; p Data Table_ADR : POINTER TO FLOAT := 0; n Data Table_SIZEOF : UINT := 0; n Data Table_Number Of Rows : UINT := 0; END_STRUCT END_TYPE 122 Version: 2.2.4 TF4100
## Page 123

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. p Data Table_ POINTER TO Address of the n x 2 array on which linear interpolation is to be carried ADR FLOAT out. n Data Table_ UINT Size of the n x 2 array SIZEOF n Data Table_ UINT Number of rows in the array Number Of Rows 4.2.1.6 Monitoring / Alarming 4.2.1.6.1 FB_CTRL_CHECK_IF_IN_BAND The function block monitors whether the input value is within the range [f Min ... f Max], i.e. whether the inequality f Min£ f In£ f Max is fulfilled. Inputs VAR_INPUT f In : FLOAT; END_VAR Name Type Description f In FLOAT Input value that is monitored. Outputs VAR_OUTPUT b In Band : BOOL; b Not In Band : BOOL; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR TF4100 Version: 2.2.4 123
## Page 124

PLC API Name Type Description b In Band BOOL A TRUE at this output indicates that the input value is within the specified range. b Not In Band BOOL A TRUE at this output indicates that the input value is not within the specified range. e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_CHECK_IF_IN_BAND_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the function block CHECK_IF_IN_ BAND_PARAMS st Params consists of the following elements: TYPE ST_CTRL_CHECK_IF_IN_BAND_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Min : FLOAT; f Max : FLOAT; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Min FLOAT Lower limit of the range f Max FLOAT Upper limit of the range 4.2.1.6.2 FB_CTRL_LOG_DATA This function block allows a log file to be created in *.csv format (comma separated values), in which a maximum of 10 variables may be recorded. The column headings specified by the user are written in the first row of this file. The input data is written at equal time intervals in the following lines. The individual entries are separated by a comma. The time interval between the entries is specified in the t Log Cycle Time parameter. If, for instance, t Log Cycle Time := T\#2s is chosen, then an entry is made in the file every 2s. The files that were generated can be analyzed with a spreadsheet program, for example. 124 Version: 2.2.4 TF4100
## Page 125

PLC API The time stamp of the log entry, in s, is stored in the first column of the file. The other columns contain the data of the function block input f Log Data. When the mode is set to e CTRL_MODE_ACTIVE the log file is opened and entries are written into the file. The file remains open until the function block's mode is set to e CTRL_MODE_PASSIVE. It is essential that the file is closed by switching into e CTRL_MODE_PASSIVE before attempting to analyze the log file. If this is not done, it is possible that not all the entries will be written into the file. The function block makes it possible to work with or without an external buffer. Operating without an The b Busy output is TRUE when the logging of a row has been started. The external buffer: following data set will not be logged until the b Busy output is FALSE again. The f Buffer Usage output indicates how full the internal buffer is. Operating with an The user must create a buffer larger than 255 bytes and with the type ARRAY OF external buffer: BYTES. The individual messages are temporarily stored in the external buffer, and this buffer is written into the file as quickly as possible. The f Buffer Usage output indicates how full the buffer is. The function block is stopped and an error is output if the buffer overflows. The external buffer is used if a buffer address and a buffer size greater than zero are parameterized. In the absence of an external buffer, an internal buffer with the size of 255 bytes is used. Inputs VAR_INPUT f Log Data : T_CTRL_LOGGER_DATA; e Mode : E_CTRL_MODE; END_VAR VAR_GLOBAL CONSTANT n CTRL_LOGGER_DATA_ARRAY_SIZE : UINT := 10; END_VAR TYPE T_CTRL_LOGGER_DATA : ARRAY [1..n CTRL_LOGGER_DATA_ARRAY_SIZE] OF FLOAT; END_TYPE Name Type Description f Log Data T_CTRL_ Array containing the values that are to be written into the log file. LOGGER_DATA e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT e State : E_CTRL_STATE; b File Open : BOOL b File Closed : BOOL f Buffer Usage : FLOAT b Busy : BOOL e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR TF4100 Version: 2.2.4 125
## Page 126

PLC API Name Type Description e State E_CTRL_STATE State of the function block b File Open BOOL A TRUE at this output indicates that the file has successfully been opened. b File Closed BOOL A TRUE at this output indicates that the file has successfully been closed. f Buffer Usage FLOAT Current fill level of the external buffer as a percentage b Busy BOOL A TRUE at this output indicates that logging a row is active. e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_LOG_DATA_PARAMS; END_VAR Name Type Description st Params ST_CTRL_LOG_ Parameter structure of the logging function block DATA_PARAMS st Params consists of the following elements: TYPE ST_CTRL_LOG_DATA_PARAMS: STRUCT t Log Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; s File Name : STRING; s Net Id : T_Ams Net Id := ''; t File Operation Timeou : TIME := T#3s; n Number Of Column : INT(1..10); ar Column Headings : ARRAY [1..10] OF STRING; b Append Data : BOOL := FALSE; b Write Time Stamps : BOOL := TRUE; b Write Column Headings : BOOL := TRUE; b Write Absolute Time Stamps : BOOL := FALSE p Log Buffer_ADR : POINTER TO BYTE; n Log Buffer_SIZEOF : UDINT; END_STRUCT END_TYPE 126 Version: 2.2.4 TF4100
## Page 127

PLC API Name Type Description t Log Cycle Time TIME Cycle time with which entries are written into the log file. This must be greater than or equal to the Task Cycle Time. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. s File Name STRING Name and path of the log file, for example: d:\Logfile.csv s Net Id T_Ams Net Id The log file is written to the system with the Net Id specified here. t File Operation TIME Timeout for all file operations Timeou n Number Of INT Number of columns written into the file (maximum 10) Column ar Column ARRAY Array of strings that contain the column headings. Headings b Append Data BOOL If this parameter is TRUE, then new data sets are appended when a file is opened again. Otherwise the file is overwritten without query, and this will delete any content that already exists. b Write Time BOOL If this parameter is set to TRUE, the time stamp of the measurement Stamps is written into the first column of the file. b Write Column BOOL If this parameter is set to TRUE, the column headers are written into Headings the first row of the file. b Write Absolute BOOL If this parameter is set to TRUE, the local NT time is used as Time Stamps timestamp. In this case the minimum Log Cycle Time is 5s! p Log Buffer_ADR POINTER TO Address of the external Log Buffer. To detect a buffer, the address BYTE must not be 0. n Log Buffer_ UDINT Size of the Log Buffer. The buffer must be an ARRAY OF BYTE SIZEOF with at least 256 elements. The size of the buffer can be optimized with the aid of the f Buffer Usage output. NOTICE Error during file handling The parameter set can only be changed when the file is closed (b File Closed = TRUE). Otherwise errors can occur during file handling. 4.2.1.6.3 FB_CTRL_LOG_MAT_FILE This function block allows a log file to be created in Matlab 5 (*.mat) format, in which a maximum of 10 magnitudes may be recorded. Two variables are created in the file, a double array and a cell array. The recorded magnitudes are recorded, line-by-line, in the double array. The identifiers of the individual rows are stored in the cell array. The user can specify the name used for the double array in the function block's parameter structure. The name of the cell array is derived from the name of the double array by appending "_Info" to the variable name. TF4100 Version: 2.2.4 127
## Page 128

PLC API The input data is written at equal time intervals in the columns of the data array. A time stamp for the relevant entry, in s, can be stored in the first column. The time interval between the entries is specified in the t Log Cycle Time parameter. If, for instance, "t Log Cycle Time := T\#2s" is chosen, then an entry is made in the file every 2s. When the mode is set to e CTRL_MODE_ACTIVE the log file is opened and entries are written into the file. The file remains open until the function block's mode is set to e CTRL_MODE_PASSIVE. It is essential that the file is closed by switching into e CTRL_MODE_PASSIVE before attempting to analyze the log file. If this is not done, it is possible that not all the entries will be written into the file, which will then not be consistent. The function block makes it possible to work with or without an external buffer. Operating without an The b Busy output is TRUE when the logging of a row has been started. The external buffer: following data set will not be logged until the b Busy output is FALSE again. The f Buffer Usage output indicates how full the internal buffer is. Operating with an The user must create a buffer larger than 1500 bytes and with the type ARRAY OF external buffer: BYTES. The individual messages are temporarily stored in the external buffer, and this buffer is written into the file as quickly as possible. The f Buffer Usage output indicates how full the buffer is. If a buffer overflow occurs, the function block is stopped and an error is output. The external buffer is used if a buffer address and a buffer size greater than zero are parameterized. In the absence of an external buffer, an internal buffer with the size of 1500 bytes is used. Inputs VAR_INPUT f Log Data : T_CTRL_LOGGER_DATA; e Mode : E_CTRL_MODE; END_VAR VAR_GLOBAL CONSTANT n CTRL_LOGGER_DATA_ARRAY_SIZE :UINT := 10; END_VAR TYPE T_CTRL_LOGGER_DATA :ARRAY [1..n CTRL_LOGGER_DATA_ARRAY_SIZE] OF FLOAT; END_TYPE Name Type Description f Log Data T_CTRL_ Array containing the values that are to be written into the log file. LOGGER_DATA e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT e State : E_CTRL_STATE; b File Open : BOOL b File Closed : BOOL f Buffer Usage : FLOAT n Logged Columns : DINT; b Busy : BOOL e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR 128 Version: 2.2.4 TF4100
## Page 129

PLC API Name Type Description e State E_CTRL_STATE State of the function block b File Open BOOL A TRUE at this output indicates that the file has successfully been opened. b File Closed BOOL A TRUE at this output indicates that the file has successfully been closed. f Buffer Usage FLOAT Current fill level of the external buffer as a percentage n Logged DINT Number of columns written in the file Columns b Busy BOOL A TRUE at this output indicates that logging a row is active. e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_LOG_MAT_FILE_PARAMS; END_VAR Name Type Description st Params ST_CTRL_LOG_ Parameter structure of the logging function block MAT_FILE_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_LOG_MAT_FILE_PARAMS: STRUCT t Log Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; s File Name : STRING; n Number Of Rows : INT(1..10); s Matrix Name : STRING; ar Row Description : ARRAY [1..10] OF STRING(25); b Write Time Stamps : BOOL := TRUE; b Write Row Description : BOOL := TRUE; p Log Buffer_ADR : POINTER TO ST_CTRL_MULTIPLE_PWM_OUT_DATA; n Log Buffer_SIZEOF : UDINT; END_STRUCT END_TYPE TF4100 Version: 2.2.4 129
## Page 130

PLC API Name Type Description t Log Cycle Time TIME Cycle time with which entries are written into the log file. This must be greater than or equal to the Task Cycle Time. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. s File Name STRING Name and path of the log file, for example: d:\Logfile.mat n Number Of Rows INT Number of columns written into the file (maximum 10). s Matrix Name STRING Name of the data array ar Row ARRAY Array of strings that contain the line headings. Description b Write Time BOOL If this parameter is set to TRUE, the timestamp of the measurement is Stamps written into the first row of the data array. b Write Row BOOL If this parameter is set to TRUE a cell array is created into which the Description descriptions of the rows are written. p Log Buffer_ADR POINTER TO Address of the external Log Buffer. To detect a buffer, the address ST_CTRL_ must not be 0. MULTIPLE_PWM _OUT_DATA n Log Buffer_ UDINT Size of the Log Buffer. The buffer must be an ARRAY OF BYTE with SIZEOF at least 1501 elements. The size of the buffer can be optimized with the aid of the f Buffer Usage output. NOTICE Error during file handling The parameter set can only be changed when the file is closed (b File Closed = TRUE). Otherwise errors can occur during file handling. Sample PROGRAM PRG_LOG_MAT_FILE_TEST_BUFFERED VAR e Mode : E_CTRL_MODE; st Params : ST_CTRL_LOG_MAT_FILE_PARAMS; Logger Data : T_CTRL_LOGGER_DATA; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; fb Ctrl Log Mat File : FB_CTRL_LOG_MAT_FILE; Log Buffer : ARRAY[0..2000] OF BYTE; b Init : BOOL := TRUE; f In : LREAL; f Out : LREAL; f Max Buffer Usage : LREAL; END_VAR IF b Init THEN st Ctrl_GLOBAL_Cycle Time Interpretation.b Interpret Cycle Time As Ticks := FALSE; st Ctrl_GLOBAL_Cycle Time Interpretation.f Base Time := 0; st Params.t Log Cycle Time := T#2ms; st Params.t Task Cycle Time := T#2ms; st Params.n Number Of Rows := 3; st Params.s File Name := 'D:\test.mat'; st Params.s Matrix Name := 'Twin CAT_Controller Toolbox_Log'; st Params.ar Row Description[1] := 'Input'; st Params.ar Row Description[2] := 'Output 1'; st Params.ar Row Description[3] := 'Output 2'; st Params.b Write Row Description := TRUE; st Params.b Write Time Stamps := TRUE; e Mode := e CTRL_MODE_ACTIVE; b Init := FALSE; END_IF st Params.n Log Buffer_SIZEOF := SIZEOF( Log Buffer ); st Params.p Log Buffer_ADR := ADR( Log Buffer ); f In := f In + 0.01; f Out := SIN(f In); 130 Version: 2.2.4 TF4100
## Page 131

PLC API Logger Data[1]:= f In; Logger Data[2]:= f Out; Logger Data[3]:= f Out * 2; IF fb Ctrl Log Mat File.n Logged Columns >= 25 THEN e Mode := e CTRL_MODE_Passive; END_IF fb Ctrl Log Mat File( f Log Data := Logger Data, e Mode := e Mode, st Params :=st Params, e Error Id => e Error Id, b Error => b Error); f Max Buffer Usage := MAX(fb Ctrl Log Mat File.f Buffer Usage, f Max Buffer Usage); TF4100 Version: 2.2.4 131
## Page 132

PLC API 4.2.1.7 Output To Controlling Equipment 4.2.1.7.1 FB_CTRL_DEADBAND This function block provides a dead band for the input signal. If the input signal is within the dead band, this is indicated by the b In Is Under Threshold output. Description of the output behavior ì0.0:| fin|£ f Threshold fout =í îfin:else Inputs VAR_INPUT f In : FLOAT; END_VAR Name Type Description f In FLOAT Input value Outputs VAR_OUTPUT f Out : FLOAT; b In Is Under Threshold : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR 132 Version: 2.2.4 TF4100
## Page 133

PLC API Name Type Description f Out FLOAT Output of the function block b In Is Under BOOL A TRUE at this output indicates that the input value is within the dead Threshold band. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_DEADBAND_PARAMS; END_VAR Name Type Description st Params ST_CTRL_DEAD Parameter structure of the function block BAND_PARAMS st Params consists of the following elements: TYPE ST_CTRL_DEADBAND_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Threshold : FLOAT; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Threshold FLOAT The function block's dead band, see diagram. 4.2.1.7.2 FB_CTRL_LIMITER This function block limits an input signal to a parameterizable interval. TF4100 Version: 2.2.4 133
## Page 134

PLC API Description of the output behavior Inputs VAR_INPUT f In : FLOAT; END_VAR Name Type Description f In FLOAT Input value for the function block Outputs AR_OUTPUT f Out : FLOAT; b Min Limit : BOOL; b Max Limit : BOOL; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the function block b Min Limit BOOL A TRUE at this output indicates that the output has reached the lower limit. b Max Limit BOOL A TRUE at this output indicates that the output has reached the upper limit. e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_LIMITER_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the function block LIMITER_ PARAMS st Params consists of the following elements: 134 Version: 2.2.4 TF4100
## Page 135

PLC API TYPE ST_CTRL_LIMITER_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f Min Output : FLOAT; f Max Output : FLOAT; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f Min Output FLOAT Lower limit to which the output is restricted. f Max Output FLOAT Upper limit to which the output is restricted. 4.2.1.7.3 FB_CTRL_MULTIPLE_PWM_OUT This function block creates PWM modulated output signals from a number of input signals in such a way that the temporal relationships between the output signals are arranged so that as few outputs as possible are switched on at any one time. This temporal arrangement reduces the maximum power necessary required for the actuators. Both the minimum switch-on time and the minimum switch-off time can be parameterized, in addition to the mark-to-space ratio, in this extended function block. TF4100 Version: 2.2.4 135
## Page 136

PLC API Description of the output behavior 1 136 Version: 2.2.4 TF4100
## Page 137

PLC API Description of the output behavior 2 The programmer must create the following arrays in the PLC if this function block is to be used: a Pwm Input : ARRAY[1..n Num Pwm Out] OF FLOAT; a St Wait Times Config : ARRAY[1..n Num Pwm Out] OF ST_CTRL_MULTIPLE_PWM_OUT_TIMES; a St Pwm Outputs : ARRAY[1.. n Num Pwm Out] OF ST_CTRL_MULTIPLE_PWM_OUT_OUTPUTS; a St Pwm Data Vars : ARRAY[1.. n Num Pwm Out] OF ST_CTRL_MULTIPLE_PWM_OUT_DATA; The input values for the individual channels of the PWM function block are written into the ar_f Pwm Input array. The programmer can specify the parameterizable times for the individual channels in the ar_st Wait Times Config array. The function block writes the output bits into the ar_st Pwm Outputs array. The internal data required by the function block is stored in the ar_st Pwm Data Vars array. Under no circumstances should the structures contained in the array ar_st Pwm Data Vars be changed within the PLC program. This procedure is also illustrated in the sample program listed below. Inputs VAR_INPUT e Mode : E_CTRL_MODE; END_VAR Name Type Description e Mode E_CTRL_MODE Input that specifies the operation mode of the function block. Outputs VAR_OUTPUT e State : E_CTRL_STATE; b Error : BOOL; e Error Id : E_CTRL_ERRORCODES; END_VAR TF4100 Version: 2.2.4 137
## Page 138

PLC API Name Type Description e State E_CTRL_STATE State of the function block b Error BOOL Supplies the error number [} 173] when the output b Error is set. e Error Id E_CTRL_ERROR Becomes TRUE, as soon as an error occurs. CODES Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PWM_OUT_EXT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PWM_ Parameter structure of the PWM element OUT_EXT_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_MULTIPLE_PWM_OUT_PARAMS : STRUCT t Task Cycle Time : TIME; t PWMPeriod : TIME; n Number Of Pwm Outputs : USINT; p Pwm Input Array_ADR : POINTER TO FLOAT := 0; n Pwm Input Array_SIZEOF : UINT; p Pwm Times Config_ADR : POINTER TO ST_CTRL_MULTIPLE_PWM_OUT_TIMES; n Pwm Times Config_SIZEOF : UINT; p Pwm Output Array_ADR : POINTER TO ST_CTRL_MULTIPLE_PWM_OUT_OUTPUTS; n Pwm Output Array_SIZEOF : UINT; p Pwm Data_ADR : POINTER TO ST_CTRL_MULTIPLE_PWM_OUT_DATA; n Pwm Data_SIZEOF : UINT; END_STRUCT END_TYPE 138 Version: 2.2.4 TF4100
## Page 139

PLC API Name Type Description t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t PWMPeriod TIME Period of the PWM signal n Number Of Pwm USINT Number of PWM outputs. [1...n] Outputs p Pwm Input Array POINTER TO Address of the PWM input array _ADR FLOAT n Pwm Input Array UINT Size of the PWM input array in bytes _SIZEOF p Pwm Times Confi POINTER TO Address of the PWM times array g_ADR ST_CTRL_ MULTIPLE_PWM _OUT_TIMES n Pwm Times Confi UINT Size of the PWM times array in bytes g_SIZEOF p Pwm Output Arra POINTER TO Address of the PWM output array y_ADR ST_CTRL_ MULTIPLE_PWM _OUT_OUTPUTS n Pwm Output Arra UINT Size of the PWM output array in bytes y_SIZEOF p Pwm Data_ADR POINTER TO Address of the internal PWM data array ST_CTRL_ MULTIPLE_PWM _OUT_DATA n Pwm Data_SIZE UINT Size of the internal PWM data array in bytes OF TYPE ST_CTRL_MULTIPLE_PWM_OUT_TIMES : STRUCT t Min On Time : TIME; t Min Off Time : TIME; t Min Wait Time : TIME; END_STRUCT END_TYPE Name Type Description t Min On Time TIME Minimum switch-on time of the PWM output t Min Off Time TIME Minimum switch-off time of the PWM output t Min Wait Time TIME Waiting time between the switching actions between a positive and negative output signal TYPE ST_CTRL_MULTIPLE_PWM_OUT_OUTPUTS : STRUCT b Pwm Out Bit Pos : BOOL; b Pwm Out Bit Neg : BOOL; b Wait Time Active : BOOL; END_STRUCT END_TYPE Name Type Description b Pwm Out Bit BOOL PWM signal, when f Pwm Input > 0.0 Pos b Pwm Out Bit BOOL PWM signal, when f Pwm Input < 0.0 Neg b Wait Time BOOL A TRUE at this output indicates that the waiting time between the Active switching actions of the output signals is active. This output can be used to hold an I component that may be present in the prior controller constant during this time. TF4100 Version: 2.2.4 139
## Page 140

PLC API TYPE ST_CTRL_MULTIPLE_PWM_OUT_DATA : STRUCT Internal structure. This must not be written to. END_STRUCT END_TYPE 4.2.1.7.4 FB_CTRL_PWM_OUT This function block creates a PWM modulated signal on the basis of the input signal. Description of the output behavior This function block creates a PWM signal at the outputs with a mark-to-space ratio corresponding to the f Pwm Input input. The mark-to-space ratio is specified at the input in %; the range from -100% to 100% is available. If a positive value is specified, the pulse width modulated signal is made available at the b Pwm Out Bit Pos output. If the specified mark-to-space ratio is negative, the signal is output at b Pwm Out Bit Neg. These two signals therefore make it possible to control two different actuators, depending on the arithmetic sign. If the b Instant PWMUpdate is set to TRUE it is possible to adopt a new input value instantly. The new input value, in other words, is effective even in the current PWM cycle. If this parameter is FALSE, then a new input value is only adopted at the start of a new PWM cycle. Inputs VAR_INPUT f Pwm Input : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Pwm Input FLOAT Input value e Mode E_CTRL_MODE Input that specifies the operation mode of the function block. 140 Version: 2.2.4 TF4100
## Page 141

PLC API Outputs VAR_OUTPUT b Pwm Out Bit Pos : BOOL; b Pwm Out Bit Neg : BOOL; e State : E_CTRL_STATE; b Error : BOOL; e Error Id : E_CTRL_ERRORCODES; END_VAR Name Type Description b Pwm Out Bit Pos BOOL PWM signal, when f Pwm Input > 0.0. b Pwm Out Bit Neg BOOL PWM signal, when f Pwm Input < 0.0. e State E_CTRL_STATE State of the function block b Error BOOL Supplies the error number [} 173] when the output b Error is set. e Error Id E_CTRL_ERROR Becomes TRUE, as soon as an error occurs. CODES Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PWM_OUT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PWM_ Parameter structure of the PWM element OUT_PARAMS st Params consists of the following elements: TYPE ST_CTRL_PWM_OUT_PARAMS: STRUCT t Task Cycle Time : TIME t PWMPeriod : TIME; b Instant PWMUpdate : BOOL; END_STRUCT END_TYPE Name Type Description t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t PWMPeriod TIME Period of the PWM signal b Instant PWMUpd BOOL If this flag is TRUE, then a new input value is immediately adopted, ate even in the present PWM cycle. 4.2.1.7.5 FB_CTRL_PWM_OUT_EXT This function block creates a PWM modulated signal on the basis of the input signal. Both the minimum switch-on time and the minimum switch-off time can be parameterized, in addition to the mark-to-space ratio, in this extended function block. TF4100 Version: 2.2.4 141
## Page 142

PLC API Description of the output behavior 1 142 Version: 2.2.4 TF4100
## Page 143

PLC API Description of the output behavior 2 Inputs VAR_INPUT f Pwm Input : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Pwm Input FLOAT Input value for the function block e Mode E_CTRL_MODE Input that specifies the operation mode of the function block. Outputs VAR_OUTPUT b Pwm Out Bit Pos : BOOL; b Pwm Out Bit Neg : BOOL; e State : E_CTRL_STATE; b Error : BOOL; e Error Id : E_CTRL_ERRORCODES; END_VAR TF4100 Version: 2.2.4 143
## Page 144

PLC API Name Type Description b Pwm Out Bit Pos BOOL PWM signal, when f Pwm Input > 0.0 b Pwm Out Bit Neg BOOL PWM signal, when f Pwm Input < 0.0 e State E_CTRL_STATE State of the function block b Error BOOL Supplies the error number [} 173] when the output b Error is set. e Error Id E_CTRL_ERROR Becomes TRUE, as soon as an error occurs. CODES Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_PWM_OUT_EXT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_PWM_ Parameter structure of the PWM element OUT_EXT_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_PWM_OUT_EXT_PARAMS : STRUCT t Task Cycle Time : TIME; t PWMPeriod : TIME; t Min On Time : TIME; t Min Off Time : TIME; t Min Wait Time : TIME; END_STRUCT END_TYPE Name Type Description t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t PWMPeriod TIME Period of the PWM signal t Min On Time TIME Minimum switch-on time t Min Off Time TIME Minimum switch-off time t Min Wait Time TIME Waiting time between the switching actions between a positive and negative output signal 4.2.1.7.6 FB_CTRL_SCALE This function block makes it possible to adjust the signal in a linear manner between two value ranges. Inputs VAR_INPUT f In : FLOAT; END_VAR Name Type Description f In FLOAT Input value for the function block 144 Version: 2.2.4 TF4100
## Page 145

PLC API Outputs VAR_OUTPUT f Out : FLOAT; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Scaled output value e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_SCALE_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the function block SCALE_PARAMS st Params consists of the following elements: TYPE ST_CTRL_SCALE_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; f In Min : FLOAT; f In Max : FLOAT; f Out Min : FLOAT; f Out Max : FLOAT; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. f In Min FLOAT Minimum of the input value f In Max FLOAT Maximum of the input value f Out Min FLOAT Minimum of the output value f Out Max FLOAT Maximum of the output value 4.2.1.7.7 FB_CTRL_SERVO_MOTOR_OUT TF4100 Version: 2.2.4 145
## Page 146

PLC API This function block generates pulses with which a servomotor can be driven to a defined position. Behavior of the output Inputs VAR_INPUT f In : FLOAT; b Upper Limit Switch : BOOL; b Lower Limit Switch : BOOL; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Control value of the controller over the range f Ctrl Out Min ... f Ctrl Out Max] (controller output). b Upper Limit BOOL Limit switch: TRUE if the upper stop has been reached. Switch b Lower Limit BOOL Limit switch: TRUE if the lower stop has been reached. Switch f Man Sync Value FLOAT Input with which the internal state of the current motor setting can be adjusted, or whose value is adopted in manual mode. b Sync BOOL With a rising edge at this input the internal motor position, which must correspond to the actual motor position, is set to the value "f Man Sync Value". e Mode E_CTRL_ Input that specifies the operation mode [} 173] of the function block. MODE 146 Version: 2.2.4 TF4100
## Page 147

PLC API For synchronization with the current valve position, this function block has the mode e CTRL_MODE_SYNC_MOVEMENT. In this mode, the output for closing the valve is set until the valve is closed safely. The function block is then synchronized with this valve position. Once the synchronization process is completed, e CTRL_STATE_ACTIVE mode is automatically activated. Outputs VAR_OUTPUT b Out Bit Pos : BOOL; b Out Bit Neg : BOOL; f Actual State : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description b Out Bit Pos BOOL Output required to drive the motor in a positive direction. b Out Bit Neg BOOL Output required to drive the motor in a negative direction. f Actual State FLOAT Current motor position in the range [f Ctrl Out Min ... f Ctrl Out Max] in which the motor is currently located. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_SERVO_MOTOR_OUT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_ Parameter structure of the function block SERVO_MOTOR_ OUT_PARAMS st Params consists of the following elements: TYPE ST_CTRL_SERVO_MOTOR_OUT_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; t Moving Time : TIME; t Signal Extension : TIME; t Additional Move Time At Limits : TIME; t Min Wait Time Between Direction Change : TIME; t Minimum Pulse Time : TIME; b Move On Limit Switch : BOOL; b Stop Additional Move Time If Input Value Is Changed : BOOL; f Ctrl Out Max : FLOAT := 100.0; f Ctrl Out Min : FLOAT := 0.0; END_STRUCT END_TYPE TF4100 Version: 2.2.4 147
## Page 148

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t Moving Time TIME The time required to move the actuator from one stop to the other. t Signal Extension TIME Signal extension by which each output pulse is extended in order to compensate for the dead time. t Additional Move T TIME Supplementary signal extension, output to reliably reach the limits ime At Limits when the actuator is to be driven to +/-100%. Only effective if b Move On Limit Switch is FALSE. t Min Wait Time TIME Minimum waiting time between positive and negative output pulses Between Direction Change t Minimum Pulse TIME Minimum length of an output pulse Time b Move On Limit BOOL If TRUE, then when the control value is either f Ctrl Out Min or Switch f Ctrl Out Max a signal will continue to be output until the corresponding limit switch is reached. b Stop Additional M BOOL If this flag is TRUE, movement of the valve to the end position, which ove Time If is triggered by "Additional Moving Time At Limits", is stopped, if an Input Value Is input value is specified that does not match the end position. If this Changed flag is FALSE and the input value matches an end position, the valve always safely moves to the end position first, before it can move to a different valve position. f Ctrl Out Max FLOAT Control value for which the valve will be driven to 100%. f Ctrl Out Min FLOAT Control value for which the valve will be driven to 0%. 4.2.1.7.8 FB_CTRL_SPLITRANGE This function block divides an input signal into positive and negative components. The parameters b Disable Pos Out and b Disable Neg Out can be used to deactivate the positive or negative output → heating mode only during the winter, cooling mode only during the summer. The b Invert Neg Output parameter allows the negative output to be inverted. 148 Version: 2.2.4 TF4100
## Page 149

PLC API Description of the output behavior Inputs VAR_INPUT f In : FLOAT; END_VAR Name Type Description f In FLOAT Input value for the function block Outputs VAR_OUTPUT f Out Pos : FLOAT; f Out Neg : FLOAT; b Out Pos Is Active : BOOL; b Out Neg Is Active : BOOL; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR TF4100 Version: 2.2.4 149
## Page 150

PLC API Name Type Description f Out Pos FLOAT Positive part of f In f Out Neg FLOAT Negative part of f In b Out Pos Is Active BOOL TRUE indicates "f In > 0.0" b Out Neg Is Active BOOL TRUE indicates "f In < 0.0" e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_SPLITRANGE_PARAMS; END_VAR Name Type Description st Params ST_CTRL_SPLIT Parameter structure of the function block RANGE_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_SPLITRANGE_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; b Invert Neg Output : BOOL; b Disable Pos Out : BOOL; b Disable Neg Out : BOOL; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. b Invert Neg Outpu BOOL f Out Neg is inverted when this parameter is TRUE. t b Disable Pos Out BOOL The output f Out Pos is disabled and always "0.0“. b Disable Neg Out BOOL The output f Out Neg is disabled and always "0.0“. 4.2.1.7.9 FB_CTRL_STEPPING_MOTOR_OUT This function block generates a control value for a stepper motor. 150 Version: 2.2.4 TF4100
## Page 151

PLC API Behavior of the output Inputs VAR_INPUT f In : FLOAT; b Upper Limit Switch : BOOL; b Lower Limit Switch : BOOL; f Man Sync Value : FLOAT; b Sync : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f In FLOAT Controller's control value (controller output) b Upper Limit BOOL Limit switch, becomes TRUE when the upper stop is reached. Switch b Lower Limit BOOL Limit switch, becomes TRUE when the lower stop is reached. Switch f Man Sync Value FLOAT Input with which the internal state of the motor setting can be adjusted, or whose value is adopted in manual mode. b Sync BOOL With a rising edge at this input the internal step counter is set to the step that corresponds to the value "f Man Sync Value". e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. For synchronization with the current valve position, this function block has the mode e CTRL_MODE_SYNC_MOVEMENT. In this mode, pulses for closing the valve are output until the valve is safely closed. The function block is then synchronized with this valve position. Once the synchronization process is completed, e CTRL_STATE_ACTIVE mode is automatically activated. TF4100 Version: 2.2.4 151
## Page 152

PLC API Outputs VAR_OUTPUT b Out Bit Pos : BOOL; b Out Bit Neg : BOOL; n Actual Step : DINT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description b Out Bit Pos BOOL Output required to drive the motor in a positive direction. b Out Bit Neg BOOL Output required to drive the motor in a negative direction. n Actual Step DINT Actual step at which the motor is positioned. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_STEPPING_MOTOR_OUT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_STEPP Parameter structure of the function block ING_MOTOR_ OUT_PARAMS st Params consists of the following elements: TYPE ST_CTRL_STEPPING_MOTOR_OUT_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; t On Time : TIME; t Off Time : TIME; n Max Moving Pulses : DINT; n Min Moving Pulses : UINT := 0; b Hold With Output On : BOOL; n Additional Pulses At Limits : DINT; b Move On Limit Switch : BOOL; f Ctrl Out Max : FLOAT := 100.0; f Ctrl Out Min : FLOAT := 0.0; END_STRUCT END_TYPE 152 Version: 2.2.4 TF4100
## Page 153

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. t On Time TIME Pulse length t Off Time TIME Pause length n Max Moving DINT Max. number of pulses required to move from one limit to another. Pulses n Min Moving UINT Min. number of pulses required to move from one limit to another. Pulses b Hold With BOOL If this parameter is set to TRUE, then an output remains set when the Output On drive is stationary. This will result in braking. n Additional Pulse DINT Number of supplementary pulses that are output to reliably ensure s At Limits that limits are reached. b Move On Limit BOOL If this is TRUE, then pulses are output when the control value is either Switch 0% or 100% until the limit switch is reached. f Ctrl Out Max FLOAT Control value for which the valve will be driven to 100%. f Ctrl Out Min FLOAT Control value for which the valve will be driven to 0%. 4.2.1.8 Setpointgeneration 4.2.1.8.1 FB_CTRL_3PHASE_SETPOINT_GENERATOR This function block represents a 3-phase setpoint generator. Description This function block generates a 3-phase setpoint profile in which the acceleration has a rectangular curve. It is possible to specify a new parameter set while the generator is active. Depending on the specified type of parameter set, it is activated immediately: e New Parameter Type := e CTRL_NEW_PARAMETER_TYPE_Instant Alternatively, the current movement is first completed and then a new movement is started with the new parameter set: e New Pos Type := e CTRL_NEW_PARAMETER_TYPE_Not Instant NOTICE Overrunning the end position Specifying a new parameter set may mean that the previous end position is exceeded. See the sample. It is generally recommended that end position monitoring is included after the setpoint generator. TF4100 Version: 2.2.4 153
## Page 154

PLC API Inputs VAR_INPUT b Start : BOOL; b Stop : BOOL; b Reset : BOOL; f Override : LREAL; END_VAR Name Type Description b Start BOOL Setpoint generation begins when a positive edge appears at the b Start input, provided the generator is not already active and that the b Stop and b Reset inputs are FALSE. b Stop BOOL Generation of the setpoints is stopped by a positive edge at the b Stop input. Braking is carried out using the deceleration specified in the current parameter set, and any subsequent task that may be pending is deleted. b Reset BOOL Reset of the setpoint generator; any positioning operation that may be active is immediately aborted, the outputs f Set Velo and f Set Acc become 0.0, the set position is set to the start position and the internal states are deleted. f Override LREAL The set velocity can be scaled through an override in the range [ 0 .. 100.0 % ]. If the override is 100%, then the generated profile uses the set velocity as specified in the parameter set. The override implemented here does not scale the current runtime table when the override is changed. Instead, an internal restart instruction is generated having a different set velocity. The override has a resolution of 0.1%. Outputs VAR_OUTPUT f Set Pos : LREAL; f Set Velo : LREAL; f Set Acc : LREAL; n Set Direction : INT; b Command Buffered : BOOL; b Done : BOOL; b Command Aborted : BOOL; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR 154 Version: 2.2.4 TF4100
## Page 155

PLC API Name Type Description f Set Pos LREAL Set position f Set Velo LREAL Set velocity f Set Acc LREAL Set acceleration n Set Direction INT Direction of movement [-1, 0, 1], 1 --> movement direction is positive 0 --> generator is inactive 1 --> movement direction is negative b Command Buffer BOOL When this output is TRUE it indicates that a motion command is ed stored that will begin when the current order has completed. A saved order is deleted if the following special case is specified as a parameter set. f Acceleration := 0.0; f Deceleration := 0.0; f Start Pos := 0.0; f Start Velo := 0.0; f Target Pos := 0.0; f Target Velo := 0.0; f Velocity := 0.0; t Ctrl Cycle Time := T#0s; t Task Cycle Time := T#0s; e New Parameter Type := e CTRL _NEW_PARAMETER_TYPE_ Not Instant; b Done BOOL This output becomes TRUE when the movement has been completed and the target position has been reached. b Command BOOL This output becomes TRUE when the current movement is Aborted interrupted. This can be caused, for instance, through a rising edge at the b Stop input. e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE as soon as an error situation occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_3PHASE_SETPOINT_GENERATOR_PARAMS; END_VAR Name Type Description st Params ST_CTRL_3PHAS Parameter structure of the setpoint generator E_ SETPOINT_GEN ERATOR_PARAM S st Params consists of the following elements: TYPE ST_CTRL_RAMP_GENERATOR_PARAMS : STRUCT t Task Cycle Time : TIME; t Ctrl Cycle Time : TIME; f Start Pos : LREAL; f Start Velo : LREAL; f Velocity : LREAL; (* >= 0.0 *) f Target Pos : LREAL; f Target Velo : LREAL; f Acceleration : LREAL; (* > 0.0 *) f Deceleration : LREAL; (* > 0.0 *) e New Parameter Type : E_CTRL_NEW_PARAMETER_TYPE; EN_STRUCT END_TYPE TF4100 Version: 2.2.4 155
## Page 156

PLC API Name Type Description t Task Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Ctrl Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every task cycle this corresponds to the task cycle time of the calling task. f Start Pos LREAL Start position for the motion profile f Start Velo LREAL Start velocity for the motion profile f Velocity LREAL Velocity in units/second f Target Pos LREAL Target position of the motion profile f Target Velo LREAL Target velocity of the motion profile. Note: The target velocity is retained when the destination position has been reached (the b Done flag is set), but after this point the position is no longer calculated (constant position at velocity ≠ 0.0). f Acceleration LREAL Acceleration in units / second2 f Deceleration LREAL Deceleration in units / second2 e New Parameter T E_CTRL_NEW_ e CTRL_NEW_PARAMETER_TYPE_Instant ype PARAMETER_ and TYPE e CTRL_NEW_PARAMETER_TYPE_Not Instant Special characteristics for e New Parameter Type TYPE E_CTRL_NEW_PARAMETER_TYPE : ( e CTRL_NEW_PARAMETER_TYPE_Not Instant := 0, e CTRL_NEW_PARAMETER_TYPE_Instant := 1); END_TYPE e CTRL_NEW_PARAMETER_TYPE_Instant: When a restart instruction is issued with a new parameter set, this set is adopted immediately. In other words a transition from the current state of movement to the data represented by the new parameter set is calculated, and the old parameters are discarded. e CTRL_NEW_PARAMETER_TYPE_Not Instant: When a restart instruction is issued with a new parameter set, the new set is not adopted immediately. In other words the current movement is first executed to completion, after which positioning to the new destination is carried out with the new parameters. A TRUE at the b Command Buffered output indicates that a non-instantaneous restart instruction is stored. An order that has already been stored can be overwritten or deleted by a further new, non-instantaneous parameter set. 156 Version: 2.2.4 TF4100
## Page 157

PLC API Positioning examples TF4100 Version: 2.2.4 157
## Page 158

PLC API Positioning example 1: st Params.f Start Pos := -500.0; st Params.f Target Pos := 2500.0; st Params.f Start Velo := 0.0; st Params.f Velocity := 1000.0; st Params.f Target Velo := 0.0; st Params.f Acceleration := 1000.0; st Params.f Deceleration := 2000.0; f Override := 100.0; Positioning example 2: st Params.f Start Pos := 1000.0; st Params.f Target Pos := -2500.0; st Params.f Start Velo := 0.0; st Params.f Velocity := 1000.0; st Params.f Target Velo := 0.0; st Params.f Acceleration := 1000.0; st Params.f Deceleration := 2000.0; f Override := 100.0; 158 Version: 2.2.4 TF4100
## Page 159

PLC API Positioning example 3: st Params.f Start Pos := -500.0; st Params.f Target Pos := 2500.0; st Params.f Start Velo := 0.0; st Params.f Velocity := 1000.0; st Params.f Target Velo := 0.0; st Params.f Acceleration := 1000.0; st Params.f Deceleration := 2000.0; st Params.e New Parameter Type := e CTRL_NEW_PARAMETER_TYPE_Not Instant; f Override := 100.0; parameter change if f Set Pos > 1000.0, e New Pos Type := e CTRL_NEW_POS_TYPE_Not Instantst Params.f Target Pos := 0.0; st Params.f Start Velo := 0.0; st Params.f Velocity := 1300.0; st Params.f Target Velo := 0.0; st Params.f Acceleration := 1000.0; st Params.f Deceleration := 2000.0; f Override := 100.0; Positioning example 4: st Params.f Start Pos := -500.0; st Params.f Target Pos := 2500.0; st Params.f Start Velo := 0.0; st Params.f Velocity := 1000.0; st Params.f Target Velo := 0.0; st Params.f Acceleration := 1000.0; st Params.f Deceleration := 2000.0; st Params.e New Parameter Type := e CTRL_NEW_PARAMETER_TYPE_Not Instant; f Override := 100.0;parameter change if f Set Pos > 1000.0, e New Pos Type := e CTRL_NEW_POS_TYPE_Instantst Params.f Tar get Pos := 0.0; st Params.f Start Velo := 0.0; st Params.f Velocity := 1300.0; st Params.f Target Velo := 0.0; st Params.f Acceleration := 1000.0; st Params.f Deceleration := 2000.0; f Override := 100.0; TF4100 Version: 2.2.4 159
## Page 160

PLC API Positioning example 5: Start at point 1: st Params.f Start Pos := -100.0; st Params.f Target Pos := 200.0; st Params.f Start Velo := 0.0; st Params.f Velocity := 250.0; st Params.f Target Velo := 150.0; st Params.f Acceleration := 500.0; st Params.f Deceleration := 400.0; st Params.e New Parameter Type := e CTRL_NEW_PARAMETER_TYPE_Instant Resta rt at point 2: st Params.f Target Pos := 400.0; st Params.e New Parameter Type := e CTRL_NEW_PARAMETER_TYPE_Not Instant;R estart at point 3: st Params.f Target Pos := 200.0; st Params.e New Parameter Type := e CTRL_NEW_PARAMETER_TYPE_Not Instant;R estart at point 4: st Params.f Target Pos := 600.0; st Params.f Target Velo := 0.0; st Params.e New Parameter Type := e CTRL_NEW_PARAMETER_TYPE_Not Instant; 160 Version: 2.2.4 TF4100
## Page 161

PLC API NOTICE Target position overshoot! If a new parameter set of type "e CTRL_NEW_POS_TYPE_Instant" in which the deceleration is reduced is given to the function block it is possible that the old target position will be exceeded. Sample: st Params.f Target Pos := 1000.0; st Params.f Start Pos := 0.0; st Params.f Velocity := 500.0; st Params.f Acceleration := 1000.0; st Params.f Deceleration := 1000.0; IF f Set Pos > 800.0 THEN st Params.f Target Pos := 400.0; st Params.f Velocity := 500.0; st Params.f Acceleration := 1_000.0; st Params.f Deceleration := 500.0; st Params.e New Pos Type := e CTRL_NEW_POS_TYPE_Instant; END_IF TF4100 Version: 2.2.4 161
## Page 162

PLC API It can clearly be seen in the following scope trace that the original target position of 1000 mm is exceeded, the reason being that the new parameter set had a reduced deceleration. 4.2.1.8.2 FB_CTRL_FLOW_TEMP_SETPOINT_GEN This function block enables specification of a flow temperature depending on the outdoor temperature. Description The setpoint for the flow temperature (f Out) is determined from the ambient temperature (f Ambient Temperature). A straight line that can be moved via an offset (f Offset Temperature) is used for this purpose. The slope is determined based on the specified ambient and flow temperature corners. A flag (b Limit Flow Temp) is used to specify whether or not the flow temperature is restricted to its limit values. The offset temperature can be used to realize a night setback or pre-control. 162 Version: 2.2.4 TF4100
## Page 163

PLC API Behavior of the output value Inputs VAR_INPUT f Ambient Temperature : FLOAT; f Offset Temperature : FLOAT; b Limit Flow Temp : BOOL; END_VAR Name Type Description f Ambient FLOAT Start of ramp generation Temperature f Offset FLOAT Start value of the ramp Temperature b Limit Flow Temp BOOL Target value of the ramp Outputs VAR_OUTPUT f Out : FLOAT; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Setpoint of the flow temperature e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE as soon as an error situation occurs. TF4100 Version: 2.2.4 163
## Page 164

PLC API Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_FLOW_TEMP_SETPOINT_GEN_PARAMS; END_VAR Name Type Description st Params ST_CTRL_FLOW Parameter structure of the ramp generator _TEMP_ SETPOINT_GEN_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_FLOW_TEMP_SETPOINT_GEN_PARAMS: STRUCT t Task Cycle Time : TIME; t Ctrl Cycle Time : TIME; f Fore Run Temp Max : FLOAT; f Fore Run Temp Min : FLOAT; f Ambient Temp Max : FLOAT; f Ambient Temp Min : FLOAT; END_STRUCT END_TYPE Name Type Description t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every task cycle this corresponds to the task cycle time of the calling task. t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. f Fore Run Temp M FLOAT Maximum flow temperature (see diagram) ax f Fore Run Temp Mi FLOAT Minimum flow temperature (see diagram) n f Ambient Temp FLOAT outdoor temperature for which the minimum flow temperature is Max specified. f Ambient Temp FLOAT outdoor temperature for which the maximum flow temperature is Min specified. 4.2.1.8.3 FB_CTRL_RAMP_GENERATOR The function block provides a parameterizable ramp generator. Description This function block generates a ramp connecting the starting value f Start and the target value f Target. The slope of the ramp (i.e. the velocity) is given in units/s by means of the f Velo Pos and f Velo Neg parameters. The starting value is adopted when a rising edge appears at b Enable; calculation of the ramp then begins. As long as the signal b Enable remains TRUE the target value can be changed, and the output value changes, taking the form of a ramp as it moves from the current value to the presently active target value. 164 Version: 2.2.4 TF4100
## Page 165

PLC API Behavior of the output value Inputs VAR_INPUT b Enable : BOOL; f Start : FLOAT; f Target : FLOAT; END_VAR Name Type Description b Enable BOOL Start of ramp generation f Start FLOAT Start value of the ramp f Target FLOAT Target value of the ramp Outputs VAR_OUTPUT f Out : FLOAT; f Velo Out : FLOAT; b Value Reached : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the ramp generator f Velo Out FLOAT Current velocity of the ramp generator b Value Reached BOOL This output indicates by going TRUE that the output f Out has reached the value f Target. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ Supplies the error number [} 173] when the output b Error is set. ERRORCODES b Error BOOL Becomes TRUE as soon as an error situation occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_RAMP_GENERATOR_PARAMS END_VAR TF4100 Version: 2.2.4 165
## Page 166

PLC API Name Type Description st Params ST_CTRL_RAMP Parameter structure of the ramp generator _GENERATOR_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_RAMP_GENERATOR_PARAMS : STRUCT t Task Cycle Time : TIME; t Ctrl Cycle Time : TIME; f Velo Pos : FLOAT; f Velo Neg : FLOAT; END_STRUCT END_TYPE Name Type Description t Task Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Ctrl Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every task cycle this corresponds to the task cycle time of the calling task. f Velo Pos FLOAT Velocity in unit/s, with which the output is changed from a lower value to a higher one. f Velo Neg FLOAT Velocity in unit/s, with which the output is changed from a higher value to a lower one. 4.2.1.8.4 FB_CTRL_RAMP_GENERATOR_EXT This function block represents a parameterizable ramp generator. In contrast to FB_CTRL_RAMP_GENERATOR it supports E_CTRL_MODE. Description: This function block generates a ramp connecting the starting value f Start Value and the target value f Target Value. The slope of the ramp (i.e. the velocity) is given in units/s by means of the f Velo Pos and f Velo Neg parameters. The start value is adopted when e CTRL_MODE_RESET changes to e CTRL_MODE_ACTIVE, and calculation of the ramp begins. As long as the function block remains in e CTRL_MODE_ACTIVE the target value can be changed, and the output value changes, taking the form of a ramp as it moves from the current value to the presently active target value. The current velocity is output at f Velo Out. It is possible to use this for feed forward in the control loop. 166 Version: 2.2.4 TF4100
## Page 167

PLC API Behavior of the output value Inputs VAR_INPUT f Start Value : FLOAT; f Target Value : FLOAT; f Man Value : FLOAT; b Hold : BOOL; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Start Value FLOAT Start value of the ramp f Target Value FLOAT Target value of the ramp f Man Value FLOAT Input value to which the output in e CTRL_MODE_MANUAL is set. b Hold BOOL Calculation of the ramp is halted at the current value. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : FLOAT; f Velo Out : FLOAT; b Value Reached : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR TF4100 Version: 2.2.4 167
## Page 168

PLC API Name Type Description f Out FLOAT Output of the ramp generator f Velo Out FLOAT Current velocity of the ramp generator b Value Reached BOOL This output indicates by going TRUE that the output f Out has reached the value "f Target Value". e State E_CTRL_ State of the function block STATE e Error Id E_CTRL_ Supplies the error number [} 173] when the output b Error is set. ERRORCODES b Error BOOL Becomes TRUE as soon as an error situation occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_RAMP_GENERATOR_EXT_PARAMS; END_VAR Name Type Description st Params ST_CTRL_RAMP Parameter structure of the ramp generator _GENERATOR_E XT_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_RAMP_GENERATOR_EXT_PARAMS : STRUCT t Task Cycle Time : TIME; t Ctrl Cycle Time : TIME; f Velo Pos : FLOAT; f Velo Neg : FLOAT; END_STRUCT END_TYPE Name Type Description t Task Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Ctrl Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every task cycle this corresponds to the task cycle time of the calling task. f Velo Pos FLOAT Velocity (>0.0) in unit/s, with which the output is changed from a lower value to a higher one. f Velo Neg FLOAT Velocity (>0.0) in unit/s, with which the output is changed from a higher value to a lower one. 4.2.1.8.5 FB_CTRL_SETPOINT_GENERATOR The function block provides a setpoint generator that outputs the setpoint selected from a table. Changing from one setpoint to another can be implemented continuously or discontinuously. 168 Version: 2.2.4 TF4100
## Page 169

PLC API Behavior of the output value Example table: Index 1 12 2 42 3 25 … 73 Description The individual setpoints are stored in the array. The array must be made known to the function block through the appropriate parameters. One of the setpoints stored in the table is selected by means of the n Setpoint Index input. This is then made available at the output, and can be used as the setpoint for the controller. Changing from one value to another can be implemented in a linear fashion or as a jump. The velocity of a continuous transition is specified by the f Velo Pos and f Velo Neg parameters. The b Value Reached output indicates that the chosen setpoint has been reached. Inputs VAR_INPUT n Setpoint Index : INT; f Man Value : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description n Setpoint Index INT Index of the selected setpoint f Man Value FLOAT Input whose value is output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. TF4100 Version: 2.2.4 169
## Page 170

PLC API Outputs VAR_OUTPUT f Out : SETPOINT_TABLE_ELEMENT; b Value Reached : BOOL; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out SETPOINT_ Output of the setpoint generator TABLE_ELEMEN T b Value Reached BOOL The output is TRUE when the selected setpoint has been reached, i.e. the ramp leading to the selected value has finished. e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_SETPOINT_GENERATOR_PARAMS; END_VAR Name Type Description st Params ST_CTRL_SETP Parameter structure of the ramp generator OINT_ GENERATOR_ PARAMS st Params consists of the following elements: TYPE ST_CTRL_SETPOINT_GENERATOR_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; p Data Table_ADR : POINTER TO INTERPOLATION_TABLE_ELEMENT := 0; n Data Table_SIZEOF : UINT := 0; n Data Table_Number Of Rows : UINT := 0; f Velo Pos : FLOAT; f Velo Neg : FLOAT; b Disable Ramping : BOOL := FALSE; END_STRUCT END_TYPE 170 Version: 2.2.4 TF4100
## Page 171

PLC API Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. Indent: -103; margin-left: 108"> t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. p Data Table_ADR POINTER TO Address of the data array INTERPOLATION _ TABLE_ELEMEN T n Data Table_SIZ UINT Size of the data array EOF n Data Table_Num UINT Number of rows in the data array ber Of Rows f Velo Pos FLOAT Velocity in unit/s, with which the output is changed from a lower value to a higher one. f Velo Neg FLOAT Velocity in unit/s, with which the output is changed from a higher value to a lower one. b Disable Rampin BOOL A continuous output value is not calculated if this parameter is TRUE. g There is a step change between the output values. 4.2.1.8.6 FB_CTRL_SIGNAL_GENERATOR The function block provides a signal generator offering triangular, sine and sawtooth signal forms. TF4100 Version: 2.2.4 171
## Page 172

PLC API Output signals Inputs VAR_INPUT f Man Value : FLOAT; e Mode : E_CTRL_MODE; END_VAR Name Type Description f Man Value FLOAT Input whose value is present at the output in manual mode. e Mode E_CTRL_MODE Input that specifies the operation mode [} 173] of the function block. Outputs VAR_OUTPUT f Out : FLOAT; e State : E_CTRL_STATE; e Error Id : E_CTRL_ERRORCODES; b Error : BOOL; END_VAR Name Type Description f Out FLOAT Output of the signal generator e State E_CTRL_STATE State of the function block e Error Id E_CTRL_ERROR Supplies the error number [} 173] when the output b Error is set. CODES b Error BOOL Becomes TRUE, as soon as an error occurs. Inputs/ outputs VAR_IN_OUT st Params : ST_CTRL_SIGNAL_GENERATOR_PARAMS; END_VAR Name Type Description st Params ST_CTRL_SIGNA Parameter structure of the function block L_ GENERATOR_PA RAMS 172 Version: 2.2.4 TF4100
## Page 173

PLC API st Params consists of the following elements: TYPE ST_CTRL_SIGNAL_GENERATOR_PARAMS: STRUCT t Ctrl Cycle Time : TIME := T#0ms; t Task Cycle Time : TIME := T#0ms; e Signal Type : E_CTRL_SIGNAL_TYPE; t Cylce Duration : TIME; f Amplitude : FLOAT; f Offset : FLOAT := 0.0; t Start : TIME := T#0s; END_STRUCT END_TYPE Name Type Description t Ctrl Cycle Time TIME Cycle time with which the control loop is processed. This must be greater than or equal to the Task Cycle Time. The function block uses this input value to calculate internally whether the state and the output values have to be updated in the current cycle. t Task Cycle Time TIME Cycle time with which the function block is called. If the function block is called in every cycle this corresponds to the task cycle time of the calling task. e Signal Type E_CTRL_ Selection of the type of signal. SIGNAL_TYPE TYPE E_CTRL_SIGNAL_TYPE : ( e CTRL_TRIANGLE := 0, e CTRL_SINUS := 1, e CTRL_SAWTOOTH := 2 ); END_TYPE t Cylce Duration TIME Period of the generated signal curve f Amplitude FLOAT Amplitude of the generated signal curve f Offset FLOAT Offset to be added to the signal curve t Start TIME The moment of time within a period at which following the signal curve will begin when switching into e CTRL_MODE_ACTIVE occurs. 4.2.2 Global Constants 4.2.2.1 Library version All libraries have a specific version. This version is shown in the PLC library repository too. A global constant contains the library version information: Global_Version VAR_GLOBAL CONSTANT st Lib Version_Tc2_Controller Toolbox : ST_Lib Version; END_VAR ST_Lib Version To compare the existing version to a required version the function F_Cmp Lib Version (defined in Tc2_System library) is offered. Obsolete Functions All other possibilities known from Twin CAT2 libraries to query a library version are obsolete! 4.2.3 Data Structures 4.2.3.1 Definition of the structures and enums This appendix describes all the structures and enums used in the Twin CAT controller toolbox. TF4100 Version: 2.2.4 173
## Page 174

PLC API FLOAT: The function blocks of the library only work with the data type FLOAT. This data type is defined as LREAL or as REAL in a supplementary library. On a PC system the additional library "Tc Float PC.lib" is automatically integrated. TYPE FLOAT : LREAL; END_TYPE E_CTRL_MODE TYPE E_CTRL_MODE : ( e CTRL_MODE_IDLE := 0, e CTRL_MODE_PASSIVE := 1, e CTRL_MODE_ACTIVE := 2, e CTRL_MODE_RESET := 3, e CTRL_MODE_MANUAL := 4, e CTRL_MODE_TUNE := 5, e CTRL_MODE_SELFTEST := 6, e CTRL_MODE_SYNC_MOVEMENT := 7 ) END_TYPE E_CTRL_STATE TYPE E_CTRL_STATE : ( e CTRL_STATE_IDLE := 0, e CTRL_STATE_PASSIVE := 1, e CTRL_STATE_ACTIVE := 2, e CTRL_STATE_RESET := 3, e CTRL_STATE_MANUAL := 4, e CTRL_STATE_TUNING := 5, e CTRL_STATE_TUNED := 6, e CTRL_STATE_SELFTEST := 7, e CTRL_STATE_ERROR := 8, e CTRL_STATE_SYNC_MOVEMENT := 9 ); END_TYPE E_CTRL_ERRORCODES: TYPE E_CTRL_ERRORCODES : ( e CTRL_ERROR_NOERROR := 0, (* no error *) e CTRL_ERROR_INVALIDTASKCYCLETIME := 1, (* invalid task cycle time *) e CTRL_ERROR_INVALIDCTRLCYCLETIME := 2, (* invalid ctrl cycle time *) e CTRL_ERROR_INVALIDPARAM := 3, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Tv := 4, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Td := 5, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Tn := 6, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Ti := 7, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Hystereisis Range := 8, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Pos Out On_Off := 9, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Neg Out On_Off := 10, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Table Description := 11, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Table Data := 12, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Data Table ADR := 13, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_T0 := 14, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_T1 := 15, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_T2 := 16, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_T3 := 17, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Theta := 18, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Order := 19, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Tt := 20, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Tu := 21, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Tg := 22, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_infinite_slope := 23, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Max Is Less Thanf Min := 24, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Out Max Limit Is Less Thanf Out Min Limit := 25, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Outer Window := 26, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Inner Window := 27, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Outer Window Is Less Thanf Inner Window := 28, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Dead Band Input := 29, (* invalid parameter *) 174 Version: 2.2.4 TF4100
## Page 175

PLC API e CTRL_ERROR_INVALIDPARAM_f Dead Band Output := 30, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_PWM_Cycletime := 31, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_no_Parameterset := 32, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Out On := 33, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Out Off := 34, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Gain := 35, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Offset := 36, (* invalid parameter *) e CTRL_ERROR_MODE_NOT_SUPPORTED := 37, (* invalid mode: mode not supported *) e CTRL_ERROR_INVALIDPARAM_Tv_heating := 38, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Td_heating := 39, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Tn_heating := 40, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Tv_cooling := 41, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Td_cooling := 42, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Tn_cooling := 43, (* invalid parameter *) e CTRL_ERROR_RANGE_NOT_SUPPORTED := 44, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Parameter Change Cycle Ticks := 45, (* invalid parameter *) e CTRL_ERROR_Parameter Estimation Failed := 46, (* invalid parameter *) e CTRL_ERROR_Noise Level To High := 47, (* invalid parameter *) e CTRL_ERROR_INTERNAL_ERROR_0 := 48, (* internal error *) e CTRL_ERROR_INTERNAL_ERROR_1 := 49, (* internal error *) e CTRL_ERROR_INTERNAL_ERROR_2 := 50, (* internal error *) e CTRL_ERROR_INTERNAL_ERROR_3 := 51, (* internal error *) e CTRL_ERROR_INTERNAL_ERROR_4 := 52, (* internal error *) e CTRL_ERROR_INTERNAL_ERROR_5 := 53, (* internal error *) e CTRL_ERROR_INTERNAL_ERROR_6 := 54, (* internal error *) e CTRL_ERROR_INTERNAL_ERROR_7 := 55, (* internal error *) e CTRL_ERROR_INTERNAL_ERROR_8 := 56, (* internal error *) e CTRL_ERROR_INTERNAL_ERROR_9 := 57, (* internal error *) e CTRL_ERROR_INVALIDPARAM_Work Array ADR := 58, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_t On Tiime := 59, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_t Off Tiime := 60, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Max Moving Pulses := 61, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Additional Pulses At Limits := 62, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Ctrl Out Max_Min := 63, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Delta Max := 64, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_t Moving Time := 65, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_t Dead Time := 66, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_t Additional Move Time At Limits := 67, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Threshold := 68, (* invalid parameter *) e CTRL_ERROR_MEMCPY := 69, (* MEMCPY failed *) e CTRL_ERROR_MEMSET := 70, (* MEMSET failed *) e CTRL_ERROR_INVALIDPARAM_n Number Of Columns := 71, (* invalid parameter *) e CTRL_ERROR_File Close := 72, (* File Close failed *) e CTRL_ERROR_File Open := 73, (* File Open failed *) e CTRL_ERROR_File Write := 74, (* File Write failed *) e CTRL_ERROR_INVALIDPARAM_f Velo Neg := 75, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Velo Pos := 76, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Dead Band Input := 77, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Dead Band Output := 78, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Cycle Duration := 79, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_t Start := 80, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Step Heigth Tuning To Low := 81, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Min Limit Is Less Than Zero := 82, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Max Limit Is Greater Than100 := 83, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Step Size := 84, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Ok Range Is Less Or Equal Zero := 85, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Force Range Is Less Or Equalf Ok Range := 86, (* invalid parameter *) e CTRL_ERROR_INVALIDPWMPeriod := 87, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_t Minimum Pulse Time := 88, (* invalid parameter *) e CTRL_ERROR_File Delete := 89, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Number Of Pwm Outputs := 90, (* File Delete failed *) e CTRL_ERROR_INVALIDPARAM_n Pwm Input Array_SIZEOF := 91, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Pwm Output Array_SIZEOF := 92, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Pwm Wait Times Config_SIZEOF := 93, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Pwm Internal Data_SIZEOF := 94, (* invalid parameter *) e CTRL_ERROR_SIZEOF := 95, (* SIZEOF failed *) e CTRL_ERROR_INVALIDPARAM_n Order Of The Transferfunction := 96, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Numerator Array_SIZEOF := 97, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Denominator Array_SIZEOF := 98, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_a_n_Is Zero := 99, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Work Array SIZEOF := 100, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_MOVINGRANGE_MIN_MAX := 101, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_MOVINGTIME := 102, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_DEADTIME := 103, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Min Limit Is Greater Thanf Max Limit := 104, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Data Table SIZEOF := 105, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Output Vector Description := 106, (* invalid parameter *) e CTRL_ERROR_Task Cycle Time Changed := 107, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Min Moving Pulses := 108, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Acceleration := 109, (* invalid parameter *) TF4100 Version: 2.2.4 175
## Page 176

PLC API e CTRL_ERROR_INVALIDPARAM_f Deceleration := 110, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Start And Target Pos := 111, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Velocity := 112, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Target Pos := 113, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Start Pos := 114, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Moving Length := 115, (* invalid parameter *) e CTRL_ERROR_NT_Get Time := 116, (* internal error NT_Get Time *) e CTRL_ERROR_INVALIDPARAM_No3Phase Solution Possible := 117, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Start Velo := 118, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Target Velo := 119, (* invalid parameter *) e CTRL_ERROR_INVALID_NEW_PARAMETER_TYPE := 120 (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Base Time := 121, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Order Of The Transferfunction_SIZEOF := 122, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Filter Order := 124, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Coefficients Array_a_SIZEOF := 125, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Coefficients Array_b_SIZEOF := 126, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Digital Fiter Data_SIZEOF := 127, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Log Buffer_SIZEOF := 128, (* invalid parameter *) e CTRL_ERROR_Log Buffer Overflow := 129, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Log Buffer_ADR := 130, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Coefficients Array_a_ADR := 131, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Coefficients Array_b_ADR := 132, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Pwm Input Array_ADR := 133, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Pwm Output Array_ADR := 134, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Pwm Wait Times Config_ADR := 135, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Pwm Internal Data_ADR := 136, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Digital Fiter Data_ADR := 137, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Numerator Array_ADR := 138, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Denominator Array_ADR := 139, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Transferfunction1Data_ADR := 140, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_n Transferfunction2Data_ADR := 141, (* invalid parameter *) e CTRL_ERROR_File Seek := 142, (* internal error FB_File Seek *) e CTRL_ERROR_INVALIDPARAM_Ambient Temp Max Is Less Than Ambient Temp Min := 143, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Forerun Temp Max Is Less Than Forerun Temp Min := 144, (* invalid parameter *) e CTRL_ERROR_INVALIDLOGCYCLETIME := 145, (* invalid parameter *) e CTRL_ERROR_INVALIDVERSION_Tc Controller Toolbox := 146, e CTRL_ERROR_INVALIDPARAM_Bandwidth := 147, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Notch Frequency := 148, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_Damping Coefficient := 149, (* invalid parameter *) e CTRL_ERROR_INVALIDPARAM_f Kp Is Less Than Zero := 150 (* invalid parameter *) ); END_TYPE E_CTRL_SIGNAL_TYPE TYPE E_CTRL_SIGNAL_TYPE : ( e CTRL_TRIANGLE := 0, e CTRL_SINUS := 1, e CTRL_SAWTOOTH := 2 ); END_TYPE TYPE E_CTRL_STEP_SENSORTYPE ( e SENSOR_NONE := 0, e SENSOR_PT100 := 1, e SENSOR_THERMO_J := 2, e SENSOR_THERMO_K := 3 ); END_TYPE 176 Version: 2.2.4 TF4100
## Page 177

Example project 5 Example project The behavoiur of the TF4100 Controller Toolbox function blocks are shown with an example. The base functionalities are included. All closed loop controlled systems of the programs are simulated, no hardware is necessary for the project. 5.1 Example Installation The Twin CAT controller toolbox offers the programmer transfer elements with which a very wide variety of controllers can be implemented. 1. Save the sample program https://infosys.beckhoff.com/content/1033/TF4100_TC3_Controller_Toolbox/ Resources/1461955979.zip and unpack it. ð The sample program Tc Controller Toolbox_Examples.sln is loaded into the Twin CAT XAE, compiled and started. 2. Load the solution file. 3. Compile the PLC project via the menu option Project - Rebuild All. 4. Load the PLC project into the runtime system via the menu option Online - Login. 5. Start the program via the menu option Online - Run. Using Twin CAT Scope View examples Twin CAT Scope View allows the signal curves from the individual examples to be displayed graphically. The settings supplied in Tc Controller Toolbox Examples_Scope_x.sv can be used for this purpose. This specification of the Scope file to be used for each particular example can be found in the comments in the project's MAIN program. 6. Load the Scope configuration file into the Twin CAT Scope View. 7. Start the recording via the menu or by pressing the Record key. Select the desired example project Because the example project contains a number of different examples, it is necessary to set the variable n Example Selector to the appropriate example number in the MAIN program. 8. Double-click the variable n Example Selector. TF4100 Version: 2.2.4 177
## Page 178

Example project 9. Enter the number of the example. 10. Click OK. 11. Press the [F7] key or click Force Values in the menu Online. 5.2 Example Structure The MAIN module calls up the corresponding sample program in accordance with the variable n Example Selector. 178 Version: 2.2.4 TF4100
## Page 179

Example project The individual sample programs contain comments for clarity and traceability. TF4100 Version: 2.2.4 179
## Page 180

Appendix 6 Appendix 6.1 Setting rules for the P, PI and PID controllers This page summarizes some of the setting rules found in the relevant literature. The setting rule to be used for a particular case has to be determined depending on the controlled system. Ziegler and Nichols The Ziegler and Nichols setting rules can be used if the controlled system can be approximated by a dead time element and 1st order delay element. T = dead time of the controlled system t K = gain factor of the controlled system s T = time constant of the controlled system s Chien, Hrones and Reswick If this procedure is to be used, the step response of the system must show delay characteristics and be free from overshoot effects. From the step response the delay time T , the compensation time T and the system amplification K are U g s determined. The system amplification is calculated from the following quotient: 180 Version: 2.2.4 TF4100
## Page 181

Appendix Optimization of the interference behavior: TF4100 Version: 2.2.4 181
## Page 182

Appendix Optimization of the control behavior 182 Version: 2.2.4 TF4100
## Page 183

Trademark statements Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered trademarks of and licensed by Beckhoff Automation Gmb H. Third-party trademark statements Microsoft, Microsoft Azure, Microsoft Edge, Power Shell, Visual Studio, Windows and Xbox are trademarks of the Microsoft group of companies.
## Page 184

More Information: www.beckhoff.com/tf4100 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
