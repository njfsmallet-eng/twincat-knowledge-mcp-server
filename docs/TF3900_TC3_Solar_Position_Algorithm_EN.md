---
title: "TF3900_TC3_Solar_Position_Algorithm_EN"
product: "TF3900"
category: "Utilities"
tags: ["ALGORITHM", "POSITION", "SOLAR"]
language: "EN"
document_type: "Manual"
version: "1.1.1"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF3900_TC3_Solar_Position_Algorithm_EN.pdf"
release_date: "2024-04-23"
---
Manual | EN TF3900 Twin CAT 3 | Solar Position Algorithm 2024-04-23 | Version: 1.1.1
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation............................................................................................................. 5 1.2 For your safety.................................................................................................................................. 5 1.3 Notes on information security............................................................................................................ 7 2 Overview.................................................................................................................................................... 8 2.1 Copyright......................................................................................................................................... 10 3 Installation............................................................................................................................................... 11 3.1 System requirements...................................................................................................................... 11 3.2 Installation....................................................................................................................................... 11 3.3 Licensing......................................................................................................................................... 14 4 API............................................................................................................................................................ 17 4.1 PLC Reference................................................................................................................................ 17 4.1.1 Function blocks................................................................................................................ 17 4.1.2 Data types........................................................................................................................ 20 4.1.3 Global constants.............................................................................................................. 22 5 Example................................................................................................................................................... 23 TF3900 Version: 1.1.1 3
## Page 4

Table of contents 4 Version: 1.1.1 TF3900
## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. For installation and commissioning of the components, it is absolutely necessary to observe the documentation and the following notes and explanations. The qualified personnel is obliged to always use the currently valid documentation. The responsible staff must ensure that the application or use of the products described satisfies all requirements for safety, including all the relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been prepared with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. No claims to modify products that have already been supplied may be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of designations or trademarks used in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Patents The Ether CAT Technology is covered, including but not limited to the following patent applications and patents: EP1590927, EP1789857, EP1456722, EP2137893, DE102015105702 and similar applications and registrations in several other countries. Ether CAT® is registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document as well as the use and communication of its contents without express authorization are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. TF3900 Version: 1.1.1 5
## Page 6

Foreword Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 6 Version: 1.1.1 TF3900
## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. TF3900 Version: 1.1.1 7
## Page 8

Overview 2 Overview The Twin CAT PLC Solar Position Algorithm library (SPA) offers an option for calculating the sun position exactly at almost any time. The times for sunrise, solar apex and sunset can also be determined. In addition to the sun angles an angle of incidence can be issued, if the point of reference has a certain inclination. The sun angles themselves refer to the horizontal at the point of reference. The algorithm is based on a technical report by the U. S. National Renewable Energy Laboratory (NREL). The theoretical inaccuracy of the sun angles between the year -2000 and 6000 is specified as +/-0.0003°. Based on this the function block of the Twin CAT Solar Position Algorithm library assumes an inaccuracy of +/-0.001° for the sun angles. Sun angles The position of the sun at a fixed observation point is normally determined by specifying two angles. In order to calculated the sun angles using the Twin CAT Solar Position Algorithm library, the date, time, longitude, latitude and further parameters have to be specified, depending on the required accuracy. The graphic illustrates the meaning of the main terms in this context: The sun position represented by two angles. Zenith The zenith angle of the sun is defined as the angle between the vertical above the observer and the connecting line between the observer and the sun. In some cases the altitude is as used to indicate the sun elevation angle. The following applies: 90° - zenith angle = altitude Azimuth The azimuth coincides with the horizon. North is 0°, with the value increasing in clockwise direction (east = 90°, south=180°, west=270°). Longitude and latitude The latitude is specified as the distance of a place on the surface of the earth from the equator to the north or to the south in degrees. The latitude can assume a value from 0° (at the equator) to ±90° (at the poles). A positive sign thereby indicates a northern direction and a negative sign a southern direction. The longitude is an angle that can assume values up to ±180° starting from the prime meridian 0° (an artificially determined North-South line). A positive sign indicates a longitude in an eastern direction and a negative sign in a western direction. Examples: 8 Version: 1.1.1 TF3900
## Page 9

Overview Place Longitude Latitude Sydney, Australia 151.2° -33.9° New York, USA -74.0° 40.7° London, England -0.1° 51.5° Moscow, Russia 37.6° 55.7° Peking, China 116.3° 39.9° Dubai, United Arab Emirates 55.3° 25.4° Rio de Janeiro, Brazil -43.2° -22.9° Hawaii, USA -155.8° 20.2° Verl, Germany 8.5° 51.9° Time scale Specification of the correct time is particularly important. Various time scales are in use. The Solar Position Algorithm is based on Universal Time (UT1). Universal Time (UT1) Between 1928 and 1968 was the UT was the accepted world time. It is also referred to as universal solar time. It is determined through astronomic observation of the angle of rotation of the earth and corresponds to the mean local time of the observatory at Greenwich (prime meridian). This parameter is derived from the earth's rotation and takes into account fluctuations and long-term slowdown and is therefore not strictly a uniform measure of time. On the other hand, it is always synchronised with the actual change-over between day and night. International Atomic Time (TAI) The International Atomic Time is specified by more than 50 time institutes worldwide, based on their atomic clocks. An atomic time is based on an atomic standard time that can be assumed to be exactly uniform. Coordinated Universal Time (UTC) The coordinated world time UTC has been used as the standard world time since 1968. This is the time referred to by GMT in everyday usage. Greenwich Mean Time (GMT) was the original world time before 1928. UTC continues to use the observatory at Greenwich (prime meridian) as point of reference. The earth's time zones are derived from the coordinated world time (UTC+1 = Central European Time). In contrast to UT1, its second cycle matches the exactly uniform second cycle of the International Atomic Time (TAI). Leap seconds are used to compensate the difference between UTC and UT1. The difference between the UT1 reference time is always less than one second. The coordinated world time UTC is therefore a compromise between UT1 and TAI. The following formula is used to convert a time from UTC to UT1: UT1 = UTC + DUT1 Terrestrial Time (TT) Also referred to as Terrestrial Dynamical Time (TDT). This time is used as the basis for calculating astronomic events and is based on the exactly uniform seconds of the International Atomic Time (TAI). The following applies: TT = TAI + 32.184 Leap Seconds To synchronise the coordinated world time UTC with UT1, a leap second is added when required. This additional second is specified by the International Earth Rotation and Reference Systems Service (IERS) at irregular, non-predictable intervals. It ensures that the difference between the two time scales is always less than one second. (In the past such additional leap seconds have always been added on 31 December or 30 June after 23:59:59 UTC.) DUT1 denotes the remaining difference. The following applies: DUT1 = UT1 - UTC This value is derived from observations that are continuously reported. Delta T TF3900 Version: 1.1.1 9
## Page 10

Overview Delta T is the difference between Terrestrial Time and Universal Time. The following applies: Delta_t = TT - UT1 This parameter can be specified as f Delta_t at the input for function block FB_SPA [} 17]. It is derived from observations that are continuously reported. A standard value is 66 seconds. 2.1 Copyright The algorithm is based on the technical report "Solar Position Algorithm for Solar Radiation Application" by I. Reda & A. Andreas, National Renewable Energy Laboratory (NREL), USA (revision 14-JAN-2009). NOTICE Copyright (C) 2007 Alliance for Sustainable Energy, LLC, All Rights Reserved This computer software was developed by the Alliance for Sustainable Energy, LLC, hereinafter the Contractor, under Contract DE-AC36-08GO28308 (Contract) with the Department of Energy (DOE). The United States Government has been granted for itself and others acting on its behalf a paid-up, non-exclusive, irrevocable, worldwide license in the Software to reproduce, prepare derivative works, and perform publicly and display publicly. Beginning five (5) years after the date permission to assert copyright is obtained from the DOE, and subject to any subsequent five (5) year renewals, the United States Government is granted for itself and others acting on its behalf a paid-up, non-exclusive, irrevocable, worldwide license in the Software to reproduce, prepare derivative works, distribute copies to the public, perform publicly and display publicly, and to permit others to do so. If the Contractor ceases to make this computer software available, it may be obtained from DOE's Office of Scientific and Technical Information's Energy Science and Technology Software Center (ESTSC) at P. O. Box 62, 1 Science Gov Way, Oak Ridge, TN 37831-1020. THIS SOFTWARE IS PROVIDED BY THE CONTRACTOR "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE CONTRACTOR OR THE U. S. GOVERNMENT BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER, INCLUDING BUT NOT LIMITED TO CLAIMS ASSOCIATED WITH THE LOSS OF DATA OR PROFITS, WHICH MAY RESULT FROM AN ACTION IN CONTRACT, NEGLIGENCE OR OTHER TORTIOUS CLAIM THAT ARISES OUT OF OR IN CONNECTION WITH THE ACCESS, USE OR PERFORMANCE OF THIS SOFTWARE. 10 Version: 1.1.1 TF3900
## Page 11

Installation 3 Installation 3.1 System requirements Runtime Technical data Description Operating system XP, XPe, WES, Win7, WES7, CE7 Target platform PC or CX (x86, x64, ARM) Minimum Twin CAT version Twin CAT 3.1 build 4011.0 or higher Required Twin CAT setup level Twin CAT 3 XAR Required Twin CAT license TC1200 In systems without floating point unit, the performance is limited due to complex internal calculations. In the event of anomalies, the cycle time should be checked. Engineering Technical data Description Operating system XP, XPe, WES, Win7, WES7 Minimum Twin CAT version Twin CAT 3.1. Build 4011.0 and higher Required PLC library Tc2_SPA This PLC library must be integrated into the PLC project. 3.2 Installation The following section describes how to install the Twin CAT 3 Function for Windows-based operating systems. ü The Twin CAT 3 Function setup file was downloaded from the Beckhoff website. 1. Run the setup file as administrator. To do this, select the command Run as administrator in the context menu of the file. ð The installation dialog opens. TF3900 Version: 1.1.1 11
## Page 12

Installation 2. Accept the end user licensing agreement and click Next. 3. Enter your user data. 12 Version: 1.1.1 TF3900
## Page 13

Installation 4. If you want to install the full version of the Twin CAT 3 Function, select Complete as installation type. If you want to install the Twin CAT 3 Function components separately, select Custom. 5. Select Next, then Install to start the installation. ð A dialog box informs you that the Twin CAT system must be stopped to proceed with the installation. TF3900 Version: 1.1.1 13
## Page 14

Installation 6. Confirm the dialog with Yes. 7. Select Finish to exit the setup. ð The Twin CAT 3 Function has been successfully installed and can be licensed (see Licensing [} 14]). 3.3 Licensing The Twin CAT 3 function can be activated as a full version or as a 7-day test version. Both license types can be activated via the Twin CAT 3 development environment (XAE). Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. 14 Version: 1.1.1 TF3900
## Page 15

Installation 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. TF3900 Version: 1.1.1 15
## Page 16

Installation 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. 16 Version: 1.1.1 TF3900
## Page 17

API 4 API 4.1 PLC Reference 4.1.1 Function blocks 4.1.1.1 FB_SPA At the input all available values for the location definition and type of calculation are specified. The calculation is performed during a function block cycle. The results are immediately available at the output. Due to the complex internal calculation steps processing takes system performance. Inputs VAR_INPUT st Time :ST_SPA_TIMESTRUCT; (* local date and time (year, month, day, hour, minute, second) *) f Timezone :LREAL; (* Observer time zone (negative west of Greenwich) *) (* valid range: -18 TO 18 hours, error code: 8*) f Delta_t :LREAL:=66; (* Difference between earth rotation time and terrestrial time *) (* It is derived from observation only and is reported in this *) (* bulletin: http://maia.usno.navy.mil/ser7/ser7.dat,*) (* where delta_t = 32.184 + (TAI-UTC) + DUT1*) (* valid range: -8000 to 8000 seconds, error code: 7 *) f Longitude :LREAL; (* Observer longitude (negative west of Greenwich) *) (* valid range: -180 to 180 degrees, error code: 9 *) f Latitude :LREAL; (* Observer latitude (negative south of equator)*) (* valid range: -90 to 90 degrees, error code: 10 *) f Elevation :LREAL; (* Observer elevation [meters] *) (* valid range: -6500000 or higher meters, error code: 11 *) f Pressure :LREAL:=1000; (* Annual average local pressure [millibars] *) (* valid range: 0 to 5000 millibars, error code: 12 *) f Temperature :LREAL; (* Annual average local temperature [degrees Celsius] *) (* valid range: -273 to 6000 degrees Celsius, error code; 13 *) f Slope :LREAL; (* Surface slope (measured from the horizontal plane) *) (* valid range: -360 to 360 degrees, error code: 14 *) f Azm_rotation :LREAL; (* Surface azimuth rotation (measured from south to projection of *) (* surface normal on horizontal plane, negative west) *) (* valid range: -360 to 360 degrees, error code: 15 *) f Atmos_refract :LREAL:=0.5667;(* Atmospheric refraction at sunrise and sunset (0.5667 deg is typ.)*) (* valid range: -5 to 5 degrees, error code: 16 *) e Function :E_SPA_Function Code:=e SPA_ZA; (* Switch to choose functions for desired output *) END_VAR TF3900 Version: 1.1.1 17
## Page 18

API Name Type Description st Time ST_SPA_TIMESTRUCT The date and the local time are specified via st Time. [} 20] f Timezone LREAL The required date with the corresponding time can be specified in local time via the above variable. The respective time zone is added via f Timezone. The time zone is always based on Greenwich (London, United Kingdom). (The prime meridian 0° of longitude also runs through Greenwich) In relation to Coordinated Universal Time: UTC+1 = Central European Time; UTC+2 = Central European Summer Time. f Delta_t LREAL The input variable f Delta_t is used for balancing the time scales used. A default value for this is 66. A more detailed description of the different time scales can be found on the overview page [} 8]. f Longitude LREAL Longitude in degrees [°]. It is positive to the east of Greenwich. f Latitude LREAL Latitude in degrees [°]. It is positive to the north of the equator and negative to the south. f Elevation LREAL The altitude of the location also has a small effect on the calculation of the sun angles. f Elevation indicates the height in meters [m] above mean sea level. f Pressure LREAL The atmospheric pressure at the location is specified in millibar [mbar] via the input variable f Pressure. The annual average is specified. f Temperature LREAL The temperature at the location is specified via the input variable f Temperature in °C. The annual average is specified. f Slope LREAL Via f Slope a surface inclination can be specified in degrees [°]. It is used for calculating the special angle of incidence f Incidence. If f Slope is zero, the angle of incidence is the same as the zenith angle. f Azm_rotation LREAL f Azm_rotation can be used to adjust the alignment (in degrees [°]) of the observer or the surface inclined by f Slope. For north alignment the value is 0°. From there the alignment angle increases clockwise (positive values, as does the azimuth of the sun angle). It is also used for calculating the special angle of incidence f Incidence. Is f Slope is zero, the angle of incidence is the same as the zenith angle, irrespective of f Azm_rotation. If f Azm_rotation is the same as the sun angle f Azimuth, the following applies: f Incidence = f Zenith + f Slope. This is illustrated the following 2D diagram. 18 Version: 1.1.1 TF3900
## Page 19

API Name Type Description f Atmos_refract LREAL Refraction in the atmosphere can have a significant effect on the zenith angle of the sun, particularly for shallow sun angles. The input variable f Atmos_refract is used as a correction factor for the atmospheric distraction at sunrise and sunset. A default value for this is 0.5667. e Function E_SPA_Function Code Via this enumeration value the type of calculations can be selected. For example, the calculation can be limited to the [} 21] sun angles, if information on sunrise etc. is not required. Outputs VAR_OUTPUT f Zenith :LREAL; (* topocentric zenith angle [degrees] *) f Azimuth :LREAL; (* topocentric azimuth angle (eastward from north) [ 0 to 360 degrees] *) f Azimuth180 :LREAL; (* topocentric azimuth angle (westward from south) [-180 to 180 degrees]*) f Incidence :LREAL; (* surface incidence angle [degrees] *) f Suntransit :LREAL; (* local sun transit time (or solar noon) [fractional hour] *) f Sunrise :LREAL; (* local sunrise time (+/- 30 seconds) [fractional hour] *) f Sunset :LREAL; (* local sunset TIME (+/- 30 seconds) [fractional hour] *) b Error :BOOL; (* error flag *) i Error Code :UINT; (* error code *) END_VAR TF3900 Version: 1.1.1 19
## Page 20

API Name Type Description f Zenith LREAL The zenith angle of the sun is defined as the angle between the vertical above the observer (zenith) and the connecting line between the observer and the sun. If the sun is absolutely vertical above the observer, the zenith angle is 0°. Sometimes the sun elevation angle (Sun Elevation or Altitude) is also used. The following applies: 90° - zenith angle = altitude f Azimuth LREAL The azimuth coincides with the horizon. North is 0°, with the value increasing in clockwise direction. (east = 90°, south=180°, west=270°). A graphical representation of the sun angles can be found on the overview page [} 8]. f Azimuth180 LREAL This value corresponds in meaning to the azimuth. However, the azimuth180 is assigned the value 0° in the south. From there the value increases positively in clockwise direction and negatively in counter-clockwise direction. (azimuth-180° = azimuth180) f Incidence LREAL Indicates the angle of solar incidence in relation to the surface specified at the input. If the surface is horizontal f Incidence matches the value of f Zenith. f Suntransit LREAL Indicates the time of the solar apex. It is specified in hours and used the time zone created at the input. The following type conversion can be used to convert the variable f Suntransit (analogous to f Sunrise and f Sunset) to the TIME format: t Suntransit := LREAL_TO_TIME(fb SPA.f Suntransit*60*60*1000); f Sunrise LREAL Indicates the sunrise time. It is specified in hours and used the time zone created at the input. f Sunset LREAL Indicates the sunset time. It is specified in hours and used the time zone created at the input. b Error BOOL Is TRUE if an error has occurred. In this case i Error Code indicates the respective error code. i Error Code UINT Indicates the error value for the calculation. If an error has occurred this value is not equal zero. All possible error values are summarized in the enumeration E_SPA_Error Code [} 21]. Requirements Development environment Target platform PLC libraries to include Twin CAT V3.1.4011 PC or CX (x86, x64, ARM) Tc2_SPA 4.1.2 Data types 4.1.2.1 Structures 4.1.2.1.1 ST_SPA_TIMESTRUCT TYPE ST_SPA_TIMESTRUCT : STRUCT i Year :INT(-2000..6000); (* 4-digit year, valid range: -2000 TO 6000, error code: 1 *) i Month :INT(1..12); (* 2-digit month, valid range: 1 to 12 (Jan.= 1), error code: 2 *) i Day :INT(1..31); (* 2-digit day, valid range: 1 to 31, error code: 3 *) i Hour :INT(0..24); (* Observer local hour, valid range: 0 to 24, error code: 4 *) i Minute :INT(0..59); (* Observer local minute, valid range: 0 to 59, error code: 5 *) 20 Version: 1.1.1 TF3900
## Page 21

API i Second :INT(0..59); (* Observer local second, valid range: 0 TO 59, error code: 6 *) END_STRUCT END_TYPE The structure ST_SPA_TIMESTRUCT contains information on date and time. It is used at the input for function block FB_SPA [} 17] in order to specify the local time at the location. This local time has seconds as the smallest unit. Various time scales are in use. The Universal Time (UT1) is used for sun position calculations based on the time specified in ST_SPA_TIMESTRUCT. If an inaccuracy of +/-0.005° is acceptable for the sun angles, the coordinated world time (UTC) may be used as the time. Explanatory notes can be found on the overview page [} 8]. Summer and winter time clock change must not be used. The initiation of summer time (daylight saving time) in the 20.century should only extend the usable number of hours daylight per day. It's not common practice in all countries. For calculating the sun position with this library the Standard Time has to be used. In germany the Standard Time is equal to the winter time. 4.1.2.2 Enumerations 4.1.2.2.1 E_SPA_Function Code The enumeration E_SPA_Function Code defines constant values for the different functions, which can be executed with the function block FB_SPA [} 17]. In addition to sun angles, sunrise and sunset can be calculated, depending on the selection. A detailed explanation of the terminology can be found on the overview page [} 8]. The time required for a calculation strongly depends on the choice of function code. (* enumeration for function codes to select desired final outputs from SPA *) TYPE E_SPA_Function Code :( e SPA_ZA, (*calculate zenith AND azimuth [default setting] *) e SPA_ZA_INC, (*calculate zenith, azimuth, AND incidence *) e SPA_ZA_RTS, (*calculate zenith, azimuth, AND sun rise/transit/set values *) e SPA_ALL (*calculate all SPA output values *) ); END_TYPE Name Description e SPA_ZA If the function code e SPA_ZA is selected only the sun angles (zenith, azimuth, azimuth180) are calculated [DEFAULT]. e SPA_ZA_INC In addition to the sun angles the angle of incidence in relation to the specified surface is issued. e SPA_ZA_RTS In addition to the sun angles, sunrise, solar apex and sunset is calculated. e SPA_ALL All offered data are calculated and displayed at the output. 4.1.2.2.2 E_SPA_Error Code The enumeration E_SPA_Error Code defines constant values for the different errors that can be generated internally in the library. These values can be found in the output variable i Error Code again, which indicates the associated integer value at the output of the PLC SPA function block FB_SPA [} 17] in the event of an error. (* enumeration for error codes returned as i Error Code output of FB_SPA //////////////////////////////////////////////////////////////////////// // Note: A non-zero return error code indicates that one of the // // input values did not pass simple bounds tests. // //////////////////////////////////////////////////////////////////////// *) TF3900 Version: 1.1.1 21
## Page 22

API TYPE E_SPA_Error Code :( e SPA_ERR_No Error := 0, e SPA_ERR_Invalid Year, e SPA_ERR_Invalid Month, e SPA_ERR_Invalid Day, e SPA_ERR_Invalid Hour, e SPA_ERR_Invalid Minute, e SPA_ERR_Invalid Second, e SPA_ERR_Invalid Delta T, e SPA_ERR_Invalid Timezone, e SPA_ERR_Invalid Longitude, e SPA_ERR_Invalid Latitude, e SPA_ERR_Invalid Elevation, e SPA_ERR_Invalid Pressure, e SPA_ERR_Invalid Temperature, e SPA_ERR_Invalid Slope, e SPA_ERR_Invalid AZMRotation, e SPA_ERR_Invalid Atmos Refract, e SPA_ERR_Invalid Function Code ); END_TYPE 4.1.3 Global constants 4.1.3.1 Global_Version All libraries have a specific version. This version is shown in the PLC library repository too. A global constant contains the library version information: VAR_GLOBAL CONSTANT st Lib Version_Tc2_SPA : ST_Lib Version; END_VAR To compare the existing version to a required version the function F_Cmp Lib Version (defined in Tc2_System library) is offered. Use only this query All other possibilities known from Twin CAT 2 libraries to query a library version are obsolete. 22 Version: 1.1.1 TF3900
## Page 23

Example 5 Example This example offers an introduction into the handling of function block FB_SPA [} 17], which is available with the Twin CAT Solar Position Algorithm library. The objective in this example is to determine the sun position on 4 March 2010 at 14:27:00 at the Cheops pyramid in Egypt. Time zone: UTC + 2 hours Latitude: 29.979, [°] Longitude: 31.134 [°] Height: 70 [m] Annual average temperature: 21.7 [°C] Other locations and times are determined similarly. Overview The following steps are now performed: 1. Installation of the PLC library 2. Program structure 3. Test 1. Installation of the PLC library Create a new Twin CAT PLC project and select your target platform. Your first POU is a program called MAIN and in the programming language ST (Structured Text). Mark node References and insert the library Tc2_SPA. TF3900 Version: 1.1.1 23
## Page 24

Example 2. Program structure For sun position calculations you should declare an instance of function block FB_SPA [} 17]and local variables for allocating the required result values. The input parameter for the calculation can be directly assigned to the inputs of the function block. In addition to the sun angles the sunrise and sunset is required as output, which means the advanced functionality is required, which is specified via the enumeration value e SPA_ZA_RTS of type E_SPA_Function Code [} 21]. The output values of the function block are assigned to your local variables. The program section should now look as follows: PROGRAM MAIN VAR fb SPA : FB_SPA; f Sun Zenith : LREAL; f Sun Azimuth : LREAL; t Sunrise : TIME; t Sunset : TIME; e Error Code : E_SPA_Error Code; b Execute : BOOL; b Init : BOOL := TRUE; END_VAR IF b Init THEN b Init := FALSE; fb SPA.st Time.i Year := 2010; fb SPA.st Time.i Month := 3; fb SPA.st Time.i Day := 4; fb SPA.st Time.i Hour := 14; fb SPA.st Time.i Minute := 27; fb SPA.f Timezone := 2; fb SPA.f Longitude := 31.134; fb SPA.f Latitude := 29.979; fb SPA.f Elevation := 70; fb SPA.f Temperature := 21.7; fb SPA.e Function := e SPA_ZA_RTS; END_IF IF b Execute THEN fb SPA(); e Error Code := fb SPA.i Error Code; f Sun Zenith := fb SPA.f Zenith; f Sun Azimuth := fb SPA.f Azimuth; t Sunrise := LREAL_TO_TIME(fb SPA.f Sunrise*60*60*1000); t Sunset := LREAL_TO_TIME(fb SPA.f Sunset*60*60*1000); END_IF This sample of the Twin CAT Solar Position Algorithm library contains a visualisation facility that provides a quick overview of current inputs and outputs of function block FB_SPA [} 17]. It is therefore ideal for test purposes. 3. Test Compile the created PLC program. Make sure that Twin CAT is in the Run mode on the desired system. Login to the desired run-time system from Twin CAT PLC Control. Start the PLC program. The calculation is executed by setting the local variable b Execute to TRUE. This can be done via 'online write' or the corresponding button in the visualisation, for example. The visualisation should now present the following results: 24 Version: 1.1.1 TF3900
## Page 25

Example The sun angles at other locations and at other times within the given value ranges can be calculated accordingly. If an input parameter is invalid, an e Error Code with the corresponding enumeration value for the error is displayed. Click here to save this example program: https://infosys.beckhoff.com/content/1033/TF3900_TC3_Solar_Position_Algorithm/Resources/ 946940683/.zip. TF3900 Version: 1.1.1 25
## Page 27

More Information: www.beckhoff.com/tf3900 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
