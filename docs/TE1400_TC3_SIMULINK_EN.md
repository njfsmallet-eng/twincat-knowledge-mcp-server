---
title: "TE1400 Twin CAT 3"
product: "TE1400"
category: "Engineering_Tools"
tags: ["CAT", "Simulink", "TWIN"]
language: "EN"
document_type: "Manual"
version: "2.4.1"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TE1400_TC3_SIMULINK_EN.pdf"
release_date: "2025-08-21"
---
Manual | EN TE1400 Twin CAT 3 | Target for Simulink® 2025-08-21 | Version: 2.4.1

## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 7 1.1 Notes on the documentation............................................................................................................. 7 1.2 For your safety.................................................................................................................................. 8 1.3 Notes on information security............................................................................................................ 9 1.4 Documentation issue status............................................................................................................ 10 2 Overview.................................................................................................................................................. 11 3 Up to version 1.2.xxxx.x......................................................................................................................... 13 3.1 Installation....................................................................................................................................... 13 3.2 Licenses.......................................................................................................................................... 15 3.3 Quickstart........................................................................................................................................ 16 3.4 Twin CAT Library in Simulink®.......................................................................................................... 19 3.5 Parameterization of the code generation in Simulink...................................................................... 22 3.5.1 Module generation (Tc Build)........................................................................................... 23 3.5.2 Data exchange (Tc Interfaces)......................................................................................... 27 3.5.3 External mode (Tc External Mode).................................................................................. 31 3.5.4 Advanced settings (Tc Advanced)................................................................................... 34 3.6 Application of modules in Twin CAT................................................................................................ 40 3.6.1 Parameterization of a module instance............................................................................ 40 3.6.2 Executing the generated module under Twin CAT........................................................... 42 3.6.3 Calling the generated module from a PLC project........................................................... 44 3.6.4 Using the To File block...................................................................................................... 49 3.6.5 Signal access via Twin CAT 3 Scope .............................................................................. 55 3.7 FAQ................................................................................................................................................. 56 3.7.1 Does code generation work even if I integrate S-Functions into my model?................... 56 3.7.2 Why do FPU/SSE exceptions occur at runtime in the generated Twin CAT module, but not in the Simulink model?..................................................................................................... 56 3.7.3 After updating Twin CAT and/or TE1400 I get an error message for an existing model... 57 3.7.4 Why do the parameters of the Tc COM instance not always change after a "Reload TMC/ TMI" operation?................................................................................................................ 57 3.7.5 After a "Reload TMC/TMI" error "Source File <path> to deploy to target not found......... 58 3.7.6 Why do I have a Class ID conflict when I start Twin CAT?................................................ 59 3.7.7 Why can the values transferred via ADS differ from values transferred via output map- ping?................................................................................................................................ 59 3.7.8 Are there limitations with regard to executing modules in real-time?............................... 59 3.7.9 Which files are created automatically during code generation and publishing?............... 60 3.7.10 How do I resolve data type conflicts in the PLC project?................................................. 61 3.7.11 Why are the parameters of the transfer function block in the Twin CAT display not identical to the display in Simulink?................................................................................................ 62 3.7.12 Why does my code generation/publish process take so long?........................................ 62 3.8 Examples........................................................................................................................................ 62 3.8.1 Temperature Controller_minimal ...................................................................................... 63 3.8.2 Temperature Controller.................................................................................................... 69 3.8.3 SFun Static Lib................................................................................................................... 78 3.8.4 SFun Wrapped Static Lib.................................................................................................... 84 3.8.5 Module generation Callbacks........................................................................................... 89 TE1400 Version: 2.4.1 3

## Page 4

Table of contents 4 From version 2.x.xxxx.x......................................................................................................................... 90 4.1 Installation....................................................................................................................................... 90 4.2 Licenses.......................................................................................................................................... 91 4.3 Initial setup of the software............................................................................................................. 92 4.3.1 Set up default settings and set MATLAB® path................................................................ 92 4.3.2 Setting up driver signing................................................................................................... 95 4.4 Quick start....................................................................................................................................... 99 4.5 Twin CAT Library in Simulink®........................................................................................................ 105 4.5.1 Twin CAT Input and Output modules.............................................................................. 106 4.5.2 Twin CAT Environment View.......................................................................................... 113 4.5.3 Twin CAT File Writer....................................................................................................... 113 4.6 Overview of automatically generated files..................................................................................... 115 4.7 Parameterization of the code generation in Simulink®.................................................................. 119 4.7.1 Overview table of all configuration parameters.............................................................. 122 4.7.2 Parameterization of the code generation via an m-file................................................... 129 4.7.3 Build for different platforms............................................................................................ 132 4.7.4 Build on a system without MATLAB® (Build Agent)........................................................ 133 4.7.5 Bundling of several models in one Twin CAT driver....................................................... 134 4.7.6 Sharing created Twin CAT objects.................................................................................. 136 4.7.7 Automatic updating of objects in a Twin CAT project...................................................... 138 4.7.8 Creation of versioned drivers......................................................................................... 140 4.7.9 Online Change of Tc COM.............................................................................................. 144 4.7.10 Configuration of data access to data of a Tc COM object............................................... 146 4.7.11 Shared memory between Tc COM instances................................................................. 153 4.7.12 Creating a module with OEM license query................................................................... 159 4.7.13 Integration of own C/C++ code...................................................................................... 161 4.7.14 Configuration of the TMX file properties......................................................................... 162 4.7.15 Multitask, Concurrent Execution and Open MP.............................................................. 162 4.7.16 Instruction Set Extensions.............................................................................................. 169 4.7.17 Symbol Properties and Attribute Pragmas..................................................................... 170 4.7.18 Available placeholders................................................................................................... 176 4.7.19 Working with callbacks................................................................................................... 186 4.8 Application of modules in Twin CAT.............................................................................................. 187 4.8.1 Working with the Tc COM module.................................................................................. 188 4.8.2 Working with the PLC library.......................................................................................... 207 4.8.3 Debugging...................................................................................................................... 218 4.8.4 Connecting to External mode......................................................................................... 221 4.8.5 Exception handling......................................................................................................... 224 4.8.6 Using Realtime Monitor time stamps............................................................................. 234 4.9 FAQ............................................................................................................................................... 234 4.9.1 Change model parameters at runtime............................................................................ 234 4.9.2 Build of a sample fails.................................................................................................... 235 4.9.3 Problems with the block diagram representation in Twin CAT XAE............................... 235 4.9.4 Can I use TE1400 version 1.2.x and version 2.x at the same time?.............................. 236 4.9.5 What is the difference between "Build" and "Generate code"?...................................... 236 4.9.6 I can't change the parameters of a module in Twin CAT................................................ 236 4 Version: 2.4.1 TE1400

## Page 5

Table of contents 4.9.7 Mapping is lost with Reload TMI/TMC........................................................................... 236 4.9.8 Integrating the block diagram controls in . NET.............................................................. 237 4.9.9 Observable signals in the Twin CAT block diagram........................................................ 239 4.9.10 Using Simulink® Strings.................................................................................................. 240 4.9.11 Are there limitations with regard to executing modules in real-time?............................. 243 4.9.12 Message: Failed to copy repository............................................................................... 243 4.9.13 Data Exchange modules cannot be loaded.................................................................... 244 4.10 Samples........................................................................................................................................ 244 4.10.1 Integrating the block diagram controls .......................................................................... 245 4.10.2 Try out created Twin CAT objects yourself..................................................................... 247 5 Support and Service............................................................................................................................. 249 TE1400 Version: 2.4.1 5

## Page 6

Table of contents 6 Version: 2.4.1 TE1400

## Page 7

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. The documentation and the following notes and explanations must be complied with when installing and commissioning the components. The trained specialists must always use the current valid documentation. The trained specialists must ensure that the application and use of the products described is in line with all safety requirements, including all relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been compiled with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. Claims to modify products that have already been supplied may not be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, ATRO® , Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, MX-System®, Safety over Ether CAT®, TC/BSD®, Twin CAT®, Twin CAT/BSD®, Twin SAFE®, XFC®, XPlanar®, and XTS® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of the designations or trademarks contained in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Ether CAT® is a registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany. Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document, as well as the use and communication of its contents without express authorization, are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. Third-party trademarks Trademarks of third parties may be used in this documentation. You can find the trademark notices here: https://www.beckhoff.com/trademarks. TE1400 Version: 2.4.1 7

## Page 8

Foreword 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 8 Version: 2.4.1 TE1400

## Page 9

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. TE1400 Version: 2.4.1 9

## Page 10

Foreword 1.4 Documentation issue status Version Changes 2.4.1 Samples: "Try out created Twin CAT objects yourself" [} 247]: ZIP file for build 4026 added 2.4.x NEW: Pack'N Go function, see Build on a system without MATLAB® (Build Agent) [} 133] Twin CAT File Writer [} 113]: New parameter "Closed opened file on Pause" General information: • Twin CAT OS (x64): Platform to be selected for execution with the Twin CAT user mode runtime • Runtime system and engineering system require the same Twin CAT major build, see system requirements [} 90]. 2.3.x Set up driver signing via Software Protection UI, see: Setting up driver signing [} 95]. 2.2.x Twin CAT 3.1 Build 4026 • Brief information on installation [} 90] • Updating the system requirements • NEW: Set up default settings and set MATLAB® path [} 92] • Updates in the "Setting up driver signing" section Convert Simulink® model into Twin CAT object: New sample [} 99] (see end of chapter) to deepen your knowledge Revised/extended table of configuration parameters [} 122] NEW: Build for different platforms [} 132] NEW: Automatic updating of objects in a Twin CAT project [} 138] Revisions in section Online Change of Tc COM [} 144] NEW: Instruction Set Extensions [} 169] Revised/extended table of available placeholders [} 176] NEW: Post deploy callback function, see Working with Callbacks [} 186]. New code samples for referencing a static module instance or dynamic instantiation and referencing from the PLC, see Applying the Tc COM Wrapper FB [} 213]. New: The Simulink® Coder™ can translate a Simulink® string into the data type std::string, for details see FAQ/Using Simulink® Strings [} 240]. FAQ/troubleshooting on the topic "Data Exchange modules cannot be loaded [} 244]". 10 Version: 2.4.1 TE1400

## Page 11

Overview 2 Overview TE1400 Twin CAT Target for Simulink® With the Twin CAT 3 Target for Simulink® it is possible to make models developed in Simulink® usable in Twin CAT 3. Various toolboxes such as Sim Scape™ or Stateflow™ or DSP System Toolbox™ can be integrated in Simulink®. Embedded MATLAB® function blocks are also supported. The models are automatically transcoded in C/C++ code with the aid of the Simulink Coder™ and transformed into Twin CAT objects with Twin CAT 3 Target for Simulink®. These Twin CAT objects can then be executed in real-time in the Twin CAT runtime. These Twin CAT objects can be Tc COM objects for direct instantiation and linking with real-time tasks or function blocks for instantiation and processing in a PLC project. Areas of application and application examples The areas of application of Twin CAT Target for Simulink® can be summarized by the following keywords: • Rapid Control Prototyping • Real-time simulation • Si L (Software in the Loop) simulation • Hi L (Hardware in the Loop) simulation • Model-based design • Model-based monitoring The following application examples are intended to illustrate possible areas of application: • Example 1: Rapid Control Prototyping During the simulation development stage in Simulink®, a controller is implemented as a Simulink® model, which is integrated into the simulation model of the control loop via model referencing. This enables the closed control loop to be designed and tested in a simulation (Model in the Loop simulation (Mi L)). Before the controller model is compiled unchanged into a Twin CAT module via mouse click, which then operates as real-time controller for an actual system. Since standard Simulink® function blocks are used as inputs and outputs, they can be used in the higher-level Simulink® model as well as in the module generated later in Twin CAT. • Example 1a: Real-time simulation of a controlled system The controlled system is also implemented as a Simulink® model, which is integrated into the model of the closed control loop via Model Referencing. The Tc COM module generated from this is used to perform a real-time simulation, in which a controller implemented in IEC61131-3, C++ or Simulink® can be tested. • Example 2: Real-time simulation of a machine/Virtual commissioning A Tc COM module is generated from a machine model created in Simulink®. This can be used to test a PLC program in real-time, before the actual machine is connected (virtual commissioning). Depending on the configuration, Si L or Hi L simulations can be performed in this way. See also TE1111 Ether CAT Simulation. • Example 2a: Si L simulation of plant components According to VDI/VDE 3693 Part 1, Software in the loop (Si L) is defined as a stage following Mi L simulation, in which the control code is available as series code. The series code can be executed in an emulated controller, for testing against a system simulation model. According to this definition, there are two options for a Si L simulation of systems (components) with Twin CAT: ◦ The system model remains in Simulink® and uses ADS to communicate with the series code, which is executed in the Twin CAT runtime. See also TE1410 Interface für MATLAB Simulink. ◦ The system model is also compiled into a Tc COM module and executed in real-time (see example 1a). • Example 2b: Hi L simulation of system components According to VDI/VDE 3693 Part 1, Hardware in the loop (Hi L) is defined as an advanced testing stage, in which the actual target control code is tested on an actual controller against a system model. The latter is executed in a simulation tool, which acts as a bus device and therefore uses the actual communication networks of the automation system for communication with the actual controller. Based on this definition, the model of the system or the system components is converted to Tc COM TE1400 Version: 2.4.1 11

## Page 12

Overview modules and executed on a second Industrial PC, taking into account the real-time requirements. The function TE1111 Ether CAT Simulation is used to configure this IPC such that it makes the mirrored process image available to the actual controller. In this way, it is possible to use the actual controller and the actual configuration to communicate with the "simulation IPC" in hard real-time. • Example 3: Model-based monitoring of system components In many cases, measured variables are of interest that are not directly accessible or would result in excessive effort/costs. By using a physically representative model with measurable input variables, non-measurable variables can still be determined. An example is temperature measurement at locations that are inaccessible, such as the permanent magnet temperature in an electric motor. Based on a thermal model of the motor, the temperature can be estimated by means of secondary parameters such as electric current, rotational speed and cooling temperature. Further Information Technical short videos • Twin CAT Target for Simulink Product descriptions • https://www.beckhoff.com/TE1400 Customer application videos • Overview of customer applications • Success Story Vintecc bv • Success Story Magway Website for MATLAB® and Simulink® with Twin CAT 3: https://www.beckhoff.com/matlab 12 Version: 2.4.1 TE1400

## Page 13

Up to version 1.2.xxxx.x 3 Up to version 1.2.xxxx.x TE1400 Target for Simulink® versions lower than 1.2.xxxx.x support MATLAB R2010b to MATLAB R2019a. TE1400 Target for Simulink® versions higher than 2.x.xxxx.x support MATLAB R2019a and higher. 3.1 Installation System requirements Initially, the same requirements apply to the target for MATLAB®/Simulink® as for Twin CAT 3 C/C++. For a detailed description of the Twin CAT 3 C/C++ requirements, please refer to Chapter 4, "Requirements", of the Twin CAT 3 C++ manual. In the following sections, these requirements are only referred to briefly, not in detail. On the engineering PC • Microsoft Visual Studio 2010 (with Service Pack 1), 2012, 2013, 2015 or 2017 Professional, Premium, Ultimate or Community Edition ◦ Installation under Windows always with right-click run as admin… ◦ For Visual Studio 2015 check the Visual C++ checkbox during installation ◦ For Visual Studio 2017, manually select "Desktop development with C++" • Microsoft "Windows Driver Kit" version 7.1.0 (only required for Twin CAT versions older than Twin CAT 3 build 4024.0) ◦ It is sufficient to install the "Build Environments". ◦ Set the environment variable (variable name WINDDK7, variable value <Installation directory> e.g. C:\Win DDK\7600.16385.1) • Twin CAT 3 XAE Build 4024 On the runtime PC • IPC or Embedded CX PC with Microsoft operating system based on "Windows NT kernel" (Win XP, Win 7 and corresponding embedded versions, Win 10) • Twin CAT 3 XAR Build 4024 ◦ Twin CAT 3.1 supports 32-bit and 64-bit operating systems. If the target is a x64 system, the created drivers must be signed. The TE1400 supports OS driver signing. See "x64: driver signing" in the Twin CAT 3 C++ manual In addition to the above requirements, which originate from the requirements of Twin CAT 3 C/C++, the following requirements apply to the engineering PC: • MATLAB®/Simulink® R2010b up to and including R2019a. As of and including R2019a, the use of TE1400 version 2.x.xxxx.x is recommended. • Simulink® Coder™ (in MATLAB® versions prior to R2011a: Real-Time Workshop®) • MATLAB Coder™ (in MATLAB® versions prior to R2011a: part of the Real-Time Workshop®) • Installing the TE1400 Target for MATLAB®/Simulink® Setup instructions ü Install one of the supported Visual Studio versions, if not already installed. Pay attention to the installation of the C++ components. 1. Start Twin CAT 3 Setup, if it does not already exist. ð If a Visual Studio and a Twin CAT installation already exists but the Visual Studio version does not meet the requirements mentioned above (e.g. Visual Studio Shell or Visual Studio without Visual C+ +), you first have to install a suitable Visual Studio version (install Visual C++, if necessary). Then run Twin CAT 3 Setup to integrate Twin CAT 3 into the new (or modified) Visual Studio version. TE1400 Version: 2.4.1 13

## Page 14

Up to version 1.2.xxxx.x 2. If necessary, install the Microsoft Windows Driver Kit (see Installation "Microsoft Windows Driver Kit (WDK)" in the Twin CAT 3 C/C++ manual). The order in which the Windows Driver Kit was installed is irrelevant. 3. If you do not have a MATLAB® installation on your system, install it. The order in which MATLAB® was installed is irrelevant. 4. Start the setup TE1400-Target For Matlab Simulink to install the TE1400. The TE1400 is installed in the Twin CAT folder, i.e. it is separate from the MATLAB® installation. A MATLAB® version that exists on the system can be linked to the TE1400 according to point 6. 5. Start MATLAB® as administrator and execute %Twin CAT3Dir%..\Functions\TE1400- Target For Matlab Simulink\Setup Twin Cat Target.p in MATLAB®. ð A setup window opens. See the following section. • The p-file links the MATLAB® version used to the TE1400. If a new MATLAB® version is installed on the system, the p-file must be executed in the new version. • If a new TE1400 version is installed on top of an existing TE1400 version, the p-file should also be run again. User Account Control If MATLAB® is executed in a system with activated User Account Control (UAC) without administrator rights, the MATLAB® path cannot be stored permanently. In this case, Setup Twin Cat Target.p must be executed every time MATLAB® is started, since otherwise some files required for generating Twin CAT modules cannot be found. Driver signing for targets with x64 operating system To use an x64-operating system as runtime PC, the drivers must be signed. Details can be found in the TC3 C++ manual under Driver signing. 14 Version: 2.4.1 TE1400

## Page 15

Up to version 1.2.xxxx.x 3.2 Licenses Two licenses are required to use the full functionality of the TE1400 Target for MATLAB®/Simulink® (see Ordering and activation of Twin CAT 3 standard licenses). Required licenses for TE1400 TE1400: TC3 Target-For-Matlab-Simulink (module generator license) This license is required for the engineering system for the module generation from MATLAB®/Simulink®. For testing purposes, the module generator of the TE1400 can be used in demo mode without a license. A fully functional 7-day trial license is not available for this product. Restrictions in the demo version The module generator has the following restrictions without a license. Allowed are models with maximum : • 100 function blocks • 5 input signals • 5 output signals Modules created with a demo license may only be used for non-commercial purposes! TC1320/TC1220: TC3 [PLC /] C++ / Mat Sim (runtime license) The license TC1320 (or TC1220 with PLC license) is required to start a Twin CAT configuration with a module generated from Simulink®. Without activated license, the module and consequently the Twin CAT system cannot be started. In this case you get error messages relating to the license violation. You can generate a 7-day trial license, which enables initial tests without purchasing the license. TE1400 Version: 2.4.1 15

## Page 16

Up to version 1.2.xxxx.x 3.3 Quickstart Configuration of the Simulink® model The coder settings can be accessed via the Model Explorer in the View menu of the Simulink environment, via Code Generation (previously Real-Time Workshop) > Options in the Tools menu, or via the Configuration Parameters dialog. In the tree view, select Configuration -> Code Generation. Then, open the General tab and select Twin CAT.tlc as "System target file". Alternatively, use the Browse button to open a selection window and select Twin CAT Target as target system. In addition, a fixed-step solver must be configured in the solver settings, to ensure real-time capability of the Simulink model. Generating a Tc COM module from Simulink Generation of the C++ code or the Tc COM module can be started with the Build button (or Generate code) in the lower section of the window for the code generator options. If the option Publish module is activated under TC Build (default setting), the build process for generating executable files starts immediately after the C++ code has been generated, and a Tc COM module is created. Otherwise, the module generator stops after the C++ code and the project file for Visual Studio™ has been generated. For further information please refer to Publish Module [} 23]. Integration of the module in Twin CAT 3 After module export with "Publish" If the option Publish Module was enabled before the module was generated, the module will already be available in compiled form. A Twin CAT Module Class (TMC file) was created during this process and can be instantiated directly in the project. A Twin CAT Module Instance (TMI) is referred to as Tc COM object or module instance below. 16 Version: 2.4.1 TE1400

## Page 17

Up to version 1.2.xxxx.x Instances of the generated module can be integrated in a Twin CAT3 project any number of times. Tc COM objects are usually appended to the node Tc COM Objects via the Add New Item context menu. A selection list of the modules that are available on the system can be obtained via this option. The modules generated by Simulink can be found under TE1400 Module Vendor > Generated Modules. Compiling the code without "Publish" If the option Publish Module was disabled prior to the module generation, the C/C++ code pertaining to the module still has to be compiled, before it can be executed. The C++ project can be inserted into the Twin CAT project via Add Existing Item in the context menu of the C++ node. The C++ project file is located in the Build directory "<MODELNAME>_tct" and has the name of the module with the file extension .vcxproj. The module can then be created in the Twin CAT development environment (XAE): TE1400 Version: 2.4.1 17

## Page 18

Up to version 1.2.xxxx.x Multiple instances of the module can be created via the context menu of the parent node of the C++ project. These are listed under the project node. Further information about the build process of C++ projects in the Twin CAT development environment (XAE) and about the instantiation of modules created in this way can be found in section "Creating a Twin CAT3 C++ project". Cyclic call by a real-time task 18 Version: 2.4.1 TE1400

## Page 19

Up to version 1.2.xxxx.x Under the Context tab of the module instance, you will find all the contexts of the module, which have to be assigned to a real-time task. If Depend on: Task Properties are assigned automatically to tasks for which the cycle time and the priority match the displayed values. If there are no matching tasks or if the setting Depend on: Manual Config was selected, tasks can be created under System Configuration -> Task Management. Further information on cyclic calling of module instances can be found in section "Cyclic Call [} 42]". Data exchange with other modules or fieldbus devices The process images of the module inputs and outputs can be expanded below the module instance node in the Twin CAT development environment. Here you will find all ports that have been defined in the Simulink model with the aid of the function blocks In1 and Out1 (components of the standard Simulink library). All signals within this process images can be linked to signals of another process images via the Change Link context menu. 3.4 Twin CAT Library in Simulink® In Simulink®, Twin CAT-specific input and output function blocks can (not mandatory) be used to define the signals/buses connected to these function blocks as inputs or outputs in the subsequent Tc COM in Twin CAT. A common way is to use the standard input ports (In) and output ports (Out) of Simulink®. This is usually also the best practice way, unless the additional functions of the Twin CAT-specific input and output function blocks described below are required. The Twin CAT-specific input and output function blocks can be found in the Library Browser under Beckhoff Twin CAT Target. If you use the input and output function blocks provided by Beckhoff, you will benefit from the following additional functionalities, compared to the standard Simulink® input and output ports: • You can also define signals and buses from subsystems directly as inputs or outputs for Tc COM, without first transferring the signals/buses from the subsystem to the top system. TE1400 Version: 2.4.1 19

## Page 20

Up to version 1.2.xxxx.x • You can (not mandatory) store an automatic mapping to other Tc COM or I/Os in the function block parameters, so that the mapping is executed directly and automatically when the Tc COM is instantiated. • You can use initial values for inputs. To do this, set the Value of the Tc Module Inputs to any value. When using automatic mapping, please note that if the Tc COM is instantiated more than once in Twin CAT, you will end up with a mapping conflict which you must resolve by manual mapping. This option is therefore not recommended for multiple instantiations. In addition to Twin CAT-specific input and output function blocks, a Twin CAT Environment View Block is also provided. This can be used in the Simulink® environment to simply display Twin CAT and TE1400 versions on the system. Example A Simulink® model is created, which outputs two negated inputs. An input is placed in a subsystem, see figure below. The inputs and outputs of the model are automatically mapped to digital inputs and outputs via the properties of the TC Modules Input and Output. The necessary tree items can be found in Twin CAT 3 by selecting the desired input or output and then copying the string in the Variable tab under Full Name. 20 Version: 2.4.1 TE1400

## Page 21

Up to version 1.2.xxxx.x A list of shortcuts for quick access can be found in the documentation of the Automation Interface > API > ITc Sys Manager > ITc Sysmanager::Lookup Tree Item. When the Simulink® model described above is compiled and integrated into Twin CAT 3, a mapping to the corresponding inputs and outputs is automatically created. The automatically generated mappings are marked with a blue symbol to distinguish them from manual mapping, while manual mapping symbols appear white. TE1400 Version: 2.4.1 21

## Page 22

Up to version 1.2.xxxx.x 3.5 Parameterization of the code generation in Simulink Within MATLAB® Simulink® a wide range of configuration setting options for the Tc COM module to be generated are available. To this end the tree structure under Code Generation is extended with the entries Tc Build, Tc Interfaces, Tc External Mode and Tc Advanced. Many parameters can be modified in Twin CAT 3 at the module instance level; see Application of modules in Twin CAT [} 40]. 22 Version: 2.4.1 TE1400

## Page 23

Up to version 1.2.xxxx.x The corresponding setting options are described below. Tooltips Hover with the cursor over the text fields of the dialog boxes to bring up a detailed description of the option as a tooltip (pop-up window). 3.5.1 Module generation (Tc Build) The Publish mechanism can be used to compile Twin CAT C++ projects for several Twin CAT platforms and export them to a central Publish directory. In the first step, the modules for all selected platforms are built. Then, all files required for instantiation and execution of the module under Twin CAT 3 are copied to the Publish directory. The section "Export TC3 modules" under TC3 Engineering > C/C++ > Modules Handling describes how the publish mechanism is applied to TC3 C++ modules. The following section describes how Simulink has to be configured in order to export Twin CAT modules directly after the code has been generated with the aid of the Publish mechanism. Publish directory The files relating to exported modules are copied to the directory %Twin Cat3Dir%Custom Config\Modules\<MODULENAME>\. To instantiate the module on another development PC, this folder can be copied to the appropriate directory on the other computer. Application It makes sense to publish modules only once they have reached a stage at which they are only rarely modified, and if they are used in several Twin CAT projects. Otherwise, it may be more efficient to integrate the whole C++ project in the Twin CAT project, e.g. if the Simulink model is still under development and regular modifications are therefore to be expected, or if the module is only used in a special Twin CAT project. TE1400 Version: 2.4.1 23

## Page 24

Up to version 1.2.xxxx.x Configuration in Simulink The publish mechanism can be configured at Tc Build: (Export options for Twin CAT modules) Publish module: • disabled: The module generator is stopped once the C++ project has been generated. The generated C++ project has to be compiled manually, so that the module can be executed in Twin CAT 3. This can be done directly from the Twin CAT development environment, once the generated C++ project has been integrated into the Twin CAT project. • enabled: "Publish" is executed automatically, once the C++ project has been generated. The module is then available on the development PC in compiled form for all Twin CAT projects and can be instantiated directly in the Twin CAT development environment (XAE). The other Publish settings relate to the target platforms for which the module is intended. Due to the sequential building for the different platforms, these settings can have a significant effect on the module generation duration. "Generate code only" option The option Generate code only (in the Build process part of the window for the Code Generation settings) has no function, because the Twin CAT Publish mechanism is used instead of the MATLAB Make mechanism. Platform toolset: Enables selection of a certain platform toolset (compiler) for building the module drivers. The options available for selection depend on the Visual Studio versions installed on the system. If Auto is selected, a compiler is selected automatically. Publish configuration: Select Debug here in order to enable debugging of the exported block diagram in Twin CAT 3. If no debugging is required, e.g. in a release version, Release can be selected here. • Publish binaries for platform „<PLATFORMNAME>“: ◦ Select all Twin CAT platforms on which the module is intended to run. The drivers are then built successively for all selected platforms. 24 Version: 2.4.1 TE1400

## Page 25

Up to version 1.2.xxxx.x • Lowest compatible Twin CAT build: ◦ Enter the build number of the oldest Twin CAT version, with which the module is still to be compatible. If the module is subsequently used with an older Twin CAT version, it may fail to start. Also, the generated code may be uncompilable, if the SDK of an older Twin CAT version is used. The following table provides an overview of main Twin CAT version-dependent properties of the generated module: Property TC3 Build Description Large Data Areas < 4018 Data Areas > 16 MB are not supported >= 4018 Data Areas > 16 MB utilize the data areas of several Data Area IDs, using the "OBJDATAAREA_SPAN_xxx" macros. Project < 4018 During instantiation of a module that was a previously exported via subdirectory"_Mod "Publish", only the TMC description is imported into the Twin CAT ule Install" project. The module instance still refers to files within the Publish directory [} 23]. To load the Twin CAT project on other development computer, the Publish directories of the modules in use have to be copied manually into to the corresponding directories of the other computers. Otherwise the project cannot be activated, and the block diagram is not displayed. >= 4018 During instantiation of an exported module, all associated files are copied to subdirectory "_Module Install" of the project directory. The project can now be opened on another development PC (even if it is compressed as an archive), without having to copy additional files manually. Another advantage is that the files in the Publish directory [} 23] are now completely decoupled from the Twin CAT project. The module description, which is part of the Twin CAT project after it is instantiated, and the associated files (e.g. the drivers) are kept consistent. Files in the Publish directory can be overwritten, while the project uses a different version of the module up to "Reload TMC" and can still be re-activated on a target system. Pre Code Generation / Post Code Generation / Post Publish callback: MATLAB functions can be entered here, which are called before and after the code generation, or after Publish: (callback sequence) TE1400 Version: 2.4.1 25

## Page 26

Up to version 1.2.xxxx.x To execute model- or module-specific actions, the structure cg Struct can be accessed here. It contains the following subelements: Name Value Comment Model Name Name of the Simulink model Start Time Return value of the MATLAB function "now ()" at the start of the code generation Build Directory Current build directory From "Post Code Generation" Module Name Name of the generated Twin CAT module From "Post Code Generation" Module Class Id Class Id of the generated Twin CAT module From "Post Code Generation" <User Defined> Additional custom fields can be added to the structure, in order to transfer additional information to subsequent callbacks. For example, in the simplest case additional information could then be output between the individual module generation phases: See also: Callback samples [} 63] Signing Certificate for x64 Windows Loader: 26 Version: 2.4.1 TE1400

## Page 27

Up to version 1.2.xxxx.x Defines the certificate used for signing of the driver for the "Twin CAT RT (x64)" platform. The default value $ (TWINCATTESTCERTIFICATE) refers to the environment variable TWINCATTESTCERTIFICATE, which is described under "Driver signing" (TC3 Engineering > C/C++ >Preparation). Alternatively, the certificate name can be entered directly here, or different placeholders can be used, depending on the desired signing behavior: Value Behavior $<ENVIRONMENT This placeholder is resolved at an early stage during code generation. The VARIABLE> value is written into the generated C++ project. If the specified environment variable is not found, the code generation process terminates with a corresponding error message. $(ENVIRONMENT VARIABLE) This placeholder is not resolved until the generated C++ project is built. If the environment variable is not found, only a warning appears. The x64 driver can then still be built, although it cannot be loaded by the Windows loader on a target system. Certificate Name The name of the certificate is written into the generated C++ project. If the field remains empty, only a warning appears. The x64 driver can then still be built, although it cannot be loaded by the Windows loader on a target system. 3.5.2 Data exchange (Tc Interfaces) Configuration in Simulink Depending on the Simulink model, there are several groups of internal variables in addition to the input and output variables. ADS access and the process image type can be configured as required. These settings affect how the variables are linked with other process images in the Twin CAT development environment, and how they can exchange data. The following groups can be configured: Group Description Input Model inputs Output Model outputs Parameter Model-specific parameters: Parameters of Simulink blocks that can be "set" Block IO Global output signals of Simulink blocks: Internal signals for which a "test point" was set or which were declared as global due to code optimizations of the code generator. Cont State Continuous state variables DWork Time-discrete state variables On the configuration page TC Interface in the coder settings, there are several possible settings for each of these variable groups. The options available for selection depend on the group, i.e. not all the described options are available in all cases: Parameter Options GROUP access TRUE The module enables access to variables of this group. (checkbox) FALSE The module denies access to variables of this group. ADS access Only relevant if "GROUP access"=TRUE No ADS access No ADS access Read Only_No Symbols No ADS write access, ADS communication is only possible via the Index group and the Index Offset information Read Write_No Symbols Full ADS access, ADS communication is only possible via the Index group and the Index Offset information Read Only_Create Symbol No ADS write access, s ADS symbol information is generated TE1400 Version: 2.4.1 27

## Page 28

Up to version 1.2.xxxx.x Parameter Options Read Write_Create Symb Full ADS access, ols ADS symbol information is generated Process image Only relevant if "GROUP access"=TRUE No Data Area Link to Data Area or I/O: no Link to Data Pointer: no Standard Data Area Link to Data Area or I/O: no Link to Data Pointer: yes Input-Destination Link to Data Area or I/O: yes Data Area Link to Data Pointer: yes Output-Source Data Area Link to Data Area or I/O: yes Link to Data Pointer: yes Internal Data Area Link to Data Area or I/O: no Link to Data Pointer: no Retain Data Area Enables linking to a "retain handler" (see retain data) for remanent data management. The above setting options can be realized in the following mask via the corresponding drop-down lists. The restore default settings option can be used to undo all changes and reset the default settings. The default settings are shown in the diagram above. 3.5.2.1 Retain data This section describes the option to make data available even after an ordered or spontaneous system restart. The NOV-RAM of a device is used for this purpose. The EL6080 cannot be used for these retain data, because the corresponding data must first be transferred, which leads to corresponding runtimes. The following section describes the retain handler, which stores data and makes them available again, and the application of the different Twin CAT 3 programming languages. 28 Version: 2.4.1 TE1400

## Page 29

Up to version 1.2.xxxx.x Configuring a retain device 1. The retain data are stored and made available by a retain handler, which is part of the NOV-DP-RAM device in the IO section of the Twin CAT solution. Create a NOV-RAM DP Device in the IO area of the Solution. 2. Create one or more Retain Handler below this device. Storage location: NOVRAM 3. Configure the NOV-DP RAM device. In the Generic NOV-DP-RAM Device tab, use Search... to define the area to be used. 4. An additional retain directory for the symbols is created in the Twin CAT boot directory. Using the retain handler with a PLC project In a PLC project the variables are either created in a VAR RETAIN section or identified with the attribute Tc Retain. PROGRAM MAIN VAR RETAIN l: UINT; k: UINT; END_VAR VAR TE1400 Version: 2.4.1 29

## Page 30

Up to version 1.2.xxxx.x {attribute 'Tc Retain':='1'} m: UINT; x: UINT; END_VAR Corresponding symbols are created after a "Build". The assignment to the retain handler of the NOV-DP-RAM device is done in column Retain Hdl. If self-defined data types (DUTs) are used as retain, the data types must be available in the Twin CAT type system. You can either use the option Convert to Global Type or you can create structures directly as STRUCT RETAIN . However, the Retain Handler then handles all occurrences of the structure. Retain data cannot be used for POUs (function blocks) as a whole. However, individual elements of a POU can be used. Using the retain handler with a C++ module In a C++ module a data area of type Retain Source is created, which contains the corresponding symbols. At the instances of the C++ module, a retain handler of the NOV-DP-RAM device to be used for this data area is defined in column Retain Hdl. 30 Version: 2.4.1 TE1400

## Page 31

Up to version 1.2.xxxx.x Conclusions When a retain handler is selected as target in the respective project, the symbols under retain handler and a mapping are created automatically after a "Build". 3.5.3 External mode (Tc External Mode) Simulink offers various execution modes. In addition to "Normal mode", in which the Simulink model is calculated directly in the Simulink environment, an "External mode" is available. In this mode Simulink only acts as a graphical interface, without performing calculations in the background. Once the model with the corresponding settings has been converted into a Tc COM module, Simulink can link to the instantiated Tc COM object that is currently running in the Twin CAT real-time environment. In this case the internal module signals are transferred to Simulink via ADS, where they can be recorded or shown with the corresponding Simulink blocks. Parameters that were modified in Simulink can be written online into the Tc COM object. However, such an online parameter modification is only possible for parameters that are defined as "tunable". Configuration of the module generator An External Mode connection is only possible if the generated module supports it. To this end External Mode must be activated in the settings for the Simulink Coder under TC External Mode before the module is generated: TE1400 Version: 2.4.1 31

## Page 32

Up to version 1.2.xxxx.x In addition, there is a button for preconfiguring the "External Mode" connection. For information on configuring the "External Mode" connection see section "Establishing a connection". Further parameters under this tab are: Parameter Description Default value Allow real-time execution Defines the default value of the module parameter FALSE commands via External Mode [} 32] "Allow Execution Commands", which specifies whether the module should process start and stop commands from Simulink. Special behavior of this parameter: The module parameter "Allow Execution Commands" is Read Only, if the value is FALSE. In this case the code is optimized in terms of the execution time and therefore does not contain the code sections for processing start/stop commands. By default wait on External Mode Default value of the module parameter [} 32] FALSE start command "Wait For Start Command" Module parameter For configuring the behavior in external mode (on the XAE side) the parameter External Mode is defined as a structure in generated modules, which contains the following elements: Parameter Description Default value Activated Read Only. Determines whether the generated module Setting the module supports the external mode. generator Allow Execution Command Only relevant if "Activated"=TRUE. Setting the module s Read Only if the default value is FALSE, since in this generator case the code sections are not included in the generated code. That is, this parameter can disable the processing of start and stop commands, but it cannot enable it, if it was not created during code generation. TRUE Enables Simulink to start and stop the module execution via the "External Mode" connection. FALSE Start and stop commands are ignored in the module. 32 Version: 2.4.1 TE1400

## Page 33

Up to version 1.2.xxxx.x Parameter Description Default value Wait For Start Command Only relevant if "Activated" is TRUE and Setting the module "Allow Execution Commands" is TRUE generator TRUE When Twin CAT has started the module is not executed automatically but waits for the start command from Simulink. FALSE The module starts immediately with the assigned Twin CAT task. (default) For further information on adapting the module parameters in XAE see section "Parameterization of the generated module". Establish connection from Simulink® The "External Mode" connection can be started from Simulink via the Connect to Target icon, which appears in the Simulink toolbar when External mode is selected: If connection data are missing or incorrect, the following dialogs are displayed one after the other, so that the user can reconfigure the connection: The first dialog box shows a list of target systems, the second box shows a list of the available module instances on the selected target system. In the following dialog the user can specify whether the new connection data should be stored. Once the connection data have been stored, the connection is established automatically, if the connection data point to a valid and suitable module. The stored connection data can be modified at any time in the coder settings via the button Setup ADS Connection under TC External Mode. TE1400 Version: 2.4.1 33

## Page 34

Up to version 1.2.xxxx.x Transfer of the calculation results for "minor time steps" Under certain circumstances, signal values transferred via ADS may differ from the values that were copied to other process images via "output mapping". See Transfer of the calculation results for "minor time steps" [} 59]. Parameterization in Twin CAT Large models necessitate communication of large data volumes between Twin CAT and Simulink. This takes place via ADS. On the Twin CAT side, buffers are created as part of the process. The buffers can be adapted for incoming and outgoing data (default: 10,000 bytes), and the timeout threshold can be adjusted (default: 3.0 seconds). 3.5.4 Advanced settings (Tc Advanced) The advanced settings can be used to set parameters that affect the execution and call behavior of the module and also the display and properties of the exported block diagram: 34 Version: 2.4.1 TE1400

## Page 35

Up to version 1.2.xxxx.x Execution behavior of the generated module In Twin CAT 3, a Simulink module can be called directly from a cyclical real-time task or from another Twin CAT module, e.g. a PLC. The behavior of the generated module class can be parameterized in Simulink under Tc Advanced. To specify individual module instances behavior that differs from the class behavior, the execution type can be adjusted in the Twin CAT 3 development environment via the Tc COM parameter list in the Parameter (Init) tab or via the parameter range of the block diagram. Configuration of the default settings in Simulink TE1400 Version: 2.4.1 35

## Page 36

Up to version 1.2.xxxx.x The default values of the call parameters can be configured in the Simulink coder settings, in order to reduce the parameterization effort for the individual objects (module instances): Task assignment The assignment type for a Twin CAT task can be defined under Task assignment. "Depend On" setting Description Manual Config The tasks can be assigned manually in the context table, by selecting or entering the object IDs of the tasks in the Task column. The selected tasks must meet all the criteria that were configured via the "Call parameters" Parent Object Can only be used if the parent node of the module instance is a task in the project tree. In this case, the parent object is used as cyclic caller of the module. Task Properties The tasks are automatically assigned to the module when the cycle time and the priority correspond to the values specified in Simulink. If there is no corresponding task, new tasks can be created and parameterized as required under the node "System Configuration -> Task Management". If the Task properties option is active, the priority of the corresponding task must be specified. Cyclic call If the value "Cyclic Task" was set for the call parameter "Call By", all task cycle times are verified when the module starts. The conditions for the cycle times of the associated tasks can be specified via the call parameter "Step size". If all cycle times meet their conditions, the module can start. Otherwise the module start and the Twin CAT runtime terminate with corresponding error messages. Call from another Twin CAT module 36 Version: 2.4.1 TE1400

## Page 37

Up to version 1.2.xxxx.x If the call parameter "Call By" was set to the value "Module", the assigned tasks do not call the module automatically. To call the generated Tc COM module via another module instead, the interfaces of that module can be accessed. This can be done from a C++-module or from a Twin CAT PLC, as shown in "Calling the generated module from a PLC project [} 44]". Execution order In modules that were created with TE1400 from version 1.1, an execution order can be specified, in order to optimize the jitter and the response times for the respective application. Older versions use always the order "State Update After Output Mapping". The following table illustrates the advantages and disadvantages of the supported call sequences: • Io At Task Begin - Longest response time of all options + Smallest possible jitter in response time • State Update After Output Mapping + Shortest response time o Average jitter in response time Results from "Minor Time Steps" are transferred via ADS Signal values transferred via ADS may differ from the values that were copied to other process images via "output mapping". The reason is that "State update" may overwrite values, depending on the selected solver. For further information see Transfer of the results from "Minor Time Steps" [} 59]. • State Update Before Output Update o Average response time - largest jitter in the response time, since dependent on execution times for "State update" and "Output update Step size adjustment (step size) The behavior of the Tc COM that was generated with regard to the step size (corresponding to the cycle time in Twin CAT) is defined here. • Require Matching Task Cycle Time The module expects the "Fixed Step Size" specified in Simulink as cycle time for the allocated task. If another cycle time is set, the Tc COM start sequence is aborted with an error message. Multitasking modules expect that all allocated tasks were configured with the associated Simulink sample time. • Use Task Cycle Time The module enables cycle times, which differ from the "Fixed Step Size" specified in Simulink. In multitasking modules, all task cycle times must match the corresponding Simulink sample times. If the cycle time deviates from the Simulink sample time, a warning is issued in Twin CAT indicating the deviation. • Use Model Step Size The module uses the sample time set in Simulink for all internal calculations. This setting is primarily intended for use in simulations within the Twin CAT environment and can be used for accelerated or slowed-down simulation. Auto start cyclic execution TE1400 Version: 2.4.1 37

## Page 38

Up to version 1.2.xxxx.x If this option is enabled (default), the Tc COM module is set to OP state on startup, and the generated model code is executed directly. If this option is disabled, the module is also set to OP state, but the model code is not executed. In the instantiated module this option can be found in the “Parameter (init)” tab and in the parameter range of the block diagram under "Module parameters" as variable "Execute Model Code", where it can also be adjusted. Adapting the display, debugging and parameterizability Modules generated from Simulink offer a wide range of options for parameterizing the module and model parameters, even after code generation and instantiation. The parameterization options can be adjusted before the code generation, so that in the development phase debugging options are enabled and parameters of masked subsystems are resolved, which are to be hidden in the release version. The use of modules in Twin CAT 3 requires a display that can be configured according to requirements. For example, debugging information can be included in the block diagram export. The following coder parameters enable adaptation of the block diagram export, the parameter and signal representation, and advanced functions: Parameters Description Default value Monitoring execution TRUE The execution times of the TC module are calculated and FALSE times made available as ADS variable for monitoring. FALSE Calculation of execution times disabled. Export block diagram TRUE The Simulink block diagram is exported and displayed in TRUE XAE under its "Block Diagram" tab once the module has been instantiated. FALSE The Simulink block diagram is not exported, and the "Block Diagram" tab is not displayed in XAE. Resolve masked Only relevant if "Export block diagram"=TRUE. FALSE Subsystems 38 Version: 2.4.1 TE1400

## Page 39

Up to version 1.2.xxxx.x Parameters Description Default value TRUE Masked subsystems are dissolved. All contents of masked subsystems are visible to users of the generated module in XAE. FALSE Masked subsystems are not resolved. The contents of the masked subsystems are not visible to users of the generated module. Access to Assign to Variables of this group, which belong to a block within an Variable Group, not parent unresolved subsystem, are assigned to the next higher, referenced by any block visible subsystem. block Hide in Variables of this group, which cannot be allocated to a block Simulink block, are not displayed in the block diagram. diagram Hide, No Variables of this group, which cannot be allocated to a access Simulink block, are hidden and made inaccessible. This is only possible, if "No Data Area" was selected for the process image of this variable group (configuration in Simulink [} 27]). Export block diagram TRUE Debugging information generated for the block diagram TRUE debug information enables allocation of row numbers in the generated code to displayed blocks. Required for debugging [} 201]. FALSE No debugging information is generated Show parameter table TRUE The "Parameter (Init)" tab is displayed in XAE and TRUE in XAE enables parameterization of the module via the parameter list. FALSE The "Parameter (Init)" tab is not displayed in XAE. Use original input and FALSE Inputs and outputs of the module have the names that FALSE output block names were created by the Simulink Coder as variable names. Spaces and special characters are not allowed. TRUE Inputs and outputs of the module have the names that were used in the Simulink model. The names may include spaces and special characters. Set testpoints at Scope blocks are ignored by the Simulink coder, i.e. the Simulink Scope signals signals are generally not available in the generated before code generation Twin CAT module and cannot be displayed. To force the generation of variables for these signals, test points can be defined in the Simulink model. This parameter can be used to automatically create test points for all scope input signals. Maximum number of Specifies the maximum number of array elements to be visible array elements displayed in the Twin CAT development environment. Larger arrays cannot be opened, and the elements cannot be linked individually, for example. Hide Datatypes defined in TMC In each TMC file the required data types are specified and notified in the system through import in Twin CAT 3. The data types are assigned a unique GUID. Accordingly, the GUID remains unchanged if a TMC file is re-imported in which a data type has not changed. If enums or structures are used, for example, changes (e.g. additional model parameters in a structure) may result in the data type name of the modified data type and the previous data type being identical, with different GUIDs. This unique assignment via GUIDs is not available in the PLC, where the data type name is used for identification. If a Tc COM instance is called from the PLC, a mechanism must be provided that prevents this kind of ambiguity. TE1400 Version: 2.4.1 39

## Page 40

Up to version 1.2.xxxx.x The Hide Data Types defined in TMC ensures that the last imported TMC or its data type names and data types are used for the PLC. Any existing data type names with other data types are hidden for the PLC. See also How do I resolve data type conflicts in the PLC project? [} 61]. Skip caller verification This option disables queries when calling a Tc COM from the PLC, see Calling the generated module from a PLC project [} 44]. This leads to faster processing of the module call. On the other hand, the user must make sure that the call is executed correctly and from the correct context. This option should only be activated if it is necessary for performance reasons, and if the project has previously been tested with activated queries. PLC Function Block The POU type for calling a Simulink object from the PLC can be defined in more detail here. A more detailed description can be found under "Calling the generated module from a PLC project [} 44]". OEM license check Optionally, a generated Tc COM can be linked to an OEM license. This OEM license is checked when starting Tc COM (besides the Beckhoff runtime license TC1220 or TC1320) in Twin CAT 3. If no valid license is available, the module does not start up and an error message appears. How to create and manage OEM certificates can be found under Twin CAT3 > TE1000 XAE > Technologies > Security Management. In Simulink, you can insert the OEM License Check by naming your OEM ID and your license ID or multiple license IDs to be queried. You can find your OEM ID in the Security Management Console (Extended Info activated). The license ID can be viewed by double-clicking on the corresponding license entry in Twin CAT under System > License. Both IDs are also included in the generated License Request File when a Request File is generated with your OEM license. Note GUID form The IDs to be entered must be transferred as a string in GUID form, i.e. in Simulink the data must be entered in quotation marks. No spaces are allowed in the specifications. Sample entry: OEM ID: '{B0D1D1B7-99AB-681G-F452-F4B3F1A993C0}' License ID: 'Name1,{6B4BD993-B7C3-4B72-B3D1-681FE7DDF3D1}' 3.6 Application of modules in Twin CAT The data of modules exported from Simulink are stored in directory %Twin Cat3Dir\Custom Config\Modules\<MODULENAME>\%, and from where they can be copied to any number of development PCs with Twin CAT XAE. A Simulink license is not required on these systems. Twin CAT nevertheless offers further extensive parameterization options for the generated modules. Cyclic execution of Tc COM modules through calls via a task and calls of modules from a PLC project are described below. 3.6.1 Parameterization of a module instance Parameter representation in XAE The block diagram in the Browser Parameters tab: 40 Version: 2.4.1 TE1400

## Page 41

Up to version 1.2.xxxx.x In general, Tc COM modules can be parameterized via the parameter list under the Parameter (Init) tab in the Twin CAT 3 development environment (XAE). Simulink modules can also be parameterized via the block diagram, if block diagram export is enabled in the Simulink coder settings under Tc Advanced. Module- and model-specific parameters The parameter list contains module- and model-specific parameters. Examples of module-specific parameters are "Call Parameter [} 42]" or "External Mode Parameter [} 31]". In the block diagram these parameters are only shown in the parameter section (on the right-hand side of the window) if the top level of the block diagram ("<root>“) is selected. Model-specific parameters are defined as "tunable" parameters in the Simulink blocks. The parameter list displays them as a structure. In the block diagram these model parameters are assigned to a block or indeed several blocks. The values can be adjusted when the corresponding block is selected. The parameter values (startup, prepared or online) can then be adjusted in the drop-down menu of the property table or in the parameter window directly in the block diagram: Hover with the mouse over the name of the drop-down menu (in this case Model Parameters. Kp) to show its ADS information as a tooltip. Right-click on the name to copy the ADS symbol information to the clipboard. Access to the model-specific parameters is only possible, if • the Simulink optimization option Inline parameters is disabled, or workspace variables were selected as model parameters in the advanced options under Inline parameters TE1400 Version: 2.4.1 41

## Page 42

Up to version 1.2.xxxx.x • ADS access to parameters is enabled under Tc interfaces (Data exchange (Tc Interfaces) [} 27]). "Default", "Startup", "Online" and "Prepared" The following value types can be found in the drop-down menu of the Property table of the block diagram: • Default values are the parameter values during code generation. They are invariably stored in the module description file and enable the manufacturing settings to be restored after parameter changes. • Startup values are stored in the Twin CAT project file and downloaded to the module instance as soon as Twin CAT starts the module instance. Startup values for the input process image can also be specified in Simulink® modules. This allows the module to be started with non-zero input values, without the need for linking the inputs with other process images. Internal signals and output signals have no starting values, since they would, in any case, be overwritten in the first cycle. • Online values are only available if the module was started on the target system. They show the current parameter value in the running module. This value can also be changed during runtime. Although in this case the corresponding input field has to be enabled via the context menu, in order to prevent accidental inputs. • Prepared values can be specified whenever online values are available. They can be used to save various values, in order to write them consistently to the module. If prepared values have been specified, they are displayed in a table below the block diagram. The buttons to the right of the list can be used to download prepared values as online values and/or save them as starting value, or delete them. 3.6.2 Executing the generated module under Twin CAT In Twin CAT 3, a Tc COM module can be called directly from a cyclical real-time task or from another module, e.g. a PLC. To specify the behavior of the individual module instances, the method of execution can be defined in the Twin CAT 3 development environment. Context settings A list of all Simulink sample times for the module can be found under the Context tab of the module instance. If "Single Tasking" is selected in the solver settings of the Simulink model, the number of tasks is limited to 1: 42 Version: 2.4.1 TE1400

## Page 43

Up to version 1.2.xxxx.x For each of the contexts listed in the table a task has to be specified, through which the module is to be called. The task assignment varies, depending on the settings under "Depend On": "Depend On" setting Description Manual Config The tasks can be assigned manually in the context table, by selecting or entering the object IDs of the tasks in the Task column. The selected tasks must meet all the criteria that were configured via the "Call parameters". Parent Object Can only be used if the parent node of the module instance is a task in the project tree. In this case, the parent object is used as cyclic caller of the module. Task Properties The tasks are automatically assigned to the module when the cycle time and the priority correspond to the values specified in Simulink. If there is no corresponding task, new tasks can be created and parameterized as required under the node "System Configuration -> Task Management". Configuration in XAE Parameters that affect the behavior of Simulink module execution are: Parameter Options / description Call By Task The module automatically appends itself to the tasks specified in the context settings [} 42], when Twin CAT is switched to Run mode. The tasks call the module cyclically until Twin CAT is stopped. Modules The module is not called directly by the assigned tasks, but it can be called from the PLC or another module. Important: The calling module must be assigned the same task as the Tc COM objects to be called. Step size Require Matching T The module expects the "Fixed Step Size" specified in Simulink as cycle ask Cycle Time time for the allocated task. Multitasking modules expect that all allocated tasks were configured with the associated Simulink sample time. Otherwise the module (and Twin CAT) cannot be started. The start sequence is then aborted with corresponding error messages. Use Task Cycle Tim The module enables cycle times, which differ from the "Fixed Step Size" e specified in Simulink. In multitasking modules, all task cycle times must match the corresponding Simulink sample times. Use Model Step Siz The module uses the Sample Time set in Simulink for all internal e calculations. This setting is primarily intended for use in simulations within the Twin CAT environment. Execution Seq This parameter is only available in modules that were generated with TE1400 Version 1.1 or uence higher. It can be used to adjust the order of the calculation and communication process, in order to optimize jitter and reaction time for the respective application. Modules generated with TE1400 version 1.0 always use the order "State Update After Output Mapping". The differences between the different options are described under "order of execution [} 37]". IOAt Taskbeginn Execution order: Input mapping -> Output mapping -> State update -> Output update -> External mode processing -> ADS access Stateupdate After Execution order: Output Mapping Input mapping -> Output update -> Output mapping -> State update -> External mode processing -> ADS access Stateupdate Befor Execution order: e Outpunk Update Input mapping -> State update -> Output update -> Output mapping -> External mode processing -> ADS access Access to these parameter in the Twin CAT development environment (XAE) is provided via the object node under the following tabs: • Parameter (Init) : TE1400 Version: 2.4.1 43

## Page 44

Up to version 1.2.xxxx.x • Block diagram : If none of these tabs are displayed, the Simulink coder settings need to be adjusted for parameter representation in XAE. 3.6.3 Calling the generated module from a PLC project If the call parameter "Call By" was set to the value "Module", the assigned tasks do not call the module automatically. To call the generated Tc Com module via another module instead, the interfaces of that module can be accessed. This can be done from a C++ module or, as shown below, from the Twin CAT PLC. A PLCopen XML file is generated during code generation. This file can be found in the build directory <MODEL_DIRECTORY>\<MODEL_NAME>_tct and - if the module was exported via the Publish step - also in the Publish directory [} 23] of the module. The file contains POUs that simplify calling a Simulink object from the PLC by encapsulating the handling of the interface pointers. The POUs can be imported via Import PLCopen XML in the context menu of a PLC project node. The following descriptions apply from version 1.2.1216.0 of TE1400! Configuration in Simulink In the settings under Tc Advanced, Call By is initially set to Module (can be changed later in Twin CAT Engineering). 44 Version: 2.4.1 TE1400

## Page 45

Up to version 1.2.xxxx.x The parameter Skip caller verification is visible from TE1400 version 1.2.1230. The parameter PLC Function Block (Tc COM wrapper) is available from TE1400 version 1.2.1216.0: The following options are available for selection: Option Description None No PLCopen XML file is generated Generic FB only Only the function block FB_Tc Mat Sim Object (see also here), which applies to all modules generated with TE1400 and data types used by it, is generated. The data exchange takes place via generic methods. The user must know module-specific data such as byte-sizes, parameter index offsets or Data Area IDs. Version note: Up to and including TE1400 1.2.1216.0, this generic FB can only be used in a meaningful way, if an FB derived from it is implemented, which deals with the initialization of internal variables. From version 1.2.1217.0 additional methods are available, which enable direct initialization, i.e. without derived FB. Module specific FB In addition to the generic FB_Tc Mat Sim Object, the module-specific function block FB_<Module Name> and associated data types are generated. The structure of the input and output variables exactly matches the structure of the corresponding data areas of the module. For exchanging data, the input and output variables can be assigned directly, without having to explicitly specify the size of the data areas or the Data Area IDs, for example. Module specific FB The module-specific function block FB_<Module Name> is assigned additional with properties for properties. Based on these properties, module parameters can be read and also all parameters written, if appropriate. For each module parameter the function block is assigned two properties: "Prameter Name_Startup" and "Parameter Name_Online". TE1400 Version: 2.4.1 45

## Page 46

Up to version 1.2.xxxx.x The module-specific function block FB_<Module Name> is derived from FB_Tc Mat Sim Object and provides the methods and properties described above. In addition, the following properties are implemented: Public Properties: Method Data type Description Init Data ST_<Module Name Stores the startup values of the module parameters for >_Init Data initializing a module instance. During module state transitions the values are transferred to the module from INIT to PREOP via Set Obj State(). Required for dynamic instantiation. <Parameter Name>_Startup <Parameter Type> Available for all parameters, if the coder is configured accordingly. Enables transparent access to the corresponding element of the Init Data structure (read/ write). <Parameter Name>_Online HRESULT Available for all parameters, if the coder is configured accordingly. Reads or writes the online values of the corresponding module parameter. Notes regarding FB with properties for all parameters If Process image is set to Internal Data Area under Tc Interfaces in the Parameter access area, a property is created for all parameters. These must then be read and written as an entity: PROGRAM MAIN VAR // declare function block (details see below) fb Control : FB_Tct Smpl Temp Ctrl(oid := 16#01010010); // local PLC variable Model Parameters : P_Tct Smpl Temp Ctrl_T; END_VAR // read all model parameters Model Parameters := fb Control. Model Parameters_Online; // change value Model Parameters. Kp := 20; // write all model parameters fb Control. Model Parameters_Online := Model Parameters; If Process image is set to No Data Area under Tc Interfaces in the Parameter access area, a separate property is created for each model parameter. These can then be read and written directly without a local PLC variable. Fb<Model Name>. Model Parameters_<Parameter Name>_Online Referencing a static module instance: The FB can be used to access module instances previously created in the XAE, e.g. under System > Tc COM Objects. For this static case, the object ID of the corresponding module instance must be transferred during declaration of the FB instance: fb Static : FB_<Module Name>(oid:=<Object Id>); The object ID can be found in the instance of Tc COM under the Object tab. Sample code The following code sample illustrates the application of a module-specific function block in a simple PLC program in ST code, using an object of module class "Temp Contr" with Object ID 0x01010010 as an example: PROGRAM MAIN VAR // declare function block with ID of referenced Object fb Temp Contr : FB_Temp Contr(oid:= 16#01010010 ); // input process image variable n Input Temperature AT%I* : INT; // output process image variable b Heater On AT%Q* : BOOL; 46 Version: 2.4.1 TE1400

## Page 47

Up to version 1.2.xxxx.x END_VAR IF (fb Temp Contr. State = TCOM_STATE. TCOM_STATE_OP) THEN // set input values fb Temp Contr.st Input. Feedback Temp := n Input Temperature; // execute module code fb Temp Contr. Execute(); // get output values b Heater On := fb Temp Contr.st Output. Heater On; END_IF Generating and referencing a dynamic module instance: If <Object Id> = 0, the FB attempts to generate an instance of the Tc Com module dynamically: fb Dynamic : FB_<Module Name>(oid:=0); In this case, the module instance does not appear in the XAE configuration tree, but only appears at runtime (i.e. after the initialization of the PLC instance) in the "Project Objects" table of the System > Tc COM Objects node. A prerequisite for dynamic instantiation of a Tc COMmodule if that the corresponding "Class Factory" is loaded. To this end, the Load checkbox (or the TC Loader checkbox if the "Twin CAT Loader" is used) must be set for the "Class Factory" of the module under the Class Factories tab of the System > Tc COM Objects node. The name of the "Class Factory" of a Tc COM module generated from Simulink usually matches the module name, although the Class Factory name is limited to fewer characters. A further condition for dynamic instantiation of a module is adequate availability of dynamic memory. To this end, the ADS router memory must be set to an adequate size. Sample code: PROGRAM MAIN VAR // declare function block fb Temp Contr_Dyn : FB_Temp Contr(oid:= 0 ); // input process image variable n Input Temperature AT%I* : INT; // output process image variable b Heater On AT%Q* : BOOL; // reset error code and reinitialize Object b Reset: BOOL; // initialization helpers st Init Data : ST_Temp Contr_Init Data; b Initialized : BOOL; END_VAR IF (NOT b Initialized) THEN st Init Data := fb Temp Contr_Dyn. Init Data; // read default parameters // adapt required parameters: st Init Data. Context Info Arr_0_Task Oid := 16#02010020; // oid of the plc task st Init Data. Context Info Arr_0_Task Cycle Time Ns := 10 * 1000000; // plc task cycle time in ns st Init Data. Context Info Arr_0_Task Priority := 20; // plc task priority st Init Data. Call By := Tct Module Call By Type. Module; st Init Data. Step Size := Tct Step Size Type. Use Task Cycle Time; // set init data, copied to module the next time it switches from INIT to PREOP: fb Temp Contr_Dyn. Init Data := st Init Data; b Initialized := TRUE; ELSIF (fb Temp Contr_Dyn. State<TCOM_STATE. TCOM_STATE_OP) THEN // try to change to OP mode fb Temp Contr_Dyn. State := TCOM_STATE. TCOM_STATE_OP; ELSIF (NOT fb Temp Contr_Dyn. Error) THEN // set input values fb Temp Contr_Dyn.st Input. Feedback Temp := n Input Temperature; // execute module code fb Temp Contr_Dyn. Execute(); // get output values b Heater On := fb Temp Contr_Dyn.st Output. Heater On; END_IF IF (b Reset) THEN IF (fb Temp Contr_Dyn. Error) THEN fb Temp Contr_Dyn. Reset Hresult(); END_IF fb Temp Contr_Dyn. State := TCOM_STATE. TCOM_STATE_INIT; END_IF TE1400 Version: 2.4.1 47

## Page 48

Up to version 1.2.xxxx.x Task context setting The PLC task from which the call is made must be configured in the context settings [} 42] of a static module instance. The object ID of the PLC task must be transferred to a dynamic module instance via the Init Data structure. If available, the corresponding Init Data element can be set via the property "Context Info Arr_<context Id>_Task Oid_Startup". When the Tc COM module is called, a context verification is performed. An error message is displayed if the context is not correct. This verification takes time and is performed with each call. For this reason, the verification can be deactivated via the checkbox Skip caller verification in the Tc Advanced dialog, see Skip caller verification [} 40]. Import of several PLCopen-XML: FB_Tc Mat Sim Object The generic function block FB_Tc Mat Sim Object is identical for all modules generated with TE1400 (from V1.2.12016.0). Even if it is used for different modules, it only has to be imported once into the PLC project. Description of the function block: Public Methods Method Return data type Description Execute HRESULT Copies the data of the Input Data Area structures from the FB to the module instance (of the object), calls the cyclic methods of the object and copies the data from the output data areas back into the corresponding data structures of the FB Get Obj Para HRESULT Reads parameter values from the object via PID (Parameter ID = ADS Index Offset) Set Obj Para HRESULT Writes parameter values to the object via PID (Parameter ID = ADS Index Offset) Reset Hresult Acknowledges error codes that have occurred during initialization of the FB or when calling "Execute()". Save Online Parameters For Init HRESULT Reads the current online values of the parameters from the object and saves them in the parameter structure after the FB variable p Init Data, if it exists Set Obj State HRESULT Tries to bring the TCOM_STATE of the object to the required target state, step-by-step Assign Class Id From TE1400 1.2.1217.0: Sets the expected class ID for the case of referencing a static object. This is compared with the class ID of the referenced module to avoid problems due to incompatibilities. If no class ID is assigned, this compatibility check is omitted. To generate a dynamic object, the class ID must be defined via this method. Set Init Data Info From TE1400 1.2.1217.0: Transfers the pointer to the Init Data structure to be used. This structure must be created when dynamic objects are used. It must be initialized with parameters, as required. For static objects, this structure is optional. It 48 Version: 2.4.1 TE1400

## Page 49

Up to version 1.2.xxxx.x Method Return data type Description enables subsequent re-initialization of the object. In this case, the structure may also be initialized by calling "Save Online Parameters For Init". Set Data Area Info From TE1400 1.2.1217.0: Transfers the pointer to an array of Data Area information of type ST_Tc Mat Sim Object Data Area Info, and the number of elements in that array. This information is required for cyclic data exchange within the "Execute" method. Public Properties Method Data type Description Class Id CLSID Returns the Class Id of the module Error BOOL Returns TRUE if a pending error requires acknowledgement Error Code HRESULT Returns the current error code State TCOM_STATE Returns the current TCOM_STATE of the object, or tries to bring it into the target state, step-by-step Referencing a module instance Just like the module-specific FB derived from it, FB_Tc Mat Sim Object can be instantiated with the object ID of a static module instance or with 0: fb Static : FB_Tc Mat Sim Object(oid:=<Object Id>); // Referenz auf statisches Tc Com-Objekt fb Dynamic : FB_Tc Mat Sim Object(oid:=0); // Erzeugen eines dynamisches Tc Com-Objektes 3.6.4 Using the To File block The To File block from the Simulink default library can be used to log signals in a MAT file. From within a created Tc COM, this block can still be used from the Twin CAT runtime. For file system access from the real-time, an additional Tc COM "Tc Extended Filewriter“ is created and linked to the Tc COM with the To File block (referred to as Simulink Tc COM below). The Tc Extended Filewriter then receives the data from the assigned Tc COM and writes it to a MAT file (mat4). The settings in Simulink and Twin CAT are described step by step below, based on an example. Configuration in the Simulink model A model with a sine and a cosine source serves as a simple example. Each signal is to be logged with a To File block. TE1400 Version: 2.4.1 49

## Page 50

Up to version 1.2.xxxx.x To enable code generation for the To File blocks, the format must be set to Array: 50 Version: 2.4.1 TE1400

## Page 51

Up to version 1.2.xxxx.x The model is now ready for code generation. Configuration in Twin CAT To write from the generated Simulink Tc COM, the Tc COM Tc Extended Filewriter installed with the TE1400 is required. It accepts data from the Simulink object and stores the data in the file system. The module can be found in the Tc COM browser under Beckhoff Automation -> Extended File Access -> Tc Extended File Writer: TE1400 Version: 2.4.1 51

## Page 52

Up to version 1.2.xxxx.x Initially, both Tc COMs are instantiated. Both objects can be linked to a joint task or separate task. In order to establish a link between the two objects, the Object ID of the Tc Extended Filewriter instance is communicated to the Simulink Tc COM. The Object ID can be found under the Object tab. 52 Version: 2.4.1 TE1400

## Page 53

Up to version 1.2.xxxx.x The Object ID is then inserted under the "Parameters (Init)" tab of the Simulink Tc COM for the parameter Extended File Access OID: It is possible to link several Simulink Tc COMs with one Tc Extended File Writer instance. Ensure that filename conflicts are avoided. Several Tc Extended File Writer instances can be used in parallel. For example, each Simulink Tc COM with a To File block can use its own Tc Extended File Writer instance. Parameterization of the Tc Extended File Writer instance The behavior of the object can be adapted under the Parameter (init) tab of the Tc Extended File Writer instance. Timeout: A timeout can be set Working directory: If a relative path is used in the To File block, e.g. /log Data, the full path is resolved via the Working Directory parameter. Number of Files: It is possible to limit the number of files. If the parameter is 0, limitation is inactive. Max File Size: Once the specified file size (default: 1 MB) has been reached, the file is closed and a new file is opened, in order to ensure that the logged data can be accessed while the module is running. Internal Buffer Size: TE1400 Version: 2.4.1 53

## Page 54

Up to version 1.2.xxxx.x A buffer with the size Internal Buffer Size is created on the Twin CAT side, from which the data is then written. Segment Size: With each write command of the Tc Extended File Writer instance, a segment with the size Segment Size is written from the internal buffer to the specified file. The maximum theoretically possible data rate for writing is composed of the Segment Size and the cycle time of the Tc Extendet File Writer (the Tc Extended File Writer instance does not have to have the same cycle time as the assigned Simulink Tc COM module). However, be aware that a write command may not yet be complete when the next cycle starts. If this is the case, the write command is suspended in this cycle. It is therefore a best case assessment. The Twin CAT project can now be activated. Once the specified file size (default: 1 MB) has been reached, the file is closed and a new file is opened, in order to ensure that the logged data can be accessed while the module is running (in the diagram: *_part1.mat and *_part2.mat are completed, while writing of *_part3.mat is still in progress): The Tc Extended Filewriter object has a Pause input to prevent continuous writing. If the input is set to TRUE, the file currently in use for write access is closed, and all further incoming data is discarded. If the input is set to FALSE again, a new file for logging incoming data is opened. The closed files can be opened as usual in MATLAB: The plot shows the expected sine wave: 54 Version: 2.4.1 TE1400

## Page 55

Up to version 1.2.xxxx.x 3.6.5 Signal access via Twin CAT 3 Scope Twin CAT 3 Scope enables access to all variable groups for which at least read ADS access was enabled, see Tc Interfaces [} 27] in Simulink. To use the Target Browser for configuring the Scope, the option … _Create Symbols must be selected under Tc Interfaces in Simulink. Without the corresponding symbol information, the signals to be captured have to be configured manually in Scope via Index group and Index offset. Alternatively, Scope can be started via the corresponding icon directly from the Twin CAT development environment (XAE). In the drop-down window of the block diagram browser, the button Show in Scope is shown for each available signal when the module instance runs on the target system. The signals can also be conveniently dragged into the Scope configuration using the right mouse button (drag & drop) from the drop-down menu (bar on the right in the diagram above) or from the blue signal lines in the block diagram (main window in the diagram above). The right mouse button can also be used to drag a whole block into the Scope configuration, in order to record all inputs and outputs for this function block. TE1400 Version: 2.4.1 55

## Page 56

Up to version 1.2.xxxx.x 3.7 FAQ 3.7.1 Does code generation work even if I integrate S-Functions into my model? S-Functions can be integrated into Simulink® models, which can then be built for use in the Twin CAT runtime. There are various workflows, which are based on different circumstances. The most common four cases are briefly explained here, and the appropriate solution for integration into the code generation process is shown. Case 1: I have access to the source code used in the S-Function. In this case, the location of the source code can be specified in the S-Function. The code generation process can be started directly without any further steps. The source code is found and compiled for use in Twin CAT. Case 2: I have an inlined S-Function (TLC file) In this case, the code generation process can be started directly without any further steps, since the code of the S-Function to be inserted is contained in the TLC file. How to create a TLC file for an S-function can be found in the documentation of The Math Works®: https://de.mathworks.com/help/simulink/sfg/how-to- implement-s-functions.html Case 3: I have a compiled MEX file without access to the source code In this case, a function was created by third parties and compiled as a MEX file. The source code or the TLC file was not included, e.g. to protect intellectual property. In this case, the third party supplying the MEX file must compile the source code as a Twin CAT-capable library, so that this library can be linked in real-time. A guide can be found under Samples: SFun Static Lib [} 78]. Case 4: I integrate a MEX library, whose source code I do not have, into my S-Function (whose source code is available). In this case, too, the third party supplying the MEX file must compile the source code as a Twin CAT- compatible library. A guide can be found under Samples: SFun Wrapped Static Lib [} 84]. 3.7.2 Why do FPU/SSE exceptions occur at runtime in the generated Twin CAT module, but not in the Simulink model? In the default settings, Simulink may treat floating point exceptions differently than Twin CAT 3. In order to adjust the behavior for floating point exceptions between Simulink and Twin CAT, in the Signals box under Model Configuration Parameters in Simulink in section Diagnostics >Data Validity you can choose between: • Division by singular matrix: error • Inf or Na N block output: error To debug an SSE exception in Twin CAT, please use the C++ debugger, see Debug [} 201] in the TE1400 documentation. Provided you have built your model as a "debug" module with the C++ debugger activated, it is sufficient to attach to the process after Twin CAT has started, if the exception occurs during the initial cycles. In many cases the SSE exception occurs directly in the first cycle. In this case, a division by zero can occur quickly if certain signals are initialized with zero. Another way to encounter SSE exceptions is to disable floating point exceptions. These can be deactivated in the System Manager under Tasks (uncheck the floating point exceptions checkbox). This setting then applies to all modules that are addressed by this task. If an exception occurs, a Na N is generated and no error is output. 56 Version: 2.4.1 TE1400

## Page 57

Up to version 1.2.xxxx.x NOTICE Deactivating floating point exceptions Na N values may only be used in other PLC libraries, in particular as control values in functions for Motion Control and for drive control, if they are expressly approved! Otherwise, Na N values can lead to potentially dangerous malfunctions! 3.7.3 After updating Twin CAT and/or TE1400 I get an error message for an existing model. Description of the situation: You have already successfully converted a Simulink model into a Tc COM. You have then carried out an update of the Twin CAT XAE and/or the TE1400. You now want to recompile the Simulink model (e.g. you have used a new TE1400 feature, changed something on the model, or you have not changed anything). Now you receive error messages during publishing. Possible cause and solution: A folder named <modelname>_tct already exists in the Build directory, see Which files are created automatically during code generation and publishing? [} 60]. This order was created with the sources of the previous software version(s). Under certain circumstances, conflicts may arise at this point if a new software release triggers a new publishing process that wants to store the sources in the same folder. A simple solution is to delete the corresponding folder, so that all sources are reconfigured with the current version of all components when you build the module. 3.7.4 Why do the parameters of the Tc COM instance not always change after a "Reload TMC/TMI" operation? Observation: Twin CAT 3 contains an existing instance of a Tc COM object. As already explained, the model parameters, e.g. the parameters of a PID controller, can be modified in Twin CAT via the exported block diagram or via the Parameter (init) tab of the Tc COM object outside of Simulink. If you change your Simulink model in Simulink and create a new Tc COM object, you can, of course, update this via the call reload TMC/TMI by right-clicking on the corresponding Tc COM object in Twin CAT. In this case all links are preserved, as long as the process image remains unchanged. A distinction is made between two different cases • Only model parameters were modified in Simulink, e.g. PID control parameters • Model parameters were modified, and further structural changes were made in the model In the former case you will note that the parameters of your Tc COM object have not changed after the call Reload TMC/TMI. The startup values are taken from the previous Tc COM instance, so that your settings from Twin CAT for this module instance are not lost. To load the model parameters from Simulink, you can select them by navigating to the Model Parameters dropdown menu in the right part of the block diagram window: right-click on Startup value or Prepared and select Insert default value. The default values are loaded from the TMC file, so that the parameter settings are taken from Simulink. TE1400 Version: 2.4.1 57

## Page 58

Up to version 1.2.xxxx.x Alternatively, you can delete the old Tc COM object and insert the new Tc COM object. In this case all previous model parameters are lost, and the newly added object has the same model parameters as the corresponding Simulink model. If additional changes were made apart from the model parameters, the model code also changes, which means retention of the previous model parameters settings is only possible to a limited degree. In this case the Twin CAT module parameters from the previous instance are retained, and the System Manager is still able to assign them unambiguously. 3.7.5 After a "Reload TMC/TMI" error "Source File <path> to deploy to target not found When you perform a TMC/TMI reload, make sure you use the TMC file from the Publish directory: %Twin CAT3Dir%\Custom Config\Modules\<MODULENAME>, not the file from the Build directory in folder <MODULENAME>_tct. If you use the TMC file from the Build directory, Twin CAT cannot find the corresponding driver and you get the error message shown in the heading when you start Twin CAT. 58 Version: 2.4.1 TE1400

## Page 59

Up to version 1.2.xxxx.x 3.7.6 Why do I have a Class ID conflict when I start Twin CAT? The class ID establishes a unique relationship between the tmc file and the associated real-time driver. If you have created a Tc COM module from Simulink® with the TE1400 and have instantiated it in a Twin CAT project, the class ID is anchored in the Tc COM instance and the instance expects a corresponding driver with this class ID. Now go back to Simulink® and create a new Tc COM with the same name as the already instantiated module. A new tmc file and new drivers will be stored in the Publish directory with a new class ID. If you now activate the Twin CAT configuration without informing Twin CAT that the class ID has changed, you will see the following behavior: Behavior for Twin CAT version < 4018: You will get an error message informing you that the class IDs do not match. Behavior for Twin CAT version ≥ 4018 The driver from the _Modul Install project folder, which matches the existing instance in the Twin CAT project, is used. The behavior of the module instance remains unchanged for the Twin CAT project. Important: The lowest compatible Twin CAT build ≥ 4018 must also be entered under Tc Build in order for the latter behavior to occur. See also Module generation (Tc Build) [} 23]. Solution: To be able to use the behavior of the newly generated Tc COM module in your Twin CAT project, you can right-click on the corresponding instance of Tc COM and select TMI/TMC-File -> Reload TMI/TMC File. Now select the tmc file in your Publish directory and confirm with OK. If you call the module from the PLC and have imported the PLCopen.xml file for this purpose, you must reimport it and select Replace the existing object in the dialog box. 3.7.7 Why can the values transferred via ADS differ from values transferred via output mapping? Transfer of the results for "minor time steps' Depending on the configured processing sequence [} 42] of the module instance, the transferred ADS values may differ from the expected values. Differences may occur if the time-continuous state variables are updated after the "output mapping", in order to obtain the shortest response time: Task cycle time Input mapping Output update Output State update External mode ADS access mapping processing Signal values transferred via ADS may differ from the values that were copied to other process images via "output mapping". The reason is that some values are overwritten in a state update. In other words: The transferred values are the result of the calculations within subordinate time steps of the solver that was used ("minor time steps"), while during "output mapping" the results of higher-level time steps are copied. This also applies for data that are transferred via External Mode [} 31]. 3.7.8 Are there limitations with regard to executing modules in real- time? Not all access operations that are possible in Simulink® under non-real-time conditions can be performed in the Twin CAT real-time environment. Known limitations are described below. • Direct file access:: No direct access to the file system of the IPC can be realized from the Twin CAT runtime. An exception is the Simulink® sink function block "To File". As described under Using the To File block [} 49], the Tc Extended File Writer module that realizes the file access can be instantiated in Twin CAT. TE1400 Version: 2.4.1 59

## Page 60

Up to version 1.2.xxxx.x • Direct hardware access: Direct access to devices/interfaces requires a corresponding driver, e.g. RS232, USB, network card, ... It is not possible to access the device drivers of the operating system from the real-time context. At present it is therefore not easily possible to establish an RS232 communication for non-real-time operation with the Instrument Controller Toolbox TM and then use this directly in the Twin CAT runtime. However, Twin CAT offers a wide range of communication options for linking external devices, see Twin CAT 3 Connectivity TF6xxx. • Access to the operating system API: The API of the operating system cannot be used directly from the Twin CAT runtime. An example is the integration of windows.h in C/C++ code. This is integrated by the Simulink Coder® if the FFTW implementation of the FFT block from the DSP Systems Toolbox TM is used (but not with the Radix 2 implementation), for example. 3.7.9 Which files are created automatically during code generation and publishing? Files are created in two separate folders as soon as you start the build process from Simulink. Which files are created depends on the selected configuration. Publish directory: %Twin CATDir%\Costum Config\Modules\ All the files required for instantiation of the Tc COM in Twin CAT are stored in this directory. File Purpose <Model Name>.tmc Twin CAT module class file <Model Name>_Module Info.xml Block diagram information and summary of the engineering system versions (Matlab version, TC version, …) <Model Name>_Plc Open POUs.xml Optional file. Can be included for the call of Tc COM from the PLC, see Calling the generated module from a PLC project [} 44]. <Model Name>.sys In the subdirectories Twin CAT RT (x64) and Twin CAT RT (x86). Real-time driver of the created module. <Model Name>.pdb In all subdirectories. Debug information file. <Model Name>.dll In the subdirectories Twin CAT UM (x64) and Twin CAT UM (x86). Driver for the user-mode runtime. To use the Tc COM described in this directory on other engineering systems, the entire folder can be copied to the appropriate folder on the engineering system. Build directory The Build directory is usually the current matlab path, which is active at the start of the build process. Two subdirectories are created in the Build directory. On the one hand, the Simulink Coder creates the directory slprj, in which Simulink stores specific cache files, on the other hand the TE1400 creates a directory <Model Name>_tct, in which all the important resources are combined. File Purpose Subfolder html Summary of code generation and publishing process in html format. <Model Name>_codegen_rpt.html *.cpp and *.h Source code of automatic code generation <Model Name>.vcxproj Visual Studio project of automatic code generation. Can be included in the Twin CAT C++ node as an existing project and published from there. <Model Name>_Publish Log.txt Text file with Publish log. <Model Name>_Module Info.xml Block diagram information and summary of the engineering system versions (Matlab version, TC version, …) 60 Version: 2.4.1 TE1400

## Page 61

Up to version 1.2.xxxx.x File Purpose <Model Name>_Plc Open POUs.xml Optional file. Can be included for the call of Tc COM from the PLC, see Calling the generated module from a PLC project [} 44]. The files stored in the Build directory are suitable for transfer to other engineering systems, just like the files in the Publish directory. On the corresponding engineering systems, the publish process must then be performed manually via the C++ area in Twin CAT. In addition to the resources for the publish process, all other relevant data for tracing the origin of the generated source code (without Matlab or Simulink source code) can be found here. 3.7.10 How do I resolve data type conflicts in the PLC project? If inputs, outputs, parameters or state variables of a Simulink model are changed, the corresponding data types in the Twin CAT module generated from it also change. After the update, the data types have the same name but a different GUID. The type system of the Twin CAT development environment (XAE) can manage several data types of the same name with different GUID. However, a PLC project is not allowed to have several data types with the same name. Especially after a module instance has been updated via "Reload TMC", several data types of the same name may exist in the type system, of which typically only the type related to the currently instantiated module class should be used. In some cases the user has the specify manually which of the data types should be available in the PLC project, particularly if PLC function blocks generated by the TE1400 are used. To this end, the data type editor can be started via the context menu of the type to be used in the table SYSTEM > Data types: By adding Datatype Hides, you can selectively exclude obsolete data types from being used in PLC projects: TE1400 Version: 2.4.1 61

## Page 62

Up to version 1.2.xxxx.x 3.7.11 Why are the parameters of the transfer function block in the Twin CAT display not identical to the display in Simulink? The Simulink Coder® generates real-time capable code; all transfer function representations are transformed into the state-space representation. Accordingly, the matrices of the state-space representation (A, B, C, D) are used in the code generated by the Simulink Coder®, which in turn can be displayed and modified in Twin CAT 3. In MATLAB the transformation of the transfer function representations into the state-space representation can take place via the function [A,B,C,D] = tf2ss(NUM,DEN), for example. 3.7.12 Why does my code generation/publish process take so long? The entire process of generating instantiable Tc COM modules runs through two phases. code generation and the publish process. The diagnostic viewer of Simulink® shows: ################################################################################ ### You can use the C++ project Tct Smpl Temp Ctrl.vcxproj to build the Tc COM module manually with Microsoft Visual Studio. ### Necessary source and project files have been generated successfully. ### Duration of the code generation (HH:MM:SS): 00:00:15 ### Publishing Tc COM module #################################################### ### Configuration: "Debug" ### Platform(s): "Twin CAT RT (x86); Twin CAT RT (x64)" ### Twin CAT SDK: "C:\Twin CAT\3.1\SDK\" ### Platform Toolset: "Microsoft Visual C++ 2015 (V14.0)" (Automatically selected) ### Now you can instantiate the generated module in Twin CAT3 on the target platform(s) "Twin CAT RT (x86);Twin CAT RT (x64)". ### Publish procedure completed successfully for Twin CAT RT (x86);Twin CAT RT (x64) ### Duration of code generation and build (HH:MM:SS): 00:00:24 ### Generating code generation report ############################### Notes on the duration of the code generation The duration of the code generation depends to a large extent on the individual model and is made up of the code generation of the Simulink Coder and the code generation for the Tc COM framework. Accordingly, the TE1400 only has influence on the Tc COM framework. If large parameter lists, e.g. look-up tables, are marked as tunable, the look-up table is entered in the tmc file to be generated, which may result in extended code generation duration. Notes on the duration of the publish process The Publish process consists of compiling the C/C++ code with the MS Visual C++ compiler, linking, and copying the module files to the Publish directory (<Twin CAT folder>\3.1\Custom Config\Modules). Accordingly, the compiler performance is crucial for this step. It depends on the compiler version and the settings (e.g. debug or release). In Simulink® under Tc Build it is possible to compile binaries for different target systems. These are created in a successive process. If you want to build a large model, it is advisable to focus on the platform(s) that you will actually use later. 3.8 Examples Example models for generating Tc Com modules: Example Topics Description Temperature Controller_minimal • Basic principles A very simple temperature controller that covers the basics. [} 63] 62 Version: 2.4.1 TE1400

## Page 63

Up to version 1.2.xxxx.x Example Topics Description Temperature Controller [} 69] • Parameter access A very simple temperature controller with PWM output. • Using bus objects Provides a quick overview of how • Using test points to use the module generator. Also • Using referenced models uses Simulink Bus Objects (structures) for an output and • Using external mode includes a test point, which affects • Generating Twin CAT modules the accessibility of internal signals from subsystems vie ADS. External Mode is also used in the example. SFun Static Lib [} 78] • SFunction Generates Twin CAT modules from Simulink models with SFunctions • Static library that are provided by third parties without source code. SFun Wrapped Static Lib [} 84] • SFunction Generates Twin CAT modules from Simulink models with SFunctions, • Static library for which the source code is available, but is dependent on static libraries. Examples for module generation callbacks [} 25]: Example Topics Description Packaging module files into ZIP • Post Publish callback This simple example illustrates the automatic archiving of generated archives [} 89] • Archiving generated module files module files. 3.8.1 Temperature Controller_minimal Description The following example shows the basics of generating a Twin CAT module from a Simulink model. Overview of project directory https://infosys.beckhoff.com/content/1033/te1400_tc3_target_Matlab/Resources/1539966475.zip contains all the files required for reproducing this example: Tct Smpl Min Temp Ctrl.mdl Simulink much of a simple PI temperature controller. Tct Smpl Temp Ctrl Parameters.mat Contains all the necessary model parameters. Tct Smpl Min Ctrl Sys PT2.mdl Simulink model of a simple PT2 controlled system (not used in the following description) TE1400 Version: 2.4.1 63

## Page 64

Up to version 1.2.xxxx.x _Precompiled Tc Com Modules This subdirectory contains readily compiled Twin CAT modules that were generated from the enclosed Simulink models. They enable the integration of a module in Twin CAT to be tested, without having to generate the module first. They can be used in situations where a MATLAB license is not yet available, for example. A quick reference guide for module installation on the development PC is also enclosed. Info: To start the module on an x64 target system, the system must be switched to test mode! _Previous Simulink Versions The MDL files described above are stored in the file format of the current Simulink version. This subdirectory contains the models in the file format of elder Simulink versions. Generating a Twin CAT module 1. Open Tct Smpl Min Temp Ctrl.mdl in Simulink 2. Start Model Explorer 3. Under Configuration -> Code Generation, select the System target file Twin CAT.tlc - either key in manually or use the Find button: 4. Close Model Explorer 64 Version: 2.4.1 TE1400

## Page 65

Up to version 1.2.xxxx.x 5. Start code generation via the Simulink menu item Tools->Code Generation-> Build Model or via the toolbar icon Incremental build ð The progress of the code generation is shown in the MATLAB command window. Using the generated Twin CAT module Open the Twin CAT development environment and create a new Twin CAT project. Expand node System in the Solution Explorer. Select the menu item Add new item in the context menu of node Tc COM Objects. The following dialog is displayed: TE1400 Version: 2.4.1 65

## Page 66

Up to version 1.2.xxxx.x Select the generated module from the group Custom Modules -> Simulink generated modules. If XAE was started before the end of the code generation, first press the Reload button. Add a new task using the context menu of the node System ->Tasks and configure the new task with the default parameters of the generated module: • Priority: 5 • Cycle Time: 5 ms 66 Version: 2.4.1 TE1400

## Page 67

Up to version 1.2.xxxx.x The module (with its default settings) should then have been configured automatically for attaching to this task. To verify this, select the object node Object1 (Tct Smpl Temp Ct) and open the Context tab. The Result table should contain the object ID and the object name of the task, as shown in the figure below: TE1400 Version: 2.4.1 67

## Page 68

Up to version 1.2.xxxx.x The configuration is now completed and can be activated on the target system. 1. Select the target system, the current configuration should be activated. 2. If there is no license, activate a free trial license in order to execute the modules generated with Simulink (TC1320 or TC1220) on the target system. 3. Activate the configuration on your target system. Confirm the question to overwrite the current configuration, and start the Twin CAT system. 4. The status symbol on the target should change its colors to green (running). 68 Version: 2.4.1 TE1400

## Page 69

Up to version 1.2.xxxx.x 5. If the Block Diagram tab was selected, the block diagram state changes to "Online", and the Properties table shows some online values. 3.8.2 Temperature Controller Description The following example extends the basics, shown in example "Temperature Controller_minimal" by the following subjects: • Parameter access [} 70] • Using Bus Objects [} 72] • Using Test Points [} 73] • Using Referenced Models [} 75] • Using External Mode [} 77] • Generating Twin CAT modules from Sub Systems [} 78] Overview of project directory https://infosys.beckhoff.com/content/1033/te1400_tc3_target_Matlab/Resources/1539964811.zip contains all the files for this example: TE1400 Version: 2.4.1 69

## Page 70

Up to version 1.2.xxxx.x Tct Smpl Temp Ctrl.mdl More advanced (but still very simple) temperature controller. Tct Smpl Ctrl Sys PT2.mdl Simple PT2 model for the controlled system. Tct Smpl Closed Loop Ctrl.mdl Model of a closed control loop, which was implemented through referencing of the controller models and the controlled system. Tct Smpl Temp Ctrl Parameters.mat Contains all the necessary model parameters. Tct Smpl Temp Ctrl Bus Objects.mat Contains all the required Simulink Bus Objects (structure definitions). _Precompiled Tc Com Modules This subdirectory contains readily compiled Twin CAT modules that were generated from the enclosed Simulink models. They enable the integration of a module in Twin CAT to be tested, without having to generate the module first. They can be used in situations where a MATLAB license is not yet available, for example. A quick reference guide for module installation on the development PC is also enclosed. Info: To start the module on an x64 target system, the system must be switched to test mode! _Previous Simulink Versions The MDL files described above are stored in the file format of the current Simulink version. This subdirectory contains the models in the file format of elder Simulink versions. Parameter access Tct Smpl Temp Ctrl.mdl has no embedded parameter values (inline parameters), i.e. the parameter values are stored in the corresponding model parameter structure. In addition, under the tab TCT Advanced of the coder settings, the module generator is configured such that ADS access to the parameters and generation of ADS symbols is allowed. ADS access is then possible from Twin CAT Scope View or other ADS clients. 70 Version: 2.4.1 TE1400

## Page 71

Up to version 1.2.xxxx.x The Block diagram tab in Twin CAT XAE is an ADS client. Access to its parameter depends on these settings. If the option Inline parameters is activated without further configurations, all parameter values in the generated module codes are fixed. The Configure... button next to Inline parameters can be used to open a configurator, in which you can select the variables of the MATLAB working area that are to remain configurable in the generated module: In the sample shown, only the workspace variables Kp and Tn remain configurable, which means that only the Simlulink block parameters that depend on these parameters are configurable. The parameter structure is reduced to these two elements. TE1400 Version: 2.4.1 71

## Page 72

Up to version 1.2.xxxx.x For further information on parameter inlining, see Simulink documentation. Using bus objects Simulink Bus Objects enable access to Twin CAT modules generated in Simulink via structured symbols. This sample contains a predefined Bus Object called Monitoring Signals Type. It is an output structure, i.e. it assigns the signals it contains to a PLC module. The configuration of a Bus Object is started by double-clicking on the Bus Creator block. To start the Bus Editor, click the Edit button in the Welcome screen, as shown in the figure below. Further information on using Bus Objects can be found in the Simulink documentation. 72 Version: 2.4.1 TE1400

## Page 73

Up to version 1.2.xxxx.x During instantiation of the generated module in a Twin CAT project, the specified Bus Object is imported into the Twin CAT project as a global Twin CAT data type. This data type is used by the generated module itself for displaying the output structure, although it can also be used by other modules, such as a PLC, for example, which are linked to this output structure. Using test points In Simulink you can specify test points on signals for monitoring by Simulink "Floating Scope", for example. If the Twin CAT Target module generator is used, signals with such test points are invariably declared as member variable for the generated Twin CAT module. This enables ADS access to the signal. For more information on test points, see Simulink documentation. In this sample, the Model Explorer is used to define a test point for the control difference e: TE1400 Version: 2.4.1 73

## Page 74

Up to version 1.2.xxxx.x To enable ADS access, enable internal block output in the code settings under the TCT Advanced tab: In this way you can use Twin CAT Scope View to access the signal with test points and some other block output variables when the generated Twin CAT module is executed. 74 Version: 2.4.1 TE1400

## Page 75

Up to version 1.2.xxxx.x Using referenced models Open the model Tct Smpl Closed Loop Ctrl.mdl, which contains two model references. Referenced models are the temperature controller described above and a simple P-T2 model of a temperature control system. TE1400 Version: 2.4.1 75

## Page 76

Up to version 1.2.xxxx.x Such model referencing has several advantages, both in general and in combination with Twin CAT Target. Two basic options for structured modelling and, particularly in this example, for controller design are: Simulation for optimizing the Optimization of the controller design based on simulation of the controller: control loop with MATLAB/Simulink, followed by transfer of the optimized controller into the real-time environment of Twin CAT 3. Thanks to the use of standard Simulink input and output blocks for the definition of the Twin CAT module process images, no changes in the controller model are required before module generation commences. Reuse and faster creation of models: A model can be referenced several times in one or several higher-level models. In this way, the models can be divided into reusable functional units, similar to text programming languages, where the code is structured into functions or methods. This improves the readability of complex models. The generated code of referenced models is compiled into static libraries, which are only updated if the referenced model was modified since the last code generation. This can speed up the development of complex models, if parts that are only rarely modified are stored in referenced models. In this example, model generation can be started for a control loop model, and a real-time control loop simulation can be executed in the Twin CAT runtime. Note on licenses: The control loop model of this example can only be compiled into a Twin CAT module with a valid Twin CAT Target license (TE1400). Otherwise, this model exceeds the limits for unlicensed models. 76 Version: 2.4.1 TE1400

## Page 77

Up to version 1.2.xxxx.x Using external mode The temperature controller model Tct Smpl Temp Ctrl.mdl has been preconfigured so that External Mode connections are permitted: Because of these configurations, you can use the Connect to Target icon in the Simulink toolbar to establish a connection with the generated temperature controller via External Mode. The module must have been previously generated and started on a Twin CAT system and an ADS route must have been configured between your development system and the corresponding target system. A number of dialogs are displayed to help you navigate to the desired module instance. You can now use the Scope block in Simulink to monitor the real-time signals of the generated and now connected Twin CAT module. You can also change the value of the Internal Setpoint block, for example. As soon as the parameter change is confirmed, it is downloaded directly to the target module. This is only possible for adjustable parameters if the model parameters are not inlined (see "Parameter access [} 70]"). TE1400 Version: 2.4.1 77

## Page 78

Up to version 1.2.xxxx.x Generating Twin CAT modules from subsystems Creating a Twin CAT module in a Simulink subsystem, instead of the entire model, via the subsystem context menu: 3.8.3 SFun Static Lib Use cases Encapsulating own code within static libraries can be useful to • speed up module generation, if the code contains algorithms, which are not changed frequently • deliver Twin CAT Target compatible SFunction algorithms to customers, without the need to hand out the source code but only the compiled libraries Description The following example illustrates how Twin CAT modules are generated using SFunctions from Simulink models, for which no source code is available. In this case, the SFunction functionality can be integrated into the generated Twin CAT module via static libraries. However, this presupposes that suitable libraries are available for all Twin CAT platforms, for which the module is to be created. The following diagram illustrates the typical workflow when using third-party algorithms in a user-created Simulink model: 78 Version: 2.4.1 TE1400

## Page 79

Up to version 1.2.xxxx.x In this example, the source code for the "algorithm development side" is available and can be compiled for all Twin CAT platforms. It shows how • SFunctions are generated with suitable Twin CAT libraries • such libraries are made available (e.g. to customers) • such libraries are used in own models Project directory overview https://infosys.beckhoff.com/content/1033/te1400_tc3_target_Matlab/Resources/1539910283.zip contains all the files necessary to reproduce this example: Tct Smpl SFun Static Lib.mdl contains the model that references the SFunction. Build Libs And SFunction.m contains an M-script that creates the static library for all currently available Twin CAT platforms and creates the SFunction. Open Lib Project.m contains an M-script that defines the MATLAB build environment for Visual Studio, such as MATLAB Include and library directories. The static library is then opened in Microsoft Visual Studio 2010 with the predefined environment variables. Subdirectory SFun Lib Project contains the SFunction project. Subdirectory Build Scripts contains several M-scripts for "Build Libs And SFunction.m" and "Open Lib Project.m". TE1400 Version: 2.4.1 79

## Page 80

Up to version 1.2.xxxx.x _Precompiled Tc Com Modules This subdirectory contains readily compiled Twin CAT modules that were generated from the enclosed Simulink models. They enable the integration of a module in Twin CAT to be tested, without having to generate the module first. They can be used in situations where a MATLAB license is not yet available, for example. A quick reference guide for module installation on the development PC is also enclosed. Info: To start the module on an x64 target system, the system must be switched to test mode! _Previous Simulink Versions The MDL files described above are stored in the file format of the current Simulink version. This subdirectory additionally contains the models in the file format elder Simulink versions. Build SFunction and appropriate static link libraries Build requirements It is recommended to have Twin CAT 3 installed on your system to build the binaries, but not required. Requirements are: Windows Driver Kit installed on your system and the environment variable Win DDK set to its path. Twin CAT SDK installed on your system and the environment variable Twin Cat Sdk set to its path. For more information about this requirement, see the system requirements in the Twin CAT 3 documentation. Creating binary files manually The binary files can be created manually with Visual Studio. To do this, execute Open Lib Project.m. This prepares the required environment variables and opens the SFunction project in Visual Studio. Create a project for all platforms that should be supported. Twin CAT xx(xxx) Creates the platform-specific static library, which is linked to the generated Twin CAT module. Win32 Creates the . MEXW32 SFunction for running the simulation of the model with Simulink in 32-bit MATLAB. It can only be created if Visual Studio was started from 32-bit MATLAB. x64 Creates the . MEXW64 SFunction for running the simulation of the model with Simulink in 64-bit MATLAB. It can only be created if Visual Studio was started from 64-bit MATLAB. In order to create the MEX files used in this example for 32- and 64-bit MATLAB, Visual Studio must be started from both MATLAB versions. 80 Version: 2.4.1 TE1400

## Page 81

Up to version 1.2.xxxx.x Build the binaries via build script Alternatively to the manual build procedure, in order to speed up the build procedure for a quick overview, run Build Libs And SFunction.m. This prepares the build environment variables and invokes MSBUILD multiple times to build the . LIB and . MEXWxx files for each Twin CAT platform and for the current MATLAB platform architecture (32 or 64 Bit). To build the MEX files of this example for 32 and 64 Bit MATLAB Build Libs And SFunction.m has to be executed with both MATLAB variants. After the build procedure, all the build output files are copied to the subfolder Lib Project\Tct Sample_SFun Lib\Build Output. All necessary binaries are additionally copied to Lib Project\Tct Sample_SFun Lib\Lib Package. Deliver the binaries Lib Project\Tct Sample_SFun Lib\Lib Package is the folder which can be delivered to customers who want to use the now built - Twin CAT Target compatible - SFunction. Copy the content of this folder to the users system, more precisely to the folder %Twin Cat3Dir%Functions\TE1400-Target For Matlab Simulink\Libraries. If Build Libs And SFunction.m was used for building the binaries, this has already been done for the local system. The content of this folder should be: Subfolders Twin CAT xx (xxx) contain the static link libraries for different Twin CAT platforms. These are used when generating Twin CAT modules from appropriate Simulink models. Subfolders Win32 / Win64 contain the MEX files (and optionally some static link libraries) for the different MATLAB platform architectures (32 and/or 64 Bit). Either subfolder Win32 or Win64 is added to the MATLAB path when setting up Twin CAT Target via Setup Twin Cat Target.m. Thus, SFunction MEX files are found by MATLAB can be used directly from this location. Run simulation To check if everything works, open "Tct Smpl SFun Wrapped Static Lib.mdl" and start simulation. If the simulation starts without error messages, everything is prepared as needed. Generate Twin CAT module Configuring a model The general settings for generating a Twin CAT module must be set, e.g. a fixed-step solver must be configured, and the system target file "Twin CAT.tlc" must be selected under the "General" tab in the model coder settings. For further information on the general configuration of the Twin CAT module generator see Quickstart. In addition, the code generator must know which static libraries have to be linked to the generated code and where to find them. Enter this information in the corresponding option fields of the Simulink coder, as shown in the figures below. TE1400 Version: 2.4.1 81

## Page 82

Up to version 1.2.xxxx.x 82 Version: 2.4.1 TE1400

## Page 83

Up to version 1.2.xxxx.x The Include folder should already have been created automatically by Twin CAT Target. The Libraries setting must contain the names of the static libraries to be linked. Background information for these settings: In this example (and in most other cases) there are several instances of these libraries in the specified folders. MSBUILD decides which version is linked to the module when the generated Twin CAT module binary files are linked. How to use this example as a template The following list provides a short overview of the easiest way, to create an own Twin CAT Target compatible SFunction: 1. Copy the sample folder 2. Replace the MDL file by your own 3. Rename the VCXPROJ file to the desired name of your SFunction 4. Copy your source files to the directory where the VCXPROJ file is located 5. Adapt the scripts Build Libs And SFunction.m and Open Lib Project.m to the new project name 6. Open the VCXPROJ file using Open Lib Project.m TE1400 Version: 2.4.1 83

## Page 84

Up to version 1.2.xxxx.x 7. Remove the existing CPP files from the project 8. Add your own CPP files to the project 9. Adapt the DEF file contents to the new project name 10. If necessary, add include directories, dependency directories and libraries to the compiler and linker settings 11. Build the project (for different platforms and/or configurations) 12. Close the VCXPROJ file 13. Run Build Libs And SFunction.m 3.8.4 SFun Wrapped Static Lib Use cases Encapsulating own code within static libraries can be useful to • speed up module generation, if the code contains algorithms, which are not changed frequently • deliver Twin CAT Target compatible SFunction algorithms to customers, without the need to hand out the source code but only the compiled libraries Description The following example shows the configuration of the module generator when using Sfunctions that depend on statically linked libraries. For this type of code integration, a suitable library must be available for all Twin CAT platforms for which the module is to be created. The following diagram illustrates the typical workflow when using third-party algorithms in a custom Simulink model: In this example, the source code for the "algorithm development side" is available and can be compiled for all Twin CAT platforms. It shows how • dependent libraries are created 84 Version: 2.4.1 TE1400

## Page 85

Up to version 1.2.xxxx.x • such libraries are made available (e.g. to customers) • such libraries are used in own models Overview of project directory https://infosys.beckhoff.com/content/1033/te1400_tc3_target_Matlab/Resources/1539911947.zip contains all the files necessary to reproduce this example: Tct Smpl SFun Wrapped Static Lib.mdl contains the model that references the SFunction. Tct Sample_SFun Lib Wrapper.cpp must be present on the target system. Contains the source code of the SFunction. Static Lib.cpp Simple example of source code of a static library. Build Libs And SFunction.m contains an M-script that creates the static library for all currently available Twin CAT platforms and creates the SFunction. Open Lib Project.m contains an M-script that defines the MATLAB build environment for Visual Studio, such as MATLAB Include and library directories. The static library is then opened in Microsoft Visual Studio 2010 with the predefined environment variables. Subdirectory Lib Project contains the static library. Subdirectory Build Scripts contains several M-scripts for "Build Libs And SFunction.m" and "Open Lib Project.m". _Precompiled Tc Com Modules This subdirectory contains readily compiled Twin CAT modules that were generated from the enclosed Simulink models. They enable the integration of a module in Twin CAT to be tested, without having to generate the module first. They can be used in situations where a MATLAB license is not yet available, for example. A quick reference guide for module installation on the development PC is also enclosed. Attention: To start the module on an x64 target system, the system must be switched to test mode! _Previous Simulink Versions The MDL files described above are stored in the file format of the current Simulink version. This subdirectory contains the models in the file format of elder Simulink versions Create SFunction and corresponding statically linked libraries Build requirements It is recommended to have Twin CAT 3 installed on your system to build the binaries, but not required. Requirements are: Windows Driver Kit installed on your system and the environment variable Win DDK set to its path. Twin CAT SDK installed on your system and the environment variable Twin Cat Sdk set to its path. For more information about this requirement, see the system requirements in the Twin CAT 3 documentation. Creating static libraries manually The static libraries can be created manually with Visual Studio. To do this, execute Open Lib Project.m. This prepares the required environment variables and opens the SFunction project in Visual Studio. Create a project for all platforms that should be supported. The output file for all platforms is a static library: TE1400 Version: 2.4.1 85

## Page 86

Up to version 1.2.xxxx.x Build the static link libraries via build script Alternatively to the manual build procedure, run Build Libs And SFunction.m. This prepares the build environment and invokes MSBUILD multiple times to build the lib files for each platform.. Afterwards, all the build output files are copied to the subfolder Lib Project\Tct Sample_Wrapped Static Lib\Build Output. The . LIB files, which are necessary to build the SFunction and the generated Twin CAT modules are additionally copied to Lib Project\Tct Sample_Wrapped Static Lib\Lib Package. Deliver the static libraries Lib Project\Tct Sample_Wrapped Static Lib\Lib Package is the folder which can be delivered to users, which want to use this library inside their own - Twin CAT Target compatible - SFunctions. Copy the content of this folder to the users system, more precisely to the folder %Twin Cat3Dir%Functions\TE1400- Target For Matlab Simulink\Libraries. This is also done by Build Libs And SFunction.m for the local system. The content of this folder should be: Subfolders Twin CAT xx (xxx) contain the static link libraries for different Twin CAT platforms. These are used when generating a Twin CAT module from an appropriate Simulink model. Subfolders Win32 / Win64 contain the static link libraries for the different MATLAB platform architectures (32 and/or 64 Bit). These are used when generating a Twin CAT module from an appropriate Simulink model. To build the libraries for this example for 32 and 64 Bit MATLAB Build Libs And SFunction.m has to be executed with both MATLAB variants. Compile mex file code Before the SFunction can be used inside the Simulink model, it has to be built, too. Of course this can be done manually, as in any other SFunction. However, the MEX compiler has to be advised to link the static library to the SFunction. When executing Build Libs And SFunction.m, this is also done automatically. Afterwards the file "SFun Static Lib.mexw32" should be located inside your working folder. To check if everything works, open "Tct Smpl SFun Wrapped Static Lib.mdl" and start simulation. If the simulation starts without error messages, everything is prepared as needed. Generating a Twin CAT module Configuring a model The general settings for generating a Twin CAT module must be set, e.g. a fixed-step solver must be configured, and the system target file "Twin CAT.tlc" must be selected under the "General" tab in the model coder settings. For further information on the general configuration of the Twin CAT module generator see Quickstart [} 16]. In addition, the code generator must know which static libraries have to be linked to the generated code and 86 Version: 2.4.1 TE1400

## Page 87

Up to version 1.2.xxxx.x where to find them. Enter this information in the corresponding option fields of the Simulink coder, as shown in the figures below. TE1400 Version: 2.4.1 87

## Page 88

Up to version 1.2.xxxx.x The Include folder should already have been created automatically by Twin CAT Target. The Libraries setting must contain the names of the static libraries to be linked. Background information for these settings: In this example (and in most other cases) there are several instances of these libraries in the specified folders. MSBUILD decides which version is linked to the module when the generated Twin CAT module binary files are linked. How to use this example as a template The following list provides a short overview of the easiest way, to create an own Twin CAT Target compatible SFunction dependency: 1. Copy the sample folder 2. Replace the MDL file by your own 3. Rename the VCXPROJ file to the desired name of your SFunction 4. Copy your source files to the directory where the VCXPROJ file is located 5. Adapt the scripts Build Libs And SFunction.m and Open Lib Project.m to the new project name 6. Open the VCXPROJ file using Open Lib Project.m 7. Remove the existing CPP files from the project 8. Add your own CPP files to the project 9. If necessary, add include directories, dependency directories and libraries to the compiler and linker settings 10. Build the project (for different platforms and/or configurations) 88 Version: 2.4.1 TE1400

## Page 89

Up to version 1.2.xxxx.x 11. Close the VCXPROJ file 12. Run Build Libs And SFunction.m 3.8.5 Module generation Callbacks Examples for module generation callbacks [} 25]: Example Topics Description Packaging module files into ZIP • Post Publish callback This simple example illustrates the automatic archiving of generated archives [} 89] • Archiving generated module files module files. 3.8.5.1 Packaging module files into ZIP archives Callbacks can be used to store generated module files in as a ZIP archive, for example. First create the directory C:\My Generated Tc Com Modules, then copy the following command in the Post Publish callback field of the code generator settings of the Simulink model under Tc Build: zip(fullfile('C: \My Generated Tc Com Modules',cg Struct. Module Name),'*',fullfile(getenv('Twin Cat3Dir'),'Custom Config','Mo dules',cg Struct. Module Name)) TE1400 Version: 2.4.1 89

## Page 90

From version 2.x.xxxx.x 4 From version 2.x.xxxx.x • TE1400 Target for Simulink® versions lower than 1.2.xxxx.x support MATLAB R2010b to MATLAB R2019a. • TE1400 Target for Simulink® versions higher than 2.x.xxxx.x support MATLAB R2019a and higher. • The installations for both versions can be used in parallel on one engineering system. • Compatibility of the created modules: see Mapping is lost with Reload TMI/TMC [} 236]. 4.1 Installation System requirements In the following, a distinction is made between the engineering PC and the runtime PC. The following definition is used: On the engineering PC, Simulink® models are converted into Twin CAT objects by using the Twin CAT Target for Simulink®. The Twin CAT objects created can be instantiated in Twin CAT projects and thus integrated into the program flow. Built objects can be easily forwarded Twin CAT objects built on an engineering PC (or Build Server) can be easily forwarded to other people. They only need the Twin CAT XAE development environment in order to use the created objects (Tc COM or PLC function blocks) in a Twin CAT solution. The created Twin CAT Solution is then loaded from the engineering PC to a runtime PC in the Twin CAT runtime environment for execution of the project. Requirements on the engineering PC • MATLAB® R2019a or higher and at least Simulink® and Simulink® Coder™ • Visual Studio 2017 or higher (Professional, Ultimate or equivalent edition) ◦ During installation, the option Desktop development with C++ must be selected manually. The option can also be installed later. ◦ To support the Twin CAT OS (ARMV8-A) platform (for compiling for CX82xx and CX9240), the “MSBuild Support for llvm (clang-cl) toolset” component is also required. This must also be selected manually. • Twin CAT XAE Version 3.1.4024.35 or higher • Twin CAT Target for Simulink® ◦ Twin CAT-build 4024: Use the Download Finder on the Beckhoff website and install Twin CAT tools for MATLAB® and Simulink® ◦ Twin CAT-build 4026: Install the appropriate workload (see next paragraph). On the runtime PC • Supported operating systems ◦ Windows 11, Windows 10, Windows Server (32-bit and 64-bit) ◦ Beckhoff RT Linux® (only from Twin CAT build 4026) ◦ Twin CAT/BSD • Twin CAT XAR version 3.1.4024.35 or higher The same Twin CAT major build is required on both the runtime and engineering systems. Please note that the same Twin CAT major build must be used on the runtime system and the engineering system. This means: Twin CAT Build 4024 on XAE and XAR or Twin CAT Build 4026 on XAE and XAR. 90 Version: 2.4.1 TE1400

## Page 91

From version 2.x.xxxx.x Installation (Twin CAT 3.1 Build 4026) The TE1400 | Twin CAT 3 Target for Simulink® workload installs all the dependencies required to create Twin CAT objects. • Install one of the supported Visual Studio versions, if not already installed. Note the installation of the Desktop development with C++ option. • Install the Twin CAT Package Manager. • Install the following workload: ◦ Name in the UI: TE1400 | Twin CAT 3 Target for Simulink® Command line: tcpkg install TE1400. Target For Simulink. XAE • Execute the integration in the Visual Studio that you have installed with the Desktop development with C++ option. • Start MATLAB® as administrator and execute C:\Program Files (x86)\Beckhoff\Twin CAT\Functions\TE14xx- Tools For Matlab And Simulink\Setup TE14xx.p in MATLAB®. If you want to create a Twin CAT project and use Twin CAT objects that have already been built, install the following workloads: • Twin CAT Standard tcpkg install Twin CAT. Standard. XAE • Twin CAT Block Diagram Classic tcpkg install Twin CAT. XAE. Block Diagram Classic • In some cases you will also need the following packages: tcpkg install Twin CAT. XAE. TMX. Data Exchange (see Data Exchange Modules [} 138]) tcpkg install Twin CAT. XAE. TMX. Mat Sim Utilities (for converting ITc Vn Image to ARRAY) Installation (Twin CAT 3.1 Build 4024) ü Install one of the supported Visual Studio versions, if not already installed. Note the installation of the Desktop development with C++ option. 1. Start Twin CAT 3 XAE or Full Setup, if it is not already present. If a Visual Studio and a Twin CAT installation are already present but the Visual Studio version does not meet the requirements mentioned above (e.g. Twin CAT XAE Shell or Visual Studio without C++ option), you need to install a suitable Visual Studio version first (install C++ option, if necessary). Then run Twin CAT 3 setup to integrate Twin CAT 3 into the new (or modified) Visual Studio version. 2. If you have not yet installed MATLAB® on your system, install it. The order in which MATLAB® has been installed is irrelevant. 3. Start Twin CAT Tools for MATLAB® and Simulink® setup to install the TE1400. ð The TE1400 is installed in the Twin CAT folder structure, i.e. it is separate from the MATLAB® installation. 4. Start MATLAB® as administrator and run %Twin CAT3Dir%.. \Functions\TE14xx-Tools For Matlab And Simulink\Setup TE14xx.p in MATLAB®. 4.2 Licenses Two licenses are required to use the full functionality of the TE1400 Twin CAT Target for Simulink®. On the one hand, the TE1400 engineering license for creating Twin CAT objects from Simulink® and, on the other hand, a runtime license for executing these objects during the Twin CAT runtime. Engineering license The license TE1400 Target for Simulink® is required for the engineering system for creating Tc COM and PLC function blocks from Simulink®. For testing purposes, the product can be used in demo mode without a license as a demo version. TE1400 Version: 2.4.1 91

## Page 92

From version 2.x.xxxx.x A 7-day trial license with full functionality is not available for this product. Restrictions in the demo version Without valid TE1400 license models are allowed with maximum: • All cpp and header files from Simulink Coder™ (incl. dependent libraries) must not exceed 100 k B in total. • 5 input signals • 5 output signals Modules created with a demo license may only be used for non-commercial purposes! Runtime license A runtime license is required to start a Twin CAT configuration containing one or more Twin CAT objects generated from Simulink®. Required licenses for execution are: TF1400 Twin CAT 3 Runtime for MATLAB®/Simulink® and TC1300 Twin CAT 3 C++. Both licenses are included in the TC1320 and TC1220 license bundles. TC1320 bundles TC1300 and TF1400 licenses (C++ and MATLAB®/Simulink® Runtime). TC1220 bundles the TC1200, TC1300 and TF1400 licenses (PLC, C++ and MATLAB®/Simulink® Runtime). License TF1400 only from Twin CAT 3.1 Build 4026 The TF1400 license is only supported from Twin CAT 3.1 Build 4026. For earlier versions only the license bundles TC1220 or TC1320 are available. The license bundles are still supported with build 4026 and higher. The TF1400 license is only required if a Twin CAT 3 C++ license is already available on the target system. Without activated license, the module and consequently the Twin CAT system cannot be started. You can generate a 7-day trial license for the named runtime licenses, which allows initial testing without purchasing the license. 4.3 Initial setup of the software 4.3.1 Set up default settings and set MATLAB® path Initial setup of the software Setting MATLAB® paths 92 Version: 2.4.1 TE1400

## Page 93

From version 2.x.xxxx.x As described under Installation [} 90], the files Setup TE14xx.p must be executed after the software installation. This script adds the necessary paths to your MATLAB® path. MATLAB® administrator rights are required to save MATLAB® paths. Run Setup TE14xx.p additionally after each product update To ensure that all paths are set in the MATLAB® path, please also run the p-file after updating the product. Set default settings The script also opens a dialog in which you can save general default settings for the Twin CAT target. These settings then apply system-wide, i.e. for all installed MATLAB® versions. If you want to execute the p-file without this dialog, you can use the following command: Setup TE14xx('Silent', true); The default values of the dialog are set. You can make the settings at this time or make/change them at a later time. In the dialog under the Build tab, you can store a default certificate for driver signing. The setup options for driver signing are explained in full in the chapter Setting up driver signing [} 95]. The hierarchy of the generated Twin CAT objects can also be influenced in the dialog. The following setting options are available in the dialog: • Vendor Name • Group Name (MATLAB®) and • Group Name (Simulink®) The hierarchy is shown in Twin CAT using the following example: • Vendor Name “TE140x Module Vendor” • Group Name “TE140x” TE1400 Version: 2.4.1 93

## Page 94

From version 2.x.xxxx.x ◦ “MATLAB Modules” for MATLAB® and ◦ “Simulink Modules” for Simulink® Change the software setup To change the default settings of the Twin CAT target, you can access a dialog in the MATLAB® Console as follows: Twin CAT. Module Generator. Settings. Edit Here you are offered various entries that you can store as default values. 94 Version: 2.4.1 TE1400

## Page 95

From version 2.x.xxxx.x Accept changes 1. Enter the new default settings in the dialog box. 2. Confirm with the Save button. 3. Restart MATLAB®. ð The changes have been adopted. 4.3.2 Setting up driver signing Create an OEM certificate level 2 Twin CAT objects generated from MATLAB® or Simulink® are based on a tmx driver (Twin CAT Module Executable), as are Twin CAT C++ objects. These drivers must be signed with a OEM certificate level 2 so that the driver can be loaded on the runtime PC during the Twin CAT runtime. See the following links for detailed documentation on how to create an OEM certificate for driver signing: • General documentation on OEM certificates • Application-related documentation for tmx driver signing TE1400 Version: 2.4.1 95

## Page 96

From version 2.x.xxxx.x The most important facts in brief: • You can create your own certificate. To do this, go to Visual Studio at: Menu bar > Twin CAT > Software Protection... ◦ You need an OEM certificate Crypto Version 2 (option: Sign Twin CAT C++ executables (*.tmx)). ◦ You will be prompted to create a password for your certificate. • Drivers can also be created without signing and signed afterwards. • For testing purposes in the development phase, a non-countersigned certificate is sufficient. • Countersigned certificates can be ordered free of charge from Beckhoff (TC0008). Set up OEM certificate level 2 under Software Protection Twin CAT Build 4026: Requirement for the setup dialog The following information on Software Protection only applies to Twin CAT 3.1 Build 4026. At least the Twin CAT Standard 4026.14 workload is required. If you are working with older versions, please continue reading “Setting up OEM certificate level 2 for driver signing without the Software Protection dialog” in the section below. In the Software Protection interface (Menu bar > Twin CAT > Software Protection...) you can both create certificates (Create New...) and: • Set a certificate as the system-wide default certificate for signing tmx files (optional). • For each certificate, store the corresponding password for the logged-in Windows user (required). The overview above contains two certificates as examples. The first certificate "Test Sign123" is not countersigned by Beckhoff, therefore it is classified as invalid in the status. Certificates that are not countersigned can still be used for signing. The target system must then be set into the test mode - see section Behavior of the Twin CAT runtime [} 98]. The "Tmx Sign Cert Faxxx Bx" certificate, on the other hand, is countersigned and therefore classified as valid. Both certificates are suitable 96 Version: 2.4.1 TE1400

## Page 97

From version 2.x.xxxx.x for signing tmx files, as can be seen under Permissions. In the "TMX Signing" column, "Default" indicates whether a certificate is set as the system-wide default certificate. The note "PW Stored" indicates that the password of the certificate is available/stored for the Windows user logged in. Set certificate as system-wide default certificate (optional) You can set a default certificate on an engineering PC, which is always used for Twin CAT C++, Target for MATLAB®, Target for Simulink®, etc., unless you explicitly specify a different certificate. Select the certificate you want to use as the default certificate from the list in the Software Protection dialog and select the "Set as System Default" checkbox. An environment variable with the name Tc Sign Twin Cat Cert Name is then created. In Windows, environment variables are made known when a process is started. Therefore, restart MATLAB® if you are already running the process. Further options for using certificates can be found later in this chapter. Store password for a certificate (required) For security reasons, the password of a certificate must not be entered in the project or source code in the Simulink® model or in the MATLAB® code. With "Store Password for Current User" you store the corresponding passwords for your certificates on your system. The passwords are stored obfuscated in the registry of the Windows operating system. This means that the password for a specific certificate is known in the operating system (for the Current User) and is used automatically. Select the certificate for which you want to store the corresponding password in the Software Protection dialog. Select "Store Password for Current User". You will be asked to enter your password. If it has been successfully checked and entered, the note "PW Stored" appears under "TMX Signing". An alternative variant for storing a password is the command prompt with the Tc Sign Tool (C:\Program Files (x86)\Beckhoff\Twin CAT\3.1\SDK\Bin). The password is stored with the following call: tcsigntool grant /f "C:\Twin CAT\3.1\Custom Config\Certificates\My Certificate.tccert" /p My Password The obfuscated password is stored in the registry under: HKEY_CURRENT_USER\SOFTWARE\Beckhoff\Tc Sign Tool\ The password is deleted with the following call: tcsigntool grant /f "C:\Twin CAT\3.1\Custom Config\Certificates\My Certificate.tccert" /r Set up OEM certificate level 2 for driver signing without the Software Protection dialog To sign tmx files, you need a certificate and a password associated with the certificate. Available certificates can be found at: Build 4026: C:\Program Data\Beckhoff\Twin CAT\3.1\Custom Config\Certificates Build 4024: C:\Twin CAT\3.1\Custom Config\Certificates Handling of the certificate There are four possible variants for signing tmx drivers. Variant 1: System-wide default certificate for Twin CAT C++ and TE14xx This variant is identical to the path via "Software Protection" > "Set as System Default". Alternatively, you can also create a Windows environment variable manually for this variant. Create a new environment variable at User > Variables with: Variable: Tc Sign Twin Cat Cert Name TE1400 Version: 2.4.1 97

## Page 98

From version 2.x.xxxx.x Value: Full path of the certificate Variant 2: System-wide default certificate for MATLAB® You can set a default certificate in your MATLAB® environment, which is always used for Target for MATLAB® and Target for Simulink® (not Twin CAT C++), unless you explicitly specify a different certificate. Open the Common Settings dialog with Twin CAT. Module Generator. Settings. Edit (MATLAB® Command line) and enter the desired default certificate under Build > Certificate name for Twin CAT signing. This certificate is stored in your user directory as default and is used by all MATLAB® versions on your system as default. Variant 3: Certificate in the configuration of the Simulink® model You can explicitly name a certificate for each build operation. For Variant 3 you do not have to make any further settings in advance. Before each build process, you can define a certificate of your choice for precisely this build process. Target for Simulink®: TC Build > Certificate for Twin CAT signing Target for MATLAB®: Property Sign Twin Cat Cert Name Variant 4: Build without certificate and sign later with Tc Sign Tool You can build without a certificate and sign afterwards with the Tc Sign Tool. The Tc Sign Tool is a command line program. For example, open the command prompt and execute tcsigntool sign /? to display the help. The program can be found here: Build 4026: C:\Program Files (x86)\Beckhoff\Twin CAT\3.1\SDK\Bin Build 4024: C:\Twin CAT\3.1\SDK\Bin Operating Tc Sign Tool from MATLAB® From MATLAB®, the tool can be started with the command system() or with !. Sample call for signing a tmx driver for Twin CAT: Tc Sign Tool sign /f "C:\Twin CAT\3.1\Custom Config\Certificates\ My Certificate.tccert" /p My Password "C:\Twin CAT\3.1\Repository\TE140x Module Vendor\Modul Name\0.0.0.1\Twin CAT RT (x64)\My Driver.tmx" Behavior of the Twin CAT runtime If a Twin CAT object created from MATLAB® or Simulink® with a signed driver is used in a Twin CAT Solution and loaded onto a target system with Activate Configuration, the following must be observed: Test mode for non-countersigned certificates If you use a non-countersigned OEM certificate for signing, you must set your target system into test mode. To do this, run the following command as an administrator on the target system: bcdedit /set testsigning yes If you are using a countersigned OEM certificate, this step is not necessary. Whitelist for certificates on target systems Each Twin CAT runtime (XAR) has its own whitelist of trusted certificates. Behavior with Twin CAT Build 4026 The Twin CAT-XAE checks whether all certificates required to activate the configuration are in the whitelist on the runtime system. If this is not the case, a pop-up window appears. You can set the whitelist entries there. Behavior with Twin CAT Build 4024 If the certificate used for signing is not included in this whitelist, the driver will not be loaded. A corresponding error message is output in Twin CAT Engineering (XAE). 98 Version: 2.4.1 TE1400

## Page 99

From version 2.x.xxxx.x The error message contains the instruction to execute a registry file, which was automatically created on the target system, on the target system as administrator. This process adds the used certificate to the whitelist. Registry file is only dependent on the OEM certificate The registry file can also be used on other target systems. It only contains information about the OEM certificate used and is not target system dependent. 4.4 Quick start The following Quickstart shows you how to convert a Simulink® model into a Twin CAT object. If you are interested in how such a created Twin CAT object is integrated in Twin CAT XAE, see Try out created Twin CAT objects yourself [} 247]. Starting with a simple Simulink® model ü Feel free to use our built-in samples for first steps with the Twin CAT Target for Simulink®. The MATLAB® Command Window provides a list of available samples via Twin CAT. Module Generator. Samples. List 1. For example, select the sample “Generate Twin CAT Classes From Simulink Models” and start the sample via the Start link in the Command Window. Twin CAT. Module Generator. Samples. Show('Generate Twin CAT Classes From Simulink Models') ð In the following, the Quickstart is executed along this sample. 2. Start at the beginning by selecting the button Open the model in the Live Script. ð For the further configuration steps in Simulink®, you can simply click on the next button in the Live Script. TE1400 Version: 2.4.1 99

## Page 100

From version 2.x.xxxx.x Beginner video The following video (only available in English) can also be used as an introduction: Twin CAT Target for Simulink® The configuration steps in Simulink® 1. Select a fixed-step solver. To do this, go to the Configuration Parameters of the model. 2. Select the system target file to “Twin Cat Grt.tlc”. Optional: Under Optimization, set the parameter Default parameter behavior to Tunable so that you can continue to change model parameters in Twin CAT, see also Parameterization of a module instance [} 190]. 3. Save your changes in the Simulink® model. 4. Start code generation via Simulink® Coder™ App. 100 Version: 2.4.1 TE1400

## Page 101

From version 2.x.xxxx.x Insert Tc COM in Twin CAT 1. Open Twin CAT (Twin CAT XAE or Twin CAT in a Visual Studio environment). 2. Instantiate a new Tc COM object. 3. Select the desired object. 4. Create a cyclic task. TE1400 Version: 2.4.1 101

## Page 102

From version 2.x.xxxx.x 5. Assign the created task to your Tc COM instance. Note that the cycle time of the task and the Sample Time in Simulink® (here 5 ms) match. 6. Activate the configuration. 102 Version: 2.4.1 TE1400

## Page 103

From version 2.x.xxxx.x Configure and link Tc COM instance The data exchange of the Tc COM instance takes place via mappings of the process image. Simulink® inputs and Simulink® outputs are automatically mapped as inputs or outputs in the process image and can be linked to I/O or other objects. In the Parameters (Init) area of the Tc COM instance, you can optionally configure the instance differently than specified when it was created from Simulink®. For example, you can set the parameter Kp to "52" here. The Tc COM module would then use this value as the startup value for this instance. Insert as PLC function block The PLC library used in the following is only available if the following parameters are set in Simulink®: If these options have not been set, this can be done subsequently without using Simulink® and the Twin CAT Target for Simulink®, see Create and install PLC library [} 210]. Brief overview of action steps PLC library/function block • Create PLC in Twin CAT: TE1400 Version: 2.4.1 103

## Page 104

From version 2.x.xxxx.x • Add PLC library: • Select PLC library and view content: 104 Version: 2.4.1 TE1400

## Page 105

From version 2.x.xxxx.x • Use the function block from the library in the PLC: Calling a Tc COM object also possible from the PLC In addition to the variant described here, you can also call up an instance of a Tc COM from the PLC, see Applying the Tc COM Wrapper FB [} 213]. Further sample After you have successfully completed the Beginner's sample, we recommend the following sample to deepen your knowledge: Twin CAT. Module Generator. Samples. Show("Generate Twin CAT Classes From Simulink Models - Extended") 4.5 Twin CAT Library in Simulink® Specific blocks for the Twin CAT Target for Simulink® are located in the Library Browser > Beckhoff Twin CAT Target area. TE1400 Version: 2.4.1 105

## Page 106

From version 2.x.xxxx.x 4.5.1 Twin CAT Input and Output modules Twin CAT-specific input and output function blocks can optionally be used in Simulink®. Another valid way is to use the standard input ports (In) and output ports (Out) of Simulink®. This is usually also the best practice way, unless the additional functions of the Twin CAT input and output modules described below are required. 106 Version: 2.4.1 TE1400

## Page 107

From version 2.x.xxxx.x Additional functions of the TC Module blocks If you use the input function blocks (TC Module Input) and output function blocks (TC Module Output) provided by Beckhoff, you will benefit from the following additional functionalities, compared to the standard Simulink® input and output ports: • You can also define signals and buses from subsystems directly as inputs or outputs for Tc COM, without first transferring the signals/buses from the subsystem to the top system. Sample: Subsystem inputs and outputs [} 108]. • You can optionally store an automatic mapping to other Tc COM or I/Os in the block parameters so that the mapping is executed automatically directly when the Tc COM is instantiated, see Automatic mapping [} 108]. • You can select individually between Mapping and Data Pointer for the connection type of each TC Module Inputs/Outputs. You can make all Standard Input Ports accessible via mapping, for example, and make others accessible via the TC Module Inputs via Data Pointer, see Data Area or Data Pointer [} 110]. Sample: Shared memory between Tc COM instances [} 153]. • You can influence the Symbol Name, i.e. change the name and hierarchy of the input or output in the process image, for example, see Symbol Name [} 111]. • You can equip signals and buses with specific Symbol Properties, see Symbol properties [} 111]. • You can use initial values for inputs. To do this, set the Value of the TC Module Inputs to any value, see Initial values [} 112]. TE1400 Version: 2.4.1 107

## Page 108

From version 2.x.xxxx.x Initial values can also be implemented for Standard Input Ports, see Option Input: Initial values under TC Tc Com Interfaces [} 146]. When using automatic mapping, please note that if the Tc COM is instantiated more than once in Twin CAT, you will end up with a mapping conflict which you must resolve by manual mapping. This option is therefore not recommended for multiple instantiations. 4.5.1.1 Subsystem inputs and outputs Creating a Tc COM input/output from a Simulink® subsystem A Simulink® model is created, which outputs two negated inputs. An input is placed in a subsystem, see figure below. According to the described property of the TC Module Input/Output blocks, the TC Module Input in the Simulink® subsystem in Twin CAT is also included in the process image of the Tc COM. Thus, it is not necessary to route to the top level of the Simulink® model, as is the case with standard in-ports or out-ports. 4.5.1.2 Automatic mapping The inputs and outputs of the Simulink® model are automatically mapped to digital inputs and outputs in the following. This means that after instantiation of the Tc COM in a Twin CAT project, the mappings are created automatically. Manual linking is no longer necessary. Navigate to the parameter Link to Twin CAT XAE tree item identifier in the Block Parameters of the Tc Module In or Tc Module Out under Advanced. You can either enter the Tree Item Identifier and the data type manually, or select them from Simulink® via a browser. By selecting the Link button a new dialog opens. You can now load an existing Twin CAT project (Select Project) and browse the existing inputs or outputs or you can create a new project (New Project) and automatically scan the Ether CAT fieldbus in the new project to link it with the detected I/Os. ü Create a new project and display and select inputs and outputs of the target: 1. Create a new project. 108 Version: 2.4.1 TE1400

## Page 109

From version 2.x.xxxx.x 2. For this purpose, select a memory path of the new Twin CAT project to be created. 3. Select the target to which you want to download the project. 4. Automatically scan the I/O tree of the target. ð All inputs and outputs of the target are displayed and can be selected. By selecting the input or output you want to link, the tree item identifier is automatically set and the appropriate data type is automatically entered in Simulink®. If the Simulink® model described above is compiled into a Tc COM and integrated in a Twin CAT 3 Solution, a mapping to the inputs and outputs selected in Simulink® is automatically created. Coloring of the symbols for differentiation: the automatically generated mappings are provided with a blue symbol, while manual mapping symbols are displayed white. TE1400 Version: 2.4.1 109

## Page 110

From version 2.x.xxxx.x 4.5.1.3 Data Area or Data Pointer By default, "Data Area (Input Dst)" is selected as Input connection type at generated Twin CAT module. This means that a TC Module Input is created as Input Destination Data Area and a TC Module Output accordingly as Output Source Data Area. Alternatively, "Data Pointer" can also be selected here, see Shared memory between Tc COM instances [} 153]. 110 Version: 2.4.1 TE1400

## Page 111

From version 2.x.xxxx.x If the Simulink® model shown above is created with the Target for Simulink®, 2 inputs and 2 outputs appear in the process image on the Tc COM instance if "mapping" is selected as Input connection type at generated Tc COM module. 4.5.1.4 Symbol properties You can define specific symbol properties for the TC Module In/Out blocks, see Symbol Properties and Attribute Pragmas [} 170]. Sample: OPC. UA. DA.=1 Restriction The symbol name must not be nested when using symbol properties. 4.5.1.5 Symbol Name You can change the name and thus the display of the symbol in the process image at Symbol name. In the following sample, a TC Module Input is nested in two subsystems. The default name resolution is (as can be seen to the right of the name symbol) <Subsystem>.<Subsystem>.<Tc Module Name>. TE1400 Version: 2.4.1 111

## Page 112

From version 2.x.xxxx.x The process image looks like this: Especially in cases where there is very deep nesting, it may be desirable to shorten the symbol name. You therefore have the option of entering the symbol name manually as text, e.g. 'Subsystem. Input Value'. 4.5.1.6 Initial values In addition to data type, dimension and Sample Time, an optional Value field is editable in addition to the standard Simulink® in-port and out-port. This field allows you to specify an initial value for the input (only available for TC Module Input). If the input in Twin CAT is not linked to a corresponding output, the value entered here is used as the input value. 112 Version: 2.4.1 TE1400

## Page 113

From version 2.x.xxxx.x 4.5.2 Twin CAT Environment View Drag the Twin CAT Environment View into your Simulink® environment to directly get the available Twin CAT XAE version and the currently installed TE1400 version displayed, for example for support cases. 4.5.3 Twin CAT File Writer The Twin CAT File Writer block writes .mat files from the Twin CAT environment. The block only fulfills this function if the Simulink® model has already been transferred to a Tc COM or FB and is executed in a Twin CAT Runtime. If the Simulink® model is executed in Simulink®, this block has no function. TE1400 Version: 2.4.1 113

## Page 114

From version 2.x.xxxx.x Parameter Description Note Port data type Data type of the incoming signal Support is offered for: • Integer Types • float • double • boolean • enums • bus objects Port dimension Dimensionality of the incoming -1 -> Inherit signal Otherwise [1,2], [1,5], ..., for example Sample Time Block Sample Time in seconds -1 -> Inherit 114 Version: 2.4.1 TE1400

## Page 115

From version 2.x.xxxx.x Parameter Description Note file name File name of the .mat file Full path or relative path possible. Relative path relative to Twin CAT\3.1\Boot. Maximum file byte size Maximum size (in bytes) of 0 -> Maximum due to file format the .mat file. When this size is reached, the current file is closed and a new one is started. Maximum file count Maximum number of .mat files to 0 -> Infinite files. If the maximum is write. reached, old files are overwritten, starting with _part0.mat. Pause writing files Pauses writing Parameters on the Tc COM Write simulation time with data Writes per date a structure with 2 fields, “time” and “data”. Expose Pause as block input Creates an input via which the Twin CAT File Writer can be paused. Closed opened file on Pause If enabled, the written .mat file is completed as soon as writing is paused. 4.6 Overview of automatically generated files When a build process is initiated, some files and folders are created automatically. "Where are the files located?", "What can be done with them?" and "What do the files mean?" These questions are answered below. What are the categories of automatically generated files? • Source code is generated [} 115]. • Log files are generated [} 117]. • The Twin CAT objects, drivers (*.tmx) and description files (*.tmc, *.library, ...) are created [} 118]. All files created by the Twin CAT Target are summarized in the current MATLAB® path in the folder <Simulink Model Name>_tcgrt. The folder is located next to the slprj folder generated by Math Works®. Generated source code The central file for the source code is <Simulink Model Name>.vcxproj and is located in the <Simulink Model Name>_tcgrt folder. The file opens a Twin CAT C++ project, which can be used to inspect the generated source code, to subsequently build Twin CAT objects or also for debugging in Twin CAT [} 218]. TE1400 Version: 2.4.1 115

## Page 116

From version 2.x.xxxx.x With regard to the build option from the generated Twin CAT C++ project, it is worth knowing that you can switch off the publish step, i.e. building for the configured platforms, in Simulink®. You can achieve code generation without build in Simulink® by deselecting Run the publish step after project generation. The publish step contains the build of the Twin CAT objects for the selected platforms (Twin CAT RT x86, x64 ...). 116 Version: 2.4.1 TE1400

## Page 117

From version 2.x.xxxx.x Further useful information: Build on a system without MATLAB® (Build Agent [} 133]) Generated log files The generated log files are summarized in the subfolder log. The log files created are the first place to look when debugging. This folder contains up to three log files. The main point of contact is the summary of all logs in the file <Model Name>_Module Generation Log.txt. Beckhoff Support requires log file If you require assistance from our support team, please send at least the following file from the log folder: <Model Name>_Module Generation Log.txt TE1400 Version: 2.4.1 117

## Page 118

From version 2.x.xxxx.x The structure of the Module Generation Log is divided into several segments that represent different steps of the Twin CAT Target. The steps are displayed with ### in the log. Sample: 2023-10-18 14:48:37: ### Starting build procedure for: Simple Temp Ctrl 2023-10-18 14:48:43: ### Save TLC export 2023-10-18 14:48:47: ### Export block diagram 2023-10-18 14:48:47: Block diagram export succeeded 2023-10-18 14:48:48: ### Export Twin CAT C++ project 2023-10-18 14:48:53: ### Save project 2023-10-18 14:48:53: The Twin CAT C++ project "C: \Users\xyz\Documents\MATLAB\TE14xx Samples\2023-10-18_13-58_Simple Temperature Controller\Simple Temp Ctr l_tcgrt\Simple Temp Ctrl.vcxproj" was generated successfully If no warnings or errors occur in the steps, no entries are usually made for the steps performed. In some cases, explicit reference is made to created files, such as the vcxproj file created in the sample above. Reference is also made to other log files for more detailed information, see the following sample: 2023-10-18 14:48:53: ### Publish TMX 2023-10-18 14:48:53: Configuration: "Release" 2023-10-18 14:48:53: Platform(s): "Twin CAT RT (x86);Twin CAT RT (x64);Twin CAT OS (x64)" 2023-10-18 14:48:53: Twin CAT SDK: "C:\Twin CAT\3.1\SDK\" (Version 3.1.4024.50) 2023-10-18 14:48:53: Platform Toolset: V142 (Automatically selected) 2023-10-18 14:48:53: Microsoft (R) Build Engine version 16.11.2+f32259642 for . NET Framework 2023-10-18 14:48:53: Copyright (C) Microsoft Corporation. All rights reserved. 2023-10-18 14:49:06: Publish procedure completed successfully 2023-10-18 14:49:06: See log file "C: \Users\xyz\Documents\MATLAB\TE14xx Samples\2023-10-18_13-58_Simple Temperature Controller\Simple Temp Ctr l_tcgrt\log\Simple Temp Ctrl_Publish Log.txt" for details If warnings or errors occur, these are displayed in the Module Generation Log. The detailed logs, on the other hand, contain all the outputs of the step performed. For example, warnings can be seen here in the signature verification area of the created tmx files: 2023-10-18 14:49:06: ### Publish summary 2023-10-18 14:49:06: Configuration: "Release" 2023-10-18 14:49:06: Platform(s): "Twin CAT RT (x86);Twin CAT RT (x64);Twin CAT OS (x64)" 2023-10-18 14:49:06: Twin CAT SDK: "C:\Twin CAT\3.1\SDK\" (Version 3.1.4024.50) 2023-10-18 14:49:06: Platform Toolset: V142 (Automatically selected) 2023-10-18 14:49:06: Vendor name: TE140x Module Vendor 2023-10-18 14:49:06: Library name: Simple Temp Ctrl 2023-10-18 14:49:06: Library version: 2.0.1.24 2023-10-18 14:49:06: Local installation folder: "C:\Twin CAT\3.1\Repository\TE140x Module Vendor\Simple Temp Ctrl\2.0.1.24" 2023-10-18 14:49:06: TMX archive: - 2023-10-18 14:49:06: Signatures: 2023-10-18 14:49:06: File 'C:\Twin CAT\3.1\Repository\TE140x Module Vendor\Simple Temp Ctrl\2.0.1.24\Twin CAT RT (x86)\Simple Temp Ctrl.tmx' has signature. 2023-10-18 14:49:06: issuer Test Sign123 (x.yz@beckhoff.com), certificate expires on 08/15/2025 2023-10-18 14:49:06: Warning: Signature found, but OEM certificate was not signed by Beckhoff. Driver can only be used in test mode. 2023-10-18 14:49:06: File 'C:\Twin CAT\3.1\Repository\TE140x Module Vendor\Simple Temp Ctrl\2.0.1.24\Twin CAT RT (x64)\Simple Temp Ctrl.tmx' has signature. 2023-10-18 14:49:06: issuer Test Sign123 (x.yz@beckhoff.com), certificate expires on 08/15/2025 2023-10-18 14:49:06: Warning: Signature found, but OEM certificate was not signed by Beckhoff. Driver can only be used in test mode. 2023-10-18 14:49:06: File 'C:\Twin CAT\3.1\Repository\TE140x Module Vendor\Simple Temp Ctrl\2.0.1.24\Twin CAT OS (x64)\Simple Temp Ctrl.tmx' has signature. 2023-10-18 14:49:06: issuer Test Sign123 (x.yz@beckhoff.com), certificate expires on 08/15/2025 Created Twin CAT objects After a successful build, the binary files and description files created, which can be re-used in Twin CAT XAE, are stored in the so-called Engineering Repository, i.e. on the engineering PC at: %Twin CATInstall Dir% \3.1\Repository\<Vendor>\<Model Name>\<Version>\ 118 Version: 2.4.1 TE1400

## Page 119

From version 2.x.xxxx.x • <Model Name>.tmc: Description file of the Tc COM object (object class) • <Model Name>.tml: Library file: Can be used like .library file. • <Model Name>.library: Twin CAT PLC library file • Deploy\<Model Name>_Module Info.xml: Module information, e.g. block diagram • <Platform>\<Model Name>.tmx: Driver file Distribution of Twin CAT objects to other XAE systems: If the folder at <Model Name> level is copied to other PCs with Twin CAT XAE in the local Engineering Repositories, their users can use the created Twin CAT objects in their Twin CAT Solutions. Compare also Sharing created Twin CAT objects [} 136]. Please note Description of the generated C++ files and binary files Versioned C++ projects 4.7 Parameterization of the code generation in Simulink® Within Simulink® a large number of settings can be made for the configuration of the Twin CAT objects to be generated (Tc COM and function blocks). For this purpose the tree structure under Code Generation is extended by several entries (see entries starting with TC) as soon as you have selected the Twin Cat Grt.tlc as System target file. TE1400 Version: 2.4.1 119

## Page 120

From version 2.x.xxxx.x Configure View Due to the wide range of configuration options, it is possible to switch the view. After installation, the configuration level is set to Standard, which displays only the most frequently used parameters. You can also increase the configuration level to Advanced to be able to make significantly more settings. Use the MATLAB® Command Window to set the view: Twin CAT. Module Generator. Settings. Change('Configuration Level', 'Advanced') Twin CAT. Module Generator. Settings. Change('Configuration Level', 'Standard') The setting made is initially only temporary. To save them, use the Save command: Twin CAT. Module Generator. Settings. Save; If you run the code generation and build process on different systems, make sure that the configuration level is identical on both systems. Overview of the configuration parameters An overview of all configuration parameters can be found in the documentation in section Overview table of all configuration parameters [} 122]. Read the tooltips Hover with the cursor over the text fields of the dialog boxes to bring up a detailed description of the option as a tooltip. Change the software setup To change the default settings of the Twin CAT target, you can access a dialog in the MATLAB® Console as follows: 120 Version: 2.4.1 TE1400

## Page 121

From version 2.x.xxxx.x Twin CAT. Module Generator. Settings. Edit Here you are offered various entries that you can store as default values. Accept changes 1. Enter the new default settings in the dialog box. 2. Confirm with the Save button. 3. Restart MATLAB®. ð The changes have been adopted. Change configurations after build Many settings selected in the Configuration parameters can be changed again in Twin CAT 3 at the level of the Tc COM instances, so that, for example, it is defined for the class of a model that it is to be called via a cyclic task, but the individual instance can also be configured subsequently for calling from the PLC. TE1400 Version: 2.4.1 121

## Page 122

From version 2.x.xxxx.x 4.7.1 Overview table of all configuration parameters An overview of all configuration parameters is given below. The configuration parameters are visible or invisible depending on the set configuration level in the UI of Simulink®. If you configure the module generator via an m-file [} 129], the configuration level has no influence. To see all of the parameters described below in the UI, switch to the Advanced configuration level: Twin CAT. Module Generator. Settings. Change('Configuration Level', 'Advanced') A brief description is given for each parameter and in some cases reference is made to other sections of the documentation for more detailed information. The categorization is based on the representation in the UI. In the UI, the display name is used. If you use the module generator via an m-file, the column “Name” is crucial. Category Name Displayname Default Description TC General Generate Generate Twin CAT TRUE Generate a Twin CAT C++ project. C++ Project If unset, only code artifacts will be generated which can get used to generate C++ projects later [} 129]. Project Dir Twin CAT C++ Project Full path to the directory with the Directory VCXPROJ file (e. g. "C:\Temp") Project Name Twin CAT C++ Project Name to the generated Name VCXPROJ file (e. g. "My Generated Project.vcxproj") Lowest Compati Lowest compatible $<Twin CAT:Ver The lowest Twin CAT build ble Tc Build Twin CAT version sion:BUILD> number the generated C++ (build number) project and its modules and POUs are to be compatible with. Class Factory Na Class factory name $<Project:Name Name of the generated C++- me > Project, Name of the Tc COM classfactory and tmx-file name Product Name Product name $<Module Gener Product name, used e.g. for the ator:Product Id> module driver description and the $<Module Gener module TMC description [} 162]. ator:Version:MA JOR. MINOR> Copyright Copyright notice Copyright Copyright notice of the generated $<Vendor Name module driver file [} 162] > $<Local Date Ti me:%Y> Description Driver description Twin CAT Driver description [} 162] executable file, generated by Twin CAT $<Module Gener ator:Product Id> Vendor Name Vendor name TE140x Module Module vendor name, used as the Vendor company name of the generated executables in the repository [} 118] and the major module group as shown in the Twin CAT XAE module dialog. Version Src Version source file $<Latest TMFile Path to an existing TMC, TML or > XML file containing the previous version value [} 140]. Increment Versi Version part for Revision The part of the version number on increment that is to be incremented [} 140]. 122 Version: 2.4.1 TE1400

## Page 123

From version 2.x.xxxx.x Category Name Displayname Default Description Drv File Version Driver file version $<Version From Executable file version and library File> version. [} 140] Drv Product Vers Driver product version $<Drv File Versio Product version [} 140] ion n> Code Gen Place Code generation Define custom placeholders holders placeholders Use Data Excha Load 0 Manually set nge Modules Data Exchange Module Data Exchange Module [} 138] s dependency (currently no need to set manually) Max Visible Arra Maximum number of 200U Specifies the maximum number of y Elements visible array elements array elements to be displayed in the Twin CAT XAE. In the Twin CAT XAE, larger arrays cannot get expanded and linked to by its individual items Pack Output Pat Pack output path Path to pack the generated h Twin CAT C++ project. Optional [} 133]. Can be a directory or .zip file. See Sample "Use Continuous Integration Principles with Code Generation" TC Build Prefer Tool Archi Prefer X64 build tools TRUE Prefer X64 compiler and linker. tecture X64 Useful for complex source files, where X86 tools may run out of heap space. Cpp Language S Specify C++ language Default Enable supported C++ language tandard standard version features from the specified version of the C++ language standard Verbosity Codegeneration and Normal Verbosity level of code generation build verbosity and build output messages. Silent and Detailed are other possible values. Publish Run the publish step TRUE Start the build procedure after after project code generation for all selected generation platforms. The generated module binaries and module descpription files will get copied to the "publish folder". Published modules are automatically located by the XAE and can get instantiated in all Twin CAT 3 projects. If unset, the module generation process will be stopped after code generation. To instantiate in a Twin CAT3 project, the generated C++ project needs to be inserted and built from. Publish Platform Platform Toolset Auto Choose Platform Toolset to build toolset binaries. Publish Configur Build configuration Release Build configuration to build ation binaries. Publish Tc RTx8 Twin CAT RT (x86) TRUE Publish binaries for platform 6 'Twin CAT RT (x86).' [} 132] Publish Tc RTx6 Twin CAT RT (x64) TRUE Publish binaries for platform 4 'Twin CAT RT (x64).' [} 132] TE1400 Version: 2.4.1 123

## Page 124

From version 2.x.xxxx.x Category Name Displayname Default Description Publish Tc OSx6 Twin CAT OS (x64) TRUE Publish binaries for platform 4 'Twin CAT OS (x64)' (e.g. Twin CAT/ BSD) [} 132] Publish Tc OSA Twin CAT OS FALSE Publish binaries for platform RMv8A (ARMV8-A) (Twin CAT 'Twin CAT OS (ARMV8-A)' XAE >= 3.1.4026) (requires Twin CAT XAE >= 3.1.4026) [} 132] Force Rebuild Fo Always rebuild all FALSE Always rebuild all source files on r Publish source files on publish publish Publish Parallel Build parallel to TRUE Build parallel on multiple cores to publish publish Sign Twin Cat Ce Certificate name for Certificate name for Twin CAT rt Name Twin CAT signing signing with OEM Certificate level 2. [} 92] Tmx Install Install TMX TRUE Install all generated Twin CAT Objects on local XAE (fill local Engineering Repository [} 118]). Tmx Archive TMX Archive Name of an optional archive containing all files required to use the generated Twin CAT Objects on another Twin CAT development system. [} 136] Ms Build Publish Ms Build publish Set additional Ms Build publish Properties properties properties. Ms Build Proj Pro Ms Build project Set additional Ms Build project perties properties properties. Pre Code Gener Pre code generation The defined MATLAB® function is ation Callback Fc callback function called before code generation n [} 186]. Post Code Gener Post code generation The defined MATLAB® function is ation Callback Fc callback function called after code generation n [} 186]. Post Publish Call Post publish callback The defined MATLAB® function is back Fcn function called after publish [} 186]. Deployment Pat Deployment project Full path to a Twin CAT project h (.tsproj). Instances of the generated Tc COM Module in the specified project will be upgraded to the newly generated version [} 138] Deploy Restart Activate and restart FALSE If set the specified Twin CAT deployment project project will be activated and restarted on the configured target system [} 138] Post Deploy Call Post deploy callback The defined MATLAB function is back Fcn function called after deployment [} 186] TC PLC library Lib Cat Path PLC library category $<Project Dir>\ Path to the PLC library category description file $<Name>.libcat description file .xml 124 Version: 2.4.1 TE1400

## Page 125

From version 2.x.xxxx.x Category Name Displayname Default Description Library Categori PLC library categories $<Vendor Name Define PLC library category es > hierarchy. Default only one hierarchy level = vendor. List separated with | possible: <Main Category>| <Sub Category1>|… Generate Plc Lib Generate a PLC FALSE Generate a PLC library with POUs. rary library [} 210] Define containing POUs with parameter Tc Com Wrapper Fb and Plc Fb>General>Generate. Install Plc Library Install the generated FALSE Install the generated PLC library PLC library for use in the local Twin CAT XAE/ PLC [} 210]. Plc Type Prefixe Type Prefixes Define custom type prefixes s Plc Var Prefixes Variable Prefixes `PVOID=p \| Define custom variable prefixes. BOOL=b \| BOOL32=b \| DATE=d \| TIME_OF_DAT E=td \| TIME=t \| LTIME=t \| GUID=n` TC License Oem Id ID of OEM ID of OEM. Required for OEM Licence checks [} 159] Oem Licenses IDs of OEM Licenses IDs of OEM Licenses. Multiple IDs may be inserted as a comma separated list. "{GUID},{GUID}" [} 159] TC Tc Com Generate Generate Tc COM TRUE Generate a Tc COM module class General Module (Twin CAT for the model. Module Class) Online Change Online change FALSE Allow to switch between different support Tc COM module versions without switching Twin CAT runtime to config mode. Module Properti TMC Properties Additional properties added to the es module description in the TMC file: Name1=Value1| Name2=Value2|... Group Name Group Name TE140x\| Minor module group name in the Simulink Twin CAT XAE module dialog Modules Group Display N Group Display Name $<Group Name> Minor module group description in ame the Twin CAT XAE module dialog Group Icon Group Icon $<TE140x:Icon Optional module group icon in the > Twin CAT XAE module dialog Module Icon Module Icon $<TE140x:Icon Optional module icon in the > Twin CAT XAE module dialog Init Exception Ha Floating point Caller Exception Configures how to throw, ndling exception handling s suppress or handle floating point during initialization exceptions during initialization [} 224]. TE1400 Version: 2.4.1 125

## Page 126

From version 2.x.xxxx.x Category Name Displayname Default Description Update Exceptio Floating point Caller Exception Configures how to throw, n Handling exception handling s suppress or handle floating point during update exceptions during cyclic execution [} 224]. Additional Includ Additional include files Additional files required to be e Files included after rtwtypes.h TC Tc Com Oem Licenses IDs of OEM License $<Project:Oem IDs of OEM Licenses. Multiple IDs License Licenses> may be inserted as a comma separated list. "{GUID},{GUID}" [} 159] TC Tc Com Tc Com Wrapper Tc Com Wrapper FB FALSE Generate a PLC Functionblock Wrapper Fb simplifying the interaction between a PLC and an instance of the generated Tc COM module [} 213] Tc Com Wrapper Tc Com Wrapper FB FALSE Generate properties for accessible Fb Properties properties data in the referenced Tc COM object [} 213] Tc Com Wrapper Tc Com Wrapper FB No Monitoring No Monitoring: Online values of Fb Property Moni property monitoring properties are not monitored in toring the PLC online view, Cyclic Update: Update property values in the PLC online view cyclically, Execution Update: Update property values in the PLC online view when the property getter or setter is called [} 213] TC Tc Com Module Caller Default module caller Cyclic Task Cyclic Task: Call module via Additional Twin CAT Task. Module: Cal settings module from another Twin CAT module (see e.g. Tc COM- Wrapper-FB). Caller Verificatio Verify caller Default Verify the caller context to prevent n concurrent execution of the model code and corresponding Data Area mappings. Skip verification to reduce the execution time. Step Size Adapta Default Step Size Require Matchin Configure how to handle tion adaptation mode g Task Cycle Tim differences between the default e model step size(s) and the cycle time of the assigned task(s). Execution Sequ Default execution Update Before O Configure the execution order of ence sequence utput Mapping input mapping, model code execution and output mapping. Execute Model C Execute model code TRUE Start cyclic execution of the model ode after startup code after startup by default. If FALSE, Module Parameter Execute needs to be set to TRUE to start execution of code. 126 Version: 2.4.1 TE1400

## Page 127

From version 2.x.xxxx.x Category Name Displayname Default Description Block Diagram E Export Block Diagram TRUE Export graphical block diagram xport information for monitoring and optional debugging on the generated Twin CAT module in Twin CAT XAE [} 197] Resolve Masked Resolve Masked FALSE Resolve masked subsystems in Subsystems Subsystems the block diagram Extend Signal Re Extended resolution of FALSE Intensified search for assignments solution signals in block of variables and block diagram diagram signals (blue signals). This option increases the build time. [} 239] Block Diagram V Access to Assign To Parent Variables from a block within an ariable Access Variable Group not unresolved subsystem are either referenced by any assigned to the next higher visible block block or hidden in the block diagram. Block Diagram D Export Block Diagram TRUE Export additional information ebug Info Export debug info required to debug the module using the block diagram [} 201]. TC Tc Com Execution Info O Create Execution Info FALSE Create additional output Interfaces utput output Data Areas containing execution and exception information [} 224]. Monitor Executio Monitor execution FALSE Calculate and expose the n Time time execution time of the module as an ADS variable for monitoring purposes. Input Data Acces Input: Data Access Input Defines how the input variables s Destination are exposed in Twin CAT [} 146]. Data Area Input Create Sy Input: Create ADS TRUE Create ADS symbol information mbols Symbols for the input variables [} 146] Input Init Values Input: Initial values FALSE Create module parameters for the input variables to allow definition of initial values [} 146] Input Properties Input: TMC Properties Additional properties added to the Input symbol description in the TMC file. [} 170] Output Data Acc Output: Data Access Output Source Defines how the output variables ess Data Area are exposed in Twin CAT [} 146]. Output Create Sy Output: Create ADS TRUE Create ADS symbol information mbols Symbols for the output variables [} 146]. Output Propertie Output: TMC Additional properties added to s Properties the Output symbol description in the TMC file. [} 170] Parameters Dat Parameters: Data Internal Defines how the model parameter a Access Access Data Area variables are exposed in Twin CAT [} 146] Parameters Cre Parameters: Create TRUE Create ADS symbol information ate Symbols ADS Symbols for the model parameter variables [} 146]. TE1400 Version: 2.4.1 127

## Page 128

From version 2.x.xxxx.x Category Name Displayname Default Description Parameters Init V Parameters: Initial TRUE Create module parameters for the alues values model parameter variables to allow definition of initial values [} 146]. Parameters Pro Parameters: TMC Additional properties added to perties Properties the Parameters symbol description in the TMC file. [} 170] Block Io Data Acc Block IO: Data Access Internal Defines how the Block IO variables ess Data Area are exposed in Twin CAT [} 146] Block Io Create S Block IO: Create ADS TRUE Create ADS symbol information ymbols Symbols for the Block IO variables [} 146]. Block Io Properti Block IO: TMC Additional properties added to es Properties the Block IO symbol description in the TMC file. [} 170] Cont State Data Cont State: Data Internal Defines how the continuous state Access Access Data Area variables are in Twin CAT [} 146] Cont State Creat Cont State: Create TRUE Create ADS symbol information e Symbols ADS Symbols for the continuous state variables [} 146]. Cont State Prope Cont State: TMC Additional properties added to rties Properties the Cont State symbol description in the TMC file. [} 170] DWork Data Acc DWork: Data Access Internal Defines how the DWork variables ess Data Area are exposed in Twin CAT [} 146] DWork Create Sy DWork: Create ADS TRUE Create ADS symbol information mbols Symbols for the DWork variables [} 146]. DWork Propertie DWork: TMC Additional properties added to s Properties the DWork symbol description in the TMC file. [} 170] Data Store Data Data Store: Data None Defines how the Data Store Access Access variables are exposed in Twin CAT [} 146] Data Store Creat Data Store: Create TRUE Create ADS symbol information e Symbols ADS Symbols for the Data Store variables [} 146]. Data Store Read Data Store: Read Only FALSE Restrict ADS access to be read Only only for the Data Store variables [} 146]. Data Store Prope Data Store: TMC Additional properties added to rties Properties the Data Store symbol description in the TMC file. [} 170] Symbol Properti Additional TMC Additional properties added to es Symbol Properties specific symbol descriptions in the TMC file. [} 170] Variable Symbol Mapping between Identical Defines the Twin CAT symbol Mapping variable names and names for the generated C/C++ ADS symbol names variables. 'Identical': Symbol name 128 Version: 2.4.1 TE1400

## Page 129

From version 2.x.xxxx.x Category Name Displayname Default Description equals variable name, 'Classic': Use symbol names known from TE1400 Release 1.2.x.x [} 146] TC Tc Com Ext Mode Rt Allo Allow Real Time FALSE Allow to start and stop model External Mode w Execution Co execution commands code execution via External Mode mmands via External Mode [} 221]. Ext Mode Rt Wait Wait for Real Time FALSE Wait for External Mode [} 221] For Start execution start connection before starting model command via External code execution. Mode Ext Mode Rt Allo Allow to change FALSE Allow to change parameter online w For Parameter parameters via values via External Mode [} 221]. Change External Mode TC Plc Fb Generate Generate Twin CAT TRUE Generate a PLC-FB for the model General PLC Function Block [} 217]. Init Exception Ha Floating point Caller Exception Configures how to throw, ndling exception handling s suppress, or handle floating point during initialization exceptions during initialization [} 224]. Update Exceptio Floating point Caller Exception Configures how to throw, n Handling exception handling s suppress, or handle floating point during update exceptions during cyclic execution [} 224]. TC Plc Fb Oem Licenses IDs of OEM License $<Project:Oem IDs of OEM Licenses. Multiple IDs License Licenses> may be inserted as a comma seperated list. "{GUID},{GUID}" [} 159] TC Plc Fb Monitor Executio Monitor FALSE Calculate and expose the Additional n Time Execution Time execution times of Twin CAT settings modules as an ADS variable for monitoring purposes. Plc Fb- Input Attributes Input variables: PLC Additional attributes added to the >Interface Attributes PLC FB Input variables. Output Attribute Output variables: PLC Additional attributes added to the s Attributes PLC FB Input variables. TC Plc Fb Ext Mode Rt Allo Allow Real Time FALSE Allow to start and stop model External Mode w Execution Co execution commands code execution via External Mode mmands via External Mode [} 221]. Ext Mode Rt Wait Wait for Real Time FALSE Wait for External Mode For Start execution start connection before starting model command via External code execution [} 221]. Mode Ext Mode Rt Allo Allow to change FALSE Allow to change parameter online w For Parameter parameters via values via External Mode [} 221]. Change External Mode 4.7.2 Parameterization of the code generation via an m-file There are two ways to parameterize the code generation via an m-file (or mlx-file): • via model-specific Simulink® parameters with set_param • via an instance of the module generator Twin CAT. Module Generator TE1400 Version: 2.4.1 129

## Page 130

From version 2.x.xxxx.x Configuration via Simulink® parameters With set_param you can assign specific parameters to an object in Simulink®. If you configure the module generator with set_param, it will be stored accordingly in the Simulink® model. To structure the configuration parameters [} 122] no namespace can be used here, therefore a prefix is set to the configuration parameters. The parameter name (“Name” column in the configuration parameter [} 122] table) is preceded by Project_, Tc Com_ or Tc Plc Fb_ depending on the level. • Project_ prefix: For all parameters that are grouped in the presentation of the configuration parameters in the tabs TC General, TC Build, TC PLC Library and TC License. • Tc Com_ prefix: For all parameters grouped in the presentation of the configuration parameters in the tabs TC Tc Com. • Tc Plc Fb_ prefix: For all parameters grouped in the presentation of the configuration parameters in the tabs TC Plc Fb. You can also find out the exact parameter name by using the search function in the Simulink® model. Sample % load Simulink model controller = load_system('Temp Ctrl.mdl'); % configure Twin Cat Grt set_param(controller,'System Target File','Twin Cat Grt.tlc'); % set project specific parameters set_param(controller,'Tc Project_Vendor Name','Company Name'); set_param(controller,'Tc Project_Generate Plc Library','on'); set_param(controller,'Tc Com_Online Change','on'); set_param(controller,'Tc Plc Fb_Monitor Execution Time','on'); % build the model 130 Version: 2.4.1 TE1400

## Page 131

From version 2.x.xxxx.x slbuild(controller); % save and close the model close_system(controller,1); Configuration via the module generator Parameter settings like in the sample above can also be made via the module generator. Thus, the settings do not remain in the Simulink® model, but in the instance of the module generator. For this purpose, only the System Target File is defined for the Simulink® model and the parameter Tc Project_Generate is switched off. This will only generate Code Artifacts, but no Twin CAT C++ project will be derived and accordingly not compiled. The code artifacts are stored in the current MATLAB® path in the folder <Model Name>_tcgrt. Export of the block diagram At the level of the Simulink® model, you should also decide whether you want to export the block diagram. In the following steps you will work on the Code Artifacts and no longer on the Simulink® model. You can specify the Code Artifacts folder afterwards to load a Project Export configuration to the Twin CAT. Modulgenerator. Here you can then make your settings and compile the project. Sample % load Simulink model controller = load_system('Temp Ctrl.mdl'); % configure Twin Cat Grt set_param(controller,'System Target File','Twin Cat Grt.tlc'); % disable generation of C++ project files for each model (suppresses build) set_param(controller,'Tc Project_Generate','off'); % create code artifacts slbuild(controller); % save and close the model close_system(controller,1); % find the code artifacts in the existing code generation directories controller Build Dir = fullfile(pwd,'Temp Ctrl_tcgrt'); % load existing export configurations controller Cfg = Twin CAT. Module Generator. Project Export Config. Load(controller Build Dir); % show complete configuration in MATALB Command Window controller Cfg % set project specific parameters controller Cfg. Project. Vendor Name = "Company"; controller Cfg. Project. Generate Plc Library = true; controller Cfg. Class Export Cfg{1}. Tc Com. Online Change = true; controller Cfg. Class Export Cfg{1}. Plc Fb. Monitor Execution Time = true; % set generate to true controller Cfg. Project. Generate = true; % instantiate and run the project exporter Twin CAT. Module Generator. Project Exporter(controller Cfg); Application examples The separation of the code generation process into the steps (1) creation of the Code Artifacts and (2) configuration of the module generator and creation of the Twin CAT objects, can be helpful in different scenarios: • You do not want to save the module generator settings in each Simulink® model. TE1400 Version: 2.4.1 131

## Page 132

From version 2.x.xxxx.x • You want to merge several Simulink® models into one project. [} 134] This combines all models in one driver and in one PLC library. Sample: Twin CAT. Module Generator. Samples. Start('Combine Multiple Twin CAT Classes In Libraries') • You are working with a Build Server or with a CI/CD system. Sample: Twin CAT. Module Generator. Samples. Start("Use Continuous Integration Principles with Code Generation") 4.7.3 Build for different platforms On the TC Build tab, you can adjust various settings to specify which compiler to use for each target system platform. Platform toolset: The default “Auto” always uses the latest version. A specific version can also be selected from the drop- down menu. Related versions Microsoft Visual C++ 14.1 => VS 2017 Microsoft Visual C++ 14.2 => VS 2019 Microsoft Visual C++ 14.3 => VS 2022 Build configuration: Build release or debug driver. Please note that a debug driver usually has a significantly slower execution time on the target system. Always rebuild all source files on publish: 132 Version: 2.4.1 TE1400

## Page 133

From version 2.x.xxxx.x Simulink® Coder™ and the Twin CAT Target for Simulink® cache some files to speed up the process for repeated builds. Select this parameter so that all source files are always rebuilt. Build parallel to publish: When multiple build platforms are selected, the compilation processes are independent of each other and executed sequentially. Activating this option causes all build processes to be executed in parallel on your engineering system. Parallelization is performed by the operating system. To avoid unnecessary waiting times, only create binaries for the platforms you use. Certificate name for Twin CAT signing If not specified via an environment variable, enter your OEM certificate level 2 here to sign the created binaries, see Setting up driver signing [} 95]. Twin CAT RT (x86) Select this platform to build binaries for a target system with the following specifications: Intel® or AMD CPU, Windows 32-bit operating system (Twin CAT platform level 40 and higher). Twin CAT RT (x64) Select this platform to build binaries for a target system with the following specifications: Intel® or AMD CPU, Windows 64-bit operating system (Twin CAT platform level 40 and higher). Twin CAT OS (x64) Select this platform to build binaries for a target system with the following specifications: Intel® or AMD CPU, Twin CAT/BSD operating system (Twin CAT platform level 40 and higher). Furthermore, this platform must be selected for execution with the Twin CAT Usermode Runtime. Twin CAT OS (ARMV8-A) Select this platform to build binaries for a target system with the following specifications: Arm® Cortex®-A CPU, Beckhoff RT Linux® operating system (Twin CAT platform level 20 and 30). Driver signing for Beckhoff RT Linux® not required No driver signing is required for Beckhoff RT-Linux®. This is mandatory for all other platforms. To support the Twin CAT OS (ARMV8-A) platform (for compiling for CX82xx and CX9240), the MSBuild Support for llvm (clang-cl) toolset component is required when installing Visual Studio. This must also be selected manually during installation. The Twin CAT OS (ARMV8-A) platform is only supported with Twin CAT 3.1. build 4026. 4.7.4 Build on a system without MATLAB® (Build Agent) If you want to build your Twin CAT objects on a development system without MATLAB® installation, e.g. using a build agent, you can use the so-called Pack-and-go feature (Pack'N Go) from Math Works®. The Twin CAT Target for Simulink® supports and extends this feature for Twin CAT development processes. Pack’N Go The Pack'N Go feature allows you to pack a project and all its dependencies. This makes it easier to transfer the project to different systems where it can be compiled. The original MATLAB® or Twin CAT environments are not required for this. Such a pack can be particularly advantageous in a CI context, as it enables more efficient use of MATLAB® agents. Creating a pack output Sample Twin CAT. Module Generator. Settings. Change('Configuration Level', 'Advanced'); model Name = 'Simple Temp Ctrl'; open_system(model Name); TE1400 Version: 2.4.1 133

## Page 134

From version 2.x.xxxx.x Twin CAT. Module Generator. Simulink. Model Export Config. Show Model Param(model Name,'Solver Type','Fixed- step'); Twin CAT. Module Generator. Simulink. Model Export Config. Show Model Param(model Name,'System Target File','Twin Cat Grt.tlc'); % add your custom settings here Twin CAT. Module Generator. Simulink. Model Export Config. Show Model Param(model Name,'Tc Project_Publish', fal se); % disable publish step Twin CAT. Module Generator. Simulink. Model Export Config. Show Model Param(model Name,'Tc Project_Pack Output Pat h', fullfile(pwd,'simple Temp Ctrl.zip')); % define name of pack output (also non zip is allowed 'simp le Temp Ctrl Pack' slbuild(model Name); % create pack output (without building) Sample in MATLAB®: Twin CAT. Module Generator. Samples. Start("Use Continuous Integration Principles with Code Generation"). Build Once you have created a pack output, e.g. 'simple Temp Ctrl.zip', you can copy this file to another Build system. The Build system then only requires Twin CAT XAE and Visual Studio Professional or an equivalent program (no Twin CAT Target and no MATLAB® installation). For Twin CAT Build 4026, install on the build agent: • Visual Studio Professional/Ultimate/Community 2017 or higher • Twin CAT Package Manager • TC1300 | Twin CAT 3 C++ Workload • Integrate the installed Twin CAT into the installed Visual Studio Unpack the pack output on the build agent and navigate to the vcxproj file. You can open the file from here in Visual Studio to build the project. You can also add the project as an existing element to your Twin CAT Solution (in the Twin CAT C++ area), or build the project via the msbuild command line interface (see first line in all Publish Log.txt files for reference). 4.7.5 Bundling of several models in one Twin CAT driver Automatically generated code from Simulink® models and MATLAB® functions can be bundled into a single C++ project. After the build process, all bundled objects are then available in one driver. Sample code in MATLAB® Open the appropriate sample with: Twin CAT. Module Generator. Samples. Start('Combine Multiple Twin CAT Classes In Libraries') Advantages of bundling When a PLC library is created, all created objects are then listed as a function block (FB) in this library. Although only one driver and one tmc file are created, all modules can still be instantiated individually at System > Tc COM, i.e. from the user's point of view in Twin CAT XAE nothing changes with regard to the use of the Tc COM objects. Using the PLC library increases the clarity. 134 Version: 2.4.1 TE1400

## Page 135

From version 2.x.xxxx.x Advantages of bundling in one driver: • The number of files in the repository directory is significantly reduced. This also means that fewer files have to be copied to other engineering systems in order to make a large number of modules available on engineering systems. • The management of different versions is simplified, as interacting modules can be exchanged in a bundle, so that no version conflicts arise. NOTICE Simulink® Coder™ does not support namespaces If data types or functions with the same naming are defined in multiple models, the build process fails because the definitions are in the same namespace. Procedure 1. Disable “Run the publish step after project generation” in Simulink®. This will abort after the code generation and the created C++ project will not be compiled. 2. When bundling multiple modules, simply use the generated folders <modelname>_tcgrt, which are placed in the current MATLAB® path. 3. Load, bundle and configure export configurations (<modelname>_tcgrt) in a project using Module Generator. 4. Create an export project. In the following, this is exemplified by the bundling of 2 export configurations: % find the code artifacts in the existing code generation directories controller Build Dir = fullfile(pwd,'Temp Ctrl_tcgrt'); ctrlsystem Build Dir = fullfile(pwd,'Temp Ctrl Sys PT2_tcgrt'); % load existing export configurations controller Cfg = Twin CAT. Module Generator. Project Export Config. Load(controller Build Dir); ctrlsystem Cfg = Twin CAT. Module Generator. Project Export Config. Load(ctrlsystem Build Dir); % create a new project export configuration combined Cfg = Twin CAT. Module Generator. Project Export Config('Full Path',fullfile(pwd,'Temp Ctrl Lib','Temp Ctrl Lib.vcxpr oj')); % add the loaded class export configurations to the new project configuration combined Cfg. Add Class Export Config(controller Cfg. Class Export Cfg{1}); combined Cfg. Add Class Export Config(ctrlsystem Cfg. Class Export Cfg{1}); % ... % additinal class export configurations can be added here, loaded from % - Simulink code generation directories (as described) % - MATLAB code generation directories (from MATLAB Coder with TE1401) in the same way TE1400 Version: 2.4.1 135

## Page 136

From version 2.x.xxxx.x % turn on generation and installation of the PLC library combined Cfg. Project. Generate Plc Library = true; % generate a PLC Lib true/false combined Cfg. Project. Install Plc Library = true; % install the PLC lib on local system true/false % instantiate and run the project exporter Twin CAT. Module Generator. Project Exporter(combined Cfg); 4.7.6 Sharing created Twin CAT objects Often the colleagues who create Twin CAT objects (Tc COM and/or PLC library) from Simulink® or MATLAB® are not the ones who implement the created modules into a Twin CAT configuration and create the machine code. In order to be able to work with the created Twin CAT objects in Twin CAT XAE, they must be available in the repository folder on the local engineering PC and the PLC library must be installed in the local PLC Library Repository. Manual copying to engineering PCs is error-prone. It is therefore strongly recommended to create a so-called TMX archive and share it with colleagues who want to use the created modules. What is a TMX archive? The TMX archive is an archive of all necessary files, which are required for the use of Tc COM and PLC libraries in a Twin CAT Engineering. The archive contains all compiled drivers, description files (e.g. for the block diagram in Twin CAT), the tmc file for Tc COM or the tml or library file for the PLC. A TMX archive only needs to be copied to any path on an engineering PC and executed. It is a self- extracting archive, which then automatically copies all files to the correct location. The files of the model Simple Temp Ctrl in version 0.0.0.2 from the Vendor TE140x Module Vendor must be located at this position, for example: How do I create a TMX archive? You can specify the path and name of the TMX archive under TC Build to have it created with the next build. 136 Version: 2.4.1 TE1400

## Page 137

From version 2.x.xxxx.x You can also use placeholders for the path and name as shown in the sample above. Result of this setting is e.g. a TMX archive 2021-11-04-172921-Simple Temp Ctrl0.0.0.3.exe (new build, therefore revision incremented). How do I use a TMX archive? You can then copy the TMX archive to any path on an engineering PC and execute it. This will copy the files in the archive to the correct location in your repository. (self-extracting zip). If you want to use not only the Tc COM modules in the archive on the engineering PC, but also the PLC library, this must still be installed via the PLC Library Repository. Alternatively, you can also use the Command Prompt. Call the help of the Tmx Package Installer via: <tmxarchive>.exe /? TE1400 Version: 2.4.1 137

## Page 138

From version 2.x.xxxx.x For example, to unpack a TMX archive and install the PLC library it contains in the local Twin CAT Engineering, execute the following command in the command line: <tmxarchive>.exe /plclib:install What software do I need on the Twin CAT Engineering PC? On the engineering PC on which you want to use the already compiled Twin CAT objects to implement them in a Twin CAT configuration, you only need a Twin CAT XAE installation. You do not need a full Visual Studio on this engineering PC (the XAE shell of the Twin CAT XAE setup is sufficient) nor do you need a MATLAB® installation. In some cases it is necessary to install the so-called Data Exchange modules on the engineering PC, so that you can use Twin CAT objects created on another system. These cases are: • The created module was created with the “External Mode” option. • The created module uses the Twin CAT File Writer [} 113] or MAT file logging. • The created module contains function blocks from TE1410 Twin CAT Interface for MATLAB®/Simulink®. In all other cases the created Twin CAT objects have no dependency to the Data Exchange modules. Installation of the Data Exchange modules Twin CAT 3.1 Build 4026 tcpkg install Twin CAT. XAE. TMX. Data Exchange Twin CAT 3.1. Build 4024 The Data Exchange-Modules Setup is copied to the following folder with the Twin CAT Tools for MATLAB® and Simulink® Setup, so that the employee who has installed the TE14xx-Tools For Matlab And Simulink Setup can distribute the Data Exchange modules setup to the colleagues concerned. <Twin CATInstall Dir>\Twin CAT\Functions\TE14xx- Tools For Matlab And Simulink\TE140x\SDK 4.7.7 Automatic updating of objects in a Twin CAT project ü During the engineering phase, changes are usually made several times in the Simulink® model, the model is built and then updated in the Twin CAT project. This process can be automated using the Deployment project parameter. 1. Enter the full path to the Twin CAT project (to the tsproj file) in the corresponding field. 138 Version: 2.4.1 TE1400

## Page 139

From version 2.x.xxxx.x 2. Then build your Simulink® model as usual. ð A new section appears in the log file, which provides information about the process of automatically updating the Twin CAT project. ð During the update process in the addressed Twin CAT project, all existing Tc COM instances of the newly built Simulink® model are automatically updated. Where possible, all existing mapping and task assignments are retained. 3. Set the Activate and restart deployment project parameter to compile the Twin CAT project after updating the objects and activate it on the set Twin CAT target. 4. If you are working with the PLC-FB and/or the Tc COM-Wrapper-FB, set the version to “Newest version always” under the properties of the corresponding PLC library to update it automatically. TE1400 Version: 2.4.1 139

## Page 140

From version 2.x.xxxx.x 4.7.8 Creation of versioned drivers Each object created from Simulink® contains version information. Accordingly, you can build several versions of a Simulink® model and instantiate the created modules version-selectively in Twin CAT. Define revision control in Simulink® Switch to Advanced mode to make the following parameters visible. Twin CAT. Module Generator. Settings. Change('Configuration Level', 'Advanced') Before creating a PLC function block or a Tc COM object, you can define the version of the Tc COM and the created PLC library under TC General with the entries “Version source file” and “Version part for increment”. 140 Version: 2.4.1 TE1400

## Page 141

From version 2.x.xxxx.x Automatic version increments The basic version on which a version update is to be created is specified via “Version source file”. In the standard case $<Latest TMFile> is specified there. This searches for the last available version of the model on the local engineering PC and then uses this as the basis for the version increment. The version number consists of four digits, e.g. 1.0.3.2 or 2.12.123.14. Each digit can be incremented separately according to the scheme: <Major>.<Minor>.<Build>.<Revision> For example, if the last version of a model named “My Model XY” on the engineering PC is found to be 1.2.12.4 and the increment is set to “Revision”, a version 1.2.12.5 is created. If “None” is selected, no version update takes place and the last version on the engineering PC is overwritten. Default of a fixed version number If a version is to be specified in Simulink®, this can be done via Drv File Version. Simply enter the target version in the input field. TE1400 Version: 2.4.1 141

## Page 142

From version 2.x.xxxx.x In the Engineering Repository, a folder is created under the model name for each version created. Each version folder then contains the corresponding drivers and Twin CAT files. See also Twin CAT objects [} 118]. Presetting of a version number via an external file You can also use an external file to specify a version. For example, this is a common method when using build agents at Continuous Integration. For configuration in Simulink® set TC General Version part for increment to “None” and specify the full path to your version file at Version source file. 142 Version: 2.4.1 TE1400

## Page 143

From version 2.x.xxxx.x Structure of external file: <?xml version="1.0" encoding="UTF-8"?> <configuration> <app Settings> <add key="major" value="1" /> <add key="minor" value="3" /> <add key="build" value="1301" /> <add key="revision" value="267" /> </app Settings> </configuration> Use versioned models in Twin CAT XAE All models available in the Engineering Repository can also be instantiated in any available version. To do this, navigate through the tree as usual to find the Tc COM of your choice. In the last hierarchical level, you can now also select the version of the Tc COM. As an example, two versions (0.0.0.4 and 0.0.0.5) of Simple Temp Ctrl are available here: TE1400 Version: 2.4.1 143

## Page 144

From version 2.x.xxxx.x 4.7.9 Online Change of Tc COM Online Change of a Tc COM during Twin CAT Run ü To switch between different versions of a Tc COM during operation, the corresponding interface must be implemented. 1. To do this, activate the Online change support checkbox in the TC Tc Com General menu in Simulink®. Online Change for PLC function block If you use the function block (PLC-FB) in a versioned PLC library, you do not have to check the checkbox Online change support. The Online Change process then runs via the PLC-specific mechanism. 144 Version: 2.4.1 TE1400

## Page 145

From version 2.x.xxxx.x In addition, created Tc COM data areas must be compatible with each other. If Online change support is activated, the last hierarchical level is more strictly differentiated in the Insert Tc Com Object dialog. Only Online Change compatible Tc COM are combined. The following shows that versions 0.0.0.1 and 0.0.0.3 or 0.0.0.4 and 0.0.0.5 are compatible for Online Change. However, not 0.0.0.3 to 0.0.0.4 or 0.0.0.2. TE1400 Version: 2.4.1 145

## Page 146

From version 2.x.xxxx.x In order to better ensure the compatibility of the Data Areas, it is possible, for example, to keep the parameters, Block I/O, Cont State and DWork of a model not in an internal Data Area, but as module parameters. This means that only the inputs and outputs as Data Area are relevant for the compatibility of the Tc COM versions. 2. To perform the Online Change in Twin CAT XAE, use the tree item Tc COM Modules and navigate to the Online Changeable Objects tab. 3. Select a version of your choice from the drop-down menu at Online Version (only compatible versions are displayed). 4. Right-click on the line of the object and select Apply changed online object versions to activate the new version of the Tc COM. ð Details can be found in the Twin CAT C++ documentation. 4.7.10 Configuration of data access to data of a Tc COM object In the TC Tc Com Interface area, you configure the way in which data of certain variable groups can be accessed. ADS access and the process image type can be configured as required. These settings affect how the variables in a group are linked with other process images in the Twin CAT development environment, and how they can exchange data. Variable groups Depending on the Simulink® model, there are several groups of internal variables in addition to the input and output variables. The following groups can be configured: Group Description Naming of the Naming of the Data Area Data Area (default) (“classic” option) Input Model inputs <Model Name>_U Input Output Model outputs <Model Name>_Y Output 146 Version: 2.4.1 TE1400

## Page 147

From version 2.x.xxxx.x Group Description Naming of the Naming of the Data Area Data Area (default) (“classic” option) Block IO Global output signals of Simulink® <Model Name>_B Block IO blocks: internal signals for which a “test point” has been defined. Parameter Model-specific parameters: <Model Name>_P Model parameters Parameters of Simulink® blocks that are tunable. Cont State Continuous state variables <Model Name>_X Cont States DWork Time-discrete state variables <Model Name>_DW DWork Data Store Data Store Memory <Model Name>_DW_<Da <Model Name>_DW_<Dat ta Store Name> a Store Name> Under TC Tc Com Interface, the option Mapping between variable names and ADS symbols can be used to influence the naming of the Data Areas. By default, they are given the same name as the associated C++ variable. This is specified by Simulink® Coder™. With the “Classic” setting, the names are abbreviated to that of the variable group, as known from earlier TE1400 versions 1.2.x. The inputs are then combined, for example, in the Data Area “Input” and not in “<Model Name>_U”. Tc COM with multiple task contexts If a Tc COM is created that has more than one task context (see Multitask, Concurrent Execution and Open MP [} 162]), the Data Areas are automatically separated. There are several inputs or Dwork Data Areas, for example. Configuration interface in Simulink® Switch to Advanced mode to make the following parameters visible. Twin CAT. Module Generator. Settings. Change('Configuration Level', 'Advanced') TE1400 Version: 2.4.1 147

## Page 148

From version 2.x.xxxx.x The Data Access can be defined individually for each variable group named above. Selection options for Data Areas and module parameters are summarized in the following table: Data Access Access via Access via mapping Access via Data ADS Pointer None No No No Module parameters Yes No No Input Destination Data Area Yes Yes (with Output Source) Yes Output Source Data Area Yes Yes (with Input Destination) Yes Internal Data Area Yes No No 148 Version: 2.4.1 TE1400

## Page 149

From version 2.x.xxxx.x Data Access Access via Access via mapping Access via Data ADS Pointer Standard Data Area Yes No Yes Retain Source Data Area Yes Yes (with Retain Handler) No Unlike Data Areas, Module parameters are not intended for cyclic (process) data exchange with other modules or I/Os. They are generally read or written asynchronously, e.g. via ADS. The parameters on the Parameters (Init) tab have an initial value that can be configured in the project and is written when the Tc COM instance is started. The parameters on Parameter (Online) on the other hand, have no configurable initial value and are typically used to monitor internal states. Data Areas can be found on the Tc COM instance on the Data Area tab. The exact type of the Data Area is also displayed here. Internal Data Areas are not created as process data image in the development environment. Properties of the parameterization The access via ADS is usually Read Only. Only the Inputs and Parameters groups can also be written via ADS. Independently of this, it is possible to set for each group whether ADS symbol information (Create ADS Symbols) should be created for the respective group. If no ADS symbol information is available, the data can only be accessed by ADS via Index Group and Index Offset. Via the option “Input: Initial values” you get an entry under “Parameter (Init)” in addition to the Data Area (for the cyclic data exchange). This way initial values for inputs can be realized. These values apply if the corresponding inputs have not been linked. Without these parameters, unlinked input values are always 0. Via the option “Parameter: Initial values”, the parameters of the Simulink® model are also created as module parameters (structure <Model Name>_P) in addition to the Data Area setting. TE1400 Version: 2.4.1 149

## Page 150

From version 2.x.xxxx.x Special case: Data Area for model parameters If the code interface is set to Reusable function [} 195] (default), then no Data Area is created for model parameters, since the parameters are kept global for this case and thus shared between multiple instances. If “Parameter: Initial values” is selected, the parameter “<Model Parameter Name>_Sharing” is created in addition to the entry for the model parameters at Parameter (Init). This parameter can only be set to “Define” for an instance of this Tc COM module class. All further instances must use “Inherit”. Since all instances share the parameters in this case, they all work with the parameter set in the “Definer”. The model parameter settings of the other instances are ignored. See also Parameterization of several module instances [} 195]. Monitor Execution Time: Creates a module parameter at Parameter (Online) and in the block diagram (right side). The execution time of the Tc COM can be read via this parameter. The measurement is updated with each call of the Tc COM, so that, for example, the execution time can be tracked precisely for each call via the Twin CAT Scope. Create Execution Info output: Creates an additional Output Source Data Area with information about the module call, see Exception handling [} 224]. Data Stores: Variables from a Data Store Memory Block are stored in DWork by default. You can create an additional addressing of these variables when you create a Data Area for Data Stores. No Data Area is created by default. For an example, see Shared memory between Tc COM instances [} 153]. Further Descriptions: • Structure of a Tc COM: Description of the Tc COM properties • Properties of Data Areas • Using a Retain Data Area with the NOV-RAM: Retain Data Area • You can use Data Pointer e.g. via the TC Module Input and TC Module Output blocks, see Shared memory between Tc COM instances [} 153]. 4.7.10.1 Best practice: access to Tc COM data Introduction The section Configuration of data access to data of a Tc COM object [} 146] described how to set data access to a Tc COM in TC Tc Com Interfaces in the configuration parameters of a Simulink® model. In the following, advantages and disadvantages and also application scenarios as well as useful hints are given as to when which type of data access to a Tc COM may be useful. Access via ADS Properties • On-demand data exchange • Asynchronous communication • Threadsafe • Time of reading or writing not determined Use Cases • Read or write access from outside the Twin CAT runtime, e.g. from an HMI. Read and write model parameters or read internal signals. • Access from inside the Twin CAT runtime to the Tc COM, if the writing software module (other Tc COM or PLC) is not called in the same task context. Thus, the data exchange is thread-safe. It can be used when a software module supplies parameter sets to different software modules in various contexts. Please note 150 Version: 2.4.1 TE1400

## Page 151

From version 2.x.xxxx.x • If several parameters are to be changed or read simultaneously, an ADS sum command should be used. Otherwise it cannot be guaranteed that separate ADS read or write commands are all processed consistently in one task cycle. • These properties also apply if the data access via the network is to be made via OPC UA and not via ADS. Access via mapping Properties • Cyclic data exchange • Threadsafe • Time of data exchange determined Use Cases • Cyclic data exchange between different software modules, especially for data that changes every task cycle. Please note • Even values that have not been changed are copied in each task cycle. Therefore, it is advisable to keep the input and output mapping Data Areas small and limit them to the essentials. Large Simulink® bus structures as input where only a few elements change cyclically should be avoided here. • The time of the data exchange is determined and can be specified in Simulink® under Configuration Parameters -> TC Tc Com Additional settings -> Default execution sequence. • Defining model parameters as Input Destination Data Area only makes sense if the parameters change cyclically (in which case it should first be checked whether the parameter cannot be better mapped as a model input) or the number of parameters is so small that the overhead of cyclic copying does not interfere. Access via Data Pointer Properties • On-demand data exchange • Not threadsafe • Time of reading or writing determined (shared memory area) • Local copy of the data in each instance • Flexible linking of Data Area and Data Pointer in XAE Use Cases • Shared memory area of several Tc COM, for example for variables in the Data Store. Tc COM instances can share a common memory area with each other via Data Pointer data. Data Pointer example An example can be found here: Shared memory between Tc COM instances [} 153]. Exported Global/Imported external Properties • On-demand data exchange • Not threadsafe • Time of reading or writing determined (shared memory area) • No local copies of the data in each instance • Only modules, bundled in the same driver [} 134], can access the global variable. Use Cases TE1400 Version: 2.4.1 151

## Page 152

From version 2.x.xxxx.x • Shared memory area for several Tc COM. Also suitable for large variables. Example for Exported Global/Imported external An example can be found here: Shared memory between Tc COM instances [} 153]. Special case: Interaction via the Tc COM Wrapper FB The Tc COM Wrapper FB (see Applying the Tc COM Wrapper FB [} 213]) simplifies the interaction between PLC and Tc COM. This FB primarily enables, with little programming effort, the cyclic execution of the linked Tc COM object from the PLC code, including the exchange of input and output data. However, it also allows simple acyclic access to the object's parameters and, if required, flexible access to the Data Areas as well. The wrapper provides the ITc ADI interface (see ADI Interface [} 217]) on the one hand and (optionally) properties on the function block (see FB properties [} 216]) on the other. The Tc COM Wrapper FB should be called in the same context as the Tc COM. Function block properties • Access to module parameters only • No access to Data Areas. Note: By default, model parameters are created both as Data Area and as module parameters. • Simple access to module parameters by name • Not threadsafe ITc ADI interface • Efficient and flexible access to all Data Areas (also subareas of a Data Area) • Access only via Data Area number and Byte Offset • No type information (type cast is to be realized by the user) • The pointer must be fetched and released every task cycle • No access to module parameters • Not threadsafe Changes persist Above, it was described how data can be changed in a Tc COM instance at Twin CAT runtime. If Twin CAT is restarted, these changes will be lost unless further recovery measures have been taken. The default behavior of a Tc COM is that when a Tc COM instance is started, the parameterization is performed according to its Startup Values. In addition, remanent variables can be defined that retain their value beyond the usual program runtime. Remanent variables can be declared as RETAIN variables or even more strictly as PERSISTENT variables. More information about remanent data (Persistent and Retain) in the Twin CAT PLC: Link In the following three ways are described in which values can be restored after restarting Twin CAT. 1) Startup values See Parameterization of a module instance [} 190] for differentiation between Online, Prepared, Default and Startup Values. Twin CAT 3 XAE necessary Startup values are changed in the Twin CAT configuration, i.e. in the engineering. Changes can be entered here. However, the change must be compiled and downloaded to the runtime system. If online values are changed during runtime, you can read the current online values via ADS, for example. This can be done, for example, with the TE1410 Twin CAT Interface for MATLAB®/Simulink®. The read values can then be entered as new startup values in the Twin CAT configuration. Use the Automation Interface sample for this purpose: 152 Version: 2.4.1 TE1400

## Page 153

From version 2.x.xxxx.x Twin CAT. Module Generator. Samples. Show('Use the Twin CAT Automation Interface in MATLAB') In the sample, a live script is used to show different functions. The section Read and write parameter online values via ADS describes how to read and write online values from a Tc COM. The section Read and change parameter startup value describes how to read and also write startup values. The new startup values are entered in the Twin CAT configuration on the engineering system. To make the changes available on the runtime system, you must activate the configuration on the system. You can also realize this with the Automation Interface (sys Manager. Activate Configuration). You can either restart the system directly via Automation Interface (sys Manager. Start Restart Twin CAT), or you can let the system run without restarting. At the next start of Twin CAT, the startup values are set and the Tc COM starts up with the new startup values. 2) Retain Data At TC Tc Com Interfaces [} 146] you can create the model parameters (and also other groups) as Data Area of type Retain Source Data Area. You can then create a retain handler in the Twin CAT configuration and connect it to the Data Area. For details see NOV-RAM and Retain Handler. NOV RAM necessary To work with the Retain Handler, you need an IPC/CX with built-in NOV-RAM. The use of an Ether CAT Terminal with NOV-RAM (e.g. EL6080) is not supported. 3) Persistent Data You can access persistent data in the Twin CAT 3 PLC without Twin CAT XAE and without NOV-RAM. Twin CAT 3 PLC runtime required To use persistent data, you must declare variables as persistent in the PLC. Persistent data can only be created in the PLC. Therefore, use the PLC to define the data you want to persist. Work with the Tc COM Wrapper FB [} 213], for example, to read data from the Tc COM and persist them via the persistent PLC variable. Create a state machine for starting the Tc COM object after a Twin CAT restart in order to write the persisted data back into the Tc COM object before it is called again in the code. 4.7.11 Shared memory between Tc COM instances In some applications it may be advantageous for Tc COM instances to share a memory area, so that certain structures/variables are defined once in an object and all other objects reference this memory location. To achieve this, you can follow two different paths in Twin CAT: • Linking Tc COM instances in Twin CAT with data pointers [} 153] • Use of global variables (Exported Global/Imported External) [} 157] In the remainder of this chapter, both paths will be described. While with data pointers you are more flexible in linking the data, when using global variables you have the advantage that the structure/variable exists only once in memory. For data pointers, a local copy of the data is held in each Tc COM instance. NOTICE Data transmission not threadsafe Use data pointers and global variables with caution. The data exchange is not threadsafe. Therefore, we strongly recommend to run all involved Tc COM instances in the same task context. Linking Tc COM instances in Twin CAT with data pointers The following describes how you can specifically use a shared memory area between Tc COM instances via data pointer. TE1400 Version: 2.4.1 153

## Page 154

From version 2.x.xxxx.x As described in section Configuration of data access to data of a Tc COM object [} 146], you can make Data Areas accessible via Data Pointer. Input Destination Data Area, Output Source Data Area and Standard Data Area are accessible via Data Pointer. In principle, you can create any variable group, model parameter, DWork, Block IO, etc. as a standard Data Area and thus make it accessible as Data Pointer. Objective In the following, we will show you how to make a specific subrange of variables accessible via Data Pointer and not the entire variable group range at once. The basic concept is based on the use of data store memory blocks in Simulink®. Model with Data Store A Data Store Memory block is created in a model "Data Store Object". In this sample with only one variable of type double. This variable is read with a Data Store Read, multiplied by an input and set to an output. At TC Tc Com Interface, the option Data Store: Data Access is changed from None to Standard Data Area and the Simulink® model is compiled into a Tc COM. If the object is instantiated in Twin CAT, the following representation is obtained: 154 Version: 2.4.1 TE1400

## Page 155

From version 2.x.xxxx.x The Data Store Data Area is now displayed in the process image and contains a variable of type LREAL, which can be accessed via Data Pointer. Model with Data Pointer In a second Simulink® model, a double value is generated by a clock and this is set to the TC Module Output [} 106]. TE1400 Version: 2.4.1 155

## Page 156

From version 2.x.xxxx.x In the configuration of the TC Module Output, the connection type is set to Data Pointer and the data type is set to double. If this model is compiled into a Tc COM object, the following representation is obtained in Twin CAT: The name of the TC Module Output "Ptr To My Data Store" of type LREAL is now displayed under Data Pointer. This can now be linked by double-clicking on the Data Store Object_DW_My Data Store. Both Tc COM instances should be called in the same task because the communication is not threadsafe. If different tasks are used, the user must ensure that data is consistent and is read or written at appropriate times. 156 Version: 2.4.1 TE1400

## Page 157

From version 2.x.xxxx.x The behavior of the sample here is shown in the graphic below. If the input In1 of the Data Store model is manually set to 1 and the output Out1 is observed via the Twin CAT Scope, an increasing straight line is seen. This means that the increasing value from the clock is written to the Data Store of the Data Store Object-Tc COM via pointer. Read access via TC Module Input Read access to a Data Area can be realized via Data Pointer using the TC Module Input. Local data copy in each module The Simulink Coder™ generates the C/C++ code in such a way that local variables are created for the TC Module Input and TC Module Output and thus each module instance contains a local copy of the data. Accordingly, the memory requirements of the project increase with each instance. Use of global variables (Exported Global/Imported External) The following describes how to create a global variable in Tc COM using the Storage Classes in Simulink® and reference it in other Tc COM. Objective A Simulink® parameter Global Params is created, which contains a structure of 3 elements. The goal is to define this structure via a Tc COM object and to instantiate further Tc COM objects that access this structure via shared memory area, so that changes in the defining Tc COM arrive directly in all connected Tc COM instances. Modeling in Simulink® Two Simulink® models are created: 1. "Data Definer" model 2. "Data User" model Furthermore, a Simulink® bus is defined and created as a Simulink® parameter named Global Param. The Data Definer model determines the content of Global Param at the end, while the Data User models only read the content. TE1400 Version: 2.4.1 157

## Page 158

From version 2.x.xxxx.x Note that the Storage Class definition of Global Param is set differently for the Data Definer and Data User below. For the Data Definer, the Storage Class is set to Exported Global, while for the Data Definer, the Storage Class is set to Imported Extern. The following script bundles the two described Simulink® models into one driver, cf. Bundling of several models in one Twin CAT driver [} 134]. this Dir = fileparts(mfilename("fullpath")); % model names mdl Names = ["Data Definer","Data User"]; code Directories = fullfile(this Dir,strcat(mdl Names,'_tcgrt')); is Param Definer = [true,false]; % instantiate project configuration proj Cfg = Twin CAT. Module Generator. Project Export Config('Full Path',fullfile(this Dir,'Tc Cpp Proj','Data S haring Modules.vcxproj')); regenerate = false; for i=1:length(mdl Names) % generate code for the models (only if the code directory doesn't exist) - > remove the directory to rebuild specific models if regenerate || ~isfolder(code Directories(i)) % load the model and apply basic settings mdl = load_system(mdl Names(i)); set_param(mdl,'System Target File','Twin Cat Grt.tlc'); set_param(mdl,'Code Interface Packaging','C++ class'); set_param(mdl,'Tc Com_Tc Com Wrapper Fb','off'); set_param(mdl,'Tc Project_Generate','off'); set_param(mdl,'Solver Type','Fixed-step'); % adapt the storage class of the shared parameter structure if is Param Definer(i) Global Param. Coder Info. Storage Class = "Exported Global"; else Global Param. Coder Info. Storage Class = "Imported Extern"; end % generate code and close the model slbuild(mdl); close_system(mdl,0); end 158 Version: 2.4.1 TE1400

## Page 159

From version 2.x.xxxx.x % add the class export configuration to the "global" project export configuration mdl Proj Cfg = Twin CAT. Module Generator. Project Export Config. Load(code Directories(i)); cls Cfg = mdl Proj Cfg. Class Export Cfg{1}; proj Cfg. Add Class Export Config(cls Cfg) end % generate and build the project Twin CAT. Module Generator. Project Exporter(proj Cfg); Configuration in Twin CAT XAE ü Create one instance of the Data Definer in the Twin CAT XAE (more are not allowed!). On the other hand, you can create as many Data User instances as you like. 1. Set Parameter (Init) > Parameter Global Param_sharing for the Data Definer to "Define". 2. Set Parameter (Init) > Parameter Global Param_sharing for all Data Users to "Inherit". 3. Create a task. 4. Assign this task to all created instances. 5. Activate the project. ð Change the values of Global Param in the Data Definer, e.g. via the Block Diagram, and observe the direct effect on the Data User instances. 4.7.12 Creating a module with OEM license query Why couple an own license to a module? If a Twin CAT object, in addition to the Twin CAT licenses, is also bound to an OEM license, a binding of this Twin CAT object to a hardware can thereby be realized, so that the application is protected against cloning. In addition, functionalities of an application can be licensed to end customers via this route. For more information, see Software Protection / Own OEM Licenses. Configuration in Simulink® • Switch to the Advanced configuration level: Twin CAT. Module Generator. Settings. Change('Configuration Level', 'Advanced') • Enter your OEM ID and the OEM license(s) you are requesting: TE1400 Version: 2.4.1 159

## Page 160

From version 2.x.xxxx.x If the module is created with the above settings and instantiated in Twin CAT, a valid OEM license must be present in addition to a valid Twin CAT license (TC1220, TC1320) so that Twin CAT can be activated. To note for license dongles The following should be noted when using the OEM license for the target system on a dongle: ü Do you use an instance of a Tc COM? 1. Set the Init Sequence on the object instance to P. 2. Note that you cannot use active mappings in this case. It is advised to use the Tc COM wrapper FB or to call the module from Twin CAT C++. 3. Activate the configuration. 160 Version: 2.4.1 TE1400

## Page 161

From version 2.x.xxxx.x 4. After Twin CAT is in run mode, switch the Tc COM object to OP state, e.g. via the XAE (see graphic below), via the Tc COM wrapper FB or via ADS. ð The license will be checked and accepted (if valid) when booting into the OP-State. ü Do you use the Tc COM wrapper FB from the created PLC library and reference a static Tc COM instance? 1. Set the Init Sequence on the object instance to P (see above). 2. Use the Tc COM wrapper FB to switch the referenced Tc COM to OP. ð The license will be checked and accepted (if valid) when booting into the OP-State. ü When do you not need to pay attention to anything else? 1. If you use the PLC-FB from the created PLC library. 2. If you create a Tc COM dynamically with the Tc COM wrapper FB. 4.7.13 Integration of own C/C++ code The Twin CAT Target for Simulink® also supports the integration of own C/C++ code in Simulink®. Math Works® offers several possibilities for this, for example the way via the S Function Builder. Note that you set the language to "Inherit from model". You can also include libraries as long as they are platform independent and available as source code. For example, the inclusion of a precompiled DLL is not possible. TE1400 Version: 2.4.1 161

## Page 162

From version 2.x.xxxx.x 4.7.14 Configuration of the TMX file properties You can parameterize the entries in the TMX file (Twin CAT Module Executable) from Simulink®. To do this, switch to Advanced mode: Twin CAT. Module Generator. Settings. Change('Configuration Level', 'Advanced') Relationship of TMX properties (left) to parameters in Simulink® (right) File description -> Description File Version -> Drv File Version Product name -> Product Name Product version -> Drv Product Version Copyright -> Copyright Note: $< > describes placeholders [} 176]. For example, Drv Product Version is set to the value in Drv File Version which in turn gets the value from Version Source File. 4.7.15 Multitask, Concurrent Execution and Open MP In Simulink®, you can configure your models to run on multi-core target systems. Further details can be found in the Math Works® documentation. Beckhoff targets usually offer a multi-core architecture, which can be used efficiently with Twin CAT 3. This is also possible with the Twin CAT Target for Simulink® as shown below. This description makes a distinction between Multitask, Concurrent Execution and Open MP. • Multitask [} 164] creates a Tc COM object with several available tasks. All tasks must run on the same core. There is no parallelization. • Concurrent Execution [} 166] also creates a Tc COM object with multiple tasks. These tasks can be distributed across different cores. Calculations can be executed in parallel. • Open MP [} 167] creates a Tc COM object with a task context. In addition, multiple Job Tasks distributed across different cores can execute the code fragments generated as Open MP code in parallel. Multitask and Concurrent Execution The following multirate system in Simulink® is considered for the descriptions of the options Multitask and Concurrent Execution. The model has an explicit and an implicit rate transition. 162 Version: 2.4.1 TE1400

## Page 163

From version 2.x.xxxx.x Select Solver under Configuration Parameters. You can choose from the following options: • Treat each discrete rate as a separate task • Allow tasks to execute concurrently on target TE1400 Version: 2.4.1 163

## Page 164

From version 2.x.xxxx.x Treat each discrete rate as a separate task: Multitask If a Tc COM object is created with the Treat each discrete rate as separate task option enabled, you can assign multiple task contexts to the object. There are three tasks in this case. Inputs, outputs, and all further Data Areas are divided into these contexts. In this case, there are three input Data Areas and three output Data Areas. 164 Version: 2.4.1 TE1400

## Page 165

From version 2.x.xxxx.x In this case, the cyclic tasks must all be allocated to the same core. The tasks are not processed in parallel. The advantage over a Tc COM with only one task interface is that not all calculations now have to be completed within the fastest task cycle time (see Scheduling). If the above Simulink® model were created using the default settings and the Treat each discrete rate as separate task option were not selected, only one task with 10 ms (the fastest task) would be linkable. This means that all calculations must be completed within this time frame. When distributing to multiple tasks on the same core, this rule is disabled because tasks can interrupt each other (see Priorities). Properties: • No function block is supported in the PLC. • The Twin CAT Usermode Runtime is not supported. • All tasks are assigned to the same core. • The fastest task must be assigned the highest priority (lowest priority value). The second fastest task must be assigned the second highest priority and so on. Scheduling Details: The graphic below describes an example of how the computing times can be distributed. The hatched areas indicate that a task may be paused during this time due to a higher priority task. The solid blue area indicates that the task is executed. Please note that the areas were added to the real-time monitor image for clarity purposes only and are not actual images. • Task 2, Task 3, and Task 4 are executed sequentially on the same core in Tick 1. Task 2 and Task 3 are executed without interruption. The execution of Task 4 is interrupted by the higher priority Task 2 in the transition to Tick 2. • Task 2 is executed first in Tick 2. The execution of Task 4 is resumed after Task 2 is completed. • Task 2 starts again and Task 3 follows in Tick 3. TE1400 Version: 2.4.1 165

## Page 166

From version 2.x.xxxx.x If cycle timeouts occur and scheduling cannot be adhered to, the execution of the respective task context is skipped until all relevant contexts are in the appropriate state. In the Tc COM object this behavior can be observed via the online parameter Skipped Execution Count. Allow tasks to execute concurrently on target: Concurrent Execution If a Tc COM object is created with the Allow tasks to execute concurrently on target option enabled, you will get an object to which you can assign multiple task contexts. In this case, as in the example above, 3 tasks. Again, the Data Areas are separated into the different contexts. The difference to the multitask object is that you can now distribute the tasks to different cores so that the processing is actually parallelized. Properties: • No function block is supported in the PLC. • The Twin CAT Usermode Runtime is supported. • Tasks can be assigned to different cores. • The fastest task must be assigned the highest priority (smallest priority value). The second fastest task the second highest priority and so on. Scheduling Details: The graphic below describes an example of how the computing times can be distributed. The full blue area indicates that the task is working. Note that the surfaces have only been subsequently overlaid on the real- time monitor image to aid comprehension and are not real images. 166 Version: 2.4.1 TE1400

## Page 167

From version 2.x.xxxx.x • Task 2, Task 3 and Task 4 are executed in parallel on different cores in Tick 1. The execution of Task 1 must be completed by the start of Tick 2. • Task 2 is executed again in tick 2. Task 3 and Task 4 may continue to work. The execution of Task 2 and Task 3 must be completed by the start of Tick 3. • Task 2 and task 3 are executed again in tick 3. Task 4 may continue to work. The execution of Task 2 and Task 4 must be completed by the start of Tick 4. If cycle time overruns occur and scheduling cannot be adhered to, the execution of the respective task context is skipped until all relevant contexts are in the appropriate state. In the Tc COM object this behavior can be observed via the online parameter Skipped Execution Count. Open MP Simulink Coder™ or MATLAB Coder™ can generate open MP code. Please refer to the Math Works® documentation for the exact cases in which this happens. The following is a sample using a MATLAB® Function in Simulink®. A MATLAB® sample can be found in conjunction with the TE1401 Twin CAT Target for MATLAB® in the samples: Twin CAT. Module Generator. Samples. Start('Code parallelization with Open MP'). TE1400 Version: 2.4.1 167

## Page 168

From version 2.x.xxxx.x The parfor command is used to parallelize the FOR loop in the MATLAB® function. In this case, the number of parallel workers is limited to 4. function y = My Function(u) %#codegen A = ones(20,50); t = 42; parfor (i = 1:10,4) A(i,1) = A(i,1) + t; end y = A(1,4) + u; No special settings regarding open MP have to be made for the Twin CAT target. You generate your Twin CAT objects as usual. Simulink® Coder™ compiles this code into open MP code, so that the C/C++ code is parallelized accordingly. Embedded Coder® is not required for this feature. In the Twin CAT XAE you can now instantiate the created Tc COM or the PLC-FB and configure it accordingly. As usual, the object instance offers only a cyclic task interface under the Context tab. A Task 2 with 200 ms cycle time is created and assigned to the object in this sample. There is a parameter Job Pool ID under Parameter (Init). Here, as far as known from the C/C++ code, it is also shown how many workers can work in parallel. A Job Pool is an organization unit for Job Tasks, which can be created in the Tasks node. 168 Version: 2.4.1 TE1400

## Page 169

From version 2.x.xxxx.x Accordingly, an object of type Tc Job Pool must be added under Tc COM Objects with “Add new item”. Under Parameter (Init) on the Tc Job Pool object, the Job Pool Id is to be entered and a group of Job Tasks is to be referenced. First define how many Job Tasks the pool should combine and then select the Job Tasks with the drop-down menu. Under System > Realtime you can distribute Job Tasks to different cores. Execution in the configuration shown above then takes place as follows. Task 2 is executed on core 4 and cyclically drives the openmp object. The code fragments generated as open MP code can then outsource tasks to the configured Job Tasks via the Job Pool. When the Job Tasks have finished their calculations, all partial results are bundled again and Task 2 on core 4 executes the code to the end. 4.7.16 Instruction Set Extensions Instruction set extensions can be used to achieve better runtime performance. While the auto-vectorizer of the Microsoft C++ compiler already optimizes the code and automatically generates SSE2 code by default, the explicit use of instruction set extensions by Intrinsics can lead to better code performance. When using the TE1400 Twin CAT Target for Simulink®, you can explicitly request the use of SSE2 code. To do this, use the following properties of Simulink® Coder™ under Code Generation > Optimization. TE1400 Version: 2.4.1 169

## Page 170

From version 2.x.xxxx.x Sample available in MATLAB® Twin CAT. Module Generator. Samples. Start("Simulink Instruction Set Extensions") Further information on code performance You can make further optimizations using the Embedded Coder® from Math Works®. To use Embedded Coder TM with Twin CAT, use the Twin CAT Target for Embedded Coder®. You can also use AVX commands with this, for example. Also make full use of the Solver settings. In general, a “discrete” solver will perform significantly better than a higher-order solver. 4.7.17 Symbol Properties and Attribute Pragmas What are properties and attributes? For Tc COM objects, you can assign properties to all definitions, e.g. Data Areas, Data Types, Sub Items, etc. A property is defined as a name-value pair. Any additional information can be included. Attributes are usually used in the PLC in the declaration part and can also bind any additional information to a variable, for example. Please refer to the PLC documentation for a list of PLC attributes. Many Twin CAT functions use attributes and properties. Examples are: • Twin CAT OPC-UA ◦ {attribute 'OPC. UA. DA' := '1'} ◦ {attribute 'OPC. UA. DA. Access' := '1'} • Analytics Logger 170 Version: 2.4.1 TE1400

## Page 171

From version 2.x.xxxx.x ◦ {attribute 'Tc Analytics'} • JSON Library Tc3_Json Xml • … Attributes and properties can also be defined by the user and used for own applications. How do I use symbol properties and attributes together with the Twin CAT target? It is possible to assign properties to ADS symbols with the Twin CAT target. ADS symbols are to be understood in the sense of variables. (Tc COM) TMC Properties In Simulink® you can freely assign Properties as a string in the Configuration Parameters under TC Tc Com Interface. Properties can be defined for the Data Area: • Input: TMC Properties • Output: TMC Properties • Parameters: TMC Properties • Block IO: TMC Properties • Cont State: TMC Properties • DWork: TMC Properties • Data Store: TMC Properties In addition, you can use the Additional TMC Symbol Properties field to assign properties independently of the Data Area. TE1400 Version: 2.4.1 171

## Page 172

From version 2.x.xxxx.x The following notation is used for Data Area specific TMC properties: Symbol Name1:Property Name1=Value1 Sample: Feedback Temp:OPC. UA. DA=1 If several properties are to be assigned, they must be separated with |: Symbol Name1:Property Name1=Value1|Symbol Name2:Property Name2=Value2 Sample: Heater On:OPC. UA. DA=1|Heater On:OPC. UA. DA. Access=3 wildcards can be used from MATLAB R2020b: *:Property Name1=Value1 172 Version: 2.4.1 TE1400

## Page 173

From version 2.x.xxxx.x The * character is used as a wildcard and in this sample assigns the Property Name1 with Value1 to all symbols in the Data Area. Substrings can also be combined with wildcards. The following sample assigns the specified property to all symbols that begin with Sum. Sum*:OPC. UA. DA=1 The same structure must be used in the Additional TMC Symbol Properties field. However, the Data Area must be added for addressing. Data Area Name1. Symbol Name1:Property Name1=Value1 Sample: Temp Ctrl_B.current:OPC. UA. DA=1 PLC Attributes The same procedure as for Tc COM applies to the PLC-FB [} 217], but there only possible for the inputs and outputs. When using the Tc COM-Wrapper-FB [} 213] a Tc COM is referenced, so that you make the configuration according to TMC Properties. The configuration for the PLC-FB is done under TC Plc Fb Interface. Sample code in MATLAB® Open the appropriate sample with: Twin CAT. Module Generator. Samples. Start(Add Properties to ADS Symbols') TE1400 Version: 2.4.1 173

## Page 174

From version 2.x.xxxx.x What are properties and attributes used for? An example is the use of attributes in the PLC or Symbol Properties for Tc COM in connection with Twin CAT 3 OPC-UA. See the OPC-UA list of attributes. The following example shows how all input variables of the Input Data Area and only the signal e from the Block IO Data Area are provided with the OPC-UA data access property. The wildcard * is used for the input Data Area. 174 Version: 2.4.1 TE1400

## Page 175

From version 2.x.xxxx.x You have to select Twin CAT 3 C++ (TMI) - Filtered on the right side under Type in the OPC-UA configurator, so that only the symbols with the corresponding property are displayed in the server. If you want to see all symbols in the server, simply select Twin CAT 3 C++ (TMI) - All at this point. Then all symbols will be displayed, regardless of the properties. Also select the TMI file of the Tc COM on the Twin CAT Target Device as Symbol File (Boot\TMI Folder). Connect to the OPC-UA Server with a client to inspect the namespace. Here the OPC-UA Sample Client of Twin CAT 3 was used. You can see that only those symbols are displayed in the server that have been explicitly assigned the OPC. UA. DA=1 property. TE1400 Version: 2.4.1 175

## Page 176

From version 2.x.xxxx.x 4.7.18 Available placeholders Placeholders are used in the Target for Simulink® configuration to reduce configuration effort and increase clarity. Placeholders are specified in the configuration with $<Placeholder Name>. 176 Version: 2.4.1 TE1400

## Page 177

From version 2.x.xxxx.x What are placeholders? Placeholders can be used to specify the value of a configuration parameter abstractly as a variable. Specific placeholders exist at the level of the target (module generator), the project and the modules (Tc COM and PLC FB). Furthermore, the configuration parameter itself is also a placeholder, so you can reuse it. Example: In the above graphic, the driver product version is specified with the placeholder $<Drv File Version>. This placeholder points to the driver file version entry, which in turn is occupied by the placeholder $<Version From File>. The placeholder $<Version From File> assumes the version value, where the source of the version value is defined with the version source file parameter. Why do we need placeholders? Placeholders allow us to define a parameter value and reuse it in many places in the configuration, or to set them in a chain dependency in relation to each other (see example above). Overview of available placeholders Placeholders from the group of configuration parameters Category Name Displayname Default Description TC General Generate Generate Twin CAT TRUE Generate a Twin CAT C++ project. C++ Project If unset, only code artifacts will be generated which can get used to generate C++ projects later [} 129]. TE1400 Version: 2.4.1 177

## Page 178

From version 2.x.xxxx.x Category Name Displayname Default Description Project Dir Twin CAT C++ Project Full path to the directory with the Directory VCXPROJ file (e. g. "C:\Temp") Project Name Twin CAT C++ Project Name to the generated Name VCXPROJ file (e. g. "My Generated Project.vcxproj") Lowest Compati Lowest compatible $<Twin CAT:Ver The lowest Twin CAT build ble Tc Build Twin CAT version sion:BUILD> number the generated C++ (build number) project and its modules and POUs are to be compatible with. Class Factory Na Class factory name $<Project:Name Name of the generated C++- me > Project, Name of the Tc COM classfactory and tmx-file name Product Name Product name $<Module Gener Product name, used e.g. for the ator:Product Id> module driver description and the $<Module Gener module TMC description [} 162]. ator:Version:MA JOR. MINOR> Copyright Copyright notice Copyright Copyright notice of the generated $<Vendor Name module driver file [} 162] > $<Local Date Ti me:%Y> Description Driver description Twin CAT Driver description [} 162] executable file, generated by Twin CAT $<Module Gener ator:Product Id> Vendor Name Vendor name TE140x Module Module vendor name, used as the Vendor company name of the generated executables in the repository [} 118] and the major module group as shown in the Twin CAT XAE module dialog. Version Src Version source file $<Latest TMFile Path to an existing TMC, TML or > XML file containing the previous version value [} 140]. Increment Versi Version part for Revision The part of the version number on increment that is to be incremented [} 140]. Drv File Version Driver file version $<Version From Executable file version and library File> version. [} 140] Drv Product Vers Driver product version $<Drv File Versio Product version [} 140] ion n> Code Gen Place Code generation Define custom placeholders holders placeholders Use Data Excha Load 0 Manually set nge Modules Data Exchange Module Data Exchange Module [} 138] s dependency (currently no need to set manually) Max Visible Arra Maximum number of 200U Specifies the maximum number of y Elements visible array elements array elements to be displayed in the Twin CAT XAE. In the Twin CAT XAE, larger arrays cannot get expanded and linked to by its individual items 178 Version: 2.4.1 TE1400

## Page 179

From version 2.x.xxxx.x Category Name Displayname Default Description Pack Output Pat Pack output path Path to pack the generated h Twin CAT C++ project. Optional [} 133]. Can be a directory or .zip file. See Sample "Use Continuous Integration Principles with Code Generation" TC Build Prefer Tool Archi Prefer X64 build tools TRUE Prefer X64 compiler and linker. tecture X64 Useful for complex source files, where X86 tools may run out of heap space. Cpp Language S Specify C++ language Default Enable supported C++ language tandard standard version features from the specified version of the C++ language standard Verbosity Codegeneration and Normal Verbosity level of code generation build verbosity and build output messages. Silent and Detailed are other possible values. Publish Run the publish step TRUE Start the build procedure after after project code generation for all selected generation platforms. The generated module binaries and module descpription files will get copied to the "publish folder". Published modules are automatically located by the XAE and can get instantiated in all Twin CAT 3 projects. If unset, the module generation process will be stopped after code generation. To instantiate in a Twin CAT3 project, the generated C++ project needs to be inserted and built from. Publish Platform Platform Toolset Auto Choose Platform Toolset to build toolset binaries. Publish Configur Build configuration Release Build configuration to build ation binaries. Publish Tc RTx8 Twin CAT RT (x86) TRUE Publish binaries for platform 6 'Twin CAT RT (x86).' [} 132] Publish Tc RTx6 Twin CAT RT (x64) TRUE Publish binaries for platform 4 'Twin CAT RT (x64).' [} 132] Publish Tc OSx6 Twin CAT OS (x64) TRUE Publish binaries for platform 4 'Twin CAT OS (x64)' (e.g. Twin CAT/ BSD) [} 132] Publish Tc OSA Twin CAT OS FALSE Publish binaries for platform RMv8A (ARMV8-A) (Twin CAT 'Twin CAT OS (ARMV8-A)' XAE >= 3.1.4026) (requires Twin CAT XAE >= 3.1.4026) [} 132] Force Rebuild Fo Always rebuild all FALSE Always rebuild all source files on r Publish source files on publish publish Publish Parallel Build parallel to TRUE Build parallel on multiple cores to publish publish Sign Twin Cat Ce Certificate name for Certificate name for Twin CAT rt Name Twin CAT signing signing with OEM Certificate level 2. [} 92] TE1400 Version: 2.4.1 179

## Page 180

From version 2.x.xxxx.x Category Name Displayname Default Description Tmx Install Install TMX TRUE Install all generated Twin CAT Objects on local XAE (fill local Engineering Repository [} 118]). Tmx Archive TMX Archive Name of an optional archive containing all files required to use the generated Twin CAT Objects on another Twin CAT development system. [} 136] Ms Build Publish Ms Build publish Set additional Ms Build publish Properties properties properties. Ms Build Proj Pro Ms Build project Set additional Ms Build project perties properties properties. Pre Code Gener Pre code generation The defined MATLAB® function is ation Callback Fc callback function called before code generation n [} 186]. Post Code Gener Post code generation The defined MATLAB® function is ation Callback Fc callback function called after code generation n [} 186]. Post Publish Call Post publish callback The defined MATLAB® function is back Fcn function called after publish [} 186]. Deployment Pat Deployment project Full path to a Twin CAT project h (.tsproj). Instances of the generated Tc COM Module in the specified project will be upgraded to the newly generated version [} 138] Deploy Restart Activate and restart FALSE If set the specified Twin CAT deployment project project will be activated and restarted on the configured target system [} 138] Post Deploy Call Post deploy callback The defined MATLAB function is back Fcn function called after deployment [} 186] TC PLC library Lib Cat Path PLC library category $<Project Dir>\ Path to the PLC library category description file $<Name>.libcat description file .xml Library Categori PLC library categories $<Vendor Name Define PLC library category es > hierarchy. Default only one hierarchy level = vendor. List separated with | possible: <Main Category>| <Sub Category1>|… Generate Plc Lib Generate a PLC FALSE Generate a PLC library with POUs. rary library [} 210] Define containing POUs with parameter Tc Com Wrapper Fb and Plc Fb>General>Generate. Install Plc Library Install the generated FALSE Install the generated PLC library PLC library for use in the local Twin CAT XAE/ PLC [} 210]. Plc Type Prefixe Type Prefixes Define custom type prefixes s 180 Version: 2.4.1 TE1400

## Page 181

From version 2.x.xxxx.x Category Name Displayname Default Description Plc Var Prefixes Variable Prefixes `PVOID=p \| Define custom variable prefixes. BOOL=b \| BOOL32=b \| DATE=d \| TIME_OF_DAT E=td \| TIME=t \| LTIME=t \| GUID=n` TC License Oem Id ID of OEM ID of OEM. Required for OEM Licence checks [} 159] Oem Licenses IDs of OEM Licenses IDs of OEM Licenses. Multiple IDs may be inserted as a comma separated list. "{GUID},{GUID}" [} 159] TC Tc Com Generate Generate Tc COM TRUE Generate a Tc COM module class General Module (Twin CAT for the model. Module Class) Online Change Online change FALSE Allow to switch between different support Tc COM module versions without switching Twin CAT runtime to config mode. Module Properti TMC Properties Additional properties added to the es module description in the TMC file: Name1=Value1| Name2=Value2|... Group Name Group Name TE140x\| Minor module group name in the Simulink Twin CAT XAE module dialog Modules Group Display N Group Display Name $<Group Name> Minor module group description in ame the Twin CAT XAE module dialog Group Icon Group Icon $<TE140x:Icon Optional module group icon in the > Twin CAT XAE module dialog Module Icon Module Icon $<TE140x:Icon Optional module icon in the > Twin CAT XAE module dialog Init Exception Ha Floating point Caller Exception Configures how to throw, ndling exception handling s suppress or handle floating point during initialization exceptions during initialization [} 224]. Update Exceptio Floating point Caller Exception Configures how to throw, n Handling exception handling s suppress or handle floating point during update exceptions during cyclic execution [} 224]. Additional Includ Additional include files Additional files required to be e Files included after rtwtypes.h TC Tc Com Oem Licenses IDs of OEM License $<Project:Oem IDs of OEM Licenses. Multiple IDs License Licenses> may be inserted as a comma separated list. "{GUID},{GUID}" [} 159] TC Tc Com Tc Com Wrapper Tc Com Wrapper FB FALSE Generate a PLC Functionblock Wrapper Fb simplifying the interaction between a PLC and an instance of the generated Tc COM module [} 213] TE1400 Version: 2.4.1 181

## Page 182

From version 2.x.xxxx.x Category Name Displayname Default Description Tc Com Wrapper Tc Com Wrapper FB FALSE Generate properties for accessible Fb Properties properties data in the referenced Tc COM object [} 213] Tc Com Wrapper Tc Com Wrapper FB No Monitoring No Monitoring: Online values of Fb Property Moni property monitoring properties are not monitored in toring the PLC online view, Cyclic Update: Update property values in the PLC online view cyclically, Execution Update: Update property values in the PLC online view when the property getter or setter is called [} 213] TC Tc Com Module Caller Default module caller Cyclic Task Cyclic Task: Call module via Additional Twin CAT Task. Module: Cal settings module from another Twin CAT module (see e.g. Tc COM- Wrapper-FB). Caller Verificatio Verify caller Default Verify the caller context to prevent n concurrent execution of the model code and corresponding Data Area mappings. Skip verification to reduce the execution time. Step Size Adapta Default Step Size Require Matchin Configure how to handle tion adaptation mode g Task Cycle Tim differences between the default e model step size(s) and the cycle time of the assigned task(s). Execution Sequ Default execution Update Before O Configure the execution order of ence sequence utput Mapping input mapping, model code execution and output mapping. Execute Model C Execute model code TRUE Start cyclic execution of the model ode after startup code after startup by default. If FALSE, Module Parameter Execute needs to be set to TRUE to start execution of code. Block Diagram E Export Block Diagram TRUE Export graphical block diagram xport information for monitoring and optional debugging on the generated Twin CAT module in Twin CAT XAE [} 197] Resolve Masked Resolve Masked FALSE Resolve masked subsystems in Subsystems Subsystems the block diagram Extend Signal Re Extended resolution of FALSE Intensified search for assignments solution signals in block of variables and block diagram diagram signals (blue signals). This option increases the build time. [} 239] Block Diagram V Access to Assign To Parent Variables from a block within an ariable Access Variable Group not unresolved subsystem are either referenced by any assigned to the next higher visible block block or hidden in the block diagram. Block Diagram D Export Block Diagram TRUE Export additional information ebug Info Export debug info required to debug the module using the block diagram [} 201]. 182 Version: 2.4.1 TE1400

## Page 183

From version 2.x.xxxx.x Category Name Displayname Default Description TC Tc Com Execution Info O Create Execution Info FALSE Create additional output Interfaces utput output Data Areas containing execution and exception information [} 224]. Monitor Executio Monitor execution FALSE Calculate and expose the n Time time execution time of the module as an ADS variable for monitoring purposes. Input Data Acces Input: Data Access Input Defines how the input variables s Destination are exposed in Twin CAT [} 146]. Data Area Input Create Sy Input: Create ADS TRUE Create ADS symbol information mbols Symbols for the input variables [} 146] Input Init Values Input: Initial values FALSE Create module parameters for the input variables to allow definition of initial values [} 146] Input Properties Input: TMC Properties Additional properties added to the Input symbol description in the TMC file. [} 170] Output Data Acc Output: Data Access Output Source Defines how the output variables ess Data Area are exposed in Twin CAT [} 146]. Output Create Sy Output: Create ADS TRUE Create ADS symbol information mbols Symbols for the output variables [} 146]. Output Propertie Output: TMC Additional properties added to s Properties the Output symbol description in the TMC file. [} 170] Parameters Dat Parameters: Data Internal Defines how the model parameter a Access Access Data Area variables are exposed in Twin CAT [} 146] Parameters Cre Parameters: Create TRUE Create ADS symbol information ate Symbols ADS Symbols for the model parameter variables [} 146]. Parameters Init V Parameters: Initial TRUE Create module parameters for the alues values model parameter variables to allow definition of initial values [} 146]. Parameters Pro Parameters: TMC Additional properties added to perties Properties the Parameters symbol description in the TMC file. [} 170] Block Io Data Acc Block IO: Data Access Internal Defines how the Block IO variables ess Data Area are exposed in Twin CAT [} 146] Block Io Create S Block IO: Create ADS TRUE Create ADS symbol information ymbols Symbols for the Block IO variables [} 146]. Block Io Properti Block IO: TMC Additional properties added to es Properties the Block IO symbol description in the TMC file. [} 170] Cont State Data Cont State: Data Internal Defines how the continuous state Access Access Data Area variables are in Twin CAT [} 146] TE1400 Version: 2.4.1 183

## Page 184

From version 2.x.xxxx.x Category Name Displayname Default Description Cont State Creat Cont State: Create TRUE Create ADS symbol information e Symbols ADS Symbols for the continuous state variables [} 146]. Cont State Prope Cont State: TMC Additional properties added to rties Properties the Cont State symbol description in the TMC file. [} 170] DWork Data Acc DWork: Data Access Internal Defines how the DWork variables ess Data Area are exposed in Twin CAT [} 146] DWork Create Sy DWork: Create ADS TRUE Create ADS symbol information mbols Symbols for the DWork variables [} 146]. DWork Propertie DWork: TMC Additional properties added to s Properties the DWork symbol description in the TMC file. [} 170] Data Store Data Data Store: Data None Defines how the Data Store Access Access variables are exposed in Twin CAT [} 146] Data Store Creat Data Store: Create TRUE Create ADS symbol information e Symbols ADS Symbols for the Data Store variables [} 146]. Data Store Read Data Store: Read Only FALSE Restrict ADS access to be read Only only for the Data Store variables [} 146]. Data Store Prope Data Store: TMC Additional properties added to rties Properties the Data Store symbol description in the TMC file. [} 170] Symbol Properti Additional TMC Additional properties added to es Symbol Properties specific symbol descriptions in the TMC file. [} 170] Variable Symbol Mapping between Identical Defines the Twin CAT symbol Mapping variable names and names for the generated C/C++ ADS symbol names variables. 'Identical': Symbol name equals variable name, 'Classic': Use symbol names known from TE1400 Release 1.2.x.x [} 146] TC Tc Com Ext Mode Rt Allo Allow Real Time FALSE Allow to start and stop model External Mode w Execution Co execution commands code execution via External Mode mmands via External Mode [} 221]. Ext Mode Rt Wait Wait for Real Time FALSE Wait for External Mode [} 221] For Start execution start connection before starting model command via External code execution. Mode Ext Mode Rt Allo Allow to change FALSE Allow to change parameter online w For Parameter parameters via values via External Mode [} 221]. Change External Mode TC Plc Fb Generate Generate Twin CAT TRUE Generate a PLC-FB for the model General PLC Function Block [} 217]. Init Exception Ha Floating point Caller Exception Configures how to throw, ndling exception handling s suppress, or handle floating point during initialization exceptions during initialization [} 224]. 184 Version: 2.4.1 TE1400

## Page 185

From version 2.x.xxxx.x Category Name Displayname Default Description Update Exceptio Floating point Caller Exception Configures how to throw, n Handling exception handling s suppress, or handle floating point during update exceptions during cyclic execution [} 224]. TC Plc Fb Oem Licenses IDs of OEM License $<Project:Oem IDs of OEM Licenses. Multiple IDs License Licenses> may be inserted as a comma seperated list. "{GUID},{GUID}" [} 159] TC Plc Fb Monitor Executio Monitor FALSE Calculate and expose the Additional n Time Execution Time execution times of Twin CAT settings modules as an ADS variable for monitoring purposes. Plc Fb- Input Attributes Input variables: PLC Additional attributes added to the >Interface Attributes PLC FB Input variables. Output Attribute Output variables: PLC Additional attributes added to the s Attributes PLC FB Input variables. TC Plc Fb Ext Mode Rt Allo Allow Real Time FALSE Allow to start and stop model External Mode w Execution Co execution commands code execution via External Mode mmands via External Mode [} 221]. Ext Mode Rt Wait Wait for Real Time FALSE Wait for External Mode For Start execution start connection before starting model command via External code execution [} 221]. Mode Ext Mode Rt Allo Allow to change FALSE Allow to change parameter online w For Parameter parameters via values via External Mode [} 221]. Change External Mode Placeholders at target level (module generator) Placeholders from this group can be used at target/project and module level. Placeholder name Description Module Generator:Product Name Product name of the module generator Module Generator:Version Version of the module generator Twin CAT:Version Version of local Twin CAT installation Usable Platform Toolsets Available and supported platform toolsets Local Date Time:Format Actual local time as string where Format must be defined like the format string for std::put_time (e.g. '%Y-%m-%d') Utc Date Time:Format Actual UTC time as string where Format must be defined like the format string for std::put_time (e.g. '%Y-%m-%d') Environment Var Name Any environment variable defined for the system, the current user or the current process (MATLAB®). Placeholders at project level Placeholders from this group can be used at project and module level. Placeholder name Description Project:Name Name of the project file (without directory and extension) Project:Dir Project file directory Project:Ext Project file extension Project:Path Full project file path Project:Guid Project GUID TE1400 Version: 2.4.1 185

## Page 186

From version 2.x.xxxx.x Placeholder name Description Project:Library ID Library ID of the generated repository driver Project:Vendor Name Company name part of the Library ID Project:Driver Name Driver name part of the Library ID Project:Drv File Version Version part of the Library ID Project:Latest TMFile Path to an existing corresponding TML or TMC file with the highest library version (searching project directory and repository) Project:Latest TMFile:Repository Path to an existing corresponding TML or TMC file with the highest library version (searching only repository) Project:Latest TMFile:Project Dir Path to an existing corresponding TML or TMC file with the highest library version (searching only project directory) Project:Version From File Version read from file defined by "Version Src" Placeholders at module level (Tc COM and PLC FB) Placeholders from this group can only be used at module level. Placeholder name Description Module:Name Name of the Tc Com module or PLC FB Module:Cls Id Class ID of the Tc Com module (Tc Com only) Module:Context Count Number of task contexts Module:Class Name Name of the Tc Com module Module:Cpp Class File Name Name of the corresponding .h and .cpp files Module:Model Name Name of the corresponding Simulink Model (TE1400 only) Module:MFile Name Name of the corresponding M-File (TE1401 only) Module:File Filter Name Visual Studio project filter name 4.7.19 Working with callbacks There are three different callback functions: • Pre code generation callback function: Callback before the model is converted to C++ code. • Post code generation callback function: Callback after the model has been converted to C++ code. • Post publish callback function: Callback after the created C++ project has been built for the configured platforms. • Post deploy callback function: Callback will be executed after the project specified in “Deployment Project” is updated. Enter the name of your created MATLAB® function here to call it. 186 Version: 2.4.1 TE1400

## Page 187

From version 2.x.xxxx.x Your MATLAB® function is passed the Project Exporter object as a transfer parameter: function My Callback(obj) … return The object contains the current configuration of the build in its properties. Project Exporter with properties: Project Generator: [1×1 Twin CAT. Module Generator. Project Generator] Configuration: [1×1 Twin CAT. Module Generator. Project Export Config] Project: [1×1 Twin CAT. Module Generator. Project] State: [1×1 struct] Class Exporters: {[1×1 Twin CAT. Module Generator. Simulink. Model Exporter]} Additional Exports: [1×1 containers. Map] Sample code in MATLAB® Open the appropriate sample with: Twin CAT. Module Generator. Samples. Start('Callbacks') 4.8 Application of modules in Twin CAT Tc COM and function blocks created with the Target for Simulink® can be used seamlessly in Twin CAT XAE. The only requirement for use on any Twin CAT XAE system is the use of Twin CAT XAE version 3.1.4024.7 and higher. MATLAB®, a full Visual Studio installation, etc. are not necessary, since you work with objects and description files already compiled for Twin CAT. TE1400 Version: 2.4.1 187

## Page 188

From version 2.x.xxxx.x Simply copy the Engineering Repository folder to the engineering system of your choice. See also Twin CAT objects [} 118] and Sharing created Twin CAT objects [} 136]. Always retain the folder structure when copying manually: %Twin CATInstall Dir% \3.1\Repository\<TE140x Module Vendor>\<Model Name>\<Version>\. 4.8.1 Working with the Tc COM module Insert Tc COM in Twin CAT 1. Open Twin CAT (Twin CAT XAE or Twin CAT in a Visual Studio environment). 2. Instantiate a new Tc COM object. 3. Select the desired object. 4. Create a cyclic task. 188 Version: 2.4.1 TE1400

## Page 189

From version 2.x.xxxx.x 5. Assign the created task to your Tc COM instance. Note that the cycle time of the task and the Sample Time in Simulink® (here 5 ms) match. 6. Activate the configuration. TE1400 Version: 2.4.1 189

## Page 190

From version 2.x.xxxx.x 4.8.1.1 Parameterization of a module instance Given is an instance of a Tc COM, in which tabs can parameters be found? You can view and change parameters in Parameter (Init), Parameter (Online) and around Block Diagram. In Data Area you can see the created Data Areas and their contents (parameter name and data type), but you cannot manually change any values here via the XAE. See also Best practice: access to Tc COM data [} 150] for ways to access data on a Tc COM. Default, Startup, Online and Prepared values Parameters can have different states/properties. These are defined below: • Default values are the parameter values during code generation (as they were set in Simulink®). They are stored unchangeably in the module description file (*.tmc), i.e. the description of the module class. • Startup values are stored in the Twin CAT project file and written to the module instance. The startup values are located accordingly on the target system and define the values at the start of the module instance. • Online values are only available if the Tc COM instance was started on the target system. They show the current parameter value in the running module. This value can also be changed during runtime. • Prepared values can be specified whenever online values are available. With its help, several parameter values can be changed and written to the module at the same time. Parameterization of a module instance Example setting in TC Tc Com Interface To explain the parameterization of a module instance, a module with the following properties is assumed. 190 Version: 2.4.1 TE1400

## Page 191

From version 2.x.xxxx.x Properties of the Tc COM based on these settings: Enter model parameters as tunable The Simulink Coder™ model parameters are set as "inlined" as the default behavior. This means that the object memory used is smaller and the generated code is optimized in terms of runtime, but often only a few parameters can be changed at runtime with this setting. Use the Configuration Parameter under Optimization > Default parameter behavior "Tunable" so that you can parameterize your model at runtime. • The structure of the model parameters <Model Name>_P is created as module parameters, because Parameters: Initial Values is enabled. As Data Area the model parameters are accessible if Code Interface packaging is not set to Reusable function. • Block IO is created as a standard Data Area and is therefore visible in the process image of the Tc COM and can be linked via Data Pointer. • Create Execution Info output is enabled, accordingly there is another Data Area of type Output Source with the execution information of the instance. • Create ADS Symbols is enabled on all Data Areas, so all parameters in the Data Areas are accessible by ADS symbol name. • Module parameters are created for the inputs of the model, because Input: Initial Values is enabled. For a description of the setting options, see Configuration of data access to data of a Tc COM object [} 146]. Possible parameter settings in Parameter (Init) Module parameters can be found in Parameter (Init), which do not change cyclically but can be changed acyclically. No online values can be seen in Config mode, or when the Tc COM is not started. TE1400 Version: 2.4.1 191

## Page 192

From version 2.x.xxxx.x Define Startup Values Startup Values can be set in the Parameter (Init) representation or in the Block Diagram representation (see in the following chapter). To do this, select the entry in the Value column that you want to adjust on the module instance and enter a value. The value set in this way is only available in the project file in the XAE at this time. Activate Configuration loads the set value (with the overall project) to the target system. Settings such as the Module Caller, Step Size Adaption or Execution Sequence cannot be changed at runtime of the module, but they can only be defined as startup values. Other module parameters such as Execute or the model parameters can also be changed online. Change values online If the Tc COM module is active, you can use Show Online Values to make the current values of the instance visible. You can enter a new value in the Value column, making it a Prepared Value. If the Prepared Value is not yet loaded on the target system, the field with deviation between Value and Online appears with red marking. Once all changes have been made, you can right-click at the structure level and use "Download" to set the prepared values in the target system. Note that this does not change the startup value of the instance on the target system. To do this, you must first activate the current configuration on the target system. Likewise, you can use "Upload" to set the current Online Values as Startup Values in the project. Again, the change is not active on the runtime system until the project is compiled and downloaded, see Best practice: access to Tc COM data [} 150]. 192 Version: 2.4.1 TE1400

## Page 193

From version 2.x.xxxx.x Possible parameter settings in Block Diagram All parameters in the parameter range (right side of the window) are only displayed in the Twin CAT 3 block diagram if you are in the top level of the block diagram ("<root>"). If you are in a subsystem or if you have selected a block, only the parameters of the active block are displayed. In the block diagram you have the possibility to read and write online values as well as to change Startup Values. Select a block with a yellow dot in the lower left corner. If you click directly on the yellow dot, a context menu opens in which you can see the online values of the block and also change them. If you change a value, it will be entered in the Prepared list. When you have made all the changes, you can write the prepared values to the target system. You can select in the Prepared list whether you want to set the prepared values as Online and/or Startup values. TE1400 Version: 2.4.1 193

## Page 194

From version 2.x.xxxx.x You can also go over the parameter list in the right area of the block diagram and change values here. Find the parameter you want to change and click the down arrow on the right side of the list. Here you can make changes in the editable fields. If you move the mouse pointer over the parameter name (Temp Ctrl_P. Kp in the following diagram), the ADS address information is displayed. By right-clicking on the parameter name, you can copy the parameter's ADS address information to the clipboard. You can also change entire structures. Select the <Model Name>_P structure, for example, i.e. the structure that contains all model parameters, and select the downward pointing arrow here. A context menu appears by right-clicking on Startup Values, for example. Here you can set all current online values of the structure as Startup Values, or you can reset the startup list to the default values. Interaction with Data Areas 194 Version: 2.4.1 TE1400

## Page 195

From version 2.x.xxxx.x You cannot change Data Areas via the XAE. You can only see the Data Area type (see Type column) and deduce which interaction options are possible with the Data Area, see Configuration of data access to data of a Tc COM object [} 146]. Via the CS column you can see whether ADS symbol names are to be generated for this Data Area. CS is editable by the user. If CS is enabled, you can use the Target Browser, for example, to search for the ADS symbols and include them in a scope configuration. If CS is disabled, you can only access the Data Area data via Index Group and Index Offset. Index Group is the Object ID of the instance (see Object tab) and Index Offset is displayed in the CD / Elements column. For more information on interacting with Data Areas, see Configuration of data access to data of a Tc COM object [} 146] and Best practice: access to Tc COM data [} 150]. 4.8.1.2 Parameterization of several module instances In the above section it was described that an instance of a Tc COM can be parameterized in Twin CAT, even deviating from the parameters in Simulink®. If several instances of a Tc COM are used in a Twin CAT Solution, different options exist with regard to the individual parameterization of the instances. To implement the following three options, you must use the Code interface packaging setting in Simulink®. Make sure that the setting Default parameter behavior is set to Tunable under Optimization. TE1400 Version: 2.4.1 195

## Page 196

From version 2.x.xxxx.x ü All instances should have the same parameters. 1. Set the parameter to "Reusable function". This is the default value when selecting the target Twin Cat Grt.tlc. 2. Create several instances of your Tc COM in Twin CAT. 3. Under Parameters (Init), configure the <Model Name>_P_Sharing parameter to define or inherit. Define specifies the parameterization of all dependent instances configured with inherit. ð Only one instance with define may be configured. ü It should be possible to parameterize each instance individually. 1. Set the parameter to "C++ class". 2. Create several instances of your Tc COM in Twin CAT. ð No <Model Name>_P_Sharing parameter is generated. Each instance can be parameterized individually. ü Only one instance should be allowed in the project. 1. Set the parameter to "Nonreusable function". ð If you create several instances of your Tc COM in Twin CAT, you receive an error message when activating the solution. ð Whether an instance of a Tc COM can be instantiated multiple times can be seen in the TC3 Block Diagram. 2. To do this, go to the parameter range on the right. Under Block Identification a parameter "Single Instance" is visible. ð The value False means multi-instantiable. Accordingly, True means one instantiation. 196 Version: 2.4.1 TE1400

## Page 197

From version 2.x.xxxx.x Settings also apply to the use of the PLC function blocks The setting of the Code Interface Packaging has the same meaning for the use of the Tc COM as well as for the use of the PLC function blocks. Open sample for parameterization In MATLAB®, open the Multi Instance sample: Twin CAT. Module Generator. Samples. Start("Create Multiple Instances of the Same Tc COM Module") 4.8.1.3 Working with the block diagram in Twin CAT 4.8.1.3.1 Simulink®-Tc COM If a Twin CAT object was created with the Twin CAT Target for Simulink® and the block diagram export was executed in the process, the block diagram of the Simulink® model can be displayed as a control in the Twin CAT XAE. 4.8.1.3.1.1 Using the block diagram The block diagram export can be configured during generation of a Tc COM module from MATLAB® or Simulink®. If the export was enabled, the block diagram can be found in the Twin CAT development environment under the "Block Diagram" tab of the module instance. Using shortcuts, drag & drop and a context menu you can navigate through the hierarchy of the Tc COM module, view parameter values, display signals values and obtain optional additional debug information. TE1400 Version: 2.4.1 197

## Page 198

From version 2.x.xxxx.x Shortcut functions: Shortcut Function Space Zoom to current size of the block diagram tab Backspace Switch to the next higher hierarchical level ESC Switch to the next higher hierarchical level CTRL + "+" Zoom in CTRL + "-" Zoom out F5 Attach Debugger (System- > Real-Time -> C++ Debugger -> Enable C++ Debugger must be activated) Context menu functions: 4.8.1.3.1.2 Display signal curves For verification and troubleshooting it is often helpful to display signal curves. The block diagram offers the following options: Display signal curves in the block diagram The block diagram offers an option to display signal curves in a window. To this end, drag and drop a signal or block into a free area of the block diagram. 198 Version: 2.4.1 TE1400

## Page 199

From version 2.x.xxxx.x Create a scope in the block diagram After the drop, a scope window opens in the block diagram. Display the scope in the block diagram The title bar of the scope window offers the following options: Close window Keep window in the foreground across all block diagram hierarchies Minimize window to the title bar TE1400 Version: 2.4.1 199

## Page 200

From version 2.x.xxxx.x Displaying the scope in the block diagram control [} 245] requires a Scope View Professional (TE1300) license. No Scope View Professional license is required in Twin CAT XAE. When creating a scope window in the block diagram for a Simulink® bus, all signals of the bus are directly displayed in the scope window. The scope window in the block diagram can be used for a quick overview. For more detailed analyzes, it is advisable to analyze the signals in a Twin CAT Measurement project. Display signal curves in Twin CAT 3 Scope If the drop is not made to the block diagram control but to an Axis Group in a Twin CAT Measurement project, the signal is added there. Add a signal in a Twin CAT 3 Scope 4.8.1.3.1.3 Module parameterization in the block diagram To parameterize a Tc COM instance, the parameter window can be used directly in the block diagram. In addition, the Property table can be used, which can be expanded or collapsed on the right-hand edge of the block diagram. A basic distinction is made between different parameter values: "Default", "Startup", "Online" and "Prepared" The following value types can be found in the drop-down menu of the Property table of the block diagram: • Default values are the parameter values during code generation. They are invariably stored in the module description file and enable the manufacturing settings to be restored after parameter changes. • Startup values are stored in the Twin CAT project file and downloaded to the module instance as soon as Twin CAT starts the module instance. Startup values for the input process image can also be specified in Simulink® modules. This allows the module to be started with non-zero input values, without the need for linking the inputs with other process images. Internal signals and output signals have no starting values, since they would, in any case, be overwritten in the first cycle. • Online values are only available if the module was started on the target system. They show the current parameter value in the running module. This value can also be changed during runtime. Although in this case the corresponding input field has to be enabled via the context menu, in order to prevent accidental inputs. • Prepared values can be specified whenever online values are available. They can be used to save various values, in order to write them consistently to the module. If prepared values have been specified, they are displayed in a table below the block diagram. The buttons to the right of the list can be used to download prepared values as online values and/or save them as starting value, or delete them. Parameterization in the block diagram Parameterizable blocks are marked with a yellow box in the block diagram. 200 Version: 2.4.1 TE1400

## Page 201

From version 2.x.xxxx.x Double-clicking on the block or a single click on the yellow box brings up a window with the parameters that can be changed. If a value is changed, it can be applied with the following keyboard commands: CTRL + Enter Set online value directly SHIFT + Enter Set startup value Enter Set prepared value The icons in the title bar have the following functions: Close window Keep window in the foreground across all block diagram hierarchical levels Keep window open at the current block diagram hierarchical level Minimize window to title bar 4.8.1.3.1.4 Debug Different ways are available to find errors within a Tc COM module created with MATLAB®/Simulink®, or to analyze the behavior of the module within the overall architecture of the Twin CAT project. TE1400 Version: 2.4.1 201

## Page 202

From version 2.x.xxxx.x Debugging in the block diagram If the block diagram was exported during generation of the Tc COM module, it can be displayed in the Twin CAT development environment and used for debugging within the corresponding module instance, for example. To do so, the block diagram uses the Microsoft Visual Studio debugger, which can be linked with the Twin CAT runtime via the Twin CAT debugger port. Attach the debugger as described in the C++ section under Debugging. Prerequisites for debugging within the block diagram are: • The C/C++ source code of the Tc COM module must be present on the engineering systems, and the Visual Studio debugger must be able to find it. Ideally, debugging should take place on the system on which the code was generated. If the module was created on another system, the associated C/C++ source code can usually be made known by integrating the Visual Studio project into the Twin CAT C++ section. The file <Model Name>.vcxproj is located in the build directory, see Which files are created automatically during code generation and publishing? [} 60] • The module must have been created with the Debug configuration. When publishing takes place directly after the code generation, select the Debug setting in the Module generation (Tc Build) [} 23] section under publish configuration. When publishing the module from the C++ section in Twin CAT, the debugger in the C++ node of the solution must be enabled; see C/C++ documentation, Debugging. • During code generation, the options Export block diagram and Export block diagram debug information must be enabled in the coder settings under Tc Advanced. • In the Twin CAT project, the debugger port must be enabled, as described in Twin CAT 3 C++ Enable C++ debugger. Setting breakpoints in the block diagram 1. After attaching the debugger to the Twin CAT runtime, the possible breakpoints are assigned to the blocks in the block diagram and represented as points. Clicking on the desired breakpoint activates it, so that execution of the module instance is stopped next time the associated function block is executed. The color of the point provides information about the current state of the breakpoint: • Gray: breakpoint inactive • Red: breakpoint active. The program is stopped next time this function block is executed • Yellow dot in the middle: breakpoint hit. Program execution is currently stopped at this point • Blue dot in the middle: breakpoint hit (as yellow), but in a different instance of the module. • 202 Version: 2.4.1 TE1400

## Page 203

From version 2.x.xxxx.x 2. Additional information, such as the corresponding C++ code section, can be found in the tooltip for the breakpoint: Breakpoints are not always assigned to a single function block. In many cases, the functions of several blocks are consolidated in a code section or even a line in the underlying C++ code. This means that several blocks can share the same breakpoint. Therefore, activation of a breakpoint in the block diagram may also result in changes in the point display in other blocks. Evaluating exceptions If exceptions occur during processing of a Tc COM module, such as division by zero, the point at which the exception occurred can be shown in the block diagram. To this end, the Tc COM module must meet the above requirements, and the C++ debugger must be enabled in the Twin CAT project (Twin CAT 3 C++ Enable C++ debugger). After the debugger has been attached, which may be done before the exception has occurred or indeed after, the block that caused the exception is highlighted in the block diagram, provided the line of code responsible for the exception can be allocated to a block. The name of the function block is shown in red, and the function block itself is marked in bold. TE1400 Version: 2.4.1 203

## Page 204

From version 2.x.xxxx.x Manual evaluation of exceptions without source code Even if the module source code is not available on the engineering system or the C++ debugger was not activated, you can highlight the error location in the block diagram once an exception has occurred. Typically, an error message will always be generated when an error occurs, indicating the source file and the line in the source code. In many cases, this information can be used to allocate an exception to a block in the block diagram. To do this, you can proceed as follows: ü A prerequisite for highlighting the error location within the block diagram is that debug information was generated (option Export block diagram debug information in the coder settings under Tc Advanced). 204 Version: 2.4.1 TE1400

## Page 205

From version 2.x.xxxx.x 3. From the context menu of the block diagram select the entry Provide exception data: 4. In the dialog that opens, enter the source code file and line number provided in the error message: TE1400 Version: 2.4.1 205

## Page 206

From version 2.x.xxxx.x 5. The name of the function block associated with the line number is displayed in red, and the function block itself is marked in bold: 4.8.1.4 Online change of Tc COM at runtime With the “Online Change” you can exchange Tc COM objects at runtime, i.e. without Twin CAT stop, on a runtime PC. For a description of the Online Change for Tc COM, see: Online Change of Tc COM [} 144]. Open sample in MATLAB® Open a sample in MATLAB® with: Twin CAT. Module Generator. Samples. Start("Online Change for Tc COM Modules") 4.8.1.5 To File Block and MAT-file logging You can configure your Simulink® models to generate MAT files on the file system of the runtime PC in the form of a Tc COM object in Twin CAT runtime. Observe write permissions on the runtime PC Note the write permissions on the path you want to write to. MAT-file logging Configuration from Simulink®: • Enable MAT-file logging at Code Generation > Interface > MAT-file logging, see Math Works® documentation. • Enable Code Generation > TC General > Load Data Exchange Modules. If a Tc COM object is created with these settings and activated in a Twin CAT configuration on a runtime system, model signals are saved in a MAT file according to the properties specified by Math Works®. The MAT file is created on the file system of the runtime PC in the Twin CAT boot directory. 206 Version: 2.4.1 TE1400

## Page 207

From version 2.x.xxxx.x To File Block Configuration in Simulink®: • Enable MAT-file logging at Code Generation > Interface > MAT-file logging. • Enable Code Generation > TC General > Load Data Exchange Modules. • In the To File Block specify the fullpath, e.g. C:\Logs\My Log.mat. If you only specify the file name the MAT-file will be created in the Twin CAT boot directory. • Select in the Block Parameters of the To File Block Save format: Array. If a Tc COM object is created with these settings and activated in a Twin CAT configuration on a runtime system, a MAT file is created at the configured position. • The MAT-file is filled with new data at runtime and grows in its required memory size accordingly over time. • The terminate method to complete the MAT file is performed in the Transition Preop Init. To do this, either move the Tc COM object to the Init state or set the Twin CAT Runtime to Config mode. NOTICE Sufficient storage space Note that you must keep enough storage space on the target system to avoid unpredictable behavior of the runtime PC. Twin CAT File Writer You can precisely control data logging at runtime with the Twin CAT File Writer. The Twin CAT File Writer can terminate file packages of defined size and generate a specified set of files on the runtime system. Thus, there is no danger of reaching the limit of the target system memory. • Maximum size of .mat files adjustable • Maximum number of .mat files adjustable • Optionally pause writing via a Tc COM module parameter • Does not support all data types Documentation of the block, see Twin CAT File Writer [} 113]. 4.8.1.6 Calling the Tc COM from the PLC Please go to section Applying the Tc COM Wrapper FB [} 213]. 4.8.2 Working with the PLC library In addition to the Tc COM object, a PLC library can also be created. This PLC library contains two different types of function blocks: • The function block FB_<modelname> in the folder POU contains the full functionality of the Simulink® model, i.e. the source code is directly anchored in the FB. This FB is called PLC-FB in the following. • The subfolder POU/Tc COM Wrapper contains FBs that are wrappers for a Tc COM object, i.e. the functionality is not directly in the FB but is outsourced to an instance of a Tc COM. The wrappers are called Tc COM-Wrapper-FB in the following. Brief overview • Create PLC project: TE1400 Version: 2.4.1 207

## Page 208

From version 2.x.xxxx.x • Load PLC library: • View content of the PLC library: 208 Version: 2.4.1 TE1400

## Page 209

From version 2.x.xxxx.x • Instantiate function block FB_<modelname> (PLC-FB [} 217]) and use in PLC code: • Alternatively: use Tc COM Wrapper FB [} 213] and use it in the PLC code: TE1400 Version: 2.4.1 209

## Page 210

From version 2.x.xxxx.x 4.8.2.1 Create and install PLC library Configure the content of the PLC library As described at Working with the PLC library [} 207], the PLC library can contain different function blocks. • The function block FB_<modelname> in the folder POU contains the full functionality of the Simulink® model, i.e. the source code is directly anchored in the FB. This FB is called PLC-FB in the following. • The subfolder POU/Tc COM Wrapper contains FBs that are wrappers for a Tc COM object, i.e. the functionality is not directly in the FB but is outsourced to an instance of a Tc COM. The wrappers are called Tc COM-Wrapper-FB in the following. In the following, you will learn how to configure the two function blocks and how to install the PLC library created. 4.8.2.1.1 Configuring and installing the PLC library Configuring the type and variable prefixes You can configure your individual type and variable prefixes to be used in the created PLC library at Code Generation > TC PLC Library. By default, the variable prefixes are generated according to this convention (see Identifiers for variables and intances). Enter the desired prefixes as pipe-seperated list. Installing the PLC library As described above, you can configure which function blocks (PLC-FB [} 211] and/or Tc COM-Wrapper-FB [} 211]) should be included in your PLC library. In order to use the created function blocks in the PLC, the corresponding PLC library must be installed on your Twin CAT engineering system. Situation 1: ü You use the Target for Simulink® on the same PC on which you want to program your PLC. 1. Create a PLC library and install it directly on your local engineering system from Simulink®. 2. To do this, select the appropriate checkboxes at TC PLC Library: ð After a successful build, the new version of the PLC library is directly available in the local Twin CAT XAE. 210 Version: 2.4.1 TE1400

## Page 211

From version 2.x.xxxx.x Situation 2: ü You want to use the PLC library on any Twin CAT XAE systems. 1. Create a TMX archive [} 136]. 2. Copy the TMX archive [} 136] to a Twin CAT engineering system of your choice. 3. Install the PLC library when unpacking the TMX archive [} 136]. ð The library contained in the archive is available in Twin CAT XAE. 4.8.2.1.2 Create and configure the PLC-FB Navigate to Configuration Parameters > Code Generation > TC Plc Fb General. Check the checkbox Generate Twin CAT PLC Function Block here. In the standard configuration, the checkbox is checked. The further settings concern the handling of floating point exceptions for the PLC-FB. These must be made separately to the settings for the Tc COM object, see Exception handling [} 224]. 4.8.2.1.3 Create and configure the Tc COM-Wrapper-FB Navigate to Configuration Parameters > Code Generation > TC Tc Com Wrapper. Check the checkbox Tc Com Wrapper FB here. The checkbox is unchecked in the standard configuration. TE1400 Version: 2.4.1 211

## Page 212

From version 2.x.xxxx.x You can use the checkbox Tc Com Wrapper FB properties to configure whether the module parameters on the FB are to be created as properties. See Configuration of data access to data of a Tc COM object [} 146], especially Parameter: Initial values. You can learn how to apply the generated wrapper here: Applying the Tc COM Wrapper FB [} 213]. Sample By setting the Parameter: Initial Values under Tc Tc Com Interfaces, the model parameters are created as module parameters (switched on by default). Now create the “Tc Com Wrapper FB” with the option “Tc Com Wrapper FB properties”. Set the property monitoring to “Cyclic Update” to see the value change of the property directly in the online view. Then you can access the module parameters as follows, for example: PROGRAM MAIN VAR // dynamic instance: create Tc COM from PLC Init Str Dyn : ST_FB_Temp Ctrl_Tc COM_Init Struct_Init Struct := ( n Task Oid:= 16#02010030, // take Task OID of Plc Task e Module Caller:= E_Module Caller. Module ); // set module caller to "call by mod ule" fb Temp Ctr Dyn : FB_Temp Ctrl_Tc COM_Init Struct(Init Str Dyn); Outputs : ST_Temp Ctrl_Y_T; // output Inputs : ST_Temp Ctrl_U_T; // input Parameters : ST_P_Temp Ctrl_T; // parameter b Change: BOOL; END_VAR fb Temp Ctr Dyn(st Temp Ctrl_U := Inputs, st Temp Ctrl_Y => Outputs Dyn); IF b Change THEN 212 Version: 2.4.1 TE1400

## Page 213

From version 2.x.xxxx.x Parameters. Kp := 10; fb Temp Ctr Dyn.st Temp Ctrl_P := Parameters; END_IF In the "advanced" configuration level, the monitoring attribute of the properties can also be specified. In the default case, "No Monitoring" is set, i.e. no attribute is set. Setting in Simulink® Attribute on property Execution Update {attribute 'monitoring' := 'variable'} Cyclic Update {attribute 'monitoring' := 'call'} Monitoring attributes influence the visibility of the attribute values in the online view, i.e. when you have logged into the PLC and want to monitor the current values of the properties on the FB. • No Monitoring: the values are not visible in the online view. • Cyclic Update: the values of the properties are updated and displayed cyclically. In the logged-in state in the PLC additional code is executed. • Execution Update: the values of the properties are only updated in the online view if getter/setter methods for the properties are called in the execution code. This quickly leads to irritation and is only relevant in rare cases. No Tc COM Wrapper for Online Change-capable modules If the Tc COM is Online Change-capable, no Tc COM-Wrapper-FB is generated, since the version of the PLC library and the version of the Tc COM object must always match, which cannot be guaranteed for the Online Change of the Tc COM. 4.8.2.2 Applying the Tc COM Wrapper FB There are two ways to call a Tc COM object from the PLC: 1. Referencing a static object instance TE1400 Version: 2.4.1 213

## Page 214

From version 2.x.xxxx.x 2. Dynamic instantiation of an object from the PLC ð For both ways the Tc COM Wrapper function block from the generated PLC library is used. Configuration of the Tc COM Wrapper function block in Simulink® Navigate to Configuration Parameters > Code Generation > TC Tc Com Wrapper. Check the Tc Com Wrapper FB checkbox here. The checkbox is unchecked in the standard configuration. You can use the Tc Com Wrapper FB properties checkbox to configure whether the model parameters on the function block are to be created as properties. In the "advanced" configuration level, the monitoring attribute of the properties can also be specified. In the default case, "No Monitoring" is set, i.e. no attribute is set. Setting in Simulink® Attribute on property Execution Update {attribute 'monitoring' := 'variable'} Cyclic Update {attribute 'monitoring' := 'call'} Monitoring attributes influence the visibility of the attribute values in the online view, i.e. when you have logged into the PLC and want to monitor the current values of the properties on the FB. • No Monitoring: the values are not visible in the online view. • Cyclic Update: the values of the properties are updated and displayed cyclically. In the logged-in state in the PLC additional code is executed. • Execution Update: the values of the properties are only updated in the online view if getter/setter methods for the properties are called in the execution code. This quickly leads to irritation and is only relevant in rare cases. See also Create and install PLC library [} 210] or Create the Tc COM-Wrapper-FB for further details. 214 Version: 2.4.1 TE1400

## Page 215

From version 2.x.xxxx.x Create instance of the Tc COM Wrapper function block 1. Create a PLC project. 2. Add the desired library under References. ð Under Pous/Tc COM Wrapper you get a function block that you can instantiate in the PLC. In addition, necessary data types are created in the Duts folder. Version 1: referencing a static module instance The function block can be used to access module instances previously created in the XAE, e.g. under System > Tc COM Objects. For this static case, the object ID of the corresponding module instance must be transferred during declaration of the function block instance. • The instance of the Tc COM object and the calling PLC must run in the same task. • On the instance of the Tc COM object, make sure that under Parameter (Init) the entry Module Caller is set to Module and not to Cyclic Task. • In this case, the required memory for the Tc COM is obtained from the non paged pool of the system. Declaration // link wrapper with a static instance Init Str Static : ST_FB_Temp Ctrl_Tc COM_Init Struct := (noid := 16#01010010); // OID from object1 in System > Tc COM Objects fb Temp Ctr Static : FB_Temp Ctrl_Tc COM_Init Struct(Init Str Static); Inputs : ST_Temp Ctrl_U_T; // data type defined in Temp Ctrl library Outputs : ST_Temp Ctrl_Y_T; Execution code TE1400 Version: 2.4.1 215

## Page 216

From version 2.x.xxxx.x fb Temp Ctr Static(st Temp Ctrl_U := Inputs, st Temp Ctrl_Y => Outputs); Version 2: dynamic instantiation and referencing from the PLC The function block can also be used in such a way that a Tc COM object is generated from the PLC and linked to the wrapper. • The Task Oid of the PLC task must be used to specify the real-time task in which the wrapper is called. • The Module Caller must also be set to Module here (via the Init structure). • In this case, the required memory for the Tc COM is obtained from the router memory. Declaration // dynamic instance: create Tc COM from PLC Init Str Dyn : ST_FB_Temp Ctrl_Tc COM_Init Struct := ( n Task Oid := 16#02010030, // take Task OID of Plc Task e Module Caller := E_Module Caller. Module ); // set module caller to "ca ll by module" fb Temp Ctr Dyn : FB_Temp Ctrl_Tc COM_Init Struct(Init Str Dyn); Outputs Dyn : ST_Temp Ctrl_Y_T; Execution code fb Temp Ctr Dyn(st Temp Ctrl_U := Inputs, st Temp Ctrl_Y => Outputs Dyn); The source code for the graph shown above is available in MATLAB® via the Command Window Twin CAT. Module Generator. Samples. Start("Tc COM Wrapper Function Blocks") Working with the properties of the Tc COM Wrapper FB Properties on the FB provide an easy way to interact with module parameters of a Tc COM, see also Best Practice: access to Tc COM data [} 150]. Sample By setting the Parameter: Initial Values under Tc Tc Com Interfaces, the model parameters are created as module parameters (switched on by default). Now create the “Tc Com Wrapper FB” with the option “Tc Com Wrapper FB properties”. Set the property monitoring to “Cyclic Update” to see the value change of the property directly in the online view. Then you can access the module parameters as follows, for example: PROGRAM MAIN VAR // dynamic instance: create Tc COM from PLC Init Str Dyn : ST_FB_Temp Ctrl_Tc COM_Init Struct_Init Struct := ( n Task Oid:= 16#02010030, // take Task OID of Plc Task e Module Caller:= E_Module Caller. Module ); // set module caller to "call by mod ule" fb Temp Ctr Dyn : FB_Temp Ctrl_Tc COM_Init Struct(Init Str Dyn); Outputs : ST_Temp Ctrl_Y_T; // output Inputs : ST_Temp Ctrl_U_T; // input Parameters : ST_P_Temp Ctrl_T; // parameter b Change: BOOL; END_VAR fb Temp Ctr Dyn(st Temp Ctrl_U := Inputs, st Temp Ctrl_Y => Outputs Dyn); IF b Change THEN Parameters. Kp := 10; fb Temp Ctr Dyn.st Temp Ctrl_P := Parameters; END_IF 216 Version: 2.4.1 TE1400

## Page 217

From version 2.x.xxxx.x Working with the ADI Interface WARNING Unrestricted read and write access You get a pointer to the memory area of a Data Area via the ITc_ADI interface. Accordingly, you can read and write there without any restrictions. The following is a sample of how to access the Data Area of the Block IO in read-only mode: st Init Temp : ST_Funktionsblock_Simple Temp Ctrl_Tc COM_Init Struct := (n Oid := 16#01010010); Funktionsblock Temp Ctr : Funktionsblock_Simple Temp Ctrl_Tc COM_Init Struct(st Init Temp); st Temp Ctr_Block IO : ST_B_Simple Temp Ctrl_T; p St Temp Ctr_Block IO : POINTER TO ST_B_Simple Temp Ctrl_T; hr : HRESULT; (* read data are via ADI Interface *) // get a pointer to Data Area hr := Funktionsblock Temp Ctr.ip ADI. Get Image Ptr(size := SIZEOF(st Temp Ctr_Block IO), offs := 0, adi_x := 2, pp Data := ADR(p St Temp Ctr_Block IO)); IF hr = 0 THEN // copy data to a local variable MEMCPY(ADR(st Temp Ctr_Block IO), p St Temp Ctr_Block IO, SIZEOF(st Temp Ctr_Block IO)); // always release the pointer! Funktionsblock Temp Ctr.ip ADI. Release Image Ptr(p Data := p St Temp Ctr_Block IO); END_IF; Among other things, adi_x and offs are passed to the Get Image Ptr method. These determine the Data Area itself, in this case Data Area number 2 (Simple Temp Ctrl_B), and the data area in the area to be read/written, in this case without offset and the total size of the Data Area (i.e. the entire Data Area). When writing, the source and destination must be swapped accordingly at MEMCPY in the above sample. For further instructions on how to interact with the Tc COM, refer to Best Practice: access to Tc COM data [} 150]. 4.8.2.3 Using the PLC function block (PLC-FB) The application of the PLC function block (PLC-FB, FB_<modelname>) in the PLC library is focused on its simple application. This is also accompanied by a few restrictions compared to the Tc COM (or the PLC Wrapper FB). Application Create one or more instances of the PLC-FB from the created PLC library. When writing the source code, the Intelli Sense is available so that you can conveniently see the expected inputs and outputs. TE1400 Version: 2.4.1 217

## Page 218

From version 2.x.xxxx.x If bus objects have been used as inputs or outputs in Simulink®, these data types are automatically defined as structures in the PLC library. Restrictions The PLC-FB does not allow access to the model parameters via properties at the function block. However, there are two ways to change the model parameters: • About the External mode [} 221] • When using reusable code [} 195], a Tc COM instance can define the parameters. All instances of the PLC-FB are automatically set to "inherit" and adopt the parameters of the default Tc COM instance. Also, the PLC-FB does not contain a block diagram [} 197] in Twin CAT XAE. Debugging of the function block is done via the Twin CAT C++ Debugger, as described under Debugging [} 218] or via External mode. 4.8.2.3.1 Online Change of the PLC library While Twin CAT is in run mode, you can exchange the PLC library version in Twin CAT XAE and load it into the running application via Online Change. This means that all function blocks in a PLC library can be updated without a Twin CAT restart. Step-by-step procedure: 1. Create a first PLC library version with the Twin CAT Target for Simulink®. 2. Include this PLC library version in a PLC project. 3. Activate your Twin CAT configuration with the first PLC library version (e.g. version 0.0.0.1). 4. Adapt your Simulink® model and create a PLC library version (0.0.0.2) from it. 5. Select the newly created PLC library version in the PLC at References (you may have to install the new library on the XAE system). 6. Select Build > Build Solution to rebuild the project. 7. Select Login > Login with online change (more information in the PLC documentation). 4.8.3 Debugging In addition to debugging via the External Mode [} 221] and via the Block Diagram in Twin CAT XAE [} 201], you can also use the C++ project created for debugging in the classic way. Step-by-step procedure: 1. Make sure that your Twin CAT application has been activated with the C++ debugger enabled. 218 Version: 2.4.1 TE1400

## Page 219

From version 2.x.xxxx.x 2. Open the C++ project created during code generation that belongs to the module you want to debug. The project can be found in the folder <Simulink Model Name>_tcgrt, which is created in the current MATLAB® path when you start the code generation process. 3. In this folder, search for the file <Simulink Model Name>.vcxproj. You can open the <Simulink Model Name>.vcxproj in Visual Studio alone or also add the vcxproj file in your Twin CAT Solution under C++ with "Add existing Item". TE1400 Version: 2.4.1 219

## Page 220

From version 2.x.xxxx.x 4. Select Debug > Attach to Process in the menu bar and select "Twin CAT XAE" as Connection Type and your desired target system under Connection target. Then select Attach. 220 Version: 2.4.1 TE1400

## Page 221

From version 2.x.xxxx.x 5. Set breakpoints in your C++ code and step through your code as usual. Tip: when executing the code, the step function is used, which you can find in the folder Simulink > Sources > <Simulink Model Name>.cpp. 4.8.4 Connecting to External mode You can connect from your Simulink® environment to a running Tc COM object or an instance of the PLC function block in the Twin CAT XAR via External mode. Restriction on code interface packaging The code interface packaging defines the behavior for multiple instances of a created class in Twin CAT [} 195]. If the External mode is to be used, the setting C++ Class is not allowed. TE1400 Version: 2.4.1 221

## Page 222

From version 2.x.xxxx.x Simulation time in Simulink® set to "inf" Set the Simulink® simulation time to "inf". For operation in Twin CAT, it makes no sense to stop the execution of the module after a defined time. ü Code generation settings in Simulink® 1. Under Code Generation > Interface, set the External mode parameter. • Note the following for Code interface packaging: ◦ Nonreusable function: allowed ◦ Reusable function: allowed, set multi-instance code error diagnostic to None ◦ C++ Class: not allowed 2. Define the permissions of the External mode (separately adjustable for Tc COM and Plc Fb). ð Shown in the following screenshot as an example for Tc COM. 222 Version: 2.4.1 TE1400

## Page 223

From version 2.x.xxxx.x ü Connect to a runtime object with the External mode 3. Open the External mode control panel. 4. Select Connect. TE1400 Version: 2.4.1 223

## Page 224

From version 2.x.xxxx.x 5. Select the connected target and object instance. ð After selecting OK, you will be connected to the object. The Connect button on the External mode control panel has changed to Disconnect and you can see the simulation time transferred from the target in Simulink®. As can be seen in the above graphic for selecting the object in a target, the External mode is available for Tc COM instances as well as for PLC-FB instances. Bidirectional ADS route required For the External mode, a bidirectional ADS route is necessary. Unidirectional routes cause a timeout in communication. 4.8.5 Exception handling When processing the C++ code autogenerated from MATLAB® or Simulink® in Twin CAT, floating point exceptions can occur at runtime, for example if an unexpected value is passed into a function during programming. The handling of such exceptions is described below. What is a floating point exception? A floating point exception occurs when an arithmetically not exactly executable operation is instructed in the floating point unit of the CPU. IEEE 754 defines these cases: inexact, underflow, overflow, divide-by-zero, invalid-operation. If one of these cases occurs, a status flag is set, which indicates that the arithmetic operation cannot be executed exactly. It is further defined that each arithmetic operation must return a result – one that in the majority of cases leads to the possibility of ignoring the exception. For example, a division by zero results in +inf or -inf. If a value is divided by inf in the further code, this results in zero, so that no consequential problems are to be expected. However, if inf is multiplied or other arithmetic operations are performed with inf, these are invalid operations, whose result is represented as a Not-a-Number (Na N). 224 Version: 2.4.1 TE1400

## Page 225

From version 2.x.xxxx.x How does the Twin CAT Runtime react in case of exceptions? Twin CAT C++ Debugger not active The following explanations only apply if the C++ debugger is not activated on the Twin CAT runtime system. When the C++ debugger is enabled, exceptions are caught by the debugger and can be handled, see Debugging [} 218]. Default behavior Default setting in Twin CAT is that at "divide-by-zero" and "invalid-operation" the execution of the program is stopped and Twin CAT issues an error message. Task setting: Floating Point Exceptions This default setting can be changed on the level of each Twin CAT task. If the checkbox "Floating Point Exception" is unchecked, an exception does not lead to a Twin CAT stop and no error message is issued. This setting is then valid for all objects that are called by this task. As a consequence, care must be taken in the application that Na N and inf values are handled accordingly in the program code. Check for Na N and Inf If, for example, a Na N is passed on via mapping to a Twin CAT object that has activated floating point exceptions, an arithmetic operation with Na N naturally leads to an exception in this object and subsequently to a Twin CAT stop. Therefore, Na N or inf must be checked directly after mapping. In the PLC, corresponding functions are available in the Tc2_Utilities library, e.g. Lreal Is Na N. Try-Catch statement Another way to handle exceptions is to embed them in a try-catch statement. In the PLC the instructions __TRY, __CATCH, __FINALLY, __ENDTRY are available for this purpose. If floating point exceptions are enabled on the calling task and an exception occurs within the Try-Catch, it is caught in the Catch branch and can be handled. Accordingly, no variables are set to inf or Na N in this approach. However, it is also important to note that the code in the Try branch is run through only up to the point of the exception and then a jump is made to the Catch branch. In the application code, it should be noted that internal states in the Try branch may not be consistent. Dump Files From Twin CAT 3.1.4024.22 (XAR), dump files can be created at runtime in case of exceptions in the Tc COM object. Specification of the behavior in the event of exceptions on object level In addition to the option to influence behavior in the event of exceptions at task level, the behavior can also be specified at Twin CAT object level, i.e. the generated Tc COM or the generated PLC function block (PLC-FB [} 217]). On the object level, a wealth of possibilities can be realized with the Twin CAT Target for Simulink®. Basically, however, all the options presented below are based on the above principles. Definition of the object behavior in case of occurring exceptions A total of 9 different settings are available. • Caller Exceptions (default): Exceptions are triggered as configured at the calling task. • Throw Exceptions: Exceptions in the Twin CAT object are triggered in any case, regardless of how the task is configured. ◦ An exception causes a Twin CAT error message and a Twin CAT stop • Suppress Exceptions: Exceptions are not triggered, regardless of how the task is configured. ◦ An exception does not cause a Twin CAT stop. ◦ Outputs or internal states can be Na N or inf. • Log Exceptions: Exceptions are triggered, but do not lead to a Twin CAT stop. TE1400 Version: 2.4.1 225

## Page 226

From version 2.x.xxxx.x ◦ An exception does not cause a Twin CAT stop. ◦ Outputs or internal states can be Na N or inf. ◦ The Execution Info output is filled with information about an exception in the current cycle. If several exceptions occur in one cycle, only the first exception is displayed at the output. When the Twin CAT object is called again, the information is reset. • Log And Hold: Exceptions are triggered. The execution of the Twin CAT object is stopped. ◦ An exception does not cause a Twin CAT stop. ◦ Outputs or internal states can be Na N or inf. ◦ The Execution Info output is filled with information about an exception in the current cycle. If several exceptions occur in one cycle, only the first exception is displayed at the output. When the Twin CAT object is called again, the information is reset. ◦ The execution of the Twin CAT object is stopped after an exception occurs. Twin CAT itself remains in run mode. Restart execution: Release Object Stop [} 230]. • Log And Catch: Exceptions are caught with try-catch in the Twin CAT object. The execution of the Twin CAT object is stopped. ◦ An exception does not cause a Twin CAT stop. ◦ Outputs or internal states cannot contain Na N or inf. ◦ The Execution Info output is filled with information about an exception in the current cycle. ◦ The execution of the code ends at the point of the exception. From there, the program jumps to the catch junction, i.e. internal states can be inconsistent. ◦ The execution of the Twin CAT object is stopped after an exception occurs. Twin CAT itself remains in run mode. Restart execution: Release Object Stop [} 230]. • Log And Dump, Log Hold And Dump and Log Catch And Dump ◦ Behavior like Log Exceptions ◦ Additionally a dump file is stored on the runtime system in the Twin CAT folder Boot. For more on dump files, see end of chapter. Version recommendation for 64-bit target systems When using the "Log Exceptions", "Log And Hold", "Log And Dump", Log Hold And Dump" settings, it is recommended to use XAR version of at least 3.1.4024.35 and TE1400 version of at least 2.4.2.0. << Setting for Tc COM >> You can define the behavior of a Tc COM object when exceptions occur under TC Tc COM General in the Code Generation Settings in Simulink®. The behavior must be defined separately for the initialization phase of the Tc COM and for the runtime phase (update phase). 226 Version: 2.4.1 TE1400

## Page 227

From version 2.x.xxxx.x If you are working with an already compiled Tc COM in Twin CAT, you can also change the settings on the object instance afterwards. To do this, use the Parameters (init) tab and select Show hidden Parameters. << Setting for PLC-FB >> The settings for the PLC-FB (PLC function block FB_<Model Name> in the PLC library) must be made independently of the settings for the Tc COM object at TC Plc Fb General. A subsequent adaptation of the exception options when using the function block in Twin CAT is not provided. Note that the other PLC function block FB_<Model Name>_Tc COM is a wrapper for a Tc COM object and therefore the exception settings from the Tc COM area are valid when it is used. TE1400 Version: 2.4.1 227

## Page 228

From version 2.x.xxxx.x Optional Execution Info Output If exceptions are handled at object level, it makes sense to make corresponding information about occurred exceptions accessible at the object output. This output can be used to query whether an exception has occurred, what kind of exception it was, whether a dump file has been written, etc. << Setting for Tc COM >> You can activate an additional "Execution Info" output for the Tc COM object via the TC Tc Com Interface entry. 228 Version: 2.4.1 TE1400

## Page 229

From version 2.x.xxxx.x The Execution Info output is a structure with the following entries: Execution Info structure Entry Data type Meaning Cycle Count ULINT Current cycle count (independent of an exception) Exception Count ULINT Number of exceptions that have occurred so far Act Exception Tc Mg Sdk. Exception Info More detailed explanation of the current exception (only first exception in the current cycle) Tc Mg Sdk. Exception Info Entry Data type Meaning Exception Code DINT Exception code Tmx Name STRING(127) Name of the tmx driver that threw the exception. Tmx Version ARRAY[0..3] OF UDINT Version of the tmx driver that threw the exception. Instruction Addr UDINT Relative address in memory; location where the exception occurred. Return Addr ARRAY[0..3] OF UDINT Return addresses TE1400 Version: 2.4.1 229

## Page 230

From version 2.x.xxxx.x Entry Data type Meaning Dump Created BOOLEAN TRUE if a dump file was created for the exception. With the Instruction Addr it is possible to judge if the exception with the given Exception Code always occurs at the same place in the source code. If the Instruction Addr is the same for repeating exceptions, it always occurs at the same point in the code. Via Return Addr you can see where the calls came from that led to the location of the exception. So you can judge if the call that leads to the exception always takes the same call path. If the code is called from outside the Tmx driver, there is a 0 in Return Addr. Exception code Meaning 0x C000008E Divide by zero 0x C000008F Inexact result 0x C0000090 Invalid operation If you use the Tc COM Wrapper FB [} 213], the Execution Info structure is available at the function block. Note that according to the Twin CAT programming conventions the entries carry prefixes corresponding to the data type. << Setting for PLC-FB >> The PLC-FB always contains n Exception Count and st Active Exception as properties according to the above definition. I.e. no checkbox has to be set separately to get these properties. The only parameter that is not available in comparison to the Tc COM is the cycle count, since this can be implemented very easily in the PLC itself if required. Handle execution stop of a Twin CAT object Log And Hold and Log Hold And Dump In the event of an exception, execution of the code in the Tc COM object or PLC function block (PLC-FB) concerned is stopped by setting the Execute parameter to FALSE. << Setting for Tc COM >> The parameter Execute can be read or written from the XAE and via ADS. In the XAE, you can display and change the online values of the Tc COM object under Parameters (Init). 230 Version: 2.4.1 TE1400

## Page 231

From version 2.x.xxxx.x In the block diagram the parameter is offered to you under Module parameters. TE1400 Version: 2.4.1 231

## Page 232

From version 2.x.xxxx.x If you move the mouse over the Execute name in the change dialog, you will be shown the ADS address of the parameter, as with all other parameters. This allows you to set the parameter also by ADS. By right-clicking on the name Execute you can also save the ADS symbol information to the clipboard. This also applies to all other parameters. 232 Version: 2.4.1 TE1400

## Page 233

From version 2.x.xxxx.x If you use the Tc COM Wrapper FB, you can change the Execute parameter by writing to the b Execute property. << Setting for PLC-FB >> The Execute parameter is available on the FB as property b Execute with read and write rights. Use this property to restart the execution of the FB. Log And Catch and Log Catch And Dump In addition to the parameter Execute, the online parameter Initialized also changes to FALSE in the case of Log And Catch and Log Catch And Dump. The module must be reinitialized before the module can perform a calculation again. This is necessary because internal states, due to the termination of code execution at the point of the exception, can be inconsistent. << Setting for Tc COM >> Reinitialization can only be performed by returning the Tc COM object to the "Init" state and moving it to OP again. At runtime, only Tc COM objects that have no mappings can be shut down, otherwise active mappings would block the shutdown. A new initialization is only possible in the case of active mappings on the Tc COM by restarting the entire Twin CAT runtime. It is therefore recommended to use the Tc COM Wrapper FB [} 213]. This can be used to call the Tc COM from the PLC and does not require any mappings to access its inputs and outputs. Accordingly, the Tc COM object can also be reinitialized during runtime. Property settings for the Tc COM Wrapper FB In the following sample code properties, e.g. b Execute, are read. Create the Tc COM Wrapper FB with Tc Com Wrapper FB properties set and with the "Cyclic Udate" option for the properties so that the code below matches the wrapper. PROGRAM MAIN VAR st Init Temp : ST_FB_Simple Temp Ctrl_Tc COM_Init Struct := (n Oid := 16#01010010); fb Temp Ctr : FB_Simple Temp Ctrl_Tc COM_Init Struct(st Init Temp); Inputs : ST_Ext U_Simple Temp Ctrl_T; Outputs : ST_Ext Y_Simple Temp Ctrl_T; Execution Out : ST_Execution Info2; END_VAR // check if Tc COM is in OP mode and all set IF fb Temp Ctr.b Execute = TRUE AND fb Temp Ctr.b Initialized = TRUE AND fb Temp Ctr.n Object State = TCOM_STA TE. TCOM_STATE_OP THEN // call the module fb Temp Ctr(st Simple Temp Ctrl_U := Inputs, st Simple Temp Ctrl_Y => Outputs, st Execution Info => Execut ion Out); // handle exceptions IF Execution Out. Act Exception. Exception Code <> 0 THEN // collect exception information (* ...... *) // reinit Tc COM fb Temp Ctr. Reinit(st Re Init := st Init Temp); END_IF END_IF Note that the Re Init method is executed synchronously, i.e. depending on the cycle time and the time required to reinitialize, cycle overruns may occur. TE1400 Version: 2.4.1 233

## Page 234

From version 2.x.xxxx.x << Setting for PLC-FB >> You can use the property b Initialized on the FB to check whether the stored module is not (no longer) initialized. You have read-only access here. Reinitialization is currently not possible via a method on the FB. The PLC runtime, alternatively the entire Twin CAT runtime, must be restarted. Dump files Writing the dump file may take a few cycles. It is best to use a separate task for the Tc COM object or the PLC-FB in question that does not block any important tasks. Dump files are only written with a Twin CAT XAR version >= 3.1.4024.22, otherwise you get a corresponding warning. In the case of Log And Dump the execution of the code is continued cyclically after the occurrence of an exception, accordingly exceptions can occur cyclically which could lead to persistent cycle timeouts. Therefore, the online value of the parameter Update Exception Handling is set to Log Exceptions after the dump file has been written, i.e. the writing of dump files is deactivated, but can subsequently be switched on again, e.g. by ADS or intervention via the XAE under parameter (Init). The created dump file is stored on the runtime PC in the boot folder and can be copied from there to another PC for analysis. If you use a Twin CAT version lower than 3.1.4024.x you can open the dump files with Win Dbg and start your analysis. 4.8.6 Using Realtime Monitor time stamps MATLAB® commands, such as tic and toc, are popular ways to analyze the performance of code sections in MATLAB®. These commands are not usable in this form during Twin CAT runtime. For this purpose, Twin CAT provides the Twin CAT Realtime Monitor, which evaluates time stamps in the source code and displays them for analysis. Setting Realtime Monitor time stamps is supported in MATLAB® code, i.e. the time stamps are set in MATLAB® and can be evaluated by the Realtime Monitor after code generation and instantiation in Twin CAT. Running time stamps in MATLAB® results in output to the MATLAB® console. Class: Twin CAT. Module Generator. Realtime. Log Mark Methods: Start, Stop and Mark MATLAB® documentation: doc("Twin CAT. Module Generator. Realtime. Log Mark") Example in MATLAB® Twin CAT. Module Generator. Samples. Start("Base Statistics Log Mark") Use of the time stamps is limited to MATLAB® code and requires appropriate embedding in MATLAB® function blocks for use in Simulink®. 4.9 FAQ 4.9.1 Change model parameters at runtime Can I change model parameters during runtime in Twin CAT? Yes, please note the following settings: • Optimization > Default parameter behavior: Tunable If the parameter is set in this way, model parameters can be set at runtime. See also Parameter illustration in XAE [} 190]. 234 Version: 2.4.1 TE1400

## Page 235

From version 2.x.xxxx.x • Interface > Code interface packaging You have the options "Nonreusable function", "Reusable function" and "C++ Class" here. The settings affect whether you can instantiate multiple instances of a Tc COM in Twin CAT and whether you can then also set their model parameters individually or dependent on each other. See also Parameterization of several module instances [} 195]. 4.9.2 Build of a sample fails All samples supplied (list by Twin CAT. Module Generator. Samples. List in the MATLAB® Command Window) have been checked by tests at Beckhoff Automation. If a build of a sample still does not run successfully, it is likely that something needs to be adjusted during setup on your engineering PC. ü To test the platform toolset without the influence of MATLAB® please create a Twin CAT Versioned C++ project in Twin CAT (open Twin CAT in Visual Studio) . 1. Right-click Add New Item on C++ Tree Item. 2. Then select Twin CAT Module Class with Cyclic Caller. ð A C++ project appears in the Twin CAT Tree under C++. 3. Build the C++ project and view the Output Window in Twin CAT. ð The output window should return "1 succeeded" for the build process. If this is not the case, check whether you have installed the Desktop development with C++ option in Visual Studio. 4.9.3 Problems with the block diagram representation in Twin CAT XAE Tc COM modules created with the Twin CAT Target for Simulink® version 2.x.xxxx.x and higher require a TC3 Block Diagram version 1.4.1419.0 and higher for correct display in Twin CAT XAE. Where can I find the version of the TC3 Block Diagram? • Under Programs and Features in the Control Panel > Beckhoff Twin CAT 3 Block Diagram. • In the block diagram in Twin CAT XAE > right-click in the window > About TC3 Block Diagram. If your Twin CAT XAE installation contains an earlier version of the TC3 Block Diagram: • Can you install the Twin CAT Tools for MATLAB and Simulink setup. This includes a new TC3 Block Diagram version. • You can contact Beckhoff support to request a separate TC3 Block Diagram setup. TE1400 Version: 2.4.1 235

## Page 236

From version 2.x.xxxx.x 4.9.4 Can I use TE1400 version 1.2.x and version 2.x at the same time? Yes, this is possible. Simply install both products on your system and select the appropriate target to differentiate between the two versions. Twin Cat Grt.tlc for version 2.x and Twin CAT.tlc for 1.2.x 4.9.5 What is the difference between "Build" and "Generate code"? In the Simulink Coder TM App, you can choose between "Build" and "Generate Code": If you have set Twin Cat Grt.tlc as target, both options have the same function, because the Twin Cat Grt.tlc does not run through the makefile of Math Works®. If you do not want to run the build process, but only generate the C++ code, uncheck the checkbox Run the publish step after project generation under TC Build. What is the difference between "Build" and "Publish"? "Publish" refers to the successive execution of the build process for specific Twin CAT platforms. From Simulink®, the corresponding binaries are then created one after the other for the platforms activated under TC Build, so that it can be decided afterwards for which target platform the compiled functions are to be used. 4.9.6 I can't change the parameters of a module in Twin CAT "Inlined" is set in the Twin Car Grt.tlc as the default value for the parameter Default parameter behavior. Change this to "Tunable" or configure which parameters should be marked as "Tunable" via the button configure.. 4.9.7 Mapping is lost with Reload TMI/TMC Challenge: You have already Tc COM objects in your Twin CAT solution, which you have created with the Target for Simulink® version 1.2.xxxx.x. You now want to create a new Tc COM object with the Target for Simulink® version 2.x.x.x and replace the newly created Tc COM with Reload TMI/TMC File... in your existing Twin CAT solution. In the default settings, you lose the mapping information by doing this. Solution: Under TC Tc COM Interface, set the "mapping between variable names and ADS symbol names" to "Classic" and use this to create the new Tc COM object. 236 Version: 2.4.1 TE1400

## Page 237

From version 2.x.xxxx.x This means that the mapping is retained if you now replace your old Tc COM object in Twin CAT with Reload TMI/TMC File.... 4.9.8 Integrating the block diagram controls in . NET The option displaying the block diagram in the Twin CAT XAE environment can also be integrated in separate visualizations. A sample program can be downloaded here: https://infosys.beckhoff.com/content/1033/ te1400_tc3_target_Matlab/Resources/11697311755.zip ü The following steps are required: 1. Create a new Windows Forms application. 2. Add Twin CAT. Block Diagram.dll to the toolbox. TE1400 Version: 2.4.1 237

## Page 238

From version 2.x.xxxx.x 3. To do this, select the Choose Items... entry in the context menu. 4. Navigate to Twin CAT. Blockdiagram.dll, which can be found under <Twin CAT installation path>\3.1\Components\Tc Block Diagram. 238 Version: 2.4.1 TE1400

## Page 239

From version 2.x.xxxx.x 5. Add a Tc Blockdiagram control instance to the Windows Forms object using drag and drop (Block Diagram Browser or Block Diagram Tc Com Objectbrowser). 4.9.9 Observable signals in the Twin CAT block diagram Which settings influence the number of "blue signals" in the Twin CAT block diagram? Basically the Twin CAT Target for Simulink® needs a variable in the C/C++ code, which can be assigned to the signal in the block diagram. If a signal in the block diagram is not marked in blue, it means that either no variable exists (because it was dropped during code generation due to optimization of the code) or the variable could not be assigned. To suppress omission of variables by code optimization, you can use Test Points in Simulink®: see Configure Signals as Test Points in the Simulink® documentation. At TC Tc Com Additional settings you can also set the entry Extended resolution of signals in block diagram. If this entry is active, an intensified search for assignments of variables and signals is performed. Note that this search takes time, so exporting the block diagram will take longer. TE1400 Version: 2.4.1 239

## Page 240

From version 2.x.xxxx.x 4.9.10 Using Simulink® Strings Simulink® strings are explicitly allowed and can be used with the Twin CAT Target for Simulink®. Restriction Depending on the MATLAB® release version, code interface packaging setting and the set C/C++ standard, Simulink® Coder™ compiles a Simulink® string into the std::string data type. If this Simulink® string is used as model input or model output, it should be noted that these entries cannot always be connected to other objects in Twin CAT by mapping. Mapping in Twin CAT assumes a static data type size, which is not the case with std::string. Detailed sample in MATLAB® The topics for Twin CAT Build 4024 and 4026 are described in detail in this sample: Twin CAT. Module Generator. Samples. Start('Using Simulink Strings') Handling with Twin CAT 3.1 Build 4026 The Twin CAT SDK for Twin CAT Builds >=4026 allows the use of a std::string implementation. This means that strings can also be implemented in mapping. This option has two restrictions: • The std::string elements used as local variables in the functions generated by Simulink® Coder™ can increase the required stack size because the std::string data is on the stack. • The maximum string size at compile time is limited to a value selected by the user. For example, if the generated code concatenates two strings that exceed the size, an exception occurs. Please design your model accordingly and validate it, for example by code checking, to ensure that this does not happen. Use the following settings to successfully build the Simulink® model: set_param(model Name,'Tc Project_Cpp Language Standard','stdcpp20'); set_param(model Name,'Tc Project_Use Static Stl String','on'); The size of the underlying character array is set to 256 by default, as configured by the Simulink® parameter Dynamic String Buffer Size. 240 Version: 2.4.1 TE1400

## Page 241

From version 2.x.xxxx.x If desired, the size of the underlying character array can be set independently of the Simulink® parameter Dynamic String Buffer Size via the project parameter Static Stl String Capacity: set_param(model Name,'Tc Project_Static Stl String Capacity','255'); For the Tc COM data areas, the corresponding Twin CAT type for each std::string is a structure type with a data member and a size member. If a string value is set, both the data member and the size member must be set. The size is the length of the character array that will be set to the data value and can be between 0 and the value of Static Stl String Capacity. Selecting a value greater than Static Stl String Capacity results in undefined behavior. The usability of the PLC-FB is similar to the Tc COM module, where std::string is a structure with a size member and a data member. Writing a string value requires both the size member and the data member to be set, while reading a string value may require the user to truncate the string read from the data element to the appropriate size. Handling with Twin CAT 3.1 Build 4024 So that you can still use the inputs and outputs, it is recommended that the PLC-FB (no mappings necessary) or the Tc COM Wrapper FB are used. For the standard inputs and outputs of the FBs, the Simulink® string entries are not displayed in either case. These are to be set separately via getter and setter methods on the FB. Simulink® bus with Simulink® strings: restricted use The following situation is currently not supported: a Simulink® string cannot be used in a Simulink® bus that serves as input or output of the model if it is mapped as std::string by Simulink® Coder™. Sample Let's take the following Simulink® model with a mixture of string and non-string inputs and outputs. TE1400 Version: 2.4.1 241

## Page 242

From version 2.x.xxxx.x When this model is compiled with MATLAB® R2022a and “C++ Class” code interface packaging, the data type std::string is generated by Simulink® Coder™. In the following figure, it can be seen that the string inputs and outputs are not present in the process image in Twin CAT. Only the non-string inputs and outputs are present in the process image. To be able to write and read the strings, either the Tc COM Wrapper FB or the PLC FB must be used. Corresponding getter and setter methods are automatically created at the function blocks. Sample code using the PLC-FB: VAR fb String Sample : FB_string_sample; my String In : T_Max String; my String Out1 : T_Max String; my String Out2 : T_Max String; n Size : ULINT; n Size2: ULINT; f In : LREAL; f Out : LREAL; END_VAR // put string input fb String Sample.put_String Input(c_str := ADR(my String In)); // call function fb String Sample(f Non String Input := f In, f Non String Out3 => f Out); 242 Version: 2.4.1 TE1400

## Page 243

From version 2.x.xxxx.x // get string outputs n Size := SIZEOF(my String Out1); fb String Sample.get_String Out1(c_str := ADR(my String Out1), size := n Size); // size in VAR IN OUT! n Size2 := SIZEOF(my String Out2); fb String Sample.get_String Out2(c_str := ADR(my String Out2), size := n Size2); 4.9.11 Are there limitations with regard to executing modules in real- time? Not all access operations that are possible in Simulink® under non-real-time conditions can be performed in the Twin CAT real-time environment. Known limitations are described below: • Direct file access:: No direct access to the file system of the IPC can be realized from the Twin CAT runtime. For writing .mat files please use the Twin CAT File Writer block instead of the To File block of Simulink®. • Direct hardware access: Direct access to devices/interfaces requires a corresponding driver, e.g. RS232, USB, network card, ... It is not possible to access the device drivers of the operating system from the real-time context. At present it is therefore not easily possible to establish an RS232 communication for non-real-time operation with the Instrument Controller Toolbox™ and then use this directly in the Twin CAT runtime. However, Twin CAT offers a wide range of communication options for linking external devices, see Twin CAT 3 Connectivity TF6xxx. • Access to the operating system API: The API of the operating system cannot be used directly from the Twin CAT runtime. An example is the integration of windows.h in C/C++ code. This is integrated by the Simulink Coder™ if the FFTW implementation of the FFT block from the DSP Systems Toolbox™ is used (but not with the Radix 2 implementation), for example. • Precompiled libraries: It is possible that during code generation by the Simulink Coder™ no platform- independent C/C++ code is generated, but precompiled libraries are included. In these cases, no real- time execution in Twin CAT is possible. 4.9.12 Message: Failed to copy repository After activating the Twin CAT Configuration the following error message appears in Twin CAT XAE? Failed to copy repository file ... The cause is usually that no or not all files, especially the TMX drivers, were found in your engineering repository. The Twin CAT XAE tries to copy the driver to the XAR system but does not find the correct file (check if you have a driver for the target platform of the selected XAR system in the engineering repository). Consequential error in the Error dialog in XAE is for example: 'TCOM Server' (10): Error loading repository driver 'C:\Twin CAT\3.1\Boot\Repository\<model vendor>\<model name>\<version>\<tmx-name>' - hr = 0xc0000225 Since the TMX file could not be copied to the XAR system, it could not be loaded. Another consequential error is a link error "Could not link external function". ü Information and remedy for this error pattern: 1. What is the Engineering Repository and where can I find it? ð See automatically created files [} 118]. TE1400 Version: 2.4.1 243

## Page 244

From version 2.x.xxxx.x 2. How do I ensure that when copying compiled models to other XAE systems, all necessary files are always transferred and the folder structure remains correct? ð See TMX archive [} 136]. 4.9.13 Data Exchange modules cannot be loaded Error image when activating a configuration with objects generated from Simulink®: Error loading repository driver ... Tc Data Exchange Modules ... Solution: In some cases it is necessary to install the so-called Data Exchange modules on the engineering PC, so that you can use Twin CAT objects created on another system. These cases are: • The created module was created with the “External Mode” option. • The created module uses the Twin CAT File Writer [} 113] or MAT file logging. • The created module contains function blocks from TE1410 Twin CAT Interface for MATLAB®/Simulink®. In all other cases the created Twin CAT objects have no dependency to the Data Exchange modules. Installation of the Data Exchange modules Twin CAT 3.1 Build 4026 tcpkg install Twin CAT. XAE. TMX. Data Exchange Twin CAT 3.1. Build 4024 The Data Exchange-Modules Setup is copied to the following folder with the Twin CAT Tools for MATLAB® and Simulink® Setup, so that the employee who has installed the TE14xx-Tools For Matlab And Simulink Setup can distribute the Data Exchange modules setup to the colleagues concerned. <Twin CATInstall Dir>\Twin CAT\Functions\TE14xx- Tools For Matlab And Simulink\TE140x\SDK 4.10 Samples Samples provided by Beckhoff Automation are installed on your system with the setup. You can use the following command to display all available samples: Twin CAT. Module Generator. Samples. List 244 Version: 2.4.1 TE1400

## Page 245

From version 2.x.xxxx.x You can access the samples by clicking on the blue start link. To do this, the sample code is copied to your user directory so that you do not change the original sample. You can work with the copy of the sample accordingly and try it out. Also available for displaying and starting individual samples: Twin CAT. Module Generator. Samples. Show(Sample Name) Twin CAT. Module Generator. Samples. Start(Sample Name) The argument Sample Name is to be passed as a string, e.g.: Twin CAT. Module Generator. Samples. Start("Generate Twin CAT Classes From Simulink Models") 4.10.1 Integrating the block diagram controls The control that displays the block diagram in the Twin CAT XAE environment can also be integrated as a control in your own visualizations. The following steps are required: 1. Create a new Windows Forms application. 2. Add Twin CAT. Block Diagram.dll to the toolbox: TE1400 Version: 2.4.1 245

## Page 246

From version 2.x.xxxx.x 3. To do this, select the "Choose Items..." entry in the context menu. 4. Navigate to Twin CAT. Blockdiagram.dll, which can be found under <Twin CAT installation path>\3.1\Components\Tc Block Diagram. 246 Version: 2.4.1 TE1400

## Page 247

From version 2.x.xxxx.x 5. Add a Tc Blockdiagram control instance to the Windows Forms object using drag and drop. 4.10.2 Try out created Twin CAT objects yourself ü You don't have MATLAB® or simply want to try out compiled Twin CAT objects with the Twin CAT Target for Simulink®? Then follow the description below. 1. Twin CATTemperature Controller (ZIP): Build 4024: https://infosys.beckhoff.com/content/1033/te1400_tc3_target_Matlab/Resources/ 14632780043.zip Build 4026: https://infosys.beckhoff.com/content/1033/te1400_tc3_target_Matlab/Resources/ 19741004939.zip 2. Unzip the ZIP and execute the tmx archive. ð The zip contains two tmx-archive [} 136] as executables. 3. Execute these. ð This unpacks the Twin CAT objects into the correct Twin CAT path (Engineering Repository). 4. Open XAE and create instances. ð You can now create new Tc COM objects in Twin CAT 3. You can find the two objects under “TE140x Module Vendor” – TE140x – Simulink Modules. 5. Create the instances and assign a Twin CAT task. 6. Activate the configuration. 7. Include the certificate used for signing in the trust list of the target. ð The target system must load the tmx files used. These bear a signature, created with an OEM certificate. The OEM certificate used is probably not yet on the target system in the whitelist. 8. Add the certificate to the whitelist accordingly. 9. Activate the configuration. ð After activating the configuration, you can observe the behavior of the objects and change parameters in the block diagram [} 197]. TE1400 Version: 2.4.1 247

## Page 248

From version 2.x.xxxx.x Necessary installation on your engineering system: Twin CAT 3.1 Build 4026 Workloads • Twin CAT Standard • Twin CAT Block Diagram Classic Twin CAT 3.1 Build 4024 • Twin CAT 3 XAE Setup 248 Version: 2.4.1 TE1400

## Page 249

Support and Service 5 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com TE1400 Version: 2.4.1 249

## Page 250

Trademark statements Beckhoff®, ATRO®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, MX-System®, Safety over Ether CAT®, TC/BSD®, Twin CAT®, Twin CAT/BSD®, Twin SAFE®, XFC®, XPlanar® and XTS® are registered and licensed trademarks of Beckhoff Automation Gmb H. Third-party trademark statements AMD is a trademark of Advanced Micro Devices, Inc. Arm, Arm9 and Cortex are trademarks or registered trademarks of Arm Limited (or its subsidiaries or affiliates) in the US and/or elsewhere. DSP System Toolbox, Embedded Coder, MATLAB, MATLAB Coder, MATLAB Compiler, Math Works, Predictive Maintenance Toolbox, Simscape, Simscape™ Multibody™, Simulink, Simulink Coder, Stateflow and Thing Speak are registered trademarks of The Math Works, Inc. Intel, the Intel logo, Intel Core, Xeon, Intel Atom, Celeron and Pentium are trademarks of Intel Corporation or its subsidiaries. The registered trademark Linux® is used pursuant to a sublicense from the Linux Foundation, the exclusive licensee of Linus Torvalds, owner of the mark on a worldwide basis. Microsoft, Microsoft Azure, Microsoft Edge, Power Shell, Visual Studio, Windows and Xbox are trademarks of the Microsoft group of companies.

## Page 251

More Information: www.beckhoff.com/te1400 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
