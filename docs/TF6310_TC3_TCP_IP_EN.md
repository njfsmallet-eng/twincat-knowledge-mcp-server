---
title: "TF6310 Twin CAT 3"
product: "TF6310"
category: "Communication"
tags: ["CAT", "TWIN"]
language: "EN"
document_type: "Manual"
version: "1.5.1"
source_pdf: "https://download.beckhoff.com/download/Document/automation/twincat3/TF6310_TC3_TCP_IP_EN.pdf"
release_date: "2025-05-21"
---
Manual | EN TF6310 Twin CAT 3 | TCP/IP 2025-05-21 | Version: 1.5.1
## Page 3

Table of contents Table of contents 1 Foreword.................................................................................................................................................... 5 1.1 Notes on the documentation............................................................................................................. 5 1.2 For your safety.................................................................................................................................. 5 1.3 Notes on information security............................................................................................................ 7 1.4 Documentation issue status.............................................................................................................. 7 2 Overview.................................................................................................................................................... 8 2.1 Comparison TF6310 TF6311............................................................................................................ 8 3 Installation................................................................................................................................................. 9 3.1 System requirements........................................................................................................................ 9 3.2 Installation......................................................................................................................................... 9 3.3 Installation from Twin CAT 4026...................................................................................................... 12 3.4 Installation Windows CE................................................................................................................. 13 3.5 Licensing......................................................................................................................................... 14 3.6 Migration from Twin CAT 2.............................................................................................................. 16 4 Technical introduction............................................................................................................................ 19 4.1 Quick Start...................................................................................................................................... 19 4.2 Protocols......................................................................................................................................... 20 5 PLC API.................................................................................................................................................... 23 5.1 Function blocks............................................................................................................................... 23 5.1.1 FB_Socket Connect.......................................................................................................... 23 5.1.2 FB_Socket Close.............................................................................................................. 24 5.1.3 FB_Socket Close All.......................................................................................................... 25 5.1.4 FB_Socket Listen.............................................................................................................. 26 5.1.5 FB_Socket Accept............................................................................................................. 27 5.1.6 FB_Socket Send............................................................................................................... 28 5.1.7 FB_Socket Receive........................................................................................................... 30 5.1.8 FB_Socket Udp Create...................................................................................................... 31 5.1.9 FB_Socket Udp Send To.................................................................................................... 32 5.1.10 FB_Socket Udp Receive From............................................................................................ 34 5.1.11 FB_Socket Udp Add Multicast Address............................................................................... 36 5.1.12 FB_Socket Udp Drop Multicast Address.............................................................................. 37 5.1.13 FB_Tls Socket Connect..................................................................................................... 38 5.1.14 FB_Tls Socket Listen......................................................................................................... 40 5.1.15 FB_Tls Socket Create........................................................................................................ 41 5.1.16 FB_Tls Socket Add Ca........................................................................................................ 42 5.1.17 FB_Tls Socket Add Crl........................................................................................................ 43 5.1.18 FB_Tls Socket Set Cert....................................................................................................... 44 5.1.19 FB_Tls Socket Set Psk....................................................................................................... 45 5.1.20 Helper............................................................................................................................... 46 5.2 Functions......................................................................................................................................... 53 5.2.1 F_Create Server Hnd......................................................................................................... 53 5.2.2 HSOCKET_TO_STRING................................................................................................. 54 5.2.3 HSOCKET_TO_STRINGEX............................................................................................ 55 TF6310 Version: 1.5.1 3
## Page 4

Table of contents 5.2.4 SOCKETADDR_TO_STRING.......................................................................................... 56 5.3 Data types....................................................................................................................................... 56 5.3.1 E_Socket Accept Mode...................................................................................................... 56 5.3.2 E_Socket Connection State............................................................................................... 57 5.3.3 E_Socket Connectionless State......................................................................................... 57 5.3.4 E_Winsock Error............................................................................................................... 58 5.3.5 ST_Sock Addr................................................................................................................... 59 5.3.6 ST_Tls Connect Flags........................................................................................................ 60 5.3.7 ST_Tls Listen Flags........................................................................................................... 60 5.3.8 T_HSERVER.................................................................................................................... 61 5.3.9 T_HSOCKET.................................................................................................................... 61 5.4 Global constants............................................................................................................................. 62 5.4.1 Library version.................................................................................................................. 62 5.4.2 Parameter list................................................................................................................... 63 6 Samples................................................................................................................................................... 64 6.1 TCP................................................................................................................................................. 65 6.1.1 Sample01: "Echo" client/server (basic function blocks)................................................... 65 6.1.2 Sample02: “Echo“ client /server....................................................................................... 84 6.1.3 Sample03: “Echo” client/server........................................................................................ 85 6.1.4 Sample04: Binary data exchange.................................................................................... 87 6.1.5 Sample05: Binary data exchange.................................................................................... 89 6.1.6 Sample06: "Echo" client/server with TLS (basic modules).............................................. 90 6.1.7 Sample07: "Echo" client/server with TLS-PSK (basic modules)...................................... 91 6.2 UDP................................................................................................................................................. 91 6.2.1 Sample01: Peer-to-peer communication.......................................................................... 91 6.2.2 Sample02: Multicast......................................................................................................... 99 7 Appendix................................................................................................................................................ 100 7.1 OSI model..................................................................................................................................... 100 7.2 Keep Alive configuration................................................................................................................ 100 7.3 Error codes.................................................................................................................................... 101 7.3.1 Overview of the error codes........................................................................................... 101 7.3.2 Internal error codes of the Twin CAT TCP/IP Connection Server................................... 102 7.3.3 Troubleshooting/diagnostics.......................................................................................... 104 7.3.4 ADS Return Codes......................................................................................................... 104 7.4 Support and Service...................................................................................................................... 108 4 Version: 1.5.1 TF6310
## Page 5

Foreword 1 Foreword 1.1 Notes on the documentation This description is intended exclusively for trained specialists in control and automation technology who are familiar with the applicable national standards. The documentation and the following notes and explanations must be complied with when installing and commissioning the components. The trained specialists must always use the current valid documentation. The trained specialists must ensure that the application and use of the products described is in line with all safety requirements, including all relevant laws, regulations, guidelines, and standards. Disclaimer The documentation has been compiled with care. The products described are, however, constantly under development. We reserve the right to revise and change the documentation at any time and without notice. Claims to modify products that have already been supplied may not be made on the basis of the data, diagrams, and descriptions in this documentation. Trademarks Beckhoff®, ATRO® , Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, MX-System®, Safety over Ether CAT®, TC/BSD®, Twin CAT®, Twin CAT/BSD®, Twin SAFE®, XFC®, XPlanar®, and XTS® are registered and licensed trademarks of Beckhoff Automation Gmb H. If third parties make use of the designations or trademarks contained in this publication for their own purposes, this could infringe upon the rights of the owners of the said designations. Ether CAT® is a registered trademark and patented technology, licensed by Beckhoff Automation Gmb H, Germany. Copyright © Beckhoff Automation Gmb H & Co. KG, Germany. The distribution and reproduction of this document, as well as the use and communication of its contents without express authorization, are prohibited. Offenders will be held liable for the payment of damages. All rights reserved in the event that a patent, utility model, or design are registered. Third-party trademarks Trademarks of third parties may be used in this documentation. You can find the trademark notices here: https://www.beckhoff.com/trademarks. 1.2 For your safety Safety regulations Read the following explanations for your safety. Always observe and follow product-specific safety instructions, which you may find at the appropriate places in this document. Exclusion of liability All the components are supplied in particular hardware and software configurations which are appropriate for the application. Modifications to hardware or software configurations other than those described in the documentation are not permitted, and nullify the liability of Beckhoff Automation Gmb H & Co. KG. TF6310 Version: 1.5.1 5
## Page 6

Foreword Personnel qualification This description is only intended for trained specialists in control, automation, and drive technology who are familiar with the applicable national standards. Signal words The signal words used in the documentation are classified below. In order to prevent injury and damage to persons and property, read and follow the safety and warning notices. Personal injury warnings DANGER Hazard with high risk of death or serious injury. WARNING Hazard with medium risk of death or serious injury. CAUTION There is a low-risk hazard that could result in medium or minor injury. Warning of damage to property or environment NOTICE The environment, equipment, or data may be damaged. Information on handling the product This information includes, for example: recommendations for action, assistance or further information on the product. 6 Version: 1.5.1 TF6310
## Page 7

Foreword 1.3 Notes on information security The products of Beckhoff Automation Gmb H & Co. KG (Beckhoff), insofar as they can be accessed online, are equipped with security functions that support the secure operation of plants, systems, machines and networks. Despite the security functions, the creation, implementation and constant updating of a holistic security concept for the operation are necessary to protect the respective plant, system, machine and networks against cyber threats. The products sold by Beckhoff are only part of the overall security concept. The customer is responsible for preventing unauthorized access by third parties to its equipment, systems, machines and networks. The latter should be connected to the corporate network or the Internet only if appropriate protective measures have been set up. In addition, the recommendations from Beckhoff regarding appropriate protective measures should be observed. Further information regarding information security and industrial security can be found in our https://www.beckhoff.com/secguide. Beckhoff products and solutions undergo continuous further development. This also applies to security functions. In light of this continuous further development, Beckhoff expressly recommends that the products are kept up to date at all times and that updates are installed for the products once they have been made available. Using outdated or unsupported product versions can increase the risk of cyber threats. To stay informed about information security for Beckhoff products, subscribe to the RSS feed at https:// www.beckhoff.com/secinfo. 1.4 Documentation issue status Version Change 1.5.x New: Technical introduction/Quick Start Technical introduction/protocols TF6310 Version: 1.5.1 7
## Page 8

Overview 2 Overview The Twin CAT TCP/IP Connection Server enables the implementation of one or several TCP/IP servers/ clients in the Twin CAT PLC. This gives a PLC programmer the possibility to develop own network protocols of the application layer (OSI model) directly in a PLC program. The communication connection can optionally be secured via TLS. Product components The product TF6310 TCP/IP consists of the following components, which will be delivered by the setup: • PLC library: Tc2_Tcp Ip library (implements basic TCP/IP and UDP/IP functionalities). • Background program: Twin CAT TCP/IP Connection Server (process which is used for communication). 2.1 Comparison TF6310 TF6311 The products TF6310 "TCP/IP" and TF6311 "TCP/UDP Realtime" offer similar functionality. This page provides an overview of similarities and differences of the products: TF 6310 TF 6311 Twin CAT Twin CAT 2 / 3 Twin CAT 3 Client/Server Both Both Large / unknown networks ++ + Determinism + ++ High-volume data transfer ++ + Programming languages PLC PLC and C++ Operating system Win32/64, CE5/6/7 Win32/64, CE7 UDP-Mutlicast Yes No Trial license Yes Yes Protocols TCP, UDP TCP, UDP, Arp/Ping Hardware requirements Variable Twin CAT-compatible network card Socket configuration See operating system (Win Sock) TCP/UDP RT Tc Com Parameters The Windows firewall cannot be used, since the TF6311 is directly integrated in the Twin CAT system. In larger / unknown networks we recommend using the TF6310. 8 Version: 1.5.1 TF6310
## Page 9

Installation 3 Installation 3.1 System requirements The following system requirements must be met for the function TF6310 TCP/IP to work properly. Technical data Description Operating system Windows 10, 11 Windows CE 6/7 Windows Embedded Standard 2009 Twin CAT/BSD Target platforms PC architecture (x86, x64, Arm®) Twin CAT Version Twin CAT 2, Twin CAT 3 Twin CAT installation level Twin CAT 2 CP, PLC, NC-PTP Twin CAT 3 XAE, XAR, ADS Required Twin CAT license TS6310 (for Twin CAT 2) TF6310 (for Twin CAT 3) Support of TLS Please note that the TLS function blocks are not available under Windows CE. 3.2 Installation Setup installation (Twin CAT 3.1 Build 4024) The following section describes how to install the Twin CAT 3 function for Windows-based operating systems. ü The Twin CAT 3 function setup file was downloaded from the Beckhoff website. 1. Run the setup file as administrator. To do this, select the Run As Admin command in the context menu of the file. ð The installation dialog opens. TF6310 Version: 1.5.1 9
## Page 10

Installation 2. Accept the end user licensing agreement and click Next. 3. Enter your user data. 10 Version: 1.5.1 TF6310
## Page 11

Installation 4. If you want to install the full version of the Twin CAT 3 function, select Complete as the installation type. If you want to install the Twin CAT 3 function components separately, select Custom. 5. Click Next, then Install to start the installation. ð A dialog box informs you that the Twin CAT system must be stopped to proceed with the installation. TF6310 Version: 1.5.1 11
## Page 12

Installation 6. Confirm the dialog with Yes. 7. Click Finish to exit the setup. ð The Twin CAT 3 function has been installed successfully. 3.3 Installation from Twin CAT 4026 Twin CAT Package Manager If you are using Twin CAT 3.1 Build 4026 (and higher) on the Microsoft Windows operating system, you can install this function via the Twin CAT Package Manager, see installation documentation. Normally you install the function via the corresponding workload; however, you can also install the packages contained in the workload individually. This documentation briefly describes the installation process via the workload. Command line program Tc Pkg You can use the Tc Pkg Command Line Interface (CLI) to display the available workloads on the system: tcpkg list TF6310 You can use the following command to install the workload of the TF6770 Io T Websockets function. tcpkg install TF6310. Tcp Ip. XAE tcpkg install TF6310. Tcp Ip. XAR Twin CAT Package Manager UI 12 Version: 1.5.1 TF6310
## Page 13

Installation You can use the User Interface (UI) to display all available workloads and install them if required. To do this, follow the corresponding instructions in the interface. 3.4 Installation Windows CE This section describes, how you can install the Twin CAT 3 Function TF6310 TCP/IP on a Beckhoff Embedded PC Controller based on Windows CE. The setup process consists of four steps: • Download of the setup file [} 13] • Installation on a host computer [} 13] • Transferring the executable to the Windows CE device [} 13] • Software installation [} 14] The last paragraph of this section describes the Software upgrade [} 14]. Download of the setup file The CAB installation files for Windows CE are part of the TF6310 TCP/IP setup. Therefore you only need to download one setup file from www.beckhoff.com which contains binaries for Windows XP, Windows 7 and Windows CE (x86 and Arm®). The installation procedure of the TF6310 TCP/IP setup is described in the regular installation article (see Installation [} 9]). Installation on a host computer After installation, the install folder contains three directories - each one for a different hardware platform: • CE-Arm®: Arm®-based Embedded Controllers running Windows CE, e.g. CX8090, CX9020 • CE-X86: X86-based Embedded Controllers running Windows CE, e.g. CX50xx. CX20x0 • Win32: Embedded Controllers running Windows XP, Windows 7 or Windows Embedded Standard The CE-Arm® and CE-X86 folders contain the TF6310 CAB files for Windows CE corresponding to the hardware platform of your Windows CE device. This file needs to be transferred to the Windows CE device. Transferring the executable to the Windows CE device Transfer the corresponding executable to you Windows CE device. This can be done via one of the following ways: • via a Shared Folder • via the integrated FTP-Server • via Active Sync TF6310 Version: 1.5.1 13
## Page 14

Installation • via a CF card For more information, please consult the "Windows CE" section in the Beckhoff Information System. Software installation After the file has been transferred via one of the above methods, execute the file and acknowledge the following dialog with Ok. Restart your Windows CE device after the installation has finished. After the restart has been completed, the executable files of TF6310 are started automatically in the background. The software is installed in the following directory on the CE device: \Hard Disk\Twin CAT\Functions\TF6310-TCP-IP Upgrade instructions If you have already a version of TF6310 installed on your Windows CE device, you need to perform the following things on the Windows CE device to upgrade to a newer version: 1. Open the CE Explorer by clicking on Start > Run and entering "explorer". 2. Navigate to \Hard Disk\Twin CAT\Functions\TF6310-TCP-IP\Server. 3. Rename Tcp Ip Server.exe to Tcp Ip Server.old. 4. Restart the Windows CE device. 5. Transfer the new CAB-File to the CE device. 6. Execute the CAB-File and install the new version. 7. Delete Tcp Ip Server.old. 8. Restart the Windows CE device. ð After the restart is complete, the new version is active. 3.5 Licensing The Twin CAT 3 function can be activated as a full version or as a 7-day test version. Both license types can be activated via the Twin CAT 3 development environment (XAE). Licensing the full version of a Twin CAT 3 Function A description of the procedure to license a full version can be found in the Beckhoff Information System in the documentation "Twin CAT 3 Licensing". Licensing the 7-day test version of a Twin CAT 3 Function A 7-day test version cannot be enabled for a Twin CAT 3 license dongle. 1. Start the Twin CAT 3 development environment (XAE). 2. Open an existing Twin CAT 3 project or create a new project. 3. If you want to activate the license for a remote device, set the desired target system. To do this, select the target system from the Choose Target System drop-down list in the toolbar. ð The licensing settings always refer to the selected target system. When the project is activated on the target system, the corresponding Twin CAT 3 licenses are automatically copied to this system. 14 Version: 1.5.1 TF6310
## Page 15

Installation 4. In the Solution Explorer, double-click License in the SYSTEM subtree. ð The Twin CAT 3 license manager opens. 5. Open the Manage Licenses tab. In the Add License column, check the check box for the license you want to add to your project (e.g. "TF4100 TC3 Controller Toolbox"). 6. Open the Order Information (Runtime) tab. ð In the tabular overview of licenses, the previously selected license is displayed with the status “missing”. TF6310 Version: 1.5.1 15
## Page 16

Installation 7. Click 7-Day Trial License... to activate the 7-day trial license. ð A dialog box opens, prompting you to enter the security code displayed in the dialog. 8. Enter the code exactly as it is displayed and confirm the entry. 9. Confirm the subsequent dialog, which indicates the successful activation. ð In the tabular overview of licenses, the license status now indicates the expiry date of the license. 10. Restart the Twin CAT system. ð The 7-day trial version is enabled. 3.6 Migration from Twin CAT 2 If you would like to migrate an existing Twin CAT 2 PLC project which uses one of the TCP/IP Server's PLC libraries, you need to perform some manual steps to ensure that the Twin CAT 3 PLC converter can process the Twin CAT 2 project file (*.pro). In Twin CAT 2, the Function TCP/IP Server is delivered with three PLC libraries: • Tcp Ip.lib • Tc Socket Helper.lib • Tc Snmp.lib By default, these library files are installed in C:\Twin CAT\Plc\Lib\. Depending on the library used in your PLC project, you need to copy the corresponding library file to C:\Twin CAT3\Components\Plc\Converter\Lib and then perform the following steps: 1. Open the Twin CAT Engineering. 2. Create a new Twin CAT 3 solution. 16 Version: 1.5.1 TF6310
## Page 17

Installation 3. Right-click on the "PLC" node and select Add Existing Item in the context menu that opens. 4. In the Open dialog, select the file type "Plc 2.x Project Import (*.pro)", browse to the folder containing your Twin CAT 2 PLC project and select the corresponding.pro file and click Open. TF6310 Version: 1.5.1 17
## Page 18

Installation ð Twin CAT 3 starts the converter process and finally displays the converted PLC project under the “PLC“ node. 18 Version: 1.5.1 TF6310
## Page 19

Technical introduction 4 Technical introduction 4.1 Quick Start The following chapter provides a quick introduction to the Twin CAT TCP/IP product. The instructions are based on the corresponding download in our samples [} 64] and can be downloaded as a finished Twin CAT project. The individual components of the application are explained in more detail below. The Twin CAT project implements a TCP/IP Client/Server application, which sends a message to the server as a client and receives the same message back accordingly. The Twin CAT project can be activated directly and starts its program execution immediately. Communication between client and server takes place via localhost. MAIN In the MAIN program, the corresponding variable declarations are first made for the client and the server. Client and server are encapsulated by two function blocks, which use the corresponding function blocks from the Tc2_Tcp Ip library to call the socket functions (Send, Receive, Listen, Connect, etc.). The following variables are declared for the client: fb Tcp Client1: FB_TCPClient; s Client1Send Data : STRING(255); n Server1Port : UDINT := 12000; s Server1Host : T_IPv4Addr := ''; b Start Client1Communication : BOOL := TRUE; t Client1Cycle Time : TIME := T#0.5S; b Client1Send Trigger : BOOL; b Client1Connected : BOOL; s Client1Received Data : STRING(255); b Client1Busy : BOOL; b Client Error1 : BOOL; n Client1Error ID1 : UDINT; The following variables are declared for the server: fb Tcp Echo Server1 : FB_TCPServer; s Server Received Data : STRING(255); b Start Server1Communication : BOOL := TRUE; b Server1Connected : BOOL; s Server Data : STRING(255); b Server1Busy : BOOL; b Server1Error : BOOL; n Server1Error ID : UDINT; The message to be sent is saved in the variable s Client1Send Data. Later in the program, the value of this variable is changed cyclically. Specifically, a counter value is appended to the variable using string concatenation. IF b Autogenerate Data AND b Client1Connected THEN fb Timer1(IN:= NOT fb Timer1. Q, PT:= t Client1Cycle Time, Q=> , ET=> ); IF fb Timer1. Q THEN s Client1Send Data := Concat('Test String No.', UDINT_TO_STRING(n Cnt)); fb Tcp Client1.b Send Trigger := TRUE; n Cnt := n Cnt + 1; ELSE fb Tcp Client1.b Send Trigger := FALSE; END_IF END_IF The cycle in which the variable value is set and sent is defined by the timer fb Timer1. The send process is started by setting the variable fb Tcp Client1.b Send Trigger. The server application is represented by the function block instance fb Tcp Echo Server1. This is activated cyclically in the program flow so that messages can be received via the server's state machine. fb Tcp Echo Server1( s Local Host := '', n Local Port := n Server1Port, b Start Communication := b Start Server1Communication, b Connected => b Server1Connected, s Send Data => s Server Data, TF6310 Version: 1.5.1 19
## Page 20

Technical introduction b Busy=> b Server1Busy, b Error=> b Server1Error, n Error ID=> n Server1Error ID); The incoming TCP port of the server is defined via the n Local Port input. The client connects to this port to exchange data with the server. If you modify this sample so that the communication between client and server is to be carried out via the network, make sure that the server port in your system's firewall is open. Closing the sockets When the Twin CAT project is restarted, the variable b Init causes all active socket connections to be closed. This is done at the beginning of the program execution. FB_TCPServer This function block encapsulates the server application and uses the function blocks from the Tc2_Tcp Ip library to set up a socket connection for the server, listen for incoming messages and send back a corresponding response. Specifically, the function blocks FB_Socket Accept [} 27], FB_Socket Listen [} 26], FB_Socket Receive [} 30], FB_Socket Send [} 28], FB_Socket Close [} 24] and FB_Socket Close All [} 25] are used for this purpose. The internal state machine of the function block is based on the following steps: State Description 0 Initial state. The process is started via the variable b Start Communication. 10 In this state, the socket listener is started, i.e. the server application connects to the defined TCP port. 20 In this state, an incoming socket connection is accepted. 30 In this state, a message is received from the connected client. 35 In this state, a message is sent back to the connected client. 40-42 The socket connections are closed in these states. FB_TCPClient This function block encapsulates the client application and uses the function blocks from the Tc2_Tcp Ip library to establish a connection to the server, send a message to the server and receive a corresponding response. Specifically, the function blocks FB_Socket Connect [} 23], FB_Socket Send [} 28], FB_Socket Receive [} 30] and FB_Socket Close [} 24] are used for this purpose. The internal state machine of the function block is based on the following steps: State Description 0 Initial state. The process is started via the variable b Start Communication. 10 In this state, a connection is established with the server. 15 In this state, a message is sent to the server and the response is processed. 20 In this state, the connection to the server is closed. 4.2 Protocols In this section you will find a general overview of the TCP and UDP transmission protocols and a link to the corresponding PLC libraries that are required to integrate the protocols. Both transmission protocols are part of the Internet Protocol Suite and are therefore of great importance for our everyday communication, e.g. via the Internet. Transmission Control Protocol (TCP) The TCP protocol is a connection-oriented transmission protocol (OSI Layer 4), comparable to a telephone connection, in which callers must first establish a connection before data can be transmitted. Data streams (bytes) can be reliably transferred on request via TCP, which is why it is also referred to as a "data stream- oriented transfer protocol" in this context. The TCP protocol is used in networks where the data sent by a client or server requires confirmation from the other party. The TCP protocol is well suited for transferring 20 Version: 1.5.1 TF6310
## Page 21

Technical introduction large amounts of data or data streams without a defined start/end identifier. For the transmitter this is not a problem since he knows how many data bytes are transmitted. However, the receiver is unable to detect where a message ends within the data stream and where the next data stream starts. A read call on the receiver side only supplies the data currently in the receive buffer (this may be less or more than the data block sent by the other device). The transmitter has to specify a message structure that is known to the receiver and can be interpreted. In simple cases the message structure may consist of the data and a final control character (e.g. carriage return). The final control character indicates the end of a message. A possible message structure, which is often used for the transmission of binary data with a variable length, can be defined as follows: A special control character (a so-called start delimiter) and the data length of the subsequent data are entered in the first data bytes. This enables the receiver to detect the start and end of the message. TCP/IP Client A minimum TCP/IP client implementation within the PLC requires the following function blocks: • An instance of the function blocks FB_Socket Connect [} 23] and FB_Socket Close [} 24] for establishing and terminating the connection to the remote server (tip: the function block FB_Client Server Connection [} 46] combines the functionality of both function blocks). • An instance of the function block FB_Socket Send [} 28] and/or FB_Socket Receive [} 30] for data exchange (sending and receiving) with the remote server. TCP/IP server A minimum TCP/IP server implementation within the PLC requires the following function blocks: • An instance of the FB_Socket Listen [} 26] function block for opening the listener socket: • An instance of the function blocks FB_Socket Accept [} 27] and FB_Socket Close [} 24] (tip: FB_Server Client Connection [} 48] combines the functionality of all three function blocks) for establishing and terminating the connection(s) to the remote clients: • For data exchange (sending and receiving) with the remote clients, one instance of the function block FB_Socket Send [} 28] and/or FB_Socket Receive [} 30]: • In each PLC runtime system in which you open a socket, one instance of the function block FB_Socket Close All [} 25]: The instances of the function blocks FB_Socket Accept [} 27] and FB_Socket Receive [} 30] are called cyclically (polling), all others as required. User Datagram Protocol (UDP) UDP is a connection-less protocol, i.e. data is sent between network devices without an explicit connection. UDP uses a simple transmission model without implicitly defining workflows for handshaking, reliability, data ordering or congestion control. Even though the above description suggests that UDP datagrams arrive unsolicited or duplicated or cause congestion on the data line, the protocol is preferred over TCP in some cases, especially for real-time communication, as TCP features require more computing power and therefore more time. The UDP protocol is well suited to sending small amounts of data due to its connection-less nature. UDP is a "packet-oriented/message-oriented transport protocol", i.e. the sent data block is received on the receiver side as a complete data block. The following function blocks are required for a minimum UDP client/server implementation: • For opening and closing a UDP socket, one instance of the function blocks FB_Socket Udp Create [} 31] and FB_Socket Close [} 24] (tip: FB_Connectionless Socket [} 51] combines the functionality of both function blocks): • An instance of the function block FB_Socket Udp Send To [} 32] and/or FB_Socket Udp Receive From [} 34] for data exchange (sending and receiving) with other devices: • In each PLC runtime system in which you open a UDP socket, one instance of the function block FB_Socket Close All [} 25]: The instances of the function block FB_Socket Udp Receive From [} 34] are called cyclically (polling), all others as required. TF6310 Version: 1.5.1 21
## Page 22

Technical introduction See also: Samples [} 64] 22 Version: 1.5.1 TF6310
## Page 23

PLC API 5 PLC API 5.1 Function blocks 5.1.1 FB_Socket Connect Using the function block FB_Socket Connect, a local client can establish a new TCP/IP connection to a remote server via the Twin CAT TCP/IP Connection Server. If successful, a new socket is opened, and the associated connection handle is returned at the h Socket output. The connection handle is required by the function blocks FB_Socket Send [} 28] and FB_Socket Receive [} 30], for example, in order to exchange data with a remote server. If a connection is no longer required, it can be closed with the function block FB_Socket Close [} 24]. Several clients can establish a connection with the remote server at the same time. For each new client, a new socket is opened and a new connection handle is returned. The Twin CAT TCP/ IP Connection Server automatically assigns a new IP port number for each client. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; s Remote Host : T_IPv4Addr := ''; n Remote Port : UDINT; b Execute : BOOL; t Timeout : TIME := T#45s;(*!!!*) END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. s Remote Host T_IPv4Addr IP address (Ipv4) of the remote server in the form of a string (e.g. '172.33.5.1'). An empty string can be entered on the local computer for a server. n Remote Port UDINT IP port number of the remote server (e.g. 200). b Execute BOOL The function block is activated by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Setting the maximum execution time of the function block Do not set the value "t Timeout" too low, as timeout periods of > 30 s can occur in case of a network interruption. If the value is too low, command execution would be interrupted prematurely, and ADS error code 1861 (timeout elapsed) would be returned instead of the Winsocket error WSAETIMEDOUT. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; h Socket : T_HSOCKET; END_VAR TF6310 Version: 1.5.1 23
## Page 24

PLC API Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. h Socket T_HSOCKET TCP/IP connection handle [} 61] to the newly opened local client socket. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.2 FB_Socket Close The function block FB_Socket Close can be used to close an open TCP/IP or UDP socket. TCP/IP: The listener socket is opened with the function block FB_Socket Listen [} 26], a local client socket with FB_Socket Connect [} 23] and a remote client socket with FB_Socket Accept [} 27]. UDP: The UDP socket is opened with the function block FB_Socket Udp Create [} 31]. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; h Socket : T_HSOCKET; b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKET • TCP/IP: Connection handle [} 61] of the listener, remote or local client socket to be closed. • UDP: Connection handle of the UDP socket. b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR 24 Version: 1.5.1 TF6310
## Page 25

PLC API Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.3 FB_Socket Close All If Twin CAT is restarted or stopped, the Twin CAT TCP/IP Connection Server is also stopped. Any open sockets (TCP/IP and UDP connection handles) are closed automatically. The PLC program is reset after a "PLC reset", a "Rebuild all..." or a new "Download", and the information about already opened sockets (connection handles) is no longer available in the PLC. Any open connections can then no longer be closed properly. The function block FB_Socket Close All can be used to close all connection handles (TCP/IP and UDP sockets) that were opened by a PLC runtime system. This means that, if FB_Socket Close All is called in one of the tasks of the first runtime systems (port 801), all sockets that were opened in the first runtime system are closed. In each PLC runtime system that uses the socket function blocks, an instance of FB_Socket Close All should be called during the PLC start. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR TF6310 Version: 1.5.1 25
## Page 26

PLC API Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Sample of an implementation in ST The following program code is used to properly close the connection handles (sockets) that were open before a "PLC reset" or "Download" before a PLC restart. PROGRAM MAIN VAR fb Socket Close All : FB_Socket Close All; b Close All : BOOL := TRUE; END_VAR IF b Close All THEN(*On PLC reset or program download close all old connections *) b Close All := FALSE; fb Socket Close All( s Srv Net Id:= '', b Execute:= TRUE, t Timeout:= T#10s ); ELSE fb Socket Close All( b Execute:= FALSE ); END_IF IF NOT fb Socket Close All.b Busy THEN (*... ... continue program execution... ...*) END_IF Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.4 FB_Socket Listen Using the function block FB_Socket Listen, a new listener socket can be opened via the Twin CAT TCP/ IP Connection Server. Via a listener socket, the Twin CAT TCP/IP Connection Server can 'listen' for incoming connection requests from remote clients. If successful, the associated connection handle is returned at the h Listner output. This handle is required by the function block FB_Socket Accept [} 27]. If a listener socket is no longer required, it can be closed with the function block FB_Socket Close [} 24]. The listener sockets on an individual computer must have unique IP port numbers. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; s Local Host : T_IPv4Addr := ''; n Local Port : UDINT; b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR 26 Version: 1.5.1 TF6310
## Page 27

PLC API Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. s Local Host T_IPv4Addr Local server IP address (Ipv4) in the form of a string (e.g. '172.13.15.2'). For a server on the local computer (default), an empty string may be entered. n Local Port UDINT Local server IP port (e.g. 200). b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; h Listener : T_HSOCKET; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. h Listener T_HSOCKE Connection handle [} 61] to the new listener socket. T Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.5 FB_Socket Accept The remote client connection requests arriving at the Twin CAT TCP/IP Connection Server have to be acknowledged (accepted). The function block FB_Socket Accept accepts the incoming remote client connection requests, opens a new remote client socket and returns the associated connection handle. The connection handle is required by the function blocks FB_Socket Send [} 28] and FB_Socket Receive [} 30], for example, in order to exchange data with a remote client. All incoming connection requests first have to be accepted. If a connection is no longer required or undesirable, it can be closed with the function block FB_Socket Close [} 24]. A server implementation requires at least one instance of this function block. This instance has to be called cyclically (polling) from a PLC task. The function block can be activated via a positive edge at the b Execute input (e.g. every 5 seconds). If successful, the b Accepted output is set, and the connection handle to the new remote client is returned at the h Socket output. No error is returned if there are no new remote client connection requests. Several remote clients can establish a connection with the server at the same time. The connection handles of TF6310 Version: 1.5.1 27
## Page 28

PLC API several remote clients can be retrieved sequentially via several function block calls. Each connection handle for a remote client can only be retrieved once. It is recommended to keep the connection handles in a list (array). New connections are added to the list, and closed connections must be removed from the list. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; h Listener : T_HSOCKET; b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. h Listener T_HSOCKE Connection handle [} 61] of the listener socket. This handle must first be T requested via the function block FB_Socket Listen [} 26]. b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Accepted : BOOL; b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; h Socket : T_HSOCKET; END_VAR Name Type Description b Accepted BOOL This output is set if a new connection to a remote client was established. b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. h Socket T_HSOCKE Connection handle [} 61] of a new remote client. T Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.6 FB_Socket Send 28 Version: 1.5.1 TF6310
## Page 29

PLC API Using the function block FB_Socket Send, data can be sent to a remote client or remote server via the Twin CAT TCP/IP Connection Server. A remote client connection will first have to be established via the function block FB_Socket Accept [} 27], or a remote server connection via the function block FB_Socket Connect [} 23]. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; h Socket : T_HSOCKET; cb Len : UDINT; p Src : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKET Connection handle [} 61] of the communication partner to which data are to be sent. cb Len UDINT Number of date to be sent in bytes. p Src POINTER TO BYT Address (pointer) of the send buffer. E b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Setting the execution time of the function block If the transmit buffer of the socket is full, for example because the remote communication partner receives the transmitted data not quickly enough or large quantities of data are transmitted, the FB_Socket Send function block will return ADS timeout error 1861 after the t Timeout time. In this case, the value of the t Timeout input variable has to be increased accordingly. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) TF6310 Version: 1.5.1 29
## Page 30

PLC API 5.1.7 FB_Socket Receive Using the function block FB_Socket Receive, data from a remote client or remote server can be received via the Twin CAT TCP/IP Connection Server. A remote client connection will first have to be established via the function block FB_Socket Accept [} 27], and a remote server connection via the function block FB_Socket Connect [} 23]. The data can be received or sent in fragmented form (i.e. in several packets) within a TCP/IP network. It is therefore possible that not all data may be received with a single call of the FB_Socket Receive instance. For this reason, the instance has to be called cyclically (polling) within the PLC task, until all required data have been received. During this process, an rising edge is generated at the b Execute input, e.g. every 100 ms. If successful, the data received last are copied into the receive buffer. The n Rec Bytes output returns the number of the last successfully received data bytes. If no new data could be read during the last call, the function block returns no error and n Rec Bytes == zero. In a simple protocol for receiving, for example, a null-terminated string on a remote server, the function block FB_Socket Receive, for example, will have to be called repeatedly until the null termination was detected in the data received. Set timeout value If the remote device was disconnected from the TCP/IP network (on the remote side only) while the local device is still connected to the TCP/IP network, the function block FB_Socket Receive returns no error and no data. The open socket still exists, but no data are received. The application may wait forever for data in this case. It is recommended to implement timeout monitoring in the PLC application. If not all data were received after a certain period, e.g. 10 seconds, the connection has to be closed and reinitialized. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; h Socket : T_HSOCKET; cb Len : UDINT; p Dest : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKET Connection handle [} 61] of the communication partner from which data are to be received. cb Len UDINT Maximum available buffer size (in bytes) for the data to be read. p Dest POINTER TO BY Address (pointer) of the receive buffer. TE b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; 30 Version: 1.5.1 TF6310
## Page 31

PLC API n Err Id : UDINT; n Rec Bytes : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number. n Rec Bytes UDINT Number of the last successfully received data bytes. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.8 FB_Socket Udp Create The function block FB_Socket Udp Create can be used to open a client/server socket for the User Datagram Protocol (UDP). If successful, a new socket is opened, and the associated socket handle is returned at the h Socket output. The handle is required by the function blocks FB_Socket Udp Send To [} 32] and FB_Socket Udp Receive From [} 34], for example, in order to exchange data with a remote device. If a UDP socket is no longer required, it can be closed with the function block FB_Socket Close [} 24]. The port address n Local Host is internally reserved by the TCP/IP Connection Server for the UDP protocol (a "bind" is carried out). Several network adapters may exist in a PC. The input parameter s Local Host determines the network adapter to be used. If the s Local Host input variable is ignored (empty string), the TCP/IP Connection Server uses the default network adapter. This is usually the first network adapter from the list of the network adapters in the Control Panel. Automatically created network connections If an empty string was specified for s Local Host when FB_Socket Udp Create was called and the PC was disconnected from the network, the system will open a new socket under the software loopback IP address: '127.0.0.1'. Automatically created network connections with several network adapters If two or more network adapters are installed in the PC and an empty string was specified as s Local Host, and the default network adapter was then disconnected from the network, the new socket will be opened under the IP address of the second network adapter. Setting a network address In order to prevent the sockets from being opened under a different IP address, you can specify the s Local Host address explicitly or check the returned address in the handle variable (h Socket), close the socket and re-open it. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; s Local Host : T_IPv4Addr := ''; n Local Port : UDINT; TF6310 Version: 1.5.1 31
## Page 32

PLC API b Execute : BOOL; t Timeout : TIME:= T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. s Local Host T_IPv4Addr Local IP address (Ipv4) of the UDP client/server socket as a string (e.g. '172.33.5.1'). An empty string may be specified for the default network adapter. n Local Port UDINT Local IP port number of the UDP client/server socket (e.g. 200). b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; h Socket : T_HSOCKET; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. h Socket T_HSOCKET Handle of the newly opened UDP client/server socket [} 61]. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.9 FB_Socket Udp Send To The function block FB_Socket Udp Send To can be used to send UDP data to a remote device via the Twin CAT TCP/IP Connection Server. The UDP socket must first be opened with the function block FB_Socket Udp Create [} 31]. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; h Socket : T_HSOCKET; s Remote Host : T_IPv4Addr; 32 Version: 1.5.1 TF6310
## Page 33

PLC API n Remote Port : UDINT; cb Len : UDINT; p Src : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKE Handle of an opened UDP socket [} 61]. T s Remote Host T_IPv4Addr IP address (Ipv4) in string form (e.g. '172.33.5.1') of the remote device to which data is to be sent. An empty string can be entered on the local computer for a device. n Remote Port UDINT IP port number (e.g. 200) of the remote device to which data is to be sent. cb Len UDINT Number of date to be sent in bytes. The maximum number of data bytes to be sent is limited to 8192 bytes (constant TCPADS_MAXUDP_BUFFSIZE in the library in order to save storage space). p Src POINTER Address (pointer) of the send buffer. TO BYTE b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Setting the size of the received data bytes Available in product version: Twin CAT TCP/IP Connection Server v1.0.50 or higher: The maximum number of data bytes to be received can be increased (only if absolutely necessary). Twin CAT 2 1. Redefine global constant in the PLC project (in the sample the maximum number of data bytes to be received is to be increased to 32000): VAR_GLOBAL CONSTANT TCPADS_MAXUDP_BUFFSIZE : UDINT := 32000; END_VAR 2. Activate option Replace constants in the dialog of the Twin CAT PLC control (Project > Options ... > Build). 3. Rebuild Project. Twin CAT 3 In Twin CAT 3, this value can be edited via a parameter list of the PLC library (from version 3.3.4.0). TF6310 Version: 1.5.1 33
## Page 34

PLC API Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.10 FB_Socket Udp Receive From Using the function block FB_Socket Udp Receive From, data from an open UDP socket can be received via the Twin CAT TCP/IP Connection Server. The UDP socket must first be opened with the function block FB_Socket Udp Create [} 31]. The instance of the FB_Socket Udp Receive function block has to be called cyclically (polling) within the PLC task. During this process, an rising edge is generated at the b Execute 34 Version: 1.5.1 TF6310
## Page 35

PLC API input, e.g. every 100 ms. If successful, the data received last are copied into the receive buffer. The n Rec Bytes output returns the number of the last successfully received data bytes. If no new data could be read during the last call, the function block returns no error and n Rec Bytes == zero. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; h Socket : T_HSOCKET; cb Len : UDINT; p Dest : POINTER TO BYTE; b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKE Handle of an opened UDP socket [} 61], whose data are to be received. T cb Len UDINT Maximum available buffer size (in bytes) for the data to be read. The maximum number of data bytes to be received is limited to 8192 bytes (constant TCPADS_MAXUDP_BUFFSIZE in the library in order to save storage space). p Dest POINTER Address (pointer) of the receive buffer. TO BYTE b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Setting the size of the received data bytes Available in product version: Twin CAT TCP/IP Connection Server v1.0.50 or higher: The maximum number of data bytes to be received can be increased (only if absolutely necessary). Twin CAT 2 1. Redefine global constant in the PLC project (in the sample the maximum number of data bytes to be received is to be increased to 32000): VAR_GLOBAL CONSTANT TCPADS_MAXUDP_BUFFSIZE : UDINT := 32000; END_VAR 2. Activate option Replace constants in the dialog of the Twin CAT PLC control (Project > Options ... > Build). 3. Rebuild Project. Twin CAT 3 In Twin CAT 3, this value can be edited via a parameter list of the PLC library (from version 3.3.4.0). TF6310 Version: 1.5.1 35
## Page 36

PLC API Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; s Remote Host : T_IPv4Addr := ''; n Remote Port : UDINT; n Rec Bytes : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. s Remote Hos T_IPv4Addr If successful, IP address (Ipv4) of the remote device whose data were received. t n Remote Port UDINT If successful, IP port number of the remote device whose data were received (e.g. 200). n Rec Bytes UDINT Number of data bytes last successfully received. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.11 FB_Socket Udp Add Multicast Address 36 Version: 1.5.1 TF6310
## Page 37

PLC API Binds the server to a multicast IP address so that multicast packages can be received. This function block expects an already established UDP socket connection, which can be established via the function block FB_Socket Udp Create [} 31]. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; h Socket : T_HSOCKET; s Multicast Addr : STRING(15); b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKE Connection handle [} 61] of the listener socket. This handle must first be T requested via the function block FB_Socket Udp Create [} 31]. s Multicast Addr T_IPv4Addr Multicast IP address to which the binding should take place. b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.12 FB_Socket Udp Drop Multicast Address Removes the binding to a multicast IP address that was previously set up via the function block FB_Socket Udp Add Multicast Address [} 36]. TF6310 Version: 1.5.1 37
## Page 38

PLC API Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id := ''; h Socket : T_HSOCKET; s Multicast Addr : STRING(15); b Execute : BOOL; t Timeout : TIME := T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net I String containing the network address of the Twin CAT TCP/ d IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCK Connection handle [} 61] of the listener socket. This handle must first be ET requested via the function block FB_Socket Udp Create [} 31]. s Multicast Addr T_IPv4Add Multicast IP address to which the binding should take place. r b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.13 FB_Tls Socket Connect The FB_Tls Socket Connect function block enables a client to establish a new TCP/IP connection to a remote server via the Twin CAT TCP/IP Connection Server, secured via TLS. If successful, a new socket is opened, and the associated connection handle is returned at the h Socket output. The connection handle is required by the function blocks FB_Socket Send [} 28] and FB_Socket Receive [} 30], for example, in order to exchange data with a remote server. If a connection is no longer required, it can be closed with the function block FB_Socket Close [} 24]. Several clients can establish a connection with the remote server at the same time. 38 Version: 1.5.1 TF6310
## Page 39

PLC API For each new client, a new socket is opened and a new connection handle is returned. The Twin CAT TCP/ IP Connection Server automatically assigns a new IP port number for each client. The TLS parameters can be defined via the function blocks FB_Tls Socket Add Ca [} 42], FB_Tls Socket Add Crl [} 43], FB_Tls Socket Set Psk [} 45] and FB_Tls Socket Set Cert [} 44]. Programming samples for their use can be found in our samples. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id:=''; s Remote Host : STRING(TCPADS_TLS_HOSTNAME_SIZE):=''; n Remote Port : UDINT:=0; flags : ST_Tls Connect Flags:=DEFAULT_TLSCONNECTFLAGS; b Execute : BOOL; t Timeout : TIME:=T#45s;(*!!!*) END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/IP Connection Server. For the local computer (default) an empty string may be specified. s Remote Host STRING(TCPADS_TLS_HOS IP address (Ipv4) of the remote server in the form of a TNAME_SIZE) string (e.g. 172.33.5.1). An empty string can be entered on the local computer for a server. n Remote Port UDINT IP port number of the remote server (e.g. 200). flags ST_Tls Connect Flags [} 60] Additional (optional) client connection parameters. b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Setting the maximum execution time of the function block Do not set the value "t Timeout" too low, as timeout periods of > 30 s can occur in case of a network interruption. If the value is too low, command execution would be interrupted prematurely, and ADS error code 1861 (timeout elapsed) would be returned instead of the Winsocket error WSAETIMEDOUT. Inputs/outputs VAR_IN_OUT h Socket : T_HSOCKET; END_VAR Name Type Description h Socket T_HSOCKET TCP/IP connection handle [} 61] to the newly opened local client socket Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR TF6310 Version: 1.5.1 39
## Page 40

PLC API Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 5.1.14 FB_Tls Socket Listen The function block FB_TLs Socket Listen can be used to open a new listener socket secured via TLS via the Twin CAT TCP/IP Connection Server. Via a listener socket, the Twin CAT TCP/IP Connection Server can 'listen' for incoming connection requests from remote clients. The socket handle created with the function block FB_Tls Socket Create [} 41] can then be used by the function block FB_Socket Accept [} 27] to accept an incoming client request. If a listener socket is no longer required, it can be closed with the function block FB_Socket Close [} 24]. The listener sockets on an individual computer must have unique IP port numbers. Programming samples for using this function block can be found in our samples. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id:=''; s Local Host : T_IPv4Addr:=''; n Local Port : UDINT:=0; flags : ST_Tls Listen Flags:=DEFAULT_TLSLISTENFLAGS; b Execute : BOOL; t Timeout : TIME:=T#5s; END_VAR Name Type Description h Listener T_HSOCKET Socket handle, which was created via the function block FB_Tls Socket Create. s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. s Local Host T_IPv4Addr Local server IP address (Ipv4) in the form of a string (e.g. 172.13.15.2). For a server on the local computer (default), an empty string may be entered. n Local Port UDINT Local server IP port (e.g. 200). flags ST_Tls Listen Flags Additional (optional) server connection settings. [} 60] b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. 40 Version: 1.5.1 TF6310
## Page 41

PLC API Inputs/outputs VAR_IN_OUT h Listener : T_HSOCKET; END_VAR Name Type Description h Listener T_HSOCKET Connection handle [} 61] to the new listener socket. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 5.1.15 FB_Tls Socket Create The function block FB_Tls Socket Create can be used to create a new socket via the Twin CAT TCP/IP Connection Server, either for a server (b Listener:=true) or client application (b Listener:=false). Via a listener socket, the Twin CAT TCP/IP Connection Server can 'listen' for incoming connection requests from remote clients. If successful, the associated connection handle (h Socket) is returned at the h Listner output. This handle is required by the function block FB_Tls Socket Listen [} 40], and subsequently FB_Socket Accept [} 27]. If a listener socket is no longer required, it can be closed with the function block FB_Socket Close [} 24]. After the execution of the function block FB_Tls Socket Create TLS parameters can be set to secure the communication connection. This is done using the function blocks FB_Tls Socket Add Ca [} 42], FB_Tls Socket Add Crl [} 43], FB_Tls Socket Set Cert [} 44] and FB_Tls Socket Set Psk [} 45]. Programming samples for this can be found in our samples. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id:=''; b Listener : BOOL:=FALSE; b Execute : BOOL; t Timeout : TIME:=T#5s; END_VAR TF6310 Version: 1.5.1 41
## Page 42

PLC API Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. b Listener BOOL Creates a new socket handle. b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; h Socket : T_HSOCKET; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. h Socket T_HSOCKET Connection handle [} 61] for the new socket. Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 5.1.16 FB_Tls Socket Add Ca The FB_Tls Socket Add Ca function block is used to configure the path to a CA certificate for an existing socket handle. The certificate file must be in PEM format. Programming samples for using this function block can be found in our samples. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id:=''; h Socket : T_HSOCKET; s Ca Path : STRING(TCPADS_TLS_CERTIFICATE_PATH_SIZE):=''; b Execute : BOOL; t Timeout : TIME:=T#5s; END_VAR 42 Version: 1.5.1 TF6310
## Page 43

PLC API Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKET Socket handle. s Ca Path STRING(TCPADS_TLS_CERTI Path to the CA's certificate file. FICATE_PATH_SIZE) b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 5.1.17 FB_Tls Socket Add Crl The function block FB_Tls Socket Add Crl is used to specify the path to a CRL file for an existing socket handle. The CRL must be in PEM format. Programming samples for using this function block can be found in our samples. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id:=''; h Socket : T_HSOCKET; s Crl Path : STRING(TCPADS_TLS_CERTIFICATE_PATH_SIZE):=''; b Execute : BOOL; t Timeout : TIME:=T#5s; END_VAR TF6310 Version: 1.5.1 43
## Page 44

PLC API Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKET Socket handle. s Crl Path STRING(TCPADS_TLS_CER Path to the CRL file. TIFICATE_PATH_SIZE) b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 5.1.18 FB_Tls Socket Set Cert The function block FB_Tls Socket Set Cert can be used to configure a client/server certificate that is to be used for a specific socket handle. The certificates must be in PEM format. Programming samples for using this function block can be found in our samples. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id:=''; h Socket : T_HSOCKET; s Cert Path : STRING(TCPADS_TLS_CERTIFICATE_PATH_SIZE):=''; s Key Path : STRING(TCPADS_TLS_CERTIFICATE_PATH_SIZE):=''; s Key Pwd : STRING(TCPADS_TLS_KEY_PASSWORD_SIZE):=''; b Execute : BOOL; t Timeout : TIME:=T#5s; END_VAR 44 Version: 1.5.1 TF6310
## Page 45

PLC API Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKET Socket handle. s Cert Path STRING(TCPADS_TLS_CERTIFI Path to the file with the client/server certificate. CATE_PATH_SIZE) s Key Path STRING(TCPADS_TLS_CERTIFI Path to the file with the client/server private key. CATE_PATH_SIZE) s Key Pwd STRING(TCPADS_TLS_KEY_PA Optional, if the private key is secured with a password. SSWORD_SIZE) b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 5.1.19 FB_Tls Socket Set Psk The function block FB_Tls Socket Set Psk can be used to configure a pre-shared secret for an existing socket handle. Programming samples for using this function block can be found in our samples. Inputs VAR_INPUT s Srv Net Id : T_Ams Net Id:=''; h Socket : T_HSOCKET; s Identity : STRING(TCPADS_TLS_PSK_IDENTITY_SIZE):=''; psk Key : PVOID:=0; TF6310 Version: 1.5.1 45
## Page 46

PLC API psk Key Len : UDINT(0.. TCPADS_TLS_MAX_PSK_KEY_SIZE):=0; b Execute : BOOL; t Timeout : TIME:=T#5s; END_VAR Name Type Description s Srv Net Id T_Ams Net Id String containing the network address of the Twin CAT TCP/IP Connection Server. For the local computer (default) an empty string may be specified. h Socket T_HSOCKET Socket handle. s Identity STRING(TCPADS_TLS_PSK_IDENTI A freely selectable identity for the PSK. TY_SIZE) psk Key PVOID Pointer to a byte array containing the PSK. psk Key Len UDINT(0.. TCPADS_TLS_MAX_PSK_K Length of psk Key. EY_SIZE) b Execute BOOL The function block is enabled by a positive edge at this input. t Timeout TIME Maximum time allowed for the execution of the function block. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR Name Type Description b Busy BOOL This output is active if the function block is activated. It remains active until acknowledgement. b Error BOOL If an error should occur during the transfer of the command, then this output is set once the b Busy output was reset. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 5.1.20 Helper 5.1.20.1 FB_Client Server Connection The function block FB_Client Server Connection can be used to manage (establish or remove) a client connection. FB_Client Server Connection simplifies the implementation of a client application by encapsulating the functionality of the two function blocks FB_Socket Connect [} 23] and FB_Socket Close [} 24] 46 Version: 1.5.1 TF6310
## Page 47

PLC API internally. The integrated debugging output of the connection status facilitates troubleshooting in the event of configuration or communication errors. In addition, a minimum client application only requires an instance of the function block FB_Socket Send [} 28] and/or an instance of the function block FB_Socket Receive [} 30]. In the first step, a typical client application establishes the connection with the server via the FB_Client Server Connection function block. In the next step instances of FB_Socket Send and/or FB_Socket Receive can be used to exchange data with the server. When a connection is closed depends on the requirements of the application. Inputs VAR_INPUT s Srv Net ID : T_Ams Net ID := ''; n Mode : DWORD := 0; s Remote Host : T_IPv4Addr := ''; n Remote Port : UDINT; b Enable : BOOL; t Reconnect : TIME := T#45s;(*!!!*) END_VAR Name Type Description s Srv Net ID T_Ams Net I String containing the AMS network address of the Twin CAT TCP/ D IP Connection Server. For the local computer (default) an empty string may be specified. n Mode DWORD Parameter flags (modes). The permissible parameters are listed here and can be combined by ORing: CONNECT_MODE_ENABLEDBG: Enables logging of debug messages in the application log. In order to view the debug messages open the Twin CAT System Manager and activate log view. s Remote Host T_IPv4Add IP address (Ipv4) of the remote server in the form of a string (e.g. '172.33.5.1'). r An empty string can be entered on the local computer for a server. n Remote Port UDINT IP port number of the remote server (e.g. 200). b Enable BOOL As long as this input is TRUE, the system attempts to establish a new connection at regular intervals until a connection was established successfully. Once established, a connection can be closed again with FALSE. t Reconnect TIME Cycle time used by the function block to try and establish the connection. Setting the cycle time for the connection The t Reconnect value should not be set too low, since timeout periods of > 30 s may occur in the event of a network interruption. If the value is too low, command execution would be interrupted prematurely, and ADS error code 1861 (timeout elapsed) would be returned instead of the Winsocket error WSAETIMEDOUT. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; h Socket : T_HSOCKET; e State : E_Socket Connection State := e SOCKET_DISCONNECTED; END_VAR TF6310 Version: 1.5.1 47
## Page 48

PLC API Name Type Description b Busy BOOL TRUE, as long as the function block is active. b Error BOOL Becomes TRUE if an error code occurs. n Err ID UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. h Socket T_HSOCKET Connection handle [} 61] to the newly opened local client socket. If successful, this variable is transferred to the instances of the function blocks FB_Socket Send [} 28] and/or FB_Socket Receive [} 30]. e State E_Socket Connection St Returns the current connection status [} 57]. ate Sample of a call in FBD PROGRAM MAIN VAR fb Client Connection1 : FB_Client Server Connection; b Connect1 : BOOL; b Busy1 : BOOL; b Error1 : BOOL; n Err ID1 : UDINT; h Socket1 : T_HSOCKET; e State1 : E_Socket Connection State; END_VAR Here you can find more application examples (and source code): Samples [} 64] Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.20.2 FB_Server Client Connection The function block FB_Server Client Connection can be used to manage (establish or remove) a server connection. FB_Server Client Connection simplifies the implementation of a server application by encapsulating the functionality of the three function blocks FB_Socket Listen [} 26], FB_Socket Accept [} 27] and FB_Socket Close [} 24] internally. The integrated debugging output of the connection status facilitates troubleshooting in the event of configuration or communication errors. In addition, a minimum server application only requires an instance of the function block FB_Socket Send [} 28] and/or an instance of the function block FB_Socket Receive [} 30]. 48 Version: 1.5.1 TF6310
## Page 49

PLC API In the first step a typical server application establishes the connection with the client via the FB_Server Client Connection function block (more precisely, the server application accepts the incoming connection request). In the next step instances of FB_Socket Send and/or FB_Socket Receive can be used to exchange data with the server. When a connection is closed depends on the requirements of the application. Inputs VAR_INPUT e Mode : E_Socket Accept Mode := e ACCEPT_ALL; s Remote Host : T_IPv4Addr := ''; n Remote Port : UDINT := 0; b Enable : BOOL; t Reconnect : TIME := T#1s; END_VAR Name Type Description e Mode E_Socket Accept M Defines whether all or only certain connections [} 56] are to be accepted. ode s Remot T_IPv4Addr IP address (Ipv4) in string form (e.g. '172.33.5.1') of the remote client whose e Host connection is to be accepted. For a client on the local computer an empty string may be specified. n Remot UDINT IP port number (e.g. 200) of the remote client whose connection is to be e Port accepted. b Enable BOOL As long as this input is TRUE, the system attempts to establish a new connection at regular intervals until a connection was established successfully. Once established, a connection can be closed again with FALSE. t Reconn TIME Cycle time used by the function block to try to establish a connection. ect Inputs/outputs VAR_IN_OUT h Server : T_HSERVER; END_VAR Name Type Description h Server h Server Server handle [} 61]. This input variable has to be initialized via the F_Create Server Hnd [} 53] function. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; h Socket : T_HSOCKET; e State : E_Socket Connection State := e SOCKET_DISCONNECTED; END_VAR Name Type Description b Busy BOOL TRUE, as long as the function block is active. b Error BOOL Becomes TRUE if an error code occurs. n Err Id UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. h Socket T_HSOCKET Connection handle [} 61] to the newly opened remote client socket. If successful, this variable is transferred to the instances of the function blocks FB_Socket Send [} 28] and/or FB_Socket Receive [} 30]. e State E_Socket Connection St Returns the current connection status [} 57]. ate TF6310 Version: 1.5.1 49
## Page 50

PLC API Sample in FBD The following sample illustrates initialization of a server handle variable. The server handle is then transferred to three instances of the FB_Server Client Connection function block. PROGRAM MAIN VAR h Server : T_HSERVER; b Listen : BOOL; fb Server Connection1 : FB_Server Client Connection; b Connect1 : BOOL; b Busy1 : BOOL; b Error1 : BOOL; n Err ID1 : UDINT; h Socket1 : T_HSOCKET; e State1 : E_Socket Connection State; fb Server Connection2 : FB_Server Client Connection; b Connect2 : BOOL; b Busy2 : BOOL; b Error2 : BOOL; n Err ID2 : UDINT; h Socket2 : T_HSOCKET; e State2 : E_Socket Connection State; fb Server Connection3 : FB_Server Client Connection; b Connect3 : BOOL; b Busy3 : BOOL; b Error3 : BOOL; n Err ID3 : UDINT; h Socket3 : T_HSOCKET; e State3 : E_Socket Connection State; END_VAR Online View: 50 Version: 1.5.1 TF6310
## Page 51

PLC API The first connection is activated (b Connect1 = TRUE), but the connection has not yet been established (passive open). The second connection has not yet been activated (b Connect2 = FALSE) (closed). The third connection has been activated (b Connect3 = TRUE) and a connection to the remote client has been established. Here you can find more application examples (and source code): Samples [} 64] Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.1.20.3 FB_Connectionless Socket TF6310 Version: 1.5.1 51
## Page 52

PLC API A UDP socket can be managed (opened/generated and closed) with the function block FB_Connectionless Socket. FB_Connectionless Socket simplifies the implementation of a UDP application by encapsulating the functionality of the two function blocks FB_Socket Udp Create [} 31] and FB_Socket Close [} 24] already internally. The integrated debugging output of the socket status facilitates troubleshooting in the event of configuration or communication errors. In addition, a minimum UDP application only requires an instance of the function block Socket Udp Send Tod [} 32] and/or an instance of the function block FB_Socket Udp Receive From [} 34]. In the first step a typical UDP application opens a connection-less UDP socket with the function block FB_Connectionless Socket. In the next step instances of FB_Socket Udp Send To and/or FB_Socket Udp Receive From can be used for exchanging data with another communication device. When a UDP socket is closed depends on the requirements of the application (e.g. in the event of a communication error). Inputs VAR_INPUT s Srv Net ID : T_Ams Net ID := ''; n Mode : DWORD := 0; s Local Host : T_Ipv4Addr := ''; n Local Port : UDINT; b Enable : BOOL; t Reconnect : TIME := T#45s;(*!!!*) END_VAR Name Type Description s Srv Net ID T_Ams Net I String containing the AMS network address of the Twin CAT TCP/ D IP Connection Server. For the local computer (default) an empty string may be specified. n Mode DWORD Parameter flags (modes). The permissible parameters are listed here and can be combined by ORing. CONNECT_MODE_ENABLEDBG: Enables logging of debug messages in the application log. In order to view the debug messages open the Twin CAT System Manager and activate log view. s Local Host T_Ipv4Add IP address (Ipv4) in string form (e.g. '172.33.5.1') of the local network adapter. An r empty string may be specified for the default network adapter. n Local Port UDINT IP port number (e.g. 200) on the local computer. b Enable BOOL As long as this input is TRUE, attempts are made cyclically to open a UDP socket until a connection has been established. An open UDP socket can be closed again with FALSE. t Reconnect TIME Cycle time with which the function block tries to open the UDP socket. Setting the cycle time for the connection The t Reconnect value should not be set too low, since timeout periods of > 30 s may occur in the event of a network interruption. If the value is too low, command execution would be interrupted prematurely, and ADS error code 1861 (timeout elapsed) would be returned instead of the Winsocket error WSAETIMEDOUT. Outputs VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; h Socket : T_HSOCKET; e State : E_Socket Connectionless State := e SOCKET_CLOSED; END_VAR 52 Version: 1.5.1 TF6310
## Page 53

PLC API Name Type Description b Busy BOOL TRUE, as long as the function block is active. b Error BOOL Becomes TRUE if an error code occurs. n Err ID UDINT If an b Error output is set, this parameter returns the Twin CAT TCP/ IP Connection Server error number [} 101]. h Socket T_HSOCKET Connection handle [} 61] to the newly opened UDP socket. If successful, this variable is transferred to the instances of the function blocks FB_Socket Udp Send To [} 32] and/or FB_Socket Udp Receive From [} 34]. e State E_Socket Connectionless S Returns the current connection status [} 57]. tate Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.2 Functions 5.2.1 F_Create Server Hnd The function F_Create Server Hnd is used to initialize/set the internal parameters of a server handle variable h Server. The server handle is then transferred to the instances of the function block FB_Server Client Connection [} 48] via VAR_IN_OUT. An instance of the FB_Server Client Connection function block can be used to manage (establish or remove) a sever connection in a straightforward manner. The same server handle can be transferred to several instances of the function block FB_Server Client Connection, in order to enable the server to establish several concurrent connections. Syntax FUNCTION F_Create Server Hnd : BOOL VAR_IN_OUT h Server : T_HSERVER; END_VAR VAR_INPUT s Srv Net ID : T_Ams Net ID := ''; s Local Host : STRING(15) := ''; n Local Port : UDINT := 0; n Mode : DWORD := LISTEN_MODE_CLOSEALL (* OR CONNECT_MODE_ENABLEDBG*); b Enable : BOOL := TRUE; END_VAR Return value Name Type Description F_Create Server Hnd BOOL Returns TRUE if everything is OK, FALSE if there is an incorrect parameter value. TF6310 Version: 1.5.1 53
## Page 54

PLC API Inputs Name Type Description s Srv Net ID T_Ams Net ID String containing the AMS network address of the Twin CAT TCP/ IP Connection Server. For the local computer (default) an empty string may be specified. s Local Host T_IPv4Addr Local server IP address (Ipv4) in the form of a string (e.g. '172.13.15.2'). For a server on the local computer (default), an empty string may be entered. n Local Port UDINT Local server IP port (e.g. 200). n Mode DWORD Parameter flags (modes). The permissible parameters are listed here and can be combined by ORing. LISTEN_MODE_CLOSEALL: All previously opened socket connections are closed (default). CONNECT_MODE_ENABLEDBG: Enables logging of debug messages in the application log. In order to view the debug messages open the Twin CAT System Manager and activate log view. b Enable BOOL This input determines the behavior of the listener socket. A listener socket opened beforehand remains open as long as this input is TRUE. If this input is FALSE, the listener socket is closed automatically, but only once the last (previously) accepted connection was also closed. / Inputs/outputs Name Type Description h Server T_HSERVER Server handle variable whose internal parameters are to be initialized. Example: See FB_Server Client Connection [} 48]. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.2.2 HSOCKET_TO_STRING The function converts the connection handle of type T_HSOCKET to a string (e.g. for debug outputs). The returned string has the following format: "Handle:0x A[BCD] Local:a[aa].b[bb].c[cc].d[dd]:port Remote:a[aa].b[bb].c[cc].d[dd]:port". Example: "Handle:0x4001 Local:172.16.6.195:28459 Remote:172.16.6.180:2404" Syntax FUNCTION HSOCKET_TO_STRING : STRING VAR_INPUT h Socket : T_HSOCKET; END_VAR 54 Version: 1.5.1 TF6310
## Page 55

PLC API Return value Name Type Description HSOCKET STRING Contains the STRING representation of the connection handle. _TO_STRI NG Inputs Name Type Description h Socket T_HSOCKET The connection handle [} 61] to be converted. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.2.3 HSOCKET_TO_STRINGEX The function converts the connection handle of type T_HSOCKET to a string (e.g. for debug outputs). The returned string has the following format: "Handle:0x A[BCD] Local:a[aa].b[bb].c[cc].d[dd]:port Remote:a[aa].b[bb].c[cc].d[dd]:port". Example: "Handle:0x4001 Local:172.16.6.195:28459 Remote:172.16.6.180:2404" The parameters b Local and b Remote determine whether the local and/or remote address information should be included in the returned string. Syntax FUNCTION HSOCKET_TO_STRINGEX : STRING VAR_INPUT h Socket : T_HSOCKET; b Local : BOOL; b Remote : BOOL; END_VAR Return value Name Type Description HSOCKET_TO_ST STRING Contains the hex-based STRING representation of the connection RINGEX handle. Inputs Name Type Description h Socket T_HSOCKET The connection handle [} 61] to be converted. b Local BOOL TRUE: Include the local address, FALSE: Exclude the local address. b Remote BOOL TRUE: Include the remote address, FALSE: Exclude the remote address. TF6310 Version: 1.5.1 55
## Page 56

PLC API Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.2.4 SOCKETADDR_TO_STRING The function converts a variable of type ST_Sock Addr to a string (e.g. for debug outputs). The returned string has the following format: "a[aa].b[bb].c[cc].d[dd]:port" Example: "172.16.6.195:80" FUNCTION SOCKETADDR_TO_STRING : STRING VAR_INPUT st Sock Addr : ST_Sock Addr; END_VAR Return value Name Type Description SOCKETADDR_TO STRING Contains the STRING representation of the socket address. _STRING Inputs Name Type Description st Socke Addr ST_Sock Addr The variable to be converted. See ST_Sock Addr [} 59] Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.3 Data types 5.3.1 E_Socket Accept Mode E_Socket Accept Mode specifies which connections are accepted by the server. Syntax TYPE E_Socket Accept Mode: (* Connection accept modes *) ( e ACCEPT_ALL, (* Accept connection to all remote clients *) e ACCEPT_SEL_HOST, (* Accept connection to selected host address *) e ACCEPT_SEL_PORT, (* Accept connection to selected port address *) e ACCEPT_SEL_HOST_PORT (* Accept connection to selected host and port address *) ); END_TYPE 56 Version: 1.5.1 TF6310
## Page 57

PLC API Values Name Description e ACCEPT_ALL Accept connection to all remote clients. e ACCEPT_SEL_HOST Accept connection to selected host address. e ACCEPT_SEL_PORT Accept connection to selected port address. e ACCEPT_SEL_HOST_PORT Accept connection to selected host and port address. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.3.2 E_Socket Connection State TCP/IP Socket Connection Status (e SOCKET_SUSPENDED == the status changes e.g. from e SOCKET_CONNECTED => e SOCKET_DISCONNECTED). Syntax TYPE E_Socket Connection State: ( e SOCKET_DISCONNECTED, e SOCKET_CONNECTED, e SOCKET_SUSPENDED ); END_TYPE Values Name Description e SOCKET_DISCONNECTED The connection is interrupted. e SOCKET_CONNECTED The connection exists. e SOCKET_SUSPENDED The status of the connection changes from disconnected to connected or from connected to disconnected. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.3.3 E_Socket Connectionless State Status information of a connection-less UDP socket (e SOCKET_TRANSIENT == the status changes from e SOCKET_CREATED=>e SOCKET_CLOSED, for example). Syntax TYPE E_Socket Connectionless State: ( e SOCKET_CLOSED, e SOCKET_CREATED, e SOCKET_TRANSIENT ); END_TYPE TF6310 Version: 1.5.1 57
## Page 58

PLC API Values Name Description e SOCKET_CLOSED The UDP socket is closed. e SOCKET_CREATED The UDP socket is created. e SOCKET_TRANSIENT The UDP socket changes from closed to open or from open to closed. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.3.4 E_Winsock Error Syntax TYPE E_Winsock Error : ( WSOK, WSAEINTR := 10004 , (* A blocking operation was interrupted by a call to WSACancel Blocking Call. *) WSAEBADF := 10009 ,(* The file handle supplied is not valid. *) WSAEACCES := 10013 , (* An attempt was made to access a socket in a way forbidden by its access permissions. *) WSAEFAULT := 10014 , (* The system detected an invalid pointer address in attempting to use a pointer argument in a call. *) WSAEINVAL := 10022 ,(* An invalid argument was supplied. *) WSAEMFILE := 10024 ,(* Too many open sockets. *) WSAEWOULDBLOCK := 10035 ,(* A non- blocking socket operation could not be completed immediately. *) WSAEINPROGRESS := 10036 ,(* A blocking operation is currently executing. *) WSAEALREADY := 10037 ,(* An operation was attempted on a non- blocking socket that already had an operation in progress. *) WSAENOTSOCK := 10038 ,(* An operation was attempted on something that is not a socket. *) WSAEDESTADDRREQ := 10039 , (* A required address was omitted from an operation on a socket. *) WSAEMSGSIZE := 10040 , (* A message sent on a datagram socket was larger than the internal message buffer or some other net work limit, or the buffer used to receive a datagram into was smaller than the datagram itself. *) WSAEPROTOTYPE := 10041 , (* A protocol was specified in the socket function call that does not support the semantics of the s ocket type requested. *) WSAENOPROTOOPT := 10042 , (* An unknown, invalid, or unsupported option or level was specified in a getsockopt or setsockopt c all. *) WSAEPROTONOSUPPORT := 10043 , (* The requested protocol has not been configured into the system, or no implementation for it exist s. *) WSAESOCKTNOSUPPORT := 10044 , (* The support for the specified socket type does not exist in this address family. *) WSAEOPNOTSUPP := 10045 , (* The attempted operation is not supported for the type of object referenced. *) WSAEPFNOSUPPORT := 10046 , (* The protocol family has not been configured into the system or no implementation for it exists. * ) WSAEAFNOSUPPORT := 10047 , (* An address incompatible with the requested protocol was used. *) WSAEADDRINUSE := 10048 ,(* Only one usage of each socket address (protocol/network address/ port) is normally permitted. *) WSAEADDRNOTAVAIL := 10049 ,(* The requested address is not valid in its context. *) WSAENETDOWN := 10050 ,(* A socket operation encountered a dead network. *) WSAENETUNREACH := 10051 ,(* A socket operation was attempted to an unreachable network. *) WSAENETRESET := 10052 ,(* The connection has been broken due to keep- alive activity detecting a failure while the operation was in progress. *) WSAECONNABORTED := 10053 , (* An established connection was aborted by the software in your host machine. *) WSAECONNRESET := 10054 ,(* An existing connection was forcibly closed by the remote host. *) WSAENOBUFS := 10055 , (* An operation on a socket could not be performed because the system lacked sufficient buffer space or because a queue was full. *) WSAEISCONN := 10056 ,(* A connect request was made on an already connected socket. *) 58 Version: 1.5.1 TF6310
## Page 59

PLC API WSAENOTCONN := 10057 , (* A request to send or receive data was disallowed because the socket is not connected and (when se nding on a datagram socket using a sendto call) no address was supplied. *) WSAESHUTDOWN := 10058 , (* A request to send or receive data was disallowed because the socket had already been shut down in that direction with a previous shutdown call. *) WSAETOOMANYREFS := 10059 ,(* Too many references to some kernel object. *) WSAETIMEDOUT := 10060 , (* A connection attempt failed because the connected party did not properly respond after a period o f time, or established connection failed because connected host has failed to respond. *) WSAECONNREFUSED := 10061 , (* No connection could be made because the target machine actively refused it. *) WSAELOOP := 10062 ,(* Cannot translate name. *) WSAENAMETOOLONG := 10063 ,(* Name component or name was too long. *) WSAEHOSTDOWN := 10064 , (* A socket operation failed because the destination host was down. *) WSAEHOSTUNREACH := 10065 ,(* A socket operation was attempted to an unreachable host. *) WSAENOTEMPTY := 10066 ,(* Cannot remove a directory that is not empty. *) WSAEPROCLIM := 10067 , (* A Windows Sockets implementation may have a limit on the number of applications that may use it s imultaneously. *) WSAEUSERS := 10068 ,(* Ran out of quota. *) WSAEDQUOT := 10069 ,(* Ran out of disk quota. *) WSAESTALE := 10070 ,(* File handle reference is no longer available. *) WSAEREMOTE := 10071 ,(* Item is not available locally. *) WSASYSNOTREADY := 10091 , (* WSAStartup cannot function at this time because the underlying system it uses to provide network services is currently unavailable. *) WSAVERNOTSUPPORTED := 10092 ,(* The Windows Sockets version requested is not supported. *) WSANOTINITIALISED := 10093 , (* Either the application has not called WSAStartup, or WSAStartup failed. *) WSAEDISCON := 10101 , (* Returned by WSARecv or WSARecv From to indicate the remote party has initiated a graceful shutdown sequence. *) WSAENOMORE := 10102 ,(* No more results can be returned by WSALookup Service Next. *) WSAECANCELLED := 10103 , (* A call to WSALookup Service End was made while this call was still processing. The call has been ca nceled. *) WSAEINVALIDPROCTABLE := 10104 ,(* The procedure call table is invalid. *) WSAEINVALIDPROVIDER := 10105 ,(* The requested service provider is invalid. *) WSAEPROVIDERFAILEDINIT := 10106 , (* The requested service provider could not be loaded or initialized. *) WSASYSCALLFAILURE := 10107 ,(* A system call that should never fail has failed. *) WSASERVICE_NOT_FOUND := 10108 , (* No such service is known. The service cannot be found in the specified name space. *) WSATYPE_NOT_FOUND := 10109 ,(* The specified class was not found. *) WSA_E_NO_MORE := 10110 ,(* No more results can be returned by WSALookup Service Next. *) WSA_E_CANCELLED := 10111 , (* A call to WSALookup Service End was made while this call was still processing. The call has been ca nceled. *) WSAEREFUSED := 10112 ,(* A database query failed because it was actively refused. *) WSAHOST_NOT_FOUND := 11001 ,(* No such host is known. *) WSATRY_AGAIN := 11002 , (* This is usually a temporary error during hostname resolution and means that the local server did not receive a response from an authoritative server. *) WSANO_RECOVERY := 11003 ,(* A non-recoverable error occurred during a database lookup. *) WSANO_DATA := 11004 (* The requested name is valid and was found in the database, but it doe s not have the correct associated data being resolved for. *) ); END_TYPE Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.3.5 ST_Sock Addr The structure contains address information of an open socket. TF6310 Version: 1.5.1 59
## Page 60

PLC API Syntax TYPE ST_Sock Addr : (* Local or remote endpoint address *) STRUCT n Port : UDINT; (* Internet Protocol (IP) port. *) s Addr : STRING(15); (* String containing an (Ipv4) Internet Protocol dotted address. *) END_STRUCT END_TYPE Values Name Type Description n Port UDINT Internet Protocol (IP) port s Addr STRING(15) Internet Protocol address separated by periods (Ipv4) in the form of a string e.g.: "172.34.12.3" Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.3.6 ST_Tls Connect Flags Additional (optional) client connection parameters. Syntax TYPE ST_Tls Connect Flags : STRUCT b No Server Cert Check: BOOL; b Ignore Cn Mismatch : BOOL; END_STRUCT END_TYPE Values Name Type Description b No Server Cert Check BOOL Disables validation of the server certificate. b Ignore Cn Mismatch BOOL Ignored if the Common Name in the server certificate does not match the host name specified as s Remote Host. Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 5.3.7 ST_Tls Listen Flags Additional (optional) server connection parameters. Syntax TYPE ST_Tls Listen Flags : STRUCT b No Client Cert : BOOL; END_STRUCT END_TYPE 60 Version: 1.5.1 TF6310
## Page 61

PLC API Values Name Type Description b No Client Cert BOOL Client certificate is not required. Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 5.3.8 T_HSERVER The variable of this type represents a TCP/IP Server Handle. The Handle has to be initialized with F_Create Server Hnd [} 53] bevor it can be used. In doing so the internal parameters of variables T_HSERVER are set. Preserve the default structure elements The structure elements are not to be written or changed. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.3.9 T_HSOCKET Variables of this type represent a connection handle or a handle of an open socket. Via this handle, data can be sent to or received from a socket. The handle can be used to close an open socket. Syntax TYPE T_HSOCKET STRUCT handle : UDINT; local Addr : ST_Sock Addr; (* Local address *) remote Addr : ST_Sock Addr; (* Remote endpoint address *) END_STRUCT END_TYPE Values Name Type Description handle UDINT Internal Twin CAT TCP/IP Connection Server socket handle. local Addr ST_Sock Addr Local socket address [} 59]. remote Addr ST_Sock Addr Remote socket address [} 59]. The following sockets can be opened and closed via the Twin CAT TCP/IP Connection Server: Listener socket, Remote Client socket or Local Client socket. Depending on which of these sockets was opened by the Twin CAT TCP/IP Connection Server, suitable address information is entered into the local Addr and remote Addr variables. Connection handle on the server side • The function block FB_Socket Listen [} 26] opens a listener socket and returns the connection handle of the listener socket. TF6310 Version: 1.5.1 61
## Page 62

PLC API • The connection handle of the listener sockets is transferred to the function block FB_Socket Accept [} 27]. FB_Socket Accept will then return the connection handles of the remote clients. • The function block FB_Socket Accept returns a new connection handle for each connected remote client. • The connection handle is then transferred to the function blocks FB_Socket Send [} 28] and/or FB_Socket Receive [} 30], in order to be able to exchange data with the remote clients. • A connection handle of a remote client that is not desirable or no longer required is transferred to the function block FB_Socket Close [} 24], which closes the remote client socket. • A listener socket connection handle that is no longer required is also transferred to the function block FB_Socket Close, which closes the listener socket. Connection handle on the client side • The function block FB_Socket Connect [} 23] returns the connection handle of a local client socket. • The connection handle is then transferred to the function blocks FB_Socket Send [} 28] and FB_Socket Receive [} 30], in order to be able to exchange data with a remote server. • The same connection handle is then transferred to the function block FB_Socket Close [} 24], in order to close a connection that is no longer required. The function block FB_Socket Close All [} 25] can be used to close all connection handles (sockets) that were opened by a PLC runtime system. This means that, if FB_Socket Close All is called in one of the tasks of the first runtime systems (port 801), all sockets that were opened in the first runtime system are closed. Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 5.4 Global constants 5.4.1 Library version All libraries have a certain version. This version is displayed in the repository of the PLC library. The version number of the library is stored in a global constant (type: ST_Lib Version). Global_Version VAR_GLOBAL CONSTANT st Lib Version_Tc2_Tcp Ip : ST_Lib Version; END_VAR The F_Cmp Lib Version function (in the Tc2_System library) is used to compare the existing and required version. Compatibility with Twin CAT 2 Query options for Twin CAT2 libraries are no longer available! Requirements Development environment Target system type PLC libraries to include (cate- gory group) Twin CAT v3.1.0 PC, or CX (x86, X64, Arm®) Tc2_Tcp Ip (communication) 62 Version: 1.5.1 TF6310
## Page 63

PLC API 5.4.2 Parameter list Param Name Type Value Description TCPADS_MAXUDP_BUFFSIZE UDINT 16#2000 Max. byte length of the internal UDP send/receive buffer (8192 bytes). TCPADS_TLS_HOSTNAME_SI UDINT 255 Max. length of the host name string. ZE TCPADS_TLS_CERTIFICATE_ UDINT 255 Max. length of the certificate path string. PATH_SIZE TCPADS_TLS_KEY_PASSWO UDINT 255 Max. length of the certificate password path string. RD_SIZE TCPADS_TLS_PSK_IDENTITY UDINT 255 Max. length of the PSK identity string. _SIZE TCPADS_TLS_MAX_PSK_KEY UDINT 128 Max. byte length of the PSK key. _SIZE Requirements Development environment Target platform PLC libraries to be integrated (category group) TF6310 v3.3.15.0 or later PC or CX (x86, x64, Arm®) Tc2_Tcp Ip (Communication) Twin CAT v3.1.0 TF6310 Version: 1.5.1 63
## Page 64

Samples 6 Samples Overview The following samples of using the product as a TCP/IP client/server are available for download in our Git Hub repository (see below). Link Description Quick Start [} 19] Enables a quick start to using the product as a TCP/IP client/server. Sample01: "Echo" client/server (basic function Demonstrates the exemplary implementation of a TCP/IP client/server application, which cyclically exchanges a blocks) [} 65] message between client and server. The basic function blocks serve as a basis. Sample02: “Echo“ client /server [} 84] Demonstrates the exemplary implementation of a TCP/IP client/server application, which cyclically exchanges a message between client and server. The helper function blocks serve as the basis. The application allows a maximum of one connection. Sample03: “Echo” client/server [} 85] Demonstrates the exemplary implementation of a TCP/IP client/server application, which cyclically exchanges a message between client and server. The helper function blocks serve as the basis. The application allows multiple connections. Sample04: Binary data exchange [} 87] Demonstrates the exemplary implementation of a TCP/IP client/server application that implements its own binary protocol for data exchange. The application allows a maximum of one connection. Sample05: Binary data exchange [} 89] Demonstrates the exemplary implementation of a TCP/IP client/server application that implements its own binary protocol for data exchange. The application allows multiple connections. Sample06: "Echo" client/server with TLS (basic This sample is essentially based on Sample01 and extends it with TLS. modules) [} 90] Sample07: "Echo" client/server with TLS-PSK This sample is essentially based on Sample01 and extends it with TLS-PSK. (basic modules) [} 91] The following samples of using the product as a UDP/IP client/server are available for download in our Git Hub repository (see below). Link Description Sample01: Peer-to-peer communication [} 91] This sample demonstrates the implementation of a simple peer-to-peer application in the PLC. Sample02: Multicast [} 99] This sample demonstrates how multicast messages can be sent and received via UDP. Downloads Sample code and configurations for this product can be obtained from the corresponding repository on Git Hub: https://github.com/Beckhoff/TF6310_Samples. There you have the option to clone the repository or download a ZIP file containing the sample. 64 Version: 1.5.1 TF6310
## Page 65

Samples 6.1 TCP 6.1.1 Sample01: "Echo" client/server (basic function blocks) 6.1.1.1 Overview The following example shows an implementation of an "echo" client/server. The client sends a test string to the server at certain intervals (e.g. every second). The remote server then immediately resends the same string to the client. In this sample, the client is implemented in the PLC and as a . NET application written in C#. The PLC client can create several instances of the communication, simulating several TCP connections at once. The . NET sample client only establishes one concurrent connection. The server is able to communicate with several clients. In addition, several instances of the server may be created. Each server instance is then addressed via a different port number which can be used by the client to connect to a specific server instance. The server implementation is more difficult if the server has to communicate with more than one client. Feel free to use and customize this sample to your needs. System requirements • Twin CAT 3 Build 3093 or higher • Twin CAT 3 Function TF6310 TCP/IP • If two computers are used to execute the sample (one client and one server), the Function TF6310 needs to be installed on both computers • If one computer is used to execute the sample, e.g. client and server running in two separate PLC runtimes, both PLC runtimes need to run in separate tasks • To run the . NET sample client, only . NET Framework 4.0 is needed Project downloads https://github.com/Beckhoff/TF6310_Samples/tree/master/PLC/TCP/Sample01 https://github.com/Beckhoff/TF6310_Samples/tree/master/C%23/Sample Client TF6310 Version: 1.5.1 65
## Page 66

Samples Project description The following links provide documentation for the three components. Additionally, an own article explains how to start the PLC samples with step-by-step instructions. • Integration in Twin CAT and Test [} 67] (Starting the PLC samples) • PLC Client [} 70] (PLC client documentation: FB_Local Client function block [} 70]) • PLC Server [} 74] (PLC serve documentation: FB_Local Server function block [} 74]) • . NET client [} 80] (. NET client documentation: . NET sample client [} 80]) Additional functions of the PLC sample projects Some functions, constants and function blocks are used in the sample projects, which are briefly described below: Log Error function FUNCTION Log Error : DINT The function writes a message with the error code into the logbook of the operating system (Event Viewer). The global variable b Log Debug Messages must first be set to TRUE. Log Message function FUNCTION Log Message : DINT The function writes a message into the logbook of the operating system (Event Viewer) if a new socket was opened or closed. The global variable b Log Debug Messages must first be set to TRUE. SCODE_CODE function FUNCTION SCODE_CODE : DWORD The function masks the least significant 16 bits of a Win32 error code returns them. 66 Version: 1.5.1 TF6310
## Page 67

Samples Global variables Name Default value Description b Log Debug Messages TRUE Activates/deactivates writing of messages into the log book of the operating system MAX_CLIENT_CONNECTIONS 5 Max. number of remote clients, that can connect to the server at the same time. MAX_PLCPRJ_RXBUFFER_SIZE 1000 Max. length of the internal receive buffer PLCPRJ_RECONNECT_TIME T#3s Once this time has elapsed, the local client will attempt to re-establish the connection with the remote server PLCPRJ_SEND_CYCLE_TIME T#1s The test string is sent cyclically at these intervals from the local client to the remote server PLCPRJ_RECEIVE_POLLING_TI T#1s The client reads (polls) data from the server using ME this cycle PLCPRJ_RECEIVE_TIMEOUT T#10s After this time has elapsed, the local client aborts the reception if no data bytes could be received during this time PLCPRJ_ERROR_RECEIVE_BUF 16#8101 Sample project error code: Too many characters FER_OVERFLOW without zero termination were received PLCPRJ_ERROR_RECEIVE_TIM 16#8102 Sample project error code: No new data could be EOUT received within the timeout time (PLCPRJ_RECEIVE_TIMEOUT) 6.1.1.2 Integration in Twin CAT and Test The following section describes how to prepare and start the PLC server and client. The PLC samples are provided as Twin CAT 3 PLC project files. To import a PLC project into Twin CAT XAE, first create a new Twin CAT 3 Solution. Then select the Add Existing Item command in the context menu of the PLC node and select the downloaded sample file (Plc 3.x Project archive (*.tpzip)) as the file type in the dialog that opens. After confirming the dialog, the PLC project is added to the Solution. Sample PLC server Create a new Twin CAT 3 solution in Twin CAT XAE and import the Twin CAT TCP/IP server project. Select a target system. The function must also be installed on the target system and licenses for TF6310 must have been generated. Keep the Twin CAT 3 Solution open. PROGRAM MAIN VAR fb Server : FB_Local Server := ( s Local Host := '127.0.0.1' (*own IP address! *), n Local Port := 200 ); TF6310 Version: 1.5.1 67
## Page 68

Samples b Enable Server : BOOL := TRUE; fb Socket Close All : FB_Socket Close All := ( s Srv Net ID := '', t Timeout := DEFAULT_ADS_TIMEOUT ); b Close All : BOOL := TRUE; END_VAR IF b Close All THEN (*On PLC reset or program download close all old connections *) b Close All := FALSE; fb Socket Close All( b Execute:= TRUE ); ELSE fb Socket Close All( b Execute:= FALSE ); END_IF IF NOT fb Socket Close All.b Busy THEN fb Server( b Enable := b Enable Server ); END_IF Sample PLC client Import the TCP/IP client project into the Twin CAT 3 Solution as a second PLC project. Link this PLC project to a different task than the server sample. The IP address of the server must be adapted to your system (initialization values of the s Remote Host variable). In this case, the server is on the same PC, so enter 127.0.0.1. Enable the configuration, log in and start the server and then the client PLC project. PROGRAM MAIN VAR fb Client1 : FB_Local Client := ( s Remote Host:= '127.0.0.1' (* IP address of remote server! *) , n Remote Port:= 200 ); fb Client2 : FB_Local Client := ( s Remote Host:= '127.0.0.1', n Remote Port:= 200 ); fb Client3 : FB_Local Client := ( s Remote Host:= '127.0.0.1', n Remote Port:= 200 ); fb Client4 : FB_Local Client := ( s Remote Host:= '127.0.0.1', n Remote Port:= 200 ); fb Client5 : FB_Local Client := ( s Remote Host:= '127.0.0.1', n Remote Port:= 200 ); b Enable Client1 : BOOL := TRUE; b Enable Client2 : BOOL := FALSE; b Enable Client3 : BOOL := FALSE; b Enable Client4 : BOOL := FALSE; b Enable Client5 : BOOL := FALSE; fb Socket Close All : FB_Socket Close All := ( s Srv Net ID := '', t Timeout := DEFAULT_ADS_TIMEOUT ); b Close All : BOOL := TRUE; n Count : UDINT; END_VAR IF b Close All THEN (*On PLC reset or program download close all old connections *) b Close All := FALSE; fb Socket Close All( b Execute:= TRUE ); ELSE fb Socket Close All( b Execute:= FALSE ); END_IF IF NOT fb Socket Close All.b Busy THEN n Count := n Count + 1; fb Client1( b Enable := b Enable Client1, s To Server := CONCAT( 'CLIENT1-', UDINT_TO_STRING( n Count ) ) ); fb Client2( b Enable := b Enable Client2, s To Server := CONCAT( 'CLIENT2-', UDINT_TO_STRING( n Count ) ) ); fb Client3( b Enable := b Enable Client3, s To Server := CONCAT( 'CLIENT3-', UDINT_TO_STRING( n Count ) ) ); fb Client4( b Enable := b Enable Client4 ); fb Client5( b Enable := b Enable Client5 ); END_IF When setting one of the b Enable Cient X variables, up to five client instances can be enabled. Each client sends one string per second to the server (default: 'TEST'). The server returns the same string to the client (echo server). For the test, a string with a counter value is generated automatically for the first three instances. The first client is enabled automatically when the program is started. Set the b Enable Cilent4 variable in the client project to TRUE. The new client then attempts to establish a connection to the server. If successful, the 'TEST' string is sent cyclically. Now open the fb Client4 instance of the FB_Local Client function block. Double-click to open the dialog for writing the s To String variable and change the value of the string variable to 'Hello', for example. 68 Version: 1.5.1 TF6310
## Page 69

Samples Close the dialog with OK. Force the new value into the PLC. Shortly afterwards, the value returned by the server can be viewed online. Now open the fb Server instance of the FB_Local Server function block in the server project. The string: 'Hello' can be seen in the online data of the server. TF6310 Version: 1.5.1 69
## Page 70

Samples 6.1.1.3 PLC Client 6.1.1.3.1 FB_Local Client If the b Enable input is set, the system will keep trying to establish the connection to the remote server once the CLIENT_RECONNECT_TIME has elapsed. The remote server is identified via the s Remote Host IP address and the n Remote Port IP port address. The data exchange with the server was encapsulated in a separate function block FB_Client Data Excha [} 72]. The data exchange is cyclic, always after PLCPRJ_SEND_CYCLE_TIME has expired. The s To Server string variable is sent to the server and the string returned by the server is available at the s Form Server output. Another implementation, in which the remote server is addressed as required is also possible. In the event of an error, the existing connection is closed, and a new connection is established. Interface FUNCTION_BLOCK FB_Local Client VAR_INPUT s Remote Host : STRING(15) := '127.0.0.1';(* IP adress of remote server *) n Remote Port : UDINT := 0; s To Server : T_Max String:= 'TEST'; b Enable : BOOL; END_VAR VAR_OUTPUT b Connected : BOOL; h Socket : T_HSOCKET; b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; s From Server : T_Max String; END_VAR VAR fb Connect : FB_Socket Connect := ( s Srv Net Id := '' ); fb Close : FB_Socket Close := ( s Srv Net Id := '', t Timeout := DEFAULT_ADS_TIMEOUT ); fb Client Data Excha : FB_Client Data Excha; 70 Version: 1.5.1 TF6310
## Page 71

Samples fb Connect TON : TON := ( PT := PLCPRJ_RECONNECT_TIME ); fb Data Excha TON : TON := ( PT := PLCPRJ_SEND_CYCLE_TIME ); e Step : E_Client Steps; END_VAR Implementation CASE e Step OF CLIENT_STATE_IDLE: IF b Enable XOR b Connected THEN b Busy := TRUE; b Error := FALSE; n Errid := 0; s From Server := ''; IF b Enable THEN fb Connect TON( IN := FALSE ); e Step := CLIENT_STATE_CONNECT_START; ELSE e Step := CLIENT_STATE_CLOSE_START; END_IF ELSIF b Connected THEN fb Data Excha TON( IN := FALSE ); e Step := CLIENT_STATE_DATAEXCHA_START; ELSE b Busy := FALSE; END_IF CLIENT_STATE_CONNECT_START: fb Connect TON( IN := TRUE, PT := PLCPRJ_RECONNECT_TIME ); IF fb Connect TON. Q THEN fb Connect TON( IN := FALSE ); fb Connect( b Execute := FALSE ); fb Connect(s Remote Host := s Remote Host, n Remote Port := n Remote Port, b Execute := TRUE ); e Step := CLIENT_STATE_CONNECT_WAIT; END_IF CLIENT_STATE_CONNECT_WAIT: fb Connect( b Execute := FALSE ); IF NOT fb Connect.b Busy THEN IF NOT fb Connect.b Error THEN b Connected := TRUE; h Socket := fb Connect.h Socket; e Step := CLIENT_STATE_IDLE; Log Message( 'LOCAL client CONNECTED!', h Socket ); ELSE Log Error( 'FB_Socket Connect', fb Connect.n Err Id ); n Err Id := fb Connect.n Err Id; e Step := CLIENT_STATE_ERROR; END_IF END_IF CLIENT_STATE_DATAEXCHA_START: fb Data Excha TON( IN := TRUE, PT := PLCPRJ_SEND_CYCLE_TIME ); IF fb Data Excha TON. Q THEN fb Data Excha TON( IN := FALSE ); fb Client Data Excha( b Execute := FALSE ); fb Client Data Excha( h Socket := h Socket, s To Server := s To Server, b Execute := TRUE ); e Step := CLIENT_STATE_DATAEXCHA_WAIT; END_IF CLIENT_STATE_DATAEXCHA_WAIT: fb Client Data Excha( b Execute := FALSE ); IF NOT fb Client Data Excha.b Busy THEN IF NOT fb Client Data Excha.b Error THEN s From Server := fb Client Data Excha.s From Server; e Step := CLIENT_STATE_IDLE; ELSE (* possible errors are logged inside of fb Client Data Excha function block *) n Err Id := fb Client Data Excha.n Err Id; e Step :=CLIENT_STATE_ERROR; END_IF END_IF CLIENT_STATE_CLOSE_START: fb Close( b Execute := FALSE ); TF6310 Version: 1.5.1 71
## Page 72

Samples fb Close( h Socket:= h Socket, b Execute:= TRUE ); e Step := CLIENT_STATE_CLOSE_WAIT; CLIENT_STATE_CLOSE_WAIT: fb Close( b Execute := FALSE ); IF NOT fb Close.b Busy THEN Log Message( 'LOCAL client CLOSED!', h Socket ); b Connected := FALSE; MEMSET( ADR(h Socket), 0, SIZEOF(h Socket)); IF fb Close.b Error THEN Log Error( 'FB_Socket Close (local client)', fb Close.n Err Id ); n Err Id := fb Close.n Err Id; e Step := CLIENT_STATE_ERROR; ELSE b Busy := FALSE; b Error := FALSE; n Err Id := 0; e Step := CLIENT_STATE_IDLE; END_IF END_IF CLIENT_STATE_ERROR: (* Error step *) b Error := TRUE; IF b Connected THEN e Step := CLIENT_STATE_CLOSE_START; ELSE b Busy := FALSE; e Step := CLIENT_STATE_IDLE; END_IF END_CASE 6.1.1.3.2 FB_Client Data Excha In the event of an rising edge at the b Execute input, a null-terminated string is sent to the remote server, and a string returned by the remote server is read. The function block will try reading the data until null termination was detected in the string received. If the PLCPRJ_RECEIVE_TIMEOUT time-out period is exceeded or if an error occurs, reception is aborted. Data are attempted to be read again after a certain delay time, if no new data could be read during the last read attempt. This reduces the system load. Interface FUNCTION_BLOCK FB_Client Data Excha VAR_INPUT h Socket : T_HSOCKET; s To Server : T_Max String; b Execute : BOOL; END_VAR VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; s From Server : T_Max String; END_VAR VAR fb Socket Send : FB_Socket Send := ( s Srv Net ID := '', t Timeout := DEFAULT_ADS_TIMEOUT ); fb Socket Receive : FB_Socket Receive := ( s Srv Net ID := '', t Timeout := DEFAULT_ADS_TIMEOUT ); fb Receive TON : TON; fb Disconnect TON : TON; Rising Edge : R_TRIG; e Step : E_Data Excha Steps; cb Received, start Pos, end Pos, idx : UDINT; cb Frame : UDINT; rx Buffer : ARRAY[0.. MAX_PLCPRJ_RXBUFFER_SIZE] OF BYTE; END_VAR 72 Version: 1.5.1 TF6310
## Page 73

Samples Implementation Rising Edge( CLK := b Execute ); CASE e Step OF DATAEXCHA_STATE_IDLE: IF Rising Edge. Q THEN b Busy := TRUE; b Error := FALSE; n Errid := 0; cb Received := 0; fb Receive TON( IN := FALSE, PT := T#0s ); (* don't wait, read the first answer data immed iately *) fb Disconnect TON( IN := FALSE, PT := T#0s );(* disable timeout check first *) e Step := DATAEXCHA_STATE_SEND_START; END_IF DATAEXCHA_STATE_SEND_START: fb Socket Send( b Execute := FALSE ); fb Socket Send( h Socket := h Socket, p Src := ADR( s To Server ), cb Len := LEN( s To Server ) + 1,(* string length inclusive zero delimiter *) b Execute:= TRUE ); e Step := DATAEXCHA_STATE_SEND_WAIT; DATAEXCHA_STATE_SEND_WAIT: fb Socket Send( b Execute := FALSE ); IF NOT fb Socket Send.b Busy THEN IF NOT fb Socket Send.b Error THEN e Step := DATAEXCHA_STATE_RECEIVE_START; ELSE Log Error( 'FB_Socket Send (local client)', fb Socket Send.n Err Id ); n Err Id := fb Socket Send.n Err Id; e Step := DATAEXCHA_STATE_ERROR; END_IF END_IF DATAEXCHA_STATE_RECEIVE_START: fb Disconnect TON( ); fb Receive TON( IN := TRUE ); IF fb Receive TON. Q THEN fb Receive TON( IN := FALSE ); fb Socket Receive( b Execute := FALSE ); fb Socket Receive( h Socket:= h Socket, p Dest:= ADR( rx Buffer ) + cb Received, cb Len:= SIZEOF( rx Buffer ) - cb Received, b Execute:= TRUE ); e Step := DATAEXCHA_STATE_RECEIVE_WAIT; END_IF DATAEXCHA_STATE_RECEIVE_WAIT: fb Socket Receive( b Execute := FALSE ); IF NOT fb Socket Receive.b Busy THEN IF NOT fb Socket Receive.b Error THEN IF (fb Socket Receive.n Rec Bytes > 0) THEN(* bytes received *) start Pos := cb Received;(* rx Buffer array index of first data byte *) end Pos := cb Received + fb Socket Receive.n Rec Bytes - 1; (* rx Buffer array index of last data byte *) cb Received := cb Received + fb Socket Receive.n Rec Bytes; (* calculate the number of received data bytes *) cb Frame := 0;(* reset frame length *) IF cb Received < SIZEOF( s From Server ) THEN(* no overflow *) fb Receive TON( PT := T#0s ); (* bytes received => increase the read (polling) speed *) fb Disconnect TON( IN := FALSE );(* bytes received => disable timeout check *) (* search for string end delimiter *) FOR idx := start Pos TO end Pos BY 1 DO IF rx Buffer[idx] = 0 THEN(* string end delimiter found *) cb Frame := idx + 1; (* calculate the length of the received string (inclusive the end delimiter) *) MEMCPY( ADR( s From Server ), ADR( rx Buffer ), cb Frame ); (* copy the received string to the output variable (inclusive the end delimiter) *) MEMMOVE( ADR( rx Buffer ), ADR( rx Buffer[cb Frame] ), cb Received - cb Frame );(* move the reamaining data bytes *) cb Received := cb Received - cb Frame; (* recalculate the remaining data byte length *) b Busy := FALSE; e Step := DATAEXCHA_STATE_IDLE; EXIT; END_IF END_FOR TF6310 Version: 1.5.1 73
## Page 74

Samples ELSE(* there is no more free read buffer space => the answer string should be te rminated *) Log Error( 'FB_Socket Receive (local client)', PLCPRJ_ERROR_RECEIVE_BUFFER_OVE RFLOW ); n Err Id := PLCPRJ_ERROR_RECEIVE_BUFFER_OVERFLOW;(* buffer overflow !*) e Step := DATAEXCHA_STATE_ERROR; END_IF ELSE(* no bytes received *) fb Receive TON( PT := PLCPRJ_RECEIVE_POLLING_TIME ); (* no bytes received => decrease the read (polling) speed *) fb Disconnect TON( IN := TRUE, PT := PLCPRJ_RECEIVE_TIMEOUT ); (* no bytes received => enable timeout check*) IF fb Disconnect TON. Q THEN (* timeout error*) fb Disconnect TON( IN := FALSE ); Log Error( 'FB_Socket Receive (local client)', PLCPRJ_ERROR_RECEIVE_TIMEOUT ); n Err ID := PLCPRJ_ERROR_RECEIVE_TIMEOUT; e Step := DATAEXCHA_STATE_ERROR; ELSE(* repeat reading *) e Step := DATAEXCHA_STATE_RECEIVE_START; (* repeat reading *) END_IF END_IF ELSE(* receive error *) Log Error( 'FB_Socket Receive (local client)', fb Socket Receive.n Err Id ); n Err Id := fb Socket Receive.n Err Id; e Step := DATAEXCHA_STATE_ERROR; END_IF END_IF DATAEXCHA_STATE_ERROR:(* error step *) b Busy := FALSE; b Error := TRUE; cb Received := 0; e Step := DATAEXCHA_STATE_IDLE; END_CASE 6.1.1.4 PLC Server 6.1.1.4.1 FB_Local Server The server must first be allocated a unique s Local Host IP address and an n Loca Port IP port number. If the b Enable input is set, the local server will repeatedly try to open the listener socket once the SERVER_RECONNECT_TIME has elapsed. The listener socket can usually be opened at the first attempt, if the Twin CAT TCP/IP Connection Server is located on the local PC. The functionality of a remote client was encapsulated in the function block FB_Remote Client [} 76]. The remote client instances are activated once the listener socket was opened successfully. Each instance of the FB_Remote Client corresponds to a remote client, with which the local server can communicate simultaneously. The maximum number of remote clients communicating with the server can be modified via the value of the MAX_CLIENT_CONNECTIONS constant. In the event of an error, all remote client connections are closed first and then the listener socket. The n Accepted Clients output provides information about the current number of connected clients. Interface FUNCTION_BLOCK FB_Local Server VAR_INPUT s Local Host : STRING(15) := '127.0.0.1';(* own IP address! *) n Local Port : UDINT := 0; b Enable : BOOL; END_VAR VAR_OUTPUT b Listening : BOOL; h Listener : T_HSOCKET; n Accepted Clients : UDINT; b Busy : BOOL; 74 Version: 1.5.1 TF6310
## Page 75

Samples b Error : BOOL; n Err Id : UDINT; END_VAR VAR fb Listen : FB_Socket Listen := ( s Srv Net ID := '', t Timeout := DEFAULT_ADS_TIMEOUT ); fb Close : FB_Socket Close := ( s Srv Net ID := '', t Timeout := DEFAULT_ADS_TIMEOUT ); fb Connect TON : TON := ( PT := PLCPRJ_RECONNECT_TIME ); e Step : E_Server Steps; fb Remote Client : ARRAY[1.. MAX_CLIENT_CONNECTIONS ] OF FB_Remote Client; i : UDINT; END_VAR Implementation CASE e Step OF SERVER_STATE_IDLE: IF b Enable XOR b Listening THEN b Busy := TRUE; b Error := FALSE; n Err Id := 0; IF b Enable THEN fb Connect TON( IN := FALSE ); e Step := SERVER_STATE_LISTENER_OPEN_START; ELSE e Step := SERVER_STATE_REMOTE_CLIENTS_CLOSE; END_IF ELSIF b Listening THEN e Step := SERVER_STATE_REMOTE_CLIENTS_COMM; END_IF SERVER_STATE_LISTENER_OPEN_START: fb Connect TON( IN := TRUE, PT := PLCPRJ_RECONNECT_TIME ); IF fb Connect TON. Q THEN fb Connect TON( IN := FALSE ); fb Listen( b Execute := FALSE ); fb Listen( s Local Host:= s Local Host, n Local Port:= n Local Port, b Execute := TRUE ); e Step := SERVER_STATE_LISTENER_OPEN_WAIT; END_IF SERVER_STATE_LISTENER_OPEN_WAIT: fb Listen( b Execute := FALSE ); IF NOT fb Listen.b Busy THEN IF NOT fb Listen.b Error THEN b Listening := TRUE; h Listener := fb Listen.h Listener; e Step := SERVER_STATE_IDLE; Log Message( 'LISTENER socket OPENED!', h Listener ); ELSE Log Error( 'FB_Socket Listen', fb Listen.n Err Id ); n Err Id := fb Listen.n Err Id; e Step := SERVER_STATE_ERROR; END_IF END_IF SERVER_STATE_REMOTE_CLIENTS_COMM: e Step := SERVER_STATE_IDLE; n Accepted Clients := 0; FOR i:= 1 TO MAX_CLIENT_CONNECTIONS DO fb Remote Client[ i ]( h Listener := h Listener, b Enable := TRUE ); IF NOT fb Remote Client[ i ].b Busy AND fb Remote Client[ i ].b Error THEN (*FB_Socket Accept r eturned error!*) e Step := SERVER_STATE_REMOTE_CLIENTS_CLOSE; EXIT; END_IF (* count the number of connected remote clients *) IF fb Remote Client[ i ].b Accepted THEN n Accepted Clients := n Accepted Clients + 1; END_IF END_FOR SERVER_STATE_REMOTE_CLIENTS_CLOSE: n Accepted Clients := 0; e Step := SERVER_STATE_LISTENER_CLOSE_START; (* close listener socket too *) FOR i:= 1 TO MAX_CLIENT_CONNECTIONS DO fb Remote Client[ i ]( b Enable := FALSE );(* close all remote client (accepted) sockets *) (* check if all remote client sockets are closed *) IF fb Remote Client[ i ].b Accepted THEN TF6310 Version: 1.5.1 75
## Page 76

Samples e Step := SERVER_STATE_REMOTE_CLIENTS_CLOSE; (* stay here and close all remote client s first *) n Accepted Clients := n Accepted Clients + 1; END_IF END_FOR SERVER_STATE_LISTENER_CLOSE_START: fb Close( b Execute := FALSE ); fb Close( h Socket := h Listener, b Execute:= TRUE ); e Step := SERVER_STATE_LISTENER_CLOSE_WAIT; SERVER_STATE_LISTENER_CLOSE_WAIT: fb Close( b Execute := FALSE ); IF NOT fb Close.b Busy THEN Log Message( 'LISTENER socket CLOSED!', h Listener ); b Listening := FALSE; MEMSET( ADR(h Listener), 0, SIZEOF(h Listener)); IF fb Close.b Error THEN Log Error( 'FB_Socket Close (listener)', fb Close.n Err Id ); n Err Id := fb Close.n Err Id; e Step := SERVER_STATE_ERROR; ELSE b Busy := FALSE; b Error := FALSE; n Err Id := 0; e Step := SERVER_STATE_IDLE; END_IF END_IF SERVER_STATE_ERROR: b Error := TRUE; IF b Listening THEN e Step := SERVER_STATE_REMOTE_CLIENTS_CLOSE; ELSE b Busy := FALSE; e Step := SERVER_STATE_IDLE; END_IF END_CASE 6.1.1.4.2 FB_Remote Client If the b Enable input is set, an attempt is made to accept the connection request of a remote client, once the SERVER_ACCEPT_POOLING_TIME has elapsed. The data exchange with the remote client was encapsulated in a separate function block FB_Server Data Excha [} 78]. Once the connection was established successfully, the instance is enabled via the FB_Server Data Excha function block. If an error occurs, the accepted connection is closed and a new one is established. Interface FUNCTION_BLOCK FB_Remote Client VAR_INPUT h Listener : T_HSOCKET; b Enable : BOOL; END_VAR VAR_OUTPUT b Accepted : BOOL; h Socket : T_HSOCKET; b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s From Client : T_Max String; END_VAR VAR fb Accept : FB_Socket Accept := ( s Srv Net ID := '', t Timeout := DEFAULT_ADS_TIMEOUT ); 76 Version: 1.5.1 TF6310
## Page 77

Samples fb Close : FB_Socket Close := ( s Srv Net ID := '', t Timeout := DEFAULT_ADS_TIMEOUT ); fb Server Data Excha : FB_Server Data Excha; fb Accept TON : TON := ( PT := PLCPRJ_ACCEPT_POLLING_TIME ); e Step : E_Client Steps; END_VAR Implementation CASE e Step OF CLIENT_STATE_IDLE: IF b Enable XOR b Accepted THEN b Busy := TRUE; b Error := FALSE; n Err Id := 0; s From Client := ''; IF b Enable THEN fb Accept TON( IN := FALSE ); e Step := CLIENT_STATE_CONNECT_START; ELSE e Step := CLIENT_STATE_CLOSE_START; END_IF ELSIF b Accepted THEN e Step := CLIENT_STATE_DATAEXCHA_START; ELSE b Busy := FALSE; END_IF CLIENT_STATE_CONNECT_START: fb Accept TON( IN := TRUE, PT := PLCPRJ_ACCEPT_POLLING_TIME ); IF fb Accept TON. Q THEN fb Accept TON( IN := FALSE ); fb Accept( b Execute := FALSE ); fb Accept( h Listener := h Listener, b Execute:= TRUE ); e Step := CLIENT_STATE_CONNECT_WAIT; END_IF CLIENT_STATE_CONNECT_WAIT: fb Accept( b Execute := FALSE ); IF NOT fb Accept.b Busy THEN IF NOT fb Accept.b Error THEN IF fb Accept.b Accepted THEN b Accepted := TRUE; h Socket := fb Accept.h Socket; Log Message( 'REMOTE client ACCEPTED!', h Socket ); END_IF e Step := CLIENT_STATE_IDLE; ELSE Log Error( 'FB_Socket Accept', fb Accept.n Err Id ); n Err Id := fb Accept.n Err Id; e Step := CLIENT_STATE_ERROR; END_IF END_IF CLIENT_STATE_DATAEXCHA_START: fb Server Data Excha( b Execute := FALSE ); fb Server Data Excha( h Socket := h Socket, b Execute := TRUE ); e Step := CLIENT_STATE_DATAEXCHA_WAIT; CLIENT_STATE_DATAEXCHA_WAIT: fb Server Data Excha( b Execute := FALSE, s From Client=>s From Client ); IF NOT fb Server Data Excha.b Busy THEN IF NOT fb Server Data Excha.b Error THEN e Step := CLIENT_STATE_IDLE; ELSE (* possible errors are logged inside of fb Server Data Excha function block *) n Err Id := fb Server Data Excha.n Err ID; e Step := CLIENT_STATE_ERROR; END_IF END_IF CLIENT_STATE_CLOSE_START: fb Close( b Execute := FALSE ); fb Close( h Socket:= h Socket, b Execute:= TRUE ); e Step := CLIENT_STATE_CLOSE_WAIT; CLIENT_STATE_CLOSE_WAIT: TF6310 Version: 1.5.1 77
## Page 78

Samples fb Close( b Execute := FALSE ); IF NOT fb Close.b Busy THEN Log Message( 'REMOTE client CLOSED!', h Socket ); b Accepted := FALSE; MEMSET( ADR( h Socket ), 0, SIZEOF( h Socket ) ); IF fb Close.b Error THEN Log Error( 'FB_Socket Close (remote client)', fb Close.n Err Id ); n Err Id := fb Close.n Err Id; e Step := CLIENT_STATE_ERROR; ELSE b Busy := FALSE; b Error := FALSE; n Err Id := 0; e Step := CLIENT_STATE_IDLE; END_IF END_IF CLIENT_STATE_ERROR: b Error := TRUE; IF b Accepted THEN e Step := CLIENT_STATE_CLOSE_START; ELSE e Step := CLIENT_STATE_IDLE; b Busy := FALSE; END_IF END_CASE 6.1.1.4.3 FB_Server Data Excha In the event of an rising edge at the b Execute input, a zero-terminated string is read by the remote client and returned to the remote client, if zero termination was detected. The function block will try reading the data until zero termination was detected in the string received. Reception is aborted in the event of an error, and if no new data were received within the PLCPRJ_RECEIVE_TIMEOUT timeout time. Data are attempted to be read again after a certain delay time, if no new data could be read during the last read attempt. This reduces the system load. Interface FUNCTION_BLOCK FB_Server Data Excha VAR_INPUT h Socket : T_HSOCKET; b Execute : BOOL; END_VAR VAR_OUTPUT b Busy : BOOL; b Error : BOOL; n Err ID : UDINT; s From Client : T_Max String; END_VAR VAR fb Socket Receive : FB_Socket Receive := ( s Srv Net Id := '', t Timeout := DEFAULT_ADS_TIMEOUT ); fb Socket Send : FB_Socket Send := ( s Srv Net Id := '', t Timeout := DEFAULT_ADS_TIMEOUT ); e Step : E_Data Excha Steps; Rising Edge : R_TRIG; fb Receive TON : TON; fb Disconnect TON : TON; cb Received, start Pos, end Pos, idx : UDINT; cb Frame : UDINT; rx Buffer : ARRAY[0.. MAX_PLCPRJ_RXBUFFER_SIZE] OF BYTE; END_VAR Implementation Rising Edge( CLK := b Execute ); CASE e Step OF DATAEXCHA_STATE_IDLE: 78 Version: 1.5.1 TF6310
## Page 79

Samples IF Rising Edge. Q THEN b Busy := TRUE; b Error := FALSE; n Err Id := 0; fb Disconnect TON( IN := FALSE, PT := T#0s );(* disable timeout check first *) fb Receive TON( IN := FALSE, PT := T#0s ); (* receive first request immediately *) e Step := DATAEXCHA_STATE_RECEIVE_START; END_IF DATAEXCHA_STATE_RECEIVE_START: (* Receive remote client data *) fb Receive TON( IN := TRUE ); IF fb Receive TON. Q THEN fb Receive TON( IN := FALSE ); fb Socket Receive( b Execute := FALSE ); fb Socket Receive( h Socket := h Socket, p Dest := ADR( rx Buffer ) + cb Received, cb Len := SIZEOF( rx Buffer ) - cb Received, b Execute := TRUE ); e Step := DATAEXCHA_STATE_RECEIVE_WAIT; END_IF DATAEXCHA_STATE_RECEIVE_WAIT: fb Socket Receive( b Execute := FALSE ); IF NOT fb Socket Receive.b Busy THEN IF NOT fb Socket Receive.b Error THEN IF (fb Socket Receive.n Rec Bytes > 0) THEN(* bytes received *) start Pos := cb Received;(* rx Buffer array index of first data byte *) end Pos := cb Received + fb Socket Receive.n Rec Bytes - 1; (* rx Buffer array index of last data byte *) cb Received := cb Received + fb Socket Receive.n Rec Bytes; (* calculate the number of received data bytes *) cb Frame := 0;(* reset frame length *) IF cb Received < SIZEOF( s From Client ) THEN(* no overflow *) fb Receive TON( IN := FALSE, PT := T#0s ); (* bytes received => increase the r ead (polling) speed *) fb Disconnect TON( IN := FALSE, PT := PLCPRJ_RECEIVE_TIMEOUT ); (* bytes received => disable timeout check *) (* search for string end delimiter *) FOR idx := start Pos TO end Pos BY 1 DO IF rx Buffer[idx] = 0 THEN(* string end delimiter found *) cb Frame := idx + 1; (* calculate the length of the received string (inclusive the end delimiter) *) MEMCPY( ADR( s From Client ), ADR( rx Buffer ), cb Frame ); (* copy the received string to the output variable (inclusive the end delimiter) *) MEMMOVE( ADR( rx Buffer ), ADR( rx Buffer[cb Frame] ), cb Received - cb Frame );(* move the reamaining data bytes *) cb Received := cb Received - cb Frame; (* recalculate the reamaining data byte length *) e Step := DATAEXCHA_STATE_SEND_START; EXIT; END_IF END_FOR ELSE(* there is no more free read buffer space => the answer string should be te rminated *) Log Error( 'FB_Socket Receive (remote client)', PLCPRJ_ERROR_RECEIVE_BUFFER_OV ERFLOW ); n Err Id := PLCPRJ_ERROR_RECEIVE_BUFFER_OVERFLOW;(* buffer overflow !*) e Step := DATAEXCHA_STATE_ERROR; END_IF ELSE(* no bytes received *) fb Receive TON( IN := FALSE, PT := PLCPRJ_RECEIVE_POLLING_TIME ); (* no bytes received => decrease the read (polling) speed *) fb Disconnect TON( IN := TRUE, PT := PLCPRJ_RECEIVE_TIMEOUT ); (* no bytes received => enable timeout check*) IF fb Disconnect TON. Q THEN (* timeout error*) fb Disconnect TON( IN := FALSE ); Log Error( 'FB_Socket Receive (remote client)', PLCPRJ_ERROR_RECEIVE_TI MEOUT ); n Err ID := PLCPRJ_ERROR_RECEIVE_TIMEOUT; e Step := DATAEXCHA_STATE_ERROR; ELSE(* repeat reading *) e Step := DATAEXCHA_STATE_RECEIVE_START; (* repeat reading *) END_IF TF6310 Version: 1.5.1 79
## Page 80

Samples END_IF ELSE(* receive error *) Log Error( 'FB_Socket Receive (remote client)', fb Socket Receive.n Err Id ); n Err Id := fb Socket Receive.n Err Id; e Step := DATAEXCHA_STATE_ERROR; END_IF END_IF DATAEXCHA_STATE_SEND_START: fb Socket Send( b Execute := FALSE ); fb Socket Send( h Socket := h Socket, p Src := ADR( s From Client ), cb Len := LEN( s From Client ) + 1, (* string length inclusive the zero delimiter *) b Execute:= TRUE ); e Step := DATAEXCHA_STATE_SEND_WAIT; DATAEXCHA_STATE_SEND_WAIT: fb Socket Send( b Execute := FALSE ); IF NOT fb Socket Send.b Busy THEN IF NOT fb Socket Send.b Error THEN b Busy := FALSE; e Step := DATAEXCHA_STATE_IDLE; ELSE Log Error( 'fb Socket Send (remote client)', fb Socket Send.n Err Id ); n Err Id := fb Socket Send.n Err Id; e Step := DATAEXCHA_STATE_ERROR; END_IF END_IF DATAEXCHA_STATE_ERROR: b Busy := FALSE; b Error := TRUE; cb Received := 0;(* reset old received data bytes *) e Step := DATAEXCHA_STATE_IDLE; END_CASE 6.1.1.5 . NET client This sample project shows how a client for the PLC TCP/IP server can be realized under . NET4.0 in C#. 80 Version: 1.5.1 TF6310
## Page 81

Samples The sample uses the . NET libraries System. Net and System. Net. Sockets, with which a programmer can easily use socket functions. Pressing Enable causes the application to cyclically (depending on the value of TIMERTICK in [ms]) attempt to establish a connection to the server. If successful, a string with a maximum length of 255 characters can be sent to the server via the Send button. This string is then accepted by the server and sent back to the client. The connection is automatically closed on the server side after the SERVER_RECEIVE_TIMEOUT time defined in the server sample has expired, default: 50 seconds, if the server was unable to receive any new data from the client within this time. using System; using System. Collections. Generic; using System. Component Model; using System. Data; using System. Drawing; using System. Text; using System. Windows. Forms; using System. Net; using System. Net. Sockets; /* ########################################################################################## * This sample TCP/IP client connects to a TCP/IP-Server, sends a message and waits for the * response. It is being delivered together with our TCP-Sample, which implements an echo server * in PLC. * ########################################################################################## */ namespace Tcp Ip Server_Sample Client { publicpartialclass Form1 : Form { / * ########################################################################################## * Constants * ########################################################################################## */ TF6310 Version: 1.5.1 81
## Page 82

Samples privateconstint RCVBUFFERSIZE = 256; // buffer size for receive bufferprivateconststring DEFAULTIP = "127.0.0.1"; privateconststring DEFAULTPORT = "200"; privateconstint TIMERTICK = 100; / * ########################################################################################## * Global variables * ########################################################################################## */ privatestaticbool _is Connected; // signals whether socket connection is active or notprivatestatic So cket _socket; // object used for socket connection to TCP/IP- Serverprivatestatic IPEnd Point _ip Address; // contains IP address as entered in text fieldprivatestat icbyte[] _rcv Buffer; // receive buffer used for receiving response from TCP/IP-Serverpublic Form1() { Initialize Component(); } privatevoid Form1_Load(object sender, Event Args e) { _rcv Buffer = newbyte[RCVBUFFERSIZE]; / * ########################################################################################## * Prepare GUI * ########################################################################################## */ cmd_send. Enabled = false; cmd_enable. Enabled = true; cmd_disable. Enabled = false; rtb_rcv Msg. Enabled = false; rtb_send Msg. Enabled = false; rtb_stat Msg. Enabled = false; txt_host. Text = DEFAULTIP; txt_port. Text = DEFAULTPORT; timer1. Enabled = false; timer1. Interval = TIMERTICK; _is Connected = false; } privatevoid cmd_enable_Click(object sender, Event Args e) { / * ########################################################################################## * Parse IP address in text field, start background timer and prepare GUI * ########################################################################################## */ try { _ip Address = new IPEnd Point(IPAddress. Parse(txt_host. Text), Convert. To Int32(txt_port. Text)); timer1. Enabled = true; cmd_enable. Enabled = false; cmd_disable. Enabled = true; rtb_send Msg. Enabled = true; cmd_send. Enabled = true; txt_host. Enabled = false; txt_port. Enabled = false; rtb_send Msg. Focus(); } catch (Exception ex) { Message Box. Show("Could not parse entered IP address. Please check spelling and retry. " + ex ); } } / * ########################################################################################## * Timer periodically checks for connection to TCP/IP- Server and reestablishes if not connected * ########################################################################################## */ privatevoid timer1_Tick(object sender, Event Args e) { if (!_is Connected) connect(); } privatevoid connect() { / * ########################################################################################## * Connect to TCP/IP-Server using the IP address specified in the text field 82 Version: 1.5.1 TF6310
## Page 83

Samples * ########################################################################################## */ try { _socket = new Socket(Address Family. Inter Network, Socket Type. Stream, Protocol Type. IP); _socket. Connect(_ip Address); _is Connected = true; if (_socket. Connected) rtb_stat Msg. Append Text(Date Time. Now. To String() + ": Connectection to host established!\n"); else rtb_stat Msg. Append Text(Date Time. Now. To String() + ": A connection to the host could not be e stablished!\n"); } catch (Exception ex) { Message Box. Show("An error occured while establishing a connection to the server: " + ex); } } privatevoid cmd_send_Click(object sender, Event Args e) { / * ########################################################################################## * Read message from text field and prepare send buffer, which is a byte[] array. The last * character in the buffer needs to be a termination character, so that the TCP/IP- Server knows * when the TCP stream ends. In this case, the termination character is '0'. * ########################################################################################## */ ASCIIEncoding enc = new ASCIIEncoding(); byte[] temp Buffer = enc. Get Bytes(rtb_send Msg. Text); byte[] send Buffer = newbyte[temp Buffer. Length + 1]; for (int i = 0; i < temp Buffer. Length; i++) send Buffer[i] = temp Buffer[i]; send Buffer[temp Buffer. Length] = 0; / * ########################################################################################## * Send buffer content via TCP/IP connection * ########################################################################################## */ try { int send = _socket. Send(send Buffer); if (send == 0) thrownew Exception(); else { / * ########################################################################################## * As the TCP/IP- Server returns a message, receive this message and store content in receive buffer. * When message receive is complete, show the received message in text field. * ######################################################################################### # */ rtb_stat Msg. Append Text(Date Time. Now. To String() + ": Message successfully sent!\n"); IAsync Result asyn Res = _socket. Begin Receive(_rcv Buffer, 0, 256, Socket Flags. None, null, nul l); if (asyn Res. Async Wait Handle. Wait One()) { int res = _socket. End Receive(asyn Res); char[] res Chars = newchar[res + 1]; Decoder d = Encoding. UTF8. Get Decoder(); int char Length = d. Get Chars(_rcv Buffer, 0, res, res Chars, 0, true); String result = new String(res Chars); rtb_rcv Msg. Append Text("\n" + Date Time. Now. To String() + ": " + result); rtb_send Msg. Clear(); } } } catch (Exception ex) { Message Box. Show("An error occured while sending the message: " + ex); } } privatevoid cmd_disable_Click(object sender, Event Args e) { / * ########################################################################################## * Disconnect from TCP/IP-Server, stop the timer and prepare GUI * ########################################################################################## */ TF6310 Version: 1.5.1 83
## Page 84

Samples timer1. Enabled = false; _socket. Disconnect(true); if (!_socket. Connected) { _is Connected = false; cmd_disable. Enabled = false; cmd_enable. Enabled = true; txt_host. Enabled = true; txt_port. Enabled = true; rtb_send Msg. Enabled = false; cmd_send. Enabled = false; rtb_stat Msg. Append Text(Date Time. Now. To String() + ": Connectection to host closed!\n"); rtb_rcv Msg. Clear(); rtb_stat Msg. Clear(); } } } } 6.1.2 Sample02: “Echo“ client /server This sample uses the functions of the former Tc Socket Helper. Lib, which is now integrated into the Tc2_Tcp Ip library. It shows a client/server PLC application based on the functions of the former Socket Helper library. The client cyclically sends a test string (s To Server) to the remote server. The server returns this string unchanged to the client (s From Server). System requirements • Twin CAT 3 Build 3093 or higher • Twin CAT 3 Function TF6310 TCP/IP • If two computers are used to execute the sample (one client and one server), the Function TF6310 needs to be installed on both computers • If one computer is used to execute the sample, e.g. client and server running in two separate PLC runtimes, both PLC runtimes need to run in separate tasks. Project downloads https://github.com/Beckhoff/TF6310_Samples/tree/master/PLC/TCP/Sample02 Project information The default communication settings used in the above samples are as follows: • PLC client application: Port and IP address of the remote server: 200, '127.0.0.1' 84 Version: 1.5.1 TF6310
## Page 85

Samples • PLC server application: Port and IP address of the local server: 200, '127.0.0.1' To test the client and server application on two different PCs, you have to adjust the port and the IP address accordingly. However, you can also test the client and server samples with the default values on a single computer by loading the client application into the first PLC runtime system and the server application into the second PLC runtime system. The behavior of the PLC project sample is determined by the following global variables/constants. Constant Value Description PLCPRJ_MAX_CONNECTIONS 5 Max. number of server → client connections. A server can establish connections to more than one client. A client can establish a connection to only one server at a time. PLCPRJ_SERVER_RESPONSE_ T#10s Max. delay time (timeout time) after which a server TIMEOUT should send a response to the client. PLCPRJ_CLIENT_SEND_CYCLE_ T#1s Cycle time based on which a client sends send data TIME (TX) to the server. PLCPRJ_RECEIVER_POLLING_C T#200ms Cycle time based on which a client or server polls for YCLE_TIME receive data (RX). PLCPRJ_BUFFER_SIZE 10000 Max. internal buffer size for RX/TX data. The PLC samples define and use the following internal error codes: Error code Value Description PLCPRJ_ERROR_RECEIVE_BUF 16#8101 The internal receive buffer reports an overflow. FER_OVERFLOW PLCPRJ_ERROR_SEND_BUFFE 16#8102 The internal send buffer reports an overflow. R_OVERFLOW PLCPRJ_ERROR_RESPONSE_TI 16#8103 The server has not sent the response within the MEOUT specified timeout time. PLCPRJ_ERROR_INVALID_FRA 16#8104 The telegram formatting is incorrect (size, faulty data ME_FORMAT bytes etc.). The client and server applications (FB_Server Application, FB_Client Application) were implemented as function blocks. The application and the connection can thus be instanced repeatedly. 6.1.3 Sample03: “Echo” client/server This sample uses the functions of the former Tc Socket Helper. Lib, which is now integrated into the Tc2_Tcp Ip library. It shows a client/server PLC application based on the functions of the former Socket Helper library. The client cyclically sends a test string (s To Server) to the remote server. The server returns this string unchanged to the client (s From Server). The difference between this sample and Sample02 is that the server can establish up to five connections and the client application can start up to five client instances. Each instance establishes a connection to the server. TF6310 Version: 1.5.1 85
## Page 86

Samples System requirements • Twin CAT 3 Build 3093 or higher • Twin CAT 3 Function TF6310 TCP/IP • If two computers are used to execute the sample (one client and one server), the Function TF6310 needs to be installed on both computers • If one computer is used to execute the sample, e.g. client and server running in two separate PLC runtimes, both PLC runtimes need to run in separate tasks Project downloads https://github.com/Beckhoff/TF6310_Samples/tree/master/PLC/TCP/Sample03 Project information The default communication settings used in the above samples are as follows: • PLC client application: Port and IP address of the remote server: 200, '127.0.0.1' • PLC server application: Port and IP address of the local server: 200, '127.0.0.1' To test the client and server application on two different PCs, you have to adjust the port and the IP address accordingly. However, you can also test the client and server samples with the default values on a single computer by loading the client application into the first PLC runtime system and the server application into the second PLC runtime system. The behavior of the PLC project sample is determined by the following global variables/constants. Constant Value Description PLCPRJ_MAX_CONNECTIONS 5 Max. number of server->client connections. A server can establish connections to more than one client. A client can establish a connection to only one server at a time. PLCPRJ_SERVER_RESPONSE_ T#10s Max. delay time (timeout time) after which a server TIMEOUT should send a response to the client. PLCPRJ_CLIENT_SEND_CYCLE_ T#1s Cycle time based on which a client sends send data TIME (TX) to the server. PLCPRJ_RECEIVER_POLLING_C T#200ms Cycle time based on which a client or server polls for YCLE_TIME receive data (RX). PLCPRJ_BUFFER_SIZE 10000 Max. internal buffer size for RX/TX data. 86 Version: 1.5.1 TF6310
## Page 87

Samples The PLC samples define and use the following internal error codes: Error code Value Description PLCPRJ_ERROR_RECEIVE_BUF 16#8101 The internal receive buffer reports an overflow. FER_OVERFLOW PLCPRJ_ERROR_SEND_BUFFE 16#8102 The internal send buffer reports an overflow. R_OVERFLOW PLCPRJ_ERROR_RESPONSE_TI 16#8103 The server has not sent the response within the MEOUT specified timeout time. PLCPRJ_ERROR_INVALID_FRA 16#8104 The telegram formatting is incorrect (size, faulty data ME_FORMAT bytes etc.). The client and server applications (FB_Server Application, FB_Client Application) were implemented as function blocks. The application and the connection can thus be instanced repeatedly. 6.1.4 Sample04: Binary data exchange This sample uses the functions of the former Tc Socket Helper. Lib, which is now integrated into the Tc2_Tcp Ip library. It shows a client/server PLC application based on the functions of the former Socket Helper library. This sample provides a client-server application for the exchange of binary data. A simple sample protocol has been implemented for this purpose. The length of the binary data and a frame counter for the sent and received telegrams are transferred in the protocol header. The structure of the binary data is defined by the PLC structure ST_Application Binary Data. The binary data are appended to the header and transferred. The instances of the binary structure are called to Server, from Server on the client side and to Client, from Client on the server side. The structure declaration on the client and server sides can be adapted as required. The structure declaration must be identical on both sides. The maximum size of the structure must not exceed the maximum buffer size of the send/receive Fifos. The maximum buffer size is defined by a constant. The server functionality is implemented in the function block FB_Server Application and the client functionality in the function block FB_Client Application. In the standard implementation the client cyclically sends the data of the binary structure to the server and waits for a response from the server. The server modifies some data and returns them to the client. If you require a specific function, you must modify the function blocks FB_Server Application and FB_Client Application accordingly. TF6310 Version: 1.5.1 87
## Page 88

Samples System requirements • Twin CAT 3 Build 3093 or higher • Twin CAT 3 Function TF6310 TCP/IP • If two computers are used to execute the sample (one client and one server), the Function TF6310 needs to be installed on both computers • If one computer is used to execute the sample, e.g. client and server running in two separate PLC runtimes, both PLC runtimes need to run in separate tasks. Project downloads https://github.com/Beckhoff/TF6310_Samples/tree/master/PLC/TCP/Sample04 Project information The default communication settings used in the above samples are as follows: • PLC client application: Port and IP address of the remote server: 200, '127.0.0.1' • PLC server application: Port and IP address of the local server: 200, '127.0.0.1' To test the client and server application on two different PCs, you have to adjust the port and the IP address accordingly. However, you can also test the client and server samples with the default values on a single computer by loading the client application into the first PLC runtime system and the server application into the second PLC runtime system. The behavior of the PLC project sample is determined by the following global variables/constants. Constant Value Description PLCPRJ_MAX_CONNECTIONS 5 Max. number of server->client connections. A server can establish connections to more than one client. A client can establish a connection to only one server at a time. PLCPRJ_SERVER_RESPONSE_ T#10s Max. delay time (timeout time) after which a server TIMEOUT should send a response to the client. PLCPRJ_CLIENT_SEND_CYCLE_ T#1s Cycle time based on which a client sends send data TIME (TX) to the server. PLCPRJ_RECEIVER_POLLING_C T#200ms Cycle time based on which a client or server polls for YCLE_TIME receive data (RX). PLCPRJ_BUFFER_SIZE 10000 Max. internal buffer size for RX/TX data. The PLC samples define and use the following internal error codes: Error code Value Description PLCPRJ_ERROR_RECEIVE_BUF 16#8101 The internal receive buffer reports an overflow. FER_OVERFLOW PLCPRJ_ERROR_SEND_BUFFE 16#8102 The internal send buffer reports an overflow. R_OVERFLOW PLCPRJ_ERROR_RESPONSE_TI 16#8103 The server has not sent the response within the MEOUT specified timeout time. PLCPRJ_ERROR_INVALID_FRA 16#8104 The telegram formatting is incorrect (size, faulty data ME_FORMAT bytes etc.). The client and server applications (FB_Server Application, FB_Client Application) were implemented as function blocks. The application and the connection can thus be instanced repeatedly. 88 Version: 1.5.1 TF6310
## Page 89

Samples 6.1.5 Sample05: Binary data exchange This sample uses the functions of the former Tc Socket Helper. Lib, which is now integrated into the Tc2_Tcp Ip library. It shows a client/server PLC application based on the functions of the former Socket Helper library. This sample provides a client-server application for the exchange of binary data. A simple sample protocol has been implemented for this purpose. The length of the binary data and a frame counter for the sent and received telegrams are transferred in the protocol header. The structure of the binary data is defined by the PLC structure ST_Application Binary Data. The binary data are appended to the header and transferred. The instances of the binary structure are called to Server, from Server on the client side and to Client, from Client on the server side. The structure declaration on the client and server sides can be adapted as required. The structure declaration must be identical on both sides. The maximum size of the structure must not exceed the maximum buffer size of the send/receive Fifos. The maximum buffer size is defined by a constant. The server functionality is implemented in the function block FB_Server Application and the client functionality in the function block FB_Client Application. In the standard implementation the client cyclically sends the data of the binary structure to the server and waits for a response from the server. The server modifies some data and returns them to the client. If you require a specific function, you must modify the function blocks FB_Server Application and FB_Client Application accordingly. The difference between this sample and Sample04 is that the server can establish up to 5 connections and the client application can have up to five client instances. Each instance establishes a connection to the server. System requirements • Twin CAT 3 Build 3093 or higher • Twin CAT 3 Function TF6310 TCP/IP • If two computers are used to execute the sample (one client and one server), the Function TF6310 needs to be installed on both computers • If one computer is used to execute the sample, e.g. client and server running in two separate PLC runtimes, both PLC runtimes need to run in separate tasks. Project downloads https://github.com/Beckhoff/TF6310_Samples/tree/master/PLC/TCP/Sample05 TF6310 Version: 1.5.1 89
## Page 90

Samples Project information The default communication settings used in the above samples are as follows: • PLC client application: Port and IP address of the remote server: 200, '127.0.0.1' • PLC server application: Port and IP address of the local server: 200, '127.0.0.1' To test the client and server application on two different PCs, you have to adjust the port and the IP address accordingly. However, you can also test the client and server samples with the default values on a single computer by loading the client application into the first PLC runtime system and the server application into the second PLC runtime system. The behavior of the PLC project sample is determined by the following global variables/constants. Constant Value Description PLCPRJ_MAX_CONNECTIONS 5 Max. number of server->client connections. A server can establish connections to more than one client. A client can establish a connection to only one server at a time. PLCPRJ_SERVER_RESPONSE_ T#10s Max. delay time (timeout time) after which a server TIMEOUT should send a response to the client. PLCPRJ_CLIENT_SEND_CYCLE_ T#1s Cycle time based on which a client sends send data (TX) TIME to the server. PLCPRJ_RECEIVER_POLLING_C T#200ms Cycle time based on which a client or server polls for YCLE_TIME receive data (RX). PLCPRJ_BUFFER_SIZE 10000 Max. internal buffer size for RX/TX data. The PLC samples define and use the following internal error codes: Error code Value Description PLCPRJ_ERROR_RECEIVE_BUF 16#8101 The internal receive buffer reports an overflow. FER_OVERFLOW PLCPRJ_ERROR_SEND_BUFFE 16#8102 The internal send buffer reports an overflow. R_OVERFLOW PLCPRJ_ERROR_RESPONSE_TI 16#8103 The server has not sent the response within the specified MEOUT timeout time. PLCPRJ_ERROR_INVALID_FRA 16#8104 The telegram formatting is incorrect (size, faulty data ME_FORMAT bytes etc.). The client and server applications (FB_Server Application, FB_Client Application) were implemented as function blocks. The application and the connection can thus be instanced repeatedly. 6.1.6 Sample06: "Echo" client/server with TLS (basic modules) The following sample is essentially based on Sample01 and shows an exemplary implementation of an "Echo" client/server system. The client sends a test string to the server at certain intervals (e.g. every second). The remote server sends this string back to the client. In contrast to Sample01, the communication connection in this sample is secured via TLS with client/server certificates. The certificates are not part of the sample and must be created by the user. In essence, this sample thus illustrates the use of the function blocks FB_Tls Socket Connect [} 38], FB_Tls Socket Create [} 41], FB_Tls Socket Listen [} 40], FB_Tls Socket Add Ca [} 42], FB_Tls Socket Add Crl [} 43], and FB_Tls Socket Set Cert [} 44]. These were integrated accordingly into the state machine of the client and server sample from Sample01. Project downloads https://github.com/Beckhoff/TF6310_Samples/tree/master/PLC/TCP/Sample06 90 Version: 1.5.1 TF6310
## Page 91

Samples 6.1.7 Sample07: "Echo" client/server with TLS-PSK (basic modules) The following sample is essentially based on Sample01 and shows an exemplary implementation of an "Echo" client/server system. The client sends a test string to the server at certain intervals (e.g. every second). The remote server sends this string back to the client. In contrast to Sample01, the communication connection in this sample is secured via TLS with a pre-shared key (PSK). In essence, this sample thus illustrates the use of the function blocks FB_Tls Socket Connect [} 38], FB_Tls Socket Create [} 41], FB_Tls Socket Listen [} 40], and FB_Tls Socket Set Psk [} 45]. These were integrated accordingly into the state machine of the client and server sample from Sample01. Project downloads https://github.com/Beckhoff/TF6310_Samples/tree/master/PLC/TCP/Sample07 6.2 UDP 6.2.1 Sample01: Peer-to-peer communication 6.2.1.1 Overview The following example demonstrates the implementation of a simple Peer-to-Peer application in the PLC and consists of two PLC projects (Peer A and Peer B) plus a . NET application which also acts as a separate peer. All peer applications send a test string to a remote peer and at the same time receive strings from a remote peer. The received strings are displayed in a message box on the monitor of the target computer. Feel free to use and customize this sample to your needs. System requirements • Twin CAT 3 Build 3093 or higher • Twin CAT 3 Function TF6310 TCP/IP • If two computers are used to execute the sample, the Function TF6310 needs to be installed on both computers • If one computer is used to execute the sample, e.g. Peer A und Peer B running in two separate PLC runtimes, both PLC runtimes need to run in separate tasks • To run the . NET sample client, only . NET Framework 4.0 is needed Project downloads The sources of the two PLC devices only differ in terms of different IP addresses of the remote communication partners. https://github.com/Beckhoff/TF6310_Samples/tree/master/PLC/UDP/Sample01 https://github.com/Beckhoff/TF6310_Samples/tree/master/C%23/Sample Client Udp Project description The following links provide documentation for each component. Additionally, an own article explains how to start the PLC samples with step-by-step instructions. • Integration in Twin CAT and Test [} 93] (Starting the PLC samples) • PLC devices A and B [} 94] (Peer-to-Peer PLC application) • . NET communication [} 97] (. NET sample client) TF6310 Version: 1.5.1 91
## Page 92

Samples Additional functions of the PLC sample projects Some functions, constants and function blocks are used in the PLC samples, which are briefly described below: Fifo function block FUNCTION_BLOCK FB_Fifo VAR_INPUT new : ST_Fifo Entry; END_VAR VAR_OUTPUT b Ok : BOOL; old : ST_Fifo Entry; END_VAR This is a simple Fifo function block. One instance of this function block is used as "send Fifo", another one as "receive Fifo". The messages to be sent are stored in the send Fifo, the received messages are stored in the receive Fifo. The b Ok output variable is set to FALSE if errors occurred during the last action (Add Tail or Remove Head) (Fifo empty or overfilled). A Fifo entry consists of the following components: TYPE ST_Fifo Entry : STRUCT s Remote Host : STRING(15); (* Remote address. String containing an (Ipv4) Internet Protocol dotte d address. *) n Remote Port : UDINT; (* Remote Internet Protocol (IP) port. *) msg : STRING; (* Udp packet data *) END_STRUCT END_TYPE Log Error function FUNCTION Log Error : DINT The function writes a message with the error code into the logbook of the operating system (Event Viewer). The global variable b Log Debug Messages must first be set to TRUE. Log Message function FUNCTION Log Message : DINT The function writes a message into the logbook of the operating system (Event Viewer) if a new socket was opened or closed. The global variable b Log Debug Messages must first be set to TRUE. SCODE_CODE function FUNCTION SCODE_CODE : DWORD The function masks the least significant 16 bits of a Win32 error code returns them. 92 Version: 1.5.1 TF6310
## Page 93

Samples 6.2.1.2 Integration in Twin CAT and Test The PLC samples are provided as Twin CAT 3 PLC project files. To import a PLC project into Twin CAT XAE, first create a new Twin CAT 3 Solution. Then select the Add Existing Item command in the context menu of the PLC node and select the downloaded sample file (Plc 3.x Project archive (*.tpzip)) as the file type in the dialog that opens. After confirming the dialog, the PLC project is added to the Solution. Two computers are required to start the sample. Alternatively, the test may be carried out with two runtime systems on a single PC. The constants with the port numbers and the IP addresses of the communication partners have to be modified accordingly. Sample configuration with two computers: • Device A is located on the local PC and has the IP address '10.1.128.21' • Device B is located on the remote PC and has the IP address '172.16.6.195'. Device A Please perform the following steps to configure the sample on device A: • Create a new Twin CAT 3 solution in Twin CAT XAE and import the Peer-to-Peer PLC project for device A. • Set the constant REMOTE_HOST_IP in POU MAIN to the real IP address of the remote system (device B - in our example: '10.1.128.'). • Activate the configuration and start the PLC runtime. (Don't forget to create a license for TF6310 TCP/ IP) Device B To install the sample on device B, proceed as follows: • Create a new Twin CAT 3 Solution in Twin CAT XAE and import the peer-to-peer PLC project for device B. • Adapt the constant REMOTE_HOST_IP in POU MAIN to the actual IP address of device A (in our sample '10.1.128.21'). • Enable the configuration and start the PLC runtime. (Do not forget to generate a license for TF6310 TCP/IP beforehand) • Log in to the PLC runtime and set the Boolean variable b Send Once To Remote to TRUE in the POU "MAIN". • A message box should appear on device A shortly afterwards. You can now repeat this step on device A. The message box should now appear on device B. TF6310 Version: 1.5.1 93
## Page 94

Samples 6.2.1.3 PLC devices A and B The required functionality was encapsulated in the function block FB_Peer To Peer. Each of the communication partners uses an instance of the FB_Peer To Peer function block. The block is activated through a rising edge at the b Enable input. A new UDP socket is opened, and data exchange commences. The socket address is specified via the variables s Local Host and n Local Port. A falling edge stops the data exchange and closes the socket. The data to be sent are transferred to the block through a reference (VAR_IN_OUT) via the variable send Fifo. The data received are stored in the variable receive Fifo. Name Default value Description g_s Tc Ip Conn Svr Addr '' Network address of the Twin CAT TCP/IP Connection Server. Default: Empty string (the server is located on the local PC); b Log Debug Messages TRUE Activates/deactivates writing of messages into the log book of the operating system; PLCPRJ_ERROR_SENDFIFO_OV 16#8103 Sample project error code: The send Fifo is full. ERFLOW PLCPRJ_ERROR_RECFIFO_OVE 16#8104 Sample project error code: The receive Fifo is full. RFLOW FUNCTION_BLOCK FB_Peer To Peer Interface VAR_IN_OUT send Fifo : FB_Fifo; receive Fifo : FB_Fifo; END_VAR VAR_INPUT s Local Host : STRING(15); n Local Port : UDINT; b Enable : BOOL; END_VAR VAR_OUTPUT b Created : BOOL; b Busy : BOOL; b Error : BOOL; n Err Id : UDINT; END_VAR VAR fb Create : FB_Socket Udp Create; 94 Version: 1.5.1 TF6310
## Page 95

Samples fb Close : FB_Socket Close; fb Receive From : FB_Socket Udp Receive From; fb Send To : FB_Socket Udp Send To; h Socket : T_HSOCKET; e Step : E_Client Server Steps; send To : ST_Fifo Entry; received From : ST_Fifo Entry; END_VAR Implementation CASE e Step OF UDP_STATE_IDLE: IF b Enable XOR b Created THEN b Busy := TRUE; b Error := FALSE; n Errid := 0; IF b Enable THEN e Step := UDP_STATE_CREATE_START; ELSE e Step := UDP_STATE_CLOSE_START; END_IF ELSIF b Created THEN send Fifo. Remove Head( old => send To ); IF send Fifo.b Ok THEN e Step := UDP_STATE_SEND_START; ELSE (* empty *) e Step := UDP_STATE_RECEIVE_START; END_IF ELSE b Busy := FALSE; END_IF UDP_STATE_CREATE_START: fb Create( b Execute := FALSE ); fb Create( s Srv Net Id:= g_s Tc Ip Conn Svr Addr, s Local Host:= s Local Host, n Local Port:= n Local Port, b Execute:= TRUE ); e Step := UDP_STATE_CREATE_WAIT; UDP_STATE_CREATE_WAIT: fb Create( b Execute := FALSE ); IF NOT fb Create.b Busy THEN IF NOT fb Create.b Error THEN b Created := TRUE; h Socket := fb Create.h Socket; e Step := UDP_STATE_IDLE; Log Message( 'Socket opened (UDP)!', h Socket ); ELSE Log Error( 'FB_Socket Udp Create', fb Create.n Err Id ); n Err Id := fb Create.n Err Id; e Step := UDP_STATE_ERROR; END_IF END_IF UDP_STATE_SEND_START: fb Send To( b Execute := FALSE ); fb Send To( s Srv Net Id:=g_s Tc Ip Conn Svr Addr, s Remote Host := send To.s Remote Host, n Remote Port := send To.n Remote Port, h Socket:= h Socket, p Src:= ADR( send To.msg ), cb Len:= LEN( send To.msg ) + 1, (* include the end delimiter *) b Execute:= TRUE ); e Step := UDP_STATE_SEND_WAIT; UDP_STATE_SEND_WAIT: fb Send To( b Execute := FALSE ); IF NOT fb Send To.b Busy THEN IF NOT fb Send To.b Error THEN e Step := UDP_STATE_RECEIVE_START; ELSE Log Error( 'FB_Socket Send To (UDP)', fb Send To.n Err Id ); n Err Id := fb Send To.n Err Id; e Step := UDP_STATE_ERROR; END_IF END_IF UDP_STATE_RECEIVE_START: TF6310 Version: 1.5.1 95
## Page 96

Samples MEMSET( ADR( received From ), 0, SIZEOF( received From ) ); fb Receive From( b Execute := FALSE ); fb Receive From( s Srv Net Id:=g_s Tc Ip Conn Svr Addr, h Socket:= h Socket, p Dest:= ADR( received From.msg ), cb Len:= SIZEOF( received From.msg ) - 1, (*without string delimiter *) b Execute:= TRUE ); e Step := UDP_STATE_RECEIVE_WAIT; UDP_STATE_RECEIVE_WAIT: fb Receive From( b Execute := FALSE ); IF NOT fb Receive From.b Busy THEN IF NOT fb Receive From.b Error THEN IF fb Receive From.n Rec Bytes > 0 THEN received From.n Remote Port := fb Receive From.n Remote Port; received From.s Remote Host := fb Receive From.s Remote Host; receive Fifo. Add Tail( new := received From ); IF NOT receive Fifo.b Ok THEN(* Check for fifo overflow *) Log Error( 'Receive fifo overflow!', PLCPRJ_ERROR_RECFIFO_OVERFLOW ); END_IF END_IF e Step := UDP_STATE_IDLE; ELSIF fb Receive From.n Err Id = 16#80072746 THEN Log Error( 'The connection is reset by remote side.', fb Receive From.n Err Id ); e Step := UDP_STATE_IDLE; ELSE Log Error( 'FB_Socket Udp Receive From (UDP client/server)', fb Receive From.n Err Id ); n Err Id := fb Receive From.n Err Id; e Step := UDP_STATE_ERROR; END_IF END_IF UDP_STATE_CLOSE_START: fb Close( b Execute := FALSE ); fb Close( s Srv Net Id:= g_s Tc Ip Conn Svr Addr, h Socket:= h Socket, b Execute:= TRUE ); e Step := UDP_STATE_CLOSE_WAIT; UDP_STATE_CLOSE_WAIT: fb Close( b Execute := FALSE ); IF NOT fb Close.b Busy THEN Log Message( 'Socket closed (UDP)!', h Socket ); b Created := FALSE; MEMSET( ADR(h Socket), 0, SIZEOF(h Socket)); IF fb Close.b Error THEN Log Error( 'FB_Socket Close (UDP)', fb Close.n Err Id ); n Err Id := fb Close.n Err Id; e Step := UDP_STATE_ERROR; ELSE b Busy := FALSE; b Error := FALSE; n Err Id := 0; e Step := UDP_STATE_IDLE; END_IF END_IF UDP_STATE_ERROR: (* Error step *) b Error := TRUE; IF b Created THEN e Step := UDP_STATE_CLOSE_START; ELSE b Busy := FALSE; e Step := UDP_STATE_IDLE; END_IF END_CASE MAIN program Previously opened sockets must be closed after a program download or a PLC reset. During PLC start-up, this is done by calling an instance of the FB_Socket Close All [} 25] function block. If one of the variables b Send Once To Itself or b Send Once To Remote has an rising edge, a new Fifo entry is generated and stored in the send Fifo. Received messages are removed from the receive Fifo and displayed in a message box. PROGRAM MAIN VAR CONSTANT LOCAL_HOST_IP : STRING(15) := ''; LOCAL_HOST_PORT : UDINT := 1001; 96 Version: 1.5.1 TF6310
## Page 97

Samples REMOTE_HOST_IP : STRING(15) := '172.16.2.209'; REMOTE_HOST_PORT : UDINT := 1001; END_VAR VAR fb Socket Close All : FB_Socket Close All; b Close All : BOOL := TRUE; fb Peer To Peer : FB_Peer To Peer; send Fifo : FB_Fifo; receive Fifo : FB_Fifo; send To Entry : ST_Fifo Entry; entry Received From : ST_Fifo Entry; tmp : STRING; b Send Once To Itself : BOOL; b Send Once To Remote : BOOL; END_VAR IF b Close All THEN (*On PLC reset or program download close all old connections *) b Close All := FALSE; fb Socket Close All( s Srv Net Id:= g_s Tc Ip Conn Svr Addr, b Execute:= TRUE, t Timeout:= T#10s ); ELSE fb Socket Close All( b Execute:= FALSE ); END_IF IF NOT fb Socket Close All.b Busy AND NOT fb Socket Close All.b Error THEN IF b Send Once To Remote THEN b Send Once To Remote := FALSE; (* clear flag *) send To Entry.n Remote Port := REMOTE_HOST_PORT; (* remote host port number*) send To Entry.s Remote Host := REMOTE_HOST_IP; (* remote host IP address *) send To Entry.msg := 'Hello remote host!'; (* message text*); send Fifo. Add Tail( new := send To Entry ); (* add new entry to the send queue*) IF NOT send Fifo.b Ok THEN (* check for fifo overflow*) Log Error( 'Send fifo overflow!', PLCPRJ_ERROR_SENDFIFO_OVERFLOW ); END_IF END_IF IF b Send Once To Itself THEN b Send Once To Itself := FALSE; (* clear flag *) send To Entry.n Remote Port := LOCAL_HOST_PORT; (* n Remote Port == n Local Port => sen d it to itself *) send To Entry.s Remote Host := LOCAL_HOST_IP; (* s Remote Host == s Local Host => send it to itself *) send To Entry.msg := 'Hello itself!'; (* message text*); send Fifo. Add Tail( new := send To Entry ); (* add new entry to the send queue*) IF NOT send Fifo.b Ok THEN (* check for fifo overflow*) Log Error( 'Send fifo overflow!', PLCPRJ_ERROR_SENDFIFO_OVERFLOW ); END_IF END_IF (* send and receive messages *) fb Peer To Peer( send Fifo := send Fifo, receive Fifo := receive Fifo, s Local Host := LOCAL_HOST_IP, n Local Port := LOCAL_HOST_PORT, b Enable := TRUE ); (* remove all received messages from receive queue *) REPEAT receive Fifo. Remove Head( old => entry Received From ); IF receive Fifo.b Ok THEN tmp := CONCAT( 'RECEIVED from: ', entry Received From.s Remote Host ); tmp := CONCAT( tmp, ', Port: ' ); tmp := CONCAT( tmp, UDINT_TO_STRING( entry Received From.n Remote Port ) ); tmp := CONCAT( tmp, ', msg: %s' ); ADSLOGSTR( ADSLOG_MSGTYPE_HINT OR ADSLOG_MSGTYPE_MSGBOX, tmp, entry Received From.msg ); END_IF UNTIL NOT receive Fifo.b Ok END_REPEAT END_IF 6.2.1.4 . NET communication This sample demonstrates how a suitable . NET communication partner for the PLC peer-to-peer device A can be realized. Only use this sample in conjunction with the PLC project Peer To Peer A. TF6310 Version: 1.5.1 97
## Page 98

Samples The . NET Sample Client can be used to send single UPD data packages to a UPD Server, in this case the PLC project Peer To Peer A. Download Download the test client. Unpack the ZIP file; the .exe file runs on a Windows system. How it works The sample uses the . Net libraries System. Net and System. Net. Sockets to implement a UDP client (class Udp Client). While listening for incoming UDP packets in a background thread, a string can be sent to a remote device by specifying its IP address and port number and clicking the Send button. For a better understanding of this article, imagine the following setup: • The PLC project Peer-to-Peer device A is running on a computer with IP address 10.1.128.21 • The . NET application is running on a computer with IP address 10.1.128.30 Description The client itself uses port 11000 for sending. At the same time it opens this port and displays received messages in the upper part of the interface as a log: Together with the PLC / C++ samples, this results in an echo sample: A UDP message is sent from the client port 11000 to the server port 10000, which sends the same data back to the sender. 98 Version: 1.5.1 TF6310
## Page 99

Samples The client can be configured via the interface: • Destination: Destination IP address • Port: The port that is addressed in the target • Source: Sender network card (IP address). "OS-based" operating system deals with selection of the appropriate network card. • Message The TF6311 "TCP/UDP Realtime" does not allow local communication. However, for testing purposes a different network interface can be selected via "Source", so that the UDP packet leaves the computer through one network card and arrives on the other network card ("loop cable"). 6.2.2 Sample02: Multicast This sample demonstrates how to send and receive Multicast packages via UDP. Client and Server cyclically send a value to each other via a Multicast IP address. Client and Server are realized by two PLC applications and delivered within a single Twin CAT 3 solution. System requirements • Twin CAT 3 Build 3093 or higher • Twin CAT 3 Function TF6310 TCP/IP version 1.0.64 or higher • Twin CAT 3 Library Tc2_Tcp Ip version 3.2.64.0 or higher • If one computer is used to execute the sample, e.g. client and server running in two separate PLC runtimes, both PLC runtimes need to run in separate tasks. Project download https://github.com/Beckhoff/TF6310_Samples/tree/master/PLC/UDP/Sample02 TF6310 Version: 1.5.1 99
## Page 100

Appendix 7 Appendix 7.1 OSI model The following article contains a brief introduction to the OSI model and describes how it influences our everyday network communication. Please note that this article is not intended to supersede more detailed documentation on the subject, but only to provide an overview. The OSI (Open Systems Interconnection) model describes the standardization of functions in a communication system via an abstract layer model. Each layer describes certain functions of communication between devices in the network. Each layer only communicates with the layer directly above or below it. Sample: If you call up the address "http://www.beckhoff.com" with your web browser, the following protocols are used, starting from layer 7: HTTP → TCP → IP → Ethernet. If you enter "https://www.beckhoff.com", however, the protocols HTTP → SSL → TCP → IP → Ethernet would be used. The Twin CAT 3 function TF6310 TCP/IP can be used to develop network-capable PLC programs that use TCP or UDP as the transport protocol. This allows PLC programmers to implement their own network protocols in the application layer and define their own message structure for communication with remote systems. 7.2 Keep Alive configuration The transmission of TCP Keep Alive messages verifies if an idle TCP connection is still active. Since version 1.0.47 of the Twin CAT TCP/IP Server (TF6310), the Keep Alive configuration of the Windows operating system is used, which can be configured via the following registry keys: The following documentation is an excerpt of a Microsoft Technet article. Keep Alive Time HKLM\SYSTEM\Current Control Set\Services\Tcpip\Parameters Data type Range Default value REG_DWORD 0x1–0x FFFFFFFF ( milliseconds ) 0x6DDD00 ( 7,200,000 milliseconds = 2 hours ) Description Determines how often TCP sends keep-alive transmissions. TCP sends keep-alive transmissions to verify that an idle connection is still active. This entry is used when the remote system is responding to TCP. Otherwise, the interval between transmissions is determined by the value of the Keep Alive Interval entry. By default, keep-alive transmissions are not sent. The TCP keep-alive feature must be enabled by a program, such as Telnet, or by an Internet browser, such as Internet Explorer. 100 Version: 1.5.1 TF6310
## Page 101

Appendix Keep Alive Interval HKLM\SYSTEM\Current Control Set\Services\Tcpip\Parameters Data type Range Default value REG_DWORD 0x1–0x FFFFFFFF ( milliseconds ) 0x3E8 ( 1,000 milliseconds = 1 second ) Description Determines how often TCP repeats keep-alive transmissions when no response is received. TCP sends keep-alive transmissions to verify that idle connections are still active. This prevents TCP from inadvertently disconnecting active lines. 7.3 Error codes 7.3.1 Overview of the error codes Codes (hex) Codes (dec) Error source Description 0x00000000-0x00007800 0-30720 Twin CAT system error Twin CAT system error (including ADS error codes [} 104] codes) 0x00008000-0x000080FF 32768-33023 Internal Twin CAT TCP/IP Internal error of the Twin CAT TCP/IP Connection Server error Connection Server codes [} 102] 0x80070000-0x8007FFFF 2147942400-2148007935 Error source = Code - Win32 system error 0x80070000 = Win32 (including Windows system error codes sockets error codes) Requirements Development environment Target system type PLC libraries to include Twin CAT v3.1 PC, CX (x86) or CX (Arm®) Tc2_Tcp Ip TF6310 Version: 1.5.1 101
## Page 102

Appendix 7.3.2 Internal error codes of the Twin CAT TCP/IP Connection Server 102 Version: 1.5.1 TF6310
## Page 103

Appendix Code Code Symbolic constant Description (hex) (dec) 0x0000800 32769 TCPADSERROR_NOMO No new sockets can be created (for FB_Socket Listen 1 REENTRIES and FB_Socket Connect). 0x0000800 32770 TCPADSERROR_NOTF Socket handle is invalid (for FB_Socket Receive, 2 OUND FB_Socket Accept, FB_Socket Send etc.). 0x0000800 32771 TCPADSERROR_ALREA Is returned when FB_Socket Listen is called, if the Tcp Ip 3 DYEXISTS port listener already exists. 0x0000800 32772 TCPADSERROR_NOTC Is returned when FB_Socket Receive is called, if the 4 ONNECTED client socket is no longer connected with the server. 0x0000800 32773 TCPADSERROR_NOTLI Is returned when FB_Socket Accept is called, if an error 5 STENING was registered in the listener socket. 0x0000800 32774 TCPADSERROR_HOST_ Returned if the target system is not reachable. 6 NOT_FOUND 0x0000808 32896 TCPADSERROR_TLS_I Returned if FB_Tls Socket Add Ca, FB_Tls Socket Add Crl , 0 NVALID_STATE FB_Tls Socket Set Cert or FB_Tls Socket Set Psk are called and a Connect has already been called. 0x0000808 32897 TCPADSERROR_TLS_C Returned if the specified CA certificate was not found. 1 A_NOTFOUND 0x0000808 32898 TCPADSERROR_TLS_C Returned if the specified certificate file was not found. 2 ERT_NOTFOUND 0x0000808 32899 TCPADSERROR_TLS_K Returned if the specified file with the private key was not 3 EY_NOTFOUND found. 0x0000808 32900 TCPADSERROR_TLS_C Returned if the specified CA certificate could not be read 4 A_INVALID or is invalid. 0x0000808 32901 TCPADSERROR_TLS_C Returned if the specified certificate file could not be read 5 ERT_INVALID or is invalid. 0x0000808 32902 TCPADSERROR_TLS_K Returned if the specified private key could not be read or 6 EY_INVALID is invalid. 0x0000808 32903 TCPADSERROR_TLS_V Returned if the remote terminal could not be verified 7 ERIFY_FAIL during the TLS handshake. 0x0000808 32904 TCPADSERROR_TLS_S Returned if a general error occurred while setting up the 8 ETUP TLS connection. 0x0000808 32905 TCPADSERROR_TLS_H Returned if an error occurred during the TLS handshake. 9 ANDSHAKE_FAIL Usually the handshake always works. However, if there are connection problems during the handshake, it may fail. 0x0000808 32906 TCPADSERROR_TLS_C Returned if an invalid cipher suite was specified. A IPHER_INVALID 0x0000808 32907 TCPADSERROR_TLS_V Returned if an invalid TLS version was specified. B ERSION_INVALID 0x0000808 32908 TCPADSERROR_TLS_C Returned if the specified Certificate Revocation List C RL_INVALID (CRL) is invalid. 0x0000808 32909 TCPADSERROR_TLS_I Returned if an internal error occurred while setting up D NTERNAL_ERROR the TLS connection. 0x0000808 32910 TCPADSERROR_TLS_P Returned if an error occurred when using a E SK_SETUP_ERROR Pre Shared Key (PSK) for TLS. 0x0000808 32911 TCPADSERROR_TLS_C Returned if the Common Name in the certificate of the F N_MISMATCH remote terminal does not match the host name or IP address used. 0x0000809 32912 TCPADSERROR_TLS_C Returned when the certificate of the remote terminal has 0 ERT_EXPIRED expired. 0x0000809 32913 TCPADSERROR_TLS_C Returned when the certificate of the remote terminal has 1 ERT_REVOKED been revoked. 0x0000809 32914 TCPADSERROR_TLS_C Returned when the remote terminal did not submit a 2 ERT_MISSING certificate. TF6310 Version: 1.5.1 103
## Page 104

Appendix Requirements Development environment Target system type PLC libraries to include Twin CAT v3.1 PC, CX (x86) or CX (Arm®) Tc2_Tcp Ip 7.3.3 Troubleshooting/diagnostics • In the event of connection problems the PING command can be used to ascertain whether the external communication partner can be reached via the network connection. If this is not the case, check the network configuration and firewall settings. • Sniffer tools such as Wireshark enable logging of the entire network communication. The log can then be analysed by Beckhoff support staff. • Check the hardware and software requirements described in this documentation (Twin CAT version, CE image version etc.). • Check the software installation hints described in this documentation (e.g. installation of CAB files on CE plattform). • Check the input parameters that are transferred to the function blocks (network address, port number, data etc, connection handle.) for correctness. Check whether the function block issues an error code. The documentation for the error codes can be found here: Overview of error codes [} 101]. • Check if the other communication partner/software/device issues an error code. • Activate the debug output integrated in the Tc Socket Helper. Lib during connection establishment/ disconnect process (keyword: CONNECT_MODE_ENABLEDBG). Open the Twin CAT System Manager and activate the Log View window. Analyze/check the debug output strings. Requirements Development environment Target system type PLC libraries to include Twin CAT v3.1 PC, CX (x86) or CX (Arm®) Tc2_Tcp Ip 7.3.4 ADS Return Codes Grouping of error codes: Global error codes: 0x0000 [} 104]... (0x9811_0000 ...) Router error codes: 0x500 [} 105]... (0x9811_0500 ...) General ADS errors: 0x700 [} 105]... (0x9811_0700 ...) RTime error codes: 0x1000 [} 107]... (0x9811_1000 ...) Global error codes 104 Version: 1.5.1 TF6310
## Page 105

Appendix Hex Dec HRESULT Name Description 0x0 0 0x98110000 ERR_NOERROR No error. 0x1 1 0x98110001 ERR_INTERNAL Internal error. 0x2 2 0x98110002 ERR_NORTIME No real time. 0x3 3 0x98110003 ERR_ALLOCLOCKEDMEM Allocation locked – memory error. 0x4 4 0x98110004 ERR_INSERTMAILBOX Mailbox full – the ADS message could not be sent. Reducing the number of ADS messages per cycle will help. 0x5 5 0x98110005 ERR_WRONGRECEIVEHMSG Wrong HMSG. 0x6 6 0x98110006 ERR_TARGETPORTNOTFOUND Target port not found – ADS server is not started, not reachable or not installed. 0x7 7 0x98110007 ERR_TARGETMACHINENOTFOUND Target computer not found – AMS route was not found. 0x8 8 0x98110008 ERR_UNKNOWNCMDID Unknown command ID. 0x9 9 0x98110009 ERR_BADTASKID Invalid task ID. 0x A 10 0x9811000A ERR_NOIO No IO. 0x B 11 0x9811000B ERR_UNKNOWNAMSCMD Unknown AMS command. 0x C 12 0x9811000C ERR_WIN32ERROR Win32 error. 0x D 13 0x9811000D ERR_PORTNOTCONNECTED Port not connected. 0x E 14 0x9811000E ERR_INVALIDAMSLENGTH Invalid AMS length. 0x F 15 0x9811000F ERR_INVALIDAMSNETID Invalid AMS Net ID. 0x10 16 0x98110010 ERR_LOWINSTLEVEL Installation level is too low –Twin CAT 2 license error. 0x11 17 0x98110011 ERR_NODEBUGINTAVAILABLE No debugging available. 0x12 18 0x98110012 ERR_PORTDISABLED Port disabled – Twin CAT system service not started. 0x13 19 0x98110013 ERR_PORTALREADYCONNECTED Port already connected. 0x14 20 0x98110014 ERR_AMSSYNC_W32ERROR AMS Sync Win32 error. 0x15 21 0x98110015 ERR_AMSSYNC_TIMEOUT AMS Sync Timeout. 0x16 22 0x98110016 ERR_AMSSYNC_AMSERROR AMS Sync error. 0x17 23 0x98110017 ERR_AMSSYNC_NOINDEXINMAP No index map for AMS Sync available. 0x18 24 0x98110018 ERR_INVALIDAMSPORT Invalid AMS port. 0x19 25 0x98110019 ERR_NOMEMORY No memory. 0x1A 26 0x9811001A ERR_TCPSEND TCP send error. 0x1B 27 0x9811001B ERR_HOSTUNREACHABLE Host unreachable. 0x1C 28 0x9811001C ERR_INVALIDAMSFRAGMENT Invalid AMS fragment. 0x1D 29 0x9811001D ERR_TLSSEND TLS send error – secure ADS connection failed. 0x1E 30 0x9811001E ERR_ACCESSDENIED Access denied – secure ADS access denied. Router error codes Hex Dec HRESULT Name Description 0x500 1280 0x98110500 ROUTERERR_NOLOCKEDMEMORY Locked memory cannot be allocated. 0x501 1281 0x98110501 ROUTERERR_RESIZEMEMORY The router memory size could not be changed. 0x502 1282 0x98110502 ROUTERERR_MAILBOXFULL The mailbox has reached the maximum number of possible messages. 0x503 1283 0x98110503 ROUTERERR_DEBUGBOXFULL The Debug mailbox has reached the maximum number of possible messages. 0x504 1284 0x98110504 ROUTERERR_UNKNOWNPORTTYPE The port type is unknown. 0x505 1285 0x98110505 ROUTERERR_NOTINITIALIZED The router is not initialized. 0x506 1286 0x98110506 ROUTERERR_PORTALREADYINUSE The port number is already assigned. 0x507 1287 0x98110507 ROUTERERR_NOTREGISTERED The port is not registered. 0x508 1288 0x98110508 ROUTERERR_NOMOREQUEUES The maximum number of ports has been reached. 0x509 1289 0x98110509 ROUTERERR_INVALIDPORT The port is invalid. 0x50A 1290 0x9811050A ROUTERERR_NOTACTIVATED The router is not active. 0x50B 1291 0x9811050B ROUTERERR_FRAGMENTBOXFULL The mailbox has reached the maximum number for fragmented messages. 0x50C 1292 0x9811050C ROUTERERR_FRAGMENTTIMEOUT A fragment timeout has occurred. 0x50D 1293 0x9811050D ROUTERERR_TOBEREMOVED The port is removed. General ADS error codes TF6310 Version: 1.5.1 105
## Page 106

Appendix Hex Dec HRESULT Name Description 0x700 1792 0x98110700 ADSERR_DEVICE_ERROR General device error. 0x701 1793 0x98110701 ADSERR_DEVICE_SRVNOTSUPP Service is not supported by the server. 0x702 1794 0x98110702 ADSERR_DEVICE_INVALIDGRP Invalid index group. 0x703 1795 0x98110703 ADSERR_DEVICE_INVALIDOFFSET Invalid index offset. 0x704 1796 0x98110704 ADSERR_DEVICE_INVALIDACCESS Reading or writing not permitted. Several causes are possible. For example, an incorrect password was entered when creating routes. 0x705 1797 0x98110705 ADSERR_DEVICE_INVALIDSIZE Parameter size not correct. 0x706 1798 0x98110706 ADSERR_DEVICE_INVALIDDATA Invalid data values. 0x707 1799 0x98110707 ADSERR_DEVICE_NOTREADY Device is not ready to operate. 0x708 1800 0x98110708 ADSERR_DEVICE_BUSY Device is busy. 0x709 1801 0x98110709 ADSERR_DEVICE_INVALIDCONTEXT Invalid operating system context. This can result from use of ADS blocks in different tasks. It may be possible to resolve this through multitasking synchronization in the PLC. 0x70A 1802 0x9811070A ADSERR_DEVICE_NOMEMORY Insufficient memory. 0x70B 1803 0x9811070B ADSERR_DEVICE_INVALIDPARM Invalid parameter values. 0x70C 1804 0x9811070C ADSERR_DEVICE_NOTFOUND Not found (files, ...). 0x70D 1805 0x9811070D ADSERR_DEVICE_SYNTAX Syntax error in file or command. 0x70E 1806 0x9811070E ADSERR_DEVICE_INCOMPATIBLE Objects do not match. 0x70F 1807 0x9811070F ADSERR_DEVICE_EXISTS Object already exists. 0x710 1808 0x98110710 ADSERR_DEVICE_SYMBOLNOTFOUND Symbol not found. 0x711 1809 0x98110711 ADSERR_DEVICE_SYMBOLVERSIONINVALID Invalid symbol version. This can occur due to an online change. Create a new handle. 0x712 1810 0x98110712 ADSERR_DEVICE_INVALIDSTATE Device (server) is in invalid state. 0x713 1811 0x98110713 ADSERR_DEVICE_TRANSMODENOTSUPP Ads Trans Mode not supported. 0x714 1812 0x98110714 ADSERR_DEVICE_NOTIFYHNDINVALID Notification handle is invalid. 0x715 1813 0x98110715 ADSERR_DEVICE_CLIENTUNKNOWN Notification client not registered. 0x716 1814 0x98110716 ADSERR_DEVICE_NOMOREHDLS No further handle available. 0x717 1815 0x98110717 ADSERR_DEVICE_INVALIDWATCHSIZE Notification size too large. 0x718 1816 0x98110718 ADSERR_DEVICE_NOTINIT Device not initialized. 0x719 1817 0x98110719 ADSERR_DEVICE_TIMEOUT Device has a timeout. 0x71A 1818 0x9811071A ADSERR_DEVICE_NOINTERFACE Interface query failed. 0x71B 1819 0x9811071B ADSERR_DEVICE_INVALIDINTERFACE Wrong interface requested. 0x71C 1820 0x9811071C ADSERR_DEVICE_INVALIDCLSID Class ID is invalid. 0x71D 1821 0x9811071D ADSERR_DEVICE_INVALIDOBJID Object ID is invalid. 0x71E 1822 0x9811071E ADSERR_DEVICE_PENDING Request pending. 0x71F 1823 0x9811071F ADSERR_DEVICE_ABORTED Request is aborted. 0x720 1824 0x98110720 ADSERR_DEVICE_WARNING Signal warning. 0x721 1825 0x98110721 ADSERR_DEVICE_INVALIDARRAYIDX Invalid array index. 0x722 1826 0x98110722 ADSERR_DEVICE_SYMBOLNOTACTIVE Symbol not active. 0x723 1827 0x98110723 ADSERR_DEVICE_ACCESSDENIED Access denied. Several causes are possible. For example, a unidirectional ADS route is used in the opposite direction. 0x724 1828 0x98110724 ADSERR_DEVICE_LICENSENOTFOUND Missing license. 0x725 1829 0x98110725 ADSERR_DEVICE_LICENSEEXPIRED License expired. 0x726 1830 0x98110726 ADSERR_DEVICE_LICENSEEXCEEDED License exceeded. 0x727 1831 0x98110727 ADSERR_DEVICE_LICENSEINVALID Invalid license. 0x728 1832 0x98110728 ADSERR_DEVICE_LICENSESYSTEMID License problem: System ID is invalid. 0x729 1833 0x98110729 ADSERR_DEVICE_LICENSENOTIMELIMIT License not limited in time. 0x72A 1834 0x9811072A ADSERR_DEVICE_LICENSEFUTUREISSUE Licensing problem: time in the future. 0x72B 1835 0x9811072B ADSERR_DEVICE_LICENSETIMETOLONG License period too long. 0x72C 1836 0x9811072C ADSERR_DEVICE_EXCEPTION Exception at system startup. 0x72D 1837 0x9811072D ADSERR_DEVICE_LICENSEDUPLICATED License file read twice. 0x72E 1838 0x9811072E ADSERR_DEVICE_SIGNATUREINVALID Invalid signature. 0x72F 1839 0x9811072F ADSERR_DEVICE_CERTIFICATEINVALID Invalid certificate. 0x730 1840 0x98110730 ADSERR_DEVICE_LICENSEOEMNOTFOUND Public key not known from OEM. 0x731 1841 0x98110731 ADSERR_DEVICE_LICENSERESTRICTED License not valid for this system ID. 106 Version: 1.5.1 TF6310
## Page 107

Appendix Hex Dec HRESULT Name Description 0x732 1842 0x98110732 ADSERR_DEVICE_LICENSEDEMODENIED Demo license prohibited. 0x733 1843 0x98110733 ADSERR_DEVICE_INVALIDFNCID Invalid function ID. 0x734 1844 0x98110734 ADSERR_DEVICE_OUTOFRANGE Outside the valid range. 0x735 1845 0x98110735 ADSERR_DEVICE_INVALIDALIGNMENT Invalid alignment. 0x736 1846 0x98110736 ADSERR_DEVICE_LICENSEPLATFORM Invalid platform level. 0x737 1847 0x98110737 ADSERR_DEVICE_FORWARD_PL Context – forward to passive level. 0x738 1848 0x98110738 ADSERR_DEVICE_FORWARD_DL Context – forward to dispatch level. 0x739 1849 0x98110739 ADSERR_DEVICE_FORWARD_RT Context – forward to real-time. 0x740 1856 0x98110740 ADSERR_CLIENT_ERROR Client error. 0x741 1857 0x98110741 ADSERR_CLIENT_INVALIDPARM Service contains an invalid parameter. 0x742 1858 0x98110742 ADSERR_CLIENT_LISTEMPTY Polling list is empty. 0x743 1859 0x98110743 ADSERR_CLIENT_VARUSED Var connection already in use. 0x744 1860 0x98110744 ADSERR_CLIENT_DUPLINVOKEID The called ID is already in use. 0x745 1861 0x98110745 ADSERR_CLIENT_SYNCTIMEOUT Timeout has occurred – the remote terminal is not responding in the specified ADS timeout. The route setting of the remote terminal may be configured incorrectly. 0x746 1862 0x98110746 ADSERR_CLIENT_W32ERROR Error in Win32 subsystem. 0x747 1863 0x98110747 ADSERR_CLIENT_TIMEOUTINVALID Invalid client timeout value. 0x748 1864 0x98110748 ADSERR_CLIENT_PORTNOTOPEN Port not open. 0x749 1865 0x98110749 ADSERR_CLIENT_NOAMSADDR No AMS address. 0x750 1872 0x98110750 ADSERR_CLIENT_SYNCINTERNAL Internal error in Ads sync. 0x751 1873 0x98110751 ADSERR_CLIENT_ADDHASH Hash table overflow. 0x752 1874 0x98110752 ADSERR_CLIENT_REMOVEHASH Key not found in the table. 0x753 1875 0x98110753 ADSERR_CLIENT_NOMORESYM No symbols in the cache. 0x754 1876 0x98110754 ADSERR_CLIENT_SYNCRESINVALID Invalid response received. 0x755 1877 0x98110755 ADSERR_CLIENT_SYNCPORTLOCKED Sync Port is locked. 0x756 1878 0x98110756 ADSERR_CLIENT_REQUESTCANCELLED The request was canceled. RTime error codes Hex Dec HRESULT Name Description 0x1000 4096 0x98111000 RTERR_INTERNAL Internal error in the real-time system. 0x1001 4097 0x98111001 RTERR_BADTIMERPERIODS Timer value is not valid. 0x1002 4098 0x98111002 RTERR_INVALIDTASKPTR Task pointer has the invalid value 0 (zero). 0x1003 4099 0x98111003 RTERR_INVALIDSTACKPTR Stack pointer has the invalid value 0 (zero). 0x1004 4100 0x98111004 RTERR_PRIOEXISTS The request task priority is already assigned. 0x1005 4101 0x98111005 RTERR_NOMORETCB No free TCB (Task Control Block) available. The maximum number of TCBs is 64. 0x1006 4102 0x98111006 RTERR_NOMORESEMAS No free semaphores available. The maximum number of semaphores is 64. 0x1007 4103 0x98111007 RTERR_NOMOREQUEUES No free space available in the queue. The maximum number of positions in the queue is 64. 0x100D 4109 0x9811100D RTERR_EXTIRQALREADYDEF An external synchronization interrupt is already applied. 0x100E 4110 0x9811100E RTERR_EXTIRQNOTDEF No external sync interrupt applied. 0x100F 4111 0x9811100F RTERR_EXTIRQINSTALLFAILED Application of the external synchronization interrupt has failed. 0x1010 4112 0x98111010 RTERR_IRQLNOTLESSOREQUAL Call of a service function in the wrong context 0x1017 4119 0x98111017 RTERR_VMXNOTSUPPORTED Intel VT-x extension is not supported. 0x1018 4120 0x98111018 RTERR_VMXDISABLED Intel VT-x extension is not enabled in the BIOS. 0x1019 4121 0x98111019 RTERR_VMXCONTROLSMISSING Missing function in Intel VT-x extension. 0x101A 4122 0x9811101A RTERR_VMXENABLEFAILS Activation of Intel VT-x fails. Specific positive HRESULT Return Codes: TF6310 Version: 1.5.1 107
## Page 108

Appendix HRESULT Name Description 0x0000_0000 S_OK No error. 0x0000_0001 S_FALSE No error. Example: successful processing, but with a negative or incomplete result. 0x0000_0203 S_PENDING No error. Example: successful processing, but no result is available yet. 0x0000_0256 S_WATCHDOG_TIMEOUT No error. Example: successful processing, but a timeout occurred. TCP Winsock error codes Hex Dec Name Description 0x274C 10060 WSAETIMEDOUT A connection timeout has occurred - error while establishing the connection, because the remote terminal did not respond properly after a certain period of time, or the established connection could not be maintained because the connected host did not respond. 0x274D 10061 WSAECONNREFUSED Connection refused - no connection could be established because the target computer has explicitly rejected it. This error usually results from an attempt to connect to a service that is inactive on the external host, that is, a service for which no server application is running. 0x2751 10065 WSAEHOSTUNREACH No route to host - a socket operation referred to an unavailable host. More Winsock error codes: Win32 error codes 7.4 Support and Service Beckhoff and their partners around the world offer comprehensive support and service, making available fast and competent assistance with all questions related to Beckhoff products and system solutions. Download finder Our download finder contains all the files that we offer you for downloading. You will find application reports, technical documentation, technical drawings, configuration files and much more. The downloads are available in various formats. Beckhoff's branch offices and representatives Please contact your Beckhoff branch office or representative for local support and service on Beckhoff products! The addresses of Beckhoff's branch offices and representatives round the world can be found on our internet page: www.beckhoff.com You will also find further documentation for Beckhoff components there. Beckhoff Support Support offers you comprehensive technical assistance, helping you not only with the application of individual Beckhoff products, but also with other, wide-ranging services: • support • design, programming and commissioning of complex automation systems • and extensive training program for Beckhoff system components Hotline: +49 5246 963-157 e-mail: support@beckhoff.com Beckhoff Service The Beckhoff Service Center supports you in all matters of after-sales service: • on-site service 108 Version: 1.5.1 TF6310
## Page 109

Appendix • repair service • spare parts service • hotline service Hotline: +49 5246 963-460 e-mail: service@beckhoff.com Beckhoff Headquarters Beckhoff Automation Gmb H & Co. KG Huelshorstweg 20 33415 Verl Germany Phone: +49 5246 963-0 e-mail: info@beckhoff.com web: www.beckhoff.com TF6310 Version: 1.5.1 109
## Page 110

Trademark statements Beckhoff®, Twin CAT®, Twin CAT/BSD®, TC/BSD®, Ether CAT®, Ether CAT G®, Ether CAT G10®, Ether CAT P®, Safety over Ether CAT®, Twin SAFE®, XFC®, XTS® and XPlanar® are registered trademarks of and licensed by Beckhoff Automation Gmb H. Third-party trademark statements Arm, Arm9 and Cortex are trademarks or registered trademarks of Arm Limited (or its subsidiaries or affiliates) in the US and/or elsewhere. Intel, the Intel logo, Intel Core, Xeon, Intel Atom, Celeron and Pentium are trademarks of Intel Corporation or its subsidiaries. Microsoft, Microsoft Azure, Microsoft Edge, Power Shell, Visual Studio, Windows and Xbox are trademarks of the Microsoft group of companies. Wireshark is a registered trademark of Sysdig, Inc.
## Page 111

More Information: www.beckhoff.com/tf6310 Beckhoff Automation Gmb H & Co. KG Hülshorstweg 20 33415 Verl Germany Phone: +49 5246 9630 info@beckhoff.com www.beckhoff.com
